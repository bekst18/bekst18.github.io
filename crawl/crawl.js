import * as dom from "../shared/dom.js";
import * as array from "../shared/array.js";
import * as gfx from "./gfx.js";
import * as gen from "./gen.js";
import * as grid from "../shared/grid.js";
const tileSize = 24;
async function generateMap(renderer, width, height) {
    const gmap = gen.generateMap(width, height);
    // bake all 24x24 tile images to a single texture
    // store mapping from image url to index
    const imageUrls = array.mapDistinct(gen.iterThings(gmap), th => th.image);
    const layerMap = new Map(imageUrls.map((url, i) => [url, i]));
    const images = await Promise.all(imageUrls.map(url => dom.loadImage(url)));
    const texture = renderer.bakeTextureArray(tileSize, tileSize, images);
    const map = grid.generate(gmap.width, gmap.height, (x, y) => {
        const gtile = gmap.at(x, y);
        const tile = {
            things: []
        };
        for (const gthing of gtile.things) {
            const layer = layerMap.get(gthing.image);
            if (typeof layer === "undefined") {
                throw new Error(`texture index not found for ${gthing.image}`);
            }
            const thing = {
                name: gthing.name,
                texture: texture,
                textureLayer: layer
            };
            tile.things.push(thing);
        }
        return tile;
    });
    return map;
}
const errorsDiv = dom.byId("errors");
function clearErrorMessages() {
    dom.removeAllChildren(errorsDiv);
}
function appendErrorMessage(error) {
    console.log(error);
    const div = document.createElement("div");
    div.classList.add("error-message");
    div.textContent = error;
    errorsDiv.appendChild(div);
}
function tick(renderer, map) {
    for (let ty = 0; ty < map.height; ++ty) {
        for (let tx = 0; tx < map.width; ++tx) {
            const tile = map.at(tx, ty);
            const x = tx * tileSize;
            const y = ty * tileSize;
            for (const thing of tile.things) {
                const sprite = {
                    position: [x, y],
                    color: [1, 1, 1, 1],
                    width: tileSize,
                    height: tileSize,
                    texture: thing.texture,
                    layer: thing.textureLayer
                };
                renderer.drawSprite(sprite);
            }
        }
    }
    renderer.flush();
}
async function main() {
    const canvas = dom.byId("canvas");
    const renderer = new gfx.Renderer(canvas);
    const map = await generateMap(renderer, 32, 32);
    requestAnimationFrame(() => tick(renderer, map));
}
main();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3Jhd2wuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJjcmF3bC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEtBQUssR0FBRyxNQUFNLGtCQUFrQixDQUFBO0FBQ3ZDLE9BQU8sS0FBSyxLQUFLLE1BQU0sb0JBQW9CLENBQUE7QUFDM0MsT0FBTyxLQUFLLEdBQUcsTUFBTSxVQUFVLENBQUE7QUFDL0IsT0FBTyxLQUFLLEdBQUcsTUFBTSxVQUFVLENBQUE7QUFDL0IsT0FBTyxLQUFLLElBQUksTUFBTSxtQkFBbUIsQ0FBQTtBQUV6QyxNQUFNLFFBQVEsR0FBRyxFQUFFLENBQUE7QUFjbkIsS0FBSyxVQUFVLFdBQVcsQ0FBQyxRQUFzQixFQUFFLEtBQWEsRUFBRSxNQUFjO0lBQzVFLE1BQU0sSUFBSSxHQUFHLEdBQUcsQ0FBQyxXQUFXLENBQUMsS0FBSyxFQUFFLE1BQU0sQ0FBQyxDQUFBO0lBRTNDLGlEQUFpRDtJQUNqRCx3Q0FBd0M7SUFDeEMsTUFBTSxTQUFTLEdBQUcsS0FBSyxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLEtBQUssQ0FBQyxDQUFBO0lBQ3pFLE1BQU0sUUFBUSxHQUFHLElBQUksR0FBRyxDQUFpQixTQUFTLENBQUMsR0FBRyxDQUFDLENBQUMsR0FBRyxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFBO0lBQzdFLE1BQU0sTUFBTSxHQUFHLE1BQU0sT0FBTyxDQUFDLEdBQUcsQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUE7SUFDMUUsTUFBTSxPQUFPLEdBQUcsUUFBUSxDQUFDLGdCQUFnQixDQUFDLFFBQVEsRUFBRSxRQUFRLEVBQUUs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RSxDQUFBO0FBQ3BCLENBQUM7QUFFRCxLQUFLLFVBQVUsSUFBSTtJQUNmLE1BQU0sTUFBTSxHQUFHLEdBQUcsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFzQixDQUFBO0lBQ3RELE1BQU0sUUFBUSxHQUFHLElBQUksR0FBRyxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsQ0FBQTtJQUN6QyxNQUFNLEdBQUcsR0FBRyxNQUFNLFdBQVcsQ0FBQyxRQUFRLEVBQUUsRUFBRSxFQUFFLEVBQUUsQ0FBQyxDQUFBO0lBQy9DLHFCQUFxQixDQUFDLEdBQUcsRUFBRSxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUUsR0FBRyxDQUFDLENBQUMsQ0FBQTtBQUNwRCxDQUFDO0FBRUQsSUFBSSxFQUFFLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBkb20gZnJvbSBcIi4uL3NoYXJlZC9kb20uanNcIlxyXG5pbXBvcnQgKiBhcyBhcnJheSBmcm9tIFwiLi4vc2hhcmVkL2FycmF5LmpzXCJcclxuaW1wb3J0ICogYXMgZ2Z4IGZyb20gXCIuL2dmeC5qc1wiXHJcbmltcG9ydCAqIGFzIGdlbiBmcm9tIFwiLi9nZW4uanNcIlxyXG5pbXBvcnQgKiBhcyBncmlkIGZyb20gXCIuLi9zaGFyZWQvZ3JpZC5qc1wiXHJcblxyXG5jb25zdCB0aWxlU2l6ZSA9IDI0XHJcblxyXG5pbnRlcmZhY2UgVGhpbmcge1xyXG4gICAgbmFtZTogc3RyaW5nXHJcbiAgICB0ZXh0dXJlOiBXZWJHTFRleHR1cmVcclxuICAgIHRleHR1cmVMYXllcjogbnVtYmVyXHJcbn1cclxuXHJcbmludGVyZmFjZSBUaWxlIHtcclxuICAgIHRoaW5nczogVGhpbmdbXVxyXG59XHJcblxyXG50eXBlIE1hcEdyaWQgPSBncmlkLkdyaWQ8VGlsZT5cclxuXHJcbmFzeW5jIGZ1bmN0aW9uIGdlbmVyYXRlTWFwKHJlbmRlcmVyOiBnZnguUmVuZGVyZXIsIHdpZHRoOiBudW1iZXIsIGhlaWdodDogbnVtYmVyKSB7XHJcbiAgICBjb25zdCBnbWFwID0gZ2VuLmdlbmVyYXRlTWFwKHdpZHRoLCBoZWlnaHQpXHJcblxyXG4gICAgLy8gYmFrZSBhbGwgMjR4MjQgdGlsZSBpbWFnZXMgdG8gYSBzaW5nbGUgdGV4dHVyZVxyXG4gICAgLy8gc3RvcmUgbWFwcGluZyBmcm9tIGltYWdlIHVybCB0byBpbmRleFxyXG4gICAgY29uc3QgaW1hZ2VVcmxzID0gYXJyYXkubWFwRGlzdGluY3QoZ2VuLml0ZXJUaGluZ3MoZ21hcCksIHRoID0+IHRoLmltYWdlKVxyXG4gICAgY29uc3QgbGF5ZXJNYXAgPSBuZXcgTWFwPHN0cmluZywgbnVtYmVyPihpbWFnZVVybHMubWFwKCh1cmwsIGkpID0+IFt1cmwsIGldKSlcclxuICAgIGNvbnN0IGltYWdlcyA9IGF3YWl0IFByb21pc2UuYWxsKGltYWdlVXJscy5tYXAodXJsID0+IGRvbS5sb2FkSW1hZ2UodXJsKSkpXHJcbiAgICBjb25zdCB0ZXh0dXJlID0gcmVuZGVyZXIuYmFrZVRleHR1cmVBcnJheSh0aWxlU2l6ZSwgdGlsZVNpemUsIGltYWdlcylcclxuXHJcbiAgICBjb25zdCBtYXA6IE1hcEdyaWQgPSBncmlkLmdlbmVyYXRlKGdtYXAud2lkdGgsIGdtYXAuaGVpZ2h0LCAoeCwgeSkgPT4ge1xyXG4gICAgICAgIGNvbnN0IGd0aWxlID0gZ21hcC5hdCh4LCB5KVxyXG4gICAgICAgIGNvbnN0IHRpbGU6IFRpbGUgPSB7XHJcbiAgICAgICAgICAgIHRoaW5nczogW11cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGZvciAoY29uc3QgZ3RoaW5nIG9mIGd0aWxlLnRoaW5ncykge1xyXG4gICAgICAgICAgICBjb25zdCBsYXllciA9IGxheWVyTWFwLmdldChndGhpbmcuaW1hZ2UpXHJcbiAgICAgICAgICAgIGlmICh0eXBlb2YgbGF5ZXIgPT09IFwidW5kZWZpbmVkXCIpIHtcclxuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgdGV4dHVyZSBpbmRleCBub3QgZm91bmQgZm9yICR7Z3RoaW5nLmltYWdlfWApXHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGNvbnN0IHRoaW5nOiBUaGluZyA9IHtcclxuICAgICAgICAgICAgICAgIG5hbWU6IGd0aGluZy5uYW1lLFxyXG4gICAgICAgICAgICAgICAgdGV4dHVyZTogdGV4dHVyZSxcclxuICAgICAgICAgICAgICAgIHRleHR1cmVMYXllcjogbGF5ZXJcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgdGlsZS50aGluZ3MucHVzaCh0aGluZylcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiB0aWxlXHJcbiAgICB9KVxyXG5cclxuICAgIHJldHVybiBtYXBcclxufVxyXG5cclxuY29uc3QgZXJyb3JzRGl2ID0gZG9tLmJ5SWQoXCJlcnJvcnNcIik7XHJcblxyXG5mdW5jdGlvbiBjbGVhckVycm9yTWVzc2FnZXMoKSB7XHJcbiAgICBkb20ucmVtb3ZlQWxsQ2hpbGRyZW4oZXJyb3JzRGl2KVxyXG59XHJcblxyXG5mdW5jdGlvbiBhcHBlbmRFcnJvck1lc3NhZ2UoZXJyb3I6IHN0cmluZykge1xyXG4gICAgY29uc29sZS5sb2coZXJyb3IpXHJcbiAgICBjb25zdCBkaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwiZGl2XCIpO1xyXG4gICAgZGl2LmNsYXNzTGlzdC5hZGQoXCJlcnJvci1tZXNzYWdlXCIpXHJcbiAgICBkaXYudGV4dENvbnRlbnQgPSBlcnJvclxyXG4gICAgZXJyb3JzRGl2LmFwcGVuZENoaWxkKGRpdilcclxufVxyXG5cclxuZnVuY3Rpb24gdGljayhyZW5kZXJlcjogZ2Z4LlJlbmRlcmVyLCBtYXA6IE1hcEdyaWQpIHtcclxuICAgIGZvciAobGV0IHR5ID0gMDsgdHkgPCBtYXAuaGVpZ2h0OyArK3R5KSB7XHJcbiAgICAgICAgZm9yIChsZXQgdHggPSAwOyB0eCA8IG1hcC53aWR0aDsgKyt0eCkge1xyXG4gICAgICAgICAgICBjb25zdCB0aWxlID0gbWFwLmF0KHR4LCB0eSlcclxuICAgICAgICAgICAgY29uc3QgeCA9IHR4ICogdGlsZVNpemVcclxuICAgICAgICAgICAgY29uc3QgeSA9IHR5ICogdGlsZVNpemVcclxuICAgICAgICAgICAgZm9yIChjb25zdCB0aGluZyBvZiB0aWxlLnRoaW5ncykge1xyXG4gICAgICAgICAgICAgICAgY29uc3Qgc3ByaXRlOiBnZnguU3ByaXRlID0ge1xyXG4gICAgICAgICAgICAgICAgICAgIHBvc2l0aW9uOiBbeCwgeV0sXHJcbiAgICAgICAgICAgICAgICAgICAgY29sb3I6IFsxLCAxLCAxLCAxXSxcclxuICAgICAgICAgICAgICAgICAgICB3aWR0aDogdGlsZVNpemUsXHJcbiAgICAgICAgICAgICAgICAgICAgaGVpZ2h0OiB0aWxlU2l6ZSxcclxuICAgICAgICAgICAgICAgICAgICB0ZXh0dXJlOiB0aGluZy50ZXh0dXJlLFxyXG4gICAgICAgICAgICAgICAgICAgIGxheWVyOiB0aGluZy50ZXh0dXJlTGF5ZXJcclxuICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICByZW5kZXJlci5kcmF3U3ByaXRlKHNwcml0ZSlcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICByZW5kZXJlci5mbHVzaCgpXHJcbn1cclxuXHJcbmFzeW5jIGZ1bmN0aW9uIG1haW4oKSB7XHJcbiAgICBjb25zdCBjYW52YXMgPSBkb20uYnlJZChcImNhbnZhc1wiKSBhcyBIVE1MQ2FudmFzRWxlbWVudFxyXG4gICAgY29uc3QgcmVuZGVyZXIgPSBuZXcgZ2Z4LlJlbmRlcmVyKGNhbnZhcylcclxuICAgIGNvbnN0IG1hcCA9IGF3YWl0IGdlbmVyYXRlTWFwKHJlbmRlcmVyLCAzMiwgMzIpXHJcbiAgICByZXF1ZXN0QW5pbWF0aW9uRnJhbWUoKCkgPT4gdGljayhyZW5kZXJlciwgbWFwKSlcclxufVxyXG5cclxubWFpbigpIl19