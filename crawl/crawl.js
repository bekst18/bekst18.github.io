import * as dom from "../shared/dom.js";
import * as array from "../shared/array.js";
import * as gfx from "./gfx.js";
import * as gen from "./gen.js";
import * as input from "../shared/input.js";
import * as rl from "./rl.js";
import * as geo from "../shared/geo2d.js";
const tileSize = 24;
async function generateMap(player, renderer, width, height) {
    const map = gen.generateMap(player, width, height);
    // bake all 24x24 tile images to a single array texture
    // store mapping from image url to index
    let imageUrls = [];
    imageUrls.push(...map.tiles.map(t => t.image));
    imageUrls.push(...map.fixtures.map(t => t.image));
    imageUrls.push(map.stairsUp.image);
    imageUrls.push(map.stairsDown.image);
    imageUrls.push(map.player.image);
    imageUrls = imageUrls.filter(url => url);
    imageUrls = array.distinct(imageUrls);
    const layerMap = new Map(imageUrls.map((url, i) => [url, i]));
    const images = await Promise.all(imageUrls.map(url => dom.loadImage(url)));
    const texture = renderer.bakeTextureArray(tileSize, tileSize, images);
    const initRenderData = (th) => {
        const layer = layerMap.get(th.image);
        if (layer === undefined) {
            throw new Error(`texture index not found for ${th.image}`);
        }
        th.renderData = {
            texture: texture,
            textureLayer: layer
        };
    };
    map.tiles.forEach(initRenderData);
    map.fixtures.forEach(initRenderData);
    initRenderData(map.stairsUp);
    initRenderData(map.stairsDown);
    initRenderData(map.player);
    return map;
}
const errorsDiv = dom.byId("errors");
function clearErrorMessages() {
    dom.removeAllChildren(errorsDiv);
}
function appendErrorMessage(error) {
    console.log(error);
    const div = document.createElement("div");
    div.classList.add("error-message");
    div.textContent = error;
    errorsDiv.appendChild(div);
}
function tick(renderer, keys, map) {
    handleInput(map, keys);
    drawFrame(renderer, map);
    requestAnimationFrame(() => tick(renderer, keys, map));
}
function handleInput(map, keys) {
    const player = map.player;
    const position = player.position.clone();
    if (keys.pressed("w")) {
        position.y -= 1;
    }
    if (keys.pressed("s")) {
        position.y += 1;
    }
    if (keys.pressed("a")) {
        position.x -= 1;
    }
    if (keys.pressed("d")) {
        position.x += 1;
    }
    if (isPassable(map, position)) {
        player.position = position;
    }
    keys.update();
}
function isPassable(map, xy) {
    const tiles = array.filter(map.tiles, t => t.position.equal(xy));
    for (const tile of tiles) {
        if (!tile.passable) {
            return false;
        }
    }
    const fixtures = array.filter(map.fixtures, t => t.position.equal(xy));
    for (const fixture of fixtures) {
        if (!fixture.passable) {
            return false;
        }
    }
    return true;
}
function drawFrame(renderer, map) {
    // center the grid around the player
    const playerCoords = map.player.position;
    const center = new geo.Point(Math.floor((renderer.canvas.width - tileSize) / 2), Math.floor((renderer.canvas.height - tileSize) / 2));
    const offset = center.subPoint(playerCoords.mulScalar(rl.tileSize));
    handleResize(renderer.canvas);
    // draw various layers of sprites
    for (const tile of map.tiles) {
        drawThing(renderer, offset, tile);
    }
    for (const fixture of map.fixtures) {
        drawThing(renderer, offset, fixture);
    }
    drawThing(renderer, offset, map.stairsUp);
    drawThing(renderer, offset, map.stairsDown);
    drawThing(renderer, offset, map.player);
    renderer.flush();
}
function drawThing(renderer, offset, th) {
    if (!th.renderData) {
        throw new Error(`renderData is not set for ${th.name} with image: ${th.image}`);
    }
    const { x, y } = th.position;
    const { x: ox, y: oy } = offset;
    const sprite = {
        position: [x * tileSize + ox, y * tileSize + oy],
        color: [1, 1, 1, 1],
        width: tileSize,
        height: tileSize,
        texture: th.renderData.texture,
        layer: th.renderData.textureLayer
    };
    renderer.drawSprite(sprite);
}
function handleResize(canvas) {
    if (canvas.width === canvas.clientWidth && canvas.height === canvas.clientHeight) {
        return;
    }
    canvas.width = canvas.clientWidth;
    canvas.height = canvas.clientHeight;
}
async function main() {
    const canvas = dom.byId("canvas");
    const renderer = new gfx.Renderer(canvas);
    const player = new rl.Player({
        name: "Player",
        position: new geo.Point(0, 0),
        passable: false,
        transparent: true,
        image: "./assets/char.png"
    });
    const map = await generateMap(player, renderer, 32, 32);
    const keys = new input.Keys();
    requestAnimationFrame(() => tick(renderer, keys, map));
}
main();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3Jhd2wuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJjcmF3bC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEtBQUssR0FBRyxNQUFNLGtCQUFrQixDQUFBO0FBQ3ZDLE9BQU8sS0FBSyxLQUFLLE1BQU0sb0JBQW9CLENBQUE7QUFDM0MsT0FBTyxLQUFLLEdBQUcsTUFBTSxVQUFVLENBQUE7QUFDL0IsT0FBTyxLQUFLLEdBQUcsTUFBTSxVQUFVLENBQUE7QUFDL0IsT0FBTyxLQUFLLEtBQUssTUFBTSxvQkFBb0IsQ0FBQTtBQUMzQyxPQUFPLEtBQUssRUFBRSxNQUFNLFNBQVMsQ0FBQTtBQUM3QixPQUFPLEtBQUssR0FBRyxNQUFNLG9CQUFvQixDQUFBO0FBRXpDLE1BQU0sUUFBUSxHQUFHLEVBQUUsQ0FBQTtBQUVuQixLQUFLLFVBQVUsV0FBVyxDQUFDLE1BQWlCLEVBQUUsUUFBc0IsRUFBRSxLQUFhLEVBQUUsTUFBYztJQUMvRixNQUFNLEdBQUcsR0FBRyxHQUFHLENBQUMsV0FBVyxDQUFDLE1BQU0sRUFBRSxLQUFLLEVBQUUsTUFBTSxDQUFDLENBQUE7SUFFbEQsdURBQXVEO0lBQ3ZELHdDQUF3QztJQUN4QyxJQUFJLFNBQVMsR0FBYSxFQUFFLENBQUE7SUFDNUIsU0FBUyxDQUFDLElBQUksQ0FBQyxHQUFHLEdBQUcsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUE7SUFDOUMsU0FBUyxDQUFDLElBQUksQ0FBQyxHQUFHLEdBQUcsQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUE7SUFDakQsU0FBUyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxDQUFBO0lBQ2xDLFNBQVMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLFVBQVUsQ0FBQyxLQUFLLENBQUMsQ0FBQTtJQUNwQyxTQUFTLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUE7SUFDaEMsU0FBUyxHQUFHLFNBQVMsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLENBQUMsQ0FBQTtJQUN4QyxTQUFTLEdBQUcsS0FBSyxDQUFDLFFBQVEsQ0FBQyxTQUFTLENBQUMsQ0FBQTtJQUVyQyxNQUFNLFFBQVEsR0FBRyxJQUFJLEdBQUcsQ0FBaUIsU0FBUyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQUcsRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQTtJQUM3RSxNQUFNLE1BQU0sR0FBRyxNQUFNLE9BQU8sQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFBO0lBQzFFLE1BQU0sT0FBTyxHQUFHLFFBQVEsQ0FBQyxnQkFBZ0IsQ0FBQyxRQUFRLEVBQUUsUUFBUSxFQUFFLE1BQU0sQ0FBQyxDQUFBO0lBRXJFLE1BQU0sY0FBYyxHQUFHLENBQUMsRUFBWSxFQUFFLEVBQUU7UUFDcEMsTUFBTSxLQUFLLEdBQUcsUUFBUSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsS0FBSyxDQUFDLENBQUE7UUFDcEMsSUFBSSxLQUFLLEtBQUssU0FBUyxFQUFFO1lBQ3JCLE1BQU0sSUFBSSxLQUFLLENBQUMsK0JBQStCLEVBQUUsQ0FBQyxLQUFLLEVBQUUsQ0FBQyxDQUFBO1NBQzdEO1FBRUQsRUFBRSxDQUFDLFVBQVUsR0FBRztZQUNaLE9BQU8sRUFBRSxPQUFPO1lBQ2hCLFlBQVksRUFBRSxLQUFLO1NBQ3RCLENBQUE7SUFDTCxDQUFDLENBQUE7SUFFRCxHQUFHLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxjQUFjLENBQUMsQ0FBQTtJQUNqQyxHQUFHLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxjQUFjLENBQUMsQ0FBQTtJQUNwQyxjQUFjLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxDQUFBO0lBQzVCLGNBQWMsQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDLENBQUE7SUFDOUIsY0FBYyxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsQ0FBQTtJQUUxQixPQUFPLEdBQUcsQ0FBQTtBQUNkLENBQUM7QUFFRCxNQUFNLFNBQVMsR0FBRyxHQUFHLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO0FBRXJDLFNBQVMsa0JBQWtCO0lBQ3ZCLEdBQUcsQ0FBQyxpQkFBaUIsQ0FBQyxTQUFTLENBQUMsQ0FBQTtBQUNwQyxDQUFDO0FBRUQsU0FBUyxrQkFBa0IsQ0FBQyxLQUFhO0lBQ3JDLE9BQU8sQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLENBQUE7SUFDbEIsTUFBTSxHQUFHLEdBQUcsUUFBUSxDQUFDLGFBQWEsQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUMxQyxHQUFHLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxlQUFlLENBQUMsQ0FBQTtJQUNsQyxHQUFHLENBQUMsV0FBVyxHQUFHLEtBQUssQ0FBQTtJQUN2QixTQUFTLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxDQUFBO0FBQzlCLENBQUM7QUFFRCxTQUFTLElBQUksQ0FBQyxRQUFzQixFQUFFLElBQWdCLEVBQUUsR0FBZ0I7SUFDcEUsV0FBVyxDQUFDLEdBQUcsRUFBRSxJQUFJLENBQUMsQ0FBQTtJQUN0QixTQUFTLENBQUMsUUFBUSxFQUFFLEdBQUcsQ0FBQyxDQUFBO0lBQ3hCLHFCQUFxQixDQUFDLEdBQUcsRUFBRSxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUUsSUFBSSxFQUFFLEdBQUcsQ0FBQyxDQUFDLENBQUE7QUFDMUQsQ0FBQztBQUVELFNBQVMsV0FBVyxDQUFDLEdBQWdCLEVBQUUsSUFBZ0I7SUFDbkQsTUFBTSxNQUFNLEdBQUcsR0FBRyxDQUFDLE1BQU0sQ0FBQTtJQUN6QixNQUFNLFFBQVEsR0FBRyxNQUFNLENBQUMsUUFBUSxDQUFDLEtBQUssRUFBRSxDQUFBO0lBRXhDLElBQUksSUFBSSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsRUFBRTtRQUNuQixRQUFRLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQTtLQUNsQjtJQUVELElBQUksSUFBSSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsRUFBRTtRQUNuQixRQUFRLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQTtLQUNsQjtJQUVELElBQUksSUFBSSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsRUFBRTtRQUNuQixRQUFRLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQTtLQUNsQjtJQUVELElBQUksSUFBSSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsRUFBRTtRQUNuQixRQUFRLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQTtLQUNsQjtJQUVELElBQUksVUFBVSxDQUFDLEdBQUcsRUFBRSxRQUFRLENBQUMsRUFBRTtRQUMzQixNQUFNLENBQUMsUUFBUSxHQUFHLFFBQVEsQ0FBQTtLQUM3QjtJQUVELElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQTtBQUNqQixDQUFDO0FBRUQsU0FBUyxVQUFVLENBQUMsR0FBZ0IsRUFBRSxFQUFhO0lBQy9DLE1BQU0sS0FBSyxHQUFHLEtBQUssQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLEtBQUssRUFBRSxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUE7SUFDaEUsS0FBSyxNQUFNLElBQUksSUFBSSxLQUFLLEVBQUU7UUFDdEIsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUU7WUFDaEIsT0FBTyxLQUFLLENBQUE7U0FDZjtLQUNKO0lBRUQsTUFBTSxRQUFRLEdBQUcsS0FBSyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsUUFBUSxFQUFFLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQTtJQUN0RSxLQUFLLE1BQU0sT0FBTyxJQUFJLFFBQVEsRUFBRTtRQUM1QixJQUFJLENBQUMsT0FBTyxDQUFDLFFBQVEsRUFBRTtZQUNuQixPQUFPLEtBQUssQ0FBQTtTQUNmO0tBQ0o7SUFFRCxPQUFPLElBQUksQ0FBQTtBQUNmLENBQUM7QUFFRCxTQUFTLFNBQVMsQ0FBQyxRQUFzQixFQUFFLEdBQWdCO0lBQ3ZELG9DQUFvQztJQUNwQyxNQUFNLFlBQVksR0FBRyxHQUFHLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQTtJQUN4QyxNQUFNLE1BQU0sR0FBRyxJQUFJLEdBQUcsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsS0FBSyxHQUFHLFFBQVEsQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLE1BQU0sR0FBRyxRQUFRLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFBO0lBQ3JJLE1BQU0sTUFBTSxHQUFHLE1BQU0sQ0FBQyxRQUFRLENBQUMsWUFBWSxDQUFDLFNBQVMsQ0FBQyxFQUFFLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQTtJQUVuRSxZQUFZLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxDQUFBO0lBRTdCLGlDQUFpQztJQUNqQyxLQUFLLE1BQU0sSUFBSSxJQUFJLEdBQUcsQ0FBQyxLQUFLLEVBQUU7UUFDMUIsU0FBUyxDQUFDLFFBQVEsRUFBRSxNQUFNLEVBQUUsSUFBSSxDQUFDLENBQUE7S0FDcEM7SUFFRCxLQUFLLE1BQU0sT0FBTyxJQUFJLEdBQUcsQ0FBQyxRQUFRLEVBQUU7UUFDaEMsU0FBUyxDQUFDLFFBQVEsRUFBRSxNQUFNLEVBQUUsT0FBTyxDQUFDLENBQUE7S0FDdkM7SUFFRCxTQUFTLENBQUMsUUFBUSxFQUFFLE1BQU0sRUFBRSxHQUFHLENBQUMsUUFBUSxDQUFDLENBQUE7SUFDekMsU0FBUyxDQUFDLFFBQVEsRUFBRSxNQUFNLEVBQUUsR0FBRyxDQUFDLFVBQVUsQ0FBQyxDQUFBO0lBQzNDLFNBQVMsQ0FBQyxRQUFRLEVBQUUsTUFBTSxFQUFFLEdBQUcsQ0FBQyxNQUFNLENBQUMsQ0FBQTtJQUV2QyxRQUFRLENBQUMsS0FBSyxFQUFFLENBQUE7QUFDcEIsQ0FBQztBQUVELFNBQVMsU0FBUyxDQUFDLFFBQXNCLEVBQUUsTUFBaUIsRUFBRSxFQUFZO0lBQ3RFLElBQUksQ0FBQyxFQUFFLENBQUMsVUFBVSxFQUFFO1FBQ2hCLE1BQU0sSUFBSSxLQUFLLENBQUMsNkJBQTZCLEVBQUUsQ0FBQyxJQUFJLGdCQUFnQixFQUFFLENBQUMsS0FBSyxFQUFFLENBQUMsQ0FBQTtLQUNsRjtJQUVELE1BQU0sRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLEdBQUcsRUFBRSxDQUFDLFFBQVEsQ0FBQTtJQUM1QixNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUUsRUFBRSxDQUFDLEVBQUUsRUFBRSxFQUFFLEdBQUcsTUFBTSxDQUFBO0lBRS9CLE1BQU0sTUFBTSxHQUFlO1FBQ3ZCLFFBQVEsRUFBRSxDQUFDLENBQUMsR0FBRyxRQUFRLEdBQUcsRUFBRSxFQUFFLENBQUMsR0FBRyxRQUFRLEdBQUcsRUFBRSxDQUFDO1FBQ2hELEtBQUssRUFBRSxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUNuQixLQUFLLEVBQUUsUUFBUTtRQUNmLE1BQU0sRUFBRSxRQUFRO1FBQ2hCLE9BQU8sRUFBRSxFQUFFLENBQUMsVUFBVSxDQUFDLE9BQU87UUFDOUIsS0FBSyxFQUFFLEVBQUUsQ0FBQyxVQUFVLENBQUMsWUFBWTtLQUNwQyxDQUFBO0lBRUQsUUFBUSxDQUFDLFVBQVUsQ0FBQyxNQUFNLENBQUMsQ0FBQTtBQUMvQixDQUFDO0FBRUQsU0FBUyxZQUFZLENBQUMsTUFBeUI7SUFDM0MsSUFBSSxNQUFNLENBQUMsS0FBSyxLQUFLLE1BQU0sQ0FBQyxXQUFXLElBQUksTUFBTSxDQUFDLE1BQU0sS0FBSyxNQUFNLENBQUMsWUFBWSxFQUFFO1FBQzlFLE9BQU07S0FDVDtJQUVELE1BQU0sQ0FBQyxLQUFLLEdBQUcsTUFBTSxDQUFDLFdBQVcsQ0FBQTtJQUNqQyxNQUFNLENBQUMsTUFBTSxHQUFHLE1BQU0sQ0FBQyxZQUFZLENBQUE7QUFDdkMsQ0FBQztBQUVELEtBQUssVUFBVSxJQUFJO0lBQ2YsTUFBTSxNQUFNLEdBQUcsR0FBRyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQXNCLENBQUE7SUFDdEQsTUFBTSxRQUFRLEdBQUcsSUFBSSxHQUFHLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxDQUFBO0lBRXpDLE1BQU0sTUFBTSxHQUFHLElBQUksRUFBRSxDQUFDLE1BQU0sQ0FBQztRQUN6QixJQUFJLEVBQUUsUUFBUTtRQUNkLFFBQVEsRUFBRSxJQUFJLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUM3QixRQUFRLEVBQUUsS0FBSztRQUNmLFdBQVcsRUFBRSxJQUFJO1FBQ2pCLEtBQUssRUFBRSxtQkFBbUI7S0FDN0IsQ0FBQyxDQUFBO0lBRUYsTUFBTSxHQUFHLEdBQUcsTUFBTSxXQUFXLENBQUMsTUFBTSxFQUFFLFFBQVEsRUFBRSxFQUFFLEVBQUUsRUFBRSxDQUFDLENBQUE7SUFDdkQsTUFBTSxJQUFJLEdBQUcsSUFBSSxLQUFLLENBQUMsSUFBSSxFQUFFLENBQUE7SUFDN0IscUJBQXFCLENBQUMsR0FBRyxFQUFFLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRSxJQUFJLEVBQUUsR0FBRyxDQUFDLENBQUMsQ0FBQTtBQUMxRCxDQUFDO0FBRUQsSUFBSSxFQUFFLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBkb20gZnJvbSBcIi4uL3NoYXJlZC9kb20uanNcIlxyXG5pbXBvcnQgKiBhcyBhcnJheSBmcm9tIFwiLi4vc2hhcmVkL2FycmF5LmpzXCJcclxuaW1wb3J0ICogYXMgZ2Z4IGZyb20gXCIuL2dmeC5qc1wiXHJcbmltcG9ydCAqIGFzIGdlbiBmcm9tIFwiLi9nZW4uanNcIlxyXG5pbXBvcnQgKiBhcyBpbnB1dCBmcm9tIFwiLi4vc2hhcmVkL2lucHV0LmpzXCJcclxuaW1wb3J0ICogYXMgcmwgZnJvbSBcIi4vcmwuanNcIlxyXG5pbXBvcnQgKiBhcyBnZW8gZnJvbSBcIi4uL3NoYXJlZC9nZW8yZC5qc1wiXHJcblxyXG5jb25zdCB0aWxlU2l6ZSA9IDI0XHJcblxyXG5hc3luYyBmdW5jdGlvbiBnZW5lcmF0ZU1hcChwbGF5ZXI6IHJsLlBsYXllciwgcmVuZGVyZXI6IGdmeC5SZW5kZXJlciwgd2lkdGg6IG51bWJlciwgaGVpZ2h0OiBudW1iZXIpOiBQcm9taXNlPGdlbi5NYXBEYXRhPiB7XHJcbiAgICBjb25zdCBtYXAgPSBnZW4uZ2VuZXJhdGVNYXAocGxheWVyLCB3aWR0aCwgaGVpZ2h0KVxyXG5cclxuICAgIC8vIGJha2UgYWxsIDI0eDI0IHRpbGUgaW1hZ2VzIHRvIGEgc2luZ2xlIGFycmF5IHRleHR1cmVcclxuICAgIC8vIHN0b3JlIG1hcHBpbmcgZnJvbSBpbWFnZSB1cmwgdG8gaW5kZXhcclxuICAgIGxldCBpbWFnZVVybHM6IHN0cmluZ1tdID0gW11cclxuICAgIGltYWdlVXJscy5wdXNoKC4uLm1hcC50aWxlcy5tYXAodCA9PiB0LmltYWdlKSlcclxuICAgIGltYWdlVXJscy5wdXNoKC4uLm1hcC5maXh0dXJlcy5tYXAodCA9PiB0LmltYWdlKSlcclxuICAgIGltYWdlVXJscy5wdXNoKG1hcC5zdGFpcnNVcC5pbWFnZSlcclxuICAgIGltYWdlVXJscy5wdXNoKG1hcC5zdGFpcnNEb3duLmltYWdlKVxyXG4gICAgaW1hZ2VVcmxzLnB1c2gobWFwLnBsYXllci5pbWFnZSlcclxuICAgIGltYWdlVXJscyA9IGltYWdlVXJscy5maWx0ZXIodXJsID0+IHVybClcclxuICAgIGltYWdlVXJscyA9IGFycmF5LmRpc3RpbmN0KGltYWdlVXJscylcclxuXHJcbiAgICBjb25zdCBsYXllck1hcCA9IG5ldyBNYXA8c3RyaW5nLCBudW1iZXI+KGltYWdlVXJscy5tYXAoKHVybCwgaSkgPT4gW3VybCwgaV0pKVxyXG4gICAgY29uc3QgaW1hZ2VzID0gYXdhaXQgUHJvbWlzZS5hbGwoaW1hZ2VVcmxzLm1hcCh1cmwgPT4gZG9tLmxvYWRJbWFnZSh1cmwpKSlcclxuICAgIGNvbnN0IHRleHR1cmUgPSByZW5kZXJlci5iYWtlVGV4dHVyZUFycmF5KHRpbGVTaXplLCB0aWxlU2l6ZSwgaW1hZ2VzKVxyXG5cclxuICAgIGNvbnN0IGluaXRSZW5kZXJEYXRhID0gKHRoOiBybC5UaGluZykgPT4ge1xyXG4gICAgICAgIGNvbnN0IGxheWVyID0gbGF5ZXJNYXAuZ2V0KHRoLmltYWdlKVxyXG4gICAgICAgIGlmIChsYXllciA9PT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgdGV4dHVyZSBpbmRleCBub3QgZm91bmQgZm9yICR7dGguaW1hZ2V9YClcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHRoLnJlbmRlckRhdGEgPSB7XHJcbiAgICAgICAgICAgIHRleHR1cmU6IHRleHR1cmUsXHJcbiAgICAgICAgICAgIHRleHR1cmVMYXllcjogbGF5ZXJcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgbWFwLnRpbGVzLmZvckVhY2goaW5pdFJlbmRlckRhdGEpXHJcbiAgICBtYXAuZml4dHVyZXMuZm9yRWFjaChpbml0UmVuZGVyRGF0YSlcclxuICAgIGluaXRSZW5kZXJEYXRhKG1hcC5zdGFpcnNVcClcclxuICAgIGluaXRSZW5kZXJEYXRhKG1hcC5zdGFpcnNEb3duKVxyXG4gICAgaW5pdFJlbmRlckRhdGEobWFwLnBsYXllcilcclxuXHJcbiAgICByZXR1cm4gbWFwXHJcbn1cclxuXHJcbmNvbnN0IGVycm9yc0RpdiA9IGRvbS5ieUlkKFwiZXJyb3JzXCIpO1xyXG5cclxuZnVuY3Rpb24gY2xlYXJFcnJvck1lc3NhZ2VzKCkge1xyXG4gICAgZG9tLnJlbW92ZUFsbENoaWxkcmVuKGVycm9yc0RpdilcclxufVxyXG5cclxuZnVuY3Rpb24gYXBwZW5kRXJyb3JNZXNzYWdlKGVycm9yOiBzdHJpbmcpIHtcclxuICAgIGNvbnNvbGUubG9nKGVycm9yKVxyXG4gICAgY29uc3QgZGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImRpdlwiKTtcclxuICAgIGRpdi5jbGFzc0xpc3QuYWRkKFwiZXJyb3ItbWVzc2FnZVwiKVxyXG4gICAgZGl2LnRleHRDb250ZW50ID0gZXJyb3JcclxuICAgIGVycm9yc0Rpdi5hcHBlbmRDaGlsZChkaXYpXHJcbn1cclxuXHJcbmZ1bmN0aW9uIHRpY2socmVuZGVyZXI6IGdmeC5SZW5kZXJlciwga2V5czogaW5wdXQuS2V5cywgbWFwOiBnZW4uTWFwRGF0YSkge1xyXG4gICAgaGFuZGxlSW5wdXQobWFwLCBrZXlzKVxyXG4gICAgZHJhd0ZyYW1lKHJlbmRlcmVyLCBtYXApXHJcbiAgICByZXF1ZXN0QW5pbWF0aW9uRnJhbWUoKCkgPT4gdGljayhyZW5kZXJlciwga2V5cywgbWFwKSlcclxufVxyXG5cclxuZnVuY3Rpb24gaGFuZGxlSW5wdXQobWFwOiBnZW4uTWFwRGF0YSwga2V5czogaW5wdXQuS2V5cykge1xyXG4gICAgY29uc3QgcGxheWVyID0gbWFwLnBsYXllclxyXG4gICAgY29uc3QgcG9zaXRpb24gPSBwbGF5ZXIucG9zaXRpb24uY2xvbmUoKVxyXG5cclxuICAgIGlmIChrZXlzLnByZXNzZWQoXCJ3XCIpKSB7XHJcbiAgICAgICAgcG9zaXRpb24ueSAtPSAxXHJcbiAgICB9XHJcblxyXG4gICAgaWYgKGtleXMucHJlc3NlZChcInNcIikpIHtcclxuICAgICAgICBwb3NpdGlvbi55ICs9IDFcclxuICAgIH1cclxuXHJcbiAgICBpZiAoa2V5cy5wcmVzc2VkKFwiYVwiKSkge1xyXG4gICAgICAgIHBvc2l0aW9uLnggLT0gMVxyXG4gICAgfVxyXG5cclxuICAgIGlmIChrZXlzLnByZXNzZWQoXCJkXCIpKSB7XHJcbiAgICAgICAgcG9zaXRpb24ueCArPSAxXHJcbiAgICB9XHJcblxyXG4gICAgaWYgKGlzUGFzc2FibGUobWFwLCBwb3NpdGlvbikpIHtcclxuICAgICAgICBwbGF5ZXIucG9zaXRpb24gPSBwb3NpdGlvblxyXG4gICAgfVxyXG5cclxuICAgIGtleXMudXBkYXRlKClcclxufVxyXG5cclxuZnVuY3Rpb24gaXNQYXNzYWJsZShtYXA6IGdlbi5NYXBEYXRhLCB4eTogZ2VvLlBvaW50KTogYm9vbGVhbiB7XHJcbiAgICBjb25zdCB0aWxlcyA9IGFycmF5LmZpbHRlcihtYXAudGlsZXMsIHQgPT4gdC5wb3NpdGlvbi5lcXVhbCh4eSkpXHJcbiAgICBmb3IgKGNvbnN0IHRpbGUgb2YgdGlsZXMpIHtcclxuICAgICAgICBpZiAoIXRpbGUucGFzc2FibGUpIHtcclxuICAgICAgICAgICAgcmV0dXJuIGZhbHNlXHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IGZpeHR1cmVzID0gYXJyYXkuZmlsdGVyKG1hcC5maXh0dXJlcywgdCA9PiB0LnBvc2l0aW9uLmVxdWFsKHh5KSlcclxuICAgIGZvciAoY29uc3QgZml4dHVyZSBvZiBmaXh0dXJlcykge1xyXG4gICAgICAgIGlmICghZml4dHVyZS5wYXNzYWJsZSkge1xyXG4gICAgICAgICAgICByZXR1cm4gZmFsc2VcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIHRydWVcclxufVxyXG5cclxuZnVuY3Rpb24gZHJhd0ZyYW1lKHJlbmRlcmVyOiBnZnguUmVuZGVyZXIsIG1hcDogZ2VuLk1hcERhdGEpIHtcclxuICAgIC8vIGNlbnRlciB0aGUgZ3JpZCBhcm91bmQgdGhlIHBsYXllclxyXG4gICAgY29uc3QgcGxheWVyQ29vcmRzID0gbWFwLnBsYXllci5wb3NpdGlvblxyXG4gICAgY29uc3QgY2VudGVyID0gbmV3IGdlby5Qb2ludChNYXRoLmZsb29yKChyZW5kZXJlci5jYW52YXMud2lkdGggLSB0aWxlU2l6ZSkgLyAyKSwgTWF0aC5mbG9vcigocmVuZGVyZXIuY2FudmFzLmhlaWdodCAtIHRpbGVTaXplKSAvIDIpKVxyXG4gICAgY29uc3Qgb2Zmc2V0ID0gY2VudGVyLnN1YlBvaW50KHBsYXllckNvb3Jkcy5tdWxTY2FsYXIocmwudGlsZVNpemUpKVxyXG5cclxuICAgIGhhbmRsZVJlc2l6ZShyZW5kZXJlci5jYW52YXMpXHJcblxyXG4gICAgLy8gZHJhdyB2YXJpb3VzIGxheWVycyBvZiBzcHJpdGVzXHJcbiAgICBmb3IgKGNvbnN0IHRpbGUgb2YgbWFwLnRpbGVzKSB7XHJcbiAgICAgICAgZHJhd1RoaW5nKHJlbmRlcmVyLCBvZmZzZXQsIHRpbGUpXHJcbiAgICB9XHJcblxyXG4gICAgZm9yIChjb25zdCBmaXh0dXJlIG9mIG1hcC5maXh0dXJlcykge1xyXG4gICAgICAgIGRyYXdUaGluZyhyZW5kZXJlciwgb2Zmc2V0LCBmaXh0dXJlKVxyXG4gICAgfVxyXG5cclxuICAgIGRyYXdUaGluZyhyZW5kZXJlciwgb2Zmc2V0LCBtYXAuc3RhaXJzVXApXHJcbiAgICBkcmF3VGhpbmcocmVuZGVyZXIsIG9mZnNldCwgbWFwLnN0YWlyc0Rvd24pXHJcbiAgICBkcmF3VGhpbmcocmVuZGVyZXIsIG9mZnNldCwgbWFwLnBsYXllcilcclxuXHJcbiAgICByZW5kZXJlci5mbHVzaCgpXHJcbn1cclxuXHJcbmZ1bmN0aW9uIGRyYXdUaGluZyhyZW5kZXJlcjogZ2Z4LlJlbmRlcmVyLCBvZmZzZXQ6IGdlby5Qb2ludCwgdGg6IHJsLlRoaW5nKSB7XHJcbiAgICBpZiAoIXRoLnJlbmRlckRhdGEpIHtcclxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYHJlbmRlckRhdGEgaXMgbm90IHNldCBmb3IgJHt0aC5uYW1lfSB3aXRoIGltYWdlOiAke3RoLmltYWdlfWApXHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgeyB4LCB5IH0gPSB0aC5wb3NpdGlvblxyXG4gICAgY29uc3QgeyB4OiBveCwgeTogb3kgfSA9IG9mZnNldFxyXG5cclxuICAgIGNvbnN0IHNwcml0ZTogZ2Z4LlNwcml0ZSA9IHtcclxuICAgICAgICBwb3NpdGlvbjogW3ggKiB0aWxlU2l6ZSArIG94LCB5ICogdGlsZVNpemUgKyBveV0sXHJcbiAgICAgICAgY29sb3I6IFsxLCAxLCAxLCAxXSxcclxuICAgICAgICB3aWR0aDogdGlsZVNpemUsXHJcbiAgICAgICAgaGVpZ2h0OiB0aWxlU2l6ZSxcclxuICAgICAgICB0ZXh0dXJlOiB0aC5yZW5kZXJEYXRhLnRleHR1cmUsXHJcbiAgICAgICAgbGF5ZXI6IHRoLnJlbmRlckRhdGEudGV4dHVyZUxheWVyXHJcbiAgICB9XHJcblxyXG4gICAgcmVuZGVyZXIuZHJhd1Nwcml0ZShzcHJpdGUpXHJcbn1cclxuXHJcbmZ1bmN0aW9uIGhhbmRsZVJlc2l6ZShjYW52YXM6IEhUTUxDYW52YXNFbGVtZW50KSB7XHJcbiAgICBpZiAoY2FudmFzLndpZHRoID09PSBjYW52YXMuY2xpZW50V2lkdGggJiYgY2FudmFzLmhlaWdodCA9PT0gY2FudmFzLmNsaWVudEhlaWdodCkge1xyXG4gICAgICAgIHJldHVyblxyXG4gICAgfVxyXG5cclxuICAgIGNhbnZhcy53aWR0aCA9IGNhbnZhcy5jbGllbnRXaWR0aFxyXG4gICAgY2FudmFzLmhlaWdodCA9IGNhbnZhcy5jbGllbnRIZWlnaHRcclxufVxyXG5cclxuYXN5bmMgZnVuY3Rpb24gbWFpbigpIHtcclxuICAgIGNvbnN0IGNhbnZhcyA9IGRvbS5ieUlkKFwiY2FudmFzXCIpIGFzIEhUTUxDYW52YXNFbGVtZW50XHJcbiAgICBjb25zdCByZW5kZXJlciA9IG5ldyBnZnguUmVuZGVyZXIoY2FudmFzKVxyXG5cclxuICAgIGNvbnN0IHBsYXllciA9IG5ldyBybC5QbGF5ZXIoe1xyXG4gICAgICAgIG5hbWU6IFwiUGxheWVyXCIsXHJcbiAgICAgICAgcG9zaXRpb246IG5ldyBnZW8uUG9pbnQoMCwgMCksXHJcbiAgICAgICAgcGFzc2FibGU6IGZhbHNlLFxyXG4gICAgICAgIHRyYW5zcGFyZW50OiB0cnVlLFxyXG4gICAgICAgIGltYWdlOiBcIi4vYXNzZXRzL2NoYXIucG5nXCJcclxuICAgIH0pXHJcblxyXG4gICAgY29uc3QgbWFwID0gYXdhaXQgZ2VuZXJhdGVNYXAocGxheWVyLCByZW5kZXJlciwgMzIsIDMyKVxyXG4gICAgY29uc3Qga2V5cyA9IG5ldyBpbnB1dC5LZXlzKClcclxuICAgIHJlcXVlc3RBbmltYXRpb25GcmFtZSgoKSA9PiB0aWNrKHJlbmRlcmVyLCBrZXlzLCBtYXApKVxyXG59XHJcblxyXG5tYWluKCkiXX0=