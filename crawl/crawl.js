import * as dom from "../shared/dom.js";
import * as array from "../shared/array.js";
import * as gfx from "./gfx.js";
import * as gen from "./gen.js";
import * as grid from "../shared/grid.js";
const tileSize = 24;
async function generateMap(renderer, width, height) {
    const gmap = gen.generateMap(width, height);
    // bake all 24x24 tile images to a single texture
    // store mapping from image url to index
    const imageUrls = array.mapDistinct(gen.iterThings(gmap), th => th.image);
    const layerMap = new Map(imageUrls.map((url, i) => [url, i]));
    const images = await Promise.all(imageUrls.map(url => dom.loadImage(url)));
    const texture = renderer.bakeTextureArray(tileSize, tileSize, images);
    const map = new grid.Grid(gmap.width, gmap.height, (x, y) => {
        const gtile = gmap.at(x, y);
        const tile = {
            things: []
        };
        for (const gthing of gtile.things) {
            const layer = layerMap.get(gthing.image);
            if (typeof layer === "undefined") {
                throw new Error(`texture index not found for ${gthing.image}`);
            }
            const thing = {
                name: gthing.name,
                texture: texture,
                textureLayer: layer
            };
            tile.things.push(thing);
        }
        return tile;
    });
    return map;
}
const errorsDiv = dom.byId("errors");
function clearErrorMessages() {
    dom.removeAllChildren(errorsDiv);
}
function appendErrorMessage(error) {
    console.log(error);
    const div = document.createElement("div");
    div.classList.add("error-message");
    div.textContent = error;
    errorsDiv.appendChild(div);
}
function tick(renderer, map) {
    for (let ty = 0; ty < map.height; ++ty) {
        for (let tx = 0; tx < map.width; ++tx) {
            const tile = map.at(tx, ty);
            const x = tx * tileSize;
            const y = ty * tileSize;
            for (const thing of tile.things) {
                const sprite = {
                    position: [x, y],
                    color: [1, 1, 1, 1],
                    width: tileSize,
                    height: tileSize,
                    texture: thing.texture,
                    layer: thing.textureLayer
                };
                renderer.drawSprite(sprite);
            }
        }
    }
    renderer.flush();
}
async function main() {
    const canvas = dom.byId("canvas");
    const renderer = new gfx.Renderer(canvas);
    const map = await generateMap(renderer, 32, 32);
    requestAnimationFrame(() => tick(renderer, map));
}
main();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3Jhd2wuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJjcmF3bC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEtBQUssR0FBRyxNQUFNLGtCQUFrQixDQUFBO0FBQ3ZDLE9BQU8sS0FBSyxLQUFLLE1BQU0sb0JBQW9CLENBQUE7QUFDM0MsT0FBTyxLQUFLLEdBQUcsTUFBTSxVQUFVLENBQUE7QUFDL0IsT0FBTyxLQUFLLEdBQUcsTUFBTSxVQUFVLENBQUE7QUFDL0IsT0FBTyxLQUFLLElBQUksTUFBTSxtQkFBbUIsQ0FBQTtBQUV6QyxNQUFNLFFBQVEsR0FBRyxFQUFFLENBQUE7QUFjbkIsS0FBSyxVQUFVLFdBQVcsQ0FBQyxRQUFzQixFQUFFLEtBQWEsRUFBRSxNQUFjO0lBQzVFLE1BQU0sSUFBSSxHQUFHLEdBQUcsQ0FBQyxXQUFXLENBQUMsS0FBSyxFQUFFLE1BQU0sQ0FBQyxDQUFBO0lBRTNDLGlEQUFpRDtJQUNqRCx3Q0FBd0M7SUFDeEMsTUFBTSxTQUFTLEdBQUcsS0FBSyxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLEtBQUssQ0FBQyxDQUFBO0lBQ3pFLE1BQU0sUUFBUSxHQUFHLElBQUksR0FBRyxDQUFpQixTQUFTLENBQUMsR0FBRyxDQUFDLENBQUMsR0FBRyxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFBO0lBQzdFLE1BQU0sTUFBTSxHQUFHLE1BQU0sT0FBTyxDQUFDLEdBQUcsQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUE7SUFDMUUsTUFBTSxPQUFPLEdBQUcsUUFBUSxDQUFDLGdCQUFnQixDQUFDLFFBQVEsRUFBRSxRQUFRLEVBQUUs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SyxFQUFFLENBQUE7QUFDcEIsQ0FBQztBQUdELEtBQUssVUFBVSxJQUFJO0lBQ2YsTUFBTSxNQUFNLEdBQUcsR0FBRyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQXNCLENBQUE7SUFDdEQsTUFBTSxRQUFRLEdBQUcsSUFBSSxHQUFHLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxDQUFBO0lBQ3pDLE1BQU0sR0FBRyxHQUFHLE1BQU0sV0FBVyxDQUFDLFFBQVEsRUFBRSxFQUFFLEVBQUUsRUFBRSxDQUFDLENBQUE7SUFDL0MscUJBQXFCLENBQUMsR0FBRyxFQUFFLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRSxHQUFHLENBQUMsQ0FBQyxDQUFBO0FBQ3BELENBQUM7QUFFRCxJQUFJLEVBQUUsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIGRvbSBmcm9tIFwiLi4vc2hhcmVkL2RvbS5qc1wiXHJcbmltcG9ydCAqIGFzIGFycmF5IGZyb20gXCIuLi9zaGFyZWQvYXJyYXkuanNcIlxyXG5pbXBvcnQgKiBhcyBnZnggZnJvbSBcIi4vZ2Z4LmpzXCJcclxuaW1wb3J0ICogYXMgZ2VuIGZyb20gXCIuL2dlbi5qc1wiXHJcbmltcG9ydCAqIGFzIGdyaWQgZnJvbSBcIi4uL3NoYXJlZC9ncmlkLmpzXCJcclxuXHJcbmNvbnN0IHRpbGVTaXplID0gMjRcclxuXHJcbmludGVyZmFjZSBUaGluZyB7XHJcbiAgICBuYW1lOiBzdHJpbmdcclxuICAgIHRleHR1cmU6IFdlYkdMVGV4dHVyZVxyXG4gICAgdGV4dHVyZUxheWVyOiBudW1iZXJcclxufVxyXG5cclxuaW50ZXJmYWNlIFRpbGUge1xyXG4gICAgdGhpbmdzOiBUaGluZ1tdXHJcbn1cclxuXHJcbnR5cGUgTWFwR3JpZCA9IGdyaWQuR3JpZDxUaWxlPlxyXG5cclxuYXN5bmMgZnVuY3Rpb24gZ2VuZXJhdGVNYXAocmVuZGVyZXI6IGdmeC5SZW5kZXJlciwgd2lkdGg6IG51bWJlciwgaGVpZ2h0OiBudW1iZXIpIHtcclxuICAgIGNvbnN0IGdtYXAgPSBnZW4uZ2VuZXJhdGVNYXAod2lkdGgsIGhlaWdodClcclxuXHJcbiAgICAvLyBiYWtlIGFsbCAyNHgyNCB0aWxlIGltYWdlcyB0byBhIHNpbmdsZSB0ZXh0dXJlXHJcbiAgICAvLyBzdG9yZSBtYXBwaW5nIGZyb20gaW1hZ2UgdXJsIHRvIGluZGV4XHJcbiAgICBjb25zdCBpbWFnZVVybHMgPSBhcnJheS5tYXBEaXN0aW5jdChnZW4uaXRlclRoaW5ncyhnbWFwKSwgdGggPT4gdGguaW1hZ2UpXHJcbiAgICBjb25zdCBsYXllck1hcCA9IG5ldyBNYXA8c3RyaW5nLCBudW1iZXI+KGltYWdlVXJscy5tYXAoKHVybCwgaSkgPT4gW3VybCwgaV0pKVxyXG4gICAgY29uc3QgaW1hZ2VzID0gYXdhaXQgUHJvbWlzZS5hbGwoaW1hZ2VVcmxzLm1hcCh1cmwgPT4gZG9tLmxvYWRJbWFnZSh1cmwpKSlcclxuICAgIGNvbnN0IHRleHR1cmUgPSByZW5kZXJlci5iYWtlVGV4dHVyZUFycmF5KHRpbGVTaXplLCB0aWxlU2l6ZSwgaW1hZ2VzKVxyXG5cclxuICAgIGNvbnN0IG1hcDogTWFwR3JpZCA9IG5ldyBncmlkLkdyaWQ8VGlsZT4oZ21hcC53aWR0aCwgZ21hcC5oZWlnaHQsICh4LCB5KSA9PiB7XHJcbiAgICAgICAgY29uc3QgZ3RpbGUgPSBnbWFwLmF0KHgsIHkpXHJcbiAgICAgICAgY29uc3QgdGlsZTogVGlsZSA9IHtcclxuICAgICAgICAgICAgdGhpbmdzOiBbXVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgZm9yIChjb25zdCBndGhpbmcgb2YgZ3RpbGUudGhpbmdzKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGxheWVyID0gbGF5ZXJNYXAuZ2V0KGd0aGluZy5pbWFnZSlcclxuICAgICAgICAgICAgaWYgKHR5cGVvZiBsYXllciA9PT0gXCJ1bmRlZmluZWRcIikge1xyXG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGB0ZXh0dXJlIGluZGV4IG5vdCBmb3VuZCBmb3IgJHtndGhpbmcuaW1hZ2V9YClcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgY29uc3QgdGhpbmc6IFRoaW5nID0ge1xyXG4gICAgICAgICAgICAgICAgbmFtZTogZ3RoaW5nLm5hbWUsXHJcbiAgICAgICAgICAgICAgICB0ZXh0dXJlOiB0ZXh0dXJlLFxyXG4gICAgICAgICAgICAgICAgdGV4dHVyZUxheWVyOiBsYXllclxyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICB0aWxlLnRoaW5ncy5wdXNoKHRoaW5nKVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIHRpbGVcclxuICAgIH0pXHJcblxyXG4gICAgcmV0dXJuIG1hcFxyXG59XHJcblxyXG5jb25zdCBlcnJvcnNEaXYgPSBkb20uYnlJZChcImVycm9yc1wiKTtcclxuXHJcbmZ1bmN0aW9uIGNsZWFyRXJyb3JNZXNzYWdlcygpIHtcclxuICAgIGRvbS5yZW1vdmVBbGxDaGlsZHJlbihlcnJvcnNEaXYpXHJcbn1cclxuXHJcbmZ1bmN0aW9uIGFwcGVuZEVycm9yTWVzc2FnZShlcnJvcjogc3RyaW5nKSB7XHJcbiAgICBjb25zb2xlLmxvZyhlcnJvcilcclxuICAgIGNvbnN0IGRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJkaXZcIik7XHJcbiAgICBkaXYuY2xhc3NMaXN0LmFkZChcImVycm9yLW1lc3NhZ2VcIilcclxuICAgIGRpdi50ZXh0Q29udGVudCA9IGVycm9yXHJcbiAgICBlcnJvcnNEaXYuYXBwZW5kQ2hpbGQoZGl2KVxyXG59XHJcblxyXG5mdW5jdGlvbiB0aWNrKHJlbmRlcmVyOiBnZnguUmVuZGVyZXIsIG1hcDogVGlsZU1hcCkge1xyXG4gICAgZm9yIChsZXQgdHkgPSAwOyB0eSA8IG1hcC5oZWlnaHQ7ICsrdHkpIHtcclxuICAgICAgICBmb3IgKGxldCB0eCA9IDA7IHR4IDwgbWFwLndpZHRoOyArK3R4KSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHRpbGUgPSBtYXAuYXQodHgsIHR5KVxyXG4gICAgICAgICAgICBjb25zdCB4ID0gdHggKiB0aWxlU2l6ZVxyXG4gICAgICAgICAgICBjb25zdCB5ID0gdHkgKiB0aWxlU2l6ZVxyXG4gICAgICAgICAgICBmb3IgKGNvbnN0IHRoaW5nIG9mIHRpbGUudGhpbmdzKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBzcHJpdGU6IGdmeC5TcHJpdGUgPSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcG9zaXRpb246IFt4LCB5XSxcclxuICAgICAgICAgICAgICAgICAgICBjb2xvcjogWzEsIDEsIDEsIDFdLFxyXG4gICAgICAgICAgICAgICAgICAgIHdpZHRoOiB0aWxlU2l6ZSxcclxuICAgICAgICAgICAgICAgICAgICBoZWlnaHQ6IHRpbGVTaXplLFxyXG4gICAgICAgICAgICAgICAgICAgIHRleHR1cmU6IHRoaW5nLnRleHR1cmUsXHJcbiAgICAgICAgICAgICAgICAgICAgbGF5ZXI6IHRoaW5nLnRleHR1cmVMYXllclxyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIHJlbmRlcmVyLmRyYXdTcHJpdGUoc3ByaXRlKVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHJlbmRlcmVyLmZsdXNoKClcclxufVxyXG5cclxuXHJcbmFzeW5jIGZ1bmN0aW9uIG1haW4oKSB7XHJcbiAgICBjb25zdCBjYW52YXMgPSBkb20uYnlJZChcImNhbnZhc1wiKSBhcyBIVE1MQ2FudmFzRWxlbWVudFxyXG4gICAgY29uc3QgcmVuZGVyZXIgPSBuZXcgZ2Z4LlJlbmRlcmVyKGNhbnZhcylcclxuICAgIGNvbnN0IG1hcCA9IGF3YWl0IGdlbmVyYXRlTWFwKHJlbmRlcmVyLCAzMiwgMzIpXHJcbiAgICByZXF1ZXN0QW5pbWF0aW9uRnJhbWUoKCkgPT4gdGljayhyZW5kZXJlciwgbWFwKSlcclxufVxyXG5cclxubWFpbigpIl19