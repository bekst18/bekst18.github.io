/**
 * map generation library
 */
import * as array from "../shared/array.js";
import * as grid from "../shared/grid.js";
import * as rnd from "../shared/rand.js";
const roomSizes = [5, 7, 9, 11];
const hallLengths = [5, 7, 9, 11];
var TileType;
(function (TileType) {
    TileType[TileType["Door"] = 0] = "Door";
    TileType[TileType["Wall"] = 1] = "Wall";
    TileType[TileType["Interior"] = 2] = "Interior";
    TileType[TileType["Exterior"] = 3] = "Exterior";
})(TileType || (TileType = {}));
var RegionType;
(function (RegionType) {
    RegionType[RegionType["Hallway"] = 0] = "Hallway";
    RegionType[RegionType["Room"] = 1] = "Room";
})(RegionType || (RegionType = {}));
export function generateMap(width, height) {
    const rooms = generateRooms(width, height);
    const map = new grid.Grid(width, height, () => ({ things: [] }));
    for (const [x, y, type] of rooms.scan()) {
        switch (type) {
            case TileType.Door:
                map.at(x, y).things.push({
                    name: "Door",
                    image: "./assets/closed.png"
                });
                break;
            case TileType.Wall:
                map.at(x, y).things.push({
                    name: "Door",
                    image: "./assets/wall.png"
                });
                break;
            case TileType.Interior:
                map.at(x, y).things.push({
                    name: "Door",
                    image: "./assets/floor.png"
                });
                break;
            case TileType.Exterior:
                break;
        }
    }
    return map;
}
export function* iterThings(grd) {
    for (const tile of grd) {
        for (const thing of tile.things) {
            yield thing;
        }
    }
}
function generateRooms(width, height) {
    const grd = new grid.Grid(width, height, () => TileType.Exterior);
    const regionStack = [];
    const regions = [];
    const maxRooms = 128;
    // place initial room
    {
        const minRoomSize = roomSizes.reduce((x, y) => x < y ? x : y);
        const maxRoomSize = roomSizes.reduce((x, y) => x > y ? x : y);
        const x = rnd.int(0, grd.width - minRoomSize);
        const y = rnd.int(0, grd.height - minRoomSize);
        const size = rnd.int(minRoomSize, Math.min(maxRoomSize, grd.width - x, grd.height - y));
        const region = {
            rect: { x: x, y: y, width: size, height: size },
            nonOverlappingRect: { x: x, y: y, width: size, height: size },
            depth: 0,
            type: RegionType.Room
        };
        if (!tryPlaceRegion(grd, region)) {
            throw new Error("Failed to place initial region");
        }
        regionStack.push(region);
        regions.push(region);
    }
    let numRooms = 1;
    while (true) {
        if (regionStack.length <= 0) {
            console.log("No more tunnel rooms");
            break;
        }
        if (numRooms >= maxRooms) {
            console.log("Max rooms reached");
            break;
        }
        // take region off of the stack
        const region = array.pop(regionStack);
        // try to tunnel from this region
        const nextRegion = tryTunnels(grd, region);
        if (!nextRegion) {
            continue;
        }
        nextRegion.depth = region.depth + 1;
        regionStack.push(region);
        regionStack.push(nextRegion);
        regions.push(nextRegion);
        if (nextRegion.type === RegionType.Room) {
            numRooms++;
        }
    }
    // remove dead end hallways
    for (const region of regions) {
        if (region.type !== RegionType.Hallway) {
            continue;
        }
        const numDoors = array.countIf(grd.iterRect(region.rect), t => t === TileType.Door);
        if (numDoors > 1) {
            continue;
        }
        for (const [x, y] of grd.scanRect(region.nonOverlappingRect)) {
            grd.set(x, y, TileType.Exterior);
        }
        for (const [x, y, t] of grd.scanRect(region.rect)) {
            if (t === TileType.Door) {
                grd.set(x, y, TileType.Wall);
            }
        }
    }
    const firstRegion = regions.reduce((x, y) => x.depth < y.depth ? x : y);
    const lastRegion = regions.reduce((x, y) => x.depth > y.depth ? x : y);
    console.log(`Placed ${numRooms} rooms`);
    return grd;
}
function tryTunnels(grd, region) {
    // try to tunnel from this room
    const tunnels = [];
    for (const [x, y] of grd.scanRect(region.rect)) {
        if (isTunnelable(grd, x, y)) {
            tunnels.push([x, y]);
        }
    }
    rnd.shuffle(tunnels);
    // try each tunnelable location
    while (tunnels.length > 0) {
        // find a place to begin tunneling to next room
        const [tx, ty] = array.pop(tunnels);
        const nxy = findTunnelableNeighbor(grd, tx, ty);
        if (!nxy) {
            continue;
        }
        const [nx, ny] = nxy;
        const nextRegion = tryTunnel(grd, region, tx, ty, nx, ny);
        if (nextRegion) {
            return nextRegion;
        }
    }
    return null;
}
function tryTunnel(grd, region, tx, ty, nx, ny) {
    switch (region.type) {
        case RegionType.Hallway:
            return tryRoom(grd, tx, ty, nx, ny);
        case RegionType.Room:
            return tryHallway(grd, tx, ty, nx, ny);
    }
}
function tryHallway(grd, tx, ty, nx, ny) {
    rnd.shuffle(hallLengths);
    for (const length of hallLengths) {
        // for nx / ny
        // nx === cx = vertical hallway
        // ny === cy = horizontal hallway
        const width = ny === ty ? length : 3;
        const height = nx === tx ? length : 3;
        const region = tryPlaceAdjacentRegion(grd, RegionType.Hallway, tx, ty, nx, ny, width, height);
        if (region) {
            return region;
        }
    }
    return null;
}
function tryRoom(grd, tx, ty, nx, ny) {
    // try placing a room here
    rnd.shuffle(roomSizes);
    for (const size of roomSizes) {
        const region = tryPlaceAdjacentRegion(grd, RegionType.Room, tx, ty, nx, ny, size, size);
        if (region) {
            return region;
        }
    }
    return null;
}
function tryPlaceAdjacentRegion(grd, type, tx, ty, nx, ny, width, height) {
    // for nx / ny
    // nx < tx - horizontal - right to left
    // nx > tx - horizontal - left to right
    // ny < ty - vertical - bottom to top
    // ny > ty - vertical - top to bottom
    // for each case - find hallway rect, find check overlap rect
    const region = {
        rect: { x: 0, y: 0, width: 0, height: 0 },
        nonOverlappingRect: { x: 0, y: 0, width: 0, height: 0 },
        depth: 0,
        type: type
    };
    if (nx < tx) {
        // right to left
        const x = tx - width + 1;
        const y = ty - Math.floor(height / 2);
        region.rect = { x: x, y: y, width: width, height: height };
        region.nonOverlappingRect = { x: x, y: y, width: width - 1, height: height };
    }
    else if (nx > tx) {
        // left to right
        const x = tx;
        const y = ty - Math.floor(height / 2);
        region.rect = { x: x, y: y, width: width, height: height };
        region.nonOverlappingRect = { x: x + 1, y: y, width: width - 1, height: height };
    }
    else if (ny < ty) {
        // bottom to top
        const x = tx - Math.floor(width / 2);
        const y = ty - height + 1;
        region.rect = { x: x, y: y, width: width, height: height };
        region.nonOverlappingRect = { x: x, y: y, width: width, height: height - 1 };
    }
    else if (ny > ty) {
        // top to bottom
        const x = tx - Math.floor(width / 2);
        const y = ty;
        region.rect = { x: x, y: y, width: width, height: height };
        region.nonOverlappingRect = { x: x, y: y + 1, width: width, height: height - 1 };
    }
    else {
        throw new Error("invalid tunnel position");
    }
    const success = tryPlaceRegion(grd, region);
    if (!success) {
        return null;
    }
    grd.set(tx, ty, TileType.Door);
    return region;
}
function tryPlaceRegion(grd, region) {
    const { x, y, width, height } = region.rect;
    if (!grd.regionInBounds(x, y, width, height)) {
        return false;
    }
    const { x: nx, y: ny, width: nwidth, height: nheight } = region.nonOverlappingRect;
    if (!regionIsExterior(grd, nx, ny, nwidth, nheight)) {
        return false;
    }
    encloseRoom(x, y, width, height, grd);
    return true;
}
function isTunnelable(grid, x, y) {
    return findTunnelableNeighbor(grid, x, y) != null;
}
function findTunnelableNeighbor(grid, x, y) {
    if (x === 0 || y === 0 || x === grid.width - 1 || y === grid.height - 1) {
        return null;
    }
    if (grid.at(x - 1, y) === TileType.Exterior && grid.at(x + 1, y) === TileType.Interior) {
        return [x - 1, y];
    }
    if (grid.at(x, y + 1) === TileType.Exterior && grid.at(x, y - 1) === TileType.Interior) {
        return [x, y + 1];
    }
    if (grid.at(x + 1, y) === TileType.Exterior && grid.at(x - 1, y) === TileType.Interior) {
        return [x + 1, y];
    }
    if (grid.at(x, y - 1) === TileType.Exterior && grid.at(x, y + 1) === TileType.Interior) {
        return [x, y - 1];
    }
    return null;
}
function encloseRoom(x0, y0, width, height, grid) {
    const r = x0 + width - 1;
    const b = y0 + height - 1;
    for (const [x, y] of grid.scanRegion(x0, y0, width, height)) {
        if (x === x0 || y == y0 || x === r || y === b) {
            grid.set(x, y, TileType.Wall);
            continue;
        }
        grid.set(x, y, TileType.Interior);
    }
}
function regionIsExterior(grid, x0, y0, width, height) {
    const exterior = array.all(grid.iterRegion(x0, y0, width, height), x => x == TileType.Exterior);
    return exterior;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2VuLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiZ2VuLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOztHQUVHO0FBQ0gsT0FBTyxLQUFLLEtBQUssTUFBTSxvQkFBb0IsQ0FBQTtBQUMzQyxPQUFPLEtBQUssSUFBSSxNQUFNLG1CQUFtQixDQUFBO0FBQ3pDLE9BQU8sS0FBSyxHQUFHLE1BQU0sbUJBQW1CLENBQUE7QUFFeEMsTUFBTSxTQUFTLEdBQUcsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQTtBQUMvQixNQUFNLFdBQVcsR0FBRyxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFBO0FBRWpDLElBQUssUUFLSjtBQUxELFdBQUssUUFBUTtJQUNULHVDQUFJLENBQUE7SUFDSix1Q0FBSSxDQUFBO0lBQ0osK0NBQVEsQ0FBQTtJQUNSLCtDQUFRLENBQUE7QUFDWixDQUFDLEVBTEksUUFBUSxLQUFSLFFBQVEsUUFLWjtBQUVELElBQUssVUFHSjtBQUhELFdBQUssVUFBVTtJQUNYLGlEQUFPLENBQUE7SUFDUCwyQ0FBSSxDQUFBO0FBQ1IsQ0FBQyxFQUhJLFVBQVUsS0FBVixVQUFVLFFBR2Q7QUFvQkQsTUFBTSxVQUFVLFdBQVcsQ0FBQyxLQUFhLEVBQUUsTUFBYztJQUNyRCxNQUFNLEtBQUssR0FBRyxhQUFhLENBQUMsS0FBSyxFQUFFLE1BQU0sQ0FBQyxDQUFBO0lBQzFDLE1BQU0sR0FBRyxHQUFHLElBQUksSUFBSSxDQUFDLElBQUksQ0FBTyxLQUFLLEVBQUUsTUFBTSxFQUFFLEdBQUcsRUFBRSxDQUFDLENBQUMsRUFBRSxNQUFNLEVBQUUsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFBO0lBRXRFLEtBQUssTUFBTSxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsSUFBSSxDQUFDLElBQUksS0FBSyxDQUFDLElBQUksRUFBRSxFQUFFO1FBQ3JDLFFBQVEsSUFB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QyxFQUFFLE1BQU0sRUFBRSxDQUFDLEVBQUU7UUFDdkQsS0FBSyxFQUFFLENBQUM7UUFDUixJQUFJLEVBQUUsSUFBSTtLQUNiLENBQUE7SUFFRCxJQUFJLEVBQUUsR0FBRyxFQUFFLEVBQUU7UUFDVCxnQkFBZ0I7UUFDaEIsTUFBTSxDQUFDLEdBQUcsRUFBRSxHQUFHLEtBQUssR0FBRyxDQUFDLENBQUE7UUFDeEIsTUFBTSxDQUFDLEdBQUcsRUFBRSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFBO1FBQ3JDLE1BQU0sQ0FBQyxJQUFJLEdBQUcsRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxNQUFNLEVBQUUsTUFBTSxFQUFFLENBQUE7UUFDMUQsTUFBTSxDQUFDLGtCQUFrQixHQUFHLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLEtBQUssRUFBRSxLQUFLLEdBQUcsQ0FBQyxFQUFFLE1BQU0sRUFBRSxNQUFNLEVBQUUsQ0FBQTtLQUMvRTtTQUFNLElBQUksRUFBRSxHQUFHLEVBQUUsRUFBRTtRQUNoQixnQkFBZ0I7UUFDaEIsTUFBTSxDQUFDLEdBQUcsRUFBRSxDQUFBO1FBQ1osTUFBTSxDQUFDLEdBQUcsRUFBRSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFBO1FBQ3JDLE1BQU0sQ0FBQyxJQUFJLEdBQUcsRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxNQUFNLEVBQUUsTUFBTSxFQUFFLENBQUE7UUFDMUQsTUFBTSxDQUFDLGtCQUFrQixHQUFHLEVBQUUsQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxLQUFLLEVBQUUsS0FBSyxHQUFHLENBQUMsRUFBRSxNQUFNLEVBQUUsTUFBTSxFQUFFLENBQUE7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QyxDQUFDLEVBQUUsQ0FBQyxDQUFDLElBQUksUUFBUSxDQUFDLFFBQVEsQ0FBQyxDQUFBO0lBQy9GLE9BQU8sUUFBUSxDQUFBO0FBQ25CLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcclxuICogbWFwIGdlbmVyYXRpb24gbGlicmFyeVxyXG4gKi9cclxuaW1wb3J0ICogYXMgYXJyYXkgZnJvbSBcIi4uL3NoYXJlZC9hcnJheS5qc1wiXHJcbmltcG9ydCAqIGFzIGdyaWQgZnJvbSBcIi4uL3NoYXJlZC9ncmlkLmpzXCJcclxuaW1wb3J0ICogYXMgcm5kIGZyb20gXCIuLi9zaGFyZWQvcmFuZC5qc1wiXHJcblxyXG5jb25zdCByb29tU2l6ZXMgPSBbNSwgNywgOSwgMTFdXHJcbmNvbnN0IGhhbGxMZW5ndGhzID0gWzUsIDcsIDksIDExXVxyXG5cclxuZW51bSBUaWxlVHlwZSB7XHJcbiAgICBEb29yLFxyXG4gICAgV2FsbCxcclxuICAgIEludGVyaW9yLFxyXG4gICAgRXh0ZXJpb3JcclxufVxyXG5cclxuZW51bSBSZWdpb25UeXBlIHtcclxuICAgIEhhbGx3YXksXHJcbiAgICBSb29tXHJcbn1cclxuXHJcbmludGVyZmFjZSBSZWdpb24ge1xyXG4gICAgcmVjdDogZ3JpZC5SZWN0LFxyXG4gICAgbm9uT3ZlcmxhcHBpbmdSZWN0OiBncmlkLlJlY3QsXHJcbiAgICBkZXB0aDogbnVtYmVyLFxyXG4gICAgdHlwZTogUmVnaW9uVHlwZVxyXG59XHJcblxyXG50eXBlIENvb3JkcyA9IFtudW1iZXIsIG51bWJlcl1cclxuXHJcbmludGVyZmFjZSBUaGluZyB7XHJcbiAgICBuYW1lOiBzdHJpbmdcclxuICAgIGltYWdlOiBzdHJpbmdcclxufVxyXG5cclxuaW50ZXJmYWNlIFRpbGUge1xyXG4gICAgdGhpbmdzOiBUaGluZ1tdXHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBnZW5lcmF0ZU1hcCh3aWR0aDogbnVtYmVyLCBoZWlnaHQ6IG51bWJlcik6IGdyaWQuR3JpZDxUaWxlPiB7XHJcbiAgICBjb25zdCByb29tcyA9IGdlbmVyYXRlUm9vbXMod2lkdGgsIGhlaWdodClcclxuICAgIGNvbnN0IG1hcCA9IG5ldyBncmlkLkdyaWQ8VGlsZT4od2lkdGgsIGhlaWdodCwgKCkgPT4gKHsgdGhpbmdzOiBbXSB9KSlcclxuXHJcbiAgICBmb3IgKGNvbnN0IFt4LCB5LCB0eXBlXSBvZiByb29tcy5zY2FuKCkpIHtcclxuICAgICAgICBzd2l0Y2ggKHR5cGUpIHtcclxuICAgICAgICAgICAgY2FzZSBUaWxlVHlwZS5Eb29yOlxyXG4gICAgICAgICAgICAgICAgbWFwLmF0KHgsIHkpLnRoaW5ncy5wdXNoKHtcclxuICAgICAgICAgICAgICAgICAgICBuYW1lOiBcIkRvb3JcIixcclxuICAgICAgICAgICAgICAgICAgICBpbWFnZTogXCIuL2Fzc2V0cy9jbG9zZWQucG5nXCJcclxuICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuXHJcbiAgICAgICAgICAgIGNhc2UgVGlsZVR5cGUuV2FsbDpcclxuICAgICAgICAgICAgICAgIG1hcC5hdCh4LCB5KS50aGluZ3MucHVzaCh7XHJcbiAgICAgICAgICAgICAgICAgICAgbmFtZTogXCJEb29yXCIsXHJcbiAgICAgICAgICAgICAgICAgICAgaW1hZ2U6IFwiLi9hc3NldHMvd2FsbC5wbmdcIlxyXG4gICAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG5cclxuICAgICAgICAgICAgY2FzZSBUaWxlVHlwZS5JbnRlcmlvcjpcclxuICAgICAgICAgICAgICAgIG1hcC5hdCh4LCB5KS50aGluZ3MucHVzaCh7XHJcbiAgICAgICAgICAgICAgICAgICAgbmFtZTogXCJEb29yXCIsXHJcbiAgICAgICAgICAgICAgICAgICAgaW1hZ2U6IFwiLi9hc3NldHMvZmxvb3IucG5nXCJcclxuICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuXHJcbiAgICAgICAgICAgIGNhc2UgVGlsZVR5cGUuRXh0ZXJpb3I6XHJcbiAgICAgICAgICAgICAgICBicmVha1xyXG5cclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIG1hcFxyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24qIGl0ZXJUaGluZ3MoZ3JkOiBncmlkLkdyaWQ8VGlsZT4pIHtcclxuICAgIGZvciAoY29uc3QgdGlsZSBvZiBncmQpIHtcclxuICAgICAgICBmb3IgKGNvbnN0IHRoaW5nIG9mIHRpbGUudGhpbmdzKSB7XHJcbiAgICAgICAgICAgIHlpZWxkIHRoaW5nXHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG59XHJcblxyXG5mdW5jdGlvbiBnZW5lcmF0ZVJvb21zKHdpZHRoOiBudW1iZXIsIGhlaWdodDogbnVtYmVyKTogZ3JpZC5HcmlkPFRpbGVUeXBlPiB7XHJcbiAgICBjb25zdCBncmQgPSBuZXcgZ3JpZC5HcmlkPFRpbGVUeXBlPih3aWR0aCwgaGVpZ2h0LCAoKSA9PiBUaWxlVHlwZS5FeHRlcmlvcilcclxuICAgIGNvbnN0IHJlZ2lvblN0YWNrOiBSZWdpb25bXSA9IFtdXHJcbiAgICBjb25zdCByZWdpb25zOiBSZWdpb25bXSA9IFtdXHJcbiAgICBjb25zdCBtYXhSb29tcyA9IDEyOFxyXG5cclxuICAgIC8vIHBsYWNlIGluaXRpYWwgcm9vbVxyXG4gICAge1xyXG4gICAgICAgIGNvbnN0IG1pblJvb21TaXplID0gcm9vbVNpemVzLnJlZHVjZSgoeCwgeSkgPT4geCA8IHkgPyB4IDogeSlcclxuICAgICAgICBjb25zdCBtYXhSb29tU2l6ZSA9IHJvb21TaXplcy5yZWR1Y2UoKHgsIHkpID0+IHggPiB5ID8geCA6IHkpXHJcbiAgICAgICAgY29uc3QgeCA9IHJuZC5pbnQoMCwgZ3JkLndpZHRoIC0gbWluUm9vbVNpemUpXHJcbiAgICAgICAgY29uc3QgeSA9IHJuZC5pbnQoMCwgZ3JkLmhlaWdodCAtIG1pblJvb21TaXplKVxyXG4gICAgICAgIGNvbnN0IHNpemUgPSBybmQuaW50KG1pblJvb21TaXplLCBNYXRoLm1pbihtYXhSb29tU2l6ZSwgZ3JkLndpZHRoIC0geCwgZ3JkLmhlaWdodCAtIHkpKVxyXG4gICAgICAgIGNvbnN0IHJlZ2lvbjogUmVnaW9uID0ge1xyXG4gICAgICAgICAgICByZWN0OiB7IHg6IHgsIHk6IHksIHdpZHRoOiBzaXplLCBoZWlnaHQ6IHNpemUgfSxcclxuICAgICAgICAgICAgbm9uT3ZlcmxhcHBpbmdSZWN0OiB7IHg6IHgsIHk6IHksIHdpZHRoOiBzaXplLCBoZWlnaHQ6IHNpemUgfSxcclxuICAgICAgICAgICAgZGVwdGg6IDAsXHJcbiAgICAgICAgICAgIHR5cGU6IFJlZ2lvblR5cGUuUm9vbVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKCF0cnlQbGFjZVJlZ2lvbihncmQsIHJlZ2lvbikpIHtcclxuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiRmFpbGVkIHRvIHBsYWNlIGluaXRpYWwgcmVnaW9uXCIpXHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZWdpb25TdGFjay5wdXNoKHJlZ2lvbilcclxuICAgICAgICByZWdpb25zLnB1c2gocmVnaW9uKVxyXG4gICAgfVxyXG5cclxuICAgIGxldCBudW1Sb29tcyA9IDFcclxuICAgIHdoaWxlICh0cnVlKSB7XHJcbiAgICAgICAgaWYgKHJlZ2lvblN0YWNrLmxlbmd0aCA8PSAwKSB7XHJcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiTm8gbW9yZSB0dW5uZWwgcm9vbXNcIilcclxuICAgICAgICAgICAgYnJlYWtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmIChudW1Sb29tcyA+PSBtYXhSb29tcykge1xyXG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcIk1heCByb29tcyByZWFjaGVkXCIpXHJcbiAgICAgICAgICAgIGJyZWFrXHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAvLyB0YWtlIHJlZ2lvbiBvZmYgb2YgdGhlIHN0YWNrXHJcbiAgICAgICAgY29uc3QgcmVnaW9uID0gYXJyYXkucG9wKHJlZ2lvblN0YWNrKVxyXG5cclxuICAgICAgICAvLyB0cnkgdG8gdHVubmVsIGZyb20gdGhpcyByZWdpb25cclxuICAgICAgICBjb25zdCBuZXh0UmVnaW9uID0gdHJ5VHVubmVscyhncmQsIHJlZ2lvbilcclxuICAgICAgICBpZiAoIW5leHRSZWdpb24pIHtcclxuICAgICAgICAgICAgY29udGludWVcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIG5leHRSZWdpb24uZGVwdGggPSByZWdpb24uZGVwdGggKyAxXHJcbiAgICAgICAgcmVnaW9uU3RhY2sucHVzaChyZWdpb24pXHJcbiAgICAgICAgcmVnaW9uU3RhY2sucHVzaChuZXh0UmVnaW9uKVxyXG4gICAgICAgIHJlZ2lvbnMucHVzaChuZXh0UmVnaW9uKVxyXG5cclxuICAgICAgICBpZiAobmV4dFJlZ2lvbi50eXBlID09PSBSZWdpb25UeXBlLlJvb20pIHtcclxuICAgICAgICAgICAgbnVtUm9vbXMrK1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvLyByZW1vdmUgZGVhZCBlbmQgaGFsbHdheXNcclxuICAgIGZvciAoY29uc3QgcmVnaW9uIG9mIHJlZ2lvbnMpIHtcclxuICAgICAgICBpZiAocmVnaW9uLnR5cGUgIT09IFJlZ2lvblR5cGUuSGFsbHdheSkge1xyXG4gICAgICAgICAgICBjb250aW51ZVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgY29uc3QgbnVtRG9vcnMgPSBhcnJheS5jb3VudElmKGdyZC5pdGVyUmVjdChyZWdpb24ucmVjdCksIHQgPT4gdCA9PT0gVGlsZVR5cGUuRG9vcilcclxuICAgICAgICBpZiAobnVtRG9vcnMgPiAxKSB7XHJcbiAgICAgICAgICAgIGNvbnRpbnVlXHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBmb3IgKGNvbnN0IFt4LCB5XSBvZiBncmQuc2NhblJlY3QocmVnaW9uLm5vbk92ZXJsYXBwaW5nUmVjdCkpIHtcclxuICAgICAgICAgICAgZ3JkLnNldCh4LCB5LCBUaWxlVHlwZS5FeHRlcmlvcilcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGZvciAoY29uc3QgW3gsIHksIHRdIG9mIGdyZC5zY2FuUmVjdChyZWdpb24ucmVjdCkpIHtcclxuICAgICAgICAgICAgaWYgKHQgPT09IFRpbGVUeXBlLkRvb3IpIHtcclxuICAgICAgICAgICAgICAgIGdyZC5zZXQoeCwgeSwgVGlsZVR5cGUuV2FsbClcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBmaXJzdFJlZ2lvbiA9IHJlZ2lvbnMucmVkdWNlKCh4LCB5KSA9PiB4LmRlcHRoIDwgeS5kZXB0aCA/IHggOiB5KVxyXG4gICAgY29uc3QgbGFzdFJlZ2lvbiA9IHJlZ2lvbnMucmVkdWNlKCh4LCB5KSA9PiB4LmRlcHRoID4geS5kZXB0aCA/IHggOiB5KVxyXG4gICAgY29uc29sZS5sb2coYFBsYWNlZCAke251bVJvb21zfSByb29tc2ApXHJcblxyXG4gICAgcmV0dXJuIGdyZFxyXG59XHJcblxyXG5mdW5jdGlvbiB0cnlUdW5uZWxzKGdyZDogZ3JpZC5HcmlkPFRpbGVUeXBlPiwgcmVnaW9uOiBSZWdpb24pOiAoUmVnaW9uIHwgbnVsbCkge1xyXG4gICAgLy8gdHJ5IHRvIHR1bm5lbCBmcm9tIHRoaXMgcm9vbVxyXG4gICAgY29uc3QgdHVubmVsczogQ29vcmRzW10gPSBbXVxyXG4gICAgZm9yIChjb25zdCBbeCwgeV0gb2YgZ3JkLnNjYW5SZWN0KHJlZ2lvbi5yZWN0KSkge1xyXG4gICAgICAgIGlmIChpc1R1bm5lbGFibGUoZ3JkLCB4LCB5KSkge1xyXG4gICAgICAgICAgICB0dW5uZWxzLnB1c2goW3gsIHldKVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBybmQuc2h1ZmZsZSh0dW5uZWxzKVxyXG5cclxuICAgIC8vIHRyeSBlYWNoIHR1bm5lbGFibGUgbG9jYXRpb25cclxuICAgIHdoaWxlICh0dW5uZWxzLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAvLyBmaW5kIGEgcGxhY2UgdG8gYmVnaW4gdHVubmVsaW5nIHRvIG5leHQgcm9vbVxyXG4gICAgICAgIGNvbnN0IFt0eCwgdHldID0gYXJyYXkucG9wKHR1bm5lbHMpXHJcbiAgICAgICAgY29uc3Qgbnh5ID0gZmluZFR1bm5lbGFibGVOZWlnaGJvcihncmQsIHR4LCB0eSlcclxuICAgICAgICBpZiAoIW54eSkge1xyXG4gICAgICAgICAgICBjb250aW51ZVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgY29uc3QgW254LCBueV0gPSBueHlcclxuICAgICAgICBjb25zdCBuZXh0UmVnaW9uID0gdHJ5VHVubmVsKGdyZCwgcmVnaW9uLCB0eCwgdHksIG54LCBueSlcclxuICAgICAgICBpZiAobmV4dFJlZ2lvbikge1xyXG4gICAgICAgICAgICByZXR1cm4gbmV4dFJlZ2lvblxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gbnVsbFxyXG59XHJcblxyXG5mdW5jdGlvbiB0cnlUdW5uZWwoZ3JkOiBncmlkLkdyaWQ8VGlsZVR5cGU+LCByZWdpb246IFJlZ2lvbiwgdHg6IG51bWJlciwgdHk6IG51bWJlciwgbng6IG51bWJlciwgbnk6IG51bWJlcik6IChSZWdpb24gfCBudWxsKSB7XHJcbiAgICBzd2l0Y2ggKHJlZ2lvbi50eXBlKSB7XHJcbiAgICAgICAgY2FzZSBSZWdpb25UeXBlLkhhbGx3YXk6XHJcbiAgICAgICAgICAgIHJldHVybiB0cnlSb29tKGdyZCwgdHgsIHR5LCBueCwgbnkpXHJcblxyXG4gICAgICAgIGNhc2UgUmVnaW9uVHlwZS5Sb29tOlxyXG4gICAgICAgICAgICByZXR1cm4gdHJ5SGFsbHdheShncmQsIHR4LCB0eSwgbngsIG55KVxyXG4gICAgfVxyXG59XHJcblxyXG5mdW5jdGlvbiB0cnlIYWxsd2F5KGdyZDogZ3JpZC5HcmlkPFRpbGVUeXBlPiwgdHg6IG51bWJlciwgdHk6IG51bWJlciwgbng6IG51bWJlciwgbnk6IG51bWJlcik6IChSZWdpb24gfCBudWxsKSB7XHJcbiAgICBybmQuc2h1ZmZsZShoYWxsTGVuZ3RocylcclxuICAgIGZvciAoY29uc3QgbGVuZ3RoIG9mIGhhbGxMZW5ndGhzKSB7XHJcbiAgICAgICAgLy8gZm9yIG54IC8gbnlcclxuICAgICAgICAvLyBueCA9PT0gY3ggPSB2ZXJ0aWNhbCBoYWxsd2F5XHJcbiAgICAgICAgLy8gbnkgPT09IGN5ID0gaG9yaXpvbnRhbCBoYWxsd2F5XHJcbiAgICAgICAgY29uc3Qgd2lkdGggPSBueSA9PT0gdHkgPyBsZW5ndGggOiAzXHJcbiAgICAgICAgY29uc3QgaGVpZ2h0ID0gbnggPT09IHR4ID8gbGVuZ3RoIDogM1xyXG4gICAgICAgIGNvbnN0IHJlZ2lvbiA9IHRyeVBsYWNlQWRqYWNlbnRSZWdpb24oZ3JkLCBSZWdpb25UeXBlLkhhbGx3YXksIHR4LCB0eSwgbngsIG55LCB3aWR0aCwgaGVpZ2h0KVxyXG4gICAgICAgIGlmIChyZWdpb24pIHtcclxuICAgICAgICAgICAgcmV0dXJuIHJlZ2lvblxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gbnVsbFxyXG59XHJcblxyXG5mdW5jdGlvbiB0cnlSb29tKGdyZDogZ3JpZC5HcmlkPFRpbGVUeXBlPiwgdHg6IG51bWJlciwgdHk6IG51bWJlciwgbng6IG51bWJlciwgbnk6IG51bWJlcik6IChSZWdpb24gfCBudWxsKSB7XHJcbiAgICAvLyB0cnkgcGxhY2luZyBhIHJvb20gaGVyZVxyXG4gICAgcm5kLnNodWZmbGUocm9vbVNpemVzKVxyXG4gICAgZm9yIChjb25zdCBzaXplIG9mIHJvb21TaXplcykge1xyXG4gICAgICAgIGNvbnN0IHJlZ2lvbiA9IHRyeVBsYWNlQWRqYWNlbnRSZWdpb24oZ3JkLCBSZWdpb25UeXBlLlJvb20sIHR4LCB0eSwgbngsIG55LCBzaXplLCBzaXplKVxyXG4gICAgICAgIGlmIChyZWdpb24pIHtcclxuICAgICAgICAgICAgcmV0dXJuIHJlZ2lvblxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gbnVsbFxyXG59XHJcblxyXG5mdW5jdGlvbiB0cnlQbGFjZUFkamFjZW50UmVnaW9uKGdyZDogZ3JpZC5HcmlkPFRpbGVUeXBlPiwgdHlwZTogUmVnaW9uVHlwZSwgdHg6IG51bWJlciwgdHk6IG51bWJlciwgbng6IG51bWJlciwgbnk6IG51bWJlciwgd2lkdGg6IG51bWJlciwgaGVpZ2h0OiBudW1iZXIpOiAoUmVnaW9uIHwgbnVsbCkge1xyXG4gICAgLy8gZm9yIG54IC8gbnlcclxuICAgIC8vIG54IDwgdHggLSBob3Jpem9udGFsIC0gcmlnaHQgdG8gbGVmdFxyXG4gICAgLy8gbnggPiB0eCAtIGhvcml6b250YWwgLSBsZWZ0IHRvIHJpZ2h0XHJcbiAgICAvLyBueSA8IHR5IC0gdmVydGljYWwgLSBib3R0b20gdG8gdG9wXHJcbiAgICAvLyBueSA+IHR5IC0gdmVydGljYWwgLSB0b3AgdG8gYm90dG9tXHJcbiAgICAvLyBmb3IgZWFjaCBjYXNlIC0gZmluZCBoYWxsd2F5IHJlY3QsIGZpbmQgY2hlY2sgb3ZlcmxhcCByZWN0XHJcbiAgICBjb25zdCByZWdpb246IFJlZ2lvbiA9IHtcclxuICAgICAgICByZWN0OiB7IHg6IDAsIHk6IDAsIHdpZHRoOiAwLCBoZWlnaHQ6IDAgfSxcclxuICAgICAgICBub25PdmVybGFwcGluZ1JlY3Q6IHsgeDogMCwgeTogMCwgd2lkdGg6IDAsIGhlaWdodDogMCB9LFxyXG4gICAgICAgIGRlcHRoOiAwLFxyXG4gICAgICAgIHR5cGU6IHR5cGVcclxuICAgIH1cclxuXHJcbiAgICBpZiAobnggPCB0eCkge1xyXG4gICAgICAgIC8vIHJpZ2h0IHRvIGxlZnRcclxuICAgICAgICBjb25zdCB4ID0gdHggLSB3aWR0aCArIDFcclxuICAgICAgICBjb25zdCB5ID0gdHkgLSBNYXRoLmZsb29yKGhlaWdodCAvIDIpXHJcbiAgICAgICAgcmVnaW9uLnJlY3QgPSB7IHg6IHgsIHk6IHksIHdpZHRoOiB3aWR0aCwgaGVpZ2h0OiBoZWlnaHQgfVxyXG4gICAgICAgIHJlZ2lvbi5ub25PdmVybGFwcGluZ1JlY3QgPSB7IHg6IHgsIHk6IHksIHdpZHRoOiB3aWR0aCAtIDEsIGhlaWdodDogaGVpZ2h0IH1cclxuICAgIH0gZWxzZSBpZiAobnggPiB0eCkge1xyXG4gICAgICAgIC8vIGxlZnQgdG8gcmlnaHRcclxuICAgICAgICBjb25zdCB4ID0gdHhcclxuICAgICAgICBjb25zdCB5ID0gdHkgLSBNYXRoLmZsb29yKGhlaWdodCAvIDIpXHJcbiAgICAgICAgcmVnaW9uLnJlY3QgPSB7IHg6IHgsIHk6IHksIHdpZHRoOiB3aWR0aCwgaGVpZ2h0OiBoZWlnaHQgfVxyXG4gICAgICAgIHJlZ2lvbi5ub25PdmVybGFwcGluZ1JlY3QgPSB7IHg6IHggKyAxLCB5OiB5LCB3aWR0aDogd2lkdGggLSAxLCBoZWlnaHQ6IGhlaWdodCB9XHJcbiAgICB9IGVsc2UgaWYgKG55IDwgdHkpIHtcclxuICAgICAgICAvLyBib3R0b20gdG8gdG9wXHJcbiAgICAgICAgY29uc3QgeCA9IHR4IC0gTWF0aC5mbG9vcih3aWR0aCAvIDIpXHJcbiAgICAgICAgY29uc3QgeSA9IHR5IC0gaGVpZ2h0ICsgMVxyXG4gICAgICAgIHJlZ2lvbi5yZWN0ID0geyB4OiB4LCB5OiB5LCB3aWR0aDogd2lkdGgsIGhlaWdodDogaGVpZ2h0IH1cclxuICAgICAgICByZWdpb24ubm9uT3ZlcmxhcHBpbmdSZWN0ID0geyB4OiB4LCB5OiB5LCB3aWR0aDogd2lkdGgsIGhlaWdodDogaGVpZ2h0IC0gMSB9XHJcbiAgICB9IGVsc2UgaWYgKG55ID4gdHkpIHtcclxuICAgICAgICAvLyB0b3AgdG8gYm90dG9tXHJcbiAgICAgICAgY29uc3QgeCA9IHR4IC0gTWF0aC5mbG9vcih3aWR0aCAvIDIpXHJcbiAgICAgICAgY29uc3QgeSA9IHR5XHJcbiAgICAgICAgcmVnaW9uLnJlY3QgPSB7IHg6IHgsIHk6IHksIHdpZHRoOiB3aWR0aCwgaGVpZ2h0OiBoZWlnaHQgfVxyXG4gICAgICAgIHJlZ2lvbi5ub25PdmVybGFwcGluZ1JlY3QgPSB7IHg6IHgsIHk6IHkgKyAxLCB3aWR0aDogd2lkdGgsIGhlaWdodDogaGVpZ2h0IC0gMSB9XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcImludmFsaWQgdHVubmVsIHBvc2l0aW9uXCIpXHJcbiAgICB9XHJcblxyXG4gICAgY29uc3Qgc3VjY2VzcyA9IHRyeVBsYWNlUmVnaW9uKGdyZCwgcmVnaW9uKVxyXG4gICAgaWYgKCFzdWNjZXNzKSB7XHJcbiAgICAgICAgcmV0dXJuIG51bGxcclxuICAgIH1cclxuXHJcbiAgICBncmQuc2V0KHR4LCB0eSwgVGlsZVR5cGUuRG9vcilcclxuICAgIHJldHVybiByZWdpb25cclxufVxyXG5cclxuZnVuY3Rpb24gdHJ5UGxhY2VSZWdpb24oZ3JkOiBncmlkLkdyaWQ8VGlsZVR5cGU+LCByZWdpb246IFJlZ2lvbik6IGJvb2xlYW4ge1xyXG4gICAgY29uc3QgeyB4LCB5LCB3aWR0aCwgaGVpZ2h0IH0gPSByZWdpb24ucmVjdFxyXG4gICAgaWYgKCFncmQucmVnaW9uSW5Cb3VuZHMoeCwgeSwgd2lkdGgsIGhlaWdodCkpIHtcclxuICAgICAgICByZXR1cm4gZmFsc2VcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCB7IHg6IG54LCB5OiBueSwgd2lkdGg6IG53aWR0aCwgaGVpZ2h0OiBuaGVpZ2h0IH0gPSByZWdpb24ubm9uT3ZlcmxhcHBpbmdSZWN0XHJcbiAgICBpZiAoIXJlZ2lvbklzRXh0ZXJpb3IoZ3JkLCBueCwgbnksIG53aWR0aCwgbmhlaWdodCkpIHtcclxuICAgICAgICByZXR1cm4gZmFsc2VcclxuICAgIH1cclxuXHJcbiAgICBlbmNsb3NlUm9vbSh4LCB5LCB3aWR0aCwgaGVpZ2h0LCBncmQpXHJcbiAgICByZXR1cm4gdHJ1ZVxyXG59XHJcblxyXG5mdW5jdGlvbiBpc1R1bm5lbGFibGUoZ3JpZDogZ3JpZC5HcmlkPFRpbGVUeXBlPiwgeDogbnVtYmVyLCB5OiBudW1iZXIpOiBib29sZWFuIHtcclxuICAgIHJldHVybiBmaW5kVHVubmVsYWJsZU5laWdoYm9yKGdyaWQsIHgsIHkpICE9IG51bGxcclxufVxyXG5cclxuZnVuY3Rpb24gZmluZFR1bm5lbGFibGVOZWlnaGJvcihncmlkOiBncmlkLkdyaWQ8VGlsZVR5cGU+LCB4OiBudW1iZXIsIHk6IG51bWJlcik6IChDb29yZHMgfCBudWxsKSB7XHJcbiAgICBpZiAoeCA9PT0gMCB8fCB5ID09PSAwIHx8IHggPT09IGdyaWQud2lkdGggLSAxIHx8IHkgPT09IGdyaWQuaGVpZ2h0IC0gMSkge1xyXG4gICAgICAgIHJldHVybiBudWxsXHJcbiAgICB9XHJcblxyXG4gICAgaWYgKGdyaWQuYXQoeCAtIDEsIHkpID09PSBUaWxlVHlwZS5FeHRlcmlvciAmJiBncmlkLmF0KHggKyAxLCB5KSA9PT0gVGlsZVR5cGUuSW50ZXJpb3IpIHtcclxuICAgICAgICByZXR1cm4gW3ggLSAxLCB5XVxyXG4gICAgfVxyXG5cclxuICAgIGlmIChncmlkLmF0KHgsIHkgKyAxKSA9PT0gVGlsZVR5cGUuRXh0ZXJpb3IgJiYgZ3JpZC5hdCh4LCB5IC0gMSkgPT09IFRpbGVUeXBlLkludGVyaW9yKSB7XHJcbiAgICAgICAgcmV0dXJuIFt4LCB5ICsgMV1cclxuICAgIH1cclxuXHJcbiAgICBpZiAoZ3JpZC5hdCh4ICsgMSwgeSkgPT09IFRpbGVUeXBlLkV4dGVyaW9yICYmIGdyaWQuYXQoeCAtIDEsIHkpID09PSBUaWxlVHlwZS5JbnRlcmlvcikge1xyXG4gICAgICAgIHJldHVybiBbeCArIDEsIHldXHJcbiAgICB9XHJcblxyXG4gICAgaWYgKGdyaWQuYXQoeCwgeSAtIDEpID09PSBUaWxlVHlwZS5FeHRlcmlvciAmJiBncmlkLmF0KHgsIHkgKyAxKSA9PT0gVGlsZVR5cGUuSW50ZXJpb3IpIHtcclxuICAgICAgICByZXR1cm4gW3gsIHkgLSAxXVxyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiBudWxsXHJcbn1cclxuXHJcbmZ1bmN0aW9uIGVuY2xvc2VSb29tKHgwOiBudW1iZXIsIHkwOiBudW1iZXIsIHdpZHRoOiBudW1iZXIsIGhlaWdodDogbnVtYmVyLCBncmlkOiBncmlkLkdyaWQ8VGlsZVR5cGU+KSB7XHJcbiAgICBjb25zdCByID0geDAgKyB3aWR0aCAtIDFcclxuICAgIGNvbnN0IGIgPSB5MCArIGhlaWdodCAtIDFcclxuICAgIGZvciAoY29uc3QgW3gsIHldIG9mIGdyaWQuc2NhblJlZ2lvbih4MCwgeTAsIHdpZHRoLCBoZWlnaHQpKSB7XHJcbiAgICAgICAgaWYgKHggPT09IHgwIHx8IHkgPT0geTAgfHwgeCA9PT0gciB8fCB5ID09PSBiKSB7XHJcbiAgICAgICAgICAgIGdyaWQuc2V0KHgsIHksIFRpbGVUeXBlLldhbGwpXHJcbiAgICAgICAgICAgIGNvbnRpbnVlXHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBncmlkLnNldCh4LCB5LCBUaWxlVHlwZS5JbnRlcmlvcilcclxuICAgIH1cclxufVxyXG5cclxuZnVuY3Rpb24gcmVnaW9uSXNFeHRlcmlvcihncmlkOiBncmlkLkdyaWQ8VGlsZVR5cGU+LCB4MDogbnVtYmVyLCB5MDogbnVtYmVyLCB3aWR0aDogbnVtYmVyLCBoZWlnaHQ6IG51bWJlcik6IGJvb2xlYW4ge1xyXG4gICAgY29uc3QgZXh0ZXJpb3IgPSBhcnJheS5hbGwoZ3JpZC5pdGVyUmVnaW9uKHgwLCB5MCwgd2lkdGgsIGhlaWdodCksIHggPT4geCA9PSBUaWxlVHlwZS5FeHRlcmlvcilcclxuICAgIHJldHVybiBleHRlcmlvclxyXG59Il19