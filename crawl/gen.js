/**
 * map generation library
 */
import * as array from "../shared/array.js";
import * as grid from "../shared/grid.js";
import * as rnd from "../shared/rand.js";
const roomSizes = [5, 7, 9, 11];
const hallLengths = [5, 7, 9, 11];
var TileType;
(function (TileType) {
    TileType[TileType["Door"] = 0] = "Door";
    TileType[TileType["Wall"] = 1] = "Wall";
    TileType[TileType["Interior"] = 2] = "Interior";
    TileType[TileType["Exterior"] = 3] = "Exterior";
    TileType[TileType["Up"] = 4] = "Up";
    TileType[TileType["Down"] = 5] = "Down";
})(TileType || (TileType = {}));
var RegionType;
(function (RegionType) {
    RegionType[RegionType["Hallway"] = 0] = "Hallway";
    RegionType[RegionType["Room"] = 1] = "Room";
})(RegionType || (RegionType = {}));
export function generateMap(width, height) {
    const rooms = generateRooms(width, height);
    const map = rooms.map(type => {
        const tile = {
            things: []
        };
        switch (type) {
            case TileType.Door:
                tile.things.push({
                    name: "Door",
                    image: "./assets/closed.png"
                });
                break;
            case TileType.Wall:
                tile.things.push({
                    name: "Door",
                    image: "./assets/wall.png"
                });
                break;
            case TileType.Interior:
                tile.things.push({
                    name: "Door",
                    image: "./assets/floor.png"
                });
                break;
            case TileType.Up:
                tile.things.push({
                    name: "Door",
                    image: "./assets/up.png"
                });
                break;
            case TileType.Down:
                tile.things.push({
                    name: "Door",
                    image: "./assets/down.png"
                });
                break;
            case TileType.Exterior:
                break;
        }
        return tile;
    });
    return map;
}
export function* iterThings(grd) {
    for (const tile of grd) {
        for (const thing of tile.things) {
            yield thing;
        }
    }
}
function generateRooms(width, height) {
    const grd = grid.generate(width, height, () => TileType.Exterior);
    const regionStack = [];
    const regions = [];
    const maxRooms = 128;
    // place initial room
    {
        const minRoomSize = roomSizes.reduce((x, y) => x < y ? x : y);
        const maxRoomSize = roomSizes.reduce((x, y) => x > y ? x : y);
        const x = rnd.int(0, grd.width - minRoomSize);
        const y = rnd.int(0, grd.height - minRoomSize);
        const size = rnd.int(minRoomSize, Math.min(maxRoomSize, grd.width - x, grd.height - y));
        const region = {
            rect: { x: x, y: y, width: size, height: size },
            nonOverlappingRect: { x: x, y: y, width: size, height: size },
            depth: 0,
            type: RegionType.Room
        };
        if (!tryPlaceRegion(grd, region)) {
            throw new Error("Failed to place initial region");
        }
        regionStack.push(region);
        regions.push(region);
    }
    let numRooms = 1;
    while (true) {
        if (regionStack.length <= 0) {
            console.log("No more tunnel rooms");
            break;
        }
        if (numRooms >= maxRooms) {
            console.log("Max rooms reached");
            break;
        }
        // take region off of the stack
        const region = array.pop(regionStack);
        // try to tunnel from this region
        const nextRegion = tryTunnels(grd, region);
        if (!nextRegion) {
            continue;
        }
        nextRegion.depth = region.depth + 1;
        regionStack.push(region);
        regionStack.push(nextRegion);
        regions.push(nextRegion);
        if (nextRegion.type === RegionType.Room) {
            numRooms++;
        }
    }
    // remove dead end hallways
    for (const region of regions) {
        if (region.type !== RegionType.Hallway) {
            continue;
        }
        const numDoors = array.countIf(grd.iterRect(region.rect), t => t === TileType.Door);
        if (numDoors > 1) {
            continue;
        }
        for (const [x, y] of grd.scanRect(region.nonOverlappingRect)) {
            grd.set(x, y, TileType.Exterior);
        }
        for (const [x, y, t] of grd.scanRect(region.rect)) {
            if (t === TileType.Door) {
                grd.set(x, y, TileType.Wall);
            }
        }
    }
    const firstRegion = regions.reduce((x, y) => x.depth < y.depth ? x : y);
    for (const [x, y, t] of grd.scanRect(firstRegion.rect)) {
        if (t === TileType.Wall && hasInteriorNeighbor(grd, x, y)) {
            grd.set(x, y, TileType.Up);
            break;
        }
    }
    const lastRegion = regions.reduce((x, y) => x.depth > y.depth ? x : y);
    for (const [x, y, t] of grd.scanRect(lastRegion.rect)) {
        if (t === TileType.Wall && hasInteriorNeighbor(grd, x, y)) {
            grd.set(x, y, TileType.Down);
            break;
        }
    }
    console.log(`Placed ${numRooms} rooms`);
    return grd;
}
function tryTunnels(grd, region) {
    // try to tunnel from this room
    const tunnels = [];
    for (const [x, y] of grd.scanRect(region.rect)) {
        if (isTunnelable(grd, x, y)) {
            tunnels.push([x, y]);
        }
    }
    rnd.shuffle(tunnels);
    // try each tunnelable location
    while (tunnels.length > 0) {
        // find a place to begin tunneling to next room
        const [tx, ty] = array.pop(tunnels);
        const nxy = findTunnelableNeighbor(grd, tx, ty);
        if (!nxy) {
            continue;
        }
        const [nx, ny] = nxy;
        const nextRegion = tryTunnel(grd, region, tx, ty, nx, ny);
        if (nextRegion) {
            return nextRegion;
        }
    }
    return null;
}
function tryTunnel(grd, region, tx, ty, nx, ny) {
    switch (region.type) {
        case RegionType.Hallway:
            return tryRoom(grd, tx, ty, nx, ny);
        case RegionType.Room:
            return tryHallway(grd, tx, ty, nx, ny);
    }
}
function tryHallway(grd, tx, ty, nx, ny) {
    rnd.shuffle(hallLengths);
    for (const length of hallLengths) {
        // for nx / ny
        // nx === cx = vertical hallway
        // ny === cy = horizontal hallway
        const width = ny === ty ? length : 3;
        const height = nx === tx ? length : 3;
        const region = tryPlaceAdjacentRegion(grd, RegionType.Hallway, tx, ty, nx, ny, width, height);
        if (region) {
            return region;
        }
    }
    return null;
}
function tryRoom(grd, tx, ty, nx, ny) {
    // try placing a room here
    rnd.shuffle(roomSizes);
    for (const size of roomSizes) {
        const region = tryPlaceAdjacentRegion(grd, RegionType.Room, tx, ty, nx, ny, size, size);
        if (region) {
            return region;
        }
    }
    return null;
}
function tryPlaceAdjacentRegion(grd, type, tx, ty, nx, ny, width, height) {
    // for nx / ny
    // nx < tx - horizontal - right to left
    // nx > tx - horizontal - left to right
    // ny < ty - vertical - bottom to top
    // ny > ty - vertical - top to bottom
    // for each case - find hallway rect, find check overlap rect
    const region = {
        rect: { x: 0, y: 0, width: 0, height: 0 },
        nonOverlappingRect: { x: 0, y: 0, width: 0, height: 0 },
        depth: 0,
        type: type
    };
    if (nx < tx) {
        // right to left
        const x = tx - width + 1;
        const y = ty - Math.floor(height / 2);
        region.rect = { x: x, y: y, width: width, height: height };
        region.nonOverlappingRect = { x: x, y: y, width: width - 1, height: height };
    }
    else if (nx > tx) {
        // left to right
        const x = tx;
        const y = ty - Math.floor(height / 2);
        region.rect = { x: x, y: y, width: width, height: height };
        region.nonOverlappingRect = { x: x + 1, y: y, width: width - 1, height: height };
    }
    else if (ny < ty) {
        // bottom to top
        const x = tx - Math.floor(width / 2);
        const y = ty - height + 1;
        region.rect = { x: x, y: y, width: width, height: height };
        region.nonOverlappingRect = { x: x, y: y, width: width, height: height - 1 };
    }
    else if (ny > ty) {
        // top to bottom
        const x = tx - Math.floor(width / 2);
        const y = ty;
        region.rect = { x: x, y: y, width: width, height: height };
        region.nonOverlappingRect = { x: x, y: y + 1, width: width, height: height - 1 };
    }
    else {
        throw new Error("invalid tunnel position");
    }
    const success = tryPlaceRegion(grd, region);
    if (!success) {
        return null;
    }
    grd.set(tx, ty, TileType.Door);
    return region;
}
function tryPlaceRegion(grd, region) {
    const { x, y, width, height } = region.rect;
    if (!grd.regionInBounds(x, y, width, height)) {
        return false;
    }
    const { x: nx, y: ny, width: nwidth, height: nheight } = region.nonOverlappingRect;
    if (!regionIsExterior(grd, nx, ny, nwidth, nheight)) {
        return false;
    }
    encloseRoom(x, y, width, height, grd);
    return true;
}
function isTunnelable(grid, x, y) {
    return findTunnelableNeighbor(grid, x, y) != null;
}
function findTunnelableNeighbor(grid, x, y) {
    if (x === 0 || y === 0 || x === grid.width - 1 || y === grid.height - 1) {
        return null;
    }
    if (grid.at(x - 1, y) === TileType.Exterior && grid.at(x + 1, y) === TileType.Interior) {
        return [x - 1, y];
    }
    if (grid.at(x, y + 1) === TileType.Exterior && grid.at(x, y - 1) === TileType.Interior) {
        return [x, y + 1];
    }
    if (grid.at(x + 1, y) === TileType.Exterior && grid.at(x - 1, y) === TileType.Interior) {
        return [x + 1, y];
    }
    if (grid.at(x, y - 1) === TileType.Exterior && grid.at(x, y + 1) === TileType.Interior) {
        return [x, y - 1];
    }
    return null;
}
function hasInteriorNeighbor(grd, x, y) {
    return findTunnelableNeighbor(grd, x, y) != null;
}
function findInteriorNeighbor(grd, x, y) {
    if (x > 0 && grd.at(x - 1, y) === TileType.Interior) {
        return [x - 1, y];
    }
    if (y < grd.width && grd.at(x, y + 1) === TileType.Interior) {
        return [x, y + 1];
    }
    if (x < grd.width && grd.at(x + 1, y) === TileType.Interior) {
        return [x + 1, y];
    }
    if (y > 0 && grd.at(x, y - 1) === TileType.Interior) {
        return [x, y - 1];
    }
    return null;
}
function encloseRoom(x0, y0, width, height, grid) {
    const r = x0 + width - 1;
    const b = y0 + height - 1;
    for (const [x, y] of grid.scanRegion(x0, y0, width, height)) {
        if (x === x0 || y == y0 || x === r || y === b) {
            grid.set(x, y, TileType.Wall);
            continue;
        }
        grid.set(x, y, TileType.Interior);
    }
}
function regionIsExterior(grid, x0, y0, width, height) {
    const exterior = array.all(grid.iterRegion(x0, y0, width, height), x => x == TileType.Exterior);
    return exterior;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2VuLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiZ2VuLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOztHQUVHO0FBQ0gsT0FBTyxLQUFLLEtBQUssTUFBTSxvQkFBb0IsQ0FBQTtBQUMzQyxPQUFPLEtBQUssSUFBSSxNQUFNLG1CQUFtQixDQUFBO0FBQ3pDLE9BQU8sS0FBSyxHQUFHLE1BQU0sbUJBQW1CLENBQUE7QUFFeEMsTUFBTSxTQUFTLEdBQUcsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQTtBQUMvQixNQUFNLFdBQVcsR0FBRyxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFBO0FBRWpDLElBQUssUUFPSjtBQVBELFdBQUssUUFBUTtJQUNULHVDQUFJLENBQUE7SUFDSix1Q0FBSSxDQUFBO0lBQ0osK0NBQVEsQ0FBQTtJQUNSLCtDQUFRLENBQUE7SUFDUixtQ0FBRSxDQUFBO0lBQ0YsdUNBQUksQ0FBQTtBQUNSLENBQUMsRUFQSSxRQUFRLEtBQVIsUUFBUSxRQU9aO0FBRUQsSUFBSyxVQUdKO0FBSEQsV0FBSyxVQUFVO0lBQ1gsaURBQU8sQ0FBQTtJQUNQLDJDQUFJLENBQUE7QUFDUixDQUFDLEVBSEksVUFBVSxLQUFWLFVBQVUsUUFHZDtBQW9CRCxNQUFNLFVBQVUsV0FBVyxDQUFDLEtBQWEsRUFBRSxNQUFjO0lBQ3JELE1BQU0sS0FBSyxHQUFHLGFBQWEsQ0FBQyxLQUFLLEVBQUUsTUFBTSxDQUFDLENBQUE7SUFDMUMsTUFBTSxHQUFHLEdBQUcsS0FBSyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsRUFBRTtRQUN6QixNQUFNLElBQUksR0FBUztZQUNmLE1BQU0sRUFBRSxFQUFFO1NBQ2IsQ0FBQTtRQUVELFFBQVEsSUFBSSxFQUFFO1lBQ1YsS0FBSyxRQUFRLENBQUMsSUFBSTtnQkFDZCxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQztv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LE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsS0FBSyxHQUFHLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUE7SUFDdkUsS0FBSyxNQUFNLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUMsSUFBSSxHQUFHLENBQUMsUUFBUSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsRUFBRTtRQUNwRCxJQUFJLENBQUMsS0FBSyxRQUFRLENBQUMsSUFBSSxJQUFJLG1CQUFtQixDQUFDLEdBQUcsRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDLEVBQUU7WUFDdkQsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLFFBQVEsQ0FBQyxFQUFFLENBQUMsQ0FBQTtZQUMxQixNQUFLO1NBQ1I7S0FDSjtJQUVELE1BQU0sVUFBVSxHQUFHLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsS0FBSyxHQUFHLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUE7SUFDdEUsS0FBSyxNQUFNLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUMsSUFBSSxHQUFHLENBQUMsUUFBUSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsRUFBRTtRQUNuRCxJQUFJLENBQUMsS0FBSyxRQUFRLENBQUMsSUFBSSxJQUFJLG1CQUFtQixDQUFDLEdBQUcsRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDLEVBQUU7WUFDdkQsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLFFBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQTtZQUM1QixNQUFLO1NBQ1I7S0FDSjtJQUVELE9BQU8sQ0FBQyxHQUFHLENBQUMsVUFBVSxRQUFRLFFB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QUNqRyxNQUFNLENBQUMsR0FBRyxFQUFFLEdBQUcsS0FBSyxHQUFHLENBQUMsQ0FBQTtJQUN4QixNQUFNLENBQUMsR0FBRyxFQUFFLEdBQUcsTUFBTSxHQUFHLENBQUMsQ0FBQTtJQUN6QixLQUFLLE1BQU0sQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLElBQUksSUFBSSxDQUFDLFVBQVUsQ0FBQyxFQUFFLEVBQUUsRUFBRSxFQUFFLEtBQUssRUFBRSxNQUFNLENBQUMsRUFBRTtRQUN6RCxJQUFJLENBQUMsS0FBSyxFQUFFLElBQUksQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLEVBQUU7WUFDM0MsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLFFBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQTtZQUM3QixTQUFRO1NBQ1g7UUFFRCxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsUUFBUSxDQUFDLFFBQVEsQ0FBQyxDQUFBO0tBQ3BDO0FBQ0wsQ0FBQztBQUVELFNBQVMsZ0JBQWdCLENBQUMsSUFBeUIsRUFBRSxFQUFVLEVBQUUsRUFBVSxFQUFFLEtBQWEsRUFBRSxNQUFjO0lBQ3RHLE1BQU0sUUFBUSxHQUFHLEtBQUssQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxFQUFFLEVBQUUsRUFBRSxFQUFFLEtBQUssRUFBRSxNQUFNLENBQUMsRUFBRSxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsSUFBSSxRQUFRLENBQUMsUUFBUSxDQUFDLENBQUE7SUFDL0YsT0FBTyxRQUFRLENBQUE7QUFDbkIsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxyXG4gKiBtYXAgZ2VuZXJhdGlvbiBsaWJyYXJ5XHJcbiAqL1xyXG5pbXBvcnQgKiBhcyBhcnJheSBmcm9tIFwiLi4vc2hhcmVkL2FycmF5LmpzXCJcclxuaW1wb3J0ICogYXMgZ3JpZCBmcm9tIFwiLi4vc2hhcmVkL2dyaWQuanNcIlxyXG5pbXBvcnQgKiBhcyBybmQgZnJvbSBcIi4uL3NoYXJlZC9yYW5kLmpzXCJcclxuXHJcbmNvbnN0IHJvb21TaXplcyA9IFs1LCA3LCA5LCAxMV1cclxuY29uc3QgaGFsbExlbmd0aHMgPSBbNSwgNywgOSwgMTFdXHJcblxyXG5lbnVtIFRpbGVUeXBlIHtcclxuICAgIERvb3IsXHJcbiAgICBXYWxsLFxyXG4gICAgSW50ZXJpb3IsXHJcbiAgICBFeHRlcmlvclxyXG4gICAgVXAsXHJcbiAgICBEb3duXHJcbn1cclxuXHJcbmVudW0gUmVnaW9uVHlwZSB7XHJcbiAgICBIYWxsd2F5LFxyXG4gICAgUm9vbVxyXG59XHJcblxyXG5pbnRlcmZhY2UgUmVnaW9uIHtcclxuICAgIHJlY3Q6IGdyaWQuUmVjdCxcclxuICAgIG5vbk92ZXJsYXBwaW5nUmVjdDogZ3JpZC5SZWN0LFxyXG4gICAgZGVwdGg6IG51bWJlcixcclxuICAgIHR5cGU6IFJlZ2lvblR5cGVcclxufVxyXG5cclxudHlwZSBDb29yZHMgPSBbbnVtYmVyLCBudW1iZXJdXHJcblxyXG5pbnRlcmZhY2UgVGhpbmcge1xyXG4gICAgbmFtZTogc3RyaW5nXHJcbiAgICBpbWFnZTogc3RyaW5nXHJcbn1cclxuXHJcbmludGVyZmFjZSBUaWxlIHtcclxuICAgIHRoaW5nczogVGhpbmdbXVxyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gZ2VuZXJhdGVNYXAod2lkdGg6IG51bWJlciwgaGVpZ2h0OiBudW1iZXIpOiBncmlkLkdyaWQ8VGlsZT4ge1xyXG4gICAgY29uc3Qgcm9vbXMgPSBnZW5lcmF0ZVJvb21zKHdpZHRoLCBoZWlnaHQpXHJcbiAgICBjb25zdCBtYXAgPSByb29tcy5tYXAodHlwZSA9PiB7XHJcbiAgICAgICAgY29uc3QgdGlsZTogVGlsZSA9IHtcclxuICAgICAgICAgICAgdGhpbmdzOiBbXVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgc3dpdGNoICh0eXBlKSB7XHJcbiAgICAgICAgICAgIGNhc2UgVGlsZVR5cGUuRG9vcjpcclxuICAgICAgICAgICAgICAgIHRpbGUudGhpbmdzLnB1c2goe1xyXG4gICAgICAgICAgICAgICAgICAgIG5hbWU6IFwiRG9vclwiLFxyXG4gICAgICAgICAgICAgICAgICAgIGltYWdlOiBcIi4vYXNzZXRzL2Nsb3NlZC5wbmdcIlxyXG4gICAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG5cclxuICAgICAgICAgICAgY2FzZSBUaWxlVHlwZS5XYWxsOlxyXG4gICAgICAgICAgICAgICAgdGlsZS50aGluZ3MucHVzaCh7XHJcbiAgICAgICAgICAgICAgICAgICAgbmFtZTogXCJEb29yXCIsXHJcbiAgICAgICAgICAgICAgICAgICAgaW1hZ2U6IFwiLi9hc3NldHMvd2FsbC5wbmdcIlxyXG4gICAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG5cclxuICAgICAgICAgICAgY2FzZSBUaWxlVHlwZS5JbnRlcmlvcjpcclxuICAgICAgICAgICAgICAgIHRpbGUudGhpbmdzLnB1c2goe1xyXG4gICAgICAgICAgICAgICAgICAgIG5hbWU6IFwiRG9vclwiLFxyXG4gICAgICAgICAgICAgICAgICAgIGltYWdlOiBcIi4vYXNzZXRzL2Zsb29yLnBuZ1wiXHJcbiAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcblxyXG4gICAgICAgICAgICBjYXNlIFRpbGVUeXBlLlVwOlxyXG4gICAgICAgICAgICAgICAgdGlsZS50aGluZ3MucHVzaCh7XHJcbiAgICAgICAgICAgICAgICAgICAgbmFtZTogXCJEb29yXCIsXHJcbiAgICAgICAgICAgICAgICAgICAgaW1hZ2U6IFwiLi9hc3NldHMvdXAucG5nXCJcclxuICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuXHJcbiAgICAgICAgICAgIGNhc2UgVGlsZVR5cGUuRG93bjpcclxuICAgICAgICAgICAgICAgIHRpbGUudGhpbmdzLnB1c2goe1xyXG4gICAgICAgICAgICAgICAgICAgIG5hbWU6IFwiRG9vclwiLFxyXG4gICAgICAgICAgICAgICAgICAgIGltYWdlOiBcIi4vYXNzZXRzL2Rvd24ucG5nXCJcclxuICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuXHJcbiAgICAgICAgICAgIGNhc2UgVGlsZVR5cGUuRXh0ZXJpb3I6XHJcbiAgICAgICAgICAgICAgICBicmVha1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIHRpbGVcclxuICAgIH0pXHJcblxyXG4gICAgcmV0dXJuIG1hcFxyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24qIGl0ZXJUaGluZ3MoZ3JkOiBncmlkLkdyaWQ8VGlsZT4pIHtcclxuICAgIGZvciAoY29uc3QgdGlsZSBvZiBncmQpIHtcclxuICAgICAgICBmb3IgKGNvbnN0IHRoaW5nIG9mIHRpbGUudGhpbmdzKSB7XHJcbiAgICAgICAgICAgIHlpZWxkIHRoaW5nXHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG59XHJcblxyXG5mdW5jdGlvbiBnZW5lcmF0ZVJvb21zKHdpZHRoOiBudW1iZXIsIGhlaWdodDogbnVtYmVyKTogZ3JpZC5HcmlkPFRpbGVUeXBlPiB7XHJcbiAgICBjb25zdCBncmQgPSBncmlkLmdlbmVyYXRlKHdpZHRoLCBoZWlnaHQsICgpID0+IFRpbGVUeXBlLkV4dGVyaW9yKVxyXG4gICAgY29uc3QgcmVnaW9uU3RhY2s6IFJlZ2lvbltdID0gW11cclxuICAgIGNvbnN0IHJlZ2lvbnM6IFJlZ2lvbltdID0gW11cclxuICAgIGNvbnN0IG1heFJvb21zID0gMTI4XHJcblxyXG4gICAgLy8gcGxhY2UgaW5pdGlhbCByb29tXHJcbiAgICB7XHJcbiAgICAgICAgY29uc3QgbWluUm9vbVNpemUgPSByb29tU2l6ZXMucmVkdWNlKCh4LCB5KSA9PiB4IDwgeSA/IHggOiB5KVxyXG4gICAgICAgIGNvbnN0IG1heFJvb21TaXplID0gcm9vbVNpemVzLnJlZHVjZSgoeCwgeSkgPT4geCA+IHkgPyB4IDogeSlcclxuICAgICAgICBjb25zdCB4ID0gcm5kLmludCgwLCBncmQud2lkdGggLSBtaW5Sb29tU2l6ZSlcclxuICAgICAgICBjb25zdCB5ID0gcm5kLmludCgwLCBncmQuaGVpZ2h0IC0gbWluUm9vbVNpemUpXHJcbiAgICAgICAgY29uc3Qgc2l6ZSA9IHJuZC5pbnQobWluUm9vbVNpemUsIE1hdGgubWluKG1heFJvb21TaXplLCBncmQud2lkdGggLSB4LCBncmQuaGVpZ2h0IC0geSkpXHJcbiAgICAgICAgY29uc3QgcmVnaW9uOiBSZWdpb24gPSB7XHJcbiAgICAgICAgICAgIHJlY3Q6IHsgeDogeCwgeTogeSwgd2lkdGg6IHNpemUsIGhlaWdodDogc2l6ZSB9LFxyXG4gICAgICAgICAgICBub25PdmVybGFwcGluZ1JlY3Q6IHsgeDogeCwgeTogeSwgd2lkdGg6IHNpemUsIGhlaWdodDogc2l6ZSB9LFxyXG4gICAgICAgICAgICBkZXB0aDogMCxcclxuICAgICAgICAgICAgdHlwZTogUmVnaW9uVHlwZS5Sb29tXHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAoIXRyeVBsYWNlUmVnaW9uKGdyZCwgcmVnaW9uKSkge1xyXG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJGYWlsZWQgdG8gcGxhY2UgaW5pdGlhbCByZWdpb25cIilcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJlZ2lvblN0YWNrLnB1c2gocmVnaW9uKVxyXG4gICAgICAgIHJlZ2lvbnMucHVzaChyZWdpb24pXHJcbiAgICB9XHJcblxyXG4gICAgbGV0IG51bVJvb21zID0gMVxyXG4gICAgd2hpbGUgKHRydWUpIHtcclxuICAgICAgICBpZiAocmVnaW9uU3RhY2subGVuZ3RoIDw9IDApIHtcclxuICAgICAgICAgICAgY29uc29sZS5sb2coXCJObyBtb3JlIHR1bm5lbCByb29tc1wiKVxyXG4gICAgICAgICAgICBicmVha1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKG51bVJvb21zID49IG1heFJvb21zKSB7XHJcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiTWF4IHJvb21zIHJlYWNoZWRcIilcclxuICAgICAgICAgICAgYnJlYWtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8vIHRha2UgcmVnaW9uIG9mZiBvZiB0aGUgc3RhY2tcclxuICAgICAgICBjb25zdCByZWdpb24gPSBhcnJheS5wb3AocmVnaW9uU3RhY2spXHJcblxyXG4gICAgICAgIC8vIHRyeSB0byB0dW5uZWwgZnJvbSB0aGlzIHJlZ2lvblxyXG4gICAgICAgIGNvbnN0IG5leHRSZWdpb24gPSB0cnlUdW5uZWxzKGdyZCwgcmVnaW9uKVxyXG4gICAgICAgIGlmICghbmV4dFJlZ2lvbikge1xyXG4gICAgICAgICAgICBjb250aW51ZVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgbmV4dFJlZ2lvbi5kZXB0aCA9IHJlZ2lvbi5kZXB0aCArIDFcclxuICAgICAgICByZWdpb25TdGFjay5wdXNoKHJlZ2lvbilcclxuICAgICAgICByZWdpb25TdGFjay5wdXNoKG5leHRSZWdpb24pXHJcbiAgICAgICAgcmVnaW9ucy5wdXNoKG5leHRSZWdpb24pXHJcblxyXG4gICAgICAgIGlmIChuZXh0UmVnaW9uLnR5cGUgPT09IFJlZ2lvblR5cGUuUm9vbSkge1xyXG4gICAgICAgICAgICBudW1Sb29tcysrXHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIC8vIHJlbW92ZSBkZWFkIGVuZCBoYWxsd2F5c1xyXG4gICAgZm9yIChjb25zdCByZWdpb24gb2YgcmVnaW9ucykge1xyXG4gICAgICAgIGlmIChyZWdpb24udHlwZSAhPT0gUmVnaW9uVHlwZS5IYWxsd2F5KSB7XHJcbiAgICAgICAgICAgIGNvbnRpbnVlXHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBjb25zdCBudW1Eb29ycyA9IGFycmF5LmNvdW50SWYoZ3JkLml0ZXJSZWN0KHJlZ2lvbi5yZWN0KSwgdCA9PiB0ID09PSBUaWxlVHlwZS5Eb29yKVxyXG4gICAgICAgIGlmIChudW1Eb29ycyA+IDEpIHtcclxuICAgICAgICAgICAgY29udGludWVcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGZvciAoY29uc3QgW3gsIHldIG9mIGdyZC5zY2FuUmVjdChyZWdpb24ubm9uT3ZlcmxhcHBpbmdSZWN0KSkge1xyXG4gICAgICAgICAgICBncmQuc2V0KHgsIHksIFRpbGVUeXBlLkV4dGVyaW9yKVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgZm9yIChjb25zdCBbeCwgeSwgdF0gb2YgZ3JkLnNjYW5SZWN0KHJlZ2lvbi5yZWN0KSkge1xyXG4gICAgICAgICAgICBpZiAodCA9PT0gVGlsZVR5cGUuRG9vcikge1xyXG4gICAgICAgICAgICAgICAgZ3JkLnNldCh4LCB5LCBUaWxlVHlwZS5XYWxsKVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IGZpcnN0UmVnaW9uID0gcmVnaW9ucy5yZWR1Y2UoKHgsIHkpID0+IHguZGVwdGggPCB5LmRlcHRoID8geCA6IHkpXHJcbiAgICBmb3IgKGNvbnN0IFt4LCB5LCB0XSBvZiBncmQuc2NhblJlY3QoZmlyc3RSZWdpb24ucmVjdCkpIHtcclxuICAgICAgICBpZiAodCA9PT0gVGlsZVR5cGUuV2FsbCAmJiBoYXNJbnRlcmlvck5laWdoYm9yKGdyZCwgeCwgeSkpIHtcclxuICAgICAgICAgICAgZ3JkLnNldCh4LCB5LCBUaWxlVHlwZS5VcClcclxuICAgICAgICAgICAgYnJlYWtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgbGFzdFJlZ2lvbiA9IHJlZ2lvbnMucmVkdWNlKCh4LCB5KSA9PiB4LmRlcHRoID4geS5kZXB0aCA/IHggOiB5KVxyXG4gICAgZm9yIChjb25zdCBbeCwgeSwgdF0gb2YgZ3JkLnNjYW5SZWN0KGxhc3RSZWdpb24ucmVjdCkpIHtcclxuICAgICAgICBpZiAodCA9PT0gVGlsZVR5cGUuV2FsbCAmJiBoYXNJbnRlcmlvck5laWdoYm9yKGdyZCwgeCwgeSkpIHtcclxuICAgICAgICAgICAgZ3JkLnNldCh4LCB5LCBUaWxlVHlwZS5Eb3duKVxyXG4gICAgICAgICAgICBicmVha1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBjb25zb2xlLmxvZyhgUGxhY2VkICR7bnVtUm9vbXN9IHJvb21zYClcclxuXHJcbiAgICByZXR1cm4gZ3JkXHJcbn1cclxuXHJcbmZ1bmN0aW9uIHRyeVR1bm5lbHMoZ3JkOiBncmlkLkdyaWQ8VGlsZVR5cGU+LCByZWdpb246IFJlZ2lvbik6IChSZWdpb24gfCBudWxsKSB7XHJcbiAgICAvLyB0cnkgdG8gdHVubmVsIGZyb20gdGhpcyByb29tXHJcbiAgICBjb25zdCB0dW5uZWxzOiBDb29yZHNbXSA9IFtdXHJcbiAgICBmb3IgKGNvbnN0IFt4LCB5XSBvZiBncmQuc2NhblJlY3QocmVnaW9uLnJlY3QpKSB7XHJcbiAgICAgICAgaWYgKGlzVHVubmVsYWJsZShncmQsIHgsIHkpKSB7XHJcbiAgICAgICAgICAgIHR1bm5lbHMucHVzaChbeCwgeV0pXHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHJuZC5zaHVmZmxlKHR1bm5lbHMpXHJcblxyXG4gICAgLy8gdHJ5IGVhY2ggdHVubmVsYWJsZSBsb2NhdGlvblxyXG4gICAgd2hpbGUgKHR1bm5lbHMubGVuZ3RoID4gMCkge1xyXG4gICAgICAgIC8vIGZpbmQgYSBwbGFjZSB0byBiZWdpbiB0dW5uZWxpbmcgdG8gbmV4dCByb29tXHJcbiAgICAgICAgY29uc3QgW3R4LCB0eV0gPSBhcnJheS5wb3AodHVubmVscylcclxuICAgICAgICBjb25zdCBueHkgPSBmaW5kVHVubmVsYWJsZU5laWdoYm9yKGdyZCwgdHgsIHR5KVxyXG4gICAgICAgIGlmICghbnh5KSB7XHJcbiAgICAgICAgICAgIGNvbnRpbnVlXHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBjb25zdCBbbngsIG55XSA9IG54eVxyXG4gICAgICAgIGNvbnN0IG5leHRSZWdpb24gPSB0cnlUdW5uZWwoZ3JkLCByZWdpb24sIHR4LCB0eSwgbngsIG55KVxyXG4gICAgICAgIGlmIChuZXh0UmVnaW9uKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBuZXh0UmVnaW9uXHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiBudWxsXHJcbn1cclxuXHJcbmZ1bmN0aW9uIHRyeVR1bm5lbChncmQ6IGdyaWQuR3JpZDxUaWxlVHlwZT4sIHJlZ2lvbjogUmVnaW9uLCB0eDogbnVtYmVyLCB0eTogbnVtYmVyLCBueDogbnVtYmVyLCBueTogbnVtYmVyKTogKFJlZ2lvbiB8IG51bGwpIHtcclxuICAgIHN3aXRjaCAocmVnaW9uLnR5cGUpIHtcclxuICAgICAgICBjYXNlIFJlZ2lvblR5cGUuSGFsbHdheTpcclxuICAgICAgICAgICAgcmV0dXJuIHRyeVJvb20oZ3JkLCB0eCwgdHksIG54LCBueSlcclxuXHJcbiAgICAgICAgY2FzZSBSZWdpb25UeXBlLlJvb206XHJcbiAgICAgICAgICAgIHJldHVybiB0cnlIYWxsd2F5KGdyZCwgdHgsIHR5LCBueCwgbnkpXHJcbiAgICB9XHJcbn1cclxuXHJcbmZ1bmN0aW9uIHRyeUhhbGx3YXkoZ3JkOiBncmlkLkdyaWQ8VGlsZVR5cGU+LCB0eDogbnVtYmVyLCB0eTogbnVtYmVyLCBueDogbnVtYmVyLCBueTogbnVtYmVyKTogKFJlZ2lvbiB8IG51bGwpIHtcclxuICAgIHJuZC5zaHVmZmxlKGhhbGxMZW5ndGhzKVxyXG4gICAgZm9yIChjb25zdCBsZW5ndGggb2YgaGFsbExlbmd0aHMpIHtcclxuICAgICAgICAvLyBmb3IgbnggLyBueVxyXG4gICAgICAgIC8vIG54ID09PSBjeCA9IHZlcnRpY2FsIGhhbGx3YXlcclxuICAgICAgICAvLyBueSA9PT0gY3kgPSBob3Jpem9udGFsIGhhbGx3YXlcclxuICAgICAgICBjb25zdCB3aWR0aCA9IG55ID09PSB0eSA/IGxlbmd0aCA6IDNcclxuICAgICAgICBjb25zdCBoZWlnaHQgPSBueCA9PT0gdHggPyBsZW5ndGggOiAzXHJcbiAgICAgICAgY29uc3QgcmVnaW9uID0gdHJ5UGxhY2VBZGphY2VudFJlZ2lvbihncmQsIFJlZ2lvblR5cGUuSGFsbHdheSwgdHgsIHR5LCBueCwgbnksIHdpZHRoLCBoZWlnaHQpXHJcbiAgICAgICAgaWYgKHJlZ2lvbikge1xyXG4gICAgICAgICAgICByZXR1cm4gcmVnaW9uXHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiBudWxsXHJcbn1cclxuXHJcbmZ1bmN0aW9uIHRyeVJvb20oZ3JkOiBncmlkLkdyaWQ8VGlsZVR5cGU+LCB0eDogbnVtYmVyLCB0eTogbnVtYmVyLCBueDogbnVtYmVyLCBueTogbnVtYmVyKTogKFJlZ2lvbiB8IG51bGwpIHtcclxuICAgIC8vIHRyeSBwbGFjaW5nIGEgcm9vbSBoZXJlXHJcbiAgICBybmQuc2h1ZmZsZShyb29tU2l6ZXMpXHJcbiAgICBmb3IgKGNvbnN0IHNpemUgb2Ygcm9vbVNpemVzKSB7XHJcbiAgICAgICAgY29uc3QgcmVnaW9uID0gdHJ5UGxhY2VBZGphY2VudFJlZ2lvbihncmQsIFJlZ2lvblR5cGUuUm9vbSwgdHgsIHR5LCBueCwgbnksIHNpemUsIHNpemUpXHJcbiAgICAgICAgaWYgKHJlZ2lvbikge1xyXG4gICAgICAgICAgICByZXR1cm4gcmVnaW9uXHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiBudWxsXHJcbn1cclxuXHJcbmZ1bmN0aW9uIHRyeVBsYWNlQWRqYWNlbnRSZWdpb24oZ3JkOiBncmlkLkdyaWQ8VGlsZVR5cGU+LCB0eXBlOiBSZWdpb25UeXBlLCB0eDogbnVtYmVyLCB0eTogbnVtYmVyLCBueDogbnVtYmVyLCBueTogbnVtYmVyLCB3aWR0aDogbnVtYmVyLCBoZWlnaHQ6IG51bWJlcik6IChSZWdpb24gfCBudWxsKSB7XHJcbiAgICAvLyBmb3IgbnggLyBueVxyXG4gICAgLy8gbnggPCB0eCAtIGhvcml6b250YWwgLSByaWdodCB0byBsZWZ0XHJcbiAgICAvLyBueCA+IHR4IC0gaG9yaXpvbnRhbCAtIGxlZnQgdG8gcmlnaHRcclxuICAgIC8vIG55IDwgdHkgLSB2ZXJ0aWNhbCAtIGJvdHRvbSB0byB0b3BcclxuICAgIC8vIG55ID4gdHkgLSB2ZXJ0aWNhbCAtIHRvcCB0byBib3R0b21cclxuICAgIC8vIGZvciBlYWNoIGNhc2UgLSBmaW5kIGhhbGx3YXkgcmVjdCwgZmluZCBjaGVjayBvdmVybGFwIHJlY3RcclxuICAgIGNvbnN0IHJlZ2lvbjogUmVnaW9uID0ge1xyXG4gICAgICAgIHJlY3Q6IHsgeDogMCwgeTogMCwgd2lkdGg6IDAsIGhlaWdodDogMCB9LFxyXG4gICAgICAgIG5vbk92ZXJsYXBwaW5nUmVjdDogeyB4OiAwLCB5OiAwLCB3aWR0aDogMCwgaGVpZ2h0OiAwIH0sXHJcbiAgICAgICAgZGVwdGg6IDAsXHJcbiAgICAgICAgdHlwZTogdHlwZVxyXG4gICAgfVxyXG5cclxuICAgIGlmIChueCA8IHR4KSB7XHJcbiAgICAgICAgLy8gcmlnaHQgdG8gbGVmdFxyXG4gICAgICAgIGNvbnN0IHggPSB0eCAtIHdpZHRoICsgMVxyXG4gICAgICAgIGNvbnN0IHkgPSB0eSAtIE1hdGguZmxvb3IoaGVpZ2h0IC8gMilcclxuICAgICAgICByZWdpb24ucmVjdCA9IHsgeDogeCwgeTogeSwgd2lkdGg6IHdpZHRoLCBoZWlnaHQ6IGhlaWdodCB9XHJcbiAgICAgICAgcmVnaW9uLm5vbk92ZXJsYXBwaW5nUmVjdCA9IHsgeDogeCwgeTogeSwgd2lkdGg6IHdpZHRoIC0gMSwgaGVpZ2h0OiBoZWlnaHQgfVxyXG4gICAgfSBlbHNlIGlmIChueCA+IHR4KSB7XHJcbiAgICAgICAgLy8gbGVmdCB0byByaWdodFxyXG4gICAgICAgIGNvbnN0IHggPSB0eFxyXG4gICAgICAgIGNvbnN0IHkgPSB0eSAtIE1hdGguZmxvb3IoaGVpZ2h0IC8gMilcclxuICAgICAgICByZWdpb24ucmVjdCA9IHsgeDogeCwgeTogeSwgd2lkdGg6IHdpZHRoLCBoZWlnaHQ6IGhlaWdodCB9XHJcbiAgICAgICAgcmVnaW9uLm5vbk92ZXJsYXBwaW5nUmVjdCA9IHsgeDogeCArIDEsIHk6IHksIHdpZHRoOiB3aWR0aCAtIDEsIGhlaWdodDogaGVpZ2h0IH1cclxuICAgIH0gZWxzZSBpZiAobnkgPCB0eSkge1xyXG4gICAgICAgIC8vIGJvdHRvbSB0byB0b3BcclxuICAgICAgICBjb25zdCB4ID0gdHggLSBNYXRoLmZsb29yKHdpZHRoIC8gMilcclxuICAgICAgICBjb25zdCB5ID0gdHkgLSBoZWlnaHQgKyAxXHJcbiAgICAgICAgcmVnaW9uLnJlY3QgPSB7IHg6IHgsIHk6IHksIHdpZHRoOiB3aWR0aCwgaGVpZ2h0OiBoZWlnaHQgfVxyXG4gICAgICAgIHJlZ2lvbi5ub25PdmVybGFwcGluZ1JlY3QgPSB7IHg6IHgsIHk6IHksIHdpZHRoOiB3aWR0aCwgaGVpZ2h0OiBoZWlnaHQgLSAxIH1cclxuICAgIH0gZWxzZSBpZiAobnkgPiB0eSkge1xyXG4gICAgICAgIC8vIHRvcCB0byBib3R0b21cclxuICAgICAgICBjb25zdCB4ID0gdHggLSBNYXRoLmZsb29yKHdpZHRoIC8gMilcclxuICAgICAgICBjb25zdCB5ID0gdHlcclxuICAgICAgICByZWdpb24ucmVjdCA9IHsgeDogeCwgeTogeSwgd2lkdGg6IHdpZHRoLCBoZWlnaHQ6IGhlaWdodCB9XHJcbiAgICAgICAgcmVnaW9uLm5vbk92ZXJsYXBwaW5nUmVjdCA9IHsgeDogeCwgeTogeSArIDEsIHdpZHRoOiB3aWR0aCwgaGVpZ2h0OiBoZWlnaHQgLSAxIH1cclxuICAgIH0gZWxzZSB7XHJcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiaW52YWxpZCB0dW5uZWwgcG9zaXRpb25cIilcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBzdWNjZXNzID0gdHJ5UGxhY2VSZWdpb24oZ3JkLCByZWdpb24pXHJcbiAgICBpZiAoIXN1Y2Nlc3MpIHtcclxuICAgICAgICByZXR1cm4gbnVsbFxyXG4gICAgfVxyXG5cclxuICAgIGdyZC5zZXQodHgsIHR5LCBUaWxlVHlwZS5Eb29yKVxyXG4gICAgcmV0dXJuIHJlZ2lvblxyXG59XHJcblxyXG5mdW5jdGlvbiB0cnlQbGFjZVJlZ2lvbihncmQ6IGdyaWQuR3JpZDxUaWxlVHlwZT4sIHJlZ2lvbjogUmVnaW9uKTogYm9vbGVhbiB7XHJcbiAgICBjb25zdCB7IHgsIHksIHdpZHRoLCBoZWlnaHQgfSA9IHJlZ2lvbi5yZWN0XHJcbiAgICBpZiAoIWdyZC5yZWdpb25JbkJvdW5kcyh4LCB5LCB3aWR0aCwgaGVpZ2h0KSkge1xyXG4gICAgICAgIHJldHVybiBmYWxzZVxyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IHsgeDogbngsIHk6IG55LCB3aWR0aDogbndpZHRoLCBoZWlnaHQ6IG5oZWlnaHQgfSA9IHJlZ2lvbi5ub25PdmVybGFwcGluZ1JlY3RcclxuICAgIGlmICghcmVnaW9uSXNFeHRlcmlvcihncmQsIG54LCBueSwgbndpZHRoLCBuaGVpZ2h0KSkge1xyXG4gICAgICAgIHJldHVybiBmYWxzZVxyXG4gICAgfVxyXG5cclxuICAgIGVuY2xvc2VSb29tKHgsIHksIHdpZHRoLCBoZWlnaHQsIGdyZClcclxuICAgIHJldHVybiB0cnVlXHJcbn1cclxuXHJcbmZ1bmN0aW9uIGlzVHVubmVsYWJsZShncmlkOiBncmlkLkdyaWQ8VGlsZVR5cGU+LCB4OiBudW1iZXIsIHk6IG51bWJlcik6IGJvb2xlYW4ge1xyXG4gICAgcmV0dXJuIGZpbmRUdW5uZWxhYmxlTmVpZ2hib3IoZ3JpZCwgeCwgeSkgIT0gbnVsbFxyXG59XHJcblxyXG5mdW5jdGlvbiBmaW5kVHVubmVsYWJsZU5laWdoYm9yKGdyaWQ6IGdyaWQuR3JpZDxUaWxlVHlwZT4sIHg6IG51bWJlciwgeTogbnVtYmVyKTogKENvb3JkcyB8IG51bGwpIHtcclxuICAgIGlmICh4ID09PSAwIHx8IHkgPT09IDAgfHwgeCA9PT0gZ3JpZC53aWR0aCAtIDEgfHwgeSA9PT0gZ3JpZC5oZWlnaHQgLSAxKSB7XHJcbiAgICAgICAgcmV0dXJuIG51bGxcclxuICAgIH1cclxuXHJcbiAgICBpZiAoZ3JpZC5hdCh4IC0gMSwgeSkgPT09IFRpbGVUeXBlLkV4dGVyaW9yICYmIGdyaWQuYXQoeCArIDEsIHkpID09PSBUaWxlVHlwZS5JbnRlcmlvcikge1xyXG4gICAgICAgIHJldHVybiBbeCAtIDEsIHldXHJcbiAgICB9XHJcblxyXG4gICAgaWYgKGdyaWQuYXQoeCwgeSArIDEpID09PSBUaWxlVHlwZS5FeHRlcmlvciAmJiBncmlkLmF0KHgsIHkgLSAxKSA9PT0gVGlsZVR5cGUuSW50ZXJpb3IpIHtcclxuICAgICAgICByZXR1cm4gW3gsIHkgKyAxXVxyXG4gICAgfVxyXG5cclxuICAgIGlmIChncmlkLmF0KHggKyAxLCB5KSA9PT0gVGlsZVR5cGUuRXh0ZXJpb3IgJiYgZ3JpZC5hdCh4IC0gMSwgeSkgPT09IFRpbGVUeXBlLkludGVyaW9yKSB7XHJcbiAgICAgICAgcmV0dXJuIFt4ICsgMSwgeV1cclxuICAgIH1cclxuXHJcbiAgICBpZiAoZ3JpZC5hdCh4LCB5IC0gMSkgPT09IFRpbGVUeXBlLkV4dGVyaW9yICYmIGdyaWQuYXQoeCwgeSArIDEpID09PSBUaWxlVHlwZS5JbnRlcmlvcikge1xyXG4gICAgICAgIHJldHVybiBbeCwgeSAtIDFdXHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIG51bGxcclxufVxyXG5cclxuZnVuY3Rpb24gaGFzSW50ZXJpb3JOZWlnaGJvcihncmQ6IGdyaWQuR3JpZDxUaWxlVHlwZT4sIHg6IG51bWJlciwgeTogbnVtYmVyKSB7XHJcbiAgICByZXR1cm4gZmluZFR1bm5lbGFibGVOZWlnaGJvcihncmQsIHgsIHkpICE9IG51bGxcclxufVxyXG5cclxuZnVuY3Rpb24gZmluZEludGVyaW9yTmVpZ2hib3IoZ3JkOiBncmlkLkdyaWQ8VGlsZVR5cGU+LCB4OiBudW1iZXIsIHk6IG51bWJlcik6IChDb29yZHMgfCBudWxsKSB7XHJcbiAgICBpZiAoeCA+IDAgJiYgZ3JkLmF0KHggLSAxLCB5KSA9PT0gVGlsZVR5cGUuSW50ZXJpb3IpIHtcclxuICAgICAgICByZXR1cm4gW3ggLSAxLCB5XVxyXG4gICAgfVxyXG5cclxuICAgIGlmICh5IDwgZ3JkLndpZHRoICYmIGdyZC5hdCh4LCB5ICsgMSkgPT09IFRpbGVUeXBlLkludGVyaW9yKSB7XHJcbiAgICAgICAgcmV0dXJuIFt4LCB5ICsgMV1cclxuICAgIH1cclxuXHJcbiAgICBpZiAoeCA8IGdyZC53aWR0aCAmJiBncmQuYXQoeCArIDEsIHkpID09PSBUaWxlVHlwZS5JbnRlcmlvcikge1xyXG4gICAgICAgIHJldHVybiBbeCArIDEsIHldXHJcbiAgICB9XHJcblxyXG4gICAgaWYgKHkgPiAwICYmIGdyZC5hdCh4LCB5IC0gMSkgPT09IFRpbGVUeXBlLkludGVyaW9yKSB7XHJcbiAgICAgICAgcmV0dXJuIFt4LCB5IC0gMV1cclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gbnVsbFxyXG59XHJcblxyXG5mdW5jdGlvbiBlbmNsb3NlUm9vbSh4MDogbnVtYmVyLCB5MDogbnVtYmVyLCB3aWR0aDogbnVtYmVyLCBoZWlnaHQ6IG51bWJlciwgZ3JpZDogZ3JpZC5HcmlkPFRpbGVUeXBlPikge1xyXG4gICAgY29uc3QgciA9IHgwICsgd2lkdGggLSAxXHJcbiAgICBjb25zdCBiID0geTAgKyBoZWlnaHQgLSAxXHJcbiAgICBmb3IgKGNvbnN0IFt4LCB5XSBvZiBncmlkLnNjYW5SZWdpb24oeDAsIHkwLCB3aWR0aCwgaGVpZ2h0KSkge1xyXG4gICAgICAgIGlmICh4ID09PSB4MCB8fCB5ID09IHkwIHx8IHggPT09IHIgfHwgeSA9PT0gYikge1xyXG4gICAgICAgICAgICBncmlkLnNldCh4LCB5LCBUaWxlVHlwZS5XYWxsKVxyXG4gICAgICAgICAgICBjb250aW51ZVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgZ3JpZC5zZXQoeCwgeSwgVGlsZVR5cGUuSW50ZXJpb3IpXHJcbiAgICB9XHJcbn1cclxuXHJcbmZ1bmN0aW9uIHJlZ2lvbklzRXh0ZXJpb3IoZ3JpZDogZ3JpZC5HcmlkPFRpbGVUeXBlPiwgeDA6IG51bWJlciwgeTA6IG51bWJlciwgd2lkdGg6IG51bWJlciwgaGVpZ2h0OiBudW1iZXIpOiBib29sZWFuIHtcclxuICAgIGNvbnN0IGV4dGVyaW9yID0gYXJyYXkuYWxsKGdyaWQuaXRlclJlZ2lvbih4MCwgeTAsIHdpZHRoLCBoZWlnaHQpLCB4ID0+IHggPT0gVGlsZVR5cGUuRXh0ZXJpb3IpXHJcbiAgICByZXR1cm4gZXh0ZXJpb3JcclxufSJdfQ==