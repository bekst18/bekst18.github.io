/**
 * web gl sprite rendering utilities
 */
import * as glu from "./glu.js";
const vertexSrc = `#version 300 es
precision mediump float;

uniform vec2 viewport_size;

in vec2 in_position;
in vec3 in_uvw;
in vec4 in_color;

out vec4 frag_color;
out vec3 frag_uvw;

void main() {
    frag_uvw = in_uvw;
    frag_color = in_color;
    vec2 position = vec2(in_position.x / viewport_size.x * 2.f - 1.f, -in_position.y / viewport_size.y * 2.f + 1.f);
    gl_Position = vec4(position, 0, 1);
}
`;
const fragmentSrc = `#version 300 es
precision highp float;
precision highp sampler2DArray;

uniform sampler2DArray sampler;

in vec4 frag_color;
in vec3 frag_uvw;

out vec4 out_color;

void main() {
    out_color = frag_color * texture(sampler, frag_uvw);
}
`;
let Renderer = /** @class */ (() => {
    class Renderer {
        constructor(canvas) {
            this.canvas = canvas;
            this.batches = new Map();
            this.numSprites = 0;
            this.vertices = new Float32Array();
            this.indices = new Uint16Array();
            this.gl = glu.createContext(canvas);
            const gl = this.gl;
            this.vertexBuffer = glu.createBuffer(gl);
            this.indexBuffer = glu.createBuffer(gl);
            this.program = glu.compileProgram(gl, vertexSrc, fragmentSrc);
            this.samplerUniformLocation = glu.getUniformLocation(gl, this.program, "sampler");
            this.positionAttribIdx = glu.getAttribLocation(gl, this.program, "in_position");
            this.uvwAttribIdx = glu.getAttribLocation(gl, this.program, "in_uvw");
            this.colorAttribIdx = glu.getAttribLocation(gl, this.program, "in_color");
            this.viewportSizeUniformLocation = glu.getUniformLocation(gl, this.program, "viewport_size");
            this.vao = glu.createVertexArray(gl);
            // setup sampler
            this.sampler = glu.createSampler(gl);
            gl.samplerParameteri(this.sampler, gl.TEXTURE_MAG_FILTER, gl.LINEAR);
            gl.samplerParameteri(this.sampler, gl.TEXTURE_MIN_FILTER, gl.LINEAR_MIPMAP_LINEAR);
            gl.samplerParameteri(this.sampler, gl.TEXTURE_WRAP_R, gl.CLAMP_TO_EDGE);
            gl.samplerParameteri(this.sampler, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);
            gl.samplerParameteri(this.sampler, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);
            // setup vertex array object
            const vertexStride = Renderer.elemsPerVertex * 4;
            gl.bindVertexArray(this.vao);
            gl.bindBuffer(gl.ARRAY_BUFFER, this.vertexBuffer);
            gl.vertexAttribPointer(this.positionAttribIdx, 2, gl.FLOAT, false, vertexStride, 0);
            gl.vertexAttribPointer(this.uvwAttribIdx, 3, gl.FLOAT, false, vertexStride, 8);
            gl.vertexAttribPointer(this.colorAttribIdx, 4, gl.FLOAT, false, vertexStride, 20);
            gl.enableVertexAttribArray(this.positionAttribIdx);
            gl.enableVertexAttribArray(this.uvwAttribIdx);
            gl.enableVertexAttribArray(this.colorAttribIdx);
            gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, this.indexBuffer);
        }
        bakeTextureArray(width, height, images) {
            // each image must be the same size
            const gl = this.gl;
            const texture = glu.createTexture(gl);
            gl.bindTexture(gl.TEXTURE_2D_ARRAY, texture);
            gl.texImage3D(gl.TEXTURE_2D_ARRAY, 0, gl.RGBA, width, height, images.length, 0, gl.RGBA, gl.UNSIGNED_BYTE, null);
            images.forEach((img, i) => {
                gl.texSubImage3D(gl.TEXTURE_2D_ARRAY, 0, 0, 0, i, width, height, 1, gl.RGBA, gl.UNSIGNED_BYTE, img);
            });
            gl.generateMipmap(gl.TEXTURE_2D_ARRAY);
            return texture;
        }
        drawSprite(sprite) {
            // add sprite to batch
            const batch = this.batches.get(sprite.texture);
            if (batch) {
                batch.sprites.push(sprite);
            }
            else {
                // append vertex for this sprite, increase sprite count
                this.batches.set(sprite.texture, {
                    offset: 0,
                    sprites: [sprite]
                });
            }
            ++this.numSprites;
        }
        flush() {
            // copy vertices and indices to arrays, growing arrays if required
            const numVertices = this.numSprites * 4;
            const numVertexElems = numVertices * Renderer.elemsPerVertex;
            const elemsPerSprite = 4 * Renderer.elemsPerVertex;
            if (this.vertices.length < numVertexElems) {
                this.vertices = new Float32Array(numVertexElems);
            }
            const numIndices = this.numSprites * 6;
            if (this.indices.length < numIndices) {
                this.indices = new Uint16Array(numIndices);
            }
            {
                let i = 0;
                for (const [_, batch] of this.batches) {
                    for (const sprite of batch.sprites) {
                        let elemOffset = i * elemsPerSprite;
                        let indexOffset = i * 6;
                        let baseIndex = i * 4;
                        this.pushVertex(elemOffset, sprite.position[0], sprite.position[1], 0, 0, sprite.layer, sprite.color[0], sprite.color[1], sprite.color[2], sprite.color[3]);
                        elemOffset += Renderer.elemsPerVertex;
                        this.pushVertex(elemOffset, sprite.position[0], sprite.position[1] + sprite.height, 0, 1, sprite.layer, sprite.color[0], sprite.color[1], sprite.color[2], sprite.color[3]);
                        elemOffset += Renderer.elemsPerVertex;
                        this.pushVertex(elemOffset, sprite.position[0] + sprite.width, sprite.position[1] + sprite.height, 1, 1, sprite.layer, sprite.color[0], sprite.color[1], sprite.color[2], sprite.color[3]);
                        elemOffset += Renderer.elemsPerVertex;
                        this.pushVertex(elemOffset, sprite.position[0] + sprite.width, sprite.position[1], 1, 0, sprite.layer, sprite.color[0], sprite.color[1], sprite.color[2], sprite.color[3]);
                        elemOffset += Renderer.elemsPerVertex;
                        this.indices[indexOffset] = baseIndex;
                        this.indices[indexOffset + 1] = baseIndex + 1;
                        this.indices[indexOffset + 2] = baseIndex + 2;
                        this.indices[indexOffset + 3] = baseIndex;
                        this.indices[indexOffset + 4] = baseIndex + 2;
                        this.indices[indexOffset + 5] = baseIndex + 3;
                        ++i;
                    }
                }
            }
            // draw the sprites
            const gl = this.gl;
            gl.bindVertexArray(this.vao);
            gl.bufferData(gl.ARRAY_BUFFER, this.vertices.subarray(0, this.numSprites * 4 * elemsPerSprite), gl.DYNAMIC_DRAW);
            gl.bufferData(gl.ELEMENT_ARRAY_BUFFER, this.indices.subarray(0, this.numSprites * 6), gl.DYNAMIC_DRAW);
            this.checkResize();
            gl.viewport(0, 0, gl.drawingBufferWidth, gl.drawingBufferHeight);
            gl.clearColor(0, 0, 0, 1);
            gl.clear(gl.COLOR_BUFFER_BIT);
            gl.useProgram(this.program);
            gl.uniform2f(this.viewportSizeUniformLocation, gl.drawingBufferWidth, gl.drawingBufferHeight);
            gl.bindVertexArray(this.vao);
            // draw each for
            for (const [texture, batch] of this.batches) {
                gl.activeTexture(gl.TEXTURE0);
                gl.bindTexture(gl.TEXTURE_2D_ARRAY, texture);
                gl.bindSampler(0, this.sampler);
                gl.uniform1i(this.samplerUniformLocation, 0);
                gl.drawElements(gl.TRIANGLES, batch.sprites.length * 6, gl.UNSIGNED_SHORT, 0);
            }
            // clear sprites
            this.batches.clear();
            this.numSprites = 0;
        }
        pushVertex(offset, x, y, u, v, w, r, g, b, a) {
            // position
            this.vertices[offset] = x;
            this.vertices[offset + 1] = y;
            // uv
            this.vertices[offset + 2] = u;
            this.vertices[offset + 3] = v;
            this.vertices[offset + 4] = w;
            // color
            this.vertices[offset + 5] = r;
            this.vertices[offset + 6] = g;
            this.vertices[offset + 7] = b;
            this.vertices[offset + 8] = a;
        }
        checkResize() {
            const canvas = this.canvas;
            if (canvas.width == canvas.clientWidth && canvas.height == canvas.clientHeight) {
                return;
            }
            canvas.width = canvas.clientWidth;
            canvas.height = canvas.clientHeight;
        }
    }
    // vertex layout:
    // xy uvw rgba (all float32)
    Renderer.elemsPerVertex = 9;
    return Renderer;
})();
export { Renderer };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2Z4LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiZ2Z4LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOztHQUVHO0FBQ0gsT0FBTyxLQUFLLEdBQUcsTUFBTSxVQUFVLENBQUE7QUFLL0IsTUFBTSxTQUFTLEdBQUc7Ozs7Ozs7Ozs7Ozs7Ozs7OztDQWtCakIsQ0FBQTtBQUVELE1BQU0sV0FBVyxHQUFHOzs7Ozs7Ozs7Ozs7OztDQWNuQixDQUFBO0FBZUQ7SUFBQSxNQUFhLFFBQVE7UUFvQmpCLFlBQTZCLE1BQXlCO1lBQXpCLFdBQU0sR0FBTixNQUFNLENBQW1CO1lBTDlDLFlBQU8sR0FBNEMsSUFBSSxHQUFHLEVBQUUsQ0FBQTtZQUM1RCxlQUFVLEdBQVcsQ0FBQyxDQUFBO1lBQ3RCLGFBQVEsR0FBaUIsSUFBSSxZQUFZLEVBQUUsQ0FBQTtZQUMzQyxZQUFPLEdBQWdCLElBQUksV0FBVyxFQUFFLENBQUE7WUFHNUMsSUFBSSxDQUFDLEVBQUUsR0FBRyxHQUFHLENBQUMsYUFBYSxDQUFDLE1BQU0sQ0FBQyxDQUFBO1lBQ25DLE1BQU0sRUFBRSxHQUFHLElBQUksQ0FBQyxFQUFFLENBQUE7WUFFbEIsSUFBSSxDQUFDLFlBQVksR0FBRyxHQUFHLENBQUMsWUFBWSxDQUFDLEVBQUUsQ0FBQyxDQUFBO1lBQ3hDLElBQUksQ0FBQyxXQUFXLEdBQUcsR0FBRyxDQUFDLFlBQVksQ0FBQyxFQUFFLENBQUMsQ0FBQTtZQUN2QyxJQUFJLENBQUMsT0FBTyxHQUFHLEdBQUcsQ0FBQyxjQUFjLENBQUMsRUFBRSxFQUFFLFNBQVMsRUFBRSxXQUFXLENBQUMsQ0FBQTtZQUM3RCxJQUFJLENBQUMsc0JBQXNCLEdBQUcsR0FBRyxDQUFDLGtCQUFrQixDQUFDLEVBQUUsRUFBRSxJQUFJLENBQUMsT0FBTyxFQUFFLFNBQVMsQ0FBQyxDQUFBO1lBQ2pGLElBQUksQ0FBQyxpQkFBaUIsR0FBRyxHQUFHLENBQUMsaUJBQWlCLENBQUMsRUFBRSxFQUFFLElBQUksQ0FB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LE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxNQUFNLENBQUMsS0FBSyxFQUFFLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLEVBQUUsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsRUFBRSxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxFQUFFLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQTt3QkFDM0osVUFBVSxJQUFJLFFBQVEsQ0FBQyxjQUFjLENBQUE7d0JBRXJDLElBQUksQ0FBQyxVQUFVLENBQUMsVUFBVSxFQUFFLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLEVBQUUsTUFBTSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsR0FBRyxNQUFNLENBQUMsTUFBTSxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsTUFBTSxDQUFDLEtBQUssRUFBRSxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxFQUFFLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLEVBQUUsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsRUFBRSxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUE7d0JBQzNLLFVBQVUsSUFBSSxRQUFRLENBQUMsY0FBYyxDQUFBO3dCQUVyQyxJQUFJLENBQUMsVUFBVSxDQUFDLFVBQVUsRUFBRSxNQUFNLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxHQUFHLE1BQU0sQ0FBQyxLQUFLLEVBQUUsTUFBTSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsR0FBRyxNQUFNLENBQUMsTUFBTSxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsTUFBTSxDQUFDLEtBQUssRUFBRSxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxFQUFFLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLEVBQUUsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsRUFBRSxN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N0IsUUFBUTtZQUNSLElBQUksQ0FBQyxRQUFRLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQTtZQUM3QixJQUFJLENBQUMsUUFBUSxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUE7WUFDN0IsSUFBSSxDQUFDLFFBQVEsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFBO1lBQzdCLElBQUksQ0FBQyxRQUFRLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQTtRQUNqQyxDQUFDO1FBRU8sV0FBVztZQUNmLE1BQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUE7WUFDMUIsSUFBSSxNQUFNLENBQUMsS0FBSyxJQUFJLE1BQU0sQ0FBQyxXQUFXLElBQUksTUFBTSxDQUFDLE1BQU0sSUFBSSxNQUFNLENBQUMsWUFBWSxFQUFFO2dCQUM1RSxPQUFNO2FBQ1Q7WUFFRCxNQUFNLENBQUMsS0FBSyxHQUFHLE1BQU0sQ0FBQyxXQUFXLENBQUE7WUFDakMsTUFBTSxDQUFDLE1BQU0sR0FBRyxNQUFNLENBQUMsWUFBWSxDQUFBO1FBQ3ZDLENBQUM7O0lBbkxELGlCQUFpQjtJQUNqQiw0QkFBNEI7SUFDSix1QkFBYyxHQUFHLENBQUMsQ0FBQTtJQWtMOUMsZUFBQztLQUFBO1NBckxZLFFBQVEiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcclxuICogd2ViIGdsIHNwcml0ZSByZW5kZXJpbmcgdXRpbGl0aWVzXHJcbiAqL1xyXG5pbXBvcnQgKiBhcyBnbHUgZnJvbSBcIi4vZ2x1LmpzXCJcclxuXHJcbmV4cG9ydCB0eXBlIENvbG9yID0gW251bWJlciwgbnVtYmVyLCBudW1iZXIsIG51bWJlcl1cclxuZXhwb3J0IHR5cGUgVmVjMiA9IFtudW1iZXIsIG51bWJlcl1cclxuXHJcbmNvbnN0IHZlcnRleFNyYyA9IGAjdmVyc2lvbiAzMDAgZXNcclxucHJlY2lzaW9uIG1lZGl1bXAgZmxvYXQ7XHJcblxyXG51bmlmb3JtIHZlYzIgdmlld3BvcnRfc2l6ZTtcclxuXHJcbmluIHZlYzIgaW5fcG9zaXRpb247XHJcbmluIHZlYzMgaW5fdXZ3O1xyXG5pbiB2ZWM0IGluX2NvbG9yO1xyXG5cclxub3V0IHZlYzQgZnJhZ19jb2xvcjtcclxub3V0IHZlYzMgZnJhZ191dnc7XHJcblxyXG52b2lkIG1haW4oKSB7XHJcbiAgICBmcmFnX3V2dyA9IGluX3V2dztcclxuICAgIGZyYWdfY29sb3IgPSBpbl9jb2xvcjtcclxuICAgIHZlYzIgcG9zaXRpb24gPSB2ZWMyKGluX3Bvc2l0aW9uLnggLyB2aWV3cG9ydF9zaXplLnggKiAyLmYgLSAxLmYsIC1pbl9wb3NpdGlvbi55IC8gdmlld3BvcnRfc2l6ZS55ICogMi5mICsgMS5mKTtcclxuICAgIGdsX1Bvc2l0aW9uID0gdmVjNChwb3NpdGlvbiwgMCwgMSk7XHJcbn1cclxuYFxyXG5cclxuY29uc3QgZnJhZ21lbnRTcmMgPSBgI3ZlcnNpb24gMzAwIGVzXHJcbnByZWNpc2lvbiBoaWdocCBmbG9hdDtcclxucHJlY2lzaW9uIGhpZ2hwIHNhbXBsZXIyREFycmF5O1xyXG5cclxudW5pZm9ybSBzYW1wbGVyMkRBcnJheSBzYW1wbGVyO1xyXG5cclxuaW4gdmVjNCBmcmFnX2NvbG9yO1xyXG5pbiB2ZWMzIGZyYWdfdXZ3O1xyXG5cclxub3V0IHZlYzQgb3V0X2NvbG9yO1xyXG5cclxudm9pZCBtYWluKCkge1xyXG4gICAgb3V0X2NvbG9yID0gZnJhZ19jb2xvciAqIHRleHR1cmUoc2FtcGxlciwgZnJhZ191dncpO1xyXG59XHJcbmBcclxuZXhwb3J0IGludGVyZmFjZSBTcHJpdGUge1xyXG4gICAgcG9zaXRpb246IFZlYzJcclxuICAgIHdpZHRoOiBudW1iZXJcclxuICAgIGhlaWdodDogbnVtYmVyXHJcbiAgICBsYXllcjogbnVtYmVyXHJcbiAgICBjb2xvcjogQ29sb3JcclxuICAgIHRleHR1cmU6IFdlYkdMVGV4dHVyZSB8IG51bGxcclxufVxyXG5cclxuaW50ZXJmYWNlIFNwcml0ZUJhdGNoIHtcclxuICAgIG9mZnNldDogbnVtYmVyXHJcbiAgICBzcHJpdGVzOiBTcHJpdGVbXVxyXG59XHJcblxyXG5leHBvcnQgY2xhc3MgUmVuZGVyZXIge1xyXG4gICAgLy8gdmVydGV4IGxheW91dDpcclxuICAgIC8vIHh5IHV2dyByZ2JhIChhbGwgZmxvYXQzMilcclxuICAgIHByaXZhdGUgc3RhdGljIHJlYWRvbmx5IGVsZW1zUGVyVmVydGV4ID0gOVxyXG4gICAgcHVibGljIHJlYWRvbmx5IGdsOiBXZWJHTDJSZW5kZXJpbmdDb250ZXh0XHJcbiAgICBwcml2YXRlIHJlYWRvbmx5IHByb2dyYW06IFdlYkdMUHJvZ3JhbVxyXG4gICAgcHJpdmF0ZSByZWFkb25seSB2ZXJ0ZXhCdWZmZXI6IFdlYkdMQnVmZmVyXHJcbiAgICBwcml2YXRlIHJlYWRvbmx5IGluZGV4QnVmZmVyOiBXZWJHTEJ1ZmZlclxyXG4gICAgcHJpdmF0ZSByZWFkb25seSBzYW1wbGVyVW5pZm9ybUxvY2F0aW9uOiBXZWJHTFVuaWZvcm1Mb2NhdGlvblxyXG4gICAgcHJpdmF0ZSByZWFkb25seSBwb3NpdGlvbkF0dHJpYklkeDogbnVtYmVyXHJcbiAgICBwcml2YXRlIHJlYWRvbmx5IHV2d0F0dHJpYklkeDogbnVtYmVyXHJcbiAgICBwcml2YXRlIHJlYWRvbmx5IGNvbG9yQXR0cmliSWR4OiBudW1iZXJcclxuICAgIHByaXZhdGUgcmVhZG9ubHkgdmlld3BvcnRTaXplVW5pZm9ybUxvY2F0aW9uOiBXZWJHTFVuaWZvcm1Mb2NhdGlvblxyXG4gICAgcHJpdmF0ZSByZWFkb25seSBzYW1wbGVyOiBXZWJHTFNhbXBsZXJcclxuICAgIHByaXZhdGUgcmVhZG9ubHkgdmFvOiBXZWJHTFZlcnRleEFycmF5T2JqZWN0XHJcbiAgICBwcml2YXRlIGJhdGNoZXM6IE1hcDwoV2ViR0xUZXh0dXJlIHwgbnVsbCksIFNwcml0ZUJhdGNoPiA9IG5ldyBNYXAoKVxyXG4gICAgcHJpdmF0ZSBudW1TcHJpdGVzOiBudW1iZXIgPSAwXHJcbiAgICBwcml2YXRlIHZlcnRpY2VzOiBGbG9hdDMyQXJyYXkgPSBuZXcgRmxvYXQzMkFycmF5KClcclxuICAgIHByaXZhdGUgaW5kaWNlczogVWludDE2QXJyYXkgPSBuZXcgVWludDE2QXJyYXkoKVxyXG5cclxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgcmVhZG9ubHkgY2FudmFzOiBIVE1MQ2FudmFzRWxlbWVudCkge1xyXG4gICAgICAgIHRoaXMuZ2wgPSBnbHUuY3JlYXRlQ29udGV4dChjYW52YXMpXHJcbiAgICAgICAgY29uc3QgZ2wgPSB0aGlzLmdsXHJcblxyXG4gICAgICAgIHRoaXMudmVydGV4QnVmZmVyID0gZ2x1LmNyZWF0ZUJ1ZmZlcihnbClcclxuICAgICAgICB0aGlzLmluZGV4QnVmZmVyID0gZ2x1LmNyZWF0ZUJ1ZmZlcihnbClcclxuICAgICAgICB0aGlzLnByb2dyYW0gPSBnbHUuY29tcGlsZVByb2dyYW0oZ2wsIHZlcnRleFNyYywgZnJhZ21lbnRTcmMpXHJcbiAgICAgICAgdGhpcy5zYW1wbGVyVW5pZm9ybUxvY2F0aW9uID0gZ2x1LmdldFVuaWZvcm1Mb2NhdGlvbihnbCwgdGhpcy5wcm9ncmFtLCBcInNhbXBsZXJcIilcclxuICAgICAgICB0aGlzLnBvc2l0aW9uQXR0cmliSWR4ID0gZ2x1LmdldEF0dHJpYkxvY2F0aW9uKGdsLCB0aGlzLnByb2dyYW0sIFwiaW5fcG9zaXRpb25cIilcclxuICAgICAgICB0aGlzLnV2d0F0dHJpYklkeCA9IGdsdS5nZXRBdHRyaWJMb2NhdGlvbihnbCwgdGhpcy5wcm9ncmFtLCBcImluX3V2d1wiKVxyXG4gICAgICAgIHRoaXMuY29sb3JBdHRyaWJJZHggPSBnbHUuZ2V0QXR0cmliTG9jYXRpb24oZ2wsIHRoaXMucHJvZ3JhbSwgXCJpbl9jb2xvclwiKVxyXG4gICAgICAgIHRoaXMudmlld3BvcnRTaXplVW5pZm9ybUxvY2F0aW9uID0gZ2x1LmdldFVuaWZvcm1Mb2NhdGlvbihnbCwgdGhpcy5wcm9ncmFtLCBcInZpZXdwb3J0X3NpemVcIilcclxuICAgICAgICB0aGlzLnZhbyA9IGdsdS5jcmVhdGVWZXJ0ZXhBcnJheShnbClcclxuXHJcbiAgICAgICAgLy8gc2V0dXAgc2FtcGxlclxyXG4gICAgICAgIHRoaXMuc2FtcGxlciA9IGdsdS5jcmVhdGVTYW1wbGVyKGdsKVxyXG4gICAgICAgIGdsLnNhbXBsZXJQYXJhbWV0ZXJpKHRoaXMuc2FtcGxlciwgZ2wuVEVYVFVSRV9NQUdfRklMVEVSLCBnbC5MSU5FQVIpXHJcbiAgICAgICAgZ2wuc2FtcGxlclBhcmFtZXRlcmkodGhpcy5zYW1wbGVyLCBnbC5URVhUVVJFX01JTl9GSUxURVIsIGdsLkxJTkVBUl9NSVBNQVBfTElORUFSKVxyXG4gICAgICAgIGdsLnNhbXBsZXJQYXJhbWV0ZXJpKHRoaXMuc2FtcGxlciwgZ2wuVEVYVFVSRV9XUkFQX1IsIGdsLkNMQU1QX1RPX0VER0UpXHJcbiAgICAgICAgZ2wuc2FtcGxlclBhcmFtZXRlcmkodGhpcy5zYW1wbGVyLCBnbC5URVhUVVJFX1dSQVBfUywgZ2wuQ0xBTVBfVE9fRURHRSlcclxuICAgICAgICBnbC5zYW1wbGVyUGFyYW1ldGVyaSh0aGlzLnNhbXBsZXIsIGdsLlRFWFRVUkVfV1JBUF9ULCBnbC5DTEFNUF9UT19FREdFKVxyXG5cclxuICAgICAgICAvLyBzZXR1cCB2ZXJ0ZXggYXJyYXkgb2JqZWN0XHJcbiAgICAgICAgY29uc3QgdmVydGV4U3RyaWRlID0gUmVuZGVyZXIuZWxlbXNQZXJWZXJ0ZXggKiA0XHJcbiAgICAgICAgZ2wuYmluZFZlcnRleEFycmF5KHRoaXMudmFvKVxyXG4gICAgICAgIGdsLmJpbmRCdWZmZXIoZ2wuQVJSQVlfQlVGRkVSLCB0aGlzLnZlcnRleEJ1ZmZlcilcclxuICAgICAgICBnbC52ZXJ0ZXhBdHRyaWJQb2ludGVyKHRoaXMucG9zaXRpb25BdHRyaWJJZHgsIDIsIGdsLkZMT0FULCBmYWxzZSwgdmVydGV4U3RyaWRlLCAwKVxyXG4gICAgICAgIGdsLnZlcnRleEF0dHJpYlBvaW50ZXIodGhpcy51dndBdHRyaWJJZHgsIDMsIGdsLkZMT0FULCBmYWxzZSwgdmVydGV4U3RyaWRlLCA4KVxyXG4gICAgICAgIGdsLnZlcnRleEF0dHJpYlBvaW50ZXIodGhpcy5jb2xvckF0dHJpYklkeCwgNCwgZ2wuRkxPQVQsIGZhbHNlLCB2ZXJ0ZXhTdHJpZGUsIDIwKVxyXG4gICAgICAgIGdsLmVuYWJsZVZlcnRleEF0dHJpYkFycmF5KHRoaXMucG9zaXRpb25BdHRyaWJJZHgpXHJcbiAgICAgICAgZ2wuZW5hYmxlVmVydGV4QXR0cmliQXJyYXkodGhpcy51dndBdHRyaWJJZHgpXHJcbiAgICAgICAgZ2wuZW5hYmxlVmVydGV4QXR0cmliQXJyYXkodGhpcy5jb2xvckF0dHJpYklkeClcclxuICAgICAgICBnbC5iaW5kQnVmZmVyKGdsLkVMRU1FTlRfQVJSQVlfQlVGRkVSLCB0aGlzLmluZGV4QnVmZmVyKVxyXG4gICAgfVxyXG5cclxuICAgIGJha2VUZXh0dXJlQXJyYXkod2lkdGg6IG51bWJlciwgaGVpZ2h0OiBudW1iZXIsIGltYWdlczogVGV4SW1hZ2VTb3VyY2VbXSkge1xyXG4gICAgICAgIC8vIGVhY2ggaW1hZ2UgbXVzdCBiZSB0aGUgc2FtZSBzaXplXHJcbiAgICAgICAgY29uc3QgZ2wgPSB0aGlzLmdsXHJcbiAgICAgICAgY29uc3QgdGV4dHVyZSA9IGdsdS5jcmVhdGVUZXh0dXJlKGdsKVxyXG4gICAgICAgIGdsLmJpbmRUZXh0dXJlKGdsLlRFWFRVUkVfMkRfQVJSQVksIHRleHR1cmUpXHJcbiAgICAgICAgZ2wudGV4SW1hZ2UzRChnbC5URVhUVVJFXzJEX0FSUkFZLCAwLCBnbC5SR0JBLCB3aWR0aCwgaGVpZ2h0LCBpbWFnZXMubGVuZ3RoLCAwLCBnbC5SR0JBLCBnbC5VTlNJR05FRF9CWVRFLCBudWxsKVxyXG4gICAgICAgIGltYWdlcy5mb3JFYWNoKChpbWcsIGkpID0+IHtcclxuICAgICAgICAgICAgZ2wudGV4U3ViSW1hZ2UzRChnbC5URVhUVVJFXzJEX0FSUkFZLCAwLCAwLCAwLCBpLCB3aWR0aCwgaGVpZ2h0LCAxLCBnbC5SR0JBLCBnbC5VTlNJR05FRF9CWVRFLCBpbWcpXHJcbiAgICAgICAgfSlcclxuXHJcbiAgICAgICAgZ2wuZ2VuZXJhdGVNaXBtYXAoZ2wuVEVYVFVSRV8yRF9BUlJBWSlcclxuICAgICAgICByZXR1cm4gdGV4dHVyZVxyXG4gICAgfVxyXG5cclxuICAgIGRyYXdTcHJpdGUoc3ByaXRlOiBTcHJpdGUpIHtcclxuICAgICAgICAvLyBhZGQgc3ByaXRlIHRvIGJhdGNoXHJcbiAgICAgICAgY29uc3QgYmF0Y2ggPSB0aGlzLmJhdGNoZXMuZ2V0KHNwcml0ZS50ZXh0dXJlKVxyXG4gICAgICAgIGlmIChiYXRjaCkge1xyXG4gICAgICAgICAgICBiYXRjaC5zcHJpdGVzLnB1c2goc3ByaXRlKVxyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIC8vIGFwcGVuZCB2ZXJ0ZXggZm9yIHRoaXMgc3ByaXRlLCBpbmNyZWFzZSBzcHJpdGUgY291bnRcclxuICAgICAgICAgICAgdGhpcy5iYXRjaGVzLnNldChzcHJpdGUudGV4dHVyZSwge1xyXG4gICAgICAgICAgICAgICAgb2Zmc2V0OiAwLFxyXG4gICAgICAgICAgICAgICAgc3ByaXRlczogW3Nwcml0ZV1cclxuICAgICAgICAgICAgfSlcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgICsrdGhpcy5udW1TcHJpdGVzXHJcbiAgICB9XHJcblxyXG4gICAgZmx1c2goKSB7XHJcbiAgICAgICAgLy8gY29weSB2ZXJ0aWNlcyBhbmQgaW5kaWNlcyB0byBhcnJheXMsIGdyb3dpbmcgYXJyYXlzIGlmIHJlcXVpcmVkXHJcbiAgICAgICAgY29uc3QgbnVtVmVydGljZXMgPSB0aGlzLm51bVNwcml0ZXMgKiA0XHJcbiAgICAgICAgY29uc3QgbnVtVmVydGV4RWxlbXMgPSBudW1WZXJ0aWNlcyAqIFJlbmRlcmVyLmVsZW1zUGVyVmVydGV4XHJcbiAgICAgICAgY29uc3QgZWxlbXNQZXJTcHJpdGUgPSA0ICogUmVuZGVyZXIuZWxlbXNQZXJWZXJ0ZXhcclxuICAgICAgICBpZiAodGhpcy52ZXJ0aWNlcy5sZW5ndGggPCBudW1WZXJ0ZXhFbGVtcykge1xyXG4gICAgICAgICAgICB0aGlzLnZlcnRpY2VzID0gbmV3IEZsb2F0MzJBcnJheShudW1WZXJ0ZXhFbGVtcylcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGNvbnN0IG51bUluZGljZXMgPSB0aGlzLm51bVNwcml0ZXMgKiA2XHJcbiAgICAgICAgaWYgKHRoaXMuaW5kaWNlcy5sZW5ndGggPCBudW1JbmRpY2VzKSB7XHJcbiAgICAgICAgICAgIHRoaXMuaW5kaWNlcyA9IG5ldyBVaW50MTZBcnJheShudW1JbmRpY2VzKVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAge1xyXG4gICAgICAgICAgICBsZXQgaSA9IDBcclxuICAgICAgICAgICAgZm9yIChjb25zdCBbXywgYmF0Y2hdIG9mIHRoaXMuYmF0Y2hlcykge1xyXG4gICAgICAgICAgICAgICAgZm9yIChjb25zdCBzcHJpdGUgb2YgYmF0Y2guc3ByaXRlcykge1xyXG4gICAgICAgICAgICAgICAgICAgIGxldCBlbGVtT2Zmc2V0ID0gaSAqIGVsZW1zUGVyU3ByaXRlXHJcbiAgICAgICAgICAgICAgICAgICAgbGV0IGluZGV4T2Zmc2V0ID0gaSAqIDZcclxuICAgICAgICAgICAgICAgICAgICBsZXQgYmFzZUluZGV4ID0gaSAqIDRcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLnB1c2hWZXJ0ZXgoZWxlbU9mZnNldCwgc3ByaXRlLnBvc2l0aW9uWzBdLCBzcHJpdGUucG9zaXRpb25bMV0sIDAsIDAsIHNwcml0ZS5sYXllciwgc3ByaXRlLmNvbG9yWzBdLCBzcHJpdGUuY29sb3JbMV0sIHNwcml0ZS5jb2xvclsyXSwgc3ByaXRlLmNvbG9yWzNdKVxyXG4gICAgICAgICAgICAgICAgICAgIGVsZW1PZmZzZXQgKz0gUmVuZGVyZXIuZWxlbXNQZXJWZXJ0ZXhcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5wdXNoVmVydGV4KGVsZW1PZmZzZXQsIHNwcml0ZS5wb3NpdGlvblswXSwgc3ByaXRlLnBvc2l0aW9uWzFdICsgc3ByaXRlLmhlaWdodCwgMCwgMSwgc3ByaXRlLmxheWVyLCBzcHJpdGUuY29sb3JbMF0sIHNwcml0ZS5jb2xvclsxXSwgc3ByaXRlLmNvbG9yWzJdLCBzcHJpdGUuY29sb3JbM10pXHJcbiAgICAgICAgICAgICAgICAgICAgZWxlbU9mZnNldCArPSBSZW5kZXJlci5lbGVtc1BlclZlcnRleFxyXG5cclxuICAgICAgICAgICAgICAgICAgICB0aGlzLnB1c2hWZXJ0ZXgoZWxlbU9mZnNldCwgc3ByaXRlLnBvc2l0aW9uWzBdICsgc3ByaXRlLndpZHRoLCBzcHJpdGUucG9zaXRpb25bMV0gKyBzcHJpdGUuaGVpZ2h0LCAxLCAxLCBzcHJpdGUubGF5ZXIsIHNwcml0ZS5jb2xvclswXSwgc3ByaXRlLmNvbG9yWzFdLCBzcHJpdGUuY29sb3JbMl0sIHNwcml0ZS5jb2xvclszXSlcclxuICAgICAgICAgICAgICAgICAgICBlbGVtT2Zmc2V0ICs9IFJlbmRlcmVyLmVsZW1zUGVyVmVydGV4XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMucHVzaFZlcnRleChlbGVtT2Zmc2V0LCBzcHJpdGUucG9zaXRpb25bMF0gKyBzcHJpdGUud2lkdGgsIHNwcml0ZS5wb3NpdGlvblsxXSwgMSwgMCwgc3ByaXRlLmxheWVyLCBzcHJpdGUuY29sb3JbMF0sIHNwcml0ZS5jb2xvclsxXSwgc3ByaXRlLmNvbG9yWzJdLCBzcHJpdGUuY29sb3JbM10pXHJcbiAgICAgICAgICAgICAgICAgICAgZWxlbU9mZnNldCArPSBSZW5kZXJlci5lbGVtc1BlclZlcnRleFxyXG5cclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmluZGljZXNbaW5kZXhPZmZzZXRdID0gYmFzZUluZGV4XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5pbmRpY2VzW2luZGV4T2Zmc2V0ICsgMV0gPSBiYXNlSW5kZXggKyAxXHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5pbmRpY2VzW2luZGV4T2Zmc2V0ICsgMl0gPSBiYXNlSW5kZXggKyAyXHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5pbmRpY2VzW2luZGV4T2Zmc2V0ICsgM10gPSBiYXNlSW5kZXhcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmluZGljZXNbaW5kZXhPZmZzZXQgKyA0XSA9IGJhc2VJbmRleCArIDJcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmluZGljZXNbaW5kZXhPZmZzZXQgKyA1XSA9IGJhc2VJbmRleCArIDNcclxuICAgICAgICAgICAgICAgICAgICArK2lcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8gZHJhdyB0aGUgc3ByaXRlc1xyXG4gICAgICAgIGNvbnN0IGdsID0gdGhpcy5nbFxyXG4gICAgICAgIGdsLmJpbmRWZXJ0ZXhBcnJheSh0aGlzLnZhbylcclxuICAgICAgICBnbC5idWZmZXJEYXRhKGdsLkFSUkFZX0JVRkZFUiwgdGhpcy52ZXJ0aWNlcy5zdWJhcnJheSgwLCB0aGlzLm51bVNwcml0ZXMgKiA0ICogZWxlbXNQZXJTcHJpdGUpLCBnbC5EWU5BTUlDX0RSQVcpXHJcbiAgICAgICAgZ2wuYnVmZmVyRGF0YShnbC5FTEVNRU5UX0FSUkFZX0JVRkZFUiwgdGhpcy5pbmRpY2VzLnN1YmFycmF5KDAsIHRoaXMubnVtU3ByaXRlcyAqIDYpLCBnbC5EWU5BTUlDX0RSQVcpXHJcblxyXG4gICAgICAgIHRoaXMuY2hlY2tSZXNpemUoKVxyXG4gICAgICAgIGdsLnZpZXdwb3J0KDAsIDAsIGdsLmRyYXdpbmdCdWZmZXJXaWR0aCwgZ2wuZHJhd2luZ0J1ZmZlckhlaWdodClcclxuICAgICAgICBnbC5jbGVhckNvbG9yKDAsIDAsIDAsIDEpXHJcbiAgICAgICAgZ2wuY2xlYXIoZ2wuQ09MT1JfQlVGRkVSX0JJVClcclxuICAgICAgICBnbC51c2VQcm9ncmFtKHRoaXMucHJvZ3JhbSlcclxuICAgICAgICBnbC51bmlmb3JtMmYodGhpcy52aWV3cG9ydFNpemVVbmlmb3JtTG9jYXRpb24sIGdsLmRyYXdpbmdCdWZmZXJXaWR0aCwgZ2wuZHJhd2luZ0J1ZmZlckhlaWdodClcclxuICAgICAgICBnbC5iaW5kVmVydGV4QXJyYXkodGhpcy52YW8pXHJcblxyXG4gICAgICAgIC8vIGRyYXcgZWFjaCBmb3JcclxuICAgICAgICBmb3IgKGNvbnN0IFt0ZXh0dXJlLCBiYXRjaF0gb2YgdGhpcy5iYXRjaGVzKSB7XHJcbiAgICAgICAgICAgIGdsLmFjdGl2ZVRleHR1cmUoZ2wuVEVYVFVSRTApXHJcbiAgICAgICAgICAgIGdsLmJpbmRUZXh0dXJlKGdsLlRFWFRVUkVfMkRfQVJSQVksIHRleHR1cmUpXHJcbiAgICAgICAgICAgIGdsLmJpbmRTYW1wbGVyKDAsIHRoaXMuc2FtcGxlcilcclxuICAgICAgICAgICAgZ2wudW5pZm9ybTFpKHRoaXMuc2FtcGxlclVuaWZvcm1Mb2NhdGlvbiwgMClcclxuICAgICAgICAgICAgZ2wuZHJhd0VsZW1lbnRzKGdsLlRSSUFOR0xFUywgYmF0Y2guc3ByaXRlcy5sZW5ndGggKiA2LCBnbC5VTlNJR05FRF9TSE9SVCwgMClcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8vIGNsZWFyIHNwcml0ZXNcclxuICAgICAgICB0aGlzLmJhdGNoZXMuY2xlYXIoKVxyXG4gICAgICAgIHRoaXMubnVtU3ByaXRlcyA9IDBcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIHB1c2hWZXJ0ZXgob2Zmc2V0OiBudW1iZXIsIHg6IG51bWJlciwgeTogbnVtYmVyLCB1OiBudW1iZXIsIHY6IG51bWJlciwgdzogbnVtYmVyLCByOiBudW1iZXIsIGc6IG51bWJlciwgYjogbnVtYmVyLCBhOiBudW1iZXIpIHtcclxuICAgICAgICAvLyBwb3NpdGlvblxyXG4gICAgICAgIHRoaXMudmVydGljZXNbb2Zmc2V0XSA9IHhcclxuICAgICAgICB0aGlzLnZlcnRpY2VzW29mZnNldCArIDFdID0geVxyXG4gICAgICAgIC8vIHV2XHJcbiAgICAgICAgdGhpcy52ZXJ0aWNlc1tvZmZzZXQgKyAyXSA9IHVcclxuICAgICAgICB0aGlzLnZlcnRpY2VzW29mZnNldCArIDNdID0gdlxyXG4gICAgICAgIHRoaXMudmVydGljZXNbb2Zmc2V0ICsgNF0gPSB3XHJcbiAgICAgICAgLy8gY29sb3JcclxuICAgICAgICB0aGlzLnZlcnRpY2VzW29mZnNldCArIDVdID0gclxyXG4gICAgICAgIHRoaXMudmVydGljZXNbb2Zmc2V0ICsgNl0gPSBnXHJcbiAgICAgICAgdGhpcy52ZXJ0aWNlc1tvZmZzZXQgKyA3XSA9IGJcclxuICAgICAgICB0aGlzLnZlcnRpY2VzW29mZnNldCArIDhdID0gYVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgY2hlY2tSZXNpemUoKSB7XHJcbiAgICAgICAgY29uc3QgY2FudmFzID0gdGhpcy5jYW52YXNcclxuICAgICAgICBpZiAoY2FudmFzLndpZHRoID09IGNhbnZhcy5jbGllbnRXaWR0aCAmJiBjYW52YXMuaGVpZ2h0ID09IGNhbnZhcy5jbGllbnRIZWlnaHQpIHtcclxuICAgICAgICAgICAgcmV0dXJuXHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBjYW52YXMud2lkdGggPSBjYW52YXMuY2xpZW50V2lkdGhcclxuICAgICAgICBjYW52YXMuaGVpZ2h0ID0gY2FudmFzLmNsaWVudEhlaWdodFxyXG4gICAgfVxyXG59Il19