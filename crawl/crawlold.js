import * as dom from "../shared/dom.js";
import * as glu from "./glu.js";
const vertexSrc = `#version 300 es
precision mediump float;
in vec4 in_position;

void main() {
    gl_Position = in_position;
}
`;
const fragmentSrc = `#version 300 es
precision mediump float;
uniform vec2 scroll_offset;
out vec4 out_color;

${glu.perlin2}

int mmod(const int n, const int M) {
    return ((n % M) + M) % M;
}

ivec2 mmod(const ivec2 n, const ivec2 M) {
    return ((n % M) + M) % M;
}

float grid_line_dist(const vec2 xy, const int interval, const float width) {
    vec2 mxy = vec2(mmod(ivec2(xy), ivec2(interval, interval)));
    mxy = clamp(mxy, vec2(0, 0), vec2(width, width));
    vec2 dxy = vec2(width, width) - mxy;
    return max(dxy.x, dxy.y) / float(width);
}

void main() {
    vec2 xy = gl_FragCoord.xy + scroll_offset.xy;
    float freq = 16.f / 512.f;
    float v = fbm2(freq * xy.x, freq * xy.y, 2.f, .5f, 5) / 32.f;
    vec4 bg = vec4(.9 + v,.9 + v,.9 + v,1);
    float d1 = grid_line_dist(xy, 128, 3.f);
    float d2 = grid_line_dist(xy, 32, 1.f);
    vec3 a = mix(bg.rgb, vec3(0, 0, 1), d1);
    vec3 b = mix(a, vec3(0, 0, 1), d2);
    out_color = vec4(b, 1);
}
`;
const canvas = dom.byId("canvas");
const errorsDiv = dom.byId("errors");
init();
function init() {
    canvas.width = canvas.clientWidth;
    canvas.height = canvas.clientHeight;
    clearErrorMessages();
    const gs = createGameState();
    canvas.addEventListener("keydown", (ev) => handleKeyDown(ev, gs.keyState));
    canvas.addEventListener("keyup", (ev) => handleKeyUp(ev, gs.keyState));
    requestAnimationFrame(() => {
        tick(gs);
    });
}
function createGameState() {
    const gl = canvas.getContext("webgl2");
    if (!gl) {
        throw new Error("Failed to not initialize webgl 2.0. Confirm that your browser is up to date and has support.");
    }
    clearErrorMessages();
    // compile program, get uniform locations
    const program = glu.compileProgram(gl, vertexSrc, fragmentSrc);
    const scrollOffsetLocation = glu.getUniformLocation(gl, program, "scroll_offset");
    const positionBuffer = gl.createBuffer();
    if (!positionBuffer) {
        throw new Error("Failed to create buffer");
    }
    const positions = [-1, -1, 1, -1, 1, 1, -1, 1];
    gl.bindBuffer(gl.ARRAY_BUFFER, positionBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(positions), gl.STATIC_DRAW);
    const indexBuffer = gl.createBuffer();
    if (!indexBuffer) {
        throw new Error("Failed to create index buffer");
    }
    const vao = gl.createVertexArray();
    if (!vao) {
        throw new Error("failed to create vertex array object");
    }
    const positionAttributeIndex = gl.getAttribLocation(program, "in_position");
    if (positionAttributeIndex < 0) {
        throwError("in_position attribute was not found");
    }
    gl.bindVertexArray(vao);
    const indices = [0, 1, 2, 0, 2, 3];
    gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, indexBuffer);
    gl.bufferData(gl.ELEMENT_ARRAY_BUFFER, new Uint16Array(indices), gl.STATIC_DRAW);
    gl.vertexAttribPointer(positionAttributeIndex, 2, gl.FLOAT, false, 0, 0);
    gl.enableVertexAttribArray(positionAttributeIndex);
    return {
        gl: gl,
        program: program,
        vao: vao,
        scrollOffsetLocation: scrollOffsetLocation,
        scrollOffset: { x: 0, y: 0 },
        keyState: {}
    };
}
function tick(gs) {
    processInput(gs);
    renderFrame(gs);
    requestAnimationFrame(() => tick(gs));
}
function processInput(gs) {
    if (gs.keyState["w"]) {
        gs.scrollOffset.y += 1;
    }
    if (gs.keyState["s"]) {
        gs.scrollOffset.y -= 1;
    }
    if (gs.keyState["a"]) {
        gs.scrollOffset.x -= 1;
    }
    if (gs.keyState["d"]) {
        gs.scrollOffset.x += 1;
    }
}
function renderFrame(gs) {
    const { gl, program, vao } = gs;
    checkResize();
    gl.viewport(0, 0, gl.drawingBufferWidth, gl.drawingBufferHeight);
    gl.clearColor(0, 0, 0, 1);
    gl.clear(gl.COLOR_BUFFER_BIT);
    gl.useProgram(program);
    gl.uniform2f(gs.scrollOffsetLocation, gs.scrollOffset.x, gs.scrollOffset.y);
    gl.bindVertexArray(vao);
    gl.drawElements(gl.TRIANGLES, 6, gl.UNSIGNED_SHORT, 0);
}
function checkResize() {
    if (canvas.width == canvas.clientWidth && canvas.height == canvas.clientHeight) {
        return;
    }
    canvas.width = canvas.clientWidth;
    canvas.height = canvas.clientHeight;
}
function clearErrorMessages() {
    canvas.hidden = false;
    dom.removeAllChildren(errorsDiv);
}
function appendErrorMessage(error) {
    console.log(error);
    const div = document.createElement("div");
    div.classList.add("error-message");
    div.textContent = error;
    errorsDiv.appendChild(div);
    canvas.hidden = true;
}
function throwError(message) {
    appendErrorMessage(message);
    throw new Error(message);
}
function handleKeyDown(ev, keyState) {
    keyState[ev.key] = true;
}
function handleKeyUp(ev, keyState) {
    keyState[ev.key] = false;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3Jhd2xvbGQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJjcmF3bG9sZC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEtBQUssR0FBRyxNQUFNLGtCQUFrQixDQUFBO0FBQ3ZDLE9BQU8sS0FBSyxHQUFHLE1BQU0sVUFBVSxDQUFBO0FBRS9CLE1BQU0sU0FBUyxHQUFHOzs7Ozs7O0NBT2pCLENBQUE7QUFDRCxNQUFNLFdBQVcsR0FBRzs7Ozs7RUFLbEIsR0FBRyxDQUFDLE9BQU87Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Q0E0QlosQ0FBQTtBQUVELE1BQU0sTUFBTSxHQUFHLEdBQUcsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFzQixDQUFBO0FBQ3RELE1BQU0sU0FBUyxHQUFHLEdBQUcsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUM7QUFFckMsSUFBSSxFQUFFLENBQUE7QUFnQk4sU0FBUyxJQUFJO0lBQ1QsTUFBTSxDQUFDLEtBQUssR0FBRyxNQUFNLENBQUMsV0FBVyxDQUFBO0lBQ2pDLE1BQU0sQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFDLFlBQVksQ0FBQTtJQUVuQyxrQkFBa0IsRUFBRSxDQUFBO0lBQ3BCLE1BQU0sRUFBRSxHQUFHLGVBQWUsRUFBRSxDQUFBO0lBRTVCLE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQyxTQUFTLEVBQUUsQ0FBQyxFQUFFLEVBQUUsRUFBRSxDQUFDLGFBQWEsQ0FBQyxFQUFFLEVBQUUsRUFBRSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUE7SUFDMUUsTUFBTSxDQUFDLGdCQUFnQixDQUFDLE9BQU8sRUFBRSxDQUFDLEVBQUUsRUFBRSxFQUFFLENBQUMsV0FBVyxDQUFDLEVBQUUsRUFBRSxFQUFFLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQTtJQUV0RSxxQkFBcUIsQ0FBQyxHQUFHLEVBQUU7UUFDdkIsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFBO0lBQ1osQ0FBQyxDQUFDLENBQUE7QUFD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QUksQ0FBQTtBQUN4QixDQUFDO0FBRUQsU0FBUyxVQUFVLENBQUMsT0FBZTtJQUMvQixrQkFBa0IsQ0FBQyxPQUFPLENBQUMsQ0FBQTtJQUMzQixNQUFNLElBQUksS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFBO0FBQzVCLENBQUM7QUFFRCxTQUFTLGFBQWEsQ0FBQyxFQUFpQixFQUFFLFFBQWlDO0lBQ3ZFLFFBQVEsQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLEdBQUcsSUFBSSxDQUFBO0FBQzNCLENBQUM7QUFFRCxTQUFTLFdBQVcsQ0FBQyxFQUFpQixFQUFFLFFBQWlDO0lBQ3JFLFFBQVEsQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLEdBQUcsS0FBSyxDQUFBO0FBQzVCLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBkb20gZnJvbSBcIi4uL3NoYXJlZC9kb20uanNcIlxyXG5pbXBvcnQgKiBhcyBnbHUgZnJvbSBcIi4vZ2x1LmpzXCJcclxuXHJcbmNvbnN0IHZlcnRleFNyYyA9IGAjdmVyc2lvbiAzMDAgZXNcclxucHJlY2lzaW9uIG1lZGl1bXAgZmxvYXQ7XHJcbmluIHZlYzQgaW5fcG9zaXRpb247XHJcblxyXG52b2lkIG1haW4oKSB7XHJcbiAgICBnbF9Qb3NpdGlvbiA9IGluX3Bvc2l0aW9uO1xyXG59XHJcbmBcclxuY29uc3QgZnJhZ21lbnRTcmMgPSBgI3ZlcnNpb24gMzAwIGVzXHJcbnByZWNpc2lvbiBtZWRpdW1wIGZsb2F0O1xyXG51bmlmb3JtIHZlYzIgc2Nyb2xsX29mZnNldDtcclxub3V0IHZlYzQgb3V0X2NvbG9yO1xyXG5cclxuJHtnbHUucGVybGluMn1cclxuXHJcbmludCBtbW9kKGNvbnN0IGludCBuLCBjb25zdCBpbnQgTSkge1xyXG4gICAgcmV0dXJuICgobiAlIE0pICsgTSkgJSBNO1xyXG59XHJcblxyXG5pdmVjMiBtbW9kKGNvbnN0IGl2ZWMyIG4sIGNvbnN0IGl2ZWMyIE0pIHtcclxuICAgIHJldHVybiAoKG4gJSBNKSArIE0pICUgTTtcclxufVxyXG5cclxuZmxvYXQgZ3JpZF9saW5lX2Rpc3QoY29uc3QgdmVjMiB4eSwgY29uc3QgaW50IGludGVydmFsLCBjb25zdCBmbG9hdCB3aWR0aCkge1xyXG4gICAgdmVjMiBteHkgPSB2ZWMyKG1tb2QoaXZlYzIoeHkpLCBpdmVjMihpbnRlcnZhbCwgaW50ZXJ2YWwpKSk7XHJcbiAgICBteHkgPSBjbGFtcChteHksIHZlYzIoMCwgMCksIHZlYzIod2lkdGgsIHdpZHRoKSk7XHJcbiAgICB2ZWMyIGR4eSA9IHZlYzIod2lkdGgsIHdpZHRoKSAtIG14eTtcclxuICAgIHJldHVybiBtYXgoZHh5LngsIGR4eS55KSAvIGZsb2F0KHdpZHRoKTtcclxufVxyXG5cclxudm9pZCBtYWluKCkge1xyXG4gICAgdmVjMiB4eSA9IGdsX0ZyYWdDb29yZC54eSArIHNjcm9sbF9vZmZzZXQueHk7XHJcbiAgICBmbG9hdCBmcmVxID0gMTYuZiAvIDUxMi5mO1xyXG4gICAgZmxvYXQgdiA9IGZibTIoZnJlcSAqIHh5LngsIGZyZXEgKiB4eS55LCAyLmYsIC41ZiwgNSkgLyAzMi5mO1xyXG4gICAgdmVjNCBiZyA9IHZlYzQoLjkgKyB2LC45ICsgdiwuOSArIHYsMSk7XHJcbiAgICBmbG9hdCBkMSA9IGdyaWRfbGluZV9kaXN0KHh5LCAxMjgsIDMuZik7XHJcbiAgICBmbG9hdCBkMiA9IGdyaWRfbGluZV9kaXN0KHh5LCAzMiwgMS5mKTtcclxuICAgIHZlYzMgYSA9IG1peChiZy5yZ2IsIHZlYzMoMCwgMCwgMSksIGQxKTtcclxuICAgIHZlYzMgYiA9IG1peChhLCB2ZWMzKDAsIDAsIDEpLCBkMik7XHJcbiAgICBvdXRfY29sb3IgPSB2ZWM0KGIsIDEpO1xyXG59XHJcbmBcclxuXHJcbmNvbnN0IGNhbnZhcyA9IGRvbS5ieUlkKFwiY2FudmFzXCIpIGFzIEhUTUxDYW52YXNFbGVtZW50XHJcbmNvbnN0IGVycm9yc0RpdiA9IGRvbS5ieUlkKFwiZXJyb3JzXCIpO1xyXG5cclxuaW5pdCgpXHJcblxyXG5pbnRlcmZhY2UgUG9pbnQge1xyXG4gICAgeDogbnVtYmVyLFxyXG4gICAgeTogbnVtYmVyXHJcbn1cclxuXHJcbmludGVyZmFjZSBHYW1lU3RhdGUge1xyXG4gICAgZ2w6IFdlYkdMMlJlbmRlcmluZ0NvbnRleHRcclxuICAgIHByb2dyYW06IFdlYkdMUHJvZ3JhbVxyXG4gICAgdmFvOiBXZWJHTFZlcnRleEFycmF5T2JqZWN0LFxyXG4gICAgc2Nyb2xsT2Zmc2V0TG9jYXRpb246IFdlYkdMVW5pZm9ybUxvY2F0aW9uLFxyXG4gICAgc2Nyb2xsT2Zmc2V0OiBQb2ludCxcclxuICAgIGtleVN0YXRlOiBSZWNvcmQ8c3RyaW5nLCBib29sZWFuPlxyXG59XHJcblxyXG5mdW5jdGlvbiBpbml0KCkge1xyXG4gICAgY2FudmFzLndpZHRoID0gY2FudmFzLmNsaWVudFdpZHRoXHJcbiAgICBjYW52YXMuaGVpZ2h0ID0gY2FudmFzLmNsaWVudEhlaWdodFxyXG5cclxuICAgIGNsZWFyRXJyb3JNZXNzYWdlcygpXHJcbiAgICBjb25zdCBncyA9IGNyZWF0ZUdhbWVTdGF0ZSgpXHJcblxyXG4gICAgY2FudmFzLmFkZEV2ZW50TGlzdGVuZXIoXCJrZXlkb3duXCIsIChldikgPT4gaGFuZGxlS2V5RG93bihldiwgZ3Mua2V5U3RhdGUpKVxyXG4gICAgY2FudmFzLmFkZEV2ZW50TGlzdGVuZXIoXCJrZXl1cFwiLCAoZXYpID0+IGhhbmRsZUtleVVwKGV2LCBncy5rZXlTdGF0ZSkpXHJcblxyXG4gICAgcmVxdWVzdEFuaW1hdGlvbkZyYW1lKCgpID0+IHtcclxuICAgICAgICB0aWNrKGdzKVxyXG4gICAgfSlcclxufVxyXG5cclxuZnVuY3Rpb24gY3JlYXRlR2FtZVN0YXRlKCk6IEdhbWVTdGF0ZSB7XHJcbiAgICBjb25zdCBnbCA9IGNhbnZhcy5nZXRDb250ZXh0KFwid2ViZ2wyXCIpXHJcbiAgICBpZiAoIWdsKSB7XHJcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiRmFpbGVkIHRvIG5vdCBpbml0aWFsaXplIHdlYmdsIDIuMC4gQ29uZmlybSB0aGF0IHlvdXIgYnJvd3NlciBpcyB1cCB0byBkYXRlIGFuZCBoYXMgc3VwcG9ydC5cIilcclxuICAgIH1cclxuXHJcbiAgICBjbGVhckVycm9yTWVzc2FnZXMoKVxyXG5cclxuICAgIC8vIGNvbXBpbGUgcHJvZ3JhbSwgZ2V0IHVuaWZvcm0gbG9jYXRpb25zXHJcbiAgICBjb25zdCBwcm9ncmFtID0gZ2x1LmNvbXBpbGVQcm9ncmFtKGdsLCB2ZXJ0ZXhTcmMsIGZyYWdtZW50U3JjKVxyXG4gICAgY29uc3Qgc2Nyb2xsT2Zmc2V0TG9jYXRpb24gPSBnbHUuZ2V0VW5pZm9ybUxvY2F0aW9uKGdsLCBwcm9ncmFtLCBcInNjcm9sbF9vZmZzZXRcIilcclxuICAgIFxyXG4gICAgY29uc3QgcG9zaXRpb25CdWZmZXIgPSBnbC5jcmVhdGVCdWZmZXIoKVxyXG4gICAgaWYgKCFwb3NpdGlvbkJ1ZmZlcikge1xyXG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcIkZhaWxlZCB0byBjcmVhdGUgYnVmZmVyXCIpXHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgcG9zaXRpb25zID0gWy0xLCAtMSwgMSwgLTEsIDEsIDEsIC0xLCAxXVxyXG4gICAgZ2wuYmluZEJ1ZmZlcihnbC5BUlJBWV9CVUZGRVIsIHBvc2l0aW9uQnVmZmVyKVxyXG4gICAgZ2wuYnVmZmVyRGF0YShnbC5BUlJBWV9CVUZGRVIsIG5ldyBGbG9hdDMyQXJyYXkocG9zaXRpb25zKSwgZ2wuU1RBVElDX0RSQVcpXHJcblxyXG4gICAgY29uc3QgaW5kZXhCdWZmZXIgPSBnbC5jcmVhdGVCdWZmZXIoKVxyXG4gICAgaWYgKCFpbmRleEJ1ZmZlcikge1xyXG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcIkZhaWxlZCB0byBjcmVhdGUgaW5kZXggYnVmZmVyXCIpXHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgdmFvID0gZ2wuY3JlYXRlVmVydGV4QXJyYXkoKVxyXG4gICAgaWYgKCF2YW8pIHtcclxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJmYWlsZWQgdG8gY3JlYXRlIHZlcnRleCBhcnJheSBvYmplY3RcIilcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBwb3NpdGlvbkF0dHJpYnV0ZUluZGV4ID0gZ2wuZ2V0QXR0cmliTG9jYXRpb24ocHJvZ3JhbSwgXCJpbl9wb3NpdGlvblwiKVxyXG4gICAgaWYgKHBvc2l0aW9uQXR0cmlidXRlSW5kZXggPCAwKSB7XHJcbiAgICAgICAgdGhyb3dFcnJvcihcImluX3Bvc2l0aW9uIGF0dHJpYnV0ZSB3YXMgbm90IGZvdW5kXCIpXHJcbiAgICB9XHJcblxyXG4gICAgZ2wuYmluZFZlcnRleEFycmF5KHZhbylcclxuXHJcbiAgICBjb25zdCBpbmRpY2VzID0gWzAsIDEsIDIsIDAsIDIsIDNdXHJcbiAgICBnbC5iaW5kQnVmZmVyKGdsLkVMRU1FTlRfQVJSQVlfQlVGRkVSLCBpbmRleEJ1ZmZlcilcclxuICAgIGdsLmJ1ZmZlckRhdGEoZ2wuRUxFTUVOVF9BUlJBWV9CVUZGRVIsIG5ldyBVaW50MTZBcnJheShpbmRpY2VzKSwgZ2wuU1RBVElDX0RSQVcpXHJcblxyXG4gICAgZ2wudmVydGV4QXR0cmliUG9pbnRlcihwb3NpdGlvbkF0dHJpYnV0ZUluZGV4LCAyLCBnbC5GTE9BVCwgZmFsc2UsIDAsIDApXHJcbiAgICBnbC5lbmFibGVWZXJ0ZXhBdHRyaWJBcnJheShwb3NpdGlvbkF0dHJpYnV0ZUluZGV4KVxyXG5cclxuICAgIHJldHVybiB7XHJcbiAgICAgICAgZ2w6IGdsLFxyXG4gICAgICAgIHByb2dyYW06IHByb2dyYW0sXHJcbiAgICAgICAgdmFvOiB2YW8sXHJcbiAgICAgICAgc2Nyb2xsT2Zmc2V0TG9jYXRpb246IHNjcm9sbE9mZnNldExvY2F0aW9uLFxyXG4gICAgICAgIHNjcm9sbE9mZnNldDogeyB4OiAwLCB5OiAwIH0sXHJcbiAgICAgICAga2V5U3RhdGU6IHt9XHJcbiAgICB9XHJcbn1cclxuXHJcbmZ1bmN0aW9uIHRpY2soZ3M6IEdhbWVTdGF0ZSkge1xyXG4gICAgcHJvY2Vzc0lucHV0KGdzKVxyXG4gICAgcmVuZGVyRnJhbWUoZ3MpXHJcbiAgICByZXF1ZXN0QW5pbWF0aW9uRnJhbWUoKCkgPT4gdGljayhncykpXHJcbn1cclxuXHJcbmZ1bmN0aW9uIHByb2Nlc3NJbnB1dChnczogR2FtZVN0YXRlKSB7XHJcbiAgICBpZiAoZ3Mua2V5U3RhdGVbXCJ3XCJdKSB7XHJcbiAgICAgICAgZ3Muc2Nyb2xsT2Zmc2V0LnkgKz0gMVxyXG4gICAgfVxyXG5cclxuICAgIGlmIChncy5rZXlTdGF0ZVtcInNcIl0pIHtcclxuICAgICAgICBncy5zY3JvbGxPZmZzZXQueSAtPSAxXHJcbiAgICB9XHJcblxyXG4gICAgaWYgKGdzLmtleVN0YXRlW1wiYVwiXSkge1xyXG4gICAgICAgIGdzLnNjcm9sbE9mZnNldC54IC09IDFcclxuICAgIH1cclxuXHJcbiAgICBpZiAoZ3Mua2V5U3RhdGVbXCJkXCJdKSB7XHJcbiAgICAgICAgZ3Muc2Nyb2xsT2Zmc2V0LnggKz0gMVxyXG4gICAgfVxyXG59XHJcblxyXG5mdW5jdGlvbiByZW5kZXJGcmFtZShnczogR2FtZVN0YXRlKSB7XHJcbiAgICBjb25zdCB7IGdsLCBwcm9ncmFtLCB2YW8gfSA9IGdzXHJcbiAgICBjaGVja1Jlc2l6ZSgpXHJcbiAgICBnbC52aWV3cG9ydCgwLCAwLCBnbC5kcmF3aW5nQnVmZmVyV2lkdGgsIGdsLmRyYXdpbmdCdWZmZXJIZWlnaHQpXHJcbiAgICBnbC5jbGVhckNvbG9yKDAsIDAsIDAsIDEpXHJcbiAgICBnbC5jbGVhcihnbC5DT0xPUl9CVUZGRVJfQklUKVxyXG4gICAgZ2wudXNlUHJvZ3JhbShwcm9ncmFtKVxyXG4gICAgZ2wudW5pZm9ybTJmKGdzLnNjcm9sbE9mZnNldExvY2F0aW9uLCBncy5zY3JvbGxPZmZzZXQueCwgZ3Muc2Nyb2xsT2Zmc2V0LnkpXHJcbiAgICBnbC5iaW5kVmVydGV4QXJyYXkodmFvKVxyXG4gICAgZ2wuZHJhd0VsZW1lbnRzKGdsLlRSSUFOR0xFUywgNiwgZ2wuVU5TSUdORURfU0hPUlQsIDApXHJcbn1cclxuXHJcbmZ1bmN0aW9uIGNoZWNrUmVzaXplKCkge1xyXG4gICAgaWYgKGNhbnZhcy53aWR0aCA9PSBjYW52YXMuY2xpZW50V2lkdGggJiYgY2FudmFzLmhlaWdodCA9PSBjYW52YXMuY2xpZW50SGVpZ2h0KSB7XHJcbiAgICAgICAgcmV0dXJuXHJcbiAgICB9XHJcblxyXG4gICAgY2FudmFzLndpZHRoID0gY2FudmFzLmNsaWVudFdpZHRoXHJcbiAgICBjYW52YXMuaGVpZ2h0ID0gY2FudmFzLmNsaWVudEhlaWdodFxyXG59XHJcblxyXG5mdW5jdGlvbiBjbGVhckVycm9yTWVzc2FnZXMoKSB7XHJcbiAgICBjYW52YXMuaGlkZGVuID0gZmFsc2VcclxuICAgIGRvbS5yZW1vdmVBbGxDaGlsZHJlbihlcnJvcnNEaXYpXHJcbn1cclxuXHJcbmZ1bmN0aW9uIGFwcGVuZEVycm9yTWVzc2FnZShlcnJvcjogc3RyaW5nKSB7XHJcbiAgICBjb25zb2xlLmxvZyhlcnJvcilcclxuICAgIGNvbnN0IGRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJkaXZcIik7XHJcbiAgICBkaXYuY2xhc3NMaXN0LmFkZChcImVycm9yLW1lc3NhZ2VcIilcclxuICAgIGRpdi50ZXh0Q29udGVudCA9IGVycm9yXHJcbiAgICBlcnJvcnNEaXYuYXBwZW5kQ2hpbGQoZGl2KVxyXG4gICAgY2FudmFzLmhpZGRlbiA9IHRydWVcclxufVxyXG5cclxuZnVuY3Rpb24gdGhyb3dFcnJvcihtZXNzYWdlOiBzdHJpbmcpIHtcclxuICAgIGFwcGVuZEVycm9yTWVzc2FnZShtZXNzYWdlKVxyXG4gICAgdGhyb3cgbmV3IEVycm9yKG1lc3NhZ2UpXHJcbn1cclxuXHJcbmZ1bmN0aW9uIGhhbmRsZUtleURvd24oZXY6IEtleWJvYXJkRXZlbnQsIGtleVN0YXRlOiBSZWNvcmQ8c3RyaW5nLCBib29sZWFuPikge1xyXG4gICAga2V5U3RhdGVbZXYua2V5XSA9IHRydWVcclxufVxyXG5cclxuZnVuY3Rpb24gaGFuZGxlS2V5VXAoZXY6IEtleWJvYXJkRXZlbnQsIGtleVN0YXRlOiBSZWNvcmQ8c3RyaW5nLCBib29sZWFuPikge1xyXG4gICAga2V5U3RhdGVbZXYua2V5XSA9IGZhbHNlXHJcbn0iXX0=