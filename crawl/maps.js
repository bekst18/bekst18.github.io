import * as geo from "../shared/geo2d.js";
import * as array from "../shared/array.js";
import * as rl from "./rl.js";
import * as grid from "../shared/grid.js";
/**
 * a layer that is based on a set
 * works well for sparse layers
 */
export class SetLayer {
    constructor() {
        this.set = new Set();
    }
    add(item) {
        if (!item.position) {
            throw new Error("Item cannot be placed in layer without a position");
        }
        this.set.add(item);
    }
    delete(item) {
        this.set.delete(item);
    }
    has(item) {
        return this.set.has(item);
    }
    at(position) {
        var _a;
        for (const value of this.set) {
            if ((_a = value.position) === null || _a === void 0 ? void 0 : _a.equal(position)) {
                return value;
            }
        }
        return null;
    }
    *[Symbol.iterator]() {
        for (const value of this.set) {
            yield value;
        }
    }
}
/**
 * a layer that is based on a grid
 * works well for dense layers
 */
export class GridLayer {
    constructor(width, height) {
        this.set = new Set();
        this.grd = grid.generate(width, height, () => null);
    }
    get width() {
        return this.grd.width;
    }
    get height() {
        return this.grd.height;
    }
    add(item) {
        if (!item.position) {
            throw new Error("Item cannot be placed in layer without a position");
        }
        this.grd.setPoint(item.position, item);
        this.set.add(item);
    }
    delete(item) {
        if (!item.position) {
            throw new Error("Item cannot be deleted from layer without a position");
        }
        this.grd.setPoint(item.position, null);
        this.set.delete(item);
    }
    has(item) {
        return this.set.has(item);
    }
    at(position) {
        return this.grd.atPoint(position);
    }
    *[Symbol.iterator]() {
        for (const value of this.set) {
            yield value;
        }
    }
}
/**
 * components of a generated map area
 */
export class Map {
    constructor(width, height, player) {
        this.width = width;
        this.height = height;
        this.player = player;
        this.tiles = new GridLayer(width, height);
        this.fixtures = new SetLayer();
        this.monsters = new SetLayer();
        this.containers = new SetLayer();
    }
    /**
      * iterate over all things in map
    */
    *[Symbol.iterator]() {
        for (const tile of this.tiles) {
            yield tile;
        }
        for (const fixture of this.fixtures) {
            yield fixture;
        }
        for (const container of this.containers) {
            yield container;
        }
        for (const monster of this.monsters) {
            yield monster;
        }
        yield this.player;
    }
    tileAt(xy) {
        return this.tiles.at(xy);
    }
    fixtureAt(xy) {
        return this.fixtures.at(xy);
    }
    containerAt(xy) {
        return this.containers.at(xy);
    }
    monsterAt(xy) {
        return this.monsters.at(xy);
    }
    *at(xy) {
        const fixture = this.fixtureAt(xy);
        if (fixture) {
            yield fixture;
        }
        const tile = this.tileAt(xy);
        if (tile) {
            yield tile;
        }
        const container = this.containerAt(xy);
        if (container) {
            yield container;
        }
        const monster = this.monsterAt(xy);
        if (monster) {
            yield monster;
        }
    }
    inBounds(xy) {
        return xy.x >= 0 && xy.x < this.width && xy.y >= 0 && xy.y < this.height;
    }
}
function resetVisibility(map) {
    for (const th of map) {
        if (th.visible === rl.Visibility.Visible) {
            th.visible = rl.Visibility.Fog;
        }
    }
    for (const monster of map.monsters) {
        monster.visible = rl.Visibility.None;
    }
    map.player.visible = rl.Visibility.Visible;
}
export function updateVisibility(map, eye, radius) {
    resetVisibility(map);
    for (let i = 0; i < 8; ++i) {
        updateVisibilityOctant(map, eye, radius, i);
    }
}
function updateVisibilityOctant(map, eye, radius, octant) {
    const shadows = [];
    for (let y = 1; y <= radius; ++y) {
        for (let x = 0; x <= y; ++x) {
            const octantPoint = new geo.Point(x, y);
            const mapPoint = transformOctant(octantPoint, octant).addPoint(eye);
            if (!map.inBounds(mapPoint)) {
                continue;
            }
            if (isShadowed(shadows, octantPoint)) {
                continue;
            }
            const opaque = array.any(map.at(mapPoint), th => !th.transparent);
            if (opaque) {
                shadows.push(octantPoint);
            }
            if (geo.calcManhattenDist(mapPoint, eye) > radius) {
                continue;
            }
            for (const th of map.at(mapPoint)) {
                th.visible = rl.Visibility.Visible;
            }
        }
    }
}
function transformOctant(coords, octant) {
    switch (octant) {
        case 0: return new geo.Point(-coords.x, coords.y);
        case 1: return new geo.Point(-coords.y, coords.x);
        case 2: return new geo.Point(coords.y, coords.x);
        case 3: return new geo.Point(coords.x, coords.y);
        case 4: return new geo.Point(coords.x, -coords.y);
        case 5: return new geo.Point(coords.y, -coords.x);
        case 6: return new geo.Point(-coords.y, -coords.x);
        case 7: return new geo.Point(-coords.x, -coords.y);
    }
    throw new Error("Invalid octant - must be in interval [0, 8)");
}
function isShadowed(shadows, coords) {
    return array.any(shadows, x => shadowCoversPoint(x, coords));
}
function shadowCoversPoint(shadow, coords) {
    if (shadow.x == 0) {
        return coords.y > shadow.y;
    }
    const startX = shadow.x / (shadow.y + 1) * coords.y;
    const endX = (shadow.x + 1) / shadow.y * coords.y;
    return coords.y > shadow.y && coords.x > startX && coords.x < endX;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFwcy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIm1hcHMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxLQUFLLEdBQUcsTUFBTSxvQkFBb0IsQ0FBQTtBQUN6QyxPQUFPLEtBQUssS0FBSyxNQUFNLG9CQUFvQixDQUFBO0FBQzNDLE9BQU8sS0FBSyxFQUFFLE1BQU0sU0FBUyxDQUFBO0FBQzdCLE9BQU8sS0FBSyxJQUFJLE1BQU0sbUJBQW1CLENBQUE7QUFjekM7OztHQUdHO0FBQ0gsTUFBTSxPQUFPLFFBQVE7SUFBckI7UUFDcUIsUUFBRyxHQUFHLElBQUksR0FBRyxFQUFLLENBQUE7SUFpQ3ZDLENBQUM7SUEvQkcsR0FBRyxDQUFDLElBQU87UUFDUCxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRTtZQUNoQixNQUFNLElBQUksS0FBSyxDQUFDLG1EQUFtRCxDQUFDLENBQUE7U0FDdkU7UUFFRCxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQTtJQUN0QixDQUFDO0lBRUQsTUFBTSxDQUFDLElBQU87UUFDVixJQUFJLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQTtJQUN6QixDQUFDO0lBRUQsR0FBRyxDQUFDLElBQU87UUFDUCxPQUFPLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFBO0lBQzdCLENBQUM7SUFFRCxFQUFFLENBQUMsUUFBbUI7O1FBQ2xCLEtBQUssTUFBTSxLQUFLLElBQUksSUFBSSxDQUFDLEdBQUcsRUFBRTtZQUMxQixVQUFJLEtBQUssQ0FBQyxRQUFRLDBDQUFFLEtBQUssQ0FBQyxRQUFRLEdBQUc7Z0JBQ2pDLE9BQU8sS0FBSyxDQUFBO2FBQ2Y7U0FDSjtRQUVELE9BQU8sSUFBSSxDQUFBO0lBQ2YsQ0FBQztJQUVELENBQUMsQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDO1FBQ2QsS0FBSyxNQUFNLEtBQUssSUFB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QUFJLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxFQUFFLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUNsRCxLQUFLLENBQUMsQ0FBQyxDQUFDLE9BQU8sSUFBSSxHQUFHLENBQUMsS0FBSyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsRUFBRSxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDbEQsS0FBSyxDQUFDLENBQUMsQ0FBQyxPQUFPLElBQUksR0FBRyxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQyxFQUFFLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUNqRCxLQUFLLENBQUMsQ0FBQyxDQUFDLE9BQU8sSUFBSSxHQUFHLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDLEVBQUUsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ2pELEtBQUssQ0FBQyxDQUFDLENBQUMsT0FBTyxJQUFJLEdBQUcsQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUMsRUFBRSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUNsRCxLQUFLLENBQUMsQ0FBQyxDQUFDLE9BQU8sSUFBSSxHQUFHLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDLEVBQUUsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDbEQsS0FBSyxDQUFDLENBQUMsQ0FBQyxPQUFPLElBQUksR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLEVBQUUsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDbkQsS0FBSyxDQUFDLENBQUMsQ0FBQyxPQUFPLElBQUksR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLEVBQUUsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUM7S0FDdEQ7SUFFRCxNQUFNLElBQUksS0FBSyxDQUFDLDZDQUE2QyxDQUFDLENBQUE7QUFDbEUsQ0FBQztBQUVELFNBQVMsVUFBVSxDQUFDLE9BQW9CLEVBQUUsTUFBaUI7SUFDdkQsT0FBTyxLQUFLLENBQUMsR0FBRyxDQUFDLE9BQU8sRUFBRSxDQUFDLENBQUMsRUFBRSxDQUFDLGlCQUFpQixDQUFDLENBQUMsRUFBRSxNQUFNLENBQUMsQ0FBQyxDQUFBO0FBQ2hFLENBQUM7QUFFRCxTQUFTLGlCQUFpQixDQUFDLE1BQWlCLEVBQUUsTUFBaUI7SUFDM0QsSUFBSSxNQUFNLENBQUMsQ0FBQyxJQUFJLENBQUMsRUFBRTtRQUNmLE9BQU8sTUFBTSxDQUFDLENBQUMsR0FBRyxNQUFNLENBQUMsQ0FBQyxDQUFBO0tBQzdCO0lBRUQsTUFBTSxNQUFNLEdBQUcsTUFBTSxDQUFDLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQUcsTUFBTSxDQUFDLENBQUMsQ0FBQTtJQUNuRCxNQUFNLElBQUksR0FBRyxDQUFDLE1BQU0sQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQUcsTUFBTSxDQUFDLENBQUMsR0FBRyxNQUFNLENBQUMsQ0FBQyxDQUFBO0lBRWpELE9BQU8sTUFBTSxDQUFDLENBQUMsR0FBRyxNQUFNLENBQUMsQ0FBQyxJQUFJLE1BQU0sQ0FBQyxDQUFDLEdBQUcsTUFBTSxJQUFJLE1BQU0sQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFBO0FBQ3RFLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBnZW8gZnJvbSBcIi4uL3NoYXJlZC9nZW8yZC5qc1wiXHJcbmltcG9ydCAqIGFzIGFycmF5IGZyb20gXCIuLi9zaGFyZWQvYXJyYXkuanNcIlxyXG5pbXBvcnQgKiBhcyBybCBmcm9tIFwiLi9ybC5qc1wiXHJcbmltcG9ydCAqIGFzIGdyaWQgZnJvbSBcIi4uL3NoYXJlZC9ncmlkLmpzXCJcclxuaW1wb3J0ICogYXMgZ2Z4IGZyb20gXCIuL2dmeC5qc1wiXHJcblxyXG4vKipcclxuICogYSBsYXllciBvZiB0aGluZ3Mgb24gYSBtYXBcclxuICovXHJcbmV4cG9ydCBpbnRlcmZhY2UgTGF5ZXI8VCBleHRlbmRzIHJsLlRoaW5nPiB7XHJcbiAgICBhZGQoaXRlbTogVCk6IHZvaWRcclxuICAgIGRlbGV0ZShpdGVtOiBUKTogdm9pZFxyXG4gICAgaGFzKGl0ZW06IFQpOiBib29sZWFuXHJcbiAgICBhdChwb3NpdGlvbjogZ2VvLlBvaW50KTogVCB8IG51bGxcclxuICAgIFtTeW1ib2wuaXRlcmF0b3JdKCk6IEdlbmVyYXRvcjxUPlxyXG59XHJcblxyXG4vKipcclxuICogYSBsYXllciB0aGF0IGlzIGJhc2VkIG9uIGEgc2V0XHJcbiAqIHdvcmtzIHdlbGwgZm9yIHNwYXJzZSBsYXllcnNcclxuICovXHJcbmV4cG9ydCBjbGFzcyBTZXRMYXllcjxUIGV4dGVuZHMgcmwuVGhpbmc+IGltcGxlbWVudHMgTGF5ZXI8VD4ge1xyXG4gICAgcHJpdmF0ZSByZWFkb25seSBzZXQgPSBuZXcgU2V0PFQ+KClcclxuXHJcbiAgICBhZGQoaXRlbTogVCk6IHZvaWQge1xyXG4gICAgICAgIGlmICghaXRlbS5wb3NpdGlvbikge1xyXG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJJdGVtIGNhbm5vdCBiZSBwbGFjZWQgaW4gbGF5ZXIgd2l0aG91dCBhIHBvc2l0aW9uXCIpXHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB0aGlzLnNldC5hZGQoaXRlbSlcclxuICAgIH1cclxuXHJcbiAgICBkZWxldGUoaXRlbTogVCk6IHZvaWQge1xyXG4gICAgICAgIHRoaXMuc2V0LmRlbGV0ZShpdGVtKVxyXG4gICAgfVxyXG5cclxuICAgIGhhcyhpdGVtOiBUKTogYm9vbGVhbiB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuc2V0LmhhcyhpdGVtKVxyXG4gICAgfVxyXG5cclxuICAgIGF0KHBvc2l0aW9uOiBnZW8uUG9pbnQpOiBUIHwgbnVsbCB7XHJcbiAgICAgICAgZm9yIChjb25zdCB2YWx1ZSBvZiB0aGlzLnNldCkge1xyXG4gICAgICAgICAgICBpZiAodmFsdWUucG9zaXRpb24/LmVxdWFsKHBvc2l0aW9uKSkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiBudWxsXHJcbiAgICB9XHJcblxyXG4gICAgKltTeW1ib2wuaXRlcmF0b3JdKCk6IEdlbmVyYXRvcjxUPiB7XHJcbiAgICAgICAgZm9yIChjb25zdCB2YWx1ZSBvZiB0aGlzLnNldCkge1xyXG4gICAgICAgICAgICB5aWVsZCB2YWx1ZVxyXG4gICAgICAgIH1cclxuICAgIH1cclxufVxyXG5cclxuXHJcbi8qKlxyXG4gKiBhIGxheWVyIHRoYXQgaXMgYmFzZWQgb24gYSBncmlkXHJcbiAqIHdvcmtzIHdlbGwgZm9yIGRlbnNlIGxheWVyc1xyXG4gKi9cclxuZXhwb3J0IGNsYXNzIEdyaWRMYXllcjxUIGV4dGVuZHMgcmwuVGhpbmc+IGltcGxlbWVudHMgTGF5ZXI8VD4ge1xyXG4gICAgcHJpdmF0ZSByZWFkb25seSBzZXQgPSBuZXcgU2V0PFQ+KClcclxuICAgIHByaXZhdGUgcmVhZG9ubHkgZ3JkOiBncmlkLkdyaWQ8VCB8IG51bGw+XHJcblxyXG4gICAgY29uc3RydWN0b3Iod2lkdGg6IG51bWJlciwgaGVpZ2h0OiBudW1iZXIpIHtcclxuICAgICAgICB0aGlzLmdyZCA9IGdyaWQuZ2VuZXJhdGUod2lkdGgsIGhlaWdodCwgKCkgPT4gbnVsbClcclxuICAgIH1cclxuXHJcbiAgICBnZXQgd2lkdGgoKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuZ3JkLndpZHRoXHJcbiAgICB9XHJcblxyXG4gICAgZ2V0IGhlaWdodCgpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5ncmQuaGVpZ2h0XHJcbiAgICB9XHJcblxyXG4gICAgYWRkKGl0ZW06IFQpOiB2b2lkIHtcclxuICAgICAgICBpZiAoIWl0ZW0ucG9zaXRpb24pIHtcclxuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiSXRlbSBjYW5ub3QgYmUgcGxhY2VkIGluIGxheWVyIHdpdGhvdXQgYSBwb3NpdGlvblwiKVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgdGhpcy5ncmQuc2V0UG9pbnQoaXRlbS5wb3NpdGlvbiwgaXRlbSlcclxuICAgICAgICB0aGlzLnNldC5hZGQoaXRlbSlcclxuICAgIH1cclxuXHJcbiAgICBkZWxldGUoaXRlbTogVCk6IHZvaWQge1xyXG4gICAgICAgIGlmICghaXRlbS5wb3NpdGlvbikge1xyXG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJJdGVtIGNhbm5vdCBiZSBkZWxldGVkIGZyb20gbGF5ZXIgd2l0aG91dCBhIHBvc2l0aW9uXCIpXHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB0aGlzLmdyZC5zZXRQb2ludChpdGVtLnBvc2l0aW9uLCBudWxsKVxyXG4gICAgICAgIHRoaXMuc2V0LmRlbGV0ZShpdGVtKVxyXG4gICAgfVxyXG5cclxuICAgIGhhcyhpdGVtOiBUKTogYm9vbGVhbiB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuc2V0LmhhcyhpdGVtKVxyXG4gICAgfVxyXG5cclxuICAgIGF0KHBvc2l0aW9uOiBnZW8uUG9pbnQpOiBUIHwgbnVsbCB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuZ3JkLmF0UG9pbnQocG9zaXRpb24pXHJcbiAgICB9XHJcblxyXG4gICAgKltTeW1ib2wuaXRlcmF0b3JdKCk6IEdlbmVyYXRvcjxUPiB7XHJcbiAgICAgICAgZm9yIChjb25zdCB2YWx1ZSBvZiB0aGlzLnNldCkge1xyXG4gICAgICAgICAgICB5aWVsZCB2YWx1ZVxyXG4gICAgICAgIH1cclxuICAgIH1cclxufVxyXG5cclxuLyoqXHJcbiAqIGNvbXBvbmVudHMgb2YgYSBnZW5lcmF0ZWQgbWFwIGFyZWFcclxuICovXHJcbmV4cG9ydCBjbGFzcyBNYXAge1xyXG4gICAgdGlsZXM6IExheWVyPHJsLlRpbGU+XHJcbiAgICBmaXh0dXJlczogTGF5ZXI8cmwuRml4dHVyZT5cclxuICAgIG1vbnN0ZXJzOiBMYXllcjxybC5Nb25zdGVyPlxyXG4gICAgY29udGFpbmVyczogTGF5ZXI8cmwuQ29udGFpbmVyPlxyXG5cclxuICAgIGNvbnN0cnVjdG9yKHJlYWRvbmx5IHdpZHRoOiBudW1iZXIsIHJlYWRvbmx5IGhlaWdodDogbnVtYmVyLCByZWFkb25seSBwbGF5ZXI6IHJsLlBsYXllcikge1xyXG4gICAgICAgIHRoaXMudGlsZXMgPSBuZXcgR3JpZExheWVyKHdpZHRoLCBoZWlnaHQpXHJcbiAgICAgICAgdGhpcy5maXh0dXJlcyA9IG5ldyBTZXRMYXllcigpXHJcbiAgICAgICAgdGhpcy5tb25zdGVycyA9IG5ldyBTZXRMYXllcigpXHJcbiAgICAgICAgdGhpcy5jb250YWluZXJzID0gbmV3IFNldExheWVyKClcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAgKiBpdGVyYXRlIG92ZXIgYWxsIHRoaW5ncyBpbiBtYXBcclxuICAgICovXHJcbiAgICBwdWJsaWMgKltTeW1ib2wuaXRlcmF0b3JdKCk6IEdlbmVyYXRvcjxybC5UaGluZz4ge1xyXG4gICAgICAgIGZvciAoY29uc3QgdGlsZSBvZiB0aGlzLnRpbGVzKSB7XHJcbiAgICAgICAgICAgIHlpZWxkIHRpbGVcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGZvciAoY29uc3QgZml4dHVyZSBvZiB0aGlzLmZpeHR1cmVzKSB7XHJcbiAgICAgICAgICAgIHlpZWxkIGZpeHR1cmVcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGZvciAoY29uc3QgY29udGFpbmVyIG9mIHRoaXMuY29udGFpbmVycykge1xyXG4gICAgICAgICAgICB5aWVsZCBjb250YWluZXJcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGZvciAoY29uc3QgbW9uc3RlciBvZiB0aGlzLm1vbnN0ZXJzKSB7XHJcbiAgICAgICAgICAgIHlpZWxkIG1vbnN0ZXJcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHlpZWxkIHRoaXMucGxheWVyXHJcbiAgICB9XHJcblxyXG4gICAgdGlsZUF0KHh5OiBnZW8uUG9pbnQpOiBybC5UaWxlIHwgbnVsbCB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMudGlsZXMuYXQoeHkpXHJcbiAgICB9XHJcblxyXG4gICAgZml4dHVyZUF0KHh5OiBnZW8uUG9pbnQpOiBybC5GaXh0dXJlIHwgbnVsbCB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuZml4dHVyZXMuYXQoeHkpXHJcbiAgICB9XHJcblxyXG4gICAgY29udGFpbmVyQXQoeHk6IGdlby5Qb2ludCk6IHJsLkNvbnRhaW5lciB8IG51bGwge1xyXG4gICAgICAgIHJldHVybiB0aGlzLmNvbnRhaW5lcnMuYXQoeHkpXHJcbiAgICB9XHJcblxyXG4gICAgbW9uc3RlckF0KHh5OiBnZW8uUG9pbnQpOiBybC5Nb25zdGVyIHwgbnVsbCB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMubW9uc3RlcnMuYXQoeHkpXHJcbiAgICB9XHJcblxyXG4gICAgKmF0KHh5OiBnZW8uUG9pbnQpOiBHZW5lcmF0b3I8cmwuTW9uc3RlciB8IHJsLkZpeHR1cmUgfCBybC5UaWxlPiB7XHJcbiAgICAgICAgY29uc3QgZml4dHVyZSA9IHRoaXMuZml4dHVyZUF0KHh5KVxyXG4gICAgICAgIGlmIChmaXh0dXJlKSB7XHJcbiAgICAgICAgICAgIHlpZWxkIGZpeHR1cmVcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGNvbnN0IHRpbGUgPSB0aGlzLnRpbGVBdCh4eSlcclxuICAgICAgICBpZiAodGlsZSkge1xyXG4gICAgICAgICAgICB5aWVsZCB0aWxlXHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBjb25zdCBjb250YWluZXIgPSB0aGlzLmNvbnRhaW5lckF0KHh5KVxyXG4gICAgICAgIGlmIChjb250YWluZXIpIHtcclxuICAgICAgICAgICAgeWllbGQgY29udGFpbmVyXHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBjb25zdCBtb25zdGVyID0gdGhpcy5tb25zdGVyQXQoeHkpXHJcbiAgICAgICAgaWYgKG1vbnN0ZXIpIHtcclxuICAgICAgICAgICAgeWllbGQgbW9uc3RlclxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBpbkJvdW5kcyh4eTogZ2VvLlBvaW50KTogYm9vbGVhbiB7XHJcbiAgICAgICAgcmV0dXJuIHh5LnggPj0gMCAmJiB4eS54IDwgdGhpcy53aWR0aCAmJiB4eS55ID49IDAgJiYgeHkueSA8IHRoaXMuaGVpZ2h0XHJcbiAgICB9XHJcbn1cclxuXHJcbmZ1bmN0aW9uIHJlc2V0VmlzaWJpbGl0eShtYXA6IE1hcCkge1xyXG4gICAgZm9yIChjb25zdCB0aCBvZiBtYXApIHtcclxuICAgICAgICBpZiAodGgudmlzaWJsZSA9PT0gcmwuVmlzaWJpbGl0eS5WaXNpYmxlKSB7XHJcbiAgICAgICAgICAgIHRoLnZpc2libGUgPSBybC5WaXNpYmlsaXR5LkZvZ1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBmb3IgKGNvbnN0IG1vbnN0ZXIgb2YgbWFwLm1vbnN0ZXJzKSB7XHJcbiAgICAgICAgbW9uc3Rlci52aXNpYmxlID0gcmwuVmlzaWJpbGl0eS5Ob25lXHJcbiAgICB9XHJcblxyXG4gICAgbWFwLnBsYXllci52aXNpYmxlID0gcmwuVmlzaWJpbGl0eS5WaXNpYmxlXHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiB1cGRhdGVWaXNpYmlsaXR5KG1hcDogTWFwLCBleWU6IGdlby5Qb2ludCwgcmFkaXVzOiBudW1iZXIpIHtcclxuICAgIHJlc2V0VmlzaWJpbGl0eShtYXApXHJcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IDg7ICsraSkge1xyXG4gICAgICAgIHVwZGF0ZVZpc2liaWxpdHlPY3RhbnQobWFwLCBleWUsIHJhZGl1cywgaSlcclxuICAgIH1cclxufVxyXG5cclxuZnVuY3Rpb24gdXBkYXRlVmlzaWJpbGl0eU9jdGFudChtYXA6IE1hcCwgZXllOiBnZW8uUG9pbnQsIHJhZGl1czogbnVtYmVyLCBvY3RhbnQ6IG51bWJlcikge1xyXG4gICAgY29uc3Qgc2hhZG93czogZ2VvLlBvaW50W10gPSBbXVxyXG5cclxuICAgIGZvciAobGV0IHkgPSAxOyB5IDw9IHJhZGl1czsgKyt5KSB7XHJcbiAgICAgICAgZm9yIChsZXQgeCA9IDA7IHggPD0geTsgKyt4KSB7XHJcbiAgICAgICAgICAgIGNvbnN0IG9jdGFudFBvaW50ID0gbmV3IGdlby5Qb2ludCh4LCB5KVxyXG5cclxuICAgICAgICAgICAgY29uc3QgbWFwUG9pbnQgPSB0cmFuc2Zvcm1PY3RhbnQob2N0YW50UG9pbnQsIG9jdGFudCkuYWRkUG9pbnQoZXllKVxyXG4gICAgICAgICAgICBpZiAoIW1hcC5pbkJvdW5kcyhtYXBQb2ludCkpIHtcclxuICAgICAgICAgICAgICAgIGNvbnRpbnVlXHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGlmIChpc1NoYWRvd2VkKHNoYWRvd3MsIG9jdGFudFBvaW50KSkge1xyXG4gICAgICAgICAgICAgICAgY29udGludWVcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgY29uc3Qgb3BhcXVlID0gYXJyYXkuYW55KG1hcC5hdChtYXBQb2ludCksIHRoID0+ICF0aC50cmFuc3BhcmVudClcclxuICAgICAgICAgICAgaWYgKG9wYXF1ZSkge1xyXG4gICAgICAgICAgICAgICAgc2hhZG93cy5wdXNoKG9jdGFudFBvaW50KVxyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBpZiAoZ2VvLmNhbGNNYW5oYXR0ZW5EaXN0KG1hcFBvaW50LCBleWUpID4gcmFkaXVzKSB7XHJcbiAgICAgICAgICAgICAgICBjb250aW51ZVxyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBmb3IgKGNvbnN0IHRoIG9mIG1hcC5hdChtYXBQb2ludCkpIHtcclxuICAgICAgICAgICAgICAgIHRoLnZpc2libGUgPSBybC5WaXNpYmlsaXR5LlZpc2libGVcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxufVxyXG5cclxuZnVuY3Rpb24gdHJhbnNmb3JtT2N0YW50KGNvb3JkczogZ2VvLlBvaW50LCBvY3RhbnQ6IG51bWJlcik6IGdlby5Qb2ludCB7XHJcbiAgICBzd2l0Y2ggKG9jdGFudCkge1xyXG4gICAgICAgIGNhc2UgMDogcmV0dXJuIG5ldyBnZW8uUG9pbnQoLWNvb3Jkcy54LCBjb29yZHMueSk7XHJcbiAgICAgICAgY2FzZSAxOiByZXR1cm4gbmV3IGdlby5Qb2ludCgtY29vcmRzLnksIGNvb3Jkcy54KTtcclxuICAgICAgICBjYXNlIDI6IHJldHVybiBuZXcgZ2VvLlBvaW50KGNvb3Jkcy55LCBjb29yZHMueCk7XHJcbiAgICAgICAgY2FzZSAzOiByZXR1cm4gbmV3IGdlby5Qb2ludChjb29yZHMueCwgY29vcmRzLnkpO1xyXG4gICAgICAgIGNhc2UgNDogcmV0dXJuIG5ldyBnZW8uUG9pbnQoY29vcmRzLngsIC1jb29yZHMueSk7XHJcbiAgICAgICAgY2FzZSA1OiByZXR1cm4gbmV3IGdlby5Qb2ludChjb29yZHMueSwgLWNvb3Jkcy54KTtcclxuICAgICAgICBjYXNlIDY6IHJldHVybiBuZXcgZ2VvLlBvaW50KC1jb29yZHMueSwgLWNvb3Jkcy54KTtcclxuICAgICAgICBjYXNlIDc6IHJldHVybiBuZXcgZ2VvLlBvaW50KC1jb29yZHMueCwgLWNvb3Jkcy55KTtcclxuICAgIH1cclxuXHJcbiAgICB0aHJvdyBuZXcgRXJyb3IoXCJJbnZhbGlkIG9jdGFudCAtIG11c3QgYmUgaW4gaW50ZXJ2YWwgWzAsIDgpXCIpXHJcbn1cclxuXHJcbmZ1bmN0aW9uIGlzU2hhZG93ZWQoc2hhZG93czogZ2VvLlBvaW50W10sIGNvb3JkczogZ2VvLlBvaW50KTogYm9vbGVhbiB7XHJcbiAgICByZXR1cm4gYXJyYXkuYW55KHNoYWRvd3MsIHggPT4gc2hhZG93Q292ZXJzUG9pbnQoeCwgY29vcmRzKSlcclxufVxyXG5cclxuZnVuY3Rpb24gc2hhZG93Q292ZXJzUG9pbnQoc2hhZG93OiBnZW8uUG9pbnQsIGNvb3JkczogZ2VvLlBvaW50KTogYm9vbGVhbiB7XHJcbiAgICBpZiAoc2hhZG93LnggPT0gMCkge1xyXG4gICAgICAgIHJldHVybiBjb29yZHMueSA+IHNoYWRvdy55XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3Qgc3RhcnRYID0gc2hhZG93LnggLyAoc2hhZG93LnkgKyAxKSAqIGNvb3Jkcy55XHJcbiAgICBjb25zdCBlbmRYID0gKHNoYWRvdy54ICsgMSkgLyBzaGFkb3cueSAqIGNvb3Jkcy55XHJcblxyXG4gICAgcmV0dXJuIGNvb3Jkcy55ID4gc2hhZG93LnkgJiYgY29vcmRzLnggPiBzdGFydFggJiYgY29vcmRzLnggPCBlbmRYXHJcbn0iXX0=