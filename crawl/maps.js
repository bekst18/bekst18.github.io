import * as geo from "../shared/geo2d.js";
import * as iter from "../shared/iter.js";
import * as rl from "./rl.js";
import * as grid from "../shared/grid.js";
/**
 * a layer that is based on a set
 * works well for sparse layers
 */
export class SetLayer {
    constructor() {
        this.set = new Set();
    }
    add(item) {
        this.set.add(item);
    }
    delete(item) {
        this.set.delete(item);
    }
    has(item) {
        return this.set.has(item);
    }
    at(position) {
        var _a;
        for (const value of this.set) {
            if ((_a = value.position) === null || _a === void 0 ? void 0 : _a.equal(position)) {
                return value;
            }
        }
        return null;
    }
    *within(aabb) {
        for (const item of this.set) {
            if (aabb.contains(item.position)) {
                yield item;
            }
        }
    }
    get size() {
        return this.set.size;
    }
    *[Symbol.iterator]() {
        for (const value of this.set) {
            yield value;
        }
    }
}
/**
 * a layer that is based on a grid
 * works well for dense layers
 */
export class GridLayer {
    constructor(width, height) {
        this.set = new Set();
        this.grd = grid.generate(width, height, () => null);
    }
    get width() {
        return this.grd.width;
    }
    get height() {
        return this.grd.height;
    }
    add(item) {
        this.grd.setPoint(item.position, item);
        this.set.add(item);
    }
    delete(item) {
        this.grd.setPoint(item.position, null);
        this.set.delete(item);
    }
    has(item) {
        return this.set.has(item);
    }
    at(position) {
        return this.grd.atPoint(position);
    }
    *within(aabb) {
        for (const [item] of this.grd.scanAABB(aabb)) {
            if (item) {
                yield item;
            }
        }
    }
    get size() {
        return this.set.size;
    }
    *[Symbol.iterator]() {
        for (const value of this.set) {
            yield value;
        }
    }
}
export var Lighting;
(function (Lighting) {
    Lighting[Lighting["None"] = 0] = "None";
    Lighting[Lighting["Ambient"] = 1] = "Ambient";
})(Lighting || (Lighting = {}));
/**
 * components of a generated map area
 */
export class Map {
    constructor(width, height, depth, player) {
        this.width = width;
        this.height = height;
        this.depth = depth;
        this.player = player;
        this.lighting = Lighting.None;
        this.tiles = new GridLayer(width, height);
        this.fixtures = new SetLayer();
        this.monsters = new SetLayer();
        this.containers = new SetLayer();
    }
    /**
      * iterate over all things in map
    */
    *[Symbol.iterator]() {
        for (const tile of this.tiles) {
            yield tile;
        }
        for (const fixture of this.fixtures) {
            yield fixture;
        }
        for (const container of this.containers) {
            yield container;
        }
        for (const monster of this.monsters) {
            yield monster;
        }
        yield this.player;
    }
    tileAt(xy) {
        return this.tiles.at(xy);
    }
    fixtureAt(xy) {
        return this.fixtures.at(xy);
    }
    containerAt(xy) {
        return this.containers.at(xy);
    }
    monsterAt(xy) {
        return this.monsters.at(xy);
    }
    *at(xy) {
        const fixture = this.fixtureAt(xy);
        if (fixture) {
            yield fixture;
        }
        const tile = this.tileAt(xy);
        if (tile) {
            yield tile;
        }
        const container = this.containerAt(xy);
        if (container) {
            yield container;
        }
        const monster = this.monsterAt(xy);
        if (monster) {
            yield monster;
        }
        if (this.player.position.equal(xy)) {
            yield this.player;
        }
    }
    inBounds(xy) {
        return xy.x >= 0 && xy.x < this.width && xy.y >= 0 && xy.y < this.height;
    }
    isPassable(position) {
        return this.inBounds(position) && iter.all(this.at(position), th => th.passable);
    }
}
function resetVisibility(map) {
    for (const th of map) {
        if (th.visible === rl.Visibility.Visible) {
            th.visible = rl.Visibility.Fog;
        }
    }
    for (const monster of map.monsters) {
        monster.visible = rl.Visibility.None;
    }
    map.player.visible = rl.Visibility.Visible;
}
export function updateVisibility(map, eye, radius) {
    resetVisibility(map);
    for (let i = 0; i < 8; ++i) {
        updateVisibilityOctant(map, eye, radius, i);
    }
    // eye point always visible
    iter.each(map.at(eye), th => th.visible = rl.Visibility.Visible);
}
function updateVisibilityOctant(map, eye, radius, octant) {
    const shadows = [];
    for (let y = 1; y <= radius; ++y) {
        for (let x = 0; x <= y; ++x) {
            const octantPoint = new geo.Point(x, y);
            const mapPoint = transformOctant(octantPoint, octant).addPoint(eye);
            if (!map.inBounds(mapPoint)) {
                continue;
            }
            if (isShadowed(shadows, octantPoint)) {
                continue;
            }
            const opaque = iter.any(map.at(mapPoint), th => !th.transparent);
            if (opaque) {
                shadows.push(octantPoint);
            }
            if (geo.calcManhattenDist(mapPoint, eye) > radius) {
                continue;
            }
            for (const th of map.at(mapPoint)) {
                th.visible = rl.Visibility.Visible;
            }
        }
    }
}
function transformOctant(coords, octant) {
    switch (octant) {
        case 0: return new geo.Point(-coords.x, coords.y);
        case 1: return new geo.Point(-coords.y, coords.x);
        case 2: return new geo.Point(coords.y, coords.x);
        case 3: return new geo.Point(coords.x, coords.y);
        case 4: return new geo.Point(coords.x, -coords.y);
        case 5: return new geo.Point(coords.y, -coords.x);
        case 6: return new geo.Point(-coords.y, -coords.x);
        case 7: return new geo.Point(-coords.x, -coords.y);
    }
    throw new Error("Invalid octant - must be in interval [0, 8)");
}
function isShadowed(shadows, coords) {
    return iter.any(shadows, x => shadowCoversPoint(x, coords));
}
function shadowCoversPoint(shadow, coords) {
    if (shadow.x == 0) {
        return coords.y > shadow.y;
    }
    const startX = shadow.x / (shadow.y + 1) * coords.y;
    const endX = (shadow.x + 1) / shadow.y * coords.y;
    return coords.y > shadow.y && coords.x > startX && coords.x < endX;
}
/**
 * Find a path from start to goal
 * @param map map
 * @param start start coords
 * @param goal goal coords
 * @returns path from start to goal, including goal, but not starting position
 */
export function findPath(map, start, goal) {
    const open = new Array();
    const closed = new Array();
    open.push({ f: 0, g: 0, h: 0, parent: null, coords: start });
    const popOpen = () => {
        // warning: assumes non-empty!
        let n = 0;
        open.forEach((x, i) => {
            if (x.f < open[n].f) {
                n = i;
            }
        });
        // swap & pop
        const r = open[n];
        if (n < open.length - 1) {
            open[n] = open[open.length - 1];
        }
        open.pop();
        return r;
    };
    const assemblePath = (node) => {
        // path found! backtrack and assemble path
        const path = new Array();
        while (node && !node.coords.equal(start)) {
            path.push(node.coords);
            node = node.parent;
        }
        return path.reverse();
    };
    while (open.length > 0) {
        const cur = popOpen();
        closed.push(cur);
        if (cur.coords.equal(goal)) {
            return assemblePath(cur);
        }
        for (const coords of visitNeighbors(cur.coords, map.width, map.height)) {
            if (!map.isPassable(coords) && !coords.equal(goal)) {
                continue;
            }
            if (closed.find(x => coords.equal(x.coords))) {
                continue;
            }
            const g = cur.g + 1;
            const h = geo.calcManhattenDist(goal, coords);
            const f = g + h;
            // does this node already exist in open list?
            const openNode = open.find(x => coords.equal(x.coords));
            if (openNode != null && openNode.g <= g) {
                continue;
            }
            // place in open list
            open.push({ g: g, h: h, f: f, parent: cur, coords: coords });
        }
    }
    return new Array();
}
function* visitNeighbors(pt, width, height) {
    if (pt.x < 0 || pt.y < 0 || pt.x >= width || pt.y >= height) {
        throw new Error("pt is out of bounds");
    }
    // w
    if (pt.x > 0) {
        const w = new geo.Point(pt.x - 1, pt.y);
        yield w;
    }
    // s
    if (pt.y < height - 1) {
        const s = new geo.Point(pt.x, pt.y + 1);
        yield s;
    }
    // e
    if (pt.x < width - 1) {
        const e = new geo.Point(pt.x + 1, pt.y);
        yield e;
    }
    // n
    if (pt.y > 0) {
        const n = new geo.Point(pt.x, pt.y - 1);
        yield n;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFwcy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIm1hcHMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxLQUFLLEdBQUcsTUFBTSxvQkFBb0IsQ0FBQTtBQUN6QyxPQUFPLEtBQUssSUFBSSxNQUFNLG1CQUFtQixDQUFBO0FBQ3pDLE9BQU8sS0FBSyxFQUFFLE1BQU0sU0FBUyxDQUFBO0FBQzdCLE9BQU8sS0FBSyxJQUFJLE1BQU0sbUJBQW1CLENBQUE7QUFlekM7OztHQUdHO0FBQ0gsTUFBTSxPQUFPLFFBQVE7SUFBckI7UUFDcUIsUUFBRyxHQUFHLElBQUksR0FBRyxFQUFLLENBQUE7SUF5Q3ZDLENBQUM7SUF2Q0csR0FBRyxDQUFDLElBQU87UUFDUCxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQTtJQUN0QixDQUFDO0lBRUQsTUFBTSxDQUFDLElBQU87UUFDVixJQUFJLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQTtJQUN6QixDQUFDO0lBRUQsR0FBRyxDQUFDLElBQU87UUFDUCxPQUFPLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFBO0lBQzdCLENBQUM7SUFFRCxFQUFFLENBQUMsUUFBbUI7O1FBQ2xCLEtBQUssTUFBTSxLQUFLLElBQUksSUFBSSxDQUFDLEdBQUcsRUFBRTtZQUMxQixJQUFJLE1BQUEsS0FBSyxDQUFDLFFBQVEsMENBQUUsS0FBSyxDQUFDLFFBQVEsQ0FBQyxFQUFFO2dCQUNqQyxPQUFPLEtBQUssQ0FBQTthQUNmO1NBQ0o7UUFFRCxPQUFPLElBQUksQ0FBQTtJQUNmLENBQUM7SUFFRCxDQUFDLE1BQU0sQ0FBQyxJQUFjO1FBQ2xCLEtBQUssTUFBTSxJQUFJLElBQUksSUFBSSxDQUFDLEdBQUcsRUFBRTtZQUN6QixJQUFJLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxFQUFFO2dCQUM5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SyxDQUFDLEVBQUUsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQTtRQUN2QyxNQUFNLENBQUMsQ0FBQTtLQUNWO0FBQ0wsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIGdlbyBmcm9tIFwiLi4vc2hhcmVkL2dlbzJkLmpzXCJcclxuaW1wb3J0ICogYXMgaXRlciBmcm9tIFwiLi4vc2hhcmVkL2l0ZXIuanNcIlxyXG5pbXBvcnQgKiBhcyBybCBmcm9tIFwiLi9ybC5qc1wiXHJcbmltcG9ydCAqIGFzIGdyaWQgZnJvbSBcIi4uL3NoYXJlZC9ncmlkLmpzXCJcclxuXHJcbi8qKlxyXG4gKiBhIGxheWVyIG9mIHRoaW5ncyBvbiBhIG1hcFxyXG4gKi9cclxuZXhwb3J0IGludGVyZmFjZSBMYXllcjxUIGV4dGVuZHMgcmwuVGhpbmc+IHtcclxuICAgIGFkZChpdGVtOiBUKTogdm9pZFxyXG4gICAgZGVsZXRlKGl0ZW06IFQpOiB2b2lkXHJcbiAgICBoYXMoaXRlbTogVCk6IGJvb2xlYW5cclxuICAgIGF0KHBvc2l0aW9uOiBnZW8uUG9pbnQpOiBUIHwgbnVsbFxyXG4gICAgd2l0aGluKGFhYmI6IGdlby5BQUJCKTogR2VuZXJhdG9yPFQ+XHJcbiAgICBzaXplOiBudW1iZXJcclxuICAgIFtTeW1ib2wuaXRlcmF0b3JdKCk6IEdlbmVyYXRvcjxUPlxyXG59XHJcblxyXG4vKipcclxuICogYSBsYXllciB0aGF0IGlzIGJhc2VkIG9uIGEgc2V0XHJcbiAqIHdvcmtzIHdlbGwgZm9yIHNwYXJzZSBsYXllcnNcclxuICovXHJcbmV4cG9ydCBjbGFzcyBTZXRMYXllcjxUIGV4dGVuZHMgcmwuVGhpbmc+IGltcGxlbWVudHMgTGF5ZXI8VD4ge1xyXG4gICAgcHJpdmF0ZSByZWFkb25seSBzZXQgPSBuZXcgU2V0PFQ+KClcclxuXHJcbiAgICBhZGQoaXRlbTogVCk6IHZvaWQge1xyXG4gICAgICAgIHRoaXMuc2V0LmFkZChpdGVtKVxyXG4gICAgfVxyXG5cclxuICAgIGRlbGV0ZShpdGVtOiBUKTogdm9pZCB7XHJcbiAgICAgICAgdGhpcy5zZXQuZGVsZXRlKGl0ZW0pXHJcbiAgICB9XHJcblxyXG4gICAgaGFzKGl0ZW06IFQpOiBib29sZWFuIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5zZXQuaGFzKGl0ZW0pXHJcbiAgICB9XHJcblxyXG4gICAgYXQocG9zaXRpb246IGdlby5Qb2ludCk6IFQgfCBudWxsIHtcclxuICAgICAgICBmb3IgKGNvbnN0IHZhbHVlIG9mIHRoaXMuc2V0KSB7XHJcbiAgICAgICAgICAgIGlmICh2YWx1ZS5wb3NpdGlvbj8uZXF1YWwocG9zaXRpb24pKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWVcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIG51bGxcclxuICAgIH1cclxuXHJcbiAgICAqd2l0aGluKGFhYmI6IGdlby5BQUJCKTogR2VuZXJhdG9yPFQ+IHtcclxuICAgICAgICBmb3IgKGNvbnN0IGl0ZW0gb2YgdGhpcy5zZXQpIHtcclxuICAgICAgICAgICAgaWYgKGFhYmIuY29udGFpbnMoaXRlbS5wb3NpdGlvbikpIHtcclxuICAgICAgICAgICAgICAgIHlpZWxkIGl0ZW1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBnZXQgc2l6ZSgpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5zZXQuc2l6ZVxyXG4gICAgfVxyXG5cclxuICAgICpbU3ltYm9sLml0ZXJhdG9yXSgpOiBHZW5lcmF0b3I8VD4ge1xyXG4gICAgICAgIGZvciAoY29uc3QgdmFsdWUgb2YgdGhpcy5zZXQpIHtcclxuICAgICAgICAgICAgeWllbGQgdmFsdWVcclxuICAgICAgICB9XHJcbiAgICB9XHJcbn1cclxuXHJcblxyXG4vKipcclxuICogYSBsYXllciB0aGF0IGlzIGJhc2VkIG9uIGEgZ3JpZFxyXG4gKiB3b3JrcyB3ZWxsIGZvciBkZW5zZSBsYXllcnNcclxuICovXHJcbmV4cG9ydCBjbGFzcyBHcmlkTGF5ZXI8VCBleHRlbmRzIHJsLlRoaW5nPiBpbXBsZW1lbnRzIExheWVyPFQ+IHtcclxuICAgIHByaXZhdGUgcmVhZG9ubHkgc2V0ID0gbmV3IFNldDxUPigpXHJcbiAgICBwcml2YXRlIHJlYWRvbmx5IGdyZDogZ3JpZC5HcmlkPFQgfCBudWxsPlxyXG5cclxuICAgIGNvbnN0cnVjdG9yKHdpZHRoOiBudW1iZXIsIGhlaWdodDogbnVtYmVyKSB7XHJcbiAgICAgICAgdGhpcy5ncmQgPSBncmlkLmdlbmVyYXRlKHdpZHRoLCBoZWlnaHQsICgpID0+IG51bGwpXHJcbiAgICB9XHJcblxyXG4gICAgZ2V0IHdpZHRoKCkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLmdyZC53aWR0aFxyXG4gICAgfVxyXG5cclxuICAgIGdldCBoZWlnaHQoKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuZ3JkLmhlaWdodFxyXG4gICAgfVxyXG5cclxuICAgIGFkZChpdGVtOiBUKTogdm9pZCB7XHJcbiAgICAgICAgdGhpcy5ncmQuc2V0UG9pbnQoaXRlbS5wb3NpdGlvbiwgaXRlbSlcclxuICAgICAgICB0aGlzLnNldC5hZGQoaXRlbSlcclxuICAgIH1cclxuXHJcbiAgICBkZWxldGUoaXRlbTogVCk6IHZvaWQge1xyXG4gICAgICAgIHRoaXMuZ3JkLnNldFBvaW50KGl0ZW0ucG9zaXRpb24sIG51bGwpXHJcbiAgICAgICAgdGhpcy5zZXQuZGVsZXRlKGl0ZW0pXHJcbiAgICB9XHJcblxyXG4gICAgaGFzKGl0ZW06IFQpOiBib29sZWFuIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5zZXQuaGFzKGl0ZW0pXHJcbiAgICB9XHJcblxyXG4gICAgYXQocG9zaXRpb246IGdlby5Qb2ludCk6IFQgfCBudWxsIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5ncmQuYXRQb2ludChwb3NpdGlvbilcclxuICAgIH1cclxuXHJcbiAgICAqd2l0aGluKGFhYmI6IGdlby5BQUJCKTogR2VuZXJhdG9yPFQ+IHtcclxuICAgICAgICBmb3IgKGNvbnN0IFtpdGVtXSBvZiB0aGlzLmdyZC5zY2FuQUFCQihhYWJiKSkge1xyXG4gICAgICAgICAgICBpZiAoaXRlbSkge1xyXG4gICAgICAgICAgICAgICAgeWllbGQgaXRlbVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGdldCBzaXplKCkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLnNldC5zaXplXHJcbiAgICB9XHJcblxyXG4gICAgKltTeW1ib2wuaXRlcmF0b3JdKCk6IEdlbmVyYXRvcjxUPiB7XHJcbiAgICAgICAgZm9yIChjb25zdCB2YWx1ZSBvZiB0aGlzLnNldCkge1xyXG4gICAgICAgICAgICB5aWVsZCB2YWx1ZVxyXG4gICAgICAgIH1cclxuICAgIH1cclxufVxyXG5cclxuZXhwb3J0IGVudW0gTGlnaHRpbmcge1xyXG4gICAgTm9uZSxcclxuICAgIEFtYmllbnQsXHJcbn1cclxuXHJcbi8qKlxyXG4gKiBjb21wb25lbnRzIG9mIGEgZ2VuZXJhdGVkIG1hcCBhcmVhXHJcbiAqL1xyXG5leHBvcnQgY2xhc3MgTWFwIHtcclxuICAgIHRpbGVzOiBMYXllcjxybC5UaWxlPlxyXG4gICAgZml4dHVyZXM6IExheWVyPHJsLkZpeHR1cmU+XHJcbiAgICBtb25zdGVyczogTGF5ZXI8cmwuTW9uc3Rlcj5cclxuICAgIGNvbnRhaW5lcnM6IExheWVyPHJsLkNvbnRhaW5lcj5cclxuICAgIGxpZ2h0aW5nOiBMaWdodGluZyA9IExpZ2h0aW5nLk5vbmVcclxuXHJcbiAgICBjb25zdHJ1Y3RvcihyZWFkb25seSB3aWR0aDogbnVtYmVyLCByZWFkb25seSBoZWlnaHQ6IG51bWJlciwgcmVhZG9ubHkgZGVwdGg6IG51bWJlciwgcmVhZG9ubHkgcGxheWVyOiBybC5QbGF5ZXIpIHtcclxuICAgICAgICB0aGlzLnRpbGVzID0gbmV3IEdyaWRMYXllcih3aWR0aCwgaGVpZ2h0KVxyXG4gICAgICAgIHRoaXMuZml4dHVyZXMgPSBuZXcgU2V0TGF5ZXIoKVxyXG4gICAgICAgIHRoaXMubW9uc3RlcnMgPSBuZXcgU2V0TGF5ZXIoKVxyXG4gICAgICAgIHRoaXMuY29udGFpbmVycyA9IG5ldyBTZXRMYXllcigpXHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgICogaXRlcmF0ZSBvdmVyIGFsbCB0aGluZ3MgaW4gbWFwXHJcbiAgICAqL1xyXG4gICAgcHVibGljICpbU3ltYm9sLml0ZXJhdG9yXSgpOiBHZW5lcmF0b3I8cmwuVGhpbmc+IHtcclxuICAgICAgICBmb3IgKGNvbnN0IHRpbGUgb2YgdGhpcy50aWxlcykge1xyXG4gICAgICAgICAgICB5aWVsZCB0aWxlXHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBmb3IgKGNvbnN0IGZpeHR1cmUgb2YgdGhpcy5maXh0dXJlcykge1xyXG4gICAgICAgICAgICB5aWVsZCBmaXh0dXJlXHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBmb3IgKGNvbnN0IGNvbnRhaW5lciBvZiB0aGlzLmNvbnRhaW5lcnMpIHtcclxuICAgICAgICAgICAgeWllbGQgY29udGFpbmVyXHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBmb3IgKGNvbnN0IG1vbnN0ZXIgb2YgdGhpcy5tb25zdGVycykge1xyXG4gICAgICAgICAgICB5aWVsZCBtb25zdGVyXHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB5aWVsZCB0aGlzLnBsYXllclxyXG4gICAgfVxyXG5cclxuICAgIHRpbGVBdCh4eTogZ2VvLlBvaW50KTogcmwuVGlsZSB8IG51bGwge1xyXG4gICAgICAgIHJldHVybiB0aGlzLnRpbGVzLmF0KHh5KVxyXG4gICAgfVxyXG5cclxuICAgIGZpeHR1cmVBdCh4eTogZ2VvLlBvaW50KTogcmwuRml4dHVyZSB8IG51bGwge1xyXG4gICAgICAgIHJldHVybiB0aGlzLmZpeHR1cmVzLmF0KHh5KVxyXG4gICAgfVxyXG5cclxuICAgIGNvbnRhaW5lckF0KHh5OiBnZW8uUG9pbnQpOiBybC5Db250YWluZXIgfCBudWxsIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5jb250YWluZXJzLmF0KHh5KVxyXG4gICAgfVxyXG5cclxuICAgIG1vbnN0ZXJBdCh4eTogZ2VvLlBvaW50KTogcmwuTW9uc3RlciB8IG51bGwge1xyXG4gICAgICAgIHJldHVybiB0aGlzLm1vbnN0ZXJzLmF0KHh5KVxyXG4gICAgfVxyXG5cclxuICAgICphdCh4eTogZ2VvLlBvaW50KTogR2VuZXJhdG9yPHJsLk1vbnN0ZXIgfCBybC5GaXh0dXJlIHwgcmwuVGlsZT4ge1xyXG4gICAgICAgIGNvbnN0IGZpeHR1cmUgPSB0aGlzLmZpeHR1cmVBdCh4eSlcclxuICAgICAgICBpZiAoZml4dHVyZSkge1xyXG4gICAgICAgICAgICB5aWVsZCBmaXh0dXJlXHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBjb25zdCB0aWxlID0gdGhpcy50aWxlQXQoeHkpXHJcbiAgICAgICAgaWYgKHRpbGUpIHtcclxuICAgICAgICAgICAgeWllbGQgdGlsZVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgY29uc3QgY29udGFpbmVyID0gdGhpcy5jb250YWluZXJBdCh4eSlcclxuICAgICAgICBpZiAoY29udGFpbmVyKSB7XHJcbiAgICAgICAgICAgIHlpZWxkIGNvbnRhaW5lclxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgY29uc3QgbW9uc3RlciA9IHRoaXMubW9uc3RlckF0KHh5KVxyXG4gICAgICAgIGlmIChtb25zdGVyKSB7XHJcbiAgICAgICAgICAgIHlpZWxkIG1vbnN0ZXJcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmICh0aGlzLnBsYXllci5wb3NpdGlvbi5lcXVhbCh4eSkpIHtcclxuICAgICAgICAgICAgeWllbGQgdGhpcy5wbGF5ZXJcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgaW5Cb3VuZHMoeHk6IGdlby5Qb2ludCk6IGJvb2xlYW4ge1xyXG4gICAgICAgIHJldHVybiB4eS54ID49IDAgJiYgeHkueCA8IHRoaXMud2lkdGggJiYgeHkueSA+PSAwICYmIHh5LnkgPCB0aGlzLmhlaWdodFxyXG4gICAgfVxyXG5cclxuICAgIGlzUGFzc2FibGUocG9zaXRpb246IGdlby5Qb2ludCk6IGJvb2xlYW4ge1xyXG4gICAgICAgIHJldHVybiB0aGlzLmluQm91bmRzKHBvc2l0aW9uKSAmJiBpdGVyLmFsbCh0aGlzLmF0KHBvc2l0aW9uKSwgdGggPT4gdGgucGFzc2FibGUpXHJcbiAgICB9XHJcbn1cclxuXHJcbmZ1bmN0aW9uIHJlc2V0VmlzaWJpbGl0eShtYXA6IE1hcCkge1xyXG4gICAgZm9yIChjb25zdCB0aCBvZiBtYXApIHtcclxuICAgICAgICBpZiAodGgudmlzaWJsZSA9PT0gcmwuVmlzaWJpbGl0eS5WaXNpYmxlKSB7XHJcbiAgICAgICAgICAgIHRoLnZpc2libGUgPSBybC5WaXNpYmlsaXR5LkZvZ1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBmb3IgKGNvbnN0IG1vbnN0ZXIgb2YgbWFwLm1vbnN0ZXJzKSB7XHJcbiAgICAgICAgbW9uc3Rlci52aXNpYmxlID0gcmwuVmlzaWJpbGl0eS5Ob25lXHJcbiAgICB9XHJcblxyXG4gICAgbWFwLnBsYXllci52aXNpYmxlID0gcmwuVmlzaWJpbGl0eS5WaXNpYmxlXHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiB1cGRhdGVWaXNpYmlsaXR5KG1hcDogTWFwLCBleWU6IGdlby5Qb2ludCwgcmFkaXVzOiBudW1iZXIpIHtcclxuICAgIHJlc2V0VmlzaWJpbGl0eShtYXApXHJcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IDg7ICsraSkge1xyXG4gICAgICAgIHVwZGF0ZVZpc2liaWxpdHlPY3RhbnQobWFwLCBleWUsIHJhZGl1cywgaSlcclxuICAgIH1cclxuXHJcbiAgICAvLyBleWUgcG9pbnQgYWx3YXlzIHZpc2libGVcclxuICAgIGl0ZXIuZWFjaChtYXAuYXQoZXllKSwgdGggPT4gdGgudmlzaWJsZSA9IHJsLlZpc2liaWxpdHkuVmlzaWJsZSlcclxufVxyXG5cclxuZnVuY3Rpb24gdXBkYXRlVmlzaWJpbGl0eU9jdGFudChtYXA6IE1hcCwgZXllOiBnZW8uUG9pbnQsIHJhZGl1czogbnVtYmVyLCBvY3RhbnQ6IG51bWJlcikge1xyXG4gICAgY29uc3Qgc2hhZG93czogZ2VvLlBvaW50W10gPSBbXVxyXG5cclxuICAgIGZvciAobGV0IHkgPSAxOyB5IDw9IHJhZGl1czsgKyt5KSB7XHJcbiAgICAgICAgZm9yIChsZXQgeCA9IDA7IHggPD0geTsgKyt4KSB7XHJcbiAgICAgICAgICAgIGNvbnN0IG9jdGFudFBvaW50ID0gbmV3IGdlby5Qb2ludCh4LCB5KVxyXG5cclxuICAgICAgICAgICAgY29uc3QgbWFwUG9pbnQgPSB0cmFuc2Zvcm1PY3RhbnQob2N0YW50UG9pbnQsIG9jdGFudCkuYWRkUG9pbnQoZXllKVxyXG4gICAgICAgICAgICBpZiAoIW1hcC5pbkJvdW5kcyhtYXBQb2ludCkpIHtcclxuICAgICAgICAgICAgICAgIGNvbnRpbnVlXHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGlmIChpc1NoYWRvd2VkKHNoYWRvd3MsIG9jdGFudFBvaW50KSkge1xyXG4gICAgICAgICAgICAgICAgY29udGludWVcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgY29uc3Qgb3BhcXVlID0gaXRlci5hbnkobWFwLmF0KG1hcFBvaW50KSwgdGggPT4gIXRoLnRyYW5zcGFyZW50KVxyXG4gICAgICAgICAgICBpZiAob3BhcXVlKSB7XHJcbiAgICAgICAgICAgICAgICBzaGFkb3dzLnB1c2gob2N0YW50UG9pbnQpXHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGlmIChnZW8uY2FsY01hbmhhdHRlbkRpc3QobWFwUG9pbnQsIGV5ZSkgPiByYWRpdXMpIHtcclxuICAgICAgICAgICAgICAgIGNvbnRpbnVlXHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGZvciAoY29uc3QgdGggb2YgbWFwLmF0KG1hcFBvaW50KSkge1xyXG4gICAgICAgICAgICAgICAgdGgudmlzaWJsZSA9IHJsLlZpc2liaWxpdHkuVmlzaWJsZVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG59XHJcblxyXG5mdW5jdGlvbiB0cmFuc2Zvcm1PY3RhbnQoY29vcmRzOiBnZW8uUG9pbnQsIG9jdGFudDogbnVtYmVyKTogZ2VvLlBvaW50IHtcclxuICAgIHN3aXRjaCAob2N0YW50KSB7XHJcbiAgICAgICAgY2FzZSAwOiByZXR1cm4gbmV3IGdlby5Qb2ludCgtY29vcmRzLngsIGNvb3Jkcy55KTtcclxuICAgICAgICBjYXNlIDE6IHJldHVybiBuZXcgZ2VvLlBvaW50KC1jb29yZHMueSwgY29vcmRzLngpO1xyXG4gICAgICAgIGNhc2UgMjogcmV0dXJuIG5ldyBnZW8uUG9pbnQoY29vcmRzLnksIGNvb3Jkcy54KTtcclxuICAgICAgICBjYXNlIDM6IHJldHVybiBuZXcgZ2VvLlBvaW50KGNvb3Jkcy54LCBjb29yZHMueSk7XHJcbiAgICAgICAgY2FzZSA0OiByZXR1cm4gbmV3IGdlby5Qb2ludChjb29yZHMueCwgLWNvb3Jkcy55KTtcclxuICAgICAgICBjYXNlIDU6IHJldHVybiBuZXcgZ2VvLlBvaW50KGNvb3Jkcy55LCAtY29vcmRzLngpO1xyXG4gICAgICAgIGNhc2UgNjogcmV0dXJuIG5ldyBnZW8uUG9pbnQoLWNvb3Jkcy55LCAtY29vcmRzLngpO1xyXG4gICAgICAgIGNhc2UgNzogcmV0dXJuIG5ldyBnZW8uUG9pbnQoLWNvb3Jkcy54LCAtY29vcmRzLnkpO1xyXG4gICAgfVxyXG5cclxuICAgIHRocm93IG5ldyBFcnJvcihcIkludmFsaWQgb2N0YW50IC0gbXVzdCBiZSBpbiBpbnRlcnZhbCBbMCwgOClcIilcclxufVxyXG5cclxuZnVuY3Rpb24gaXNTaGFkb3dlZChzaGFkb3dzOiBnZW8uUG9pbnRbXSwgY29vcmRzOiBnZW8uUG9pbnQpOiBib29sZWFuIHtcclxuICAgIHJldHVybiBpdGVyLmFueShzaGFkb3dzLCB4ID0+IHNoYWRvd0NvdmVyc1BvaW50KHgsIGNvb3JkcykpXHJcbn1cclxuXHJcbmZ1bmN0aW9uIHNoYWRvd0NvdmVyc1BvaW50KHNoYWRvdzogZ2VvLlBvaW50LCBjb29yZHM6IGdlby5Qb2ludCk6IGJvb2xlYW4ge1xyXG4gICAgaWYgKHNoYWRvdy54ID09IDApIHtcclxuICAgICAgICByZXR1cm4gY29vcmRzLnkgPiBzaGFkb3cueVxyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IHN0YXJ0WCA9IHNoYWRvdy54IC8gKHNoYWRvdy55ICsgMSkgKiBjb29yZHMueVxyXG4gICAgY29uc3QgZW5kWCA9IChzaGFkb3cueCArIDEpIC8gc2hhZG93LnkgKiBjb29yZHMueVxyXG5cclxuICAgIHJldHVybiBjb29yZHMueSA+IHNoYWRvdy55ICYmIGNvb3Jkcy54ID4gc3RhcnRYICYmIGNvb3Jkcy54IDwgZW5kWFxyXG59XHJcblxyXG5cclxuLyoqXHJcbiAqIEZpbmQgYSBwYXRoIGZyb20gc3RhcnQgdG8gZ29hbFxyXG4gKiBAcGFyYW0gbWFwIG1hcFxyXG4gKiBAcGFyYW0gc3RhcnQgc3RhcnQgY29vcmRzXHJcbiAqIEBwYXJhbSBnb2FsIGdvYWwgY29vcmRzXHJcbiAqIEByZXR1cm5zIHBhdGggZnJvbSBzdGFydCB0byBnb2FsLCBpbmNsdWRpbmcgZ29hbCwgYnV0IG5vdCBzdGFydGluZyBwb3NpdGlvblxyXG4gKi9cclxuZXhwb3J0IGZ1bmN0aW9uIGZpbmRQYXRoKG1hcDogTWFwLCBzdGFydDogZ2VvLlBvaW50LCBnb2FsOiBnZW8uUG9pbnQpOiBBcnJheTxnZW8uUG9pbnQ+IHtcclxuICAgIGludGVyZmFjZSBOb2RlIHtcclxuICAgICAgICBmOiBudW1iZXJcclxuICAgICAgICBnOiBudW1iZXJcclxuICAgICAgICBoOiBudW1iZXJcclxuICAgICAgICBwYXJlbnQ6IE5vZGUgfCBudWxsXHJcbiAgICAgICAgY29vcmRzOiBnZW8uUG9pbnRcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBvcGVuID0gbmV3IEFycmF5PE5vZGU+KClcclxuICAgIGNvbnN0IGNsb3NlZCA9IG5ldyBBcnJheTxOb2RlPigpXHJcblxyXG4gICAgb3Blbi5wdXNoKHsgZjogMCwgZzogMCwgaDogMCwgcGFyZW50OiBudWxsLCBjb29yZHM6IHN0YXJ0IH0pXHJcblxyXG4gICAgY29uc3QgcG9wT3BlbiA9ICgpID0+IHtcclxuICAgICAgICAvLyB3YXJuaW5nOiBhc3N1bWVzIG5vbi1lbXB0eSFcclxuICAgICAgICBsZXQgbiA9IDBcclxuICAgICAgICBvcGVuLmZvckVhY2goKHgsIGkpID0+IHtcclxuICAgICAgICAgICAgaWYgKHguZiA8IG9wZW5bbl0uZikge1xyXG4gICAgICAgICAgICAgICAgbiA9IGlcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pXHJcblxyXG4gICAgICAgIC8vIHN3YXAgJiBwb3BcclxuICAgICAgICBjb25zdCByID0gb3BlbltuXVxyXG5cclxuICAgICAgICBpZiAobiA8IG9wZW4ubGVuZ3RoIC0gMSkge1xyXG4gICAgICAgICAgICBvcGVuW25dID0gb3BlbltvcGVuLmxlbmd0aCAtIDFdXHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBvcGVuLnBvcCgpXHJcblxyXG4gICAgICAgIHJldHVybiByXHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgYXNzZW1ibGVQYXRoID0gKG5vZGU6IE5vZGUgfCBudWxsKTogQXJyYXk8Z2VvLlBvaW50PiA9PiB7XHJcbiAgICAgICAgLy8gcGF0aCBmb3VuZCEgYmFja3RyYWNrIGFuZCBhc3NlbWJsZSBwYXRoXHJcbiAgICAgICAgY29uc3QgcGF0aCA9IG5ldyBBcnJheTxnZW8uUG9pbnQ+KClcclxuXHJcbiAgICAgICAgd2hpbGUgKG5vZGUgJiYgIW5vZGUuY29vcmRzLmVxdWFsKHN0YXJ0KSkge1xyXG4gICAgICAgICAgICBwYXRoLnB1c2gobm9kZS5jb29yZHMpXHJcbiAgICAgICAgICAgIG5vZGUgPSBub2RlLnBhcmVudFxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIHBhdGgucmV2ZXJzZSgpXHJcbiAgICB9XHJcblxyXG4gICAgd2hpbGUgKG9wZW4ubGVuZ3RoID4gMCkge1xyXG4gICAgICAgIGNvbnN0IGN1ciA9IHBvcE9wZW4oKVxyXG4gICAgICAgIGNsb3NlZC5wdXNoKGN1cilcclxuXHJcbiAgICAgICAgaWYgKGN1ci5jb29yZHMuZXF1YWwoZ29hbCkpIHtcclxuICAgICAgICAgICAgcmV0dXJuIGFzc2VtYmxlUGF0aChjdXIpXHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBmb3IgKGNvbnN0IGNvb3JkcyBvZiB2aXNpdE5laWdoYm9ycyhjdXIuY29vcmRzLCBtYXAud2lkdGgsIG1hcC5oZWlnaHQpKSB7XHJcbiAgICAgICAgICAgIGlmICghbWFwLmlzUGFzc2FibGUoY29vcmRzKSAmJiAhY29vcmRzLmVxdWFsKGdvYWwpKSB7XHJcbiAgICAgICAgICAgICAgICBjb250aW51ZVxyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBpZiAoY2xvc2VkLmZpbmQoeCA9PiBjb29yZHMuZXF1YWwoeC5jb29yZHMpKSkge1xyXG4gICAgICAgICAgICAgICAgY29udGludWVcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgY29uc3QgZyA9IGN1ci5nICsgMVxyXG4gICAgICAgICAgICBjb25zdCBoID0gZ2VvLmNhbGNNYW5oYXR0ZW5EaXN0KGdvYWwsIGNvb3JkcylcclxuICAgICAgICAgICAgY29uc3QgZiA9IGcgKyBoXHJcblxyXG4gICAgICAgICAgICAvLyBkb2VzIHRoaXMgbm9kZSBhbHJlYWR5IGV4aXN0IGluIG9wZW4gbGlzdD9cclxuICAgICAgICAgICAgY29uc3Qgb3Blbk5vZGUgPSBvcGVuLmZpbmQoeCA9PiBjb29yZHMuZXF1YWwoeC5jb29yZHMpKVxyXG4gICAgICAgICAgICBpZiAob3Blbk5vZGUgIT0gbnVsbCAmJiBvcGVuTm9kZS5nIDw9IGcpIHtcclxuICAgICAgICAgICAgICAgIGNvbnRpbnVlXHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIC8vIHBsYWNlIGluIG9wZW4gbGlzdFxyXG4gICAgICAgICAgICBvcGVuLnB1c2goeyBnOiBnLCBoOiBoLCBmOiBmLCBwYXJlbnQ6IGN1ciwgY29vcmRzOiBjb29yZHMgfSlcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIG5ldyBBcnJheTxnZW8uUG9pbnQ+KCk7XHJcbn1cclxuXHJcbmZ1bmN0aW9uKiB2aXNpdE5laWdoYm9ycyhwdDogZ2VvLlBvaW50LCB3aWR0aDogbnVtYmVyLCBoZWlnaHQ6IG51bWJlcik6IEl0ZXJhYmxlPGdlby5Qb2ludD4ge1xyXG4gICAgaWYgKHB0LnggPCAwIHx8IHB0LnkgPCAwIHx8IHB0LnggPj0gd2lkdGggfHwgcHQueSA+PSBoZWlnaHQpIHtcclxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJwdCBpcyBvdXQgb2YgYm91bmRzXCIpXHJcbiAgICB9XHJcblxyXG4gICAgLy8gd1xyXG4gICAgaWYgKHB0LnggPiAwKSB7XHJcbiAgICAgICAgY29uc3QgdyA9IG5ldyBnZW8uUG9pbnQocHQueCAtIDEsIHB0LnkpXHJcbiAgICAgICAgeWllbGQgd1xyXG4gICAgfVxyXG5cclxuICAgIC8vIHNcclxuICAgIGlmIChwdC55IDwgaGVpZ2h0IC0gMSkge1xyXG4gICAgICAgIGNvbnN0IHMgPSBuZXcgZ2VvLlBvaW50KHB0LngsIHB0LnkgKyAxKVxyXG4gICAgICAgIHlpZWxkIHNcclxuICAgIH1cclxuXHJcbiAgICAvLyBlXHJcbiAgICBpZiAocHQueCA8IHdpZHRoIC0gMSkge1xyXG4gICAgICAgIGNvbnN0IGUgPSBuZXcgZ2VvLlBvaW50KHB0LnggKyAxLCBwdC55KVxyXG4gICAgICAgIHlpZWxkIGVcclxuICAgIH1cclxuXHJcbiAgICAvLyBuXHJcbiAgICBpZiAocHQueSA+IDApIHtcclxuICAgICAgICBjb25zdCBuID0gbmV3IGdlby5Qb2ludChwdC54LCBwdC55IC0gMSlcclxuICAgICAgICB5aWVsZCBuXHJcbiAgICB9XHJcbn1cclxuIl19