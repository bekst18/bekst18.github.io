import * as geo from "../shared/geo2d.js";
import * as iter from "../shared/iter.js";
import * as grid from "../shared/grid.js";
export var Visibility;
(function (Visibility) {
    // no visibility, no line of site
    Visibility[Visibility["None"] = 0] = "None";
    // in line of sight, but outside of light radius
    Visibility[Visibility["Dark"] = 1] = "Dark";
    // visible and lit
    Visibility[Visibility["Visible"] = 2] = "Visible";
})(Visibility || (Visibility = {}));
/**
 * a layer that is based on a map
 * works well for sparse layers
 */
export class MapLayer {
    constructor() {
        this.map = new window.Map();
    }
    // this isn't quite right!
    // need to remove any old item at the specified position!
    set(position, thing) {
        position = position.clone();
        let th = iter.wrap(this.map.values()).find(pth => pth.position.equal(position));
        if (th) {
            this.map.delete(th.thing);
        }
        this.map.set(thing, { thing, position });
    }
    delete(thing) {
        this.map.delete(thing);
    }
    has(thing) {
        return this.map.has(thing);
    }
    at(position) {
        for (const pth of this.map.values()) {
            if (pth.position.equal(position)) {
                return pth.thing;
            }
        }
        return undefined;
    }
    where(thing) {
        var _a, _b;
        return (_b = (_a = this.map.get(thing)) === null || _a === void 0 ? void 0 : _a.position) === null || _b === void 0 ? void 0 : _b.clone();
    }
    *within(aabb) {
        for (const pth of this.map.values()) {
            if (aabb.contains(pth.position)) {
                yield pth;
            }
        }
    }
    get size() {
        return this.map.size;
    }
    *[Symbol.iterator]() {
        for (const value of this.map.values()) {
            yield value;
        }
    }
    *things() {
        for (const th of this.map.keys()) {
            yield th;
        }
    }
    *thingsWithin(aabb) {
        for (const pth of this.within(aabb)) {
            yield pth.thing;
        }
    }
    save() {
        const things = [...iter.map(this, pth => ({ thing: pth.thing.save(), x: pth.position.x, y: pth.position.y }))];
        return {
            things
        };
    }
    load(db, state) {
        for (const placedThingState of state.things) {
            const position = new geo.Point(placedThingState.x, placedThingState.y);
            const thing = db.load(placedThingState.thing);
            this.set(position, thing);
        }
    }
}
/**
 * a layer that is based on a grid
 * works well for dense layers
 */
export class GridLayer {
    constructor(width, height) {
        this.map = new MapLayer();
        this.grd = grid.generate(width, height, () => undefined);
    }
    get width() {
        return this.grd.width;
    }
    get height() {
        return this.grd.height;
    }
    set(position, thing) {
        // remove from grid if already present
        const oldPosition = this.map.where(thing);
        if (oldPosition) {
            this.grd.setPoint(oldPosition, undefined);
        }
        this.grd.setPoint(position, thing);
        this.map.set(position, thing);
    }
    delete(thing) {
        const pos = this.map.where(thing);
        if (!pos) {
            return;
        }
        this.grd.setPoint(pos, undefined);
        this.map.delete(thing);
    }
    has(item) {
        return this.map.has(item);
    }
    at(position) {
        return this.grd.atPoint(position);
    }
    where(thing) {
        return this.map.where(thing);
    }
    *within(aabb) {
        for (const [thing, x, y] of this.grd.scanAABB(aabb)) {
            if (!thing) {
                continue;
            }
            yield {
                position: new geo.Point(x, y),
                thing,
            };
        }
    }
    *thingsWithin(aabb) {
        for (const pth of this.within(aabb)) {
            yield pth.thing;
        }
    }
    get size() {
        return this.map.size;
    }
    *[Symbol.iterator]() {
        for (const value of this.map) {
            yield value;
        }
    }
    things() {
        return this.map.things();
    }
    save() {
        const things = [...iter.map(this, pth => ({ thing: pth.thing.save(), x: pth.position.x, y: pth.position.y }))];
        return {
            things
        };
    }
    load(db, state) {
        for (const placedThingState of state.things) {
            const position = new geo.Point(placedThingState.x, placedThingState.y);
            const thing = db.load(placedThingState.thing);
            this.set(position, thing);
        }
    }
}
export var Lighting;
(function (Lighting) {
    Lighting[Lighting["None"] = 0] = "None";
    Lighting[Lighting["Ambient"] = 1] = "Ambient";
})(Lighting || (Lighting = {}));
/**
 * components of a generated map area
 */
export class Map {
    constructor(width, height) {
        this.width = width;
        this.height = height;
        this.lighting = Lighting.None;
        this.tiles = new GridLayer(width, height);
        this.visible = grid.generate(width, height, _ => Visibility.None);
        this.seen = grid.generate(width, height, _ => false);
        this.fixtures = new MapLayer();
        this.exits = new MapLayer();
        this.monsters = new MapLayer();
        this.containers = new MapLayer();
        this.players = new MapLayer();
    }
    /**
     * retrieve player from map, throwing an exception if not found
     */
    get player() {
        const player = iter.first(this.players);
        return player;
    }
    /**
      * iterate over all things in map
    */
    *[Symbol.iterator]() {
        for (const tile of this.tiles) {
            yield tile;
        }
        for (const fixture of this.fixtures) {
            yield fixture;
        }
        for (const exit of this.exits) {
            yield exit;
        }
        for (const container of this.containers) {
            yield container;
        }
        for (const monster of this.monsters) {
            yield monster;
        }
        for (const player of this.players) {
            yield player;
        }
    }
    /**
     * iterate over all things in map
   */
    *things() {
        for (const pth of this) {
            yield pth.thing;
        }
    }
    tileAt(xy) {
        return this.tiles.at(xy);
    }
    fixtureAt(xy) {
        return this.fixtures.at(xy);
    }
    containerAt(xy) {
        return this.containers.at(xy);
    }
    monsterAt(xy) {
        return this.monsters.at(xy);
    }
    playerAt(xy) {
        return this.players.at(xy);
    }
    visibilityAt(xy) {
        return this.visible.atPoint(xy);
    }
    seenAt(xy) {
        return this.seen.atPoint(xy);
    }
    *at(xy) {
        const fixture = this.fixtureAt(xy);
        if (fixture) {
            yield fixture;
        }
        const tile = this.tileAt(xy);
        if (tile) {
            yield tile;
        }
        const container = this.containerAt(xy);
        if (container) {
            yield container;
        }
        const monster = this.monsterAt(xy);
        if (monster) {
            yield monster;
        }
        const player = this.playerAt(xy);
        if (player) {
            yield player;
        }
    }
    inBounds(xy) {
        return xy.x >= 0 && xy.x < this.width && xy.y >= 0 && xy.y < this.height;
    }
    isPassable(position) {
        return this.inBounds(position) && iter.all(this.at(position), th => th.passable);
    }
    updateVisible(viewportRadius) {
        this.clearVisible();
        const eye = this.player.position;
        const lightRadius = this.player.thing.lightRadius;
        for (let i = 0; i < 8; ++i) {
            this.updateVisibleOctant(eye, viewportRadius, lightRadius, i);
        }
        this.visible.setPoint(eye, Visibility.Visible);
        this.seen.setPoint(eye, true);
        // process each light source, lighting any tile that is marked as dark
        const sources = iter.filter(this.fixtures, f => f.thing.lightRadius > 0);
        for (const source of sources) {
            this.processLightSource(source);
        }
    }
    clearVisible() {
        for (let i = 0; i < this.visible.size; ++i) {
            this.visible.setf(i, Visibility.None);
        }
    }
    updateVisibleOctant(eye, viewportRadius, lightRadius, octant) {
        const shadows = [];
        for (let y = 1; y <= viewportRadius; ++y) {
            for (let x = 0; x <= y; ++x) {
                const octantPoint = new geo.Point(x, y);
                const mapPoint = transformOctant(octantPoint, octant).addPoint(eye);
                if (!this.inBounds(mapPoint)) {
                    continue;
                }
                if (isShadowed(shadows, octantPoint)) {
                    this.visible.set(mapPoint.x, mapPoint.y, Visibility.None);
                    continue;
                }
                const opaque = iter.any(this.at(mapPoint), th => !th.transparent);
                if (opaque) {
                    shadows.push(octantPoint);
                }
                if (geo.calcManhattenDist(mapPoint, eye) > lightRadius) {
                    this.visible.setPoint(mapPoint, Visibility.Dark);
                    continue;
                }
                this.visible.setPoint(mapPoint, Visibility.Visible);
                this.seen.setPoint(mapPoint, true);
            }
        }
    }
    processLightSource(positionedSource) {
        const { position, thing: source } = positionedSource;
        if (source.lightRadius <= 0) {
            return;
        }
        for (let i = 0; i < 8; ++i) {
            this.updateVisibleOctantLightSource(position, source.lightRadius, i);
        }
        if (this.visibilityAt(position) == Visibility.Dark) {
            this.visible.setPoint(position, Visibility.Visible);
            this.seen.setPoint(position, true);
        }
    }
    updateVisibleOctantLightSource(eye, radius, octant) {
        const shadows = [];
        // for light source, should only light darkened squares
        for (let y = 1; y <= radius; ++y) {
            for (let x = 0; x <= y; ++x) {
                const octantPoint = new geo.Point(x, y);
                const mapPoint = transformOctant(octantPoint, octant).addPoint(eye);
                if (!this.inBounds(mapPoint)) {
                    continue;
                }
                if (isShadowed(shadows, octantPoint)) {
                    continue;
                }
                const opaque = iter.any(this.at(mapPoint), th => !th.transparent);
                if (opaque) {
                    shadows.push(octantPoint);
                }
                if (geo.calcManhattenDist(mapPoint, eye) > radius) {
                    continue;
                }
                if (this.visibilityAt(mapPoint) === Visibility.Dark) {
                    this.visible.set(mapPoint.x, mapPoint.y, Visibility.Visible);
                    this.seen.setPoint(mapPoint, true);
                }
            }
        }
    }
    save() {
        return {
            width: this.visible.width,
            height: this.visible.height,
            tiles: this.tiles.save(),
            visible: [...this.visible],
            seen: [...this.seen],
            fixtures: this.fixtures.save(),
            exits: this.exits.save(),
            monsters: this.monsters.save(),
            containers: this.containers.save(),
            players: this.players.save(),
            lighting: this.lighting,
        };
    }
    static load(db, state) {
        const map = new Map(state.width, state.height);
        map.tiles.load(db, state.tiles);
        for (let i = 0; i < state.visible.length; ++i) {
            map.visible.setf(i, state.visible[i]);
        }
        for (let i = 0; i < state.visible.length; ++i) {
            map.seen.setf(i, state.seen[i]);
        }
        map.fixtures.load(db, state.fixtures);
        map.exits.load(db, state.exits);
        map.monsters.load(db, state.monsters);
        map.containers.load(db, state.containers);
        map.players.load(db, state.players);
        map.lighting = state.lighting;
        return map;
    }
}
function transformOctant(coords, octant) {
    switch (octant) {
        case 0: return new geo.Point(-coords.x, coords.y);
        case 1: return new geo.Point(-coords.y, coords.x);
        case 2: return new geo.Point(coords.y, coords.x);
        case 3: return new geo.Point(coords.x, coords.y);
        case 4: return new geo.Point(coords.x, -coords.y);
        case 5: return new geo.Point(coords.y, -coords.x);
        case 6: return new geo.Point(-coords.y, -coords.x);
        case 7: return new geo.Point(-coords.x, -coords.y);
    }
    throw new Error("Invalid octant - must be in interval [0, 8)");
}
function isShadowed(shadows, coords) {
    return iter.any(shadows, x => shadowCoversPoint(x, coords));
}
function shadowCoversPoint(shadow, coords) {
    if (shadow.x == 0) {
        return coords.y > shadow.y;
    }
    const startX = shadow.x / (shadow.y + 1) * coords.y;
    const endX = (shadow.x + 1) / shadow.y * coords.y;
    return coords.y > shadow.y && coords.x > startX && coords.x < endX;
}
/**
 * Find a path from start to goal
 * @param map map
 * @param start start coords
 * @param goal goal coords
 * @returns path from start to goal, including goal, but not starting position
 */
export function findPath(map, start, goal) {
    const open = new Array();
    const closed = new Array();
    open.push({ f: 0, g: 0, h: 0, parent: null, coords: start });
    const popOpen = () => {
        // warning: assumes non-empty!
        let n = 0;
        open.forEach((x, i) => {
            if (x.f < open[n].f) {
                n = i;
            }
        });
        // swap & pop
        const r = open[n];
        if (n < open.length - 1) {
            open[n] = open[open.length - 1];
        }
        open.pop();
        return r;
    };
    const assemblePath = (node) => {
        // path found! backtrack and assemble path
        const path = new Array();
        while (node && !node.coords.equal(start)) {
            path.push(node.coords);
            node = node.parent;
        }
        return path.reverse();
    };
    while (open.length > 0) {
        const cur = popOpen();
        closed.push(cur);
        if (cur.coords.equal(goal)) {
            return assemblePath(cur);
        }
        for (const coords of visitNeighbors(cur.coords, map.width, map.height)) {
            if (!map.isPassable(coords) && !coords.equal(goal)) {
                continue;
            }
            if (closed.find(x => coords.equal(x.coords))) {
                continue;
            }
            const g = cur.g + 1;
            const h = geo.calcManhattenDist(goal, coords);
            const f = g + h;
            // does this node already exist in open list?
            const openNode = open.find(x => coords.equal(x.coords));
            if (openNode != null && openNode.g <= g) {
                continue;
            }
            // place in open list
            open.push({ g: g, h: h, f: f, parent: cur, coords: coords });
        }
    }
    return new Array();
}
function* visitNeighbors(pt, width, height) {
    if (pt.x < 0 || pt.y < 0 || pt.x >= width || pt.y >= height) {
        throw new Error("pt is out of bounds");
    }
    // w
    if (pt.x > 0) {
        const w = new geo.Point(pt.x - 1, pt.y);
        yield w;
    }
    // s
    if (pt.y < height - 1) {
        const s = new geo.Point(pt.x, pt.y + 1);
        yield s;
    }
    // e
    if (pt.x < width - 1) {
        const e = new geo.Point(pt.x + 1, pt.y);
        yield e;
    }
    // n
    if (pt.y > 0) {
        const n = new geo.Point(pt.x, pt.y - 1);
        yield n;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFwcy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIm1hcHMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxLQUFLLEdBQUcsTUFBTSxvQkFBb0IsQ0FBQTtBQUN6QyxPQUFPLEtBQUssSUFBSSxNQUFNLG1CQUFtQixDQUFBO0FBRXpDLE9BQU8sS0FBSyxJQUFJLE1BQU0sbUJBQW1CLENBQUE7QUFFekMsTUFBTSxDQUFOLElBQVksVUFPWDtBQVBELFdBQVksVUFBVTtJQUNsQixpQ0FBaUM7SUFDakMsMkNBQUksQ0FBQTtJQUNKLGdEQUFnRDtJQUNoRCwyQ0FBSSxDQUFBO0lBQ0osa0JBQWtCO0lBQ2xCLGlEQUFPLENBQUE7QUFDWCxDQUFDLEVBUFcsVUFBVSxLQUFWLFVBQVUsUUFPckI7QUFtQ0Q7OztHQUdHO0FBQ0gsTUFBTSxPQUFPLFFBQVE7SUFBckI7UUFDcUIsUUFBRyxHQUFHLElBQUksTUFBTSxDQUFDLEdBQUcsRUFBZ0IsQ0FBQTtJQWlGekQsQ0FBQztJQS9FRywwQkFBMEI7SUFDMUIseURBQXlEO0lBQ3pELEdBQUcsQ0FBQyxRQUFtQixFQUFFLEtBQVE7UUFDN0IsUUFBUSxHQUFHLFFBQVEsQ0FBQyxLQUFLLEVBQUUsQ0FBQTtRQUUzQixJQUFJLEVBQUUsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFBO1FBQy9FLElBQUksRUFBRSxFQUFFO1lBQ0osSUFBSSxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLEtBQUssQ0FBQyxDQUFBO1NBQzVCO1FBRUQsSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsS0FBSyxFQUFFLEVBQUUsS0FBSyxFQUFFLFFBQVEsRUFBRSxDQUFDLENBQUE7SUFDNUMs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ekQsTUFBTSxJQUFJLEtBQUssQ0FBQyxxQkFBcUIsQ0FBQyxDQUFBO0tBQ3pDO0lBRUQsSUFBSTtJQUNKLElBQUksRUFBRSxDQUFDLENBQUMsR0FBRyxDQUFDLEVBQUU7UUFDVixNQUFNLENBQUMsR0FBRyxJQUFJLEdBQUcsQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDLENBQUMsR0FBRyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFBO1FBQ3ZDLE1BQU0sQ0FBQyxDQUFBO0tBQ1Y7SUFFRCxJQUFJO0lBQ0osSUFBSSxFQUFFLENBQUMsQ0FBQyxHQUFHLE1BQU0sR0FBRyxDQUFDLEVBQUU7UUFDbkIsTUFBTSxDQUFDLEdBQUcsSUFBSSxHQUFHLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQTtRQUN2QyxNQUFNLENBQUMsQ0FBQTtLQUNWO0lBRUQsSUFBSTtJQUNKLElBQUksRUFBRSxDQUFDLENBQUMsR0FBRyxLQUFLLEdBQUcsQ0FBQyxFQUFFO1FBQ2xCLE1BQU0sQ0FBQyxHQUFHLElBQUksR0FBRyxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUMsQ0FBQyxHQUFHLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUE7UUFDdkMsTUFBTSxDQUFDLENBQUE7S0FDVjtJQUVELElBQUk7SUFDSixJQUFJLEVBQUUsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxFQUFFO1FBQ1YsTUFBTSxDQUFDLEdBQUcsSUFBSSxHQUFHLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQTtRQUN2QyxNQUFNLENBQUMsQ0FBQTtLQUNWO0FBQ0wsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIGdlbyBmcm9tIFwiLi4vc2hhcmVkL2dlbzJkLmpzXCJcclxuaW1wb3J0ICogYXMgaXRlciBmcm9tIFwiLi4vc2hhcmVkL2l0ZXIuanNcIlxyXG5pbXBvcnQgKiBhcyBybCBmcm9tIFwiLi9ybC5qc1wiXHJcbmltcG9ydCAqIGFzIGdyaWQgZnJvbSBcIi4uL3NoYXJlZC9ncmlkLmpzXCJcclxuXHJcbmV4cG9ydCBlbnVtIFZpc2liaWxpdHkge1xyXG4gICAgLy8gbm8gdmlzaWJpbGl0eSwgbm8gbGluZSBvZiBzaXRlXHJcbiAgICBOb25lLFxyXG4gICAgLy8gaW4gbGluZSBvZiBzaWdodCwgYnV0IG91dHNpZGUgb2YgbGlnaHQgcmFkaXVzXHJcbiAgICBEYXJrLFxyXG4gICAgLy8gdmlzaWJsZSBhbmQgbGl0XHJcbiAgICBWaXNpYmxlXHJcbn1cclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgUGxhY2VkPFQgZXh0ZW5kcyBybC5UaGluZz4ge1xyXG4gICAgdGhpbmc6IFQsXHJcbiAgICBwb3NpdGlvbjogZ2VvLlBvaW50LFxyXG59XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIFBsYWNlZFNhdmVTdGF0ZSB7XHJcbiAgICB0aGluZzogcmwuVGhpbmdTYXZlU3RhdGUsXHJcbiAgICB4OiBudW1iZXIsXHJcbiAgICB5OiBudW1iZXIsXHJcbn1cclxuXHJcbi8qKlxyXG4gKiBhIGxheWVyIG9mIHRoaW5ncyBvbiBhIG1hcFxyXG4gKi9cclxuZXhwb3J0IGludGVyZmFjZSBMYXllcjxUIGV4dGVuZHMgcmwuVGhpbmc+IHtcclxuICAgIHNldChwb3NpdGlvbjogZ2VvLlBvaW50LCB0aGluZzogVCk6IHZvaWRcclxuICAgIGRlbGV0ZSh0aGluZzogVCk6IHZvaWRcclxuICAgIGhhcyh0aGluZzogVCk6IGJvb2xlYW5cclxuICAgIGF0KHBvc2l0aW9uOiBnZW8uUG9pbnQpOiBUIHwgdW5kZWZpbmVkXHJcbiAgICB3aXRoaW4oYWFiYjogZ2VvLkFBQkIpOiBHZW5lcmF0b3I8UGxhY2VkPFQ+PixcclxuICAgIHRoaW5nc1dpdGhpbihhYWJiOiBnZW8uQUFCQik6IEdlbmVyYXRvcjxUPixcclxuICAgIHdoZXJlKHRoaW5nOiBUKTogZ2VvLlBvaW50IHwgdW5kZWZpbmVkLFxyXG4gICAgc2l6ZTogbnVtYmVyXHJcbiAgICBbU3ltYm9sLml0ZXJhdG9yXSgpOiBHZW5lcmF0b3I8UGxhY2VkPFQ+PlxyXG4gICAgdGhpbmdzKCk6IEdlbmVyYXRvcjxUPlxyXG4gICAgc2F2ZSgpOiBMYXllclNhdmVTdGF0ZVxyXG4gICAgbG9hZChkYjogcmwuVGhpbmdEQiwgc3RhdGU6IExheWVyU2F2ZVN0YXRlKTogdm9pZFxyXG59XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIExheWVyU2F2ZVN0YXRlIHtcclxuICAgIHRoaW5nczogUGxhY2VkU2F2ZVN0YXRlW11cclxufVxyXG5cclxuLyoqXHJcbiAqIGEgbGF5ZXIgdGhhdCBpcyBiYXNlZCBvbiBhIG1hcFxyXG4gKiB3b3JrcyB3ZWxsIGZvciBzcGFyc2UgbGF5ZXJzXHJcbiAqL1xyXG5leHBvcnQgY2xhc3MgTWFwTGF5ZXI8VCBleHRlbmRzIHJsLlRoaW5nPiBpbXBsZW1lbnRzIExheWVyPFQ+IHtcclxuICAgIHByaXZhdGUgcmVhZG9ubHkgbWFwID0gbmV3IHdpbmRvdy5NYXA8VCwgUGxhY2VkPFQ+PigpXHJcblxyXG4gICAgLy8gdGhpcyBpc24ndCBxdWl0ZSByaWdodCFcclxuICAgIC8vIG5lZWQgdG8gcmVtb3ZlIGFueSBvbGQgaXRlbSBhdCB0aGUgc3BlY2lmaWVkIHBvc2l0aW9uIVxyXG4gICAgc2V0KHBvc2l0aW9uOiBnZW8uUG9pbnQsIHRoaW5nOiBUKTogdm9pZCB7XHJcbiAgICAgICAgcG9zaXRpb24gPSBwb3NpdGlvbi5jbG9uZSgpXHJcblxyXG4gICAgICAgIGxldCB0aCA9IGl0ZXIud3JhcCh0aGlzLm1hcC52YWx1ZXMoKSkuZmluZChwdGggPT4gcHRoLnBvc2l0aW9uLmVxdWFsKHBvc2l0aW9uKSlcclxuICAgICAgICBpZiAodGgpIHtcclxuICAgICAgICAgICAgdGhpcy5tYXAuZGVsZXRlKHRoLnRoaW5nKVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgdGhpcy5tYXAuc2V0KHRoaW5nLCB7IHRoaW5nLCBwb3NpdGlvbiB9KVxyXG4gICAgfVxyXG5cclxuICAgIGRlbGV0ZSh0aGluZzogVCk6IHZvaWQge1xyXG4gICAgICAgIHRoaXMubWFwLmRlbGV0ZSh0aGluZylcclxuICAgIH1cclxuXHJcbiAgICBoYXModGhpbmc6IFQpOiBib29sZWFuIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5tYXAuaGFzKHRoaW5nKVxyXG4gICAgfVxyXG5cclxuICAgIGF0KHBvc2l0aW9uOiBnZW8uUG9pbnQpOiBUIHwgdW5kZWZpbmVkIHtcclxuICAgICAgICBmb3IgKGNvbnN0IHB0aCBvZiB0aGlzLm1hcC52YWx1ZXMoKSkge1xyXG4gICAgICAgICAgICBpZiAocHRoLnBvc2l0aW9uLmVxdWFsKHBvc2l0aW9uKSkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHB0aC50aGluZ1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gdW5kZWZpbmVkXHJcbiAgICB9XHJcblxyXG4gICAgd2hlcmUodGhpbmc6IFQpOiBnZW8uUG9pbnQgfCB1bmRlZmluZWQge1xyXG4gICAgICAgIHJldHVybiB0aGlzLm1hcC5nZXQodGhpbmcpPy5wb3NpdGlvbj8uY2xvbmUoKVxyXG4gICAgfVxyXG5cclxuICAgICp3aXRoaW4oYWFiYjogZ2VvLkFBQkIpOiBHZW5lcmF0b3I8UGxhY2VkPFQ+PiB7XHJcbiAgICAgICAgZm9yIChjb25zdCBwdGggb2YgdGhpcy5tYXAudmFsdWVzKCkpIHtcclxuICAgICAgICAgICAgaWYgKGFhYmIuY29udGFpbnMocHRoLnBvc2l0aW9uKSkge1xyXG4gICAgICAgICAgICAgICAgeWllbGQgcHRoXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0IHNpemUoKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMubWFwLnNpemVcclxuICAgIH1cclxuXHJcbiAgICAqW1N5bWJvbC5pdGVyYXRvcl0oKTogR2VuZXJhdG9yPFBsYWNlZDxUPj4ge1xyXG4gICAgICAgIGZvciAoY29uc3QgdmFsdWUgb2YgdGhpcy5tYXAudmFsdWVzKCkpIHtcclxuICAgICAgICAgICAgeWllbGQgdmFsdWVcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgKnRoaW5ncygpOiBHZW5lcmF0b3I8VD4ge1xyXG4gICAgICAgIGZvciAoY29uc3QgdGggb2YgdGhpcy5tYXAua2V5cygpKSB7XHJcbiAgICAgICAgICAgIHlpZWxkIHRoXHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgICp0aGluZ3NXaXRoaW4oYWFiYjogZ2VvLkFBQkIpOiBHZW5lcmF0b3I8VD4ge1xyXG4gICAgICAgIGZvciAoY29uc3QgcHRoIG9mIHRoaXMud2l0aGluKGFhYmIpKSB7XHJcbiAgICAgICAgICAgIHlpZWxkIHB0aC50aGluZ1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBzYXZlKCk6IExheWVyU2F2ZVN0YXRlIHtcclxuICAgICAgICBjb25zdCB0aGluZ3MgPSBbLi4uaXRlci5tYXAodGhpcywgcHRoID0+ICh7IHRoaW5nOiBwdGgudGhpbmcuc2F2ZSgpLCB4OiBwdGgucG9zaXRpb24ueCwgeTogcHRoLnBvc2l0aW9uLnkgfSkpXVxyXG4gICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgIHRoaW5nc1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBsb2FkKGRiOiBybC5UaGluZ0RCLCBzdGF0ZTogTGF5ZXJTYXZlU3RhdGUpIHtcclxuICAgICAgICBmb3IgKGNvbnN0IHBsYWNlZFRoaW5nU3RhdGUgb2Ygc3RhdGUudGhpbmdzKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHBvc2l0aW9uID0gbmV3IGdlby5Qb2ludChwbGFjZWRUaGluZ1N0YXRlLngsIHBsYWNlZFRoaW5nU3RhdGUueSlcclxuICAgICAgICAgICAgY29uc3QgdGhpbmcgPSBkYi5sb2FkKHBsYWNlZFRoaW5nU3RhdGUudGhpbmcpIGFzIFRcclxuICAgICAgICAgICAgdGhpcy5zZXQocG9zaXRpb24sIHRoaW5nKVxyXG4gICAgICAgIH1cclxuICAgIH1cclxufVxyXG5cclxuLyoqXHJcbiAqIGEgbGF5ZXIgdGhhdCBpcyBiYXNlZCBvbiBhIGdyaWRcclxuICogd29ya3Mgd2VsbCBmb3IgZGVuc2UgbGF5ZXJzXHJcbiAqL1xyXG5leHBvcnQgY2xhc3MgR3JpZExheWVyPFQgZXh0ZW5kcyBybC5UaGluZz4gaW1wbGVtZW50cyBMYXllcjxUPiB7XHJcbiAgICBwcml2YXRlIHJlYWRvbmx5IG1hcCA9IG5ldyBNYXBMYXllcjxUPigpXHJcbiAgICBwcml2YXRlIHJlYWRvbmx5IGdyZDogZ3JpZC5HcmlkPFQgfCB1bmRlZmluZWQ+XHJcblxyXG4gICAgY29uc3RydWN0b3Iod2lkdGg6IG51bWJlciwgaGVpZ2h0OiBudW1iZXIpIHtcclxuICAgICAgICB0aGlzLmdyZCA9IGdyaWQuZ2VuZXJhdGUod2lkdGgsIGhlaWdodCwgKCkgPT4gdW5kZWZpbmVkKVxyXG4gICAgfVxyXG5cclxuICAgIGdldCB3aWR0aCgpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5ncmQud2lkdGhcclxuICAgIH1cclxuXHJcbiAgICBnZXQgaGVpZ2h0KCkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLmdyZC5oZWlnaHRcclxuICAgIH1cclxuXHJcbiAgICBzZXQocG9zaXRpb246IGdlby5Qb2ludCwgdGhpbmc6IFQpOiB2b2lkIHtcclxuICAgICAgICAvLyByZW1vdmUgZnJvbSBncmlkIGlmIGFscmVhZHkgcHJlc2VudFxyXG4gICAgICAgIGNvbnN0IG9sZFBvc2l0aW9uID0gdGhpcy5tYXAud2hlcmUodGhpbmcpXHJcbiAgICAgICAgaWYgKG9sZFBvc2l0aW9uKSB7XHJcbiAgICAgICAgICAgIHRoaXMuZ3JkLnNldFBvaW50KG9sZFBvc2l0aW9uLCB1bmRlZmluZWQpXHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB0aGlzLmdyZC5zZXRQb2ludChwb3NpdGlvbiwgdGhpbmcpXHJcbiAgICAgICAgdGhpcy5tYXAuc2V0KHBvc2l0aW9uLCB0aGluZylcclxuICAgIH1cclxuXHJcbiAgICBkZWxldGUodGhpbmc6IFQpOiB2b2lkIHtcclxuICAgICAgICBjb25zdCBwb3MgPSB0aGlzLm1hcC53aGVyZSh0aGluZylcclxuICAgICAgICBpZiAoIXBvcykge1xyXG4gICAgICAgICAgICByZXR1cm5cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHRoaXMuZ3JkLnNldFBvaW50KHBvcywgdW5kZWZpbmVkKVxyXG4gICAgICAgIHRoaXMubWFwLmRlbGV0ZSh0aGluZylcclxuICAgIH1cclxuXHJcbiAgICBoYXMoaXRlbTogVCk6IGJvb2xlYW4ge1xyXG4gICAgICAgIHJldHVybiB0aGlzLm1hcC5oYXMoaXRlbSlcclxuICAgIH1cclxuXHJcbiAgICBhdChwb3NpdGlvbjogZ2VvLlBvaW50KTogVCB8IHVuZGVmaW5lZCB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuZ3JkLmF0UG9pbnQocG9zaXRpb24pXHJcbiAgICB9XHJcblxyXG4gICAgd2hlcmUodGhpbmc6IFQpOiBnZW8uUG9pbnQgfCB1bmRlZmluZWQge1xyXG4gICAgICAgIHJldHVybiB0aGlzLm1hcC53aGVyZSh0aGluZylcclxuICAgIH1cclxuXHJcbiAgICAqd2l0aGluKGFhYmI6IGdlby5BQUJCKTogR2VuZXJhdG9yPFBsYWNlZDxUPj4ge1xyXG4gICAgICAgIGZvciAoY29uc3QgW3RoaW5nLCB4LCB5XSBvZiB0aGlzLmdyZC5zY2FuQUFCQihhYWJiKSkge1xyXG4gICAgICAgICAgICBpZiAoIXRoaW5nKSB7XHJcbiAgICAgICAgICAgICAgICBjb250aW51ZVxyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICB5aWVsZCB7XHJcbiAgICAgICAgICAgICAgICBwb3NpdGlvbjogbmV3IGdlby5Qb2ludCh4LCB5KSxcclxuICAgICAgICAgICAgICAgIHRoaW5nLFxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgICp0aGluZ3NXaXRoaW4oYWFiYjogZ2VvLkFBQkIpOiBHZW5lcmF0b3I8VD4ge1xyXG4gICAgICAgIGZvciAoY29uc3QgcHRoIG9mIHRoaXMud2l0aGluKGFhYmIpKSB7XHJcbiAgICAgICAgICAgIHlpZWxkIHB0aC50aGluZ1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBnZXQgc2l6ZSgpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5tYXAuc2l6ZVxyXG4gICAgfVxyXG5cclxuICAgICpbU3ltYm9sLml0ZXJhdG9yXSgpOiBHZW5lcmF0b3I8UGxhY2VkPFQ+PiB7XHJcbiAgICAgICAgZm9yIChjb25zdCB2YWx1ZSBvZiB0aGlzLm1hcCkge1xyXG4gICAgICAgICAgICB5aWVsZCB2YWx1ZVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICB0aGluZ3MoKTogR2VuZXJhdG9yPFQ+IHtcclxuICAgICAgICByZXR1cm4gdGhpcy5tYXAudGhpbmdzKClcclxuICAgIH1cclxuXHJcbiAgICBzYXZlKCk6IExheWVyU2F2ZVN0YXRlIHtcclxuICAgICAgICBjb25zdCB0aGluZ3MgPSBbLi4uaXRlci5tYXAodGhpcywgcHRoID0+ICh7IHRoaW5nOiBwdGgudGhpbmcuc2F2ZSgpLCB4OiBwdGgucG9zaXRpb24ueCwgeTogcHRoLnBvc2l0aW9uLnkgfSkpXVxyXG4gICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgIHRoaW5nc1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBsb2FkKGRiOiBybC5UaGluZ0RCLCBzdGF0ZTogTGF5ZXJTYXZlU3RhdGUpIHtcclxuICAgICAgICBmb3IgKGNvbnN0IHBsYWNlZFRoaW5nU3RhdGUgb2Ygc3RhdGUudGhpbmdzKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHBvc2l0aW9uID0gbmV3IGdlby5Qb2ludChwbGFjZWRUaGluZ1N0YXRlLngsIHBsYWNlZFRoaW5nU3RhdGUueSlcclxuICAgICAgICAgICAgY29uc3QgdGhpbmcgPSBkYi5sb2FkKHBsYWNlZFRoaW5nU3RhdGUudGhpbmcpIGFzIFRcclxuICAgICAgICAgICAgdGhpcy5zZXQocG9zaXRpb24sIHRoaW5nKVxyXG4gICAgICAgIH1cclxuICAgIH1cclxufVxyXG5cclxuZXhwb3J0IGVudW0gTGlnaHRpbmcge1xyXG4gICAgTm9uZSxcclxuICAgIEFtYmllbnQsXHJcbn1cclxuXHJcbi8qKlxyXG4gKiBjb21wb25lbnRzIG9mIGEgZ2VuZXJhdGVkIG1hcCBhcmVhXHJcbiAqL1xyXG5leHBvcnQgY2xhc3MgTWFwIHtcclxuICAgIHRpbGVzOiBMYXllcjxybC5UaWxlPlxyXG4gICAgdmlzaWJsZTogZ3JpZC5HcmlkPFZpc2liaWxpdHk+XHJcbiAgICBzZWVuOiBncmlkLkdyaWQ8Ym9vbGVhbj5cclxuICAgIGZpeHR1cmVzOiBMYXllcjxybC5GaXh0dXJlPlxyXG4gICAgZXhpdHM6IExheWVyPHJsLkV4aXQ+XHJcbiAgICBtb25zdGVyczogTGF5ZXI8cmwuTW9uc3Rlcj5cclxuICAgIGNvbnRhaW5lcnM6IExheWVyPHJsLkNvbnRhaW5lcj5cclxuICAgIHBsYXllcnM6IExheWVyPHJsLlBsYXllcj5cclxuICAgIGxpZ2h0aW5nOiBMaWdodGluZyA9IExpZ2h0aW5nLk5vbmVcclxuXHJcbiAgICBjb25zdHJ1Y3RvcihyZWFkb25seSB3aWR0aDogbnVtYmVyLCByZWFkb25seSBoZWlnaHQ6IG51bWJlcikge1xyXG4gICAgICAgIHRoaXMudGlsZXMgPSBuZXcgR3JpZExheWVyKHdpZHRoLCBoZWlnaHQpXHJcbiAgICAgICAgdGhpcy52aXNpYmxlID0gZ3JpZC5nZW5lcmF0ZSh3aWR0aCwgaGVpZ2h0LCBfID0+IFZpc2liaWxpdHkuTm9uZSlcclxuICAgICAgICB0aGlzLnNlZW4gPSBncmlkLmdlbmVyYXRlKHdpZHRoLCBoZWlnaHQsIF8gPT4gZmFsc2UpXHJcbiAgICAgICAgdGhpcy5maXh0dXJlcyA9IG5ldyBNYXBMYXllcigpXHJcbiAgICAgICAgdGhpcy5leGl0cyA9IG5ldyBNYXBMYXllcigpXHJcbiAgICAgICAgdGhpcy5tb25zdGVycyA9IG5ldyBNYXBMYXllcigpXHJcbiAgICAgICAgdGhpcy5jb250YWluZXJzID0gbmV3IE1hcExheWVyKClcclxuICAgICAgICB0aGlzLnBsYXllcnMgPSBuZXcgTWFwTGF5ZXIoKVxyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogcmV0cmlldmUgcGxheWVyIGZyb20gbWFwLCB0aHJvd2luZyBhbiBleGNlcHRpb24gaWYgbm90IGZvdW5kXHJcbiAgICAgKi9cclxuICAgIGdldCBwbGF5ZXIoKTogUGxhY2VkPHJsLlBsYXllcj4ge1xyXG4gICAgICAgIGNvbnN0IHBsYXllciA9IGl0ZXIuZmlyc3QodGhpcy5wbGF5ZXJzKVxyXG4gICAgICAgIHJldHVybiBwbGF5ZXJcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAgKiBpdGVyYXRlIG92ZXIgYWxsIHRoaW5ncyBpbiBtYXBcclxuICAgICovXHJcbiAgICBwdWJsaWMgKltTeW1ib2wuaXRlcmF0b3JdKCk6IEdlbmVyYXRvcjxQbGFjZWQ8cmwuVGhpbmc+PiB7XHJcbiAgICAgICAgZm9yIChjb25zdCB0aWxlIG9mIHRoaXMudGlsZXMpIHtcclxuICAgICAgICAgICAgeWllbGQgdGlsZVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgZm9yIChjb25zdCBmaXh0dXJlIG9mIHRoaXMuZml4dHVyZXMpIHtcclxuICAgICAgICAgICAgeWllbGQgZml4dHVyZVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgZm9yIChjb25zdCBleGl0IG9mIHRoaXMuZXhpdHMpIHtcclxuICAgICAgICAgICAgeWllbGQgZXhpdFxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgZm9yIChjb25zdCBjb250YWluZXIgb2YgdGhpcy5jb250YWluZXJzKSB7XHJcbiAgICAgICAgICAgIHlpZWxkIGNvbnRhaW5lclxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgZm9yIChjb25zdCBtb25zdGVyIG9mIHRoaXMubW9uc3RlcnMpIHtcclxuICAgICAgICAgICAgeWllbGQgbW9uc3RlclxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgZm9yIChjb25zdCBwbGF5ZXIgb2YgdGhpcy5wbGF5ZXJzKSB7XHJcbiAgICAgICAgICAgIHlpZWxkIHBsYXllclxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIGl0ZXJhdGUgb3ZlciBhbGwgdGhpbmdzIGluIG1hcFxyXG4gICAqL1xyXG4gICAgcHVibGljICp0aGluZ3MoKTogR2VuZXJhdG9yPHJsLlRoaW5nPiB7XHJcbiAgICAgICAgZm9yIChjb25zdCBwdGggb2YgdGhpcykge1xyXG4gICAgICAgICAgICB5aWVsZCBwdGgudGhpbmdcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgdGlsZUF0KHh5OiBnZW8uUG9pbnQpOiBybC5UaWxlIHwgdW5kZWZpbmVkIHtcclxuICAgICAgICByZXR1cm4gdGhpcy50aWxlcy5hdCh4eSlcclxuICAgIH1cclxuXHJcbiAgICBmaXh0dXJlQXQoeHk6IGdlby5Qb2ludCk6IHJsLkZpeHR1cmUgfCB1bmRlZmluZWQge1xyXG4gICAgICAgIHJldHVybiB0aGlzLmZpeHR1cmVzLmF0KHh5KVxyXG4gICAgfVxyXG5cclxuICAgIGNvbnRhaW5lckF0KHh5OiBnZW8uUG9pbnQpOiBybC5Db250YWluZXIgfCB1bmRlZmluZWQge1xyXG4gICAgICAgIHJldHVybiB0aGlzLmNvbnRhaW5lcnMuYXQoeHkpXHJcbiAgICB9XHJcblxyXG4gICAgbW9uc3RlckF0KHh5OiBnZW8uUG9pbnQpOiBybC5Nb25zdGVyIHwgdW5kZWZpbmVkIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5tb25zdGVycy5hdCh4eSlcclxuICAgIH1cclxuXHJcbiAgICBwbGF5ZXJBdCh4eTogZ2VvLlBvaW50KTogcmwuUGxheWVyIHwgdW5kZWZpbmVkIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5wbGF5ZXJzLmF0KHh5KVxyXG4gICAgfVxyXG5cclxuICAgIHZpc2liaWxpdHlBdCh4eTogZ2VvLlBvaW50KTogVmlzaWJpbGl0eSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMudmlzaWJsZS5hdFBvaW50KHh5KVxyXG4gICAgfVxyXG5cclxuICAgIHNlZW5BdCh4eTogZ2VvLlBvaW50KTogYm9vbGVhbiB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuc2Vlbi5hdFBvaW50KHh5KVxyXG4gICAgfVxyXG5cclxuICAgICphdCh4eTogZ2VvLlBvaW50KTogR2VuZXJhdG9yPHJsLk1vbnN0ZXIgfCBybC5GaXh0dXJlIHwgcmwuVGlsZT4ge1xyXG4gICAgICAgIGNvbnN0IGZpeHR1cmUgPSB0aGlzLmZpeHR1cmVBdCh4eSlcclxuICAgICAgICBpZiAoZml4dHVyZSkge1xyXG4gICAgICAgICAgICB5aWVsZCBmaXh0dXJlXHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBjb25zdCB0aWxlID0gdGhpcy50aWxlQXQoeHkpXHJcbiAgICAgICAgaWYgKHRpbGUpIHtcclxuICAgICAgICAgICAgeWllbGQgdGlsZVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgY29uc3QgY29udGFpbmVyID0gdGhpcy5jb250YWluZXJBdCh4eSlcclxuICAgICAgICBpZiAoY29udGFpbmVyKSB7XHJcbiAgICAgICAgICAgIHlpZWxkIGNvbnRhaW5lclxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgY29uc3QgbW9uc3RlciA9IHRoaXMubW9uc3RlckF0KHh5KVxyXG4gICAgICAgIGlmIChtb25zdGVyKSB7XHJcbiAgICAgICAgICAgIHlpZWxkIG1vbnN0ZXJcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGNvbnN0IHBsYXllciA9IHRoaXMucGxheWVyQXQoeHkpXHJcbiAgICAgICAgaWYgKHBsYXllcikge1xyXG4gICAgICAgICAgICB5aWVsZCBwbGF5ZXJcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgaW5Cb3VuZHMoeHk6IGdlby5Qb2ludCk6IGJvb2xlYW4ge1xyXG4gICAgICAgIHJldHVybiB4eS54ID49IDAgJiYgeHkueCA8IHRoaXMud2lkdGggJiYgeHkueSA+PSAwICYmIHh5LnkgPCB0aGlzLmhlaWdodFxyXG4gICAgfVxyXG5cclxuICAgIGlzUGFzc2FibGUocG9zaXRpb246IGdlby5Qb2ludCk6IGJvb2xlYW4ge1xyXG4gICAgICAgIHJldHVybiB0aGlzLmluQm91bmRzKHBvc2l0aW9uKSAmJiBpdGVyLmFsbCh0aGlzLmF0KHBvc2l0aW9uKSwgdGggPT4gdGgucGFzc2FibGUpXHJcbiAgICB9XHJcblxyXG4gICAgdXBkYXRlVmlzaWJsZSh2aWV3cG9ydFJhZGl1czogbnVtYmVyKSB7XHJcbiAgICAgICAgdGhpcy5jbGVhclZpc2libGUoKVxyXG4gICAgICAgIGNvbnN0IGV5ZSA9IHRoaXMucGxheWVyLnBvc2l0aW9uXHJcbiAgICAgICAgY29uc3QgbGlnaHRSYWRpdXMgPSB0aGlzLnBsYXllci50aGluZy5saWdodFJhZGl1c1xyXG5cclxuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IDg7ICsraSkge1xyXG4gICAgICAgICAgICB0aGlzLnVwZGF0ZVZpc2libGVPY3RhbnQoZXllLCB2aWV3cG9ydFJhZGl1cywgbGlnaHRSYWRpdXMsIGkpXHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB0aGlzLnZpc2libGUuc2V0UG9pbnQoZXllLCBWaXNpYmlsaXR5LlZpc2libGUpXHJcbiAgICAgICAgdGhpcy5zZWVuLnNldFBvaW50KGV5ZSwgdHJ1ZSlcclxuXHJcbiAgICAgICAgLy8gcHJvY2VzcyBlYWNoIGxpZ2h0IHNvdXJjZSwgbGlnaHRpbmcgYW55IHRpbGUgdGhhdCBpcyBtYXJrZWQgYXMgZGFya1xyXG4gICAgICAgIGNvbnN0IHNvdXJjZXMgPSBpdGVyLmZpbHRlcih0aGlzLmZpeHR1cmVzLCBmID0+IGYudGhpbmcubGlnaHRSYWRpdXMgPiAwKVxyXG5cclxuICAgICAgICBmb3IgKGNvbnN0IHNvdXJjZSBvZiBzb3VyY2VzKSB7XHJcbiAgICAgICAgICAgIHRoaXMucHJvY2Vzc0xpZ2h0U291cmNlKHNvdXJjZSlcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBjbGVhclZpc2libGUoKSB7XHJcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLnZpc2libGUuc2l6ZTsgKytpKSB7XHJcbiAgICAgICAgICAgIHRoaXMudmlzaWJsZS5zZXRmKGksIFZpc2liaWxpdHkuTm9uZSlcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSB1cGRhdGVWaXNpYmxlT2N0YW50KGV5ZTogZ2VvLlBvaW50LCB2aWV3cG9ydFJhZGl1czogbnVtYmVyLCBsaWdodFJhZGl1czogbnVtYmVyLCBvY3RhbnQ6IG51bWJlcikge1xyXG4gICAgICAgIGNvbnN0IHNoYWRvd3M6IGdlby5Qb2ludFtdID0gW11cclxuXHJcbiAgICAgICAgZm9yIChsZXQgeSA9IDE7IHkgPD0gdmlld3BvcnRSYWRpdXM7ICsreSkge1xyXG4gICAgICAgICAgICBmb3IgKGxldCB4ID0gMDsgeCA8PSB5OyArK3gpIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IG9jdGFudFBvaW50ID0gbmV3IGdlby5Qb2ludCh4LCB5KVxyXG5cclxuICAgICAgICAgICAgICAgIGNvbnN0IG1hcFBvaW50ID0gdHJhbnNmb3JtT2N0YW50KG9jdGFudFBvaW50LCBvY3RhbnQpLmFkZFBvaW50KGV5ZSlcclxuICAgICAgICAgICAgICAgIGlmICghdGhpcy5pbkJvdW5kcyhtYXBQb2ludCkpIHtcclxuICAgICAgICAgICAgICAgICAgICBjb250aW51ZVxyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIGlmIChpc1NoYWRvd2VkKHNoYWRvd3MsIG9jdGFudFBvaW50KSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMudmlzaWJsZS5zZXQobWFwUG9pbnQueCwgbWFwUG9pbnQueSwgVmlzaWJpbGl0eS5Ob25lKVxyXG4gICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlXHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgY29uc3Qgb3BhcXVlID0gaXRlci5hbnkodGhpcy5hdChtYXBQb2ludCksIHRoID0+ICF0aC50cmFuc3BhcmVudClcclxuICAgICAgICAgICAgICAgIGlmIChvcGFxdWUpIHtcclxuICAgICAgICAgICAgICAgICAgICBzaGFkb3dzLnB1c2gob2N0YW50UG9pbnQpXHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgaWYgKGdlby5jYWxjTWFuaGF0dGVuRGlzdChtYXBQb2ludCwgZXllKSA+IGxpZ2h0UmFkaXVzKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy52aXNpYmxlLnNldFBvaW50KG1hcFBvaW50LCBWaXNpYmlsaXR5LkRhcmspXHJcbiAgICAgICAgICAgICAgICAgICAgY29udGludWVcclxuICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICB0aGlzLnZpc2libGUuc2V0UG9pbnQobWFwUG9pbnQsIFZpc2liaWxpdHkuVmlzaWJsZSlcclxuICAgICAgICAgICAgICAgIHRoaXMuc2Vlbi5zZXRQb2ludChtYXBQb2ludCwgdHJ1ZSlcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIHByb2Nlc3NMaWdodFNvdXJjZShwb3NpdGlvbmVkU291cmNlOiBQbGFjZWQ8cmwuRml4dHVyZT4pIHtcclxuICAgICAgICBjb25zdCB7IHBvc2l0aW9uLCB0aGluZzogc291cmNlIH0gPSBwb3NpdGlvbmVkU291cmNlXHJcbiAgICAgICAgaWYgKHNvdXJjZS5saWdodFJhZGl1cyA8PSAwKSB7XHJcbiAgICAgICAgICAgIHJldHVyblxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCA4OyArK2kpIHtcclxuICAgICAgICAgICAgdGhpcy51cGRhdGVWaXNpYmxlT2N0YW50TGlnaHRTb3VyY2UocG9zaXRpb24sIHNvdXJjZS5saWdodFJhZGl1cywgaSlcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmICh0aGlzLnZpc2liaWxpdHlBdChwb3NpdGlvbikgPT0gVmlzaWJpbGl0eS5EYXJrKSB7XHJcbiAgICAgICAgICAgIHRoaXMudmlzaWJsZS5zZXRQb2ludChwb3NpdGlvbiwgVmlzaWJpbGl0eS5WaXNpYmxlKVxyXG4gICAgICAgICAgICB0aGlzLnNlZW4uc2V0UG9pbnQocG9zaXRpb24sIHRydWUpXHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgdXBkYXRlVmlzaWJsZU9jdGFudExpZ2h0U291cmNlKGV5ZTogZ2VvLlBvaW50LCByYWRpdXM6IG51bWJlciwgb2N0YW50OiBudW1iZXIpIHtcclxuICAgICAgICBjb25zdCBzaGFkb3dzOiBnZW8uUG9pbnRbXSA9IFtdXHJcblxyXG4gICAgICAgIC8vIGZvciBsaWdodCBzb3VyY2UsIHNob3VsZCBvbmx5IGxpZ2h0IGRhcmtlbmVkIHNxdWFyZXNcclxuICAgICAgICBmb3IgKGxldCB5ID0gMTsgeSA8PSByYWRpdXM7ICsreSkge1xyXG4gICAgICAgICAgICBmb3IgKGxldCB4ID0gMDsgeCA8PSB5OyArK3gpIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IG9jdGFudFBvaW50ID0gbmV3IGdlby5Qb2ludCh4LCB5KVxyXG5cclxuICAgICAgICAgICAgICAgIGNvbnN0IG1hcFBvaW50ID0gdHJhbnNmb3JtT2N0YW50KG9jdGFudFBvaW50LCBvY3RhbnQpLmFkZFBvaW50KGV5ZSlcclxuICAgICAgICAgICAgICAgIGlmICghdGhpcy5pbkJvdW5kcyhtYXBQb2ludCkpIHtcclxuICAgICAgICAgICAgICAgICAgICBjb250aW51ZVxyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIGlmIChpc1NoYWRvd2VkKHNoYWRvd3MsIG9jdGFudFBvaW50KSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlXHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgY29uc3Qgb3BhcXVlID0gaXRlci5hbnkodGhpcy5hdChtYXBQb2ludCksIHRoID0+ICF0aC50cmFuc3BhcmVudClcclxuICAgICAgICAgICAgICAgIGlmIChvcGFxdWUpIHtcclxuICAgICAgICAgICAgICAgICAgICBzaGFkb3dzLnB1c2gob2N0YW50UG9pbnQpXHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgaWYgKGdlby5jYWxjTWFuaGF0dGVuRGlzdChtYXBQb2ludCwgZXllKSA+IHJhZGl1cykge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlXHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgaWYgKHRoaXMudmlzaWJpbGl0eUF0KG1hcFBvaW50KSA9PT0gVmlzaWJpbGl0eS5EYXJrKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy52aXNpYmxlLnNldChtYXBQb2ludC54LCBtYXBQb2ludC55LCBWaXNpYmlsaXR5LlZpc2libGUpXHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZWVuLnNldFBvaW50KG1hcFBvaW50LCB0cnVlKVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHNhdmUoKTogTWFwU2F2ZVN0YXRlIHtcclxuICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICB3aWR0aDogdGhpcy52aXNpYmxlLndpZHRoLFxyXG4gICAgICAgICAgICBoZWlnaHQ6IHRoaXMudmlzaWJsZS5oZWlnaHQsXHJcbiAgICAgICAgICAgIHRpbGVzOiB0aGlzLnRpbGVzLnNhdmUoKSxcclxuICAgICAgICAgICAgdmlzaWJsZTogWy4uLnRoaXMudmlzaWJsZV0sXHJcbiAgICAgICAgICAgIHNlZW46IFsuLi50aGlzLnNlZW5dLFxyXG4gICAgICAgICAgICBmaXh0dXJlczogdGhpcy5maXh0dXJlcy5zYXZlKCksXHJcbiAgICAgICAgICAgIGV4aXRzOiB0aGlzLmV4aXRzLnNhdmUoKSxcclxuICAgICAgICAgICAgbW9uc3RlcnM6IHRoaXMubW9uc3RlcnMuc2F2ZSgpLFxyXG4gICAgICAgICAgICBjb250YWluZXJzOiB0aGlzLmNvbnRhaW5lcnMuc2F2ZSgpLFxyXG4gICAgICAgICAgICBwbGF5ZXJzOiB0aGlzLnBsYXllcnMuc2F2ZSgpLFxyXG4gICAgICAgICAgICBsaWdodGluZzogdGhpcy5saWdodGluZyxcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgc3RhdGljIGxvYWQoZGI6IHJsLlRoaW5nREIsIHN0YXRlOiBNYXBTYXZlU3RhdGUpOiBNYXAge1xyXG4gICAgICAgIGNvbnN0IG1hcCA9IG5ldyBNYXAoc3RhdGUud2lkdGgsIHN0YXRlLmhlaWdodClcclxuICAgICAgICBtYXAudGlsZXMubG9hZChkYiwgc3RhdGUudGlsZXMpXHJcblxyXG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgc3RhdGUudmlzaWJsZS5sZW5ndGg7ICsraSkge1xyXG4gICAgICAgICAgICBtYXAudmlzaWJsZS5zZXRmKGksIHN0YXRlLnZpc2libGVbaV0pXHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHN0YXRlLnZpc2libGUubGVuZ3RoOyArK2kpIHtcclxuICAgICAgICAgICAgbWFwLnNlZW4uc2V0ZihpLCBzdGF0ZS5zZWVuW2ldKVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgbWFwLmZpeHR1cmVzLmxvYWQoZGIsIHN0YXRlLmZpeHR1cmVzKVxyXG4gICAgICAgIG1hcC5leGl0cy5sb2FkKGRiLCBzdGF0ZS5leGl0cylcclxuICAgICAgICBtYXAubW9uc3RlcnMubG9hZChkYiwgc3RhdGUubW9uc3RlcnMpXHJcbiAgICAgICAgbWFwLmNvbnRhaW5lcnMubG9hZChkYiwgc3RhdGUuY29udGFpbmVycylcclxuICAgICAgICBtYXAucGxheWVycy5sb2FkKGRiLCBzdGF0ZS5wbGF5ZXJzKVxyXG4gICAgICAgIG1hcC5saWdodGluZyA9IHN0YXRlLmxpZ2h0aW5nXHJcblxyXG4gICAgICAgIHJldHVybiBtYXBcclxuICAgIH1cclxufVxyXG5cclxuZXhwb3J0IGludGVyZmFjZSBNYXBTYXZlU3RhdGUge1xyXG4gICAgd2lkdGg6IG51bWJlcixcclxuICAgIGhlaWdodDogbnVtYmVyLFxyXG4gICAgdGlsZXM6IExheWVyU2F2ZVN0YXRlXHJcbiAgICB2aXNpYmxlOiBWaXNpYmlsaXR5W11cclxuICAgIHNlZW46IGJvb2xlYW5bXVxyXG4gICAgZml4dHVyZXM6IExheWVyU2F2ZVN0YXRlXHJcbiAgICBleGl0czogTGF5ZXJTYXZlU3RhdGVcclxuICAgIG1vbnN0ZXJzOiBMYXllclNhdmVTdGF0ZVxyXG4gICAgY29udGFpbmVyczogTGF5ZXJTYXZlU3RhdGVcclxuICAgIHBsYXllcnM6IExheWVyU2F2ZVN0YXRlXHJcbiAgICBsaWdodGluZzogTGlnaHRpbmdcclxufVxyXG5cclxuZnVuY3Rpb24gdHJhbnNmb3JtT2N0YW50KGNvb3JkczogZ2VvLlBvaW50LCBvY3RhbnQ6IG51bWJlcik6IGdlby5Qb2ludCB7XHJcbiAgICBzd2l0Y2ggKG9jdGFudCkge1xyXG4gICAgICAgIGNhc2UgMDogcmV0dXJuIG5ldyBnZW8uUG9pbnQoLWNvb3Jkcy54LCBjb29yZHMueSlcclxuICAgICAgICBjYXNlIDE6IHJldHVybiBuZXcgZ2VvLlBvaW50KC1jb29yZHMueSwgY29vcmRzLngpXHJcbiAgICAgICAgY2FzZSAyOiByZXR1cm4gbmV3IGdlby5Qb2ludChjb29yZHMueSwgY29vcmRzLngpXHJcbiAgICAgICAgY2FzZSAzOiByZXR1cm4gbmV3IGdlby5Qb2ludChjb29yZHMueCwgY29vcmRzLnkpXHJcbiAgICAgICAgY2FzZSA0OiByZXR1cm4gbmV3IGdlby5Qb2ludChjb29yZHMueCwgLWNvb3Jkcy55KVxyXG4gICAgICAgIGNhc2UgNTogcmV0dXJuIG5ldyBnZW8uUG9pbnQoY29vcmRzLnksIC1jb29yZHMueClcclxuICAgICAgICBjYXNlIDY6IHJldHVybiBuZXcgZ2VvLlBvaW50KC1jb29yZHMueSwgLWNvb3Jkcy54KVxyXG4gICAgICAgIGNhc2UgNzogcmV0dXJuIG5ldyBnZW8uUG9pbnQoLWNvb3Jkcy54LCAtY29vcmRzLnkpXHJcbiAgICB9XHJcblxyXG4gICAgdGhyb3cgbmV3IEVycm9yKFwiSW52YWxpZCBvY3RhbnQgLSBtdXN0IGJlIGluIGludGVydmFsIFswLCA4KVwiKVxyXG59XHJcblxyXG5mdW5jdGlvbiBpc1NoYWRvd2VkKHNoYWRvd3M6IGdlby5Qb2ludFtdLCBjb29yZHM6IGdlby5Qb2ludCk6IGJvb2xlYW4ge1xyXG4gICAgcmV0dXJuIGl0ZXIuYW55KHNoYWRvd3MsIHggPT4gc2hhZG93Q292ZXJzUG9pbnQoeCwgY29vcmRzKSlcclxufVxyXG5cclxuZnVuY3Rpb24gc2hhZG93Q292ZXJzUG9pbnQoc2hhZG93OiBnZW8uUG9pbnQsIGNvb3JkczogZ2VvLlBvaW50KTogYm9vbGVhbiB7XHJcbiAgICBpZiAoc2hhZG93LnggPT0gMCkge1xyXG4gICAgICAgIHJldHVybiBjb29yZHMueSA+IHNoYWRvdy55XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3Qgc3RhcnRYID0gc2hhZG93LnggLyAoc2hhZG93LnkgKyAxKSAqIGNvb3Jkcy55XHJcbiAgICBjb25zdCBlbmRYID0gKHNoYWRvdy54ICsgMSkgLyBzaGFkb3cueSAqIGNvb3Jkcy55XHJcblxyXG4gICAgcmV0dXJuIGNvb3Jkcy55ID4gc2hhZG93LnkgJiYgY29vcmRzLnggPiBzdGFydFggJiYgY29vcmRzLnggPCBlbmRYXHJcbn1cclxuXHJcblxyXG4vKipcclxuICogRmluZCBhIHBhdGggZnJvbSBzdGFydCB0byBnb2FsXHJcbiAqIEBwYXJhbSBtYXAgbWFwXHJcbiAqIEBwYXJhbSBzdGFydCBzdGFydCBjb29yZHNcclxuICogQHBhcmFtIGdvYWwgZ29hbCBjb29yZHNcclxuICogQHJldHVybnMgcGF0aCBmcm9tIHN0YXJ0IHRvIGdvYWwsIGluY2x1ZGluZyBnb2FsLCBidXQgbm90IHN0YXJ0aW5nIHBvc2l0aW9uXHJcbiAqL1xyXG5leHBvcnQgZnVuY3Rpb24gZmluZFBhdGgobWFwOiBNYXAsIHN0YXJ0OiBnZW8uUG9pbnQsIGdvYWw6IGdlby5Qb2ludCk6IEFycmF5PGdlby5Qb2ludD4ge1xyXG4gICAgaW50ZXJmYWNlIE5vZGUge1xyXG4gICAgICAgIGY6IG51bWJlclxyXG4gICAgICAgIGc6IG51bWJlclxyXG4gICAgICAgIGg6IG51bWJlclxyXG4gICAgICAgIHBhcmVudDogTm9kZSB8IG51bGxcclxuICAgICAgICBjb29yZHM6IGdlby5Qb2ludFxyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IG9wZW4gPSBuZXcgQXJyYXk8Tm9kZT4oKVxyXG4gICAgY29uc3QgY2xvc2VkID0gbmV3IEFycmF5PE5vZGU+KClcclxuXHJcbiAgICBvcGVuLnB1c2goeyBmOiAwLCBnOiAwLCBoOiAwLCBwYXJlbnQ6IG51bGwsIGNvb3Jkczogc3RhcnQgfSlcclxuXHJcbiAgICBjb25zdCBwb3BPcGVuID0gKCkgPT4ge1xyXG4gICAgICAgIC8vIHdhcm5pbmc6IGFzc3VtZXMgbm9uLWVtcHR5IVxyXG4gICAgICAgIGxldCBuID0gMFxyXG4gICAgICAgIG9wZW4uZm9yRWFjaCgoeCwgaSkgPT4ge1xyXG4gICAgICAgICAgICBpZiAoeC5mIDwgb3BlbltuXS5mKSB7XHJcbiAgICAgICAgICAgICAgICBuID0gaVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSlcclxuXHJcbiAgICAgICAgLy8gc3dhcCAmIHBvcFxyXG4gICAgICAgIGNvbnN0IHIgPSBvcGVuW25dXHJcblxyXG4gICAgICAgIGlmIChuIDwgb3Blbi5sZW5ndGggLSAxKSB7XHJcbiAgICAgICAgICAgIG9wZW5bbl0gPSBvcGVuW29wZW4ubGVuZ3RoIC0gMV1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIG9wZW4ucG9wKClcclxuXHJcbiAgICAgICAgcmV0dXJuIHJcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBhc3NlbWJsZVBhdGggPSAobm9kZTogTm9kZSB8IG51bGwpOiBBcnJheTxnZW8uUG9pbnQ+ID0+IHtcclxuICAgICAgICAvLyBwYXRoIGZvdW5kISBiYWNrdHJhY2sgYW5kIGFzc2VtYmxlIHBhdGhcclxuICAgICAgICBjb25zdCBwYXRoID0gbmV3IEFycmF5PGdlby5Qb2ludD4oKVxyXG5cclxuICAgICAgICB3aGlsZSAobm9kZSAmJiAhbm9kZS5jb29yZHMuZXF1YWwoc3RhcnQpKSB7XHJcbiAgICAgICAgICAgIHBhdGgucHVzaChub2RlLmNvb3JkcylcclxuICAgICAgICAgICAgbm9kZSA9IG5vZGUucGFyZW50XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gcGF0aC5yZXZlcnNlKClcclxuICAgIH1cclxuXHJcbiAgICB3aGlsZSAob3Blbi5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgY29uc3QgY3VyID0gcG9wT3BlbigpXHJcbiAgICAgICAgY2xvc2VkLnB1c2goY3VyKVxyXG5cclxuICAgICAgICBpZiAoY3VyLmNvb3Jkcy5lcXVhbChnb2FsKSkge1xyXG4gICAgICAgICAgICByZXR1cm4gYXNzZW1ibGVQYXRoKGN1cilcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGZvciAoY29uc3QgY29vcmRzIG9mIHZpc2l0TmVpZ2hib3JzKGN1ci5jb29yZHMsIG1hcC53aWR0aCwgbWFwLmhlaWdodCkpIHtcclxuICAgICAgICAgICAgaWYgKCFtYXAuaXNQYXNzYWJsZShjb29yZHMpICYmICFjb29yZHMuZXF1YWwoZ29hbCkpIHtcclxuICAgICAgICAgICAgICAgIGNvbnRpbnVlXHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGlmIChjbG9zZWQuZmluZCh4ID0+IGNvb3Jkcy5lcXVhbCh4LmNvb3JkcykpKSB7XHJcbiAgICAgICAgICAgICAgICBjb250aW51ZVxyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBjb25zdCBnID0gY3VyLmcgKyAxXHJcbiAgICAgICAgICAgIGNvbnN0IGggPSBnZW8uY2FsY01hbmhhdHRlbkRpc3QoZ29hbCwgY29vcmRzKVxyXG4gICAgICAgICAgICBjb25zdCBmID0gZyArIGhcclxuXHJcbiAgICAgICAgICAgIC8vIGRvZXMgdGhpcyBub2RlIGFscmVhZHkgZXhpc3QgaW4gb3BlbiBsaXN0P1xyXG4gICAgICAgICAgICBjb25zdCBvcGVuTm9kZSA9IG9wZW4uZmluZCh4ID0+IGNvb3Jkcy5lcXVhbCh4LmNvb3JkcykpXHJcbiAgICAgICAgICAgIGlmIChvcGVuTm9kZSAhPSBudWxsICYmIG9wZW5Ob2RlLmcgPD0gZykge1xyXG4gICAgICAgICAgICAgICAgY29udGludWVcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgLy8gcGxhY2UgaW4gb3BlbiBsaXN0XHJcbiAgICAgICAgICAgIG9wZW4ucHVzaCh7IGc6IGcsIGg6IGgsIGY6IGYsIHBhcmVudDogY3VyLCBjb29yZHM6IGNvb3JkcyB9KVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gbmV3IEFycmF5PGdlby5Qb2ludD4oKTtcclxufVxyXG5cclxuZnVuY3Rpb24qIHZpc2l0TmVpZ2hib3JzKHB0OiBnZW8uUG9pbnQsIHdpZHRoOiBudW1iZXIsIGhlaWdodDogbnVtYmVyKTogSXRlcmFibGU8Z2VvLlBvaW50PiB7XHJcbiAgICBpZiAocHQueCA8IDAgfHwgcHQueSA8IDAgfHwgcHQueCA+PSB3aWR0aCB8fCBwdC55ID49IGhlaWdodCkge1xyXG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcInB0IGlzIG91dCBvZiBib3VuZHNcIilcclxuICAgIH1cclxuXHJcbiAgICAvLyB3XHJcbiAgICBpZiAocHQueCA+IDApIHtcclxuICAgICAgICBjb25zdCB3ID0gbmV3IGdlby5Qb2ludChwdC54IC0gMSwgcHQueSlcclxuICAgICAgICB5aWVsZCB3XHJcbiAgICB9XHJcblxyXG4gICAgLy8gc1xyXG4gICAgaWYgKHB0LnkgPCBoZWlnaHQgLSAxKSB7XHJcbiAgICAgICAgY29uc3QgcyA9IG5ldyBnZW8uUG9pbnQocHQueCwgcHQueSArIDEpXHJcbiAgICAgICAgeWllbGQgc1xyXG4gICAgfVxyXG5cclxuICAgIC8vIGVcclxuICAgIGlmIChwdC54IDwgd2lkdGggLSAxKSB7XHJcbiAgICAgICAgY29uc3QgZSA9IG5ldyBnZW8uUG9pbnQocHQueCArIDEsIHB0LnkpXHJcbiAgICAgICAgeWllbGQgZVxyXG4gICAgfVxyXG5cclxuICAgIC8vIG5cclxuICAgIGlmIChwdC55ID4gMCkge1xyXG4gICAgICAgIGNvbnN0IG4gPSBuZXcgZ2VvLlBvaW50KHB0LngsIHB0LnkgLSAxKVxyXG4gICAgICAgIHlpZWxkIG5cclxuICAgIH1cclxufVxyXG4iXX0=