import * as geo from "../shared/geo2d.js";
import * as iter from "../shared/iter.js";
import * as rl from "./rl.js";
import * as grid from "../shared/grid.js";
/**
 * a layer that is based on a set
 * works well for sparse layers
 */
export class MapLayer {
    constructor() {
        this.map = new window.Map();
    }
    set(position, thing) {
        position = position.clone();
        this.map.set(thing, { thing, position });
    }
    delete(thing) {
        this.map.delete(thing);
    }
    has(thing) {
        return this.map.has(thing);
    }
    at(position) {
        for (const pth of this.map.values()) {
            if (pth.position.equal(position)) {
                return pth.thing;
            }
        }
        return undefined;
    }
    where(thing) {
        var _a, _b;
        return (_b = (_a = this.map.get(thing)) === null || _a === void 0 ? void 0 : _a.position) === null || _b === void 0 ? void 0 : _b.clone();
    }
    *within(aabb) {
        for (const pth of this.map.values()) {
            if (aabb.contains(pth.position)) {
                yield pth;
            }
        }
    }
    get size() {
        return this.map.size;
    }
    *[Symbol.iterator]() {
        for (const value of this.map.values()) {
            yield value;
        }
    }
    *things() {
        for (const th of this.map.keys()) {
            yield th;
        }
    }
    *thingsWithin(aabb) {
        for (const pth of this.within(aabb)) {
            yield pth.thing;
        }
    }
}
/**
 * a layer that is based on a grid
 * works well for dense layers
 */
export class GridLayer {
    constructor(width, height) {
        this.map = new MapLayer();
        this.grd = grid.generate(width, height, () => undefined);
    }
    get width() {
        return this.grd.width;
    }
    get height() {
        return this.grd.height;
    }
    set(position, thing) {
        // remove from grid if already present
        const oldPosition = this.map.where(thing);
        if (oldPosition) {
            this.grd.setPoint(oldPosition, undefined);
        }
        this.grd.setPoint(position, thing);
        this.map.set(position, thing);
    }
    delete(thing) {
        const pos = this.map.where(thing);
        if (!pos) {
            return;
        }
        this.grd.setPoint(pos, undefined);
        this.map.delete(thing);
    }
    has(item) {
        return this.map.has(item);
    }
    at(position) {
        return this.grd.atPoint(position);
    }
    where(thing) {
        return this.map.where(thing);
    }
    *within(aabb) {
        for (const [thing, x, y] of this.grd.scanAABB(aabb)) {
            if (!thing) {
                continue;
            }
            yield {
                position: new geo.Point(x, y),
                thing,
            };
        }
    }
    *thingsWithin(aabb) {
        for (const pth of this.within(aabb)) {
            yield pth.thing;
        }
    }
    get size() {
        return this.map.size;
    }
    *[Symbol.iterator]() {
        for (const value of this.map) {
            yield value;
        }
    }
    things() {
        return this.map.things();
    }
}
export var Lighting;
(function (Lighting) {
    Lighting[Lighting["None"] = 0] = "None";
    Lighting[Lighting["Ambient"] = 1] = "Ambient";
})(Lighting || (Lighting = {}));
/**
 * components of a generated map area
 */
export class Map {
    constructor(width, height, depth, player) {
        this.width = width;
        this.height = height;
        this.depth = depth;
        this.player = player;
        this.lighting = Lighting.None;
        this.tiles = new GridLayer(width, height);
        this.fixtures = new MapLayer();
        this.exits = new MapLayer();
        this.monsters = new MapLayer();
        this.containers = new MapLayer();
    }
    /**
      * iterate over all things in map
    */
    *[Symbol.iterator]() {
        for (const tile of this.tiles) {
            yield tile;
        }
        for (const fixture of this.fixtures) {
            yield fixture;
        }
        for (const exit of this.exits) {
            yield exit;
        }
        for (const container of this.containers) {
            yield container;
        }
        for (const monster of this.monsters) {
            yield monster;
        }
        yield this.player;
    }
    /**
     * iterate over all things in map
   */
    *things() {
        for (const pth of this) {
            yield pth.thing;
        }
    }
    tileAt(xy) {
        return this.tiles.at(xy);
    }
    fixtureAt(xy) {
        return this.fixtures.at(xy);
    }
    containerAt(xy) {
        return this.containers.at(xy);
    }
    monsterAt(xy) {
        return this.monsters.at(xy);
    }
    *at(xy) {
        const fixture = this.fixtureAt(xy);
        if (fixture) {
            yield fixture;
        }
        const tile = this.tileAt(xy);
        if (tile) {
            yield tile;
        }
        const container = this.containerAt(xy);
        if (container) {
            yield container;
        }
        const monster = this.monsterAt(xy);
        if (monster) {
            yield monster;
        }
        if (this.player.position.equal(xy)) {
            yield this.player.thing;
        }
    }
    inBounds(xy) {
        return xy.x >= 0 && xy.x < this.width && xy.y >= 0 && xy.y < this.height;
    }
    isPassable(position) {
        return this.inBounds(position) && iter.all(this.at(position), th => th.passable);
    }
}
function resetVisibility(map) {
    for (const th of map) {
        if (th.thing.visible === rl.Visibility.Visible) {
            th.thing.visible = rl.Visibility.Fog;
        }
    }
    for (const monster of map.monsters) {
        monster.thing.visible = rl.Visibility.None;
    }
    map.player.thing.visible = rl.Visibility.Visible;
}
export function updateVisibility(map, radius) {
    resetVisibility(map);
    const eye = map.player.position;
    for (let i = 0; i < 8; ++i) {
        updateVisibilityOctant(map, eye, radius, i);
    }
    // eye point always visible
    iter.each(map.at(eye), th => th.visible = rl.Visibility.Visible);
}
function updateVisibilityOctant(map, eye, radius, octant) {
    const shadows = [];
    for (let y = 1; y <= radius; ++y) {
        for (let x = 0; x <= y; ++x) {
            const octantPoint = new geo.Point(x, y);
            const mapPoint = transformOctant(octantPoint, octant).addPoint(eye);
            if (!map.inBounds(mapPoint)) {
                continue;
            }
            if (isShadowed(shadows, octantPoint)) {
                continue;
            }
            const opaque = iter.any(map.at(mapPoint), th => !th.transparent);
            if (opaque) {
                shadows.push(octantPoint);
            }
            if (geo.calcManhattenDist(mapPoint, eye) > radius) {
                continue;
            }
            for (const th of map.at(mapPoint)) {
                th.visible = rl.Visibility.Visible;
            }
        }
    }
}
function transformOctant(coords, octant) {
    switch (octant) {
        case 0: return new geo.Point(-coords.x, coords.y);
        case 1: return new geo.Point(-coords.y, coords.x);
        case 2: return new geo.Point(coords.y, coords.x);
        case 3: return new geo.Point(coords.x, coords.y);
        case 4: return new geo.Point(coords.x, -coords.y);
        case 5: return new geo.Point(coords.y, -coords.x);
        case 6: return new geo.Point(-coords.y, -coords.x);
        case 7: return new geo.Point(-coords.x, -coords.y);
    }
    throw new Error("Invalid octant - must be in interval [0, 8)");
}
function isShadowed(shadows, coords) {
    return iter.any(shadows, x => shadowCoversPoint(x, coords));
}
function shadowCoversPoint(shadow, coords) {
    if (shadow.x == 0) {
        return coords.y > shadow.y;
    }
    const startX = shadow.x / (shadow.y + 1) * coords.y;
    const endX = (shadow.x + 1) / shadow.y * coords.y;
    return coords.y > shadow.y && coords.x > startX && coords.x < endX;
}
/**
 * Find a path from start to goal
 * @param map map
 * @param start start coords
 * @param goal goal coords
 * @returns path from start to goal, including goal, but not starting position
 */
export function findPath(map, start, goal) {
    const open = new Array();
    const closed = new Array();
    open.push({ f: 0, g: 0, h: 0, parent: null, coords: start });
    const popOpen = () => {
        // warning: assumes non-empty!
        let n = 0;
        open.forEach((x, i) => {
            if (x.f < open[n].f) {
                n = i;
            }
        });
        // swap & pop
        const r = open[n];
        if (n < open.length - 1) {
            open[n] = open[open.length - 1];
        }
        open.pop();
        return r;
    };
    const assemblePath = (node) => {
        // path found! backtrack and assemble path
        const path = new Array();
        while (node && !node.coords.equal(start)) {
            path.push(node.coords);
            node = node.parent;
        }
        return path.reverse();
    };
    while (open.length > 0) {
        const cur = popOpen();
        closed.push(cur);
        if (cur.coords.equal(goal)) {
            return assemblePath(cur);
        }
        for (const coords of visitNeighbors(cur.coords, map.width, map.height)) {
            if (!map.isPassable(coords) && !coords.equal(goal)) {
                continue;
            }
            if (closed.find(x => coords.equal(x.coords))) {
                continue;
            }
            const g = cur.g + 1;
            const h = geo.calcManhattenDist(goal, coords);
            const f = g + h;
            // does this node already exist in open list?
            const openNode = open.find(x => coords.equal(x.coords));
            if (openNode != null && openNode.g <= g) {
                continue;
            }
            // place in open list
            open.push({ g: g, h: h, f: f, parent: cur, coords: coords });
        }
    }
    return new Array();
}
function* visitNeighbors(pt, width, height) {
    if (pt.x < 0 || pt.y < 0 || pt.x >= width || pt.y >= height) {
        throw new Error("pt is out of bounds");
    }
    // w
    if (pt.x > 0) {
        const w = new geo.Point(pt.x - 1, pt.y);
        yield w;
    }
    // s
    if (pt.y < height - 1) {
        const s = new geo.Point(pt.x, pt.y + 1);
        yield s;
    }
    // e
    if (pt.x < width - 1) {
        const e = new geo.Point(pt.x + 1, pt.y);
        yield e;
    }
    // n
    if (pt.y > 0) {
        const n = new geo.Point(pt.x, pt.y - 1);
        yield n;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFwcy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIm1hcHMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxLQUFLLEdBQUcsTUFBTSxvQkFBb0IsQ0FBQTtBQUN6QyxPQUFPLEtBQUssSUFBSSxNQUFNLG1CQUFtQixDQUFBO0FBQ3pDLE9BQU8sS0FBSyxFQUFFLE1BQU0sU0FBUyxDQUFBO0FBQzdCLE9BQU8sS0FBSyxJQUFJLE1BQU0sbUJBQW1CLENBQUE7QUEyQnpDOzs7R0FHRztBQUNILE1BQU0sT0FBTyxRQUFRO0lBQXJCO1FBQ3FCLFFBQUcsR0FBRyxJQUFJLE1BQU0sQ0FBQyxHQUFHLEVBQWdCLENBQUE7SUEwRHpELENBQUM7SUF4REcsR0FBRyxDQUFDLFFBQW1CLEVBQUUsS0FBUTtRQUM3QixRQUFRLEdBQUcsUUFBUSxDQUFDLEtBQUssRUFBRSxDQUFBO1FBQzNCLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLEtBQUssRUFBRSxFQUFFLEtBQUssRUFBRSxRQUFRLEVBQUUsQ0FBQyxDQUFBO0lBQzVDLENBQUM7SUFFRCxNQUFNLENBQUMsS0FBUTtRQUNYLElBQUksQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFBO0lBQzFCLENBQUM7SUFFRCxHQUFHLENBQUMsS0FBUTtRQUNSLE9BQU8sSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLENBQUE7SUFDOUIsQ0FBQztJQUVELEVBQUUsQ0FBQyxRQUFtQjtRQUNsQixLQUFLLE1BQU0sR0FBRyxJQUFJLElBQUksQ0FBQyxHQUFHLENBQUMsTUFBTSxFQUFFLEVBQUU7WUFDakMsSUFBSSxHQUFHLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsRUFBRTtnQkFDOUIsT0FBTyxHQUFHLENBQUMsS0FBSyxDQUFBO2FBQ25CO1NBQ0o7UUFFRCxPQUFPLFNBQVMsQ0FBQTtJQUNwQixDQUFDO0lBRUQsS0FBSyxDQUFDLEtB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QUMsRUFBRTtRQUNWLE1BQU0sQ0FBQyxHQUFHLElBQUksR0FBRyxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUMsQ0FBQyxHQUFHLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUE7UUFDdkMsTUFBTSxDQUFDLENBQUE7S0FDVjtJQUVELElBQUk7SUFDSixJQUFJLEVBQUUsQ0FBQyxDQUFDLEdBQUcsTUFBTSxHQUFHLENBQUMsRUFBRTtRQUNuQixNQUFNLENBQUMsR0FBRyxJQUFJLEdBQUcsQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFBO1FBQ3ZDLE1BQU0sQ0FBQyxDQUFBO0tBQ1Y7SUFFRCxJQUFJO0lBQ0osSUFBSSxFQUFFLENBQUMsQ0FBQyxHQUFHLEtBQUssR0FBRyxDQUFDLEVBQUU7UUFDbEIsTUFBTSxDQUFDLEdBQUcsSUFBSSxHQUFHLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQTtRQUN2QyxNQUFNLENBQUMsQ0FBQTtLQUNWO0lBRUQsSUFBSTtJQUNKLElBQUksRUFBRSxDQUFDLENBQUMsR0FBRyxDQUFDLEVBQUU7UUFDVixNQUFNLENBQUMsR0FBRyxJQUFJLEdBQUcsQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFBO1FBQ3ZDLE1BQU0sQ0FBQyxDQUFBO0tBQ1Y7QUFDTCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgZ2VvIGZyb20gXCIuLi9zaGFyZWQvZ2VvMmQuanNcIlxyXG5pbXBvcnQgKiBhcyBpdGVyIGZyb20gXCIuLi9zaGFyZWQvaXRlci5qc1wiXHJcbmltcG9ydCAqIGFzIHJsIGZyb20gXCIuL3JsLmpzXCJcclxuaW1wb3J0ICogYXMgZ3JpZCBmcm9tIFwiLi4vc2hhcmVkL2dyaWQuanNcIlxyXG5cclxuZXhwb3J0IGludGVyZmFjZSBQbGFjZWQ8VCBleHRlbmRzIHJsLlRoaW5nPiB7XHJcbiAgICB0aGluZzogVCxcclxuICAgIHBvc2l0aW9uOiBnZW8uUG9pbnQsXHJcbn1cclxuXHJcbi8qKlxyXG4gKiBhIGxheWVyIG9mIHRoaW5ncyBvbiBhIG1hcFxyXG4gKi9cclxuZXhwb3J0IGludGVyZmFjZSBMYXllcjxUIGV4dGVuZHMgcmwuVGhpbmc+IHtcclxuICAgIHNldChwb3NpdGlvbjogZ2VvLlBvaW50LCB0aGluZzogVCk6IHZvaWRcclxuICAgIGRlbGV0ZSh0aGluZzogVCk6IHZvaWRcclxuICAgIGhhcyh0aGluZzogVCk6IGJvb2xlYW5cclxuICAgIGF0KHBvc2l0aW9uOiBnZW8uUG9pbnQpOiBUIHwgdW5kZWZpbmVkXHJcbiAgICB3aXRoaW4oYWFiYjogZ2VvLkFBQkIpOiBHZW5lcmF0b3I8UGxhY2VkPFQ+PixcclxuICAgIHRoaW5nc1dpdGhpbihhYWJiOiBnZW8uQUFCQik6IEdlbmVyYXRvcjxUPixcclxuICAgIHdoZXJlKHRoaW5nOiBUKTogZ2VvLlBvaW50IHwgdW5kZWZpbmVkLFxyXG4gICAgc2l6ZTogbnVtYmVyXHJcbiAgICBbU3ltYm9sLml0ZXJhdG9yXSgpOiBHZW5lcmF0b3I8UGxhY2VkPFQ+PlxyXG4gICAgdGhpbmdzKCk6IEdlbmVyYXRvcjxUPlxyXG59XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIExheWVyU2F2ZVN0YXRlIHtcclxuXHJcbn1cclxuXHJcbi8qKlxyXG4gKiBhIGxheWVyIHRoYXQgaXMgYmFzZWQgb24gYSBzZXRcclxuICogd29ya3Mgd2VsbCBmb3Igc3BhcnNlIGxheWVyc1xyXG4gKi9cclxuZXhwb3J0IGNsYXNzIE1hcExheWVyPFQgZXh0ZW5kcyBybC5UaGluZz4gaW1wbGVtZW50cyBMYXllcjxUPiB7XHJcbiAgICBwcml2YXRlIHJlYWRvbmx5IG1hcCA9IG5ldyB3aW5kb3cuTWFwPFQsIFBsYWNlZDxUPj4oKVxyXG5cclxuICAgIHNldChwb3NpdGlvbjogZ2VvLlBvaW50LCB0aGluZzogVCk6IHZvaWQge1xyXG4gICAgICAgIHBvc2l0aW9uID0gcG9zaXRpb24uY2xvbmUoKVxyXG4gICAgICAgIHRoaXMubWFwLnNldCh0aGluZywgeyB0aGluZywgcG9zaXRpb24gfSlcclxuICAgIH1cclxuXHJcbiAgICBkZWxldGUodGhpbmc6IFQpOiB2b2lkIHtcclxuICAgICAgICB0aGlzLm1hcC5kZWxldGUodGhpbmcpXHJcbiAgICB9XHJcblxyXG4gICAgaGFzKHRoaW5nOiBUKTogYm9vbGVhbiB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMubWFwLmhhcyh0aGluZylcclxuICAgIH1cclxuXHJcbiAgICBhdChwb3NpdGlvbjogZ2VvLlBvaW50KTogVCB8IHVuZGVmaW5lZCB7XHJcbiAgICAgICAgZm9yIChjb25zdCBwdGggb2YgdGhpcy5tYXAudmFsdWVzKCkpIHtcclxuICAgICAgICAgICAgaWYgKHB0aC5wb3NpdGlvbi5lcXVhbChwb3NpdGlvbikpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBwdGgudGhpbmdcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIHVuZGVmaW5lZFxyXG4gICAgfVxyXG5cclxuICAgIHdoZXJlKHRoaW5nOiBUKTogZ2VvLlBvaW50IHwgdW5kZWZpbmVkIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5tYXAuZ2V0KHRoaW5nKT8ucG9zaXRpb24/LmNsb25lKClcclxuICAgIH1cclxuXHJcbiAgICAqd2l0aGluKGFhYmI6IGdlby5BQUJCKTogR2VuZXJhdG9yPFBsYWNlZDxUPj4ge1xyXG4gICAgICAgIGZvciAoY29uc3QgcHRoIG9mIHRoaXMubWFwLnZhbHVlcygpKSB7XHJcbiAgICAgICAgICAgIGlmIChhYWJiLmNvbnRhaW5zKHB0aC5wb3NpdGlvbikpIHtcclxuICAgICAgICAgICAgICAgIHlpZWxkIHB0aFxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGdldCBzaXplKCkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLm1hcC5zaXplXHJcbiAgICB9XHJcblxyXG4gICAgKltTeW1ib2wuaXRlcmF0b3JdKCk6IEdlbmVyYXRvcjxQbGFjZWQ8VD4+IHtcclxuICAgICAgICBmb3IgKGNvbnN0IHZhbHVlIG9mIHRoaXMubWFwLnZhbHVlcygpKSB7XHJcbiAgICAgICAgICAgIHlpZWxkIHZhbHVlXHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgICp0aGluZ3MoKTogR2VuZXJhdG9yPFQ+IHtcclxuICAgICAgICBmb3IgKGNvbnN0IHRoIG9mIHRoaXMubWFwLmtleXMoKSkge1xyXG4gICAgICAgICAgICB5aWVsZCB0aFxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAqdGhpbmdzV2l0aGluKGFhYmI6IGdlby5BQUJCKTogR2VuZXJhdG9yPFQ+IHtcclxuICAgICAgICBmb3IgKGNvbnN0IHB0aCBvZiB0aGlzLndpdGhpbihhYWJiKSkge1xyXG4gICAgICAgICAgICB5aWVsZCBwdGgudGhpbmdcclxuICAgICAgICB9XHJcbiAgICB9XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBhIGxheWVyIHRoYXQgaXMgYmFzZWQgb24gYSBncmlkXHJcbiAqIHdvcmtzIHdlbGwgZm9yIGRlbnNlIGxheWVyc1xyXG4gKi9cclxuZXhwb3J0IGNsYXNzIEdyaWRMYXllcjxUIGV4dGVuZHMgcmwuVGhpbmc+IGltcGxlbWVudHMgTGF5ZXI8VD4ge1xyXG4gICAgcHJpdmF0ZSByZWFkb25seSBtYXAgPSBuZXcgTWFwTGF5ZXI8VD4oKVxyXG4gICAgcHJpdmF0ZSByZWFkb25seSBncmQ6IGdyaWQuR3JpZDxUIHwgdW5kZWZpbmVkPlxyXG5cclxuICAgIGNvbnN0cnVjdG9yKHdpZHRoOiBudW1iZXIsIGhlaWdodDogbnVtYmVyKSB7XHJcbiAgICAgICAgdGhpcy5ncmQgPSBncmlkLmdlbmVyYXRlKHdpZHRoLCBoZWlnaHQsICgpID0+IHVuZGVmaW5lZClcclxuICAgIH1cclxuXHJcbiAgICBnZXQgd2lkdGgoKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuZ3JkLndpZHRoXHJcbiAgICB9XHJcblxyXG4gICAgZ2V0IGhlaWdodCgpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5ncmQuaGVpZ2h0XHJcbiAgICB9XHJcblxyXG4gICAgc2V0KHBvc2l0aW9uOiBnZW8uUG9pbnQsIHRoaW5nOiBUKTogdm9pZCB7XHJcbiAgICAgICAgLy8gcmVtb3ZlIGZyb20gZ3JpZCBpZiBhbHJlYWR5IHByZXNlbnRcclxuICAgICAgICBjb25zdCBvbGRQb3NpdGlvbiA9IHRoaXMubWFwLndoZXJlKHRoaW5nKVxyXG4gICAgICAgIGlmIChvbGRQb3NpdGlvbikge1xyXG4gICAgICAgICAgICB0aGlzLmdyZC5zZXRQb2ludChvbGRQb3NpdGlvbiwgdW5kZWZpbmVkKVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgdGhpcy5ncmQuc2V0UG9pbnQocG9zaXRpb24sIHRoaW5nKVxyXG4gICAgICAgIHRoaXMubWFwLnNldChwb3NpdGlvbiwgdGhpbmcpXHJcbiAgICB9XHJcblxyXG4gICAgZGVsZXRlKHRoaW5nOiBUKTogdm9pZCB7XHJcbiAgICAgICAgY29uc3QgcG9zID0gdGhpcy5tYXAud2hlcmUodGhpbmcpXHJcbiAgICAgICAgaWYgKCFwb3MpIHtcclxuICAgICAgICAgICAgcmV0dXJuXHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB0aGlzLmdyZC5zZXRQb2ludChwb3MsIHVuZGVmaW5lZClcclxuICAgICAgICB0aGlzLm1hcC5kZWxldGUodGhpbmcpXHJcbiAgICB9XHJcblxyXG4gICAgaGFzKGl0ZW06IFQpOiBib29sZWFuIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5tYXAuaGFzKGl0ZW0pXHJcbiAgICB9XHJcblxyXG4gICAgYXQocG9zaXRpb246IGdlby5Qb2ludCk6IFQgfCB1bmRlZmluZWQge1xyXG4gICAgICAgIHJldHVybiB0aGlzLmdyZC5hdFBvaW50KHBvc2l0aW9uKVxyXG4gICAgfVxyXG5cclxuICAgIHdoZXJlKHRoaW5nOiBUKTogZ2VvLlBvaW50IHwgdW5kZWZpbmVkIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5tYXAud2hlcmUodGhpbmcpXHJcbiAgICB9XHJcblxyXG4gICAgKndpdGhpbihhYWJiOiBnZW8uQUFCQik6IEdlbmVyYXRvcjxQbGFjZWQ8VD4+IHtcclxuICAgICAgICBmb3IgKGNvbnN0IFt0aGluZywgeCwgeV0gb2YgdGhpcy5ncmQuc2NhbkFBQkIoYWFiYikpIHtcclxuICAgICAgICAgICAgaWYgKCF0aGluZykge1xyXG4gICAgICAgICAgICAgICAgY29udGludWVcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgeWllbGQge1xyXG4gICAgICAgICAgICAgICAgcG9zaXRpb246IG5ldyBnZW8uUG9pbnQoeCwgeSksXHJcbiAgICAgICAgICAgICAgICB0aGluZyxcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAqdGhpbmdzV2l0aGluKGFhYmI6IGdlby5BQUJCKTogR2VuZXJhdG9yPFQ+IHtcclxuICAgICAgICBmb3IgKGNvbnN0IHB0aCBvZiB0aGlzLndpdGhpbihhYWJiKSkge1xyXG4gICAgICAgICAgICB5aWVsZCBwdGgudGhpbmdcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0IHNpemUoKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMubWFwLnNpemVcclxuICAgIH1cclxuXHJcbiAgICAqW1N5bWJvbC5pdGVyYXRvcl0oKTogR2VuZXJhdG9yPFBsYWNlZDxUPj4ge1xyXG4gICAgICAgIGZvciAoY29uc3QgdmFsdWUgb2YgdGhpcy5tYXApIHtcclxuICAgICAgICAgICAgeWllbGQgdmFsdWVcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgdGhpbmdzKCk6IEdlbmVyYXRvcjxUPiB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMubWFwLnRoaW5ncygpXHJcbiAgICB9XHJcbn1cclxuXHJcbmV4cG9ydCBlbnVtIExpZ2h0aW5nIHtcclxuICAgIE5vbmUsXHJcbiAgICBBbWJpZW50LFxyXG59XHJcblxyXG4vKipcclxuICogY29tcG9uZW50cyBvZiBhIGdlbmVyYXRlZCBtYXAgYXJlYVxyXG4gKi9cclxuZXhwb3J0IGNsYXNzIE1hcCB7XHJcbiAgICB0aWxlczogTGF5ZXI8cmwuVGlsZT5cclxuICAgIGZpeHR1cmVzOiBMYXllcjxybC5GaXh0dXJlPlxyXG4gICAgZXhpdHM6IExheWVyPHJsLkV4aXQ+XHJcbiAgICBtb25zdGVyczogTGF5ZXI8cmwuTW9uc3Rlcj5cclxuICAgIGNvbnRhaW5lcnM6IExheWVyPHJsLkNvbnRhaW5lcj5cclxuICAgIGxpZ2h0aW5nOiBMaWdodGluZyA9IExpZ2h0aW5nLk5vbmVcclxuXHJcbiAgICBjb25zdHJ1Y3RvcihyZWFkb25seSB3aWR0aDogbnVtYmVyLCByZWFkb25seSBoZWlnaHQ6IG51bWJlciwgcmVhZG9ubHkgZGVwdGg6IG51bWJlciwgcmVhZG9ubHkgcGxheWVyOiBQbGFjZWQ8cmwuUGxheWVyPikge1xyXG4gICAgICAgIHRoaXMudGlsZXMgPSBuZXcgR3JpZExheWVyKHdpZHRoLCBoZWlnaHQpXHJcbiAgICAgICAgdGhpcy5maXh0dXJlcyA9IG5ldyBNYXBMYXllcigpXHJcbiAgICAgICAgdGhpcy5leGl0cyA9IG5ldyBNYXBMYXllcigpXHJcbiAgICAgICAgdGhpcy5tb25zdGVycyA9IG5ldyBNYXBMYXllcigpXHJcbiAgICAgICAgdGhpcy5jb250YWluZXJzID0gbmV3IE1hcExheWVyKClcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAgKiBpdGVyYXRlIG92ZXIgYWxsIHRoaW5ncyBpbiBtYXBcclxuICAgICovXHJcbiAgICBwdWJsaWMgKltTeW1ib2wuaXRlcmF0b3JdKCk6IEdlbmVyYXRvcjxQbGFjZWQ8cmwuVGhpbmc+PiB7XHJcbiAgICAgICAgZm9yIChjb25zdCB0aWxlIG9mIHRoaXMudGlsZXMpIHtcclxuICAgICAgICAgICAgeWllbGQgdGlsZVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgZm9yIChjb25zdCBmaXh0dXJlIG9mIHRoaXMuZml4dHVyZXMpIHtcclxuICAgICAgICAgICAgeWllbGQgZml4dHVyZVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgZm9yIChjb25zdCBleGl0IG9mIHRoaXMuZXhpdHMpIHtcclxuICAgICAgICAgICAgeWllbGQgZXhpdFxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgZm9yIChjb25zdCBjb250YWluZXIgb2YgdGhpcy5jb250YWluZXJzKSB7XHJcbiAgICAgICAgICAgIHlpZWxkIGNvbnRhaW5lclxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgZm9yIChjb25zdCBtb25zdGVyIG9mIHRoaXMubW9uc3RlcnMpIHtcclxuICAgICAgICAgICAgeWllbGQgbW9uc3RlclxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgeWllbGQgdGhpcy5wbGF5ZXJcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIGl0ZXJhdGUgb3ZlciBhbGwgdGhpbmdzIGluIG1hcFxyXG4gICAqL1xyXG4gICAgcHVibGljICp0aGluZ3MoKTogR2VuZXJhdG9yPHJsLlRoaW5nPiB7XHJcbiAgICAgICAgZm9yIChjb25zdCBwdGggb2YgdGhpcykge1xyXG4gICAgICAgICAgICB5aWVsZCBwdGgudGhpbmdcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgdGlsZUF0KHh5OiBnZW8uUG9pbnQpOiBybC5UaWxlIHwgdW5kZWZpbmVkIHtcclxuICAgICAgICByZXR1cm4gdGhpcy50aWxlcy5hdCh4eSlcclxuICAgIH1cclxuXHJcbiAgICBmaXh0dXJlQXQoeHk6IGdlby5Qb2ludCk6IHJsLkZpeHR1cmUgfCB1bmRlZmluZWQge1xyXG4gICAgICAgIHJldHVybiB0aGlzLmZpeHR1cmVzLmF0KHh5KVxyXG4gICAgfVxyXG5cclxuICAgIGNvbnRhaW5lckF0KHh5OiBnZW8uUG9pbnQpOiBybC5Db250YWluZXIgfCB1bmRlZmluZWQge1xyXG4gICAgICAgIHJldHVybiB0aGlzLmNvbnRhaW5lcnMuYXQoeHkpXHJcbiAgICB9XHJcblxyXG4gICAgbW9uc3RlckF0KHh5OiBnZW8uUG9pbnQpOiBybC5Nb25zdGVyIHwgdW5kZWZpbmVkIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5tb25zdGVycy5hdCh4eSlcclxuICAgIH1cclxuXHJcbiAgICAqYXQoeHk6IGdlby5Qb2ludCk6IEdlbmVyYXRvcjxybC5Nb25zdGVyIHwgcmwuRml4dHVyZSB8IHJsLlRpbGU+IHtcclxuICAgICAgICBjb25zdCBmaXh0dXJlID0gdGhpcy5maXh0dXJlQXQoeHkpXHJcbiAgICAgICAgaWYgKGZpeHR1cmUpIHtcclxuICAgICAgICAgICAgeWllbGQgZml4dHVyZVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgY29uc3QgdGlsZSA9IHRoaXMudGlsZUF0KHh5KVxyXG4gICAgICAgIGlmICh0aWxlKSB7XHJcbiAgICAgICAgICAgIHlpZWxkIHRpbGVcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGNvbnN0IGNvbnRhaW5lciA9IHRoaXMuY29udGFpbmVyQXQoeHkpXHJcbiAgICAgICAgaWYgKGNvbnRhaW5lcikge1xyXG4gICAgICAgICAgICB5aWVsZCBjb250YWluZXJcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGNvbnN0IG1vbnN0ZXIgPSB0aGlzLm1vbnN0ZXJBdCh4eSlcclxuICAgICAgICBpZiAobW9uc3Rlcikge1xyXG4gICAgICAgICAgICB5aWVsZCBtb25zdGVyXHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAodGhpcy5wbGF5ZXIucG9zaXRpb24uZXF1YWwoeHkpKSB7XHJcbiAgICAgICAgICAgIHlpZWxkIHRoaXMucGxheWVyLnRoaW5nXHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGluQm91bmRzKHh5OiBnZW8uUG9pbnQpOiBib29sZWFuIHtcclxuICAgICAgICByZXR1cm4geHkueCA+PSAwICYmIHh5LnggPCB0aGlzLndpZHRoICYmIHh5LnkgPj0gMCAmJiB4eS55IDwgdGhpcy5oZWlnaHRcclxuICAgIH1cclxuXHJcbiAgICBpc1Bhc3NhYmxlKHBvc2l0aW9uOiBnZW8uUG9pbnQpOiBib29sZWFuIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5pbkJvdW5kcyhwb3NpdGlvbikgJiYgaXRlci5hbGwodGhpcy5hdChwb3NpdGlvbiksIHRoID0+IHRoLnBhc3NhYmxlKVxyXG4gICAgfVxyXG59XHJcblxyXG5mdW5jdGlvbiByZXNldFZpc2liaWxpdHkobWFwOiBNYXApIHtcclxuICAgIGZvciAoY29uc3QgdGggb2YgbWFwKSB7XHJcbiAgICAgICAgaWYgKHRoLnRoaW5nLnZpc2libGUgPT09IHJsLlZpc2liaWxpdHkuVmlzaWJsZSkge1xyXG4gICAgICAgICAgICB0aC50aGluZy52aXNpYmxlID0gcmwuVmlzaWJpbGl0eS5Gb2dcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgZm9yIChjb25zdCBtb25zdGVyIG9mIG1hcC5tb25zdGVycykge1xyXG4gICAgICAgIG1vbnN0ZXIudGhpbmcudmlzaWJsZSA9IHJsLlZpc2liaWxpdHkuTm9uZVxyXG4gICAgfVxyXG5cclxuICAgIG1hcC5wbGF5ZXIudGhpbmcudmlzaWJsZSA9IHJsLlZpc2liaWxpdHkuVmlzaWJsZVxyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gdXBkYXRlVmlzaWJpbGl0eShtYXA6IE1hcCwgcmFkaXVzOiBudW1iZXIpIHtcclxuICAgIHJlc2V0VmlzaWJpbGl0eShtYXApXHJcblxyXG4gICAgY29uc3QgZXllID0gbWFwLnBsYXllci5wb3NpdGlvblxyXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCA4OyArK2kpIHtcclxuICAgICAgICB1cGRhdGVWaXNpYmlsaXR5T2N0YW50KG1hcCwgZXllLCByYWRpdXMsIGkpXHJcbiAgICB9XHJcblxyXG4gICAgLy8gZXllIHBvaW50IGFsd2F5cyB2aXNpYmxlXHJcbiAgICBpdGVyLmVhY2gobWFwLmF0KGV5ZSksIHRoID0+IHRoLnZpc2libGUgPSBybC5WaXNpYmlsaXR5LlZpc2libGUpXHJcbn1cclxuXHJcbmZ1bmN0aW9uIHVwZGF0ZVZpc2liaWxpdHlPY3RhbnQobWFwOiBNYXAsIGV5ZTogZ2VvLlBvaW50LCByYWRpdXM6IG51bWJlciwgb2N0YW50OiBudW1iZXIpIHtcclxuICAgIGNvbnN0IHNoYWRvd3M6IGdlby5Qb2ludFtdID0gW11cclxuXHJcbiAgICBmb3IgKGxldCB5ID0gMTsgeSA8PSByYWRpdXM7ICsreSkge1xyXG4gICAgICAgIGZvciAobGV0IHggPSAwOyB4IDw9IHk7ICsreCkge1xyXG4gICAgICAgICAgICBjb25zdCBvY3RhbnRQb2ludCA9IG5ldyBnZW8uUG9pbnQoeCwgeSlcclxuXHJcbiAgICAgICAgICAgIGNvbnN0IG1hcFBvaW50ID0gdHJhbnNmb3JtT2N0YW50KG9jdGFudFBvaW50LCBvY3RhbnQpLmFkZFBvaW50KGV5ZSlcclxuICAgICAgICAgICAgaWYgKCFtYXAuaW5Cb3VuZHMobWFwUG9pbnQpKSB7XHJcbiAgICAgICAgICAgICAgICBjb250aW51ZVxyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBpZiAoaXNTaGFkb3dlZChzaGFkb3dzLCBvY3RhbnRQb2ludCkpIHtcclxuICAgICAgICAgICAgICAgIGNvbnRpbnVlXHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGNvbnN0IG9wYXF1ZSA9IGl0ZXIuYW55KG1hcC5hdChtYXBQb2ludCksIHRoID0+ICF0aC50cmFuc3BhcmVudClcclxuICAgICAgICAgICAgaWYgKG9wYXF1ZSkge1xyXG4gICAgICAgICAgICAgICAgc2hhZG93cy5wdXNoKG9jdGFudFBvaW50KVxyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBpZiAoZ2VvLmNhbGNNYW5oYXR0ZW5EaXN0KG1hcFBvaW50LCBleWUpID4gcmFkaXVzKSB7XHJcbiAgICAgICAgICAgICAgICBjb250aW51ZVxyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBmb3IgKGNvbnN0IHRoIG9mIG1hcC5hdChtYXBQb2ludCkpIHtcclxuICAgICAgICAgICAgICAgIHRoLnZpc2libGUgPSBybC5WaXNpYmlsaXR5LlZpc2libGVcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxufVxyXG5cclxuZnVuY3Rpb24gdHJhbnNmb3JtT2N0YW50KGNvb3JkczogZ2VvLlBvaW50LCBvY3RhbnQ6IG51bWJlcik6IGdlby5Qb2ludCB7XHJcbiAgICBzd2l0Y2ggKG9jdGFudCkge1xyXG4gICAgICAgIGNhc2UgMDogcmV0dXJuIG5ldyBnZW8uUG9pbnQoLWNvb3Jkcy54LCBjb29yZHMueSk7XHJcbiAgICAgICAgY2FzZSAxOiByZXR1cm4gbmV3IGdlby5Qb2ludCgtY29vcmRzLnksIGNvb3Jkcy54KTtcclxuICAgICAgICBjYXNlIDI6IHJldHVybiBuZXcgZ2VvLlBvaW50KGNvb3Jkcy55LCBjb29yZHMueCk7XHJcbiAgICAgICAgY2FzZSAzOiByZXR1cm4gbmV3IGdlby5Qb2ludChjb29yZHMueCwgY29vcmRzLnkpO1xyXG4gICAgICAgIGNhc2UgNDogcmV0dXJuIG5ldyBnZW8uUG9pbnQoY29vcmRzLngsIC1jb29yZHMueSk7XHJcbiAgICAgICAgY2FzZSA1OiByZXR1cm4gbmV3IGdlby5Qb2ludChjb29yZHMueSwgLWNvb3Jkcy54KTtcclxuICAgICAgICBjYXNlIDY6IHJldHVybiBuZXcgZ2VvLlBvaW50KC1jb29yZHMueSwgLWNvb3Jkcy54KTtcclxuICAgICAgICBjYXNlIDc6IHJldHVybiBuZXcgZ2VvLlBvaW50KC1jb29yZHMueCwgLWNvb3Jkcy55KTtcclxuICAgIH1cclxuXHJcbiAgICB0aHJvdyBuZXcgRXJyb3IoXCJJbnZhbGlkIG9jdGFudCAtIG11c3QgYmUgaW4gaW50ZXJ2YWwgWzAsIDgpXCIpXHJcbn1cclxuXHJcbmZ1bmN0aW9uIGlzU2hhZG93ZWQoc2hhZG93czogZ2VvLlBvaW50W10sIGNvb3JkczogZ2VvLlBvaW50KTogYm9vbGVhbiB7XHJcbiAgICByZXR1cm4gaXRlci5hbnkoc2hhZG93cywgeCA9PiBzaGFkb3dDb3ZlcnNQb2ludCh4LCBjb29yZHMpKVxyXG59XHJcblxyXG5mdW5jdGlvbiBzaGFkb3dDb3ZlcnNQb2ludChzaGFkb3c6IGdlby5Qb2ludCwgY29vcmRzOiBnZW8uUG9pbnQpOiBib29sZWFuIHtcclxuICAgIGlmIChzaGFkb3cueCA9PSAwKSB7XHJcbiAgICAgICAgcmV0dXJuIGNvb3Jkcy55ID4gc2hhZG93LnlcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBzdGFydFggPSBzaGFkb3cueCAvIChzaGFkb3cueSArIDEpICogY29vcmRzLnlcclxuICAgIGNvbnN0IGVuZFggPSAoc2hhZG93LnggKyAxKSAvIHNoYWRvdy55ICogY29vcmRzLnlcclxuXHJcbiAgICByZXR1cm4gY29vcmRzLnkgPiBzaGFkb3cueSAmJiBjb29yZHMueCA+IHN0YXJ0WCAmJiBjb29yZHMueCA8IGVuZFhcclxufVxyXG5cclxuXHJcbi8qKlxyXG4gKiBGaW5kIGEgcGF0aCBmcm9tIHN0YXJ0IHRvIGdvYWxcclxuICogQHBhcmFtIG1hcCBtYXBcclxuICogQHBhcmFtIHN0YXJ0IHN0YXJ0IGNvb3Jkc1xyXG4gKiBAcGFyYW0gZ29hbCBnb2FsIGNvb3Jkc1xyXG4gKiBAcmV0dXJucyBwYXRoIGZyb20gc3RhcnQgdG8gZ29hbCwgaW5jbHVkaW5nIGdvYWwsIGJ1dCBub3Qgc3RhcnRpbmcgcG9zaXRpb25cclxuICovXHJcbmV4cG9ydCBmdW5jdGlvbiBmaW5kUGF0aChtYXA6IE1hcCwgc3RhcnQ6IGdlby5Qb2ludCwgZ29hbDogZ2VvLlBvaW50KTogQXJyYXk8Z2VvLlBvaW50PiB7XHJcbiAgICBpbnRlcmZhY2UgTm9kZSB7XHJcbiAgICAgICAgZjogbnVtYmVyXHJcbiAgICAgICAgZzogbnVtYmVyXHJcbiAgICAgICAgaDogbnVtYmVyXHJcbiAgICAgICAgcGFyZW50OiBOb2RlIHwgbnVsbFxyXG4gICAgICAgIGNvb3JkczogZ2VvLlBvaW50XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3Qgb3BlbiA9IG5ldyBBcnJheTxOb2RlPigpXHJcbiAgICBjb25zdCBjbG9zZWQgPSBuZXcgQXJyYXk8Tm9kZT4oKVxyXG5cclxuICAgIG9wZW4ucHVzaCh7IGY6IDAsIGc6IDAsIGg6IDAsIHBhcmVudDogbnVsbCwgY29vcmRzOiBzdGFydCB9KVxyXG5cclxuICAgIGNvbnN0IHBvcE9wZW4gPSAoKSA9PiB7XHJcbiAgICAgICAgLy8gd2FybmluZzogYXNzdW1lcyBub24tZW1wdHkhXHJcbiAgICAgICAgbGV0IG4gPSAwXHJcbiAgICAgICAgb3Blbi5mb3JFYWNoKCh4LCBpKSA9PiB7XHJcbiAgICAgICAgICAgIGlmICh4LmYgPCBvcGVuW25dLmYpIHtcclxuICAgICAgICAgICAgICAgIG4gPSBpXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KVxyXG5cclxuICAgICAgICAvLyBzd2FwICYgcG9wXHJcbiAgICAgICAgY29uc3QgciA9IG9wZW5bbl1cclxuXHJcbiAgICAgICAgaWYgKG4gPCBvcGVuLmxlbmd0aCAtIDEpIHtcclxuICAgICAgICAgICAgb3BlbltuXSA9IG9wZW5bb3Blbi5sZW5ndGggLSAxXVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgb3Blbi5wb3AoKVxyXG5cclxuICAgICAgICByZXR1cm4gclxyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IGFzc2VtYmxlUGF0aCA9IChub2RlOiBOb2RlIHwgbnVsbCk6IEFycmF5PGdlby5Qb2ludD4gPT4ge1xyXG4gICAgICAgIC8vIHBhdGggZm91bmQhIGJhY2t0cmFjayBhbmQgYXNzZW1ibGUgcGF0aFxyXG4gICAgICAgIGNvbnN0IHBhdGggPSBuZXcgQXJyYXk8Z2VvLlBvaW50PigpXHJcblxyXG4gICAgICAgIHdoaWxlIChub2RlICYmICFub2RlLmNvb3Jkcy5lcXVhbChzdGFydCkpIHtcclxuICAgICAgICAgICAgcGF0aC5wdXNoKG5vZGUuY29vcmRzKVxyXG4gICAgICAgICAgICBub2RlID0gbm9kZS5wYXJlbnRcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiBwYXRoLnJldmVyc2UoKVxyXG4gICAgfVxyXG5cclxuICAgIHdoaWxlIChvcGVuLmxlbmd0aCA+IDApIHtcclxuICAgICAgICBjb25zdCBjdXIgPSBwb3BPcGVuKClcclxuICAgICAgICBjbG9zZWQucHVzaChjdXIpXHJcblxyXG4gICAgICAgIGlmIChjdXIuY29vcmRzLmVxdWFsKGdvYWwpKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBhc3NlbWJsZVBhdGgoY3VyKVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgZm9yIChjb25zdCBjb29yZHMgb2YgdmlzaXROZWlnaGJvcnMoY3VyLmNvb3JkcywgbWFwLndpZHRoLCBtYXAuaGVpZ2h0KSkge1xyXG4gICAgICAgICAgICBpZiAoIW1hcC5pc1Bhc3NhYmxlKGNvb3JkcykgJiYgIWNvb3Jkcy5lcXVhbChnb2FsKSkge1xyXG4gICAgICAgICAgICAgICAgY29udGludWVcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgaWYgKGNsb3NlZC5maW5kKHggPT4gY29vcmRzLmVxdWFsKHguY29vcmRzKSkpIHtcclxuICAgICAgICAgICAgICAgIGNvbnRpbnVlXHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGNvbnN0IGcgPSBjdXIuZyArIDFcclxuICAgICAgICAgICAgY29uc3QgaCA9IGdlby5jYWxjTWFuaGF0dGVuRGlzdChnb2FsLCBjb29yZHMpXHJcbiAgICAgICAgICAgIGNvbnN0IGYgPSBnICsgaFxyXG5cclxuICAgICAgICAgICAgLy8gZG9lcyB0aGlzIG5vZGUgYWxyZWFkeSBleGlzdCBpbiBvcGVuIGxpc3Q/XHJcbiAgICAgICAgICAgIGNvbnN0IG9wZW5Ob2RlID0gb3Blbi5maW5kKHggPT4gY29vcmRzLmVxdWFsKHguY29vcmRzKSlcclxuICAgICAgICAgICAgaWYgKG9wZW5Ob2RlICE9IG51bGwgJiYgb3Blbk5vZGUuZyA8PSBnKSB7XHJcbiAgICAgICAgICAgICAgICBjb250aW51ZVxyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAvLyBwbGFjZSBpbiBvcGVuIGxpc3RcclxuICAgICAgICAgICAgb3Blbi5wdXNoKHsgZzogZywgaDogaCwgZjogZiwgcGFyZW50OiBjdXIsIGNvb3JkczogY29vcmRzIH0pXHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiBuZXcgQXJyYXk8Z2VvLlBvaW50PigpO1xyXG59XHJcblxyXG5mdW5jdGlvbiogdmlzaXROZWlnaGJvcnMocHQ6IGdlby5Qb2ludCwgd2lkdGg6IG51bWJlciwgaGVpZ2h0OiBudW1iZXIpOiBJdGVyYWJsZTxnZW8uUG9pbnQ+IHtcclxuICAgIGlmIChwdC54IDwgMCB8fCBwdC55IDwgMCB8fCBwdC54ID49IHdpZHRoIHx8IHB0LnkgPj0gaGVpZ2h0KSB7XHJcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwicHQgaXMgb3V0IG9mIGJvdW5kc1wiKVxyXG4gICAgfVxyXG5cclxuICAgIC8vIHdcclxuICAgIGlmIChwdC54ID4gMCkge1xyXG4gICAgICAgIGNvbnN0IHcgPSBuZXcgZ2VvLlBvaW50KHB0LnggLSAxLCBwdC55KVxyXG4gICAgICAgIHlpZWxkIHdcclxuICAgIH1cclxuXHJcbiAgICAvLyBzXHJcbiAgICBpZiAocHQueSA8IGhlaWdodCAtIDEpIHtcclxuICAgICAgICBjb25zdCBzID0gbmV3IGdlby5Qb2ludChwdC54LCBwdC55ICsgMSlcclxuICAgICAgICB5aWVsZCBzXHJcbiAgICB9XHJcblxyXG4gICAgLy8gZVxyXG4gICAgaWYgKHB0LnggPCB3aWR0aCAtIDEpIHtcclxuICAgICAgICBjb25zdCBlID0gbmV3IGdlby5Qb2ludChwdC54ICsgMSwgcHQueSlcclxuICAgICAgICB5aWVsZCBlXHJcbiAgICB9XHJcblxyXG4gICAgLy8gblxyXG4gICAgaWYgKHB0LnkgPiAwKSB7XHJcbiAgICAgICAgY29uc3QgbiA9IG5ldyBnZW8uUG9pbnQocHQueCwgcHQueSAtIDEpXHJcbiAgICAgICAgeWllbGQgblxyXG4gICAgfVxyXG59XHJcbiJdfQ==