import * as geo from "../shared/geo2d.js";
import * as array from "../shared/array.js";
import * as rl from "./rl.js";
import * as grid from "../shared/grid.js";
/**
 * a layer that is based on a set
 * works well for sparse layers
 */
export class SetLayer {
    constructor() {
        this.set = new Set();
    }
    add(item) {
        if (!item.position) {
            throw new Error("Item cannot be placed in layer without a position");
        }
        this.set.add(item);
    }
    delete(item) {
        this.set.delete(item);
    }
    has(item) {
        return this.set.has(item);
    }
    at(position) {
        var _a;
        for (const value of this.set) {
            if ((_a = value.position) === null || _a === void 0 ? void 0 : _a.equal(position)) {
                return value;
            }
        }
        return null;
    }
    *[Symbol.iterator]() {
        for (const value of this.set) {
            yield value;
        }
    }
}
/**
 * a layer that is based on a grid
 * works well for dense layers
 */
export class GridLayer {
    constructor(width, height) {
        this.set = new Set();
        this.grd = grid.generate(width, height, () => null);
    }
    get width() {
        return this.grd.width;
    }
    get height() {
        return this.grd.height;
    }
    add(item) {
        if (!item.position) {
            throw new Error("Item cannot be placed in layer without a position");
        }
        this.grd.setPoint(item.position, item);
        this.set.add(item);
    }
    delete(item) {
        if (!item.position) {
            throw new Error("Item cannot be deleted from layer without a position");
        }
        this.grd.setPoint(item.position, null);
        this.set.delete(item);
    }
    has(item) {
        return this.set.has(item);
    }
    at(position) {
        return this.grd.atPoint(position);
    }
    *[Symbol.iterator]() {
        for (const value of this.set) {
            yield value;
        }
    }
}
/**
 * components of a generated map area
 */
export class Map {
    constructor(width, height, player) {
        this.width = width;
        this.height = height;
        this.player = player;
        this.tiles = new GridLayer(width, height);
        this.fixtures = new SetLayer();
        this.monsters = new SetLayer();
        this.containers = new SetLayer();
    }
    /**
      * iterate over all things in map
    */
    *[Symbol.iterator]() {
        for (const tile of this.tiles) {
            yield tile;
        }
        for (const fixture of this.fixtures) {
            yield fixture;
        }
        for (const container of this.containers) {
            yield container;
        }
        for (const monster of this.monsters) {
            yield monster;
        }
        yield this.player;
    }
    tileAt(xy) {
        return this.tiles.at(xy);
    }
    fixtureAt(xy) {
        return this.fixtures.at(xy);
    }
    containerAt(xy) {
        return this.containers.at(xy);
    }
    monsterAt(xy) {
        return this.monsters.at(xy);
    }
    *at(xy) {
        const fixture = this.fixtureAt(xy);
        if (fixture) {
            yield fixture;
        }
        const tile = this.tileAt(xy);
        if (tile) {
            yield tile;
        }
        const container = this.containerAt(xy);
        if (container) {
            yield container;
        }
        const monster = this.monsterAt(xy);
        if (monster) {
            yield monster;
        }
    }
    inBounds(xy) {
        return xy.x >= 0 && xy.x < this.width && xy.y >= 0 && xy.y < this.height;
    }
}
function resetVisibility(map) {
    for (const th of map) {
        if (th.visible) {
            th.visible = rl.Visible.Fog;
        }
    }
    map.player.visible = rl.Visible.Visible;
}
export function updateVisibility(map, eye, radius) {
    resetVisibility(map);
    for (let i = 0; i < 8; ++i) {
        updateVisibilityOctant(map, eye, radius, i);
    }
}
function updateVisibilityOctant(map, eye, radius, octant) {
    const shadows = [];
    for (let y = 1; y <= radius; ++y) {
        for (let x = 0; x <= y; ++x) {
            const octantPoint = new geo.Point(x, y);
            const mapPoint = transformOctant(octantPoint, octant).addPoint(eye);
            if (!map.inBounds(mapPoint)) {
                continue;
            }
            if (isShadowed(shadows, octantPoint)) {
                continue;
            }
            const opaque = array.any(map.at(mapPoint), th => !th.transparent);
            if (opaque) {
                shadows.push(octantPoint);
            }
            if (geo.calcManhattenDist(mapPoint, eye) > radius) {
                continue;
            }
            for (const th of map.at(mapPoint)) {
                th.visible = rl.Visible.Visible;
            }
        }
    }
}
function transformOctant(coords, octant) {
    switch (octant) {
        case 0: return new geo.Point(-coords.x, coords.y);
        case 1: return new geo.Point(-coords.y, coords.x);
        case 2: return new geo.Point(coords.y, coords.x);
        case 3: return new geo.Point(coords.x, coords.y);
        case 4: return new geo.Point(coords.x, -coords.y);
        case 5: return new geo.Point(coords.y, -coords.x);
        case 6: return new geo.Point(-coords.y, -coords.x);
        case 7: return new geo.Point(-coords.x, -coords.y);
    }
    throw new Error("Invalid octant - must be in interval [0, 8)");
}
function isShadowed(shadows, coords) {
    return array.any(shadows, x => shadowCoversPoint(x, coords));
}
function shadowCoversPoint(shadow, coords) {
    if (shadow.x == 0) {
        return coords.y > shadow.y;
    }
    const startX = shadow.x / (shadow.y + 1) * coords.y;
    const endX = (shadow.x + 1) / shadow.y * coords.y;
    return coords.y > shadow.y && coords.x > startX && coords.x < endX;
}
// export function updateVisibility(map: Map, eye: geo.Point, radius: number) {
//     updateVisibilityFlags(map, eye, radius, TileFlags.Visible | TileFlags.Seen, TileFlags.Visible)
// }
// function updateVisibilityFlags(map: Map, eye: geo.Point, radius: number, setFlags: TileFlags, clearFlags: TileFlags) {
//     for (const tile of map) {
//         tile.flags &= ~clearFlags
//     }
//     map.getTile(eye).flags |= setFlags
//     for (let i = 0; i < 8; ++i) {
//         updateVisibilityOctant(map, eye, radius, setFlags, i)
//     }
// }
// function updateVisibilityOctant(map: Map, eye: geo.Point, radius: number, setFlags: TileFlags, octant: number) {
//     const shadows: geo.Point[] = []
//     for (let i = 1; i <= radius; ++i) {
//         for (let j = 0; j <= i; ++j) {
//             const octantPoint = new geo.Point(i, j)
//             const mapPoint = transformOctant(octantPoint, octant).add(eye)
//             if (!map.inBounds(mapPoint)) {
//                 continue
//             }
//             if (isShadowed(shadows, octantPoint)) {
//                 continue
//             }
//             const tile = map.getTile(mapPoint)
//             if (tileBlocksView(tile)) {
//                 shadows.push(octantPoint)
//             }
//             if (geo.calcDist(mapPoint, eye) > radius) {
//                 continue
//             }
//             tile.flags |= setFlags
//         }
//     }
// }
// function transformOctant(coords: geo.Point, octant: number): geo.Point {
//     switch (octant) {
//         case 0: return new geo.Point(coords.i, -coords.j);
//         case 1: return new geo.Point(coords.j, -coords.i);
//         case 2: return new geo.Point(coords.j, coords.i);
//         case 3: return new geo.Point(coords.i, coords.j);
//         case 4: return new geo.Point(-coords.i, coords.j);
//         case 5: return new geo.Point(-coords.j, coords.i);
//         case 6: return new geo.Point(-coords.j, -coords.i);
//         case 7: return new geo.Point(-coords.i, -coords.j);
//     }
//     throw new Error("Invalid octant - must be in interval [0, 8)")
// }
// function isShadowed(shadows: geo.Point[], coords: geo.Point): boolean {
//     return iter.any(shadows, x => shadowCoversPoint(x, coords))
// }
// function shadowCoversPoint(shadow: geo.Point, coords: geo.Point): boolean {
//     if (shadow.j == 0) {
//         return coords.i > shadow.i
//     }
//     const startJ = shadow.j / (shadow.i + 1) * coords.i
//     const endJ = (shadow.j + 1) / shadow.i * coords.i
//     return coords.i > shadow.i && coords.j > startJ && coords.j < endJ
// }
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFwcy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIm1hcHMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxLQUFLLEdBQUcsTUFBTSxvQkFBb0IsQ0FBQTtBQUN6QyxPQUFPLEtBQUssS0FBSyxNQUFNLG9CQUFvQixDQUFBO0FBQzNDLE9BQU8sS0FBSyxFQUFFLE1BQU0sU0FBUyxDQUFBO0FBQzdCLE9BQU8sS0FBSyxJQUFJLE1BQU0sbUJBQW1CLENBQUE7QUFhekM7OztHQUdHO0FBQ0gsTUFBTSxPQUFPLFFBQVE7SUFBckI7UUFDcUIsUUFBRyxHQUFHLElBQUksR0FBRyxFQUFLLENBQUE7SUFpQ3ZDLENBQUM7SUEvQkcsR0FBRyxDQUFDLElBQU87UUFDUCxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRTtZQUNoQixNQUFNLElBQUksS0FBSyxDQUFDLG1EQUFtRCxDQUFDLENBQUE7U0FDdkU7UUFFRCxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQTtJQUN0QixDQUFDO0lBRUQsTUFBTSxDQUFDLElBQU87UUFDVixJQUFJLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQTtJQUN6QixDQUFDO0lBRUQsR0FBRyxDQUFDLElBQU87UUFDUCxPQUFPLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFBO0lBQzdCLENBQUM7SUFFRCxFQUFFLENBQUMsUUFBbUI7O1FBQ2xCLEtBQUssTUFBTSxLQUFLLElBQUksSUFBSSxDQUFDLEdBQUcsRUFBRTtZQUMxQixVQUFJLEtBQUssQ0FBQyxRQUFRLDBDQUFFLEtBQUssQ0FBQyxRQUFRLEdBQUc7Z0JBQ2pDLE9BQU8sS0FBSyxDQUFBO2FBQ2Y7U0FDSjtRQUVELE9BQU8sSUFBSSxDQUFBO0lBQ2YsQ0FBQztJQUVELENBQUMsQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDO1FBQ2QsS0FBSyxNQUFNLEtBQUssSUFB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QkFBd0I7QUFDeEIsNkRBQTZEO0FBQzdELDZEQUE2RDtBQUM3RCw0REFBNEQ7QUFDNUQsNERBQTREO0FBQzVELDZEQUE2RDtBQUM3RCw2REFBNkQ7QUFDN0QsOERBQThEO0FBQzlELDhEQUE4RDtBQUM5RCxRQUFRO0FBRVIscUVBQXFFO0FBQ3JFLElBQUk7QUFFSiwwRUFBMEU7QUFDMUUsa0VBQWtFO0FBQ2xFLElBQUk7QUFFSiw4RUFBOEU7QUFDOUUsMkJBQTJCO0FBQzNCLHFDQUFxQztBQUNyQyxRQUFRO0FBRVIsMERBQTBEO0FBQzFELHdEQUF3RDtBQUV4RCx5RUFBeUU7QUFDekUsSUFBSSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIGdlbyBmcm9tIFwiLi4vc2hhcmVkL2dlbzJkLmpzXCJcclxuaW1wb3J0ICogYXMgYXJyYXkgZnJvbSBcIi4uL3NoYXJlZC9hcnJheS5qc1wiXHJcbmltcG9ydCAqIGFzIHJsIGZyb20gXCIuL3JsLmpzXCJcclxuaW1wb3J0ICogYXMgZ3JpZCBmcm9tIFwiLi4vc2hhcmVkL2dyaWQuanNcIlxyXG5cclxuLyoqXHJcbiAqIGEgbGF5ZXIgb2YgdGhpbmdzIG9uIGEgbWFwXHJcbiAqL1xyXG5leHBvcnQgaW50ZXJmYWNlIExheWVyPFQgZXh0ZW5kcyBybC5UaGluZz4ge1xyXG4gICAgYWRkKGl0ZW06IFQpOiB2b2lkXHJcbiAgICBkZWxldGUoaXRlbTogVCk6IHZvaWRcclxuICAgIGhhcyhpdGVtOiBUKTogYm9vbGVhblxyXG4gICAgYXQocG9zaXRpb246IGdlby5Qb2ludCk6IFQgfCBudWxsXHJcbiAgICBbU3ltYm9sLml0ZXJhdG9yXSgpOiBHZW5lcmF0b3I8VD5cclxufVxyXG5cclxuLyoqXHJcbiAqIGEgbGF5ZXIgdGhhdCBpcyBiYXNlZCBvbiBhIHNldFxyXG4gKiB3b3JrcyB3ZWxsIGZvciBzcGFyc2UgbGF5ZXJzXHJcbiAqL1xyXG5leHBvcnQgY2xhc3MgU2V0TGF5ZXI8VCBleHRlbmRzIHJsLlRoaW5nPiBpbXBsZW1lbnRzIExheWVyPFQ+IHtcclxuICAgIHByaXZhdGUgcmVhZG9ubHkgc2V0ID0gbmV3IFNldDxUPigpXHJcblxyXG4gICAgYWRkKGl0ZW06IFQpOiB2b2lkIHtcclxuICAgICAgICBpZiAoIWl0ZW0ucG9zaXRpb24pIHtcclxuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiSXRlbSBjYW5ub3QgYmUgcGxhY2VkIGluIGxheWVyIHdpdGhvdXQgYSBwb3NpdGlvblwiKVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgdGhpcy5zZXQuYWRkKGl0ZW0pXHJcbiAgICB9XHJcblxyXG4gICAgZGVsZXRlKGl0ZW06IFQpOiB2b2lkIHtcclxuICAgICAgICB0aGlzLnNldC5kZWxldGUoaXRlbSlcclxuICAgIH1cclxuXHJcbiAgICBoYXMoaXRlbTogVCk6IGJvb2xlYW4ge1xyXG4gICAgICAgIHJldHVybiB0aGlzLnNldC5oYXMoaXRlbSlcclxuICAgIH1cclxuXHJcbiAgICBhdChwb3NpdGlvbjogZ2VvLlBvaW50KTogVCB8IG51bGwge1xyXG4gICAgICAgIGZvciAoY29uc3QgdmFsdWUgb2YgdGhpcy5zZXQpIHtcclxuICAgICAgICAgICAgaWYgKHZhbHVlLnBvc2l0aW9uPy5lcXVhbChwb3NpdGlvbikpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gbnVsbFxyXG4gICAgfVxyXG5cclxuICAgICpbU3ltYm9sLml0ZXJhdG9yXSgpOiBHZW5lcmF0b3I8VD4ge1xyXG4gICAgICAgIGZvciAoY29uc3QgdmFsdWUgb2YgdGhpcy5zZXQpIHtcclxuICAgICAgICAgICAgeWllbGQgdmFsdWVcclxuICAgICAgICB9XHJcbiAgICB9XHJcbn1cclxuXHJcblxyXG4vKipcclxuICogYSBsYXllciB0aGF0IGlzIGJhc2VkIG9uIGEgZ3JpZFxyXG4gKiB3b3JrcyB3ZWxsIGZvciBkZW5zZSBsYXllcnNcclxuICovXHJcbmV4cG9ydCBjbGFzcyBHcmlkTGF5ZXI8VCBleHRlbmRzIHJsLlRoaW5nPiBpbXBsZW1lbnRzIExheWVyPFQ+IHtcclxuICAgIHByaXZhdGUgcmVhZG9ubHkgc2V0ID0gbmV3IFNldDxUPigpXHJcbiAgICBwcml2YXRlIHJlYWRvbmx5IGdyZDogZ3JpZC5HcmlkPFQgfCBudWxsPlxyXG5cclxuICAgIGNvbnN0cnVjdG9yKHdpZHRoOiBudW1iZXIsIGhlaWdodDogbnVtYmVyKSB7XHJcbiAgICAgICAgdGhpcy5ncmQgPSBncmlkLmdlbmVyYXRlKHdpZHRoLCBoZWlnaHQsICgpID0+IG51bGwpXHJcbiAgICB9XHJcblxyXG4gICAgZ2V0IHdpZHRoKCkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLmdyZC53aWR0aFxyXG4gICAgfVxyXG5cclxuICAgIGdldCBoZWlnaHQoKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuZ3JkLmhlaWdodFxyXG4gICAgfVxyXG5cclxuICAgIGFkZChpdGVtOiBUKTogdm9pZCB7XHJcbiAgICAgICAgaWYgKCFpdGVtLnBvc2l0aW9uKSB7XHJcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcIkl0ZW0gY2Fubm90IGJlIHBsYWNlZCBpbiBsYXllciB3aXRob3V0IGEgcG9zaXRpb25cIilcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHRoaXMuZ3JkLnNldFBvaW50KGl0ZW0ucG9zaXRpb24sIGl0ZW0pXHJcbiAgICAgICAgdGhpcy5zZXQuYWRkKGl0ZW0pXHJcbiAgICB9XHJcblxyXG4gICAgZGVsZXRlKGl0ZW06IFQpOiB2b2lkIHtcclxuICAgICAgICBpZiAoIWl0ZW0ucG9zaXRpb24pIHtcclxuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiSXRlbSBjYW5ub3QgYmUgZGVsZXRlZCBmcm9tIGxheWVyIHdpdGhvdXQgYSBwb3NpdGlvblwiKVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgdGhpcy5ncmQuc2V0UG9pbnQoaXRlbS5wb3NpdGlvbiwgbnVsbClcclxuICAgICAgICB0aGlzLnNldC5kZWxldGUoaXRlbSlcclxuICAgIH1cclxuXHJcbiAgICBoYXMoaXRlbTogVCk6IGJvb2xlYW4ge1xyXG4gICAgICAgIHJldHVybiB0aGlzLnNldC5oYXMoaXRlbSlcclxuICAgIH1cclxuXHJcbiAgICBhdChwb3NpdGlvbjogZ2VvLlBvaW50KTogVCB8IG51bGwge1xyXG4gICAgICAgIHJldHVybiB0aGlzLmdyZC5hdFBvaW50KHBvc2l0aW9uKVxyXG4gICAgfVxyXG5cclxuICAgICpbU3ltYm9sLml0ZXJhdG9yXSgpOiBHZW5lcmF0b3I8VD4ge1xyXG4gICAgICAgIGZvciAoY29uc3QgdmFsdWUgb2YgdGhpcy5zZXQpIHtcclxuICAgICAgICAgICAgeWllbGQgdmFsdWVcclxuICAgICAgICB9XHJcbiAgICB9XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBjb21wb25lbnRzIG9mIGEgZ2VuZXJhdGVkIG1hcCBhcmVhXHJcbiAqL1xyXG5leHBvcnQgY2xhc3MgTWFwIHtcclxuICAgIHRpbGVzOiBMYXllcjxybC5UaWxlPlxyXG4gICAgZml4dHVyZXM6IExheWVyPHJsLkZpeHR1cmU+XHJcbiAgICBtb25zdGVyczogTGF5ZXI8cmwuTW9uc3Rlcj5cclxuICAgIGNvbnRhaW5lcnM6IExheWVyPHJsLkNvbnRhaW5lcj5cclxuXHJcbiAgICBjb25zdHJ1Y3RvcihyZWFkb25seSB3aWR0aDogbnVtYmVyLCByZWFkb25seSBoZWlnaHQ6IG51bWJlciwgcmVhZG9ubHkgcGxheWVyOiBybC5QbGF5ZXIpIHtcclxuICAgICAgICB0aGlzLnRpbGVzID0gbmV3IEdyaWRMYXllcih3aWR0aCwgaGVpZ2h0KVxyXG4gICAgICAgIHRoaXMuZml4dHVyZXMgPSBuZXcgU2V0TGF5ZXIoKVxyXG4gICAgICAgIHRoaXMubW9uc3RlcnMgPSBuZXcgU2V0TGF5ZXIoKVxyXG4gICAgICAgIHRoaXMuY29udGFpbmVycyA9IG5ldyBTZXRMYXllcigpXHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgICogaXRlcmF0ZSBvdmVyIGFsbCB0aGluZ3MgaW4gbWFwXHJcbiAgICAqL1xyXG4gICAgcHVibGljICpbU3ltYm9sLml0ZXJhdG9yXSgpOiBHZW5lcmF0b3I8cmwuVGhpbmc+IHtcclxuICAgICAgICBmb3IgKGNvbnN0IHRpbGUgb2YgdGhpcy50aWxlcykge1xyXG4gICAgICAgICAgICB5aWVsZCB0aWxlXHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBmb3IgKGNvbnN0IGZpeHR1cmUgb2YgdGhpcy5maXh0dXJlcykge1xyXG4gICAgICAgICAgICB5aWVsZCBmaXh0dXJlXHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBmb3IgKGNvbnN0IGNvbnRhaW5lciBvZiB0aGlzLmNvbnRhaW5lcnMpIHtcclxuICAgICAgICAgICAgeWllbGQgY29udGFpbmVyXHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBmb3IgKGNvbnN0IG1vbnN0ZXIgb2YgdGhpcy5tb25zdGVycykge1xyXG4gICAgICAgICAgICB5aWVsZCBtb25zdGVyXHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB5aWVsZCB0aGlzLnBsYXllclxyXG4gICAgfVxyXG5cclxuICAgIHRpbGVBdCh4eTogZ2VvLlBvaW50KTogcmwuVGlsZSB8IG51bGwge1xyXG4gICAgICAgIHJldHVybiB0aGlzLnRpbGVzLmF0KHh5KVxyXG4gICAgfVxyXG5cclxuICAgIGZpeHR1cmVBdCh4eTogZ2VvLlBvaW50KTogcmwuRml4dHVyZSB8IG51bGwge1xyXG4gICAgICAgIHJldHVybiB0aGlzLmZpeHR1cmVzLmF0KHh5KVxyXG4gICAgfVxyXG5cclxuICAgIGNvbnRhaW5lckF0KHh5OiBnZW8uUG9pbnQpOiBybC5Db250YWluZXIgfCBudWxsIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5jb250YWluZXJzLmF0KHh5KVxyXG4gICAgfVxyXG5cclxuICAgIG1vbnN0ZXJBdCh4eTogZ2VvLlBvaW50KTogcmwuTW9uc3RlciB8IG51bGwge1xyXG4gICAgICAgIHJldHVybiB0aGlzLm1vbnN0ZXJzLmF0KHh5KVxyXG4gICAgfVxyXG5cclxuICAgICphdCh4eTogZ2VvLlBvaW50KTogR2VuZXJhdG9yPHJsLk1vbnN0ZXIgfCBybC5GaXh0dXJlIHwgcmwuVGlsZT4ge1xyXG4gICAgICAgIGNvbnN0IGZpeHR1cmUgPSB0aGlzLmZpeHR1cmVBdCh4eSlcclxuICAgICAgICBpZiAoZml4dHVyZSkge1xyXG4gICAgICAgICAgICB5aWVsZCBmaXh0dXJlXHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBjb25zdCB0aWxlID0gdGhpcy50aWxlQXQoeHkpXHJcbiAgICAgICAgaWYgKHRpbGUpIHtcclxuICAgICAgICAgICAgeWllbGQgdGlsZVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgY29uc3QgY29udGFpbmVyID0gdGhpcy5jb250YWluZXJBdCh4eSlcclxuICAgICAgICBpZiAoY29udGFpbmVyKSB7XHJcbiAgICAgICAgICAgIHlpZWxkIGNvbnRhaW5lclxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgY29uc3QgbW9uc3RlciA9IHRoaXMubW9uc3RlckF0KHh5KVxyXG4gICAgICAgIGlmIChtb25zdGVyKSB7XHJcbiAgICAgICAgICAgIHlpZWxkIG1vbnN0ZXJcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgaW5Cb3VuZHMoeHk6IGdlby5Qb2ludCk6IGJvb2xlYW4ge1xyXG4gICAgICAgIHJldHVybiB4eS54ID49IDAgJiYgeHkueCA8IHRoaXMud2lkdGggJiYgeHkueSA+PSAwICYmIHh5LnkgPCB0aGlzLmhlaWdodFxyXG4gICAgfVxyXG59XHJcblxyXG5mdW5jdGlvbiByZXNldFZpc2liaWxpdHkobWFwOiBNYXApIHtcclxuICAgIGZvciAoY29uc3QgdGggb2YgbWFwKSB7XHJcbiAgICAgICAgaWYgKHRoLnZpc2libGUpIHtcclxuICAgICAgICAgICAgdGgudmlzaWJsZSA9IHJsLlZpc2libGUuRm9nXHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIG1hcC5wbGF5ZXIudmlzaWJsZSA9IHJsLlZpc2libGUuVmlzaWJsZVxyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gdXBkYXRlVmlzaWJpbGl0eShtYXA6IE1hcCwgZXllOiBnZW8uUG9pbnQsIHJhZGl1czogbnVtYmVyKSB7XHJcbiAgICByZXNldFZpc2liaWxpdHkobWFwKVxyXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCA4OyArK2kpIHtcclxuICAgICAgICB1cGRhdGVWaXNpYmlsaXR5T2N0YW50KG1hcCwgZXllLCByYWRpdXMsIGkpXHJcbiAgICB9XHJcbn1cclxuXHJcbmZ1bmN0aW9uIHVwZGF0ZVZpc2liaWxpdHlPY3RhbnQobWFwOiBNYXAsIGV5ZTogZ2VvLlBvaW50LCByYWRpdXM6IG51bWJlciwgb2N0YW50OiBudW1iZXIpIHtcclxuICAgIGNvbnN0IHNoYWRvd3M6IGdlby5Qb2ludFtdID0gW11cclxuXHJcbiAgICBmb3IgKGxldCB5ID0gMTsgeSA8PSByYWRpdXM7ICsreSkge1xyXG4gICAgICAgIGZvciAobGV0IHggPSAwOyB4IDw9IHk7ICsreCkge1xyXG4gICAgICAgICAgICBjb25zdCBvY3RhbnRQb2ludCA9IG5ldyBnZW8uUG9pbnQoeCwgeSlcclxuXHJcbiAgICAgICAgICAgIGNvbnN0IG1hcFBvaW50ID0gdHJhbnNmb3JtT2N0YW50KG9jdGFudFBvaW50LCBvY3RhbnQpLmFkZFBvaW50KGV5ZSlcclxuICAgICAgICAgICAgaWYgKCFtYXAuaW5Cb3VuZHMobWFwUG9pbnQpKSB7XHJcbiAgICAgICAgICAgICAgICBjb250aW51ZVxyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBpZiAoaXNTaGFkb3dlZChzaGFkb3dzLCBvY3RhbnRQb2ludCkpIHtcclxuICAgICAgICAgICAgICAgIGNvbnRpbnVlXHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGNvbnN0IG9wYXF1ZSA9IGFycmF5LmFueShtYXAuYXQobWFwUG9pbnQpLCB0aCA9PiAhdGgudHJhbnNwYXJlbnQpXHJcbiAgICAgICAgICAgIGlmIChvcGFxdWUpIHtcclxuICAgICAgICAgICAgICAgIHNoYWRvd3MucHVzaChvY3RhbnRQb2ludClcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgaWYgKGdlby5jYWxjTWFuaGF0dGVuRGlzdChtYXBQb2ludCwgZXllKSA+IHJhZGl1cykge1xyXG4gICAgICAgICAgICAgICAgY29udGludWVcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgZm9yIChjb25zdCB0aCBvZiBtYXAuYXQobWFwUG9pbnQpKSB7XHJcbiAgICAgICAgICAgICAgICB0aC52aXNpYmxlID0gcmwuVmlzaWJsZS5WaXNpYmxlXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcbn1cclxuXHJcbmZ1bmN0aW9uIHRyYW5zZm9ybU9jdGFudChjb29yZHM6IGdlby5Qb2ludCwgb2N0YW50OiBudW1iZXIpOiBnZW8uUG9pbnQge1xyXG4gICAgc3dpdGNoIChvY3RhbnQpIHtcclxuICAgICAgICBjYXNlIDA6IHJldHVybiBuZXcgZ2VvLlBvaW50KC1jb29yZHMueCwgY29vcmRzLnkpO1xyXG4gICAgICAgIGNhc2UgMTogcmV0dXJuIG5ldyBnZW8uUG9pbnQoLWNvb3Jkcy55LCBjb29yZHMueCk7XHJcbiAgICAgICAgY2FzZSAyOiByZXR1cm4gbmV3IGdlby5Qb2ludChjb29yZHMueSwgY29vcmRzLngpO1xyXG4gICAgICAgIGNhc2UgMzogcmV0dXJuIG5ldyBnZW8uUG9pbnQoY29vcmRzLngsIGNvb3Jkcy55KTtcclxuICAgICAgICBjYXNlIDQ6IHJldHVybiBuZXcgZ2VvLlBvaW50KGNvb3Jkcy54LCAtY29vcmRzLnkpO1xyXG4gICAgICAgIGNhc2UgNTogcmV0dXJuIG5ldyBnZW8uUG9pbnQoY29vcmRzLnksIC1jb29yZHMueCk7XHJcbiAgICAgICAgY2FzZSA2OiByZXR1cm4gbmV3IGdlby5Qb2ludCgtY29vcmRzLnksIC1jb29yZHMueCk7XHJcbiAgICAgICAgY2FzZSA3OiByZXR1cm4gbmV3IGdlby5Qb2ludCgtY29vcmRzLngsIC1jb29yZHMueSk7XHJcbiAgICB9XHJcblxyXG4gICAgdGhyb3cgbmV3IEVycm9yKFwiSW52YWxpZCBvY3RhbnQgLSBtdXN0IGJlIGluIGludGVydmFsIFswLCA4KVwiKVxyXG59XHJcblxyXG5mdW5jdGlvbiBpc1NoYWRvd2VkKHNoYWRvd3M6IGdlby5Qb2ludFtdLCBjb29yZHM6IGdlby5Qb2ludCk6IGJvb2xlYW4ge1xyXG4gICAgcmV0dXJuIGFycmF5LmFueShzaGFkb3dzLCB4ID0+IHNoYWRvd0NvdmVyc1BvaW50KHgsIGNvb3JkcykpXHJcbn1cclxuXHJcbmZ1bmN0aW9uIHNoYWRvd0NvdmVyc1BvaW50KHNoYWRvdzogZ2VvLlBvaW50LCBjb29yZHM6IGdlby5Qb2ludCk6IGJvb2xlYW4ge1xyXG4gICAgaWYgKHNoYWRvdy54ID09IDApIHtcclxuICAgICAgICByZXR1cm4gY29vcmRzLnkgPiBzaGFkb3cueVxyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IHN0YXJ0WCA9IHNoYWRvdy54IC8gKHNoYWRvdy55ICsgMSkgKiBjb29yZHMueVxyXG4gICAgY29uc3QgZW5kWCA9IChzaGFkb3cueCArIDEpIC8gc2hhZG93LnkgKiBjb29yZHMueVxyXG5cclxuICAgIHJldHVybiBjb29yZHMueSA+IHNoYWRvdy55ICYmIGNvb3Jkcy54ID4gc3RhcnRYICYmIGNvb3Jkcy54IDwgZW5kWFxyXG59XHJcblxyXG4vLyBleHBvcnQgZnVuY3Rpb24gdXBkYXRlVmlzaWJpbGl0eShtYXA6IE1hcCwgZXllOiBnZW8uUG9pbnQsIHJhZGl1czogbnVtYmVyKSB7XHJcbi8vICAgICB1cGRhdGVWaXNpYmlsaXR5RmxhZ3MobWFwLCBleWUsIHJhZGl1cywgVGlsZUZsYWdzLlZpc2libGUgfCBUaWxlRmxhZ3MuU2VlbiwgVGlsZUZsYWdzLlZpc2libGUpXHJcbi8vIH1cclxuXHJcbi8vIGZ1bmN0aW9uIHVwZGF0ZVZpc2liaWxpdHlGbGFncyhtYXA6IE1hcCwgZXllOiBnZW8uUG9pbnQsIHJhZGl1czogbnVtYmVyLCBzZXRGbGFnczogVGlsZUZsYWdzLCBjbGVhckZsYWdzOiBUaWxlRmxhZ3MpIHtcclxuLy8gICAgIGZvciAoY29uc3QgdGlsZSBvZiBtYXApIHtcclxuLy8gICAgICAgICB0aWxlLmZsYWdzICY9IH5jbGVhckZsYWdzXHJcbi8vICAgICB9XHJcblxyXG4vLyAgICAgbWFwLmdldFRpbGUoZXllKS5mbGFncyB8PSBzZXRGbGFnc1xyXG5cclxuLy8gICAgIGZvciAobGV0IGkgPSAwOyBpIDwgODsgKytpKSB7XHJcbi8vICAgICAgICAgdXBkYXRlVmlzaWJpbGl0eU9jdGFudChtYXAsIGV5ZSwgcmFkaXVzLCBzZXRGbGFncywgaSlcclxuLy8gICAgIH1cclxuLy8gfVxyXG5cclxuLy8gZnVuY3Rpb24gdXBkYXRlVmlzaWJpbGl0eU9jdGFudChtYXA6IE1hcCwgZXllOiBnZW8uUG9pbnQsIHJhZGl1czogbnVtYmVyLCBzZXRGbGFnczogVGlsZUZsYWdzLCBvY3RhbnQ6IG51bWJlcikge1xyXG4vLyAgICAgY29uc3Qgc2hhZG93czogZ2VvLlBvaW50W10gPSBbXVxyXG5cclxuLy8gICAgIGZvciAobGV0IGkgPSAxOyBpIDw9IHJhZGl1czsgKytpKSB7XHJcbi8vICAgICAgICAgZm9yIChsZXQgaiA9IDA7IGogPD0gaTsgKytqKSB7XHJcbi8vICAgICAgICAgICAgIGNvbnN0IG9jdGFudFBvaW50ID0gbmV3IGdlby5Qb2ludChpLCBqKVxyXG5cclxuLy8gICAgICAgICAgICAgY29uc3QgbWFwUG9pbnQgPSB0cmFuc2Zvcm1PY3RhbnQob2N0YW50UG9pbnQsIG9jdGFudCkuYWRkKGV5ZSlcclxuLy8gICAgICAgICAgICAgaWYgKCFtYXAuaW5Cb3VuZHMobWFwUG9pbnQpKSB7XHJcbi8vICAgICAgICAgICAgICAgICBjb250aW51ZVxyXG4vLyAgICAgICAgICAgICB9XHJcblxyXG4vLyAgICAgICAgICAgICBpZiAoaXNTaGFkb3dlZChzaGFkb3dzLCBvY3RhbnRQb2ludCkpIHtcclxuLy8gICAgICAgICAgICAgICAgIGNvbnRpbnVlXHJcbi8vICAgICAgICAgICAgIH1cclxuXHJcbi8vICAgICAgICAgICAgIGNvbnN0IHRpbGUgPSBtYXAuZ2V0VGlsZShtYXBQb2ludClcclxuLy8gICAgICAgICAgICAgaWYgKHRpbGVCbG9ja3NWaWV3KHRpbGUpKSB7XHJcbi8vICAgICAgICAgICAgICAgICBzaGFkb3dzLnB1c2gob2N0YW50UG9pbnQpXHJcbi8vICAgICAgICAgICAgIH1cclxuXHJcbi8vICAgICAgICAgICAgIGlmIChnZW8uY2FsY0Rpc3QobWFwUG9pbnQsIGV5ZSkgPiByYWRpdXMpIHtcclxuLy8gICAgICAgICAgICAgICAgIGNvbnRpbnVlXHJcbi8vICAgICAgICAgICAgIH1cclxuXHJcbi8vICAgICAgICAgICAgIHRpbGUuZmxhZ3MgfD0gc2V0RmxhZ3NcclxuLy8gICAgICAgICB9XHJcbi8vICAgICB9XHJcbi8vIH1cclxuXHJcbi8vIGZ1bmN0aW9uIHRyYW5zZm9ybU9jdGFudChjb29yZHM6IGdlby5Qb2ludCwgb2N0YW50OiBudW1iZXIpOiBnZW8uUG9pbnQge1xyXG4vLyAgICAgc3dpdGNoIChvY3RhbnQpIHtcclxuLy8gICAgICAgICBjYXNlIDA6IHJldHVybiBuZXcgZ2VvLlBvaW50KGNvb3Jkcy5pLCAtY29vcmRzLmopO1xyXG4vLyAgICAgICAgIGNhc2UgMTogcmV0dXJuIG5ldyBnZW8uUG9pbnQoY29vcmRzLmosIC1jb29yZHMuaSk7XHJcbi8vICAgICAgICAgY2FzZSAyOiByZXR1cm4gbmV3IGdlby5Qb2ludChjb29yZHMuaiwgY29vcmRzLmkpO1xyXG4vLyAgICAgICAgIGNhc2UgMzogcmV0dXJuIG5ldyBnZW8uUG9pbnQoY29vcmRzLmksIGNvb3Jkcy5qKTtcclxuLy8gICAgICAgICBjYXNlIDQ6IHJldHVybiBuZXcgZ2VvLlBvaW50KC1jb29yZHMuaSwgY29vcmRzLmopO1xyXG4vLyAgICAgICAgIGNhc2UgNTogcmV0dXJuIG5ldyBnZW8uUG9pbnQoLWNvb3Jkcy5qLCBjb29yZHMuaSk7XHJcbi8vICAgICAgICAgY2FzZSA2OiByZXR1cm4gbmV3IGdlby5Qb2ludCgtY29vcmRzLmosIC1jb29yZHMuaSk7XHJcbi8vICAgICAgICAgY2FzZSA3OiByZXR1cm4gbmV3IGdlby5Qb2ludCgtY29vcmRzLmksIC1jb29yZHMuaik7XHJcbi8vICAgICB9XHJcblxyXG4vLyAgICAgdGhyb3cgbmV3IEVycm9yKFwiSW52YWxpZCBvY3RhbnQgLSBtdXN0IGJlIGluIGludGVydmFsIFswLCA4KVwiKVxyXG4vLyB9XHJcblxyXG4vLyBmdW5jdGlvbiBpc1NoYWRvd2VkKHNoYWRvd3M6IGdlby5Qb2ludFtdLCBjb29yZHM6IGdlby5Qb2ludCk6IGJvb2xlYW4ge1xyXG4vLyAgICAgcmV0dXJuIGl0ZXIuYW55KHNoYWRvd3MsIHggPT4gc2hhZG93Q292ZXJzUG9pbnQoeCwgY29vcmRzKSlcclxuLy8gfVxyXG5cclxuLy8gZnVuY3Rpb24gc2hhZG93Q292ZXJzUG9pbnQoc2hhZG93OiBnZW8uUG9pbnQsIGNvb3JkczogZ2VvLlBvaW50KTogYm9vbGVhbiB7XHJcbi8vICAgICBpZiAoc2hhZG93LmogPT0gMCkge1xyXG4vLyAgICAgICAgIHJldHVybiBjb29yZHMuaSA+IHNoYWRvdy5pXHJcbi8vICAgICB9XHJcblxyXG4vLyAgICAgY29uc3Qgc3RhcnRKID0gc2hhZG93LmogLyAoc2hhZG93LmkgKyAxKSAqIGNvb3Jkcy5pXHJcbi8vICAgICBjb25zdCBlbmRKID0gKHNoYWRvdy5qICsgMSkgLyBzaGFkb3cuaSAqIGNvb3Jkcy5pXHJcblxyXG4vLyAgICAgcmV0dXJuIGNvb3Jkcy5pID4gc2hhZG93LmkgJiYgY29vcmRzLmogPiBzdGFydEogJiYgY29vcmRzLmogPCBlbmRKXHJcbi8vIH0iXX0=