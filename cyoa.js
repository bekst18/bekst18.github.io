import * as util from "./util.js";
init();
const state = {
    currentModule: null
};
function init() {
    initLoadUi();
    initPlayUi();
}
function initLoadUi() {
    const fileDropBox = util.byId("fileDropBox");
    const fileInput = util.byId("fileInput");
    const fileButton = util.byId("fileButton");
    const urlInput = util.byId("urlInput");
    const loadButton = util.byId("urlButton");
    fileButton.addEventListener("click", () => {
        fileInput.click();
    });
    fileDropBox.addEventListener("dragenter", onDragEnterOver);
    fileDropBox.addEventListener("dragover", onDragEnterOver);
    fileDropBox.addEventListener("drop", onFileDrop);
    fileInput.addEventListener("change", () => {
        if (!fileInput.files) {
            return;
        }
        processFiles(fileInput.files);
    });
    loadButton.addEventListener("click", () => {
        clearErrorMessages();
        const url = urlInput.value;
        if (!url) {
            appendErrorMessage("A valid url is required");
            return;
        }
        loadFromUrl(url);
    });
    // for now - debug current game
    loadFromUrl("cyoa.json");
}
function initPlayUi() {
    const choices = util.byId("choices");
    const tryAgain = util.byId("tryAgain");
    util.delegate(choices, "click", ".choice", (ev) => {
        if (!state.currentModule) {
            return;
        }
        handleChoice(state.currentModule, ev.target);
    });
    tryAgain.addEventListener("click", () => {
        if (!state.currentModule) {
            return;
        }
        loadModule(state.currentModule);
    });
}
function loadFromString(json) {
    try {
        const module = (JSON.parse(json));
        if (!validateModule(module)) {
            return;
        }
        // module is valid - proceed
        loadModule(module);
    }
    catch (x) {
        if (!(x instanceof Error)) {
            throw x;
        }
        appendErrorMessage(x.message);
    }
}
function onDragEnterOver(ev) {
    ev.stopPropagation();
    ev.preventDefault();
}
function onFileDrop(ev) {
    ev.stopPropagation();
    ev.preventDefault();
    if (ev.dataTransfer == null) {
        return;
    }
    processFiles(ev.dataTransfer.files);
}
async function loadFromUrl(url) {
    try {
        const response = await fetch(url);
        const json = await response.text();
        loadFromString(json);
    }
    catch (x) {
        if (x instanceof Error) {
            appendErrorMessage(x.message);
        }
        else {
            appendErrorMessage(x);
        }
    }
}
async function processFiles(files) {
    if (files.length == 0) {
        return;
    }
    const file = files[0];
    const json = await file.text();
    loadFromString(json);
}
function loadModule(module) {
    state.currentModule = module;
    const loadUi = util.byId("loadUi");
    const playUi = util.byId("playUi");
    loadUi.hidden = true;
    playUi.hidden = false;
    // load module title
    const moduleTitle = util.byId("moduleTitle");
    moduleTitle.textContent = module.title;
    // load initial passage
    const intro = module.passages[0];
    loadPassage(intro);
}
function loadPassage(passage) {
    console.log(passage);
    const passageTitle = util.byId("passageTitle");
    const passageDesc = util.byId("passageDesc");
    const choicesDiv = util.byId("choices");
    util.removeAllChildren(choicesDiv);
    passageTitle.textContent = passage.title;
    passageDesc.textContent = passage.desc;
    const template = util.byId("choiceTemplate");
    for (const choice of passage.choices) {
        const fragment = template.content.cloneNode(true);
        const choiceDiv = util.bySelector(fragment, ".choice");
        choiceDiv.dataset.passageId = choice.passageId;
        choiceDiv.textContent = choice.desc;
        choicesDiv.appendChild(fragment);
    }
    const tryAgain = util.byId("tryAgain");
    const end = util.byId("end");
    if (passage.choices.length == 0) {
        end.hidden = false;
        tryAgain.hidden = false;
    }
    else {
        end.hidden = true;
        tryAgain.hidden = true;
    }
}
function clearErrorMessages() {
    const errorsDiv = util.byId("errors");
    util.removeAllChildren(errorsDiv);
}
function validateModule(module) {
    clearErrorMessages();
    if (!module) {
        appendErrorMessage("No module was found - .json file should contain a top level module object.");
        return false;
    }
    if (!module.title) {
        appendErrorMessage("Module title is required.");
        return false;
    }
    if (!module.desc) {
        appendErrorMessage("Module desc is required.");
        return false;
    }
    if (!module.passages) {
        appendErrorMessage("Module must contain at least one passage.");
        return false;
    }
    for (const passage of module.passages) {
        validatePassage(module, passage);
    }
    return true;
}
function validatePassage(module, passage) {
    var _a, _b;
    passage.id = ((_a = passage.id) !== null && _a !== void 0 ? _a : "").toUpperCase().trim();
    if (!passage.desc) {
        appendErrorMessage("Each passage must have a description.");
    }
    passage.choices = (_b = passage.choices) !== null && _b !== void 0 ? _b : [];
    for (const choice of passage.choices) {
        validateChoice(module, choice);
    }
}
function validateChoice(module, choice) {
    if (!choice.desc) {
        appendErrorMessage("Each choice must have a description.");
    }
    if (!choice.passageId) {
        appendErrorMessage("Each choice must have a passageId.");
    }
    else if (!findPassageById(module, choice.passageId)) {
        appendErrorMessage(`Could not passage with id of ${choice.passageId}`);
    }
}
function findPassageById(module, id) {
    id = id.toUpperCase().trim();
    return module.passages.find(p => p.id.toUpperCase() == id);
}
function appendErrorMessage(error) {
    const errorsDiv = util.byId("errors");
    const div = document.createElement("div");
    div.classList.add("error-message");
    div.textContent = error;
    errorsDiv.appendChild(div);
}
function handleChoice(module, choice) {
    const passageId = choice.dataset.passageId;
    if (!passageId) {
        throw Error(`Missing passage for choice: ${choice.textContent}`);
    }
    const passage = findPassageById(module, passageId);
    if (!passage) {
        throw Error(`Missing passage for choice: ${choice.textContent} with id ${passageId}`);
    }
    loadPassage(passage);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3lvYS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImN5b2EudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxLQUFLLElBQUksTUFBTSxXQUFXLENBQUE7QUFFakMsSUFBSSxFQUFFLENBQUE7QUF3Qk4sTUFBTSxLQUFLLEdBQVU7SUFDakIsYUFBYSxFQUFFLElBQUk7Q0FDdEIsQ0FBQTtBQUVELFNBQVMsSUFBSTtJQUNULFVBQVUsRUFBRSxDQUFBO0lBQ1osVUFBVSxFQUFFLENBQUE7QUFDaEIsQ0FBQztBQUVELFNBQVMsVUFBVTtJQUNmLE1BQU0sV0FBVyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFtQixDQUFBO0lBQzlELE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFxQixDQUFBO0lBQzVELE1BQU0sVUFBVSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFzQixDQUFBO0lBQy9ELE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFxQixDQUFBO0lBQzFELE1BQU0sVUFBVSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFzQixDQUFBO0lBRTlELFVBQVUsQ0FBQyxnQkFBZ0IsQ0FBQyxPQUFPLEVBQUUsR0FBRyxFQUFFO1FBQ3RDLFNBQVMsQ0FBQyxLQUFLLEVBQUUsQ0FBQTtJQUNyQixDQUFDLENBQUMsQ0FBQTtJQUVGLFdBQVcsQ0FBQyxnQkFBZ0IsQ0FBQyxXQUFXLEVBQUUsZUFBZSxDQUFDLENBQUE7SUFDMUQsV0FBVyxDQUFDLGdCQUFnQixDQUFDLFVBQVUsRUFBRSxlQUFlLENBQUMsQ0FBQTtJQUN6RCxXQUFXLENBQUMsZ0JBQWdCLENBQUMsTUFBTSxFQUFFLFVBQVUsQ0FBQyxDQUFBO0lBRWhELFNBQVMsQ0FBQyxnQkFBZ0IsQ0FBQyxRQUFRLEVBQUUsR0FBRyxFQUFFO1FBQ3RDLElBQUksQ0FBQyxTQUFTLENBQUMsS0FB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RyxDQUFDLGVBQWUsQ0FBQyxDQUFBO0lBQ2xDLEdBQUcsQ0FBQyxXQUFXLEdBQUcsS0FBSyxDQUFBO0lBQ3ZCLFNBQVMsQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLENBQUE7QUFDOUIsQ0FBQztBQUVELFNBQVMsWUFBWSxDQUFDLE1BQWMsRUFBRSxNQUFzQjtJQUN4RCxNQUFNLFNBQVMsR0FBRyxNQUFNLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQTtJQUMxQyxJQUFJLENBQUMsU0FBUyxFQUFFO1FBQ1osTUFBTSxLQUFLLENBQUMsK0JBQStCLE1BQU0sQ0FBQyxXQUFXLEVBQUUsQ0FBQyxDQUFBO0tBQ25FO0lBRUQsTUFBTSxPQUFPLEdBQUcsZUFBZSxDQUFDLE1BQU0sRUFBRSxTQUFTLENBQUMsQ0FBQTtJQUNsRCxJQUFJLENBQUMsT0FBTyxFQUFFO1FBQ1YsTUFBTSxLQUFLLENBQUMsK0JBQStCLE1BQU0sQ0FBQyxXQUFXLFlBQVksU0FBUyxFQUFFLENBQUMsQ0FBQTtLQUN4RjtJQUVELFdBQVcsQ0FBQyxPQUFPLENBQUMsQ0FBQTtBQUN4QixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgdXRpbCBmcm9tIFwiLi91dGlsLmpzXCJcclxuXHJcbmluaXQoKVxyXG5cclxuaW50ZXJmYWNlIE1vZHVsZSB7XHJcbiAgICB0aXRsZTogc3RyaW5nXHJcbiAgICBkZXNjOiBzdHJpbmdcclxuICAgIHBhc3NhZ2VzOiBQYXNzYWdlW11cclxufVxyXG5cclxuaW50ZXJmYWNlIFBhc3NhZ2Uge1xyXG4gICAgaWQ6IHN0cmluZ1xyXG4gICAgdGl0bGU6IHN0cmluZ1xyXG4gICAgZGVzYzogc3RyaW5nXHJcbiAgICBjaG9pY2VzOiBDaG9pY2VbXVxyXG59XHJcblxyXG5pbnRlcmZhY2UgQ2hvaWNlIHtcclxuICAgIGRlc2M6IHN0cmluZ1xyXG4gICAgcGFzc2FnZUlkOiBzdHJpbmdcclxufVxyXG5cclxuaW50ZXJmYWNlIFN0YXRlIHtcclxuICAgIGN1cnJlbnRNb2R1bGU6IG51bGwgfCBNb2R1bGVcclxufVxyXG5cclxuY29uc3Qgc3RhdGU6IFN0YXRlID0ge1xyXG4gICAgY3VycmVudE1vZHVsZTogbnVsbFxyXG59XHJcblxyXG5mdW5jdGlvbiBpbml0KCkge1xyXG4gICAgaW5pdExvYWRVaSgpXHJcbiAgICBpbml0UGxheVVpKClcclxufVxyXG5cclxuZnVuY3Rpb24gaW5pdExvYWRVaSgpIHtcclxuICAgIGNvbnN0IGZpbGVEcm9wQm94ID0gdXRpbC5ieUlkKFwiZmlsZURyb3BCb3hcIikgYXMgSFRNTERpdkVsZW1lbnRcclxuICAgIGNvbnN0IGZpbGVJbnB1dCA9IHV0aWwuYnlJZChcImZpbGVJbnB1dFwiKSBhcyBIVE1MSW5wdXRFbGVtZW50XHJcbiAgICBjb25zdCBmaWxlQnV0dG9uID0gdXRpbC5ieUlkKFwiZmlsZUJ1dHRvblwiKSBhcyBIVE1MQnV0dG9uRWxlbWVudFxyXG4gICAgY29uc3QgdXJsSW5wdXQgPSB1dGlsLmJ5SWQoXCJ1cmxJbnB1dFwiKSBhcyBIVE1MSW5wdXRFbGVtZW50XHJcbiAgICBjb25zdCBsb2FkQnV0dG9uID0gdXRpbC5ieUlkKFwidXJsQnV0dG9uXCIpIGFzIEhUTUxCdXR0b25FbGVtZW50XHJcblxyXG4gICAgZmlsZUJ1dHRvbi5hZGRFdmVudExpc3RlbmVyKFwiY2xpY2tcIiwgKCkgPT4ge1xyXG4gICAgICAgIGZpbGVJbnB1dC5jbGljaygpXHJcbiAgICB9KVxyXG5cclxuICAgIGZpbGVEcm9wQm94LmFkZEV2ZW50TGlzdGVuZXIoXCJkcmFnZW50ZXJcIiwgb25EcmFnRW50ZXJPdmVyKVxyXG4gICAgZmlsZURyb3BCb3guYWRkRXZlbnRMaXN0ZW5lcihcImRyYWdvdmVyXCIsIG9uRHJhZ0VudGVyT3ZlcilcclxuICAgIGZpbGVEcm9wQm94LmFkZEV2ZW50TGlzdGVuZXIoXCJkcm9wXCIsIG9uRmlsZURyb3ApXHJcblxyXG4gICAgZmlsZUlucHV0LmFkZEV2ZW50TGlzdGVuZXIoXCJjaGFuZ2VcIiwgKCkgPT4ge1xyXG4gICAgICAgIGlmICghZmlsZUlucHV0LmZpbGVzKSB7XHJcbiAgICAgICAgICAgIHJldHVyblxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcHJvY2Vzc0ZpbGVzKGZpbGVJbnB1dC5maWxlcylcclxuICAgIH0pXHJcblxyXG4gICAgbG9hZEJ1dHRvbi5hZGRFdmVudExpc3RlbmVyKFwiY2xpY2tcIiwgKCkgPT4ge1xyXG4gICAgICAgIGNsZWFyRXJyb3JNZXNzYWdlcygpXHJcblxyXG4gICAgICAgIGNvbnN0IHVybCA9IHVybElucHV0LnZhbHVlXHJcbiAgICAgICAgaWYgKCF1cmwpIHtcclxuICAgICAgICAgICAgYXBwZW5kRXJyb3JNZXNzYWdlKFwiQSB2YWxpZCB1cmwgaXMgcmVxdWlyZWRcIilcclxuICAgICAgICAgICAgcmV0dXJuXHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBsb2FkRnJvbVVybCh1cmwpXHJcbiAgICB9KVxyXG5cclxuICAgIC8vIGZvciBub3cgLSBkZWJ1ZyBjdXJyZW50IGdhbWVcclxuICAgIGxvYWRGcm9tVXJsKFwiY3lvYS5qc29uXCIpXHJcbn1cclxuXHJcbmZ1bmN0aW9uIGluaXRQbGF5VWkoKSB7XHJcbiAgICBjb25zdCBjaG9pY2VzID0gdXRpbC5ieUlkKFwiY2hvaWNlc1wiKVxyXG4gICAgY29uc3QgdHJ5QWdhaW4gPSB1dGlsLmJ5SWQoXCJ0cnlBZ2FpblwiKVxyXG5cclxuICAgIHV0aWwuZGVsZWdhdGUoY2hvaWNlcywgXCJjbGlja1wiLCBcIi5jaG9pY2VcIiwgKGV2KSA9PiB7XHJcbiAgICAgICAgaWYgKCFzdGF0ZS5jdXJyZW50TW9kdWxlKSB7XHJcbiAgICAgICAgICAgIHJldHVyblxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaGFuZGxlQ2hvaWNlKHN0YXRlLmN1cnJlbnRNb2R1bGUsIGV2LnRhcmdldCBhcyBIVE1MRGl2RWxlbWVudClcclxuICAgIH0pXHJcblxyXG4gICAgdHJ5QWdhaW4uYWRkRXZlbnRMaXN0ZW5lcihcImNsaWNrXCIsICgpID0+IHtcclxuICAgICAgICBpZiAoIXN0YXRlLmN1cnJlbnRNb2R1bGUpIHtcclxuICAgICAgICAgICAgcmV0dXJuXHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBsb2FkTW9kdWxlKHN0YXRlLmN1cnJlbnRNb2R1bGUpXHJcbiAgICB9KVxyXG59XHJcblxyXG5mdW5jdGlvbiBsb2FkRnJvbVN0cmluZyhqc29uOiBzdHJpbmcpIHtcclxuICAgIHRyeSB7XHJcbiAgICAgICAgY29uc3QgbW9kdWxlID0gPE1vZHVsZT4oSlNPTi5wYXJzZShqc29uKSlcclxuICAgICAgICBpZiAoIXZhbGlkYXRlTW9kdWxlKG1vZHVsZSkpIHtcclxuICAgICAgICAgICAgcmV0dXJuXHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAvLyBtb2R1bGUgaXMgdmFsaWQgLSBwcm9jZWVkXHJcbiAgICAgICAgbG9hZE1vZHVsZShtb2R1bGUpXHJcbiAgICB9XHJcbiAgICBjYXRjaCAoeCkge1xyXG4gICAgICAgIGlmICghKHggaW5zdGFuY2VvZiBFcnJvcikpIHtcclxuICAgICAgICAgICAgdGhyb3cgeFxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgYXBwZW5kRXJyb3JNZXNzYWdlKHgubWVzc2FnZSlcclxuICAgIH1cclxufVxyXG5cclxuZnVuY3Rpb24gb25EcmFnRW50ZXJPdmVyKGV2OiBEcmFnRXZlbnQpIHtcclxuICAgIGV2LnN0b3BQcm9wYWdhdGlvbigpXHJcbiAgICBldi5wcmV2ZW50RGVmYXVsdCgpXHJcbn1cclxuXHJcbmZ1bmN0aW9uIG9uRmlsZURyb3AoZXY6IERyYWdFdmVudCkge1xyXG4gICAgZXYuc3RvcFByb3BhZ2F0aW9uKClcclxuICAgIGV2LnByZXZlbnREZWZhdWx0KClcclxuXHJcbiAgICBpZiAoZXYuZGF0YVRyYW5zZmVyID09IG51bGwpIHtcclxuICAgICAgICByZXR1cm5cclxuICAgIH1cclxuXHJcbiAgICBwcm9jZXNzRmlsZXMoZXYuZGF0YVRyYW5zZmVyLmZpbGVzKVxyXG59XHJcblxyXG5hc3luYyBmdW5jdGlvbiBsb2FkRnJvbVVybCh1cmw6IHN0cmluZykge1xyXG4gICAgdHJ5IHtcclxuICAgICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGZldGNoKHVybClcclxuICAgICAgICBjb25zdCBqc29uID0gYXdhaXQgcmVzcG9uc2UudGV4dCgpXHJcbiAgICAgICAgbG9hZEZyb21TdHJpbmcoanNvbilcclxuXHJcbiAgICB9XHJcbiAgICBjYXRjaCAoeCkge1xyXG4gICAgICAgIGlmICh4IGluc3RhbmNlb2YgRXJyb3IpIHtcclxuICAgICAgICAgICAgYXBwZW5kRXJyb3JNZXNzYWdlKHgubWVzc2FnZSlcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBhcHBlbmRFcnJvck1lc3NhZ2UoeClcclxuICAgICAgICB9XHJcbiAgICB9XHJcbn1cclxuXHJcbmFzeW5jIGZ1bmN0aW9uIHByb2Nlc3NGaWxlcyhmaWxlczogRmlsZUxpc3QpIHtcclxuICAgIGlmIChmaWxlcy5sZW5ndGggPT0gMCkge1xyXG4gICAgICAgIHJldHVyblxyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IGZpbGUgPSBmaWxlc1swXVxyXG4gICAgY29uc3QganNvbiA9IGF3YWl0IGZpbGUudGV4dCgpXHJcbiAgICBsb2FkRnJvbVN0cmluZyhqc29uKVxyXG59XHJcblxyXG5mdW5jdGlvbiBsb2FkTW9kdWxlKG1vZHVsZTogTW9kdWxlKSB7XHJcbiAgICBzdGF0ZS5jdXJyZW50TW9kdWxlID0gbW9kdWxlXHJcbiAgICBjb25zdCBsb2FkVWkgPSB1dGlsLmJ5SWQoXCJsb2FkVWlcIik7XHJcbiAgICBjb25zdCBwbGF5VWkgPSB1dGlsLmJ5SWQoXCJwbGF5VWlcIik7XHJcbiAgICBsb2FkVWkuaGlkZGVuID0gdHJ1ZTtcclxuICAgIHBsYXlVaS5oaWRkZW4gPSBmYWxzZTtcclxuXHJcbiAgICAvLyBsb2FkIG1vZHVsZSB0aXRsZVxyXG4gICAgY29uc3QgbW9kdWxlVGl0bGUgPSB1dGlsLmJ5SWQoXCJtb2R1bGVUaXRsZVwiKVxyXG4gICAgbW9kdWxlVGl0bGUudGV4dENvbnRlbnQgPSBtb2R1bGUudGl0bGVcclxuXHJcbiAgICAvLyBsb2FkIGluaXRpYWwgcGFzc2FnZVxyXG4gICAgY29uc3QgaW50cm8gPSBtb2R1bGUucGFzc2FnZXNbMF1cclxuICAgIGxvYWRQYXNzYWdlKGludHJvKVxyXG59XHJcblxyXG5mdW5jdGlvbiBsb2FkUGFzc2FnZShwYXNzYWdlOiBQYXNzYWdlKSB7XHJcbiAgICBjb25zb2xlLmxvZyhwYXNzYWdlKVxyXG4gICAgY29uc3QgcGFzc2FnZVRpdGxlID0gdXRpbC5ieUlkKFwicGFzc2FnZVRpdGxlXCIpXHJcbiAgICBjb25zdCBwYXNzYWdlRGVzYyA9IHV0aWwuYnlJZChcInBhc3NhZ2VEZXNjXCIpXHJcbiAgICBjb25zdCBjaG9pY2VzRGl2ID0gdXRpbC5ieUlkKFwiY2hvaWNlc1wiKVxyXG4gICAgdXRpbC5yZW1vdmVBbGxDaGlsZHJlbihjaG9pY2VzRGl2KVxyXG5cclxuICAgIHBhc3NhZ2VUaXRsZS50ZXh0Q29udGVudCA9IHBhc3NhZ2UudGl0bGVcclxuICAgIHBhc3NhZ2VEZXNjLnRleHRDb250ZW50ID0gcGFzc2FnZS5kZXNjXHJcblxyXG4gICAgY29uc3QgdGVtcGxhdGUgPSB1dGlsLmJ5SWQoXCJjaG9pY2VUZW1wbGF0ZVwiKSBhcyBIVE1MVGVtcGxhdGVFbGVtZW50XHJcbiAgICBmb3IgKGNvbnN0IGNob2ljZSBvZiBwYXNzYWdlLmNob2ljZXMpIHtcclxuICAgICAgICBjb25zdCBmcmFnbWVudCA9IHRlbXBsYXRlLmNvbnRlbnQuY2xvbmVOb2RlKHRydWUpIGFzIERvY3VtZW50RnJhZ21lbnRcclxuICAgICAgICBjb25zdCBjaG9pY2VEaXYgPSB1dGlsLmJ5U2VsZWN0b3IoZnJhZ21lbnQsIFwiLmNob2ljZVwiKSBhcyBIVE1MRWxlbWVudFxyXG4gICAgICAgIGNob2ljZURpdi5kYXRhc2V0LnBhc3NhZ2VJZCA9IGNob2ljZS5wYXNzYWdlSWRcclxuICAgICAgICBjaG9pY2VEaXYudGV4dENvbnRlbnQgPSBjaG9pY2UuZGVzY1xyXG4gICAgICAgIGNob2ljZXNEaXYuYXBwZW5kQ2hpbGQoZnJhZ21lbnQpXHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgdHJ5QWdhaW4gPSB1dGlsLmJ5SWQoXCJ0cnlBZ2FpblwiKVxyXG4gICAgY29uc3QgZW5kID0gdXRpbC5ieUlkKFwiZW5kXCIpXHJcbiAgICBpZiAocGFzc2FnZS5jaG9pY2VzLmxlbmd0aCA9PSAwKSB7XHJcbiAgICAgICAgZW5kLmhpZGRlbiA9IGZhbHNlXHJcbiAgICAgICAgdHJ5QWdhaW4uaGlkZGVuID0gZmFsc2VcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgICAgZW5kLmhpZGRlbiA9IHRydWVcclxuICAgICAgICB0cnlBZ2Fpbi5oaWRkZW4gPSB0cnVlXHJcbiAgICB9XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGNsZWFyRXJyb3JNZXNzYWdlcygpIHtcclxuICAgIGNvbnN0IGVycm9yc0RpdiA9IHV0aWwuYnlJZChcImVycm9yc1wiKVxyXG4gICAgdXRpbC5yZW1vdmVBbGxDaGlsZHJlbihlcnJvcnNEaXYpXHJcbn1cclxuXHJcbmZ1bmN0aW9uIHZhbGlkYXRlTW9kdWxlKG1vZHVsZTogTW9kdWxlKTogYm9vbGVhbiB7XHJcbiAgICBjbGVhckVycm9yTWVzc2FnZXMoKVxyXG5cclxuICAgIGlmICghbW9kdWxlKSB7XHJcbiAgICAgICAgYXBwZW5kRXJyb3JNZXNzYWdlKFwiTm8gbW9kdWxlIHdhcyBmb3VuZCAtIC5qc29uIGZpbGUgc2hvdWxkIGNvbnRhaW4gYSB0b3AgbGV2ZWwgbW9kdWxlIG9iamVjdC5cIilcclxuICAgICAgICByZXR1cm4gZmFsc2VcclxuICAgIH1cclxuXHJcbiAgICBpZiAoIW1vZHVsZS50aXRsZSkge1xyXG4gICAgICAgIGFwcGVuZEVycm9yTWVzc2FnZShcIk1vZHVsZSB0aXRsZSBpcyByZXF1aXJlZC5cIilcclxuICAgICAgICByZXR1cm4gZmFsc2VcclxuICAgIH1cclxuXHJcbiAgICBpZiAoIW1vZHVsZS5kZXNjKSB7XHJcbiAgICAgICAgYXBwZW5kRXJyb3JNZXNzYWdlKFwiTW9kdWxlIGRlc2MgaXMgcmVxdWlyZWQuXCIpXHJcbiAgICAgICAgcmV0dXJuIGZhbHNlXHJcbiAgICB9XHJcblxyXG4gICAgaWYgKCFtb2R1bGUucGFzc2FnZXMpIHtcclxuICAgICAgICBhcHBlbmRFcnJvck1lc3NhZ2UoXCJNb2R1bGUgbXVzdCBjb250YWluIGF0IGxlYXN0IG9uZSBwYXNzYWdlLlwiKVxyXG4gICAgICAgIHJldHVybiBmYWxzZVxyXG4gICAgfVxyXG5cclxuICAgIGZvciAoY29uc3QgcGFzc2FnZSBvZiBtb2R1bGUucGFzc2FnZXMpIHtcclxuICAgICAgICB2YWxpZGF0ZVBhc3NhZ2UobW9kdWxlLCBwYXNzYWdlKVxyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiB0cnVlXHJcbn1cclxuXHJcbmZ1bmN0aW9uIHZhbGlkYXRlUGFzc2FnZShtb2R1bGU6IE1vZHVsZSwgcGFzc2FnZTogUGFzc2FnZSkge1xyXG4gICAgcGFzc2FnZS5pZCA9IChwYXNzYWdlLmlkID8/IFwiXCIpLnRvVXBwZXJDYXNlKCkudHJpbSgpXHJcblxyXG4gICAgaWYgKCFwYXNzYWdlLmRlc2MpIHtcclxuICAgICAgICBhcHBlbmRFcnJvck1lc3NhZ2UoXCJFYWNoIHBhc3NhZ2UgbXVzdCBoYXZlIGEgZGVzY3JpcHRpb24uXCIpXHJcbiAgICB9XHJcblxyXG4gICAgcGFzc2FnZS5jaG9pY2VzID0gcGFzc2FnZS5jaG9pY2VzID8/IFtdXHJcbiAgICBmb3IgKGNvbnN0IGNob2ljZSBvZiBwYXNzYWdlLmNob2ljZXMpIHtcclxuICAgICAgICB2YWxpZGF0ZUNob2ljZShtb2R1bGUsIGNob2ljZSlcclxuICAgIH1cclxufVxyXG5cclxuZnVuY3Rpb24gdmFsaWRhdGVDaG9pY2UobW9kdWxlOiBNb2R1bGUsIGNob2ljZTogQ2hvaWNlKSB7XHJcbiAgICBpZiAoIWNob2ljZS5kZXNjKSB7XHJcbiAgICAgICAgYXBwZW5kRXJyb3JNZXNzYWdlKFwiRWFjaCBjaG9pY2UgbXVzdCBoYXZlIGEgZGVzY3JpcHRpb24uXCIpXHJcbiAgICB9XHJcblxyXG4gICAgaWYgKCFjaG9pY2UucGFzc2FnZUlkKSB7XHJcbiAgICAgICAgYXBwZW5kRXJyb3JNZXNzYWdlKFwiRWFjaCBjaG9pY2UgbXVzdCBoYXZlIGEgcGFzc2FnZUlkLlwiKVxyXG4gICAgfSBlbHNlIGlmICghZmluZFBhc3NhZ2VCeUlkKG1vZHVsZSwgY2hvaWNlLnBhc3NhZ2VJZCkpIHtcclxuICAgICAgICBhcHBlbmRFcnJvck1lc3NhZ2UoYENvdWxkIG5vdCBwYXNzYWdlIHdpdGggaWQgb2YgJHtjaG9pY2UucGFzc2FnZUlkfWApXHJcbiAgICB9XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGZpbmRQYXNzYWdlQnlJZChtb2R1bGU6IE1vZHVsZSwgaWQ6IHN0cmluZyk6IChQYXNzYWdlIHwgdW5kZWZpbmVkKSB7XHJcbiAgICBpZCA9IGlkLnRvVXBwZXJDYXNlKCkudHJpbSgpXHJcbiAgICByZXR1cm4gbW9kdWxlLnBhc3NhZ2VzLmZpbmQocCA9PiBwLmlkLnRvVXBwZXJDYXNlKCkgPT0gaWQpXHJcbn1cclxuXHJcbmZ1bmN0aW9uIGFwcGVuZEVycm9yTWVzc2FnZShlcnJvcjogc3RyaW5nKSB7XHJcbiAgICBjb25zdCBlcnJvcnNEaXYgPSB1dGlsLmJ5SWQoXCJlcnJvcnNcIik7XHJcbiAgICBjb25zdCBkaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwiZGl2XCIpO1xyXG4gICAgZGl2LmNsYXNzTGlzdC5hZGQoXCJlcnJvci1tZXNzYWdlXCIpXHJcbiAgICBkaXYudGV4dENvbnRlbnQgPSBlcnJvclxyXG4gICAgZXJyb3JzRGl2LmFwcGVuZENoaWxkKGRpdilcclxufVxyXG5cclxuZnVuY3Rpb24gaGFuZGxlQ2hvaWNlKG1vZHVsZTogTW9kdWxlLCBjaG9pY2U6IEhUTUxEaXZFbGVtZW50KSB7XHJcbiAgICBjb25zdCBwYXNzYWdlSWQgPSBjaG9pY2UuZGF0YXNldC5wYXNzYWdlSWRcclxuICAgIGlmICghcGFzc2FnZUlkKSB7XHJcbiAgICAgICAgdGhyb3cgRXJyb3IoYE1pc3NpbmcgcGFzc2FnZSBmb3IgY2hvaWNlOiAke2Nob2ljZS50ZXh0Q29udGVudH1gKVxyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IHBhc3NhZ2UgPSBmaW5kUGFzc2FnZUJ5SWQobW9kdWxlLCBwYXNzYWdlSWQpXHJcbiAgICBpZiAoIXBhc3NhZ2UpIHtcclxuICAgICAgICB0aHJvdyBFcnJvcihgTWlzc2luZyBwYXNzYWdlIGZvciBjaG9pY2U6ICR7Y2hvaWNlLnRleHRDb250ZW50fSB3aXRoIGlkICR7cGFzc2FnZUlkfWApXHJcbiAgICB9XHJcblxyXG4gICAgbG9hZFBhc3NhZ2UocGFzc2FnZSlcclxufSJdfQ==