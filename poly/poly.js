import * as dom from "../shared/dom.js";
import * as math from "../shared/math.js";
function init() {
    const canvas = dom.byId("canvas");
    const ctx = canvas.getContext("2d");
    if (!ctx) {
        throw new Error("Failed to create canvas, no browser support?");
    }
    const clearButton = dom.byId("clear");
    const xSpan = dom.byId("x");
    const ySpan = dom.byId("y");
    let poly = new Array();
    let vertices = new Array();
    let diags = new Array();
    canvas.addEventListener("pointerup", onCanvasClick);
    canvas.addEventListener("pointermove", onCanvasMove);
    canvas.addEventListener("contextmenu", (e) => e.preventDefault());
    canvas.addEventListener("keypress", onCanvasKeypress);
    clearButton.addEventListener("click", onClearClick);
    function onCanvasClick(e) {
        if (e.button === 0) {
            poly.push([e.clientX, e.clientY]);
            reset();
            redraw();
        }
        else if (e.button === 2) {
            poly.pop();
            reset();
            redraw();
        }
    }
    function onCanvasMove(e) {
        const [x, y] = [e.clientX, e.clientY];
        xSpan.textContent = x.toString();
        ySpan.textContent = y.toString();
    }
    function onCanvasKeypress(e) {
        if (e.key === ' ') {
            const diag = step(vertices);
            if (diag) {
                diags.push(diag);
            }
            redraw();
        }
        if (e.key === 'r' || e.key === 'R') {
            reset();
            redraw();
        }
    }
    function reset() {
        vertices = beginTriangulation(poly);
        diags = [];
    }
    function redraw() {
        canvas.width = canvas.clientWidth;
        canvas.height = canvas.clientHeight;
        drawPoly();
        drawTriangulation();
    }
    function drawPoly() {
        // draw interior
        if (poly.length >= 3) {
            ctx.fillStyle = "lightgray";
            ctx.strokeStyle = "black";
            ctx.beginPath();
            for (const pt of poly) {
                const [x, y] = pt;
                ctx.lineTo(x, y);
            }
            {
                const [x, y] = poly[0];
                ctx.lineTo(x, y);
            }
            ctx.closePath();
            ctx.fill();
            ctx.stroke();
        }
        // draw vertices
        ctx.strokeStyle = "black";
        ctx.fillStyle = "gray";
        for (const pt of poly) {
            let radius = 3;
            const [x, y] = pt;
            ctx.beginPath();
            ctx.arc(x, y, radius, 0, Math.PI * 2);
            ctx.closePath();
            ctx.fill();
            ctx.stroke();
        }
    }
    function drawTriangulation() {
        // draw interior
        if (vertices.length >= 3) {
            ctx.fillStyle = "darkgray";
            ctx.strokeStyle = "black";
            ctx.beginPath();
            for (const v of vertices) {
                const { x, y } = v;
                ctx.lineTo(x, y);
            }
            {
                const { x, y } = vertices[0];
                ctx.lineTo(x, y);
            }
            ctx.closePath();
            ctx.fill();
            ctx.stroke();
        }
        // draw diagonals
        ctx.strokeStyle = "red";
        for (const diag of diags) {
            const [x0, y0, x1, y1] = diag;
            ctx.beginPath();
            ctx.setLineDash([1, 2]);
            ctx.lineTo(x0, y0);
            ctx.setLineDash([1, 2]);
            ctx.lineTo(x1, y1);
            ctx.closePath();
            ctx.stroke();
        }
        // draw vertices
        ctx.strokeStyle = "black";
        const textHeight = ctx.measureText("M").width;
        for (let i = 0; i < vertices.length; ++i) {
            let radius = 9;
            const { x, y, reflex, ear } = vertices[i];
            ctx.fillStyle = "blue";
            if (ear) {
                ctx.fillStyle = "green";
                radius = 9;
            }
            else if (reflex) {
                ctx.fillStyle = "red";
                radius = 9;
            }
            ctx.beginPath();
            ctx.arc(x, y, radius, 0, Math.PI * 2);
            ctx.closePath();
            ctx.fill();
            ctx.stroke();
            ctx.fillStyle = "black";
            const label = i.toString();
            const metrics = ctx.measureText(label);
            ctx.fillText(i.toString(), x - metrics.width / 2, y + textHeight / 2);
        }
    }
    function onClearClick() {
        poly = [];
        reset();
        redraw();
    }
}
function beginTriangulation(poly) {
    const vertices = poly.map(pt => ({ x: pt[0], y: pt[1], reflex: false, ear: false }));
    // determine initial status of every vertex
    for (let i = 0; i < vertices.length; ++i) {
        updateReflex(vertices, i);
    }
    // determine status of every vertex
    for (let i = 0; i < vertices.length; ++i) {
        updateEar(vertices, i);
    }
    return vertices;
}
function step(vertices) {
    if (vertices.length <= 3) {
        return null;
    }
    // start removing ears!
    // copy initial array, then splice triangles off one by one
    // find ear
    const i1 = vertices.findIndex(v => v.ear);
    if (i1 === -1) {
        throw new Error("No ear found");
    }
    const i0 = math.mod(i1 - 1, vertices.length);
    const i2 = math.mod(i1 + 1, vertices.length);
    const { x: x0, y: y0 } = vertices[i0];
    const { x: x2, y: y2 } = vertices[i2];
    vertices.splice(i1, 1);
    updateStatus(vertices, math.mod(i1 - 1, vertices.length));
    return ([x0, y0, x2, y2]);
}
// function triangulate(vs: Vertex[]): Array<[number, number, number, number]> {
//     for (const v of vs) {
//         v.status = Status.none
//     }
//     if (vs.length <= 3) {
//         return []
//     }
//     // determine status of every vertex
//     for (let i = 0; i < vs.length; ++i) {
//         updateReflex(vs, i)
//     }
//     // determine status of every vertex
//     for (let i = 0; i < vs.length; ++i) {
//         updateEar(vs, i)
//     }
//     // start removing ears!
//     // copy initial array, then splice triangles off one by one
//     const diags = new Array<[number, number, number, number]>()
//     while (vs.length > 3) {
//         // find ear
//         const i1 = vs.findIndex(v => v.status === Status.ear)
//         if (i1 === -1) {
//             throw new Error("No ear found")
//         }
//         const i0 = math.mod(i1 - 1, vs.length)
//         const i2 = math.mod(i1 + 1, vs.length)
//         const { x: x0, y: y0 } = vs[i0]
//         const { x: x2, y: y2 } = vs[i2]
//         diags.push([x0, y0, x2, y2])
//         vs.splice(i1, 1)
//         updateStatus(vs, math.mod(i1 - 1, vs.length))
//     }
//     // final triangle (does this line always already exist?)
//     // diags.push([vs[0].x, vs[0].y, vs[2].x, vs[2].y])
//     return diags
// }
// update status of two adjacent vertices
function updateStatus(vs, i0) {
    const i1 = math.mod(i0 + 1, vs.length);
    console.log(vs, i0, i1);
    // convex can't become reflex
    const v0 = vs[i0];
    if (v0.reflex) {
        updateReflex(vs, i0);
    }
    const v1 = vs[i1];
    if (v1.reflex) {
        updateReflex(vs, i1);
    }
    updateEar(vs, i0);
    updateEar(vs, i1);
}
function updateEar(vs, i) {
    const n = vs.length;
    const v0 = vs[math.mod(i - 1, n)];
    const v1 = vs[i];
    const v2 = vs[math.mod(i + 1, n)];
    const i3 = math.mod(i + 2, n);
    // reflex can't also be ear
    if (v1.reflex) {
        v1.ear = false;
        return;
    }
    // update ear status
    // check other vertices to determine if they are in triangle
    for (let j = 0; j < n - 3; ++j) {
        const jj = (i3 + j) % n;
        const { x, y, reflex } = vs[jj];
        // must be reflex to be inside triangle
        if (!reflex) {
            continue;
        }
        if (leftTurn(x, y, v0.x, v0.y, v1.x, v1.y)
            && leftTurn(x, y, v1.x, v1.y, v2.x, v2.y)
            && leftTurn(x, y, v2.x, v2.y, v0.x, v0.y)) {
            v1.ear = false;
            return;
        }
    }
    v1.ear = true;
}
function updateReflex(vs, i) {
    console.log("update reflex", i, vs);
    const n = vs.length;
    const v0 = vs[math.mod(i - 1, n)];
    const v1 = vs[i];
    const v2 = vs[math.mod(i + 1, n)];
    // is this a reflex vertex?
    // v1 is a reflex vertex if for ccw polygon a cw turn is made from v(i-1), vi, v(i+1)
    if (leftTurn(v0.x, v0.y, v1.x, v1.y, v2.x, v2.y)) {
        v1.reflex = false;
    }
    else {
        v1.reflex = true;
    }
}
function leftTurn(x0, y0, x1, y1, x2, y2) {
    const ax = x2 - x0;
    const ay = y2 - y0;
    const bx = x1 - x0;
    const by = y1 - y0;
    return det(ax, ay, bx, by) > 0;
}
function det(x0, y0, x1, y1) {
    return x0 * y1 - y0 * x1;
}
init();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG9seS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbInBvbHkudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxLQUFLLEdBQUcsTUFBTSxrQkFBa0IsQ0FBQTtBQUN2QyxPQUFPLEtBQUssSUFBSSxNQUFNLG1CQUFtQixDQUFBO0FBU3pDLFNBQVMsSUFBSTtJQUNULE1BQU0sTUFBTSxHQUFHLEdBQUcsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFzQixDQUFBO0lBQ3RELE1BQU0sR0FBRyxHQUFHLE1BQU0sQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFFLENBQUE7SUFDcEMsSUFBSSxDQUFDLEdBQUcsRUFBRTtRQUNOLE1BQU0sSUFBSSxLQUFLLENBQUMsOENBQThDLENBQUMsQ0FBQTtLQUNsRTtJQUVELE1BQU0sV0FBVyxHQUFHLEdBQUcsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFzQixDQUFBO0lBQzFELE1BQU0sS0FBSyxHQUFHLEdBQUcsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFvQixDQUFBO0lBQzlDLE1BQU0sS0FBSyxHQUFHLEdBQUcsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFvQixDQUFBO0lBRTlDLElBQUksSUFBSSxHQUFHLElBQUksS0FBSyxFQUFvQixDQUFBO0lBQ3hDLElBQUksUUFBUSxHQUFHLElBQUksS0FBSyxFQUFVLENBQUE7SUFDbEMsSUFBSSxLQUFLLEdBQUcsSUFBSSxLQUFLLEVBQW9DLENBQUE7SUFFekQsTUFBTSxDQUFDLGdCQUFnQixDQUFDLFdBQVcsRUFBRSxhQUFhLENBQUMsQ0FBQTtJQUNuRCxNQUFNLENBQUMsZ0JBQWdCLENBQUMsYUFBYSxFQUFFLFlBQVksQ0FBQyxDQUFBO0lBQ3BELE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQyxhQUFhLEVBQUUsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxjQUFjLEVBQUUsQ0FBQyxDQUFBO0lBQ2pFLE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQyxVQUFVLEVBQUUs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RyxFQUFFLEdBQUcsRUFBRSxDQUFBO0FBQzVCLENBQUM7QUFFRCxJQUFJLEVBQUUsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIGRvbSBmcm9tIFwiLi4vc2hhcmVkL2RvbS5qc1wiXHJcbmltcG9ydCAqIGFzIG1hdGggZnJvbSBcIi4uL3NoYXJlZC9tYXRoLmpzXCJcclxuXHJcbmludGVyZmFjZSBWZXJ0ZXgge1xyXG4gICAgeDogbnVtYmVyXHJcbiAgICB5OiBudW1iZXJcclxuICAgIHJlZmxleDogYm9vbGVhblxyXG4gICAgZWFyOiBib29sZWFuXHJcbn1cclxuXHJcbmZ1bmN0aW9uIGluaXQoKSB7XHJcbiAgICBjb25zdCBjYW52YXMgPSBkb20uYnlJZChcImNhbnZhc1wiKSBhcyBIVE1MQ2FudmFzRWxlbWVudFxyXG4gICAgY29uc3QgY3R4ID0gY2FudmFzLmdldENvbnRleHQoXCIyZFwiKSFcclxuICAgIGlmICghY3R4KSB7XHJcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiRmFpbGVkIHRvIGNyZWF0ZSBjYW52YXMsIG5vIGJyb3dzZXIgc3VwcG9ydD9cIilcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBjbGVhckJ1dHRvbiA9IGRvbS5ieUlkKFwiY2xlYXJcIikgYXMgSFRNTEJ1dHRvbkVsZW1lbnRcclxuICAgIGNvbnN0IHhTcGFuID0gZG9tLmJ5SWQoXCJ4XCIpIGFzIEhUTUxTcGFuRWxlbWVudFxyXG4gICAgY29uc3QgeVNwYW4gPSBkb20uYnlJZChcInlcIikgYXMgSFRNTFNwYW5FbGVtZW50XHJcblxyXG4gICAgbGV0IHBvbHkgPSBuZXcgQXJyYXk8W251bWJlciwgbnVtYmVyXT4oKVxyXG4gICAgbGV0IHZlcnRpY2VzID0gbmV3IEFycmF5PFZlcnRleD4oKVxyXG4gICAgbGV0IGRpYWdzID0gbmV3IEFycmF5PFtudW1iZXIsIG51bWJlciwgbnVtYmVyLCBudW1iZXJdPigpXHJcblxyXG4gICAgY2FudmFzLmFkZEV2ZW50TGlzdGVuZXIoXCJwb2ludGVydXBcIiwgb25DYW52YXNDbGljaylcclxuICAgIGNhbnZhcy5hZGRFdmVudExpc3RlbmVyKFwicG9pbnRlcm1vdmVcIiwgb25DYW52YXNNb3ZlKVxyXG4gICAgY2FudmFzLmFkZEV2ZW50TGlzdGVuZXIoXCJjb250ZXh0bWVudVwiLCAoZSkgPT4gZS5wcmV2ZW50RGVmYXVsdCgpKVxyXG4gICAgY2FudmFzLmFkZEV2ZW50TGlzdGVuZXIoXCJrZXlwcmVzc1wiLCBvbkNhbnZhc0tleXByZXNzKVxyXG4gICAgY2xlYXJCdXR0b24uYWRkRXZlbnRMaXN0ZW5lcihcImNsaWNrXCIsIG9uQ2xlYXJDbGljaylcclxuXHJcbiAgICBmdW5jdGlvbiBvbkNhbnZhc0NsaWNrKGU6IFBvaW50ZXJFdmVudCkge1xyXG4gICAgICAgIGlmIChlLmJ1dHRvbiA9PT0gMCkge1xyXG4gICAgICAgICAgICBwb2x5LnB1c2goW2UuY2xpZW50WCwgZS5jbGllbnRZXSlcclxuICAgICAgICAgICAgcmVzZXQoKVxyXG4gICAgICAgICAgICByZWRyYXcoKVxyXG4gICAgICAgIH0gZWxzZSBpZiAoZS5idXR0b24gPT09IDIpIHtcclxuICAgICAgICAgICAgcG9seS5wb3AoKVxyXG4gICAgICAgICAgICByZXNldCgpXHJcbiAgICAgICAgICAgIHJlZHJhdygpXHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIG9uQ2FudmFzTW92ZShlOiBQb2ludGVyRXZlbnQpIHtcclxuICAgICAgICBjb25zdCBbeCwgeV0gPSBbZS5jbGllbnRYLCBlLmNsaWVudFldXHJcbiAgICAgICAgeFNwYW4udGV4dENvbnRlbnQgPSB4LnRvU3RyaW5nKClcclxuICAgICAgICB5U3Bhbi50ZXh0Q29udGVudCA9IHkudG9TdHJpbmcoKVxyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIG9uQ2FudmFzS2V5cHJlc3MoZTogS2V5Ym9hcmRFdmVudCkge1xyXG4gICAgICAgIGlmIChlLmtleSA9PT0gJyAnKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGRpYWcgPSBzdGVwKHZlcnRpY2VzKVxyXG4gICAgICAgICAgICBpZiAoZGlhZykge1xyXG4gICAgICAgICAgICAgICAgZGlhZ3MucHVzaChkaWFnKVxyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICByZWRyYXcoKVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKGUua2V5ID09PSAncicgfHwgZS5rZXkgPT09ICdSJykge1xyXG4gICAgICAgICAgICByZXNldCgpXHJcbiAgICAgICAgICAgIHJlZHJhdygpXHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIHJlc2V0KCkge1xyXG4gICAgICAgIHZlcnRpY2VzID0gYmVnaW5Ucmlhbmd1bGF0aW9uKHBvbHkpXHJcbiAgICAgICAgZGlhZ3MgPSBbXVxyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIHJlZHJhdygpIHtcclxuICAgICAgICBjYW52YXMud2lkdGggPSBjYW52YXMuY2xpZW50V2lkdGhcclxuICAgICAgICBjYW52YXMuaGVpZ2h0ID0gY2FudmFzLmNsaWVudEhlaWdodFxyXG4gICAgICAgIGRyYXdQb2x5KClcclxuICAgICAgICBkcmF3VHJpYW5ndWxhdGlvbigpXHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gZHJhd1BvbHkoKSB7XHJcbiAgICAgICAgLy8gZHJhdyBpbnRlcmlvclxyXG4gICAgICAgIGlmIChwb2x5Lmxlbmd0aCA+PSAzKSB7XHJcbiAgICAgICAgICAgIGN0eC5maWxsU3R5bGUgPSBcImxpZ2h0Z3JheVwiXHJcbiAgICAgICAgICAgIGN0eC5zdHJva2VTdHlsZSA9IFwiYmxhY2tcIlxyXG4gICAgICAgICAgICBjdHguYmVnaW5QYXRoKClcclxuICAgICAgICAgICAgZm9yIChjb25zdCBwdCBvZiBwb2x5KSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBbeCwgeV0gPSBwdFxyXG4gICAgICAgICAgICAgICAgY3R4LmxpbmVUbyh4LCB5KVxyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBbeCwgeV0gPSBwb2x5WzBdXHJcbiAgICAgICAgICAgICAgICBjdHgubGluZVRvKHgsIHkpXHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGN0eC5jbG9zZVBhdGgoKVxyXG4gICAgICAgICAgICBjdHguZmlsbCgpXHJcbiAgICAgICAgICAgIGN0eC5zdHJva2UoKVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8gZHJhdyB2ZXJ0aWNlc1xyXG4gICAgICAgIGN0eC5zdHJva2VTdHlsZSA9IFwiYmxhY2tcIlxyXG4gICAgICAgIGN0eC5maWxsU3R5bGUgPSBcImdyYXlcIlxyXG4gICAgICAgIGZvciAoY29uc3QgcHQgb2YgcG9seSkge1xyXG4gICAgICAgICAgICBsZXQgcmFkaXVzID0gM1xyXG4gICAgICAgICAgICBjb25zdCBbeCwgeV0gPSBwdFxyXG4gICAgICAgICAgICBjdHguYmVnaW5QYXRoKClcclxuICAgICAgICAgICAgY3R4LmFyYyh4LCB5LCByYWRpdXMsIDAsIE1hdGguUEkgKiAyKVxyXG4gICAgICAgICAgICBjdHguY2xvc2VQYXRoKClcclxuICAgICAgICAgICAgY3R4LmZpbGwoKVxyXG4gICAgICAgICAgICBjdHguc3Ryb2tlKClcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gZHJhd1RyaWFuZ3VsYXRpb24oKSB7XHJcbiAgICAgICAgLy8gZHJhdyBpbnRlcmlvclxyXG4gICAgICAgIGlmICh2ZXJ0aWNlcy5sZW5ndGggPj0gMykge1xyXG4gICAgICAgICAgICBjdHguZmlsbFN0eWxlID0gXCJkYXJrZ3JheVwiXHJcbiAgICAgICAgICAgIGN0eC5zdHJva2VTdHlsZSA9IFwiYmxhY2tcIlxyXG4gICAgICAgICAgICBjdHguYmVnaW5QYXRoKClcclxuICAgICAgICAgICAgZm9yIChjb25zdCB2IG9mIHZlcnRpY2VzKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCB7IHgsIHkgfSA9IHZcclxuICAgICAgICAgICAgICAgIGN0eC5saW5lVG8oeCwgeSlcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgeyB4LCB5IH0gPSB2ZXJ0aWNlc1swXVxyXG4gICAgICAgICAgICAgICAgY3R4LmxpbmVUbyh4LCB5KVxyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBjdHguY2xvc2VQYXRoKClcclxuICAgICAgICAgICAgY3R4LmZpbGwoKVxyXG4gICAgICAgICAgICBjdHguc3Ryb2tlKClcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8vIGRyYXcgZGlhZ29uYWxzXHJcbiAgICAgICAgY3R4LnN0cm9rZVN0eWxlID0gXCJyZWRcIlxyXG4gICAgICAgIGZvciAoY29uc3QgZGlhZyBvZiBkaWFncykge1xyXG4gICAgICAgICAgICBjb25zdCBbeDAsIHkwLCB4MSwgeTFdID0gZGlhZ1xyXG4gICAgICAgICAgICBjdHguYmVnaW5QYXRoKClcclxuICAgICAgICAgICAgY3R4LnNldExpbmVEYXNoKFsxLCAyXSlcclxuICAgICAgICAgICAgY3R4LmxpbmVUbyh4MCwgeTApXHJcbiAgICAgICAgICAgIGN0eC5zZXRMaW5lRGFzaChbMSwgMl0pXHJcbiAgICAgICAgICAgIGN0eC5saW5lVG8oeDEsIHkxKVxyXG4gICAgICAgICAgICBjdHguY2xvc2VQYXRoKClcclxuICAgICAgICAgICAgY3R4LnN0cm9rZSgpXHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAvLyBkcmF3IHZlcnRpY2VzXHJcbiAgICAgICAgY3R4LnN0cm9rZVN0eWxlID0gXCJibGFja1wiXHJcbiAgICAgICAgY29uc3QgdGV4dEhlaWdodCA9IGN0eC5tZWFzdXJlVGV4dChcIk1cIikud2lkdGhcclxuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHZlcnRpY2VzLmxlbmd0aDsgKytpKSB7XHJcbiAgICAgICAgICAgIGxldCByYWRpdXMgPSA5XHJcbiAgICAgICAgICAgIGNvbnN0IHsgeCwgeSwgcmVmbGV4LCBlYXIgfSA9IHZlcnRpY2VzW2ldXHJcblxyXG4gICAgICAgICAgICBjdHguZmlsbFN0eWxlID0gXCJibHVlXCJcclxuICAgICAgICAgICAgaWYgKGVhcikge1xyXG4gICAgICAgICAgICAgICAgY3R4LmZpbGxTdHlsZSA9IFwiZ3JlZW5cIlxyXG4gICAgICAgICAgICAgICAgcmFkaXVzID0gOVxyXG4gICAgICAgICAgICB9IGVsc2UgaWYgKHJlZmxleCkge1xyXG4gICAgICAgICAgICAgICAgY3R4LmZpbGxTdHlsZSA9IFwicmVkXCJcclxuICAgICAgICAgICAgICAgIHJhZGl1cyA9IDlcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpXHJcbiAgICAgICAgICAgIGN0eC5hcmMoeCwgeSwgcmFkaXVzLCAwLCBNYXRoLlBJICogMilcclxuICAgICAgICAgICAgY3R4LmNsb3NlUGF0aCgpXHJcbiAgICAgICAgICAgIGN0eC5maWxsKClcclxuICAgICAgICAgICAgY3R4LnN0cm9rZSgpXHJcblxyXG4gICAgICAgICAgICBjdHguZmlsbFN0eWxlID0gXCJibGFja1wiXHJcbiAgICAgICAgICAgIGNvbnN0IGxhYmVsID0gaS50b1N0cmluZygpXHJcbiAgICAgICAgICAgIGNvbnN0IG1ldHJpY3MgPSBjdHgubWVhc3VyZVRleHQobGFiZWwpXHJcbiAgICAgICAgICAgIGN0eC5maWxsVGV4dChpLnRvU3RyaW5nKCksIHggLSBtZXRyaWNzLndpZHRoIC8gMiwgeSArIHRleHRIZWlnaHQgLyAyKVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBvbkNsZWFyQ2xpY2soKSB7XHJcbiAgICAgICAgcG9seSA9IFtdXHJcbiAgICAgICAgcmVzZXQoKVxyXG4gICAgICAgIHJlZHJhdygpXHJcbiAgICB9XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGJlZ2luVHJpYW5ndWxhdGlvbihwb2x5OiBbbnVtYmVyLCBudW1iZXJdW10pOiBWZXJ0ZXhbXSB7XHJcbiAgICBjb25zdCB2ZXJ0aWNlcyA9IHBvbHkubWFwKHB0ID0+ICh7IHg6IHB0WzBdLCB5OiBwdFsxXSwgcmVmbGV4OiBmYWxzZSwgZWFyOiBmYWxzZSB9KSlcclxuXHJcbiAgICAvLyBkZXRlcm1pbmUgaW5pdGlhbCBzdGF0dXMgb2YgZXZlcnkgdmVydGV4XHJcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHZlcnRpY2VzLmxlbmd0aDsgKytpKSB7XHJcbiAgICAgICAgdXBkYXRlUmVmbGV4KHZlcnRpY2VzLCBpKVxyXG4gICAgfVxyXG5cclxuICAgIC8vIGRldGVybWluZSBzdGF0dXMgb2YgZXZlcnkgdmVydGV4XHJcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHZlcnRpY2VzLmxlbmd0aDsgKytpKSB7XHJcbiAgICAgICAgdXBkYXRlRWFyKHZlcnRpY2VzLCBpKVxyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiB2ZXJ0aWNlc1xyXG59XHJcblxyXG5mdW5jdGlvbiBzdGVwKHZlcnRpY2VzOiBWZXJ0ZXhbXSk6IFtudW1iZXIsIG51bWJlciwgbnVtYmVyLCBudW1iZXJdIHwgbnVsbCB7XHJcbiAgICBpZiAodmVydGljZXMubGVuZ3RoIDw9IDMpIHtcclxuICAgICAgICByZXR1cm4gbnVsbFxyXG4gICAgfVxyXG5cclxuICAgIC8vIHN0YXJ0IHJlbW92aW5nIGVhcnMhXHJcbiAgICAvLyBjb3B5IGluaXRpYWwgYXJyYXksIHRoZW4gc3BsaWNlIHRyaWFuZ2xlcyBvZmYgb25lIGJ5IG9uZVxyXG4gICAgLy8gZmluZCBlYXJcclxuICAgIGNvbnN0IGkxID0gdmVydGljZXMuZmluZEluZGV4KHYgPT4gdi5lYXIpXHJcbiAgICBpZiAoaTEgPT09IC0xKSB7XHJcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiTm8gZWFyIGZvdW5kXCIpXHJcbiAgICB9XHJcbiBcclxuICAgIGNvbnN0IGkwID0gbWF0aC5tb2QoaTEgLSAxLCB2ZXJ0aWNlcy5sZW5ndGgpXHJcbiAgICBjb25zdCBpMiA9IG1hdGgubW9kKGkxICsgMSwgdmVydGljZXMubGVuZ3RoKVxyXG4gICAgY29uc3QgeyB4OiB4MCwgeTogeTAgfSA9IHZlcnRpY2VzW2kwXVxyXG4gICAgY29uc3QgeyB4OiB4MiwgeTogeTIgfSA9IHZlcnRpY2VzW2kyXVxyXG5cclxuICAgIHZlcnRpY2VzLnNwbGljZShpMSwgMSlcclxuICAgIHVwZGF0ZVN0YXR1cyh2ZXJ0aWNlcywgbWF0aC5tb2QoaTEgLSAxLCB2ZXJ0aWNlcy5sZW5ndGgpKVxyXG5cclxuICAgIHJldHVybiAoW3gwLCB5MCwgeDIsIHkyXSlcclxufVxyXG5cclxuLy8gZnVuY3Rpb24gdHJpYW5ndWxhdGUodnM6IFZlcnRleFtdKTogQXJyYXk8W251bWJlciwgbnVtYmVyLCBudW1iZXIsIG51bWJlcl0+IHtcclxuLy8gICAgIGZvciAoY29uc3QgdiBvZiB2cykge1xyXG4vLyAgICAgICAgIHYuc3RhdHVzID0gU3RhdHVzLm5vbmVcclxuLy8gICAgIH1cclxuXHJcbi8vICAgICBpZiAodnMubGVuZ3RoIDw9IDMpIHtcclxuLy8gICAgICAgICByZXR1cm4gW11cclxuLy8gICAgIH1cclxuXHJcbi8vICAgICAvLyBkZXRlcm1pbmUgc3RhdHVzIG9mIGV2ZXJ5IHZlcnRleFxyXG4vLyAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB2cy5sZW5ndGg7ICsraSkge1xyXG4vLyAgICAgICAgIHVwZGF0ZVJlZmxleCh2cywgaSlcclxuLy8gICAgIH1cclxuXHJcbi8vICAgICAvLyBkZXRlcm1pbmUgc3RhdHVzIG9mIGV2ZXJ5IHZlcnRleFxyXG4vLyAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB2cy5sZW5ndGg7ICsraSkge1xyXG4vLyAgICAgICAgIHVwZGF0ZUVhcih2cywgaSlcclxuLy8gICAgIH1cclxuXHJcbi8vICAgICAvLyBzdGFydCByZW1vdmluZyBlYXJzIVxyXG4vLyAgICAgLy8gY29weSBpbml0aWFsIGFycmF5LCB0aGVuIHNwbGljZSB0cmlhbmdsZXMgb2ZmIG9uZSBieSBvbmVcclxuLy8gICAgIGNvbnN0IGRpYWdzID0gbmV3IEFycmF5PFtudW1iZXIsIG51bWJlciwgbnVtYmVyLCBudW1iZXJdPigpXHJcbi8vICAgICB3aGlsZSAodnMubGVuZ3RoID4gMykge1xyXG4vLyAgICAgICAgIC8vIGZpbmQgZWFyXHJcbi8vICAgICAgICAgY29uc3QgaTEgPSB2cy5maW5kSW5kZXgodiA9PiB2LnN0YXR1cyA9PT0gU3RhdHVzLmVhcilcclxuLy8gICAgICAgICBpZiAoaTEgPT09IC0xKSB7XHJcbi8vICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcIk5vIGVhciBmb3VuZFwiKVxyXG4vLyAgICAgICAgIH1cclxuXHJcbi8vICAgICAgICAgY29uc3QgaTAgPSBtYXRoLm1vZChpMSAtIDEsIHZzLmxlbmd0aClcclxuLy8gICAgICAgICBjb25zdCBpMiA9IG1hdGgubW9kKGkxICsgMSwgdnMubGVuZ3RoKVxyXG4vLyAgICAgICAgIGNvbnN0IHsgeDogeDAsIHk6IHkwIH0gPSB2c1tpMF1cclxuLy8gICAgICAgICBjb25zdCB7IHg6IHgyLCB5OiB5MiB9ID0gdnNbaTJdXHJcbi8vICAgICAgICAgZGlhZ3MucHVzaChbeDAsIHkwLCB4MiwgeTJdKVxyXG5cclxuLy8gICAgICAgICB2cy5zcGxpY2UoaTEsIDEpXHJcbi8vICAgICAgICAgdXBkYXRlU3RhdHVzKHZzLCBtYXRoLm1vZChpMSAtIDEsIHZzLmxlbmd0aCkpXHJcbi8vICAgICB9XHJcblxyXG4vLyAgICAgLy8gZmluYWwgdHJpYW5nbGUgKGRvZXMgdGhpcyBsaW5lIGFsd2F5cyBhbHJlYWR5IGV4aXN0PylcclxuLy8gICAgIC8vIGRpYWdzLnB1c2goW3ZzWzBdLngsIHZzWzBdLnksIHZzWzJdLngsIHZzWzJdLnldKVxyXG4vLyAgICAgcmV0dXJuIGRpYWdzXHJcbi8vIH1cclxuXHJcbi8vIHVwZGF0ZSBzdGF0dXMgb2YgdHdvIGFkamFjZW50IHZlcnRpY2VzXHJcbmZ1bmN0aW9uIHVwZGF0ZVN0YXR1cyh2czogVmVydGV4W10sIGkwOiBudW1iZXIpIHtcclxuICAgIGNvbnN0IGkxID0gbWF0aC5tb2QoaTAgKyAxLCB2cy5sZW5ndGgpXHJcbiAgICBjb25zb2xlLmxvZyh2cywgaTAsIGkxKVxyXG5cclxuICAgIC8vIGNvbnZleCBjYW4ndCBiZWNvbWUgcmVmbGV4XHJcbiAgICBjb25zdCB2MCA9IHZzW2kwXVxyXG4gICAgaWYgKHYwLnJlZmxleCkge1xyXG4gICAgICAgIHVwZGF0ZVJlZmxleCh2cywgaTApXHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgdjEgPSB2c1tpMV1cclxuICAgIGlmICh2MS5yZWZsZXgpIHtcclxuICAgICAgICB1cGRhdGVSZWZsZXgodnMsIGkxKVxyXG4gICAgfVxyXG5cclxuICAgIHVwZGF0ZUVhcih2cywgaTApXHJcbiAgICB1cGRhdGVFYXIodnMsIGkxKVxyXG59XHJcblxyXG5mdW5jdGlvbiB1cGRhdGVFYXIodnM6IHJlYWRvbmx5IFZlcnRleFtdLCBpOiBudW1iZXIpIHtcclxuICAgIGNvbnN0IG4gPSB2cy5sZW5ndGhcclxuICAgIGNvbnN0IHYwID0gdnNbbWF0aC5tb2QoaSAtIDEsIG4pXVxyXG4gICAgY29uc3QgdjEgPSB2c1tpXVxyXG4gICAgY29uc3QgdjIgPSB2c1ttYXRoLm1vZChpICsgMSwgbildXHJcbiAgICBjb25zdCBpMyA9IG1hdGgubW9kKGkgKyAyLCBuKVxyXG4gICAgLy8gcmVmbGV4IGNhbid0IGFsc28gYmUgZWFyXHJcbiAgICBpZiAodjEucmVmbGV4KSB7XHJcbiAgICAgICAgdjEuZWFyID0gZmFsc2VcclxuICAgICAgICByZXR1cm5cclxuICAgIH1cclxuXHJcbiAgICAvLyB1cGRhdGUgZWFyIHN0YXR1c1xyXG4gICAgLy8gY2hlY2sgb3RoZXIgdmVydGljZXMgdG8gZGV0ZXJtaW5lIGlmIHRoZXkgYXJlIGluIHRyaWFuZ2xlXHJcbiAgICBmb3IgKGxldCBqID0gMDsgaiA8IG4gLSAzOyArK2opIHtcclxuICAgICAgICBjb25zdCBqaiA9IChpMyArIGopICUgblxyXG4gICAgICAgIGNvbnN0IHsgeCwgeSwgcmVmbGV4IH0gPSB2c1tqal1cclxuXHJcbiAgICAgICAgLy8gbXVzdCBiZSByZWZsZXggdG8gYmUgaW5zaWRlIHRyaWFuZ2xlXHJcbiAgICAgICAgaWYgKCFyZWZsZXgpIHtcclxuICAgICAgICAgICAgY29udGludWVcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmIChcclxuICAgICAgICAgICAgbGVmdFR1cm4oeCwgeSwgdjAueCwgdjAueSwgdjEueCwgdjEueSlcclxuICAgICAgICAgICAgJiYgbGVmdFR1cm4oeCwgeSwgdjEueCwgdjEueSwgdjIueCwgdjIueSlcclxuICAgICAgICAgICAgJiYgbGVmdFR1cm4oeCwgeSwgdjIueCwgdjIueSwgdjAueCwgdjAueSkpIHtcclxuICAgICAgICAgICAgdjEuZWFyID0gZmFsc2VcclxuICAgICAgICAgICAgcmV0dXJuXHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHYxLmVhciA9IHRydWVcclxufVxyXG5cclxuZnVuY3Rpb24gdXBkYXRlUmVmbGV4KHZzOiByZWFkb25seSBWZXJ0ZXhbXSwgaTogbnVtYmVyKSB7XHJcbiAgICBjb25zb2xlLmxvZyhcInVwZGF0ZSByZWZsZXhcIiwgaSwgdnMpXHJcbiAgICBjb25zdCBuID0gdnMubGVuZ3RoXHJcbiAgICBjb25zdCB2MCA9IHZzW21hdGgubW9kKGkgLSAxLCBuKV1cclxuICAgIGNvbnN0IHYxID0gdnNbaV1cclxuICAgIGNvbnN0IHYyID0gdnNbbWF0aC5tb2QoaSArIDEsIG4pXVxyXG5cclxuICAgIC8vIGlzIHRoaXMgYSByZWZsZXggdmVydGV4P1xyXG4gICAgLy8gdjEgaXMgYSByZWZsZXggdmVydGV4IGlmIGZvciBjY3cgcG9seWdvbiBhIGN3IHR1cm4gaXMgbWFkZSBmcm9tIHYoaS0xKSwgdmksIHYoaSsxKVxyXG4gICAgaWYgKGxlZnRUdXJuKHYwLngsIHYwLnksIHYxLngsIHYxLnksIHYyLngsIHYyLnkpKSB7XHJcbiAgICAgICAgdjEucmVmbGV4ID0gZmFsc2VcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgICAgdjEucmVmbGV4ID0gdHJ1ZVxyXG4gICAgfVxyXG59XHJcblxyXG5mdW5jdGlvbiBsZWZ0VHVybih4MDogbnVtYmVyLCB5MDogbnVtYmVyLCB4MTogbnVtYmVyLCB5MTogbnVtYmVyLCB4MjogbnVtYmVyLCB5MjogbnVtYmVyKTogYm9vbGVhbiB7XHJcbiAgICBjb25zdCBheCA9IHgyIC0geDBcclxuICAgIGNvbnN0IGF5ID0geTIgLSB5MFxyXG4gICAgY29uc3QgYnggPSB4MSAtIHgwXHJcbiAgICBjb25zdCBieSA9IHkxIC0geTBcclxuICAgIHJldHVybiBkZXQoYXgsIGF5LCBieCwgYnkpID4gMFxyXG59XHJcblxyXG5mdW5jdGlvbiBkZXQoeDA6IG51bWJlciwgeTA6IG51bWJlciwgeDE6IG51bWJlciwgeTE6IG51bWJlcik6IG51bWJlciB7XHJcbiAgICByZXR1cm4geDAgKiB5MSAtIHkwICogeDFcclxufVxyXG5cclxuaW5pdCgpIl19