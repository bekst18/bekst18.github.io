import * as dom from "../shared/dom.js";
import * as rand from "../shared/rand.js";
import * as geo from "../shared/geo2d.js";
const STORAGE_KEY = "crossword_storage";
var Direction;
(function (Direction) {
    Direction[Direction["Across"] = 0] = "Across";
    Direction[Direction["Down"] = 1] = "Down";
})(Direction || (Direction = {}));
function main() {
    let hintAnswers = new Array();
    const hintAnswerForm = dom.byId("hintAnswerForm");
    const hintInput = dom.byId("hint");
    const answerInput = dom.byId("answer");
    const hintAnswerTemplate = dom.byId("hintAnswerTemplate");
    const hintAnswerList = dom.byId("hintAnswers");
    const createButton = dom.byId("createButton");
    const clearButton = dom.byId("clearButton");
    const seed = rand.xmur3(new Date().toString());
    const rng = new rand.SFC32RNG(seed(), seed(), seed(), seed());
    const directions = [Direction.Across, Direction.Down];
    hintAnswerForm.addEventListener("submit", addHintAnswer);
    createButton.addEventListener("click", create);
    clearButton.addEventListener("click", clear);
    dom.delegate(hintAnswerList, "click", ".delete-button", deleteHintAnswer);
    load();
    function addHintAnswer(e) {
        e.preventDefault();
        const hint = hintInput.value;
        const answer = answerInput.value;
        if (!hint || !answer) {
            return;
        }
        hintAnswers.push({ hint, answer });
        save();
        updateHintAnswerList();
        hintInput.value = "";
        answerInput.value = "";
        hintInput.focus();
    }
    function updateHintAnswerList() {
        dom.removeAllChildren(hintAnswerList);
        for (const hintAnswer of hintAnswers) {
            const fragment = hintAnswerTemplate.content.cloneNode(true);
            const hintSpan = dom.bySelector(fragment, ".hint");
            const answerSpan = dom.bySelector(fragment, ".answer");
            hintSpan.textContent = hintAnswer.hint;
            answerSpan.textContent = hintAnswer.answer;
            hintAnswerList.appendChild(fragment);
        }
    }
    function rndDir() {
        return rand.choose(rng, directions);
    }
    function create() {
        // sort words from longest to shortest
        hintAnswers = hintAnswers.sort((a, b) => b.answer.length - a.answer.length);
        if (hintAnswers.length == 0) {
            alert("Please enter at least one hint and answer!");
            return;
        }
        // make all answers lowercase
        for (const ha of hintAnswers) {
            ha.answer = ha.answer.toLocaleLowerCase();
        }
        // place longest word at 0,0 randomly across/down
        const words = new Array();
        words.push(placeInitialWord(hintAnswers[0]));
        for (let i = 1; i < words.length; ++i) {
            let ha = hintAnswers[i];
            placeNextWord(words, ha);
        }
    }
    function placeInitialWord(hintAnswer) {
        const direction = rndDir();
        const position = new geo.Point(0, 0);
        let { hint, answer } = hintAnswer;
        return {
            hint,
            answer,
            position,
            direction
        };
    }
    function placeNextWord(words, hintAnswer) {
        // find next possible intersection with existing words
        const { hint, answer } = hintAnswer;
        for (const word of words) {
            // find next common letter
            const w = word.answer;
            for (let i = 0; i < w.length; ++i) {
                for (let j = 0; j < answer.length; ++i) {
                    if (w[i] === answer[j]) {
                        // try placing the word here
                    }
                }
            }
        }
    }
    function getDirectionVector(dir) {
        switch (dir) {
            case Direction.Across:
                return new geo.Point(1, 0);
                break;
            case Direction.Down:
                return new geo.Point(0, 1);
                break;
        }
        return new geo.Point(0, 0);
    }
    function getWordCharPosition(word, i) {
        const { position, direction } = word;
        const v = getDirectionVector(direction);
        return position.addPoint(v.mulScalar(i));
    }
    function tryPlaceWord(words, hint, answer) {
    }
    function clear() {
        hintAnswers = [];
        updateHintAnswerList();
        save();
    }
    function deleteHintAnswer(e) {
        const target = e.target;
        const li = target.closest(".hint-answer-li");
        const parent = li.parentElement;
        if (!parent) {
            return;
        }
        const index = Array.from(parent.children).indexOf(li);
        hintAnswers.splice(index, 1);
        save();
        updateHintAnswerList();
    }
    function load() {
        const jsonData = localStorage.getItem(STORAGE_KEY);
        if (!jsonData) {
            return;
        }
        hintAnswers = JSON.parse(jsonData);
        updateHintAnswerList();
    }
    function save() {
        const jsonData = JSON.stringify(hintAnswers);
        localStorage.setItem(STORAGE_KEY, jsonData);
    }
}
main();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3Jvc3N3b3JkLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiY3Jvc3N3b3JkLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sS0FBSyxHQUFHLE1BQU0sa0JBQWtCLENBQUE7QUFDdkMsT0FBTyxLQUFLLElBQUksTUFBTSxtQkFBbUIsQ0FBQTtBQUN6QyxPQUFPLEtBQUssR0FBRyxNQUFNLG9CQUFvQixDQUFBO0FBRXpDLE1BQU0sV0FBVyxHQUFHLG1CQUFtQixDQUFDO0FBT3hDLElBQUssU0FHSjtBQUhELFdBQUssU0FBUztJQUNWLDZDQUFNLENBQUE7SUFDTix5Q0FBSSxDQUFBO0FBQ1IsQ0FBQyxFQUhJLFNBQVMsS0FBVCxTQUFTLFFBR2I7QUFTRCxTQUFTLElBQUk7SUFDVCxJQUFJLFdBQVcsR0FBRyxJQUFJLEtBQUssRUFBYyxDQUFDO0lBQzFDLE1BQU0sY0FBYyxHQUFHLEdBQUcsQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLENBQW9CLENBQUM7SUFDckUsTUFBTSxTQUFTLEdBQUcsR0FBRyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQXFCLENBQUM7SUFDdkQsTUFBTSxXQUFXLEdBQUcsR0FBRyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQXFCLENBQUM7SUFDM0QsTUFBTSxrQkFBa0IsR0FBRyxHQUFHLENBQUMsSUFBSSxDQUFDLG9CQUFvQixDQUF3QixDQUFDO0lBQ2pGLE1BQU0sY0FBYyxHQUFHLEdBQUcsQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFxQixDQUFDO0lBQ25FLE1BQU0sWUFBWSxHQUFHLEdBQUcsQ0FBQyxJQUFJLENBQUMsY0FBYyxDQUFzQixDQUFDO0lBQ25FLE1BQU0sV0FBVyxHQUFHLEdBQUcsQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFzQixDQUFDO0lBQ2pFLE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxJQUFJLEVBQUUsQ0FBQyxRQUFRLEVBQUUsQ0FBQyxDQUFDO0lBQy9DLE1BQU0sR0FBRyxHQUFHLElBQUksSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLEVBQUUsRUFBRSxJQUFJLEVBQUUsRUFBRSxJQUFJLEVBQUUsRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDO0lBQzlELE1BQU0sVUFBVSxHQUFHLENBQUMsU0FBUyxDQUFDLE1BQU0sRUFBRSxTQUFTLENBQUMsSUFBSSxDQUFDLENBQUM7SUFFdEQsY0FBYyxDQUFDLGdCQUFnQixDQUFDLFFBQVEsRUFBRSxhQUFhLENBQUMsQ0FBQztJQUN6RCxZQUFZLENBQUMsZ0JBQWdCLENBQUMsT0FBTyxFQUFFLE1BQU0sQ0FBQyxDQUFDO0lBQy9DLFdBQVcsQ0FBQyxnQkFBZ0IsQ0FBQyxPQUFPLEVBQUUsS0FBSyxDQUFDLENBQUM7SUFDN0MsR0FBRyxDQUFDLFFBQVEsQ0FBQyxjQUFjLEVBQUUsT0FBTyxFQUFFLGdCQUFnQixFQUFFLGdCQUFnQixDQUFDLENBQUM7SUFFMUUsSUFBSSxFQUFFLENBQUM7SUFFUCxTQUFTLGFBQWEsQ0FBQyxDQUFRO1FBQzNCLENBQUMsQ0FBQyxjQUFjLEVBQUUsQ0FBQztRQUVuQixNQUFNLElBQUksR0FBRyxTQUFTLENBQUMsS0FBSyxDQUFDO1FBQzdCLE1BQU0sTUFBTSxHQUFHLFdBQVcsQ0FBQyxLQUFLLENBQUM7UUFDakMsSUFBSSxDQUFDLElBQUksSUFBSSxDQUFDLE1BQU0sRUFBRTtZQUNsQixPQUFNO1NBQ1Q7UUFFRCxXQUFXLENBQUMsSUFBSSxDQUFDLEVBQUUsSUFBSSxFQUFFLE1BQU0sRUFBRSxDQUFDLENBQUM7UUFDbkMsSUFBSSxFQUFFLENBQUM7UUFFUCxvQkFBb0IsRUFBRSxDQUFDO1FBRXZCLFNBQVMsQ0FBQyxLQUFLLEdBQUcsRUFBRSxDQUFDO1FBQ3JCLFdBQVcsQ0FBQyxLQUFLLEdBQUcsRUFBRSxDQUFDO1FBQ3ZCLFNBQVMsQ0FBQyxLQUFLLEVBQUUsQ0FBQztJQUN0QixDQUFDO0lBRUQsU0FBUyxvQkFBb0I7UUFDekIsR0FBRyxDQUFDLGlCQUFpQixDQUFDLGNBQWMsQ0FBQyxDQUFDO1FBQ3RDLEtBQUssTUFBTSxVQUFVLElBQUksV0FBVyxFQUFFO1lBQ2xDLE1BQU0sUUFBUSxHQUFHLGtCQUFrQixDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFxQixDQUFDO1lBQ2hGLE1BQU0sUUFBUSxHQUFHLEdBQUcsQ0FBQyxVQUFVLENBQUMsUUFBUSxFQUFFLE9BQU8sQ0FBQyxDQUFDO1lBQ25ELE1BQU0sVUFBVSxHQUFHLEdBQUcsQ0FBQyxVQUFVLENBQUMsUUFBUSxFQUFFLFNBQVMsQ0FBQyxDQUFDO1lBQ3ZELFFBQVEsQ0FBQyxXQUFXLEdBQUcsVUFBVSxDQUFDLElBQUksQ0FBQztZQUN2QyxVQUFVLENBQUMsV0FBVyxHQUFHLFVBQVUsQ0FBQyxNQUFNLENBQUM7WUFDM0MsY0FBYyxDQUFDLFdBQVcsQ0FBQyxRQUFRLENBQUMsQ0FBQztTQUN4QztJQUNMLENBQUM7SUFFRCxTQUFTLE1BQU07UUFDWCxPQUFPLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxFQUFFLFVBQVUsQ0FBQyxDQUFDO0lBQ3hDLENBQUM7SUFFRCxTQUFTLE1BQU07UUFDWCxzQ0FBc0M7UUFDdEMsV0FBVyxHQUFHLFdBQVcsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQzVFLElBQUksV0FBVyxDQUFDLE1BQU0sSUFBSSxDQUFDLEVBQUU7WUFDekIsS0FBSyxDQUFDLDRDQUE0QyxDQUFDLENBQUM7WUFDcEQsT0FBTztTQUNWO1FBRUQsNkJBQTZCO1FBQzdCLEtBQUssTUFBTSxFQUFFLElBQUksV0FBVyxFQUFFO1lBQzFCLEVBQUUsQ0FBQyxNQUFNLEdBQUcsRUFBRSxDQUFDLE1BQU0sQ0FBQyxpQkFBaUIsRUFBRSxDQUFDO1NBQzdDO1FBRUQsaURBQWlEO1FBQ2pELE1BQU0sS0FBSyxHQUFHLElBQUksS0FBSyxFQUFRLENBQUM7UUFDaEMsS0FBSyxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBRTdDLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxLQUFLLENBQUMsTUFBTSxFQUFFLEVBQUUsQ0FBQyxFQUFFO1lBQ25DLElBQUksRUFBRSxHQUFHLFdBQVcsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUN4QixhQUFhLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1NBQzVCO0lBQ0wsQ0FBQztJQUVELFNBQVMsZ0JBQWdCLENBQUMsVUFBc0I7UUFDNUMsTUFBTSxTQUFTLEdBQUcsTUFBTSxFQUFFLENBQUM7UUFDM0IsTUFBTSxRQUFRLEdBQUcsSUFBSSxHQUFHLENBQUMsS0FBSyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztRQUNyQyxJQUFJLEVBQUUsSUFBSSxFQUFFLE1BQU0sRUFBRSxHQUFHLFVBQVUsQ0FBQztRQUNsQyxPQUFPO1lBQ0gsSUFBSTtZQUNKLE1BQU07WUFDTixRQUFRO1lBQ1IsU0FBUztTQUNaLENBQUM7SUFDTixDQUFDO0lBRUQsU0FBUyxhQUFhLENBQUMsS0FBYSxFQUFFLFVBQXNCO1FBQ3hELHNEQUFzRDtRQUN0RCxNQUFNLEVBQUUsSUFBSSxFQUFFLE1BQU0sRUFBRSxHQUFHLFVBQVUsQ0FBQztRQUNwQyxLQUFLLE1BQU0sSUFBSSxJQUFJLEtBQUssRUFBRTtZQUN0QiwwQkFBMEI7WUFDMUIsTUFBTSxDQUFDLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQztZQUN0QixLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsQ0FBQyxDQUFDLE1BQU0sRUFBRSxFQUFFLENBQUMsRUFBRTtnQkFDL0IsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLE1BQU0sQ0FBQyxNQUFNLEVBQUUsRUFBRSxDQUFDLEVBQUU7b0JBQ3BDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLE1BQU0sQ0FBQyxDQUFDLENBQUMsRUFBRTt3QkFDcEIsNEJBQTRCO3FCQUUvQjtpQkFDSjthQUNKO1NBQ0o7SUFDTCxDQUFDO0lBRUQsU0FBUyxrQkFBa0IsQ0FBQyxHQUFjO1FBQ3RDLFFBQVEsR0FBRyxFQUFFO1lBQ1QsS0FBSyxTQUFTLENBQUMsTUFBTTtnQkFDakIsT0FBTyxJQUFJLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO2dCQUMzQixNQUFNO1lBQ1YsS0FBSyxTQUFTLENBQUMsSUFBSTtnQkFDZixPQUFPLElBQUksR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7Z0JBQzNCLE1BQU07U0FDYjtRQUVELE9BQU8sSUFBSSxHQUFHLENBQUMsS0FBSyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztJQUMvQixDQUFDO0lBRUQsU0FBUyxtQkFBbUIsQ0FBQyxJQUFVLEVBQUUsQ0FBUztRQUM5QyxNQUFNLEVBQUUsUUFBUSxFQUFFLFNBQVMsRUFBRSxHQUFHLElBQUksQ0FBQztRQUNyQyxNQUFNLENBQUMsR0FBRyxrQkFBa0IsQ0FBQyxTQUFTLENBQUMsQ0FBQztRQUN4QyxPQUFPLFFBQVEsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQzdDLENBQUM7SUFFRCxTQUFTLFlBQVksQ0FBQyxLQUFhLEVBQUUsSUFBWSxFQUFFLE1BQWM7SUFFakUsQ0FBQztJQUVELFNBQVMsS0FBSztRQUNWLFdBQVcsR0FBRyxFQUFFLENBQUM7UUFDakIsb0JBQW9CLEVBQUUsQ0FBQztRQUN2QixJQUFJLEVBQUUsQ0FBQztJQUNYLENBQUM7SUFFRCxTQUFTLGdCQUFnQixDQUFDLENBQVE7UUFDOUIsTUFBTSxNQUFNLEdBQUcsQ0FBQyxDQUFDLE1BQXFCLENBQUM7UUFDdkMsTUFBTSxFQUFFLEdBQUcsTUFBTSxDQUFDLE9BQU8sQ0FBQyxpQkFBaUIsQ0FBa0IsQ0FBQztRQUM5RCxNQUFNLE1BQU0sR0FBRyxFQUFFLENBQUMsYUFBYSxDQUFDO1FBQ2hDLElBQUksQ0FBQyxNQUFNLEVBQUU7WUFDVCxPQUFPO1NBQ1Y7UUFFRCxNQUFNLEtBQUssR0FBRyxLQUFLLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDLENBQUM7UUFDdEQsV0FBVyxDQUFDLE1BQU0sQ0FBQyxLQUFLLEVBQUUsQ0FBQyxDQUFDLENBQUM7UUFDN0IsSUFBSSxFQUFFLENBQUM7UUFDUCxvQkFBb0IsRUFBRSxDQUFDO0lBQzNCLENBQUM7SUFFRCxTQUFTLElBQUk7UUFDVCxNQUFNLFFBQVEsR0FBRyxZQUFZLENBQUMsT0FBTyxDQUFDLFdBQVcsQ0FBQyxDQUFDO1FBQ25ELElBQUksQ0FBQyxRQUFRLEVBQUU7WUFDWCxPQUFPO1NBQ1Y7UUFFRCxXQUFXLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQWlCLENBQUM7UUFDbkQsb0JBQW9CLEVBQUUsQ0FBQztJQUMzQixDQUFDO0lBRUQsU0FBUyxJQUFJO1FBQ1QsTUFBTSxRQUFRLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUM3QyxZQUFZLENBQUMsT0FBTyxDQUFDLFdBQVcsRUFBRSxRQUFRLENBQUMsQ0FBQztJQUNoRCxDQUFDO0FBQ0wsQ0FBQztBQUVELElBQUksRUFBRSxDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgZG9tIGZyb20gXCIuLi9zaGFyZWQvZG9tLmpzXCJcclxuaW1wb3J0ICogYXMgcmFuZCBmcm9tIFwiLi4vc2hhcmVkL3JhbmQuanNcIlxyXG5pbXBvcnQgKiBhcyBnZW8gZnJvbSBcIi4uL3NoYXJlZC9nZW8yZC5qc1wiXHJcblxyXG5jb25zdCBTVE9SQUdFX0tFWSA9IFwiY3Jvc3N3b3JkX3N0b3JhZ2VcIjtcclxuXHJcbmludGVyZmFjZSBIaW50QW5zd2VyIHtcclxuICAgIGhpbnQ6IHN0cmluZyxcclxuICAgIGFuc3dlcjogc3RyaW5nLFxyXG59XHJcblxyXG5lbnVtIERpcmVjdGlvbiB7XHJcbiAgICBBY3Jvc3MsXHJcbiAgICBEb3duLFxyXG59XHJcblxyXG5pbnRlcmZhY2UgV29yZCB7XHJcbiAgICBoaW50OiBzdHJpbmcsXHJcbiAgICBhbnN3ZXI6IHN0cmluZyxcclxuICAgIHBvc2l0aW9uOiBnZW8uUG9pbnQsXHJcbiAgICBkaXJlY3Rpb246IERpcmVjdGlvblxyXG59XHJcblxyXG5mdW5jdGlvbiBtYWluKCkge1xyXG4gICAgbGV0IGhpbnRBbnN3ZXJzID0gbmV3IEFycmF5PEhpbnRBbnN3ZXI+KCk7XHJcbiAgICBjb25zdCBoaW50QW5zd2VyRm9ybSA9IGRvbS5ieUlkKFwiaGludEFuc3dlckZvcm1cIikgYXMgSFRNTEZvcm1FbGVtZW50O1xyXG4gICAgY29uc3QgaGludElucHV0ID0gZG9tLmJ5SWQoXCJoaW50XCIpIGFzIEhUTUxJbnB1dEVsZW1lbnQ7XHJcbiAgICBjb25zdCBhbnN3ZXJJbnB1dCA9IGRvbS5ieUlkKFwiYW5zd2VyXCIpIGFzIEhUTUxJbnB1dEVsZW1lbnQ7XHJcbiAgICBjb25zdCBoaW50QW5zd2VyVGVtcGxhdGUgPSBkb20uYnlJZChcImhpbnRBbnN3ZXJUZW1wbGF0ZVwiKSBhcyBIVE1MVGVtcGxhdGVFbGVtZW50O1xyXG4gICAgY29uc3QgaGludEFuc3dlckxpc3QgPSBkb20uYnlJZChcImhpbnRBbnN3ZXJzXCIpIGFzIEhUTUxPTGlzdEVsZW1lbnQ7XHJcbiAgICBjb25zdCBjcmVhdGVCdXR0b24gPSBkb20uYnlJZChcImNyZWF0ZUJ1dHRvblwiKSBhcyBIVE1MQnV0dG9uRWxlbWVudDtcclxuICAgIGNvbnN0IGNsZWFyQnV0dG9uID0gZG9tLmJ5SWQoXCJjbGVhckJ1dHRvblwiKSBhcyBIVE1MQnV0dG9uRWxlbWVudDtcclxuICAgIGNvbnN0IHNlZWQgPSByYW5kLnhtdXIzKG5ldyBEYXRlKCkudG9TdHJpbmcoKSk7XHJcbiAgICBjb25zdCBybmcgPSBuZXcgcmFuZC5TRkMzMlJORyhzZWVkKCksIHNlZWQoKSwgc2VlZCgpLCBzZWVkKCkpO1xyXG4gICAgY29uc3QgZGlyZWN0aW9ucyA9IFtEaXJlY3Rpb24uQWNyb3NzLCBEaXJlY3Rpb24uRG93bl07XHJcblxyXG4gICAgaGludEFuc3dlckZvcm0uYWRkRXZlbnRMaXN0ZW5lcihcInN1Ym1pdFwiLCBhZGRIaW50QW5zd2VyKTtcclxuICAgIGNyZWF0ZUJ1dHRvbi5hZGRFdmVudExpc3RlbmVyKFwiY2xpY2tcIiwgY3JlYXRlKTtcclxuICAgIGNsZWFyQnV0dG9uLmFkZEV2ZW50TGlzdGVuZXIoXCJjbGlja1wiLCBjbGVhcik7XHJcbiAgICBkb20uZGVsZWdhdGUoaGludEFuc3dlckxpc3QsIFwiY2xpY2tcIiwgXCIuZGVsZXRlLWJ1dHRvblwiLCBkZWxldGVIaW50QW5zd2VyKTtcclxuXHJcbiAgICBsb2FkKCk7XHJcblxyXG4gICAgZnVuY3Rpb24gYWRkSGludEFuc3dlcihlOiBFdmVudCkge1xyXG4gICAgICAgIGUucHJldmVudERlZmF1bHQoKTtcclxuXHJcbiAgICAgICAgY29uc3QgaGludCA9IGhpbnRJbnB1dC52YWx1ZTtcclxuICAgICAgICBjb25zdCBhbnN3ZXIgPSBhbnN3ZXJJbnB1dC52YWx1ZTtcclxuICAgICAgICBpZiAoIWhpbnQgfHwgIWFuc3dlcikge1xyXG4gICAgICAgICAgICByZXR1cm5cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGhpbnRBbnN3ZXJzLnB1c2goeyBoaW50LCBhbnN3ZXIgfSk7XHJcbiAgICAgICAgc2F2ZSgpO1xyXG5cclxuICAgICAgICB1cGRhdGVIaW50QW5zd2VyTGlzdCgpO1xyXG5cclxuICAgICAgICBoaW50SW5wdXQudmFsdWUgPSBcIlwiO1xyXG4gICAgICAgIGFuc3dlcklucHV0LnZhbHVlID0gXCJcIjtcclxuICAgICAgICBoaW50SW5wdXQuZm9jdXMoKTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiB1cGRhdGVIaW50QW5zd2VyTGlzdCgpIHtcclxuICAgICAgICBkb20ucmVtb3ZlQWxsQ2hpbGRyZW4oaGludEFuc3dlckxpc3QpO1xyXG4gICAgICAgIGZvciAoY29uc3QgaGludEFuc3dlciBvZiBoaW50QW5zd2Vycykge1xyXG4gICAgICAgICAgICBjb25zdCBmcmFnbWVudCA9IGhpbnRBbnN3ZXJUZW1wbGF0ZS5jb250ZW50LmNsb25lTm9kZSh0cnVlKSBhcyBEb2N1bWVudEZyYWdtZW50O1xyXG4gICAgICAgICAgICBjb25zdCBoaW50U3BhbiA9IGRvbS5ieVNlbGVjdG9yKGZyYWdtZW50LCBcIi5oaW50XCIpO1xyXG4gICAgICAgICAgICBjb25zdCBhbnN3ZXJTcGFuID0gZG9tLmJ5U2VsZWN0b3IoZnJhZ21lbnQsIFwiLmFuc3dlclwiKTtcclxuICAgICAgICAgICAgaGludFNwYW4udGV4dENvbnRlbnQgPSBoaW50QW5zd2VyLmhpbnQ7XHJcbiAgICAgICAgICAgIGFuc3dlclNwYW4udGV4dENvbnRlbnQgPSBoaW50QW5zd2VyLmFuc3dlcjtcclxuICAgICAgICAgICAgaGludEFuc3dlckxpc3QuYXBwZW5kQ2hpbGQoZnJhZ21lbnQpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBybmREaXIoKTogRGlyZWN0aW9uIHtcclxuICAgICAgICByZXR1cm4gcmFuZC5jaG9vc2Uocm5nLCBkaXJlY3Rpb25zKTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBjcmVhdGUoKSB7XHJcbiAgICAgICAgLy8gc29ydCB3b3JkcyBmcm9tIGxvbmdlc3QgdG8gc2hvcnRlc3RcclxuICAgICAgICBoaW50QW5zd2VycyA9IGhpbnRBbnN3ZXJzLnNvcnQoKGEsIGIpID0+IGIuYW5zd2VyLmxlbmd0aCAtIGEuYW5zd2VyLmxlbmd0aCk7XHJcbiAgICAgICAgaWYgKGhpbnRBbnN3ZXJzLmxlbmd0aCA9PSAwKSB7XHJcbiAgICAgICAgICAgIGFsZXJ0KFwiUGxlYXNlIGVudGVyIGF0IGxlYXN0IG9uZSBoaW50IGFuZCBhbnN3ZXIhXCIpO1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAvLyBtYWtlIGFsbCBhbnN3ZXJzIGxvd2VyY2FzZVxyXG4gICAgICAgIGZvciAoY29uc3QgaGEgb2YgaGludEFuc3dlcnMpIHtcclxuICAgICAgICAgICAgaGEuYW5zd2VyID0gaGEuYW5zd2VyLnRvTG9jYWxlTG93ZXJDYXNlKCk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAvLyBwbGFjZSBsb25nZXN0IHdvcmQgYXQgMCwwIHJhbmRvbWx5IGFjcm9zcy9kb3duXHJcbiAgICAgICAgY29uc3Qgd29yZHMgPSBuZXcgQXJyYXk8V29yZD4oKTtcclxuICAgICAgICB3b3Jkcy5wdXNoKHBsYWNlSW5pdGlhbFdvcmQoaGludEFuc3dlcnNbMF0pKTtcclxuXHJcbiAgICAgICAgZm9yIChsZXQgaSA9IDE7IGkgPCB3b3Jkcy5sZW5ndGg7ICsraSkge1xyXG4gICAgICAgICAgICBsZXQgaGEgPSBoaW50QW5zd2Vyc1tpXTtcclxuICAgICAgICAgICAgcGxhY2VOZXh0V29yZCh3b3JkcywgaGEpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBwbGFjZUluaXRpYWxXb3JkKGhpbnRBbnN3ZXI6IEhpbnRBbnN3ZXIpOiBXb3JkIHtcclxuICAgICAgICBjb25zdCBkaXJlY3Rpb24gPSBybmREaXIoKTtcclxuICAgICAgICBjb25zdCBwb3NpdGlvbiA9IG5ldyBnZW8uUG9pbnQoMCwgMCk7XHJcbiAgICAgICAgbGV0IHsgaGludCwgYW5zd2VyIH0gPSBoaW50QW5zd2VyO1xyXG4gICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgIGhpbnQsXHJcbiAgICAgICAgICAgIGFuc3dlcixcclxuICAgICAgICAgICAgcG9zaXRpb24sXHJcbiAgICAgICAgICAgIGRpcmVjdGlvblxyXG4gICAgICAgIH07XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gcGxhY2VOZXh0V29yZCh3b3JkczogV29yZFtdLCBoaW50QW5zd2VyOiBIaW50QW5zd2VyKTogV29yZCB7XHJcbiAgICAgICAgLy8gZmluZCBuZXh0IHBvc3NpYmxlIGludGVyc2VjdGlvbiB3aXRoIGV4aXN0aW5nIHdvcmRzXHJcbiAgICAgICAgY29uc3QgeyBoaW50LCBhbnN3ZXIgfSA9IGhpbnRBbnN3ZXI7XHJcbiAgICAgICAgZm9yIChjb25zdCB3b3JkIG9mIHdvcmRzKSB7XHJcbiAgICAgICAgICAgIC8vIGZpbmQgbmV4dCBjb21tb24gbGV0dGVyXHJcbiAgICAgICAgICAgIGNvbnN0IHcgPSB3b3JkLmFuc3dlcjtcclxuICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB3Lmxlbmd0aDsgKytpKSB7XHJcbiAgICAgICAgICAgICAgICBmb3IgKGxldCBqID0gMDsgaiA8IGFuc3dlci5sZW5ndGg7ICsraSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmICh3W2ldID09PSBhbnN3ZXJbal0pIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgLy8gdHJ5IHBsYWNpbmcgdGhlIHdvcmQgaGVyZVxyXG5cclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gZ2V0RGlyZWN0aW9uVmVjdG9yKGRpcjogRGlyZWN0aW9uKTogZ2VvLlBvaW50IHtcclxuICAgICAgICBzd2l0Y2ggKGRpcikge1xyXG4gICAgICAgICAgICBjYXNlIERpcmVjdGlvbi5BY3Jvc3M6XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gbmV3IGdlby5Qb2ludCgxLCAwKTtcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICBjYXNlIERpcmVjdGlvbi5Eb3duOlxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBnZW8uUG9pbnQoMCwgMSk7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiBuZXcgZ2VvLlBvaW50KDAsIDApO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIGdldFdvcmRDaGFyUG9zaXRpb24od29yZDogV29yZCwgaTogbnVtYmVyKTogZ2VvLlBvaW50IHtcclxuICAgICAgICBjb25zdCB7IHBvc2l0aW9uLCBkaXJlY3Rpb24gfSA9IHdvcmQ7XHJcbiAgICAgICAgY29uc3QgdiA9IGdldERpcmVjdGlvblZlY3RvcihkaXJlY3Rpb24pO1xyXG4gICAgICAgIHJldHVybiBwb3NpdGlvbi5hZGRQb2ludCh2Lm11bFNjYWxhcihpKSk7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gdHJ5UGxhY2VXb3JkKHdvcmRzOiBXb3JkW10sIGhpbnQ6IHN0cmluZywgYW5zd2VyOiBzdHJpbmcpIHtcclxuXHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gY2xlYXIoKSB7XHJcbiAgICAgICAgaGludEFuc3dlcnMgPSBbXTtcclxuICAgICAgICB1cGRhdGVIaW50QW5zd2VyTGlzdCgpO1xyXG4gICAgICAgIHNhdmUoKTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBkZWxldGVIaW50QW5zd2VyKGU6IEV2ZW50KSB7XHJcbiAgICAgICAgY29uc3QgdGFyZ2V0ID0gZS50YXJnZXQgYXMgSFRNTEVsZW1lbnQ7XHJcbiAgICAgICAgY29uc3QgbGkgPSB0YXJnZXQuY2xvc2VzdChcIi5oaW50LWFuc3dlci1saVwiKSBhcyBIVE1MTElFbGVtZW50O1xyXG4gICAgICAgIGNvbnN0IHBhcmVudCA9IGxpLnBhcmVudEVsZW1lbnQ7XHJcbiAgICAgICAgaWYgKCFwYXJlbnQpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgY29uc3QgaW5kZXggPSBBcnJheS5mcm9tKHBhcmVudC5jaGlsZHJlbikuaW5kZXhPZihsaSk7XHJcbiAgICAgICAgaGludEFuc3dlcnMuc3BsaWNlKGluZGV4LCAxKTtcclxuICAgICAgICBzYXZlKCk7XHJcbiAgICAgICAgdXBkYXRlSGludEFuc3dlckxpc3QoKTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBsb2FkKCkge1xyXG4gICAgICAgIGNvbnN0IGpzb25EYXRhID0gbG9jYWxTdG9yYWdlLmdldEl0ZW0oU1RPUkFHRV9LRVkpO1xyXG4gICAgICAgIGlmICghanNvbkRhdGEpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaGludEFuc3dlcnMgPSBKU09OLnBhcnNlKGpzb25EYXRhKSBhcyBbSGludEFuc3dlcl07XHJcbiAgICAgICAgdXBkYXRlSGludEFuc3dlckxpc3QoKTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBzYXZlKCkge1xyXG4gICAgICAgIGNvbnN0IGpzb25EYXRhID0gSlNPTi5zdHJpbmdpZnkoaGludEFuc3dlcnMpO1xyXG4gICAgICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKFNUT1JBR0VfS0VZLCBqc29uRGF0YSk7XHJcbiAgICB9XHJcbn1cclxuXHJcbm1haW4oKVxyXG5cclxuIl19