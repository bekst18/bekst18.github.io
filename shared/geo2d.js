/**
 * 1st attempt at a simple 2d geometry library
 */
import * as array from "../shared/array.js";
export class Point {
    constructor(x, y) {
        this.x = x;
        this.y = y;
    }
    equal(pt) {
        return this.x === pt.x && this.y === pt.y;
    }
    addScalar(x) {
        return new Point(this.x + x, this.y + x);
    }
    subScalar(x) {
        return new Point(this.x - x, this.y - x);
    }
    mulScalar(x) {
        return new Point(this.x * x, this.y * x);
    }
    divScalar(x) {
        return new Point(this.x / x, this.y / x);
    }
    addPoint(pt) {
        return new Point(this.x + pt.x, this.y + pt.y);
    }
    subPoint(pt) {
        return new Point(this.x - pt.x, this.y - pt.y);
    }
    mulPoint(pt) {
        return new Point(this.x * pt.x, this.y * pt.y);
    }
    divPoint(pt) {
        return new Point(this.x / pt.x, this.y / pt.y);
    }
    floor() {
        return new Point(Math.floor(this.x), Math.floor(this.y));
    }
    ciel() {
        return new Point(Math.ceil(this.x), Math.ceil(this.y));
    }
    round() {
        return new Point(Math.round(this.x), Math.round(this.y));
    }
    sign() {
        return new Point(Math.sign(this.x), Math.sign(this.y));
    }
    clone() {
        return new Point(this.x, this.y);
    }
}
export class AABB {
    constructor(min, max) {
        this.min = min;
        this.max = max;
    }
    get width() {
        return this.max.x - this.min.x;
    }
    get height() {
        return this.max.y - this.min.y;
    }
    get area() {
        return this.width * this.height;
    }
    get center() {
        return new Point(this.min.x + this.width / 2, this.min.y + this.height / 2);
    }
    combine(aabb) {
        const min = new Point(Math.min(this.min.x, aabb.min.x), Math.min(this.min.y, aabb.min.y));
        const max = new Point(Math.max(this.max.x, aabb.max.x), Math.max(this.max.y, aabb.max.y));
        const r = new AABB(min, max);
        return r;
    }
    overlaps(aabb) {
        return (this.max.x >= aabb.min.x &&
            this.max.y >= aabb.min.y &&
            this.min.x <= aabb.max.x &&
            this.min.y <= aabb.max.y);
    }
    translate(offset) {
        return new AABB(this.min.addPoint(offset), this.max.addPoint(offset));
    }
    scale(s) {
        return new AABB(this.min.mulScalar(s), this.max.mulScalar(s));
    }
    buffer(padding) {
        const min = new Point(this.min.x - padding, this.min.y - padding);
        const max = new Point(this.max.x + padding, this.max.y + padding);
        return new AABB(min, max);
    }
    shrink(amount) {
        return this.buffer(-amount);
    }
    clone() {
        return new AABB(this.min, this.max);
    }
}
var NodeType;
(function (NodeType) {
    NodeType[NodeType["Internal"] = 0] = "Internal";
    NodeType[NodeType["Leaf"] = 1] = "Leaf";
})(NodeType || (NodeType = {}));
export class AABBTree {
    constructor() {
        this.root = null;
    }
    /**
     * insert a new node into the tree
     * returns a reference to the leaf node that can later be used for removal
     * @param aabb aabb of data
     * @param data data to insert
     */
    insert(aabb, data) {
        // create the leaf node that will be inserted
        const newLeaf = {
            type: NodeType.Leaf,
            aabb: aabb.clone(),
            parent: null,
            data
        };
        // no root, create a leaf
        if (!this.root) {
            this.root = newLeaf;
            return newLeaf;
        }
        // otherwise, choose a leaf to become the sibling of the new leaf
        const sibling = this.chooseSiblingLeaf(this.root, aabb);
        // create a new parent node
        const newParent = {
            type: NodeType.Internal,
            parent: sibling.parent,
            aabb: aabb.combine(sibling.aabb),
            children: [newLeaf, sibling]
        };
        sibling.parent = newParent;
        newLeaf.parent = newParent;
        // replace link in old parent with newly created parent
        // or if there was no parent, leaf was root, make new parent the new root
        let parent = newParent.parent;
        if (parent) {
            const idx = parent.children.indexOf(sibling);
            if (idx === -1) {
                throw new Error("Could not find link to chosen sibling");
            }
            parent.children[idx] = newParent;
        }
        else {
            this.root = newParent;
        }
        this.updateAABBs(parent);
        return newLeaf;
    }
    /**
     * removes specified leaf node and its data from the tree
     * @param leaf leaf
     */
    delete(leaf) {
        // special case - leaf is root
        if (this.root === leaf) {
            this.root = null;
            return;
        }
        const parent = leaf.parent;
        if (!parent) {
            throw new Error("Invalid tree, non-root leaf has no parent");
        }
        // otherwise,
        // replace leaf.parent with leaf's sibling
        // recalculate aabbs
        const sibling = parent.children.find(n => n !== leaf);
        if (!sibling) {
            throw new Error("Invalid tree, leaf node has no sibling");
        }
        const grandParent = parent.parent;
        // no grandparent - parent was root - make sibling the new root
        if (!grandParent) {
            this.root = sibling;
            sibling.parent = null;
            return;
        }
        const parentIdx = grandParent.children.indexOf(parent);
        if (parentIdx === -1) {
            throw new Error("Invalid tree, grandparent does not have link to parent");
        }
        grandParent.children[parentIdx] = sibling;
        sibling.parent = grandParent;
        this.updateAABBs(grandParent);
    }
    /**
     * Iterates over all data that overlaps the AABB
     * @param aabb aabb
     */
    *query(aabb) {
        const stack = [];
        if (this.root && this.root.aabb.overlaps(aabb)) {
            stack.push(this.root);
        }
        while (stack.length > 0) {
            const node = array.pop(stack);
            switch (node.type) {
                case NodeType.Internal:
                    for (const child of node.children) {
                        if (child.aabb.overlaps(aabb)) {
                            stack.push(child);
                        }
                    }
                    break;
                case NodeType.Leaf:
                    yield node.data;
                    break;
            }
        }
    }
    chooseSiblingLeaf(node, aabb) {
        // choose the leaf that would increase least in area by including this node
        switch (node.type) {
            case NodeType.Internal:
                const n = node.children.reduce((a, b) => {
                    // calculate surface area increase for node a
                    const da = a.aabb.area - a.aabb.combine(aabb).area;
                    const db = b.aabb.area - b.aabb.combine(aabb).area;
                    return da < db ? a : b;
                });
                return this.chooseSiblingLeaf(n, aabb);
                break;
            case NodeType.Leaf:
                // we've reached a leaf - return it
                return node;
        }
    }
    updateAABBs(node) {
        while (node != null) {
            node.aabb = node.children[0].aabb.combine(node.children[1].aabb);
            node = node.parent;
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2VvMmQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJnZW8yZC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7R0FFRztBQUNILE9BQU8sS0FBSyxLQUFLLE1BQU0sb0JBQW9CLENBQUE7QUFFM0MsTUFBTSxPQUFPLEtBQUs7SUFDZCxZQUFtQixDQUFTLEVBQVMsQ0FBUztRQUEzQixNQUFDLEdBQUQsQ0FBQyxDQUFRO1FBQVMsTUFBQyxHQUFELENBQUMsQ0FBUTtJQUFJLENBQUM7SUFFbkQsS0FBSyxDQUFDLEVBQVM7UUFDWCxPQUFPLElBQUksQ0FBQyxDQUFDLEtBQUssRUFBRSxDQUFDLENBQUMsSUFBSSxJQUFJLENBQUMsQ0FBQyxLQUFLLEVBQUUsQ0FBQyxDQUFDLENBQUE7SUFDN0MsQ0FBQztJQUVELFNBQVMsQ0FBQyxDQUFTO1FBQ2YsT0FBTyxJQUFJLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQyxHQUFHLENBQUMsRUFBRSxJQUFJLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFBO0lBQzVDLENBQUM7SUFFRCxTQUFTLENBQUMsQ0FBUztRQUNmLE9BQU8sSUFBSSxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUMsR0FBRyxDQUFDLEVBQUUsSUFBSSxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQTtJQUM1QyxDQUFDO0lBRUQsU0FBUyxDQUFDLENBQVM7UUFDZixPQUFPLElBQUksS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDLEdBQUcsQ0FBQyxFQUFFLElBQUksQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUE7SUFDNUMsQ0FBQztJQUVELFNBQVMsQ0FBQyxDQUFTO1FBQ2YsT0FBTyxJQUFJLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQyxHQUFHLENBQUMsRUFBRSxJQUFJLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFBO0lBQzVDLENBQUM7SUFFRCxRQUFRLENBQUMsRUFBUztRQUNkLE9BQU8sSUFBSSxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFBO0lBQ2xELENBQUM7SUFFRCxRQUFRLENBQUMsRUFBUztRQUNkLE9BQU8sSUFBSSxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFBO0lBQ2xELENBQUM7SUFFRCxRQUFRLENBQUMsRUFBUztRQUNkLE9BQU8sSUFBSSxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFBO0lBQ2xELENBQUM7SUFFRCxRQUFRLENBQUMsRUFBUztRQUNkLE9BQU8sSUFBSSxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFBO0lBQ2xELENBQUM7SUFFRCxLQUFLO1FBQ0QsT0FBTyxJQUFJLEtBQUssQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFBO0lBQzVELENBQUM7SUFFRCxJQUFJO1FBQ0EsT0FBTyxJQUFJLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFBO0lBQzFELENBQUM7SUFFRCxLQUFLO1FBQ0QsT0FBTyxJQUFJLEtBQUssQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFD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LENBQUMsRUFBRSxFQUFFO29CQUNwQyw2Q0FBNkM7b0JBQzdDLE1BQU0sRUFBRSxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDLElBQUksQ0FBQTtvQkFDbEQsTUFBTSxFQUFFLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsSUFBSSxDQUFBO29CQUNsRCxPQUFPLEVBQUUsR0FBRyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFBO2dCQUMxQixDQUFDLENBQUMsQ0FBQTtnQkFFRixPQUFPLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDLEVBQUUsSUFBSSxDQUFDLENBQUE7Z0JBQ3RDLE1BQU07WUFFVixLQUFLLFFBQVEsQ0FBQyxJQUFJO2dCQUNkLG1DQUFtQztnQkFDbkMsT0FBTyxJQUFJLENBQUE7U0FDbEI7SUFDTCxDQUFDO0lBRU8sV0FBVyxDQUFDLElBQTRCO1FBQzVDLE9BQU8sSUFBSSxJQUFJLElBQUksRUFBRTtZQUNqQixJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFBO1lBQ2hFLElBQUksR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFBO1NBQ3JCO0lBQ0wsQ0FBQztDQUNKIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXHJcbiAqIDFzdCBhdHRlbXB0IGF0IGEgc2ltcGxlIDJkIGdlb21ldHJ5IGxpYnJhcnlcclxuICovXHJcbmltcG9ydCAqIGFzIGFycmF5IGZyb20gXCIuLi9zaGFyZWQvYXJyYXkuanNcIlxyXG5cclxuZXhwb3J0IGNsYXNzIFBvaW50IHtcclxuICAgIGNvbnN0cnVjdG9yKHB1YmxpYyB4OiBudW1iZXIsIHB1YmxpYyB5OiBudW1iZXIpIHsgfVxyXG5cclxuICAgIGVxdWFsKHB0OiBQb2ludCk6IGJvb2xlYW4ge1xyXG4gICAgICAgIHJldHVybiB0aGlzLnggPT09IHB0LnggJiYgdGhpcy55ID09PSBwdC55XHJcbiAgICB9XHJcblxyXG4gICAgYWRkU2NhbGFyKHg6IG51bWJlcik6IFBvaW50IHtcclxuICAgICAgICByZXR1cm4gbmV3IFBvaW50KHRoaXMueCArIHgsIHRoaXMueSArIHgpXHJcbiAgICB9XHJcblxyXG4gICAgc3ViU2NhbGFyKHg6IG51bWJlcik6IFBvaW50IHtcclxuICAgICAgICByZXR1cm4gbmV3IFBvaW50KHRoaXMueCAtIHgsIHRoaXMueSAtIHgpXHJcbiAgICB9XHJcblxyXG4gICAgbXVsU2NhbGFyKHg6IG51bWJlcik6IFBvaW50IHtcclxuICAgICAgICByZXR1cm4gbmV3IFBvaW50KHRoaXMueCAqIHgsIHRoaXMueSAqIHgpXHJcbiAgICB9XHJcblxyXG4gICAgZGl2U2NhbGFyKHg6IG51bWJlcik6IFBvaW50IHtcclxuICAgICAgICByZXR1cm4gbmV3IFBvaW50KHRoaXMueCAvIHgsIHRoaXMueSAvIHgpXHJcbiAgICB9XHJcblxyXG4gICAgYWRkUG9pbnQocHQ6IFBvaW50KTogUG9pbnQge1xyXG4gICAgICAgIHJldHVybiBuZXcgUG9pbnQodGhpcy54ICsgcHQueCwgdGhpcy55ICsgcHQueSlcclxuICAgIH1cclxuXHJcbiAgICBzdWJQb2ludChwdDogUG9pbnQpOiBQb2ludCB7XHJcbiAgICAgICAgcmV0dXJuIG5ldyBQb2ludCh0aGlzLnggLSBwdC54LCB0aGlzLnkgLSBwdC55KVxyXG4gICAgfVxyXG5cclxuICAgIG11bFBvaW50KHB0OiBQb2ludCk6IFBvaW50IHtcclxuICAgICAgICByZXR1cm4gbmV3IFBvaW50KHRoaXMueCAqIHB0LngsIHRoaXMueSAqIHB0LnkpXHJcbiAgICB9XHJcblxyXG4gICAgZGl2UG9pbnQocHQ6IFBvaW50KTogUG9pbnQge1xyXG4gICAgICAgIHJldHVybiBuZXcgUG9pbnQodGhpcy54IC8gcHQueCwgdGhpcy55IC8gcHQueSlcclxuICAgIH1cclxuXHJcbiAgICBmbG9vcigpOiBQb2ludCB7XHJcbiAgICAgICAgcmV0dXJuIG5ldyBQb2ludChNYXRoLmZsb29yKHRoaXMueCksIE1hdGguZmxvb3IodGhpcy55KSlcclxuICAgIH1cclxuXHJcbiAgICBjaWVsKCk6IFBvaW50IHtcclxuICAgICAgICByZXR1cm4gbmV3IFBvaW50KE1hdGguY2VpbCh0aGlzLngpLCBNYXRoLmNlaWwodGhpcy55KSlcclxuICAgIH1cclxuXHJcbiAgICByb3VuZCgpOiBQb2ludCB7XHJcbiAgICAgICAgcmV0dXJuIG5ldyBQb2ludChNYXRoLnJvdW5kKHRoaXMueCksIE1hdGgucm91bmQodGhpcy55KSlcclxuICAgIH1cclxuXHJcbiAgICBzaWduKCk6IFBvaW50IHtcclxuICAgICAgICByZXR1cm4gbmV3IFBvaW50KE1hdGguc2lnbih0aGlzLngpLCBNYXRoLnNpZ24odGhpcy55KSlcclxuICAgIH1cclxuXHJcbiAgICBjbG9uZSgpOiBQb2ludCB7XHJcbiAgICAgICAgcmV0dXJuIG5ldyBQb2ludCh0aGlzLngsIHRoaXMueSlcclxuICAgIH1cclxufVxyXG5cclxuZXhwb3J0IGNsYXNzIEFBQkIge1xyXG4gICAgY29uc3RydWN0b3IocmVhZG9ubHkgbWluOiBQb2ludCwgcmVhZG9ubHkgbWF4OiBQb2ludCkgeyB9XHJcblxyXG4gICAgZ2V0IHdpZHRoKCkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLm1heC54IC0gdGhpcy5taW4ueFxyXG4gICAgfVxyXG5cclxuICAgIGdldCBoZWlnaHQoKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMubWF4LnkgLSB0aGlzLm1pbi55XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0IGFyZWEoKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMud2lkdGggKiB0aGlzLmhlaWdodFxyXG4gICAgfVxyXG5cclxuICAgIGdldCBjZW50ZXIoKTogUG9pbnQge1xyXG4gICAgICAgIHJldHVybiBuZXcgUG9pbnQodGhpcy5taW4ueCArIHRoaXMud2lkdGggLyAyLCB0aGlzLm1pbi55ICsgdGhpcy5oZWlnaHQgLyAyKVxyXG4gICAgfVxyXG5cclxuICAgIGNvbWJpbmUoYWFiYjogQUFCQik6IEFBQkIge1xyXG4gICAgICAgIGNvbnN0IG1pbiA9IG5ldyBQb2ludChNYXRoLm1pbih0aGlzLm1pbi54LCBhYWJiLm1pbi54KSwgTWF0aC5taW4odGhpcy5taW4ueSwgYWFiYi5taW4ueSkpXHJcbiAgICAgICAgY29uc3QgbWF4ID0gbmV3IFBvaW50KE1hdGgubWF4KHRoaXMubWF4LngsIGFhYmIubWF4LngpLCBNYXRoLm1heCh0aGlzLm1heC55LCBhYWJiLm1heC55KSlcclxuICAgICAgICBjb25zdCByID0gbmV3IEFBQkIobWluLCBtYXgpXHJcbiAgICAgICAgcmV0dXJuIHJcclxuICAgIH1cclxuXHJcbiAgICBvdmVybGFwcyhhYWJiOiBBQUJCKTogYm9vbGVhbiB7XHJcbiAgICAgICAgcmV0dXJuIChcclxuICAgICAgICAgICAgdGhpcy5tYXgueCA+PSBhYWJiLm1pbi54ICYmXHJcbiAgICAgICAgICAgIHRoaXMubWF4LnkgPj0gYWFiYi5taW4ueSAmJlxyXG4gICAgICAgICAgICB0aGlzLm1pbi54IDw9IGFhYmIubWF4LnggJiZcclxuICAgICAgICAgICAgdGhpcy5taW4ueSA8PSBhYWJiLm1heC55XHJcbiAgICAgICAgKVxyXG4gICAgfVxyXG5cclxuICAgIHRyYW5zbGF0ZShvZmZzZXQ6IFBvaW50KTogQUFCQiB7XHJcbiAgICAgICAgcmV0dXJuIG5ldyBBQUJCKHRoaXMubWluLmFkZFBvaW50KG9mZnNldCksIHRoaXMubWF4LmFkZFBvaW50KG9mZnNldCkpXHJcbiAgICB9XHJcblxyXG4gICAgc2NhbGUoczogbnVtYmVyKTogQUFCQiB7XHJcbiAgICAgICAgcmV0dXJuIG5ldyBBQUJCKHRoaXMubWluLm11bFNjYWxhcihzKSwgdGhpcy5tYXgubXVsU2NhbGFyKHMpKVxyXG4gICAgfVxyXG5cclxuICAgIGJ1ZmZlcihwYWRkaW5nOiBudW1iZXIpOiBBQUJCIHtcclxuICAgICAgICBjb25zdCBtaW4gPSBuZXcgUG9pbnQodGhpcy5taW4ueCAtIHBhZGRpbmcsIHRoaXMubWluLnkgLSBwYWRkaW5nKVxyXG4gICAgICAgIGNvbnN0IG1heCA9IG5ldyBQb2ludCh0aGlzLm1heC54ICsgcGFkZGluZywgdGhpcy5tYXgueSArIHBhZGRpbmcpXHJcbiAgICAgICAgcmV0dXJuIG5ldyBBQUJCKG1pbiwgbWF4KVxyXG4gICAgfVxyXG5cclxuICAgIHNocmluayhhbW91bnQ6IG51bWJlcik6IEFBQkIge1xyXG4gICAgICAgIHJldHVybiB0aGlzLmJ1ZmZlcigtYW1vdW50KVxyXG4gICAgfVxyXG5cclxuICAgIGNsb25lKCk6IEFBQkIge1xyXG4gICAgICAgIHJldHVybiBuZXcgQUFCQih0aGlzLm1pbiwgdGhpcy5tYXgpXHJcbiAgICB9XHJcbn1cclxuXHJcbmVudW0gTm9kZVR5cGUge1xyXG4gICAgSW50ZXJuYWwsXHJcbiAgICBMZWFmXHJcbn1cclxuXHJcbmludGVyZmFjZSBJbnRlcm5hbE5vZGU8VD4ge1xyXG4gICAgdHlwZTogTm9kZVR5cGUuSW50ZXJuYWxcclxuICAgIGFhYmI6IEFBQkJcclxuICAgIHBhcmVudDogSW50ZXJuYWxOb2RlPFQ+IHwgbnVsbFxyXG4gICAgY2hpbGRyZW46IE5vZGU8VD5bXVxyXG59XHJcblxyXG5pbnRlcmZhY2UgTGVhZk5vZGU8VD4ge1xyXG4gICAgdHlwZTogTm9kZVR5cGUuTGVhZlxyXG4gICAgYWFiYjogQUFCQlxyXG4gICAgcGFyZW50OiBJbnRlcm5hbE5vZGU8VD4gfCBudWxsXHJcbiAgICBkYXRhOiBUXHJcbn1cclxuXHJcbnR5cGUgTm9kZTxUPiA9IEludGVybmFsTm9kZTxUPiB8IExlYWZOb2RlPFQ+XHJcblxyXG5leHBvcnQgY2xhc3MgQUFCQlRyZWU8VD4ge1xyXG4gICAgcm9vdDogTm9kZTxUPiB8IG51bGwgPSBudWxsXHJcblxyXG4gICAgY29uc3RydWN0b3IoKSB7IH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIGluc2VydCBhIG5ldyBub2RlIGludG8gdGhlIHRyZWVcclxuICAgICAqIHJldHVybnMgYSByZWZlcmVuY2UgdG8gdGhlIGxlYWYgbm9kZSB0aGF0IGNhbiBsYXRlciBiZSB1c2VkIGZvciByZW1vdmFsXHJcbiAgICAgKiBAcGFyYW0gYWFiYiBhYWJiIG9mIGRhdGFcclxuICAgICAqIEBwYXJhbSBkYXRhIGRhdGEgdG8gaW5zZXJ0XHJcbiAgICAgKi9cclxuICAgIGluc2VydChhYWJiOiBBQUJCLCBkYXRhOiBUKTogTGVhZk5vZGU8VD4ge1xyXG4gICAgICAgIC8vIGNyZWF0ZSB0aGUgbGVhZiBub2RlIHRoYXQgd2lsbCBiZSBpbnNlcnRlZFxyXG4gICAgICAgIGNvbnN0IG5ld0xlYWY6IExlYWZOb2RlPFQ+ID0ge1xyXG4gICAgICAgICAgICB0eXBlOiBOb2RlVHlwZS5MZWFmLFxyXG4gICAgICAgICAgICBhYWJiOiBhYWJiLmNsb25lKCksXHJcbiAgICAgICAgICAgIHBhcmVudDogbnVsbCxcclxuICAgICAgICAgICAgZGF0YVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8gbm8gcm9vdCwgY3JlYXRlIGEgbGVhZlxyXG4gICAgICAgIGlmICghdGhpcy5yb290KSB7XHJcbiAgICAgICAgICAgIHRoaXMucm9vdCA9IG5ld0xlYWZcclxuICAgICAgICAgICAgcmV0dXJuIG5ld0xlYWZcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8vIG90aGVyd2lzZSwgY2hvb3NlIGEgbGVhZiB0byBiZWNvbWUgdGhlIHNpYmxpbmcgb2YgdGhlIG5ldyBsZWFmXHJcbiAgICAgICAgY29uc3Qgc2libGluZyA9IHRoaXMuY2hvb3NlU2libGluZ0xlYWYodGhpcy5yb290LCBhYWJiKVxyXG5cclxuICAgICAgICAvLyBjcmVhdGUgYSBuZXcgcGFyZW50IG5vZGVcclxuICAgICAgICBjb25zdCBuZXdQYXJlbnQ6IEludGVybmFsTm9kZTxUPiA9IHtcclxuICAgICAgICAgICAgdHlwZTogTm9kZVR5cGUuSW50ZXJuYWwsXHJcbiAgICAgICAgICAgIHBhcmVudDogc2libGluZy5wYXJlbnQsXHJcbiAgICAgICAgICAgIGFhYmI6IGFhYmIuY29tYmluZShzaWJsaW5nLmFhYmIpLFxyXG4gICAgICAgICAgICBjaGlsZHJlbjogW25ld0xlYWYsIHNpYmxpbmddXHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBzaWJsaW5nLnBhcmVudCA9IG5ld1BhcmVudFxyXG4gICAgICAgIG5ld0xlYWYucGFyZW50ID0gbmV3UGFyZW50XHJcblxyXG4gICAgICAgIC8vIHJlcGxhY2UgbGluayBpbiBvbGQgcGFyZW50IHdpdGggbmV3bHkgY3JlYXRlZCBwYXJlbnRcclxuICAgICAgICAvLyBvciBpZiB0aGVyZSB3YXMgbm8gcGFyZW50LCBsZWFmIHdhcyByb290LCBtYWtlIG5ldyBwYXJlbnQgdGhlIG5ldyByb290XHJcbiAgICAgICAgbGV0IHBhcmVudCA9IG5ld1BhcmVudC5wYXJlbnRcclxuICAgICAgICBpZiAocGFyZW50KSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGlkeCA9IHBhcmVudC5jaGlsZHJlbi5pbmRleE9mKHNpYmxpbmcpXHJcbiAgICAgICAgICAgIGlmIChpZHggPT09IC0xKSB7XHJcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJDb3VsZCBub3QgZmluZCBsaW5rIHRvIGNob3NlbiBzaWJsaW5nXCIpXHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIHBhcmVudC5jaGlsZHJlbltpZHhdID0gbmV3UGFyZW50XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgdGhpcy5yb290ID0gbmV3UGFyZW50XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB0aGlzLnVwZGF0ZUFBQkJzKHBhcmVudClcclxuICAgICAgICByZXR1cm4gbmV3TGVhZlxyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogcmVtb3ZlcyBzcGVjaWZpZWQgbGVhZiBub2RlIGFuZCBpdHMgZGF0YSBmcm9tIHRoZSB0cmVlXHJcbiAgICAgKiBAcGFyYW0gbGVhZiBsZWFmIFxyXG4gICAgICovXHJcbiAgICBkZWxldGUobGVhZjogTGVhZk5vZGU8VD4pIHtcclxuICAgICAgICAvLyBzcGVjaWFsIGNhc2UgLSBsZWFmIGlzIHJvb3RcclxuICAgICAgICBpZiAodGhpcy5yb290ID09PSBsZWFmKSB7XHJcbiAgICAgICAgICAgIHRoaXMucm9vdCA9IG51bGxcclxuICAgICAgICAgICAgcmV0dXJuXHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBjb25zdCBwYXJlbnQgPSBsZWFmLnBhcmVudFxyXG4gICAgICAgIGlmICghcGFyZW50KSB7XHJcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcIkludmFsaWQgdHJlZSwgbm9uLXJvb3QgbGVhZiBoYXMgbm8gcGFyZW50XCIpXHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAvLyBvdGhlcndpc2UsXHJcbiAgICAgICAgLy8gcmVwbGFjZSBsZWFmLnBhcmVudCB3aXRoIGxlYWYncyBzaWJsaW5nXHJcbiAgICAgICAgLy8gcmVjYWxjdWxhdGUgYWFiYnNcclxuICAgICAgICBjb25zdCBzaWJsaW5nID0gcGFyZW50LmNoaWxkcmVuLmZpbmQobiA9PiBuICE9PSBsZWFmKVxyXG4gICAgICAgIGlmICghc2libGluZykge1xyXG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJJbnZhbGlkIHRyZWUsIGxlYWYgbm9kZSBoYXMgbm8gc2libGluZ1wiKVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgY29uc3QgZ3JhbmRQYXJlbnQgPSBwYXJlbnQucGFyZW50XHJcblxyXG4gICAgICAgIC8vIG5vIGdyYW5kcGFyZW50IC0gcGFyZW50IHdhcyByb290IC0gbWFrZSBzaWJsaW5nIHRoZSBuZXcgcm9vdFxyXG4gICAgICAgIGlmICghZ3JhbmRQYXJlbnQpIHtcclxuICAgICAgICAgICAgdGhpcy5yb290ID0gc2libGluZ1xyXG4gICAgICAgICAgICBzaWJsaW5nLnBhcmVudCA9IG51bGxcclxuICAgICAgICAgICAgcmV0dXJuXHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBjb25zdCBwYXJlbnRJZHggPSBncmFuZFBhcmVudC5jaGlsZHJlbi5pbmRleE9mKHBhcmVudClcclxuICAgICAgICBpZiAocGFyZW50SWR4ID09PSAtMSkge1xyXG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJJbnZhbGlkIHRyZWUsIGdyYW5kcGFyZW50IGRvZXMgbm90IGhhdmUgbGluayB0byBwYXJlbnRcIilcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGdyYW5kUGFyZW50LmNoaWxkcmVuW3BhcmVudElkeF0gPSBzaWJsaW5nXHJcbiAgICAgICAgc2libGluZy5wYXJlbnQgPSBncmFuZFBhcmVudFxyXG4gICAgICAgIHRoaXMudXBkYXRlQUFCQnMoZ3JhbmRQYXJlbnQpXHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBJdGVyYXRlcyBvdmVyIGFsbCBkYXRhIHRoYXQgb3ZlcmxhcHMgdGhlIEFBQkJcclxuICAgICAqIEBwYXJhbSBhYWJiIGFhYmJcclxuICAgICAqL1xyXG4gICAgcHVibGljICpxdWVyeShhYWJiOiBBQUJCKTogSXRlcmFibGU8VD4ge1xyXG4gICAgICAgIGNvbnN0IHN0YWNrOiBOb2RlPFQ+W10gPSBbXVxyXG4gICAgICAgIGlmICh0aGlzLnJvb3QgJiYgdGhpcy5yb290LmFhYmIub3ZlcmxhcHMoYWFiYikpIHtcclxuICAgICAgICAgICAgc3RhY2sucHVzaCh0aGlzLnJvb3QpXHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB3aGlsZSAoc3RhY2subGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICBjb25zdCBub2RlID0gYXJyYXkucG9wKHN0YWNrKVxyXG4gICAgICAgICAgICBzd2l0Y2ggKG5vZGUudHlwZSkge1xyXG4gICAgICAgICAgICAgICAgY2FzZSBOb2RlVHlwZS5JbnRlcm5hbDpcclxuICAgICAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IGNoaWxkIG9mIG5vZGUuY2hpbGRyZW4pIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNoaWxkLmFhYmIub3ZlcmxhcHMoYWFiYikpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YWNrLnB1c2goY2hpbGQpXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcblxyXG4gICAgICAgICAgICAgICAgY2FzZSBOb2RlVHlwZS5MZWFmOlxyXG4gICAgICAgICAgICAgICAgICAgIHlpZWxkIG5vZGUuZGF0YVxyXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgY2hvb3NlU2libGluZ0xlYWYobm9kZTogTm9kZTxUPiwgYWFiYjogQUFCQik6IE5vZGU8VD4ge1xyXG4gICAgICAgIC8vIGNob29zZSB0aGUgbGVhZiB0aGF0IHdvdWxkIGluY3JlYXNlIGxlYXN0IGluIGFyZWEgYnkgaW5jbHVkaW5nIHRoaXMgbm9kZVxyXG4gICAgICAgIHN3aXRjaCAobm9kZS50eXBlKSB7XHJcbiAgICAgICAgICAgIGNhc2UgTm9kZVR5cGUuSW50ZXJuYWw6XHJcbiAgICAgICAgICAgICAgICBjb25zdCBuID0gbm9kZS5jaGlsZHJlbi5yZWR1Y2UoKGEsIGIpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAvLyBjYWxjdWxhdGUgc3VyZmFjZSBhcmVhIGluY3JlYXNlIGZvciBub2RlIGFcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBkYSA9IGEuYWFiYi5hcmVhIC0gYS5hYWJiLmNvbWJpbmUoYWFiYikuYXJlYVxyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGRiID0gYi5hYWJiLmFyZWEgLSBiLmFhYmIuY29tYmluZShhYWJiKS5hcmVhXHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGRhIDwgZGIgPyBhIDogYlxyXG4gICAgICAgICAgICAgICAgfSlcclxuXHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5jaG9vc2VTaWJsaW5nTGVhZihuLCBhYWJiKVxyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcblxyXG4gICAgICAgICAgICBjYXNlIE5vZGVUeXBlLkxlYWY6XHJcbiAgICAgICAgICAgICAgICAvLyB3ZSd2ZSByZWFjaGVkIGEgbGVhZiAtIHJldHVybiBpdFxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIG5vZGVcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSB1cGRhdGVBQUJCcyhub2RlOiBJbnRlcm5hbE5vZGU8VD4gfCBudWxsKSB7XHJcbiAgICAgICAgd2hpbGUgKG5vZGUgIT0gbnVsbCkge1xyXG4gICAgICAgICAgICBub2RlLmFhYmIgPSBub2RlLmNoaWxkcmVuWzBdLmFhYmIuY29tYmluZShub2RlLmNoaWxkcmVuWzFdLmFhYmIpXHJcbiAgICAgICAgICAgIG5vZGUgPSBub2RlLnBhcmVudFxyXG4gICAgICAgIH1cclxuICAgIH1cclxufSJdfQ==