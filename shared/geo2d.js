/**
 * 1st attempt at a simple 2d geometry library
 */
import * as array from "../shared/array.js";
import * as math from "../shared/math.js";
export class Point {
    constructor(x, y) {
        this.x = x;
        this.y = y;
    }
    equal(pt) {
        return this.x === pt.x && this.y === pt.y;
    }
    addScalar(x) {
        return new Point(this.x + x, this.y + x);
    }
    subScalar(x) {
        return new Point(this.x - x, this.y - x);
    }
    mulScalar(x) {
        return new Point(this.x * x, this.y * x);
    }
    divScalar(x) {
        return new Point(this.x / x, this.y / x);
    }
    addPoint(pt) {
        return new Point(this.x + pt.x, this.y + pt.y);
    }
    subPoint(pt) {
        return new Point(this.x - pt.x, this.y - pt.y);
    }
    mulPoint(pt) {
        return new Point(this.x * pt.x, this.y * pt.y);
    }
    divPoint(pt) {
        return new Point(this.x / pt.x, this.y / pt.y);
    }
    floor() {
        return new Point(Math.floor(this.x), Math.floor(this.y));
    }
    ciel() {
        return new Point(Math.ceil(this.x), Math.ceil(this.y));
    }
    round() {
        return new Point(Math.round(this.x), Math.round(this.y));
    }
    sign() {
        return new Point(Math.sign(this.x), Math.sign(this.y));
    }
    abs() {
        return new Point(Math.abs(this.x), Math.abs(this.y));
    }
    neg() {
        return new Point(-this.x, -this.y);
    }
    max() {
        return Math.max(this.x, this.y);
    }
    min() {
        return Math.min(this.x, this.y);
    }
    clone() {
        return new Point(this.x, this.y);
    }
    save() {
        return [this.x, this.y];
    }
    static inf() {
        return new Point(Infinity, Infinity);
    }
    static negInf() {
        return new Point(-Infinity, -Infinity);
    }
    static load(a) {
        return new Point(a[0], a[1]);
    }
}
export class AABB {
    constructor(min, max) {
        this.min = min;
        this.max = max;
    }
    get width() {
        return this.max.x - this.min.x;
    }
    get height() {
        return this.max.y - this.min.y;
    }
    get area() {
        return this.width * this.height;
    }
    get center() {
        return new Point(this.min.x + this.width / 2, this.min.y + this.height / 2);
    }
    union(aabb) {
        const min = new Point(Math.min(this.min.x, aabb.min.x), Math.min(this.min.y, aabb.min.y));
        const max = new Point(Math.max(this.max.x, aabb.max.x), Math.max(this.max.y, aabb.max.y));
        const r = new AABB(min, max);
        return r;
    }
    intersection(aabb) {
        const min = new Point(Math.max(this.min.x, aabb.min.x), Math.max(this.min.y, aabb.min.y));
        const max = new Point(Math.min(this.max.x, aabb.max.x), Math.min(this.max.y, aabb.max.y));
        const r = new AABB(min, max);
        return r;
    }
    overlaps(aabb) {
        return (this.max.x >= aabb.min.x &&
            this.max.y >= aabb.min.y &&
            this.min.x <= aabb.max.x &&
            this.min.y <= aabb.max.y);
    }
    contains(pt) {
        return (pt.x >= this.min.x &&
            pt.y >= this.min.y &&
            pt.x < this.max.x &&
            pt.y < this.max.y);
    }
    translate(offset) {
        return new AABB(this.min.addPoint(offset), this.max.addPoint(offset));
    }
    scale(s) {
        return new AABB(this.min.mulScalar(s), this.max.mulScalar(s));
    }
    buffer(padding) {
        const min = new Point(this.min.x - padding, this.min.y - padding);
        const max = new Point(this.max.x + padding, this.max.y + padding);
        return new AABB(min, max);
    }
    shrink(amount) {
        return this.buffer(-amount);
    }
    clone() {
        return new AABB(this.min.clone(), this.max.clone());
    }
    static empty() {
        return new AABB(Point.inf(), Point.negInf());
    }
    static inf() {
        return new AABB(Point.negInf(), Point.inf());
    }
}
var NodeType;
(function (NodeType) {
    NodeType[NodeType["Internal"] = 0] = "Internal";
    NodeType[NodeType["Leaf"] = 1] = "Leaf";
})(NodeType || (NodeType = {}));
export class AABBTree {
    constructor() {
        this.root = null;
    }
    /**
     * insert a new node into the tree
     * returns a reference to the leaf node that can later be used for removal
     * @param aabb aabb of data
     * @param data data to insert
     */
    insert(aabb, data) {
        // create the leaf node that will be inserted
        const newLeaf = {
            type: NodeType.Leaf,
            aabb: aabb.clone(),
            parent: null,
            data
        };
        // no root, create a leaf
        if (!this.root) {
            this.root = newLeaf;
            return newLeaf;
        }
        // otherwise, choose a leaf to become the sibling of the new leaf
        const sibling = this.chooseSiblingLeaf(this.root, aabb);
        // create a new parent node
        const newParent = {
            type: NodeType.Internal,
            parent: sibling.parent,
            aabb: aabb.union(sibling.aabb),
            children: [newLeaf, sibling]
        };
        sibling.parent = newParent;
        newLeaf.parent = newParent;
        // replace link in old parent with newly created parent
        // or if there was no parent, leaf was root, make new parent the new root
        let parent = newParent.parent;
        if (parent) {
            const idx = parent.children.indexOf(sibling);
            if (idx === -1) {
                throw new Error("Could not find link to chosen sibling");
            }
            parent.children[idx] = newParent;
        }
        else {
            this.root = newParent;
        }
        this.updateAABBs(parent);
        return newLeaf;
    }
    /**
     * removes specified leaf node and its data from the tree
     * @param leaf leaf
     */
    delete(leaf) {
        // special case - leaf is root
        if (this.root === leaf) {
            this.root = null;
            return;
        }
        const parent = leaf.parent;
        if (!parent) {
            throw new Error("Invalid tree, non-root leaf has no parent");
        }
        // otherwise,
        // replace leaf.parent with leaf's sibling
        // recalculate aabbs
        const sibling = parent.children.find(n => n !== leaf);
        if (!sibling) {
            throw new Error("Invalid tree, leaf node has no sibling");
        }
        const grandParent = parent.parent;
        // no grandparent - parent was root - make sibling the new root
        if (!grandParent) {
            this.root = sibling;
            sibling.parent = null;
            return;
        }
        const parentIdx = grandParent.children.indexOf(parent);
        if (parentIdx === -1) {
            throw new Error("Invalid tree, grandparent does not have link to parent");
        }
        grandParent.children[parentIdx] = sibling;
        sibling.parent = grandParent;
        this.updateAABBs(grandParent);
    }
    /**
     * Iterates over all data that overlaps the AABB
     * @param aabb aabb
     */
    *query(aabb) {
        const stack = [];
        if (this.root && this.root.aabb.overlaps(aabb)) {
            stack.push(this.root);
        }
        while (stack.length > 0) {
            const node = array.pop(stack);
            switch (node.type) {
                case NodeType.Internal:
                    for (const child of node.children) {
                        if (child.aabb.overlaps(aabb)) {
                            stack.push(child);
                        }
                    }
                    break;
                case NodeType.Leaf:
                    yield node.data;
                    break;
            }
        }
    }
    chooseSiblingLeaf(node, aabb) {
        // choose the leaf that would increase least in area by including this node
        switch (node.type) {
            case NodeType.Internal:
                const n = node.children.reduce((a, b) => {
                    // calculate surface area increase for node a
                    const da = a.aabb.area - a.aabb.union(aabb).area;
                    const db = b.aabb.area - b.aabb.union(aabb).area;
                    return da < db ? a : b;
                });
                return this.chooseSiblingLeaf(n, aabb);
                break;
            case NodeType.Leaf:
                // we've reached a leaf - return it
                return node;
        }
    }
    updateAABBs(node) {
        while (node != null) {
            node.aabb = node.children[0].aabb.union(node.children[1].aabb);
            node = node.parent;
        }
    }
}
/**
 * calculate manhatten distance between coordinates
 * @param a first point
 * @param b second point
 */
export function calcManhattenDist(a, b) {
    return Math.abs(b.x - a.x) + Math.abs(b.y - a.y);
}
/**
 * linearly interpolate between 2 points
 * @param a first point
 * @param b second point
 * @param t number between 0 and 1
 */
export function lerp(a, b, t) {
    const x = math.lerp(a.x, b.x, t);
    const y = math.lerp(a.y, b.y, t);
    return new Point(x, y);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2VvMmQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJnZW8yZC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7R0FFRztBQUNILE9BQU8sS0FBSyxLQUFLLE1BQU0sb0JBQW9CLENBQUE7QUFDM0MsT0FBTyxLQUFLLElBQUksTUFBTSxtQkFBbUIsQ0FBQTtBQU96QyxNQUFNLE9BQU8sS0FBSztJQUNkLFlBQW1CLENBQVMsRUFBUyxDQUFTO1FBQTNCLE1BQUMsR0FBRCxDQUFDLENBQVE7UUFBUyxNQUFDLEdBQUQsQ0FBQyxDQUFRO0lBQUksQ0FBQztJQUVuRCxLQUFLLENBQUMsRUFBUztRQUNYLE9BQU8sSUFBSSxDQUFDLENBQUMsS0FBSyxFQUFFLENBQUMsQ0FBQyxJQUFJLElBQUksQ0FBQyxDQUFDLEtBQUssRUFBRSxDQUFDLENBQUMsQ0FBQTtJQUM3QyxDQUFDO0lBRUQsU0FBUyxDQUFDLENBQVM7UUFDZixPQUFPLElBQUksS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDLEdBQUcsQ0FBQyxFQUFFLElBQUksQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUE7SUFDNUMsQ0FBQztJQUVELFNBQVMsQ0FBQyxDQUFTO1FBQ2YsT0FBTyxJQUFJLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQyxHQUFHLENBQUMsRUFBRSxJQUFJLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFBO0lBQzVDLENBQUM7SUFFRCxTQUFTLENBQUMsQ0FBUztRQUNmLE9BQU8sSUFBSSxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUMsR0FBRyxDQUFDLEVBQUUsSUFBSSxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQTtJQUM1QyxDQUFDO0lBRUQsU0FBUyxDQUFDLENBQVM7UUFDZixPQUFPLElBQUksS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDLEdBQUcsQ0FBQyxFQUFFLElBQUksQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUE7SUFDNUMsQ0FBQztJQUVELFFBQVEsQ0FBQyxFQUFTO1FBQ2QsT0FBTyxJQUFJLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDLEVBQUUsSUFBSSxDQUFDLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUE7SUFDbEQsQ0FBQztJQUVELFFBQVEsQ0FBQyxFQUFTO1FBQ2QsT0FBTyxJQUFJLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDLEVBQUUsSUFBSSxDQUFDLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUE7SUFDbEQsQ0FBQztJQUVELFFBQVEsQ0FBQyxFQUFTO1FBQ2QsT0FBTyxJQUFJLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDLEVBQUUsSUFBSSxDQUFDLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUE7SUFDbEQsQ0FBQztJQUVELFFBQVEsQ0FBQyxFQUFTO1FBQ2QsT0FBTyxJQUFJLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDLEVBQUUsSUFBSSxDQUFDLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUE7SUFDbEQsQ0FBQztJQUVELEtBQUs7UUFDRCxPQUFPLElBQUksS0FBSyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUE7SUFDNUQsQ0FBQztJQUVELElBQUk7UUFDQSxPQUFPLElBQUksS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUE7SUFDMUQsQ0FBQztJQUVELEtBQUs7UUFDRCxPQUFPLElBQUksS0FBSyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUE7SUFDNUQsQ0FBQztJQUVELElBQUk7UUFDQSxPQUFPLElBQUksS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUE7SUFDMUQsQ0FBQztJQUVELEdBQUc7UUFDQyxPQUFPLElBQUksS0FBSyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUE7SUFDeEQsQ0FBQztJQUVELEdBQUc7UUFDQyxPQUFPLElBQUksS0FBSyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQTtJQUN0QyxDQUFDO0lBRUQsR0FBRztRQUNDLE9BQU8sSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQTtJQUNuQyxDQUFDO0lBRUQsR0FBRztRQUNDLE9BQU8sSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQTtJQUNuQyxDQUFDO0lBRUQsS0FBSztRQUNELE9BQU8sSUFBSSxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUMsRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUE7SUFDcEMsQ0FBQztJQUVELElBQUk7UUFDQSxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDNUIsQ0FBQztJQUVELE1BQU0sQ0FBQyxHQUFHO1FBQ04sT0FBTyxJQUFJLEtBQUssQ0FBQyxRQUFRLEVBQUUsUUFBUSxDQUFDLENBQUE7SUFDeEMsQ0FBQztJQUVELE1BQU0sQ0FBQyxNQUFNO1FBQ1QsT0FBTyxJQUFJLEtBQUssQ0FBQyxDQUFDLFFBQVEsRUFBRSxDQUFDLFFBQVEsQ0FBQyxDQUFBO0lBQzFDLENBQUM7SUFFRCxNQUFNLENBQUMsSUFBSSxDQUFDLENBQW1CO1FBQzNCLE9BQU8sSUFBSSxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ2pDLENBQUM7Q0FDSjtBQUVELE1BQU0sT0FBTyxJQUFJO0lBQ2IsWUFBcUIsR0FBVSxFQUFXLEdBQVU7UUFBL0IsUUFBRyxHQUFILEdBQUcsQ0FBTztRQUFXLFFBQUcsR0FBSCxHQUFHLENBQU87SUFBSSxDQUFDO0lBRXpELElBQUksS0FBSztRQUNMLE9BQU8sSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUE7SUFDbEMsQ0FBQztJQUVELElBQUksTUFBTTtRQUNOLE9BQU8sSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUE7SUFDbEMsQ0FBQztJQUVELElBQUksSUFBSTtRQUNKLE9BQU8sSUFBSSxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFBO0lBQ25DLENBQUM7SUFFRCxJQUFJLE1BQU07UUFDTixPQUFPLElBQUksS0FBSyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFHLElBQUksQ0FBQyxLQUFLLEdBQUcsQ0FBQyxFQUFFLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFHLElBQUksQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDLENBQUE7SUFDL0UsQ0FBQztJQUVELEtBQUssQ0FBQyxJQUFVO1FBQ1osTUFBTSxHQUFHLEdBQUcsSUFBSSxLQUFLLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRSxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUUsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFBO1FBQ3pGLE1BQU0sR0FBRyxHQUFHLElBQUksS0FBSyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUUsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQTtRQUN6RixNQUFNLENBQUMsR0FBRyxJQUFJLElBQUksQ0FBQyxHQUFHLEVBQUUsR0FBRyxDQUFDLENBQUE7UUFDNUIsT0FBTyxDQUFDLENBQUE7SUFDWixDQUFDO0lBRUQsWUFBWSxDQUFDLElBQVU7UUFDbkIsTUFBTSxHQUFHLEdBQUcsSUFBSSxLQUFLLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRSxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUUsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFBO1FBQ3pGLE1BQU0sR0FBRyxHQUFHLElBQUksS0FBSyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUUsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQTtRQUN6RixNQUFNLENBQUMsR0FBRyxJQUFJLElBQUksQ0FBQyxHQUFHLEVBQUUs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QUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUE7QUFDcEQsQ0FBQztBQUVEOzs7OztHQUtHO0FBQ0gsTUFBTSxVQUFVLElBQUksQ0FBQyxDQUFRLEVBQUUsQ0FBUSxFQUFFLENBQVM7SUFDOUMsTUFBTSxDQUFDLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUE7SUFDaEMsTUFBTSxDQUFDLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUE7SUFDaEMsT0FBTyxJQUFJLEtBQUssQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUE7QUFDMUIsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxyXG4gKiAxc3QgYXR0ZW1wdCBhdCBhIHNpbXBsZSAyZCBnZW9tZXRyeSBsaWJyYXJ5XHJcbiAqL1xyXG5pbXBvcnQgKiBhcyBhcnJheSBmcm9tIFwiLi4vc2hhcmVkL2FycmF5LmpzXCJcclxuaW1wb3J0ICogYXMgbWF0aCBmcm9tIFwiLi4vc2hhcmVkL21hdGguanNcIlxyXG5cclxuZXhwb3J0IGludGVyZmFjZSBQb2ludE9wdGlvbnMge1xyXG4gICAgeDogbnVtYmVyLFxyXG4gICAgeTogbnVtYmVyXHJcbn1cclxuXHJcbmV4cG9ydCBjbGFzcyBQb2ludCB7XHJcbiAgICBjb25zdHJ1Y3RvcihwdWJsaWMgeDogbnVtYmVyLCBwdWJsaWMgeTogbnVtYmVyKSB7IH1cclxuXHJcbiAgICBlcXVhbChwdDogUG9pbnQpOiBib29sZWFuIHtcclxuICAgICAgICByZXR1cm4gdGhpcy54ID09PSBwdC54ICYmIHRoaXMueSA9PT0gcHQueVxyXG4gICAgfVxyXG5cclxuICAgIGFkZFNjYWxhcih4OiBudW1iZXIpOiBQb2ludCB7XHJcbiAgICAgICAgcmV0dXJuIG5ldyBQb2ludCh0aGlzLnggKyB4LCB0aGlzLnkgKyB4KVxyXG4gICAgfVxyXG5cclxuICAgIHN1YlNjYWxhcih4OiBudW1iZXIpOiBQb2ludCB7XHJcbiAgICAgICAgcmV0dXJuIG5ldyBQb2ludCh0aGlzLnggLSB4LCB0aGlzLnkgLSB4KVxyXG4gICAgfVxyXG5cclxuICAgIG11bFNjYWxhcih4OiBudW1iZXIpOiBQb2ludCB7XHJcbiAgICAgICAgcmV0dXJuIG5ldyBQb2ludCh0aGlzLnggKiB4LCB0aGlzLnkgKiB4KVxyXG4gICAgfVxyXG5cclxuICAgIGRpdlNjYWxhcih4OiBudW1iZXIpOiBQb2ludCB7XHJcbiAgICAgICAgcmV0dXJuIG5ldyBQb2ludCh0aGlzLnggLyB4LCB0aGlzLnkgLyB4KVxyXG4gICAgfVxyXG5cclxuICAgIGFkZFBvaW50KHB0OiBQb2ludCk6IFBvaW50IHtcclxuICAgICAgICByZXR1cm4gbmV3IFBvaW50KHRoaXMueCArIHB0LngsIHRoaXMueSArIHB0LnkpXHJcbiAgICB9XHJcblxyXG4gICAgc3ViUG9pbnQocHQ6IFBvaW50KTogUG9pbnQge1xyXG4gICAgICAgIHJldHVybiBuZXcgUG9pbnQodGhpcy54IC0gcHQueCwgdGhpcy55IC0gcHQueSlcclxuICAgIH1cclxuXHJcbiAgICBtdWxQb2ludChwdDogUG9pbnQpOiBQb2ludCB7XHJcbiAgICAgICAgcmV0dXJuIG5ldyBQb2ludCh0aGlzLnggKiBwdC54LCB0aGlzLnkgKiBwdC55KVxyXG4gICAgfVxyXG5cclxuICAgIGRpdlBvaW50KHB0OiBQb2ludCk6IFBvaW50IHtcclxuICAgICAgICByZXR1cm4gbmV3IFBvaW50KHRoaXMueCAvIHB0LngsIHRoaXMueSAvIHB0LnkpXHJcbiAgICB9XHJcblxyXG4gICAgZmxvb3IoKTogUG9pbnQge1xyXG4gICAgICAgIHJldHVybiBuZXcgUG9pbnQoTWF0aC5mbG9vcih0aGlzLngpLCBNYXRoLmZsb29yKHRoaXMueSkpXHJcbiAgICB9XHJcblxyXG4gICAgY2llbCgpOiBQb2ludCB7XHJcbiAgICAgICAgcmV0dXJuIG5ldyBQb2ludChNYXRoLmNlaWwodGhpcy54KSwgTWF0aC5jZWlsKHRoaXMueSkpXHJcbiAgICB9XHJcblxyXG4gICAgcm91bmQoKTogUG9pbnQge1xyXG4gICAgICAgIHJldHVybiBuZXcgUG9pbnQoTWF0aC5yb3VuZCh0aGlzLngpLCBNYXRoLnJvdW5kKHRoaXMueSkpXHJcbiAgICB9XHJcblxyXG4gICAgc2lnbigpOiBQb2ludCB7XHJcbiAgICAgICAgcmV0dXJuIG5ldyBQb2ludChNYXRoLnNpZ24odGhpcy54KSwgTWF0aC5zaWduKHRoaXMueSkpXHJcbiAgICB9XHJcblxyXG4gICAgYWJzKCk6IFBvaW50IHtcclxuICAgICAgICByZXR1cm4gbmV3IFBvaW50KE1hdGguYWJzKHRoaXMueCksIE1hdGguYWJzKHRoaXMueSkpXHJcbiAgICB9XHJcblxyXG4gICAgbmVnKCk6IFBvaW50IHtcclxuICAgICAgICByZXR1cm4gbmV3IFBvaW50KC10aGlzLngsIC10aGlzLnkpXHJcbiAgICB9XHJcblxyXG4gICAgbWF4KCk6IG51bWJlciB7XHJcbiAgICAgICAgcmV0dXJuIE1hdGgubWF4KHRoaXMueCwgdGhpcy55KVxyXG4gICAgfVxyXG5cclxuICAgIG1pbigpOiBudW1iZXIge1xyXG4gICAgICAgIHJldHVybiBNYXRoLm1pbih0aGlzLngsIHRoaXMueSlcclxuICAgIH1cclxuXHJcbiAgICBjbG9uZSgpOiBQb2ludCB7XHJcbiAgICAgICAgcmV0dXJuIG5ldyBQb2ludCh0aGlzLngsIHRoaXMueSlcclxuICAgIH1cclxuXHJcbiAgICBzYXZlKCk6IFtudW1iZXIsIG51bWJlcl0ge1xyXG4gICAgICAgIHJldHVybiBbdGhpcy54LCB0aGlzLnldO1xyXG4gICAgfVxyXG5cclxuICAgIHN0YXRpYyBpbmYoKSB7XHJcbiAgICAgICAgcmV0dXJuIG5ldyBQb2ludChJbmZpbml0eSwgSW5maW5pdHkpXHJcbiAgICB9XHJcblxyXG4gICAgc3RhdGljIG5lZ0luZigpIHtcclxuICAgICAgICByZXR1cm4gbmV3IFBvaW50KC1JbmZpbml0eSwgLUluZmluaXR5KVxyXG4gICAgfVxyXG5cclxuICAgIHN0YXRpYyBsb2FkKGE6IFtudW1iZXIsIG51bWJlcl0pOiBQb2ludCB7XHJcbiAgICAgICAgcmV0dXJuIG5ldyBQb2ludChhWzBdLCBhWzFdKTtcclxuICAgIH1cclxufVxyXG5cclxuZXhwb3J0IGNsYXNzIEFBQkIge1xyXG4gICAgY29uc3RydWN0b3IocmVhZG9ubHkgbWluOiBQb2ludCwgcmVhZG9ubHkgbWF4OiBQb2ludCkgeyB9XHJcblxyXG4gICAgZ2V0IHdpZHRoKCkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLm1heC54IC0gdGhpcy5taW4ueFxyXG4gICAgfVxyXG5cclxuICAgIGdldCBoZWlnaHQoKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMubWF4LnkgLSB0aGlzLm1pbi55XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0IGFyZWEoKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMud2lkdGggKiB0aGlzLmhlaWdodFxyXG4gICAgfVxyXG5cclxuICAgIGdldCBjZW50ZXIoKTogUG9pbnQge1xyXG4gICAgICAgIHJldHVybiBuZXcgUG9pbnQodGhpcy5taW4ueCArIHRoaXMud2lkdGggLyAyLCB0aGlzLm1pbi55ICsgdGhpcy5oZWlnaHQgLyAyKVxyXG4gICAgfVxyXG5cclxuICAgIHVuaW9uKGFhYmI6IEFBQkIpOiBBQUJCIHtcclxuICAgICAgICBjb25zdCBtaW4gPSBuZXcgUG9pbnQoTWF0aC5taW4odGhpcy5taW4ueCwgYWFiYi5taW4ueCksIE1hdGgubWluKHRoaXMubWluLnksIGFhYmIubWluLnkpKVxyXG4gICAgICAgIGNvbnN0IG1heCA9IG5ldyBQb2ludChNYXRoLm1heCh0aGlzLm1heC54LCBhYWJiLm1heC54KSwgTWF0aC5tYXgodGhpcy5tYXgueSwgYWFiYi5tYXgueSkpXHJcbiAgICAgICAgY29uc3QgciA9IG5ldyBBQUJCKG1pbiwgbWF4KVxyXG4gICAgICAgIHJldHVybiByXHJcbiAgICB9XHJcblxyXG4gICAgaW50ZXJzZWN0aW9uKGFhYmI6IEFBQkIpOiBBQUJCIHtcclxuICAgICAgICBjb25zdCBtaW4gPSBuZXcgUG9pbnQoTWF0aC5tYXgodGhpcy5taW4ueCwgYWFiYi5taW4ueCksIE1hdGgubWF4KHRoaXMubWluLnksIGFhYmIubWluLnkpKVxyXG4gICAgICAgIGNvbnN0IG1heCA9IG5ldyBQb2ludChNYXRoLm1pbih0aGlzLm1heC54LCBhYWJiLm1heC54KSwgTWF0aC5taW4odGhpcy5tYXgueSwgYWFiYi5tYXgueSkpXHJcbiAgICAgICAgY29uc3QgciA9IG5ldyBBQUJCKG1pbiwgbWF4KVxyXG4gICAgICAgIHJldHVybiByXHJcbiAgICB9XHJcblxyXG4gICAgb3ZlcmxhcHMoYWFiYjogQUFCQik6IGJvb2xlYW4ge1xyXG4gICAgICAgIHJldHVybiAoXHJcbiAgICAgICAgICAgIHRoaXMubWF4LnggPj0gYWFiYi5taW4ueCAmJlxyXG4gICAgICAgICAgICB0aGlzLm1heC55ID49IGFhYmIubWluLnkgJiZcclxuICAgICAgICAgICAgdGhpcy5taW4ueCA8PSBhYWJiLm1heC54ICYmXHJcbiAgICAgICAgICAgIHRoaXMubWluLnkgPD0gYWFiYi5tYXgueVxyXG4gICAgICAgIClcclxuICAgIH1cclxuXHJcbiAgICBjb250YWlucyhwdDogUG9pbnQpOiBib29sZWFuIHtcclxuICAgICAgICByZXR1cm4gKFxyXG4gICAgICAgICAgICBwdC54ID49IHRoaXMubWluLnggJiZcclxuICAgICAgICAgICAgcHQueSA+PSB0aGlzLm1pbi55ICYmXHJcbiAgICAgICAgICAgIHB0LnggPCB0aGlzLm1heC54ICYmXHJcbiAgICAgICAgICAgIHB0LnkgPCB0aGlzLm1heC55XHJcbiAgICAgICAgKVxyXG4gICAgfVxyXG5cclxuICAgIHRyYW5zbGF0ZShvZmZzZXQ6IFBvaW50KTogQUFCQiB7XHJcbiAgICAgICAgcmV0dXJuIG5ldyBBQUJCKHRoaXMubWluLmFkZFBvaW50KG9mZnNldCksIHRoaXMubWF4LmFkZFBvaW50KG9mZnNldCkpXHJcbiAgICB9XHJcblxyXG4gICAgc2NhbGUoczogbnVtYmVyKTogQUFCQiB7XHJcbiAgICAgICAgcmV0dXJuIG5ldyBBQUJCKHRoaXMubWluLm11bFNjYWxhcihzKSwgdGhpcy5tYXgubXVsU2NhbGFyKHMpKVxyXG4gICAgfVxyXG5cclxuICAgIGJ1ZmZlcihwYWRkaW5nOiBudW1iZXIpOiBBQUJCIHtcclxuICAgICAgICBjb25zdCBtaW4gPSBuZXcgUG9pbnQodGhpcy5taW4ueCAtIHBhZGRpbmcsIHRoaXMubWluLnkgLSBwYWRkaW5nKVxyXG4gICAgICAgIGNvbnN0IG1heCA9IG5ldyBQb2ludCh0aGlzLm1heC54ICsgcGFkZGluZywgdGhpcy5tYXgueSArIHBhZGRpbmcpXHJcbiAgICAgICAgcmV0dXJuIG5ldyBBQUJCKG1pbiwgbWF4KVxyXG4gICAgfVxyXG5cclxuICAgIHNocmluayhhbW91bnQ6IG51bWJlcik6IEFBQkIge1xyXG4gICAgICAgIHJldHVybiB0aGlzLmJ1ZmZlcigtYW1vdW50KVxyXG4gICAgfVxyXG5cclxuICAgIGNsb25lKCk6IEFBQkIge1xyXG4gICAgICAgIHJldHVybiBuZXcgQUFCQih0aGlzLm1pbi5jbG9uZSgpLCB0aGlzLm1heC5jbG9uZSgpKVxyXG4gICAgfVxyXG5cclxuICAgIHN0YXRpYyBlbXB0eSgpOiBBQUJCIHtcclxuICAgICAgICByZXR1cm4gbmV3IEFBQkIoUG9pbnQuaW5mKCksIFBvaW50Lm5lZ0luZigpKVxyXG4gICAgfVxyXG5cclxuICAgIHN0YXRpYyBpbmYoKTogQUFCQiB7XHJcbiAgICAgICAgcmV0dXJuIG5ldyBBQUJCKFBvaW50Lm5lZ0luZigpLCBQb2ludC5pbmYoKSlcclxuICAgIH1cclxufVxyXG5cclxuZW51bSBOb2RlVHlwZSB7XHJcbiAgICBJbnRlcm5hbCxcclxuICAgIExlYWZcclxufVxyXG5cclxuaW50ZXJmYWNlIEludGVybmFsTm9kZTxUPiB7XHJcbiAgICB0eXBlOiBOb2RlVHlwZS5JbnRlcm5hbFxyXG4gICAgYWFiYjogQUFCQlxyXG4gICAgcGFyZW50OiBJbnRlcm5hbE5vZGU8VD4gfCBudWxsXHJcbiAgICBjaGlsZHJlbjogTm9kZTxUPltdXHJcbn1cclxuXHJcbmludGVyZmFjZSBMZWFmTm9kZTxUPiB7XHJcbiAgICB0eXBlOiBOb2RlVHlwZS5MZWFmXHJcbiAgICBhYWJiOiBBQUJCXHJcbiAgICBwYXJlbnQ6IEludGVybmFsTm9kZTxUPiB8IG51bGxcclxuICAgIGRhdGE6IFRcclxufVxyXG5cclxudHlwZSBOb2RlPFQ+ID0gSW50ZXJuYWxOb2RlPFQ+IHwgTGVhZk5vZGU8VD5cclxuXHJcbmV4cG9ydCBjbGFzcyBBQUJCVHJlZTxUPiB7XHJcbiAgICByb290OiBOb2RlPFQ+IHwgbnVsbCA9IG51bGxcclxuXHJcbiAgICBjb25zdHJ1Y3RvcigpIHsgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogaW5zZXJ0IGEgbmV3IG5vZGUgaW50byB0aGUgdHJlZVxyXG4gICAgICogcmV0dXJucyBhIHJlZmVyZW5jZSB0byB0aGUgbGVhZiBub2RlIHRoYXQgY2FuIGxhdGVyIGJlIHVzZWQgZm9yIHJlbW92YWxcclxuICAgICAqIEBwYXJhbSBhYWJiIGFhYmIgb2YgZGF0YVxyXG4gICAgICogQHBhcmFtIGRhdGEgZGF0YSB0byBpbnNlcnRcclxuICAgICAqL1xyXG4gICAgaW5zZXJ0KGFhYmI6IEFBQkIsIGRhdGE6IFQpOiBMZWFmTm9kZTxUPiB7XHJcbiAgICAgICAgLy8gY3JlYXRlIHRoZSBsZWFmIG5vZGUgdGhhdCB3aWxsIGJlIGluc2VydGVkXHJcbiAgICAgICAgY29uc3QgbmV3TGVhZjogTGVhZk5vZGU8VD4gPSB7XHJcbiAgICAgICAgICAgIHR5cGU6IE5vZGVUeXBlLkxlYWYsXHJcbiAgICAgICAgICAgIGFhYmI6IGFhYmIuY2xvbmUoKSxcclxuICAgICAgICAgICAgcGFyZW50OiBudWxsLFxyXG4gICAgICAgICAgICBkYXRhXHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAvLyBubyByb290LCBjcmVhdGUgYSBsZWFmXHJcbiAgICAgICAgaWYgKCF0aGlzLnJvb3QpIHtcclxuICAgICAgICAgICAgdGhpcy5yb290ID0gbmV3TGVhZlxyXG4gICAgICAgICAgICByZXR1cm4gbmV3TGVhZlxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8gb3RoZXJ3aXNlLCBjaG9vc2UgYSBsZWFmIHRvIGJlY29tZSB0aGUgc2libGluZyBvZiB0aGUgbmV3IGxlYWZcclxuICAgICAgICBjb25zdCBzaWJsaW5nID0gdGhpcy5jaG9vc2VTaWJsaW5nTGVhZih0aGlzLnJvb3QsIGFhYmIpXHJcblxyXG4gICAgICAgIC8vIGNyZWF0ZSBhIG5ldyBwYXJlbnQgbm9kZVxyXG4gICAgICAgIGNvbnN0IG5ld1BhcmVudDogSW50ZXJuYWxOb2RlPFQ+ID0ge1xyXG4gICAgICAgICAgICB0eXBlOiBOb2RlVHlwZS5JbnRlcm5hbCxcclxuICAgICAgICAgICAgcGFyZW50OiBzaWJsaW5nLnBhcmVudCxcclxuICAgICAgICAgICAgYWFiYjogYWFiYi51bmlvbihzaWJsaW5nLmFhYmIpLFxyXG4gICAgICAgICAgICBjaGlsZHJlbjogW25ld0xlYWYsIHNpYmxpbmddXHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBzaWJsaW5nLnBhcmVudCA9IG5ld1BhcmVudFxyXG4gICAgICAgIG5ld0xlYWYucGFyZW50ID0gbmV3UGFyZW50XHJcblxyXG4gICAgICAgIC8vIHJlcGxhY2UgbGluayBpbiBvbGQgcGFyZW50IHdpdGggbmV3bHkgY3JlYXRlZCBwYXJlbnRcclxuICAgICAgICAvLyBvciBpZiB0aGVyZSB3YXMgbm8gcGFyZW50LCBsZWFmIHdhcyByb290LCBtYWtlIG5ldyBwYXJlbnQgdGhlIG5ldyByb290XHJcbiAgICAgICAgbGV0IHBhcmVudCA9IG5ld1BhcmVudC5wYXJlbnRcclxuICAgICAgICBpZiAocGFyZW50KSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGlkeCA9IHBhcmVudC5jaGlsZHJlbi5pbmRleE9mKHNpYmxpbmcpXHJcbiAgICAgICAgICAgIGlmIChpZHggPT09IC0xKSB7XHJcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJDb3VsZCBub3QgZmluZCBsaW5rIHRvIGNob3NlbiBzaWJsaW5nXCIpXHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIHBhcmVudC5jaGlsZHJlbltpZHhdID0gbmV3UGFyZW50XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgdGhpcy5yb290ID0gbmV3UGFyZW50XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB0aGlzLnVwZGF0ZUFBQkJzKHBhcmVudClcclxuICAgICAgICByZXR1cm4gbmV3TGVhZlxyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogcmVtb3ZlcyBzcGVjaWZpZWQgbGVhZiBub2RlIGFuZCBpdHMgZGF0YSBmcm9tIHRoZSB0cmVlXHJcbiAgICAgKiBAcGFyYW0gbGVhZiBsZWFmIFxyXG4gICAgICovXHJcbiAgICBkZWxldGUobGVhZjogTGVhZk5vZGU8VD4pIHtcclxuICAgICAgICAvLyBzcGVjaWFsIGNhc2UgLSBsZWFmIGlzIHJvb3RcclxuICAgICAgICBpZiAodGhpcy5yb290ID09PSBsZWFmKSB7XHJcbiAgICAgICAgICAgIHRoaXMucm9vdCA9IG51bGxcclxuICAgICAgICAgICAgcmV0dXJuXHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBjb25zdCBwYXJlbnQgPSBsZWFmLnBhcmVudFxyXG4gICAgICAgIGlmICghcGFyZW50KSB7XHJcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcIkludmFsaWQgdHJlZSwgbm9uLXJvb3QgbGVhZiBoYXMgbm8gcGFyZW50XCIpXHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAvLyBvdGhlcndpc2UsXHJcbiAgICAgICAgLy8gcmVwbGFjZSBsZWFmLnBhcmVudCB3aXRoIGxlYWYncyBzaWJsaW5nXHJcbiAgICAgICAgLy8gcmVjYWxjdWxhdGUgYWFiYnNcclxuICAgICAgICBjb25zdCBzaWJsaW5nID0gcGFyZW50LmNoaWxkcmVuLmZpbmQobiA9PiBuICE9PSBsZWFmKVxyXG4gICAgICAgIGlmICghc2libGluZykge1xyXG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJJbnZhbGlkIHRyZWUsIGxlYWYgbm9kZSBoYXMgbm8gc2libGluZ1wiKVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgY29uc3QgZ3JhbmRQYXJlbnQgPSBwYXJlbnQucGFyZW50XHJcblxyXG4gICAgICAgIC8vIG5vIGdyYW5kcGFyZW50IC0gcGFyZW50IHdhcyByb290IC0gbWFrZSBzaWJsaW5nIHRoZSBuZXcgcm9vdFxyXG4gICAgICAgIGlmICghZ3JhbmRQYXJlbnQpIHtcclxuICAgICAgICAgICAgdGhpcy5yb290ID0gc2libGluZ1xyXG4gICAgICAgICAgICBzaWJsaW5nLnBhcmVudCA9IG51bGxcclxuICAgICAgICAgICAgcmV0dXJuXHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBjb25zdCBwYXJlbnRJZHggPSBncmFuZFBhcmVudC5jaGlsZHJlbi5pbmRleE9mKHBhcmVudClcclxuICAgICAgICBpZiAocGFyZW50SWR4ID09PSAtMSkge1xyXG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJJbnZhbGlkIHRyZWUsIGdyYW5kcGFyZW50IGRvZXMgbm90IGhhdmUgbGluayB0byBwYXJlbnRcIilcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGdyYW5kUGFyZW50LmNoaWxkcmVuW3BhcmVudElkeF0gPSBzaWJsaW5nXHJcbiAgICAgICAgc2libGluZy5wYXJlbnQgPSBncmFuZFBhcmVudFxyXG4gICAgICAgIHRoaXMudXBkYXRlQUFCQnMoZ3JhbmRQYXJlbnQpXHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBJdGVyYXRlcyBvdmVyIGFsbCBkYXRhIHRoYXQgb3ZlcmxhcHMgdGhlIEFBQkJcclxuICAgICAqIEBwYXJhbSBhYWJiIGFhYmJcclxuICAgICAqL1xyXG4gICAgcHVibGljICpxdWVyeShhYWJiOiBBQUJCKTogSXRlcmFibGU8VD4ge1xyXG4gICAgICAgIGNvbnN0IHN0YWNrOiBOb2RlPFQ+W10gPSBbXVxyXG4gICAgICAgIGlmICh0aGlzLnJvb3QgJiYgdGhpcy5yb290LmFhYmIub3ZlcmxhcHMoYWFiYikpIHtcclxuICAgICAgICAgICAgc3RhY2sucHVzaCh0aGlzLnJvb3QpXHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB3aGlsZSAoc3RhY2subGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICBjb25zdCBub2RlID0gYXJyYXkucG9wKHN0YWNrKVxyXG4gICAgICAgICAgICBzd2l0Y2ggKG5vZGUudHlwZSkge1xyXG4gICAgICAgICAgICAgICAgY2FzZSBOb2RlVHlwZS5JbnRlcm5hbDpcclxuICAgICAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IGNoaWxkIG9mIG5vZGUuY2hpbGRyZW4pIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNoaWxkLmFhYmIub3ZlcmxhcHMoYWFiYikpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YWNrLnB1c2goY2hpbGQpXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcblxyXG4gICAgICAgICAgICAgICAgY2FzZSBOb2RlVHlwZS5MZWFmOlxyXG4gICAgICAgICAgICAgICAgICAgIHlpZWxkIG5vZGUuZGF0YVxyXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgY2hvb3NlU2libGluZ0xlYWYobm9kZTogTm9kZTxUPiwgYWFiYjogQUFCQik6IE5vZGU8VD4ge1xyXG4gICAgICAgIC8vIGNob29zZSB0aGUgbGVhZiB0aGF0IHdvdWxkIGluY3JlYXNlIGxlYXN0IGluIGFyZWEgYnkgaW5jbHVkaW5nIHRoaXMgbm9kZVxyXG4gICAgICAgIHN3aXRjaCAobm9kZS50eXBlKSB7XHJcbiAgICAgICAgICAgIGNhc2UgTm9kZVR5cGUuSW50ZXJuYWw6XHJcbiAgICAgICAgICAgICAgICBjb25zdCBuID0gbm9kZS5jaGlsZHJlbi5yZWR1Y2UoKGEsIGIpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAvLyBjYWxjdWxhdGUgc3VyZmFjZSBhcmVhIGluY3JlYXNlIGZvciBub2RlIGFcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBkYSA9IGEuYWFiYi5hcmVhIC0gYS5hYWJiLnVuaW9uKGFhYmIpLmFyZWFcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBkYiA9IGIuYWFiYi5hcmVhIC0gYi5hYWJiLnVuaW9uKGFhYmIpLmFyZWFcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gZGEgPCBkYiA/IGEgOiBiXHJcbiAgICAgICAgICAgICAgICB9KVxyXG5cclxuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmNob29zZVNpYmxpbmdMZWFmKG4sIGFhYmIpXHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuXHJcbiAgICAgICAgICAgIGNhc2UgTm9kZVR5cGUuTGVhZjpcclxuICAgICAgICAgICAgICAgIC8vIHdlJ3ZlIHJlYWNoZWQgYSBsZWFmIC0gcmV0dXJuIGl0XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gbm9kZVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIHVwZGF0ZUFBQkJzKG5vZGU6IEludGVybmFsTm9kZTxUPiB8IG51bGwpIHtcclxuICAgICAgICB3aGlsZSAobm9kZSAhPSBudWxsKSB7XHJcbiAgICAgICAgICAgIG5vZGUuYWFiYiA9IG5vZGUuY2hpbGRyZW5bMF0uYWFiYi51bmlvbihub2RlLmNoaWxkcmVuWzFdLmFhYmIpXHJcbiAgICAgICAgICAgIG5vZGUgPSBub2RlLnBhcmVudFxyXG4gICAgICAgIH1cclxuICAgIH1cclxufVxyXG5cclxuLyoqXHJcbiAqIGNhbGN1bGF0ZSBtYW5oYXR0ZW4gZGlzdGFuY2UgYmV0d2VlbiBjb29yZGluYXRlc1xyXG4gKiBAcGFyYW0gYSBmaXJzdCBwb2ludFxyXG4gKiBAcGFyYW0gYiBzZWNvbmQgcG9pbnRcclxuICovXHJcbmV4cG9ydCBmdW5jdGlvbiBjYWxjTWFuaGF0dGVuRGlzdChhOiBQb2ludCwgYjogUG9pbnQpOiBudW1iZXIge1xyXG4gICAgcmV0dXJuIE1hdGguYWJzKGIueCAtIGEueCkgKyBNYXRoLmFicyhiLnkgLSBhLnkpXHJcbn1cclxuXHJcbi8qKlxyXG4gKiBsaW5lYXJseSBpbnRlcnBvbGF0ZSBiZXR3ZWVuIDIgcG9pbnRzXHJcbiAqIEBwYXJhbSBhIGZpcnN0IHBvaW50XHJcbiAqIEBwYXJhbSBiIHNlY29uZCBwb2ludFxyXG4gKiBAcGFyYW0gdCBudW1iZXIgYmV0d2VlbiAwIGFuZCAxXHJcbiAqL1xyXG5leHBvcnQgZnVuY3Rpb24gbGVycChhOiBQb2ludCwgYjogUG9pbnQsIHQ6IG51bWJlcik6IFBvaW50IHtcclxuICAgIGNvbnN0IHggPSBtYXRoLmxlcnAoYS54LCBiLngsIHQpXHJcbiAgICBjb25zdCB5ID0gbWF0aC5sZXJwKGEueSwgYi55LCB0KVxyXG4gICAgcmV0dXJuIG5ldyBQb2ludCh4LCB5KVxyXG59Il19