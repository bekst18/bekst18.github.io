/**
 * 1st attempt at a simple 2d geometry library
 */
import * as array from "../shared/array.js";
export class Point {
    constructor(x, y) {
        this.x = x;
        this.y = y;
    }
    equal(pt) {
        return this.x === pt.x && this.y === pt.y;
    }
    addScalar(x) {
        return new Point(this.x + x, this.y + x);
    }
    subScalar(x) {
        return new Point(this.x - x, this.y - x);
    }
    mulScalar(x) {
        return new Point(this.x * x, this.y * x);
    }
    divScalar(x) {
        return new Point(this.x / x, this.y / x);
    }
    addPoint(pt) {
        return new Point(this.x + pt.x, this.y + pt.y);
    }
    subPoint(pt) {
        return new Point(this.x - pt.x, this.y - pt.y);
    }
    mulPoint(pt) {
        return new Point(this.x * pt.x, this.y * pt.y);
    }
    divPoint(pt) {
        return new Point(this.x / pt.x, this.y / pt.y);
    }
    floor() {
        return new Point(Math.floor(this.x), Math.floor(this.y));
    }
    ciel() {
        return new Point(Math.ceil(this.x), Math.ceil(this.y));
    }
    round() {
        return new Point(Math.round(this.x), Math.round(this.y));
    }
    sign() {
        return new Point(Math.sign(this.x), Math.sign(this.y));
    }
    abs() {
        return new Point(Math.abs(this.x), Math.abs(this.y));
    }
    neg() {
        return new Point(-this.x, -this.y);
    }
    max() {
        return Math.max(this.x, this.y);
    }
    min() {
        return Math.min(this.x, this.y);
    }
    clone() {
        return new Point(this.x, this.y);
    }
    static inf() {
        return new Point(Infinity, Infinity);
    }
    static negInf() {
        return new Point(-Infinity, -Infinity);
    }
}
export class AABB {
    constructor(min, max) {
        this.min = min;
        this.max = max;
    }
    get width() {
        return this.max.x - this.min.x;
    }
    get height() {
        return this.max.y - this.min.y;
    }
    get area() {
        return this.width * this.height;
    }
    get center() {
        return new Point(this.min.x + this.width / 2, this.min.y + this.height / 2);
    }
    union(aabb) {
        const min = new Point(Math.min(this.min.x, aabb.min.x), Math.min(this.min.y, aabb.min.y));
        const max = new Point(Math.max(this.max.x, aabb.max.x), Math.max(this.max.y, aabb.max.y));
        const r = new AABB(min, max);
        return r;
    }
    intersection(aabb) {
        const min = new Point(Math.max(this.min.x, aabb.min.x), Math.max(this.min.y, aabb.min.y));
        const max = new Point(Math.min(this.max.x, aabb.max.x), Math.min(this.max.y, aabb.max.y));
        const r = new AABB(min, max);
        return r;
    }
    overlaps(aabb) {
        return (this.max.x >= aabb.min.x &&
            this.max.y >= aabb.min.y &&
            this.min.x <= aabb.max.x &&
            this.min.y <= aabb.max.y);
    }
    contains(pt) {
        return (pt.x >= this.min.x &&
            pt.y >= this.min.y &&
            pt.x < this.max.x &&
            pt.y < this.max.y);
    }
    translate(offset) {
        return new AABB(this.min.addPoint(offset), this.max.addPoint(offset));
    }
    scale(s) {
        return new AABB(this.min.mulScalar(s), this.max.mulScalar(s));
    }
    buffer(padding) {
        const min = new Point(this.min.x - padding, this.min.y - padding);
        const max = new Point(this.max.x + padding, this.max.y + padding);
        return new AABB(min, max);
    }
    shrink(amount) {
        return this.buffer(-amount);
    }
    clone() {
        return new AABB(this.min.clone(), this.max.clone());
    }
    static empty() {
        return new AABB(Point.inf(), Point.negInf());
    }
    static inf() {
        return new AABB(Point.negInf(), Point.inf());
    }
}
var NodeType;
(function (NodeType) {
    NodeType[NodeType["Internal"] = 0] = "Internal";
    NodeType[NodeType["Leaf"] = 1] = "Leaf";
})(NodeType || (NodeType = {}));
export class AABBTree {
    constructor() {
        this.root = null;
    }
    /**
     * insert a new node into the tree
     * returns a reference to the leaf node that can later be used for removal
     * @param aabb aabb of data
     * @param data data to insert
     */
    insert(aabb, data) {
        // create the leaf node that will be inserted
        const newLeaf = {
            type: NodeType.Leaf,
            aabb: aabb.clone(),
            parent: null,
            data
        };
        // no root, create a leaf
        if (!this.root) {
            this.root = newLeaf;
            return newLeaf;
        }
        // otherwise, choose a leaf to become the sibling of the new leaf
        const sibling = this.chooseSiblingLeaf(this.root, aabb);
        // create a new parent node
        const newParent = {
            type: NodeType.Internal,
            parent: sibling.parent,
            aabb: aabb.union(sibling.aabb),
            children: [newLeaf, sibling]
        };
        sibling.parent = newParent;
        newLeaf.parent = newParent;
        // replace link in old parent with newly created parent
        // or if there was no parent, leaf was root, make new parent the new root
        let parent = newParent.parent;
        if (parent) {
            const idx = parent.children.indexOf(sibling);
            if (idx === -1) {
                throw new Error("Could not find link to chosen sibling");
            }
            parent.children[idx] = newParent;
        }
        else {
            this.root = newParent;
        }
        this.updateAABBs(parent);
        return newLeaf;
    }
    /**
     * removes specified leaf node and its data from the tree
     * @param leaf leaf
     */
    delete(leaf) {
        // special case - leaf is root
        if (this.root === leaf) {
            this.root = null;
            return;
        }
        const parent = leaf.parent;
        if (!parent) {
            throw new Error("Invalid tree, non-root leaf has no parent");
        }
        // otherwise,
        // replace leaf.parent with leaf's sibling
        // recalculate aabbs
        const sibling = parent.children.find(n => n !== leaf);
        if (!sibling) {
            throw new Error("Invalid tree, leaf node has no sibling");
        }
        const grandParent = parent.parent;
        // no grandparent - parent was root - make sibling the new root
        if (!grandParent) {
            this.root = sibling;
            sibling.parent = null;
            return;
        }
        const parentIdx = grandParent.children.indexOf(parent);
        if (parentIdx === -1) {
            throw new Error("Invalid tree, grandparent does not have link to parent");
        }
        grandParent.children[parentIdx] = sibling;
        sibling.parent = grandParent;
        this.updateAABBs(grandParent);
    }
    /**
     * Iterates over all data that overlaps the AABB
     * @param aabb aabb
     */
    *query(aabb) {
        const stack = [];
        if (this.root && this.root.aabb.overlaps(aabb)) {
            stack.push(this.root);
        }
        while (stack.length > 0) {
            const node = array.pop(stack);
            switch (node.type) {
                case NodeType.Internal:
                    for (const child of node.children) {
                        if (child.aabb.overlaps(aabb)) {
                            stack.push(child);
                        }
                    }
                    break;
                case NodeType.Leaf:
                    yield node.data;
                    break;
            }
        }
    }
    chooseSiblingLeaf(node, aabb) {
        // choose the leaf that would increase least in area by including this node
        switch (node.type) {
            case NodeType.Internal:
                const n = node.children.reduce((a, b) => {
                    // calculate surface area increase for node a
                    const da = a.aabb.area - a.aabb.union(aabb).area;
                    const db = b.aabb.area - b.aabb.union(aabb).area;
                    return da < db ? a : b;
                });
                return this.chooseSiblingLeaf(n, aabb);
                break;
            case NodeType.Leaf:
                // we've reached a leaf - return it
                return node;
        }
    }
    updateAABBs(node) {
        while (node != null) {
            node.aabb = node.children[0].aabb.union(node.children[1].aabb);
            node = node.parent;
        }
    }
}
/**
 * calculate manhatten distance between coordinates
 * @param a first point
 * @param b second point
 */
export function calcManhattenDist(a, b) {
    return Math.abs(b.x - a.x) + Math.abs(b.y - a.y);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2VvMmQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJnZW8yZC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7R0FFRztBQUNILE9BQU8sS0FBSyxLQUFLLE1BQU0sb0JBQW9CLENBQUE7QUFPM0MsTUFBTSxPQUFPLEtBQUs7SUFDZCxZQUFtQixDQUFTLEVBQVMsQ0FBUztRQUEzQixNQUFDLEdBQUQsQ0FBQyxDQUFRO1FBQVMsTUFBQyxHQUFELENBQUMsQ0FBUTtJQUFJLENBQUM7SUFFbkQsS0FBSyxDQUFDLEVBQVM7UUFDWCxPQUFPLElBQUksQ0FBQyxDQUFDLEtBQUssRUFBRSxDQUFDLENBQUMsSUFBSSxJQUFJLENBQUMsQ0FBQyxLQUFLLEVBQUUsQ0FBQyxDQUFDLENBQUE7SUFDN0MsQ0FBQztJQUVELFNBQVMsQ0FBQyxDQUFTO1FBQ2YsT0FBTyxJQUFJLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQyxHQUFHLENBQUMsRUFBRSxJQUFJLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFBO0lBQzVDLENBQUM7SUFFRCxTQUFTLENBQUMsQ0FBUztRQUNmLE9BQU8sSUFBSSxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUMsR0FBRyxDQUFDLEVBQUUsSUFBSSxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQTtJQUM1QyxDQUFDO0lBRUQsU0FBUyxDQUFDLENBQVM7UUFDZixPQUFPLElBQUksS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDLEdBQUcsQ0FBQyxFQUFFLElBQUksQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUE7SUFDNUMsQ0FBQztJQUVELFNBQVMsQ0FBQyxDQUFTO1FBQ2YsT0FBTyxJQUFJLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQyxHQUFHLENBQUMsRUFBRSxJQUFJLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFBO0lBQzVDLENBQUM7SUFFRCxRQUFRLENBQUMsRUFBUztRQUNkLE9BQU8sSUFBSSxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFBO0lBQ2xELENBQUM7SUFFRCxRQUFRLENBQUMsRUFBUztRQUNkLE9BQU8sSUFBSSxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFBO0lBQ2xELENBQUM7SUFFRCxRQUFRLENBQUMsRUFBUztRQUNkLE9BQU8sSUFBSSxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFBO0lBQ2xELENBQUM7SUFFRCxRQUFRLENBQUMsRUFBUztRQUNkLE9BQU8sSUFBSSxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFBO0lBQ2xELENBQUM7SUFFRCxLQUFLO1FBQ0QsT0FBTyxJQUFJLEtBQUssQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFBO0lBQzVELENBQUM7SUFFRCxJQUFJO1FBQ0EsT0FBTyxJQUFJLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFBO0lBQzFELENBQUM7SUFFRCxLQUFLO1FBQ0QsT0FBTyxJQUFJLEtBQUssQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFBO0lBQzVELENBQUM7SUFFRCxJQUFJO1FBQ0EsT0FBTyxJQUFJLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFBO0lBQzFELENBQUM7SUFFRCxHQUFHO1FBQ0MsT0FBTyxJQUFJLEtBQUssQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFBO0lBQ3hELENBQUM7SUFFRCxHQUFHO1FBQ0MsT0FBTyxJQUFJLEtBQUssQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUE7SUFDdEMsQ0FBQztJQUVELEdBQUc7UUFDQyxPQUFPLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUMsRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUE7SUFDbkMsQ0FBQztJQUVELEdBQUc7UUFDQyxPQUFPLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUMsRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUE7SUFDbkMsQ0FBQztJQUVELEtBQUs7UUFDRCxPQUFPLElBQUksS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDLEVBQUUsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFBO0lBQ3BDLENBQUM7SUFFRCxNQUFNLENBQUMsR0FBRztRQUNOLE9BQU8sSUFBSSxLQUFLLENBQUMsUUFBUSxFQUFFLFFBQVEsQ0FBQyxDQUFBO0lBQ3hDLENBQUM7SUFFRCxNQUFNLENBQUMsTUFBTTtRQUNULE9BQU8sSUFBSSxLQUFLLENBQUMsQ0FBQyxRQUFRLEVBQUUsQ0FBQyxRQUFRLENBQUMsQ0FBQTtJQUMxQyxDQUFDO0NBQ0o7QUFFRCxNQUFNLE9BQU8s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R0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQyxJQUFJLENBQUE7b0JBQ2hELE9BQU8sRUFBRSxHQUFHLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUE7Z0JBQzFCLENBQUMsQ0FBQyxDQUFBO2dCQUVGLE9BQU8sSUFBSSxDQUFDLGlCQUFpQixDQUFDLENBQUMsRUFBRSxJQUFJLENBQUMsQ0FBQTtnQkFDdEMsTUFBTTtZQUVWLEtBQUssUUFBUSxDQUFDLElBQUk7Z0JBQ2QsbUNBQW1DO2dCQUNuQyxPQUFPLElBQUksQ0FBQTtTQUNsQjtJQUNMLENBQUM7SUFFTyxXQUFXLENBQUMsSUFBNEI7UUFDNUMsT0FBTyxJQUFJLElBQUksSUFBSSxFQUFFO1lBQ2pCLElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUE7WUFDOUQsSUFBSSxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUE7U0FDckI7SUFDTCxDQUFDO0NBQ0o7QUFFRDs7OztHQUlHO0FBQ0gsTUFBTSxVQUFVLGlCQUFpQixDQUFDLENBQVEsRUFBRSxDQUFRO0lBQ2hELE9BQU8sSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFBO0FBQ3BELENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcclxuICogMXN0IGF0dGVtcHQgYXQgYSBzaW1wbGUgMmQgZ2VvbWV0cnkgbGlicmFyeVxyXG4gKi9cclxuaW1wb3J0ICogYXMgYXJyYXkgZnJvbSBcIi4uL3NoYXJlZC9hcnJheS5qc1wiXHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIFBvaW50T3B0aW9ucyB7XHJcbiAgICB4OiBudW1iZXIsXHJcbiAgICB5OiBudW1iZXJcclxufVxyXG5cclxuZXhwb3J0IGNsYXNzIFBvaW50IHtcclxuICAgIGNvbnN0cnVjdG9yKHB1YmxpYyB4OiBudW1iZXIsIHB1YmxpYyB5OiBudW1iZXIpIHsgfVxyXG5cclxuICAgIGVxdWFsKHB0OiBQb2ludCk6IGJvb2xlYW4ge1xyXG4gICAgICAgIHJldHVybiB0aGlzLnggPT09IHB0LnggJiYgdGhpcy55ID09PSBwdC55XHJcbiAgICB9XHJcblxyXG4gICAgYWRkU2NhbGFyKHg6IG51bWJlcik6IFBvaW50IHtcclxuICAgICAgICByZXR1cm4gbmV3IFBvaW50KHRoaXMueCArIHgsIHRoaXMueSArIHgpXHJcbiAgICB9XHJcblxyXG4gICAgc3ViU2NhbGFyKHg6IG51bWJlcik6IFBvaW50IHtcclxuICAgICAgICByZXR1cm4gbmV3IFBvaW50KHRoaXMueCAtIHgsIHRoaXMueSAtIHgpXHJcbiAgICB9XHJcblxyXG4gICAgbXVsU2NhbGFyKHg6IG51bWJlcik6IFBvaW50IHtcclxuICAgICAgICByZXR1cm4gbmV3IFBvaW50KHRoaXMueCAqIHgsIHRoaXMueSAqIHgpXHJcbiAgICB9XHJcblxyXG4gICAgZGl2U2NhbGFyKHg6IG51bWJlcik6IFBvaW50IHtcclxuICAgICAgICByZXR1cm4gbmV3IFBvaW50KHRoaXMueCAvIHgsIHRoaXMueSAvIHgpXHJcbiAgICB9XHJcblxyXG4gICAgYWRkUG9pbnQocHQ6IFBvaW50KTogUG9pbnQge1xyXG4gICAgICAgIHJldHVybiBuZXcgUG9pbnQodGhpcy54ICsgcHQueCwgdGhpcy55ICsgcHQueSlcclxuICAgIH1cclxuXHJcbiAgICBzdWJQb2ludChwdDogUG9pbnQpOiBQb2ludCB7XHJcbiAgICAgICAgcmV0dXJuIG5ldyBQb2ludCh0aGlzLnggLSBwdC54LCB0aGlzLnkgLSBwdC55KVxyXG4gICAgfVxyXG5cclxuICAgIG11bFBvaW50KHB0OiBQb2ludCk6IFBvaW50IHtcclxuICAgICAgICByZXR1cm4gbmV3IFBvaW50KHRoaXMueCAqIHB0LngsIHRoaXMueSAqIHB0LnkpXHJcbiAgICB9XHJcblxyXG4gICAgZGl2UG9pbnQocHQ6IFBvaW50KTogUG9pbnQge1xyXG4gICAgICAgIHJldHVybiBuZXcgUG9pbnQodGhpcy54IC8gcHQueCwgdGhpcy55IC8gcHQueSlcclxuICAgIH1cclxuXHJcbiAgICBmbG9vcigpOiBQb2ludCB7XHJcbiAgICAgICAgcmV0dXJuIG5ldyBQb2ludChNYXRoLmZsb29yKHRoaXMueCksIE1hdGguZmxvb3IodGhpcy55KSlcclxuICAgIH1cclxuXHJcbiAgICBjaWVsKCk6IFBvaW50IHtcclxuICAgICAgICByZXR1cm4gbmV3IFBvaW50KE1hdGguY2VpbCh0aGlzLngpLCBNYXRoLmNlaWwodGhpcy55KSlcclxuICAgIH1cclxuXHJcbiAgICByb3VuZCgpOiBQb2ludCB7XHJcbiAgICAgICAgcmV0dXJuIG5ldyBQb2ludChNYXRoLnJvdW5kKHRoaXMueCksIE1hdGgucm91bmQodGhpcy55KSlcclxuICAgIH1cclxuXHJcbiAgICBzaWduKCk6IFBvaW50IHtcclxuICAgICAgICByZXR1cm4gbmV3IFBvaW50KE1hdGguc2lnbih0aGlzLngpLCBNYXRoLnNpZ24odGhpcy55KSlcclxuICAgIH1cclxuXHJcbiAgICBhYnMoKTogUG9pbnQge1xyXG4gICAgICAgIHJldHVybiBuZXcgUG9pbnQoTWF0aC5hYnModGhpcy54KSwgTWF0aC5hYnModGhpcy55KSlcclxuICAgIH1cclxuXHJcbiAgICBuZWcoKTogUG9pbnQge1xyXG4gICAgICAgIHJldHVybiBuZXcgUG9pbnQoLXRoaXMueCwgLXRoaXMueSlcclxuICAgIH1cclxuXHJcbiAgICBtYXgoKTogbnVtYmVyIHtcclxuICAgICAgICByZXR1cm4gTWF0aC5tYXgodGhpcy54LCB0aGlzLnkpXHJcbiAgICB9XHJcblxyXG4gICAgbWluKCk6IG51bWJlciB7XHJcbiAgICAgICAgcmV0dXJuIE1hdGgubWluKHRoaXMueCwgdGhpcy55KVxyXG4gICAgfVxyXG5cclxuICAgIGNsb25lKCk6IFBvaW50IHtcclxuICAgICAgICByZXR1cm4gbmV3IFBvaW50KHRoaXMueCwgdGhpcy55KVxyXG4gICAgfVxyXG5cclxuICAgIHN0YXRpYyBpbmYoKSB7XHJcbiAgICAgICAgcmV0dXJuIG5ldyBQb2ludChJbmZpbml0eSwgSW5maW5pdHkpXHJcbiAgICB9XHJcblxyXG4gICAgc3RhdGljIG5lZ0luZigpIHtcclxuICAgICAgICByZXR1cm4gbmV3IFBvaW50KC1JbmZpbml0eSwgLUluZmluaXR5KVxyXG4gICAgfVxyXG59XHJcblxyXG5leHBvcnQgY2xhc3MgQUFCQiB7XHJcbiAgICBjb25zdHJ1Y3RvcihyZWFkb25seSBtaW46IFBvaW50LCByZWFkb25seSBtYXg6IFBvaW50KSB7IH1cclxuXHJcbiAgICBnZXQgd2lkdGgoKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMubWF4LnggLSB0aGlzLm1pbi54XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0IGhlaWdodCgpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5tYXgueSAtIHRoaXMubWluLnlcclxuICAgIH1cclxuXHJcbiAgICBnZXQgYXJlYSgpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy53aWR0aCAqIHRoaXMuaGVpZ2h0XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0IGNlbnRlcigpOiBQb2ludCB7XHJcbiAgICAgICAgcmV0dXJuIG5ldyBQb2ludCh0aGlzLm1pbi54ICsgdGhpcy53aWR0aCAvIDIsIHRoaXMubWluLnkgKyB0aGlzLmhlaWdodCAvIDIpXHJcbiAgICB9XHJcblxyXG4gICAgdW5pb24oYWFiYjogQUFCQik6IEFBQkIge1xyXG4gICAgICAgIGNvbnN0IG1pbiA9IG5ldyBQb2ludChNYXRoLm1pbih0aGlzLm1pbi54LCBhYWJiLm1pbi54KSwgTWF0aC5taW4odGhpcy5taW4ueSwgYWFiYi5taW4ueSkpXHJcbiAgICAgICAgY29uc3QgbWF4ID0gbmV3IFBvaW50KE1hdGgubWF4KHRoaXMubWF4LngsIGFhYmIubWF4LngpLCBNYXRoLm1heCh0aGlzLm1heC55LCBhYWJiLm1heC55KSlcclxuICAgICAgICBjb25zdCByID0gbmV3IEFBQkIobWluLCBtYXgpXHJcbiAgICAgICAgcmV0dXJuIHJcclxuICAgIH1cclxuXHJcbiAgICBpbnRlcnNlY3Rpb24oYWFiYjogQUFCQik6IEFBQkIge1xyXG4gICAgICAgIGNvbnN0IG1pbiA9IG5ldyBQb2ludChNYXRoLm1heCh0aGlzLm1pbi54LCBhYWJiLm1pbi54KSwgTWF0aC5tYXgodGhpcy5taW4ueSwgYWFiYi5taW4ueSkpXHJcbiAgICAgICAgY29uc3QgbWF4ID0gbmV3IFBvaW50KE1hdGgubWluKHRoaXMubWF4LngsIGFhYmIubWF4LngpLCBNYXRoLm1pbih0aGlzLm1heC55LCBhYWJiLm1heC55KSlcclxuICAgICAgICBjb25zdCByID0gbmV3IEFBQkIobWluLCBtYXgpXHJcbiAgICAgICAgcmV0dXJuIHJcclxuICAgIH1cclxuXHJcbiAgICBvdmVybGFwcyhhYWJiOiBBQUJCKTogYm9vbGVhbiB7XHJcbiAgICAgICAgcmV0dXJuIChcclxuICAgICAgICAgICAgdGhpcy5tYXgueCA+PSBhYWJiLm1pbi54ICYmXHJcbiAgICAgICAgICAgIHRoaXMubWF4LnkgPj0gYWFiYi5taW4ueSAmJlxyXG4gICAgICAgICAgICB0aGlzLm1pbi54IDw9IGFhYmIubWF4LnggJiZcclxuICAgICAgICAgICAgdGhpcy5taW4ueSA8PSBhYWJiLm1heC55XHJcbiAgICAgICAgKVxyXG4gICAgfVxyXG5cclxuICAgIGNvbnRhaW5zKHB0OiBQb2ludCk6IGJvb2xlYW4ge1xyXG4gICAgICAgIHJldHVybiAoXHJcbiAgICAgICAgICAgIHB0LnggPj0gdGhpcy5taW4ueCAmJlxyXG4gICAgICAgICAgICBwdC55ID49IHRoaXMubWluLnkgJiZcclxuICAgICAgICAgICAgcHQueCA8IHRoaXMubWF4LnggJiZcclxuICAgICAgICAgICAgcHQueSA8IHRoaXMubWF4LnlcclxuICAgICAgICApXHJcbiAgICB9XHJcblxyXG4gICAgdHJhbnNsYXRlKG9mZnNldDogUG9pbnQpOiBBQUJCIHtcclxuICAgICAgICByZXR1cm4gbmV3IEFBQkIodGhpcy5taW4uYWRkUG9pbnQob2Zmc2V0KSwgdGhpcy5tYXguYWRkUG9pbnQob2Zmc2V0KSlcclxuICAgIH1cclxuXHJcbiAgICBzY2FsZShzOiBudW1iZXIpOiBBQUJCIHtcclxuICAgICAgICByZXR1cm4gbmV3IEFBQkIodGhpcy5taW4ubXVsU2NhbGFyKHMpLCB0aGlzLm1heC5tdWxTY2FsYXIocykpXHJcbiAgICB9XHJcblxyXG4gICAgYnVmZmVyKHBhZGRpbmc6IG51bWJlcik6IEFBQkIge1xyXG4gICAgICAgIGNvbnN0IG1pbiA9IG5ldyBQb2ludCh0aGlzLm1pbi54IC0gcGFkZGluZywgdGhpcy5taW4ueSAtIHBhZGRpbmcpXHJcbiAgICAgICAgY29uc3QgbWF4ID0gbmV3IFBvaW50KHRoaXMubWF4LnggKyBwYWRkaW5nLCB0aGlzLm1heC55ICsgcGFkZGluZylcclxuICAgICAgICByZXR1cm4gbmV3IEFBQkIobWluLCBtYXgpXHJcbiAgICB9XHJcblxyXG4gICAgc2hyaW5rKGFtb3VudDogbnVtYmVyKTogQUFCQiB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuYnVmZmVyKC1hbW91bnQpXHJcbiAgICB9XHJcblxyXG4gICAgY2xvbmUoKTogQUFCQiB7XHJcbiAgICAgICAgcmV0dXJuIG5ldyBBQUJCKHRoaXMubWluLmNsb25lKCksIHRoaXMubWF4LmNsb25lKCkpXHJcbiAgICB9XHJcblxyXG4gICAgc3RhdGljIGVtcHR5KCk6IEFBQkIge1xyXG4gICAgICAgIHJldHVybiBuZXcgQUFCQihQb2ludC5pbmYoKSwgUG9pbnQubmVnSW5mKCkpXHJcbiAgICB9XHJcblxyXG4gICAgc3RhdGljIGluZigpOiBBQUJCIHtcclxuICAgICAgICByZXR1cm4gbmV3IEFBQkIoUG9pbnQubmVnSW5mKCksIFBvaW50LmluZigpKVxyXG4gICAgfVxyXG59XHJcblxyXG5lbnVtIE5vZGVUeXBlIHtcclxuICAgIEludGVybmFsLFxyXG4gICAgTGVhZlxyXG59XHJcblxyXG5pbnRlcmZhY2UgSW50ZXJuYWxOb2RlPFQ+IHtcclxuICAgIHR5cGU6IE5vZGVUeXBlLkludGVybmFsXHJcbiAgICBhYWJiOiBBQUJCXHJcbiAgICBwYXJlbnQ6IEludGVybmFsTm9kZTxUPiB8IG51bGxcclxuICAgIGNoaWxkcmVuOiBOb2RlPFQ+W11cclxufVxyXG5cclxuaW50ZXJmYWNlIExlYWZOb2RlPFQ+IHtcclxuICAgIHR5cGU6IE5vZGVUeXBlLkxlYWZcclxuICAgIGFhYmI6IEFBQkJcclxuICAgIHBhcmVudDogSW50ZXJuYWxOb2RlPFQ+IHwgbnVsbFxyXG4gICAgZGF0YTogVFxyXG59XHJcblxyXG50eXBlIE5vZGU8VD4gPSBJbnRlcm5hbE5vZGU8VD4gfCBMZWFmTm9kZTxUPlxyXG5cclxuZXhwb3J0IGNsYXNzIEFBQkJUcmVlPFQ+IHtcclxuICAgIHJvb3Q6IE5vZGU8VD4gfCBudWxsID0gbnVsbFxyXG5cclxuICAgIGNvbnN0cnVjdG9yKCkgeyB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBpbnNlcnQgYSBuZXcgbm9kZSBpbnRvIHRoZSB0cmVlXHJcbiAgICAgKiByZXR1cm5zIGEgcmVmZXJlbmNlIHRvIHRoZSBsZWFmIG5vZGUgdGhhdCBjYW4gbGF0ZXIgYmUgdXNlZCBmb3IgcmVtb3ZhbFxyXG4gICAgICogQHBhcmFtIGFhYmIgYWFiYiBvZiBkYXRhXHJcbiAgICAgKiBAcGFyYW0gZGF0YSBkYXRhIHRvIGluc2VydFxyXG4gICAgICovXHJcbiAgICBpbnNlcnQoYWFiYjogQUFCQiwgZGF0YTogVCk6IExlYWZOb2RlPFQ+IHtcclxuICAgICAgICAvLyBjcmVhdGUgdGhlIGxlYWYgbm9kZSB0aGF0IHdpbGwgYmUgaW5zZXJ0ZWRcclxuICAgICAgICBjb25zdCBuZXdMZWFmOiBMZWFmTm9kZTxUPiA9IHtcclxuICAgICAgICAgICAgdHlwZTogTm9kZVR5cGUuTGVhZixcclxuICAgICAgICAgICAgYWFiYjogYWFiYi5jbG9uZSgpLFxyXG4gICAgICAgICAgICBwYXJlbnQ6IG51bGwsXHJcbiAgICAgICAgICAgIGRhdGFcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8vIG5vIHJvb3QsIGNyZWF0ZSBhIGxlYWZcclxuICAgICAgICBpZiAoIXRoaXMucm9vdCkge1xyXG4gICAgICAgICAgICB0aGlzLnJvb3QgPSBuZXdMZWFmXHJcbiAgICAgICAgICAgIHJldHVybiBuZXdMZWFmXHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAvLyBvdGhlcndpc2UsIGNob29zZSBhIGxlYWYgdG8gYmVjb21lIHRoZSBzaWJsaW5nIG9mIHRoZSBuZXcgbGVhZlxyXG4gICAgICAgIGNvbnN0IHNpYmxpbmcgPSB0aGlzLmNob29zZVNpYmxpbmdMZWFmKHRoaXMucm9vdCwgYWFiYilcclxuXHJcbiAgICAgICAgLy8gY3JlYXRlIGEgbmV3IHBhcmVudCBub2RlXHJcbiAgICAgICAgY29uc3QgbmV3UGFyZW50OiBJbnRlcm5hbE5vZGU8VD4gPSB7XHJcbiAgICAgICAgICAgIHR5cGU6IE5vZGVUeXBlLkludGVybmFsLFxyXG4gICAgICAgICAgICBwYXJlbnQ6IHNpYmxpbmcucGFyZW50LFxyXG4gICAgICAgICAgICBhYWJiOiBhYWJiLnVuaW9uKHNpYmxpbmcuYWFiYiksXHJcbiAgICAgICAgICAgIGNoaWxkcmVuOiBbbmV3TGVhZiwgc2libGluZ11cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHNpYmxpbmcucGFyZW50ID0gbmV3UGFyZW50XHJcbiAgICAgICAgbmV3TGVhZi5wYXJlbnQgPSBuZXdQYXJlbnRcclxuXHJcbiAgICAgICAgLy8gcmVwbGFjZSBsaW5rIGluIG9sZCBwYXJlbnQgd2l0aCBuZXdseSBjcmVhdGVkIHBhcmVudFxyXG4gICAgICAgIC8vIG9yIGlmIHRoZXJlIHdhcyBubyBwYXJlbnQsIGxlYWYgd2FzIHJvb3QsIG1ha2UgbmV3IHBhcmVudCB0aGUgbmV3IHJvb3RcclxuICAgICAgICBsZXQgcGFyZW50ID0gbmV3UGFyZW50LnBhcmVudFxyXG4gICAgICAgIGlmIChwYXJlbnQpIHtcclxuICAgICAgICAgICAgY29uc3QgaWR4ID0gcGFyZW50LmNoaWxkcmVuLmluZGV4T2Yoc2libGluZylcclxuICAgICAgICAgICAgaWYgKGlkeCA9PT0gLTEpIHtcclxuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcIkNvdWxkIG5vdCBmaW5kIGxpbmsgdG8gY2hvc2VuIHNpYmxpbmdcIilcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgcGFyZW50LmNoaWxkcmVuW2lkeF0gPSBuZXdQYXJlbnRcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICB0aGlzLnJvb3QgPSBuZXdQYXJlbnRcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHRoaXMudXBkYXRlQUFCQnMocGFyZW50KVxyXG4gICAgICAgIHJldHVybiBuZXdMZWFmXHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiByZW1vdmVzIHNwZWNpZmllZCBsZWFmIG5vZGUgYW5kIGl0cyBkYXRhIGZyb20gdGhlIHRyZWVcclxuICAgICAqIEBwYXJhbSBsZWFmIGxlYWYgXHJcbiAgICAgKi9cclxuICAgIGRlbGV0ZShsZWFmOiBMZWFmTm9kZTxUPikge1xyXG4gICAgICAgIC8vIHNwZWNpYWwgY2FzZSAtIGxlYWYgaXMgcm9vdFxyXG4gICAgICAgIGlmICh0aGlzLnJvb3QgPT09IGxlYWYpIHtcclxuICAgICAgICAgICAgdGhpcy5yb290ID0gbnVsbFxyXG4gICAgICAgICAgICByZXR1cm5cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGNvbnN0IHBhcmVudCA9IGxlYWYucGFyZW50XHJcbiAgICAgICAgaWYgKCFwYXJlbnQpIHtcclxuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiSW52YWxpZCB0cmVlLCBub24tcm9vdCBsZWFmIGhhcyBubyBwYXJlbnRcIilcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8vIG90aGVyd2lzZSxcclxuICAgICAgICAvLyByZXBsYWNlIGxlYWYucGFyZW50IHdpdGggbGVhZidzIHNpYmxpbmdcclxuICAgICAgICAvLyByZWNhbGN1bGF0ZSBhYWJic1xyXG4gICAgICAgIGNvbnN0IHNpYmxpbmcgPSBwYXJlbnQuY2hpbGRyZW4uZmluZChuID0+IG4gIT09IGxlYWYpXHJcbiAgICAgICAgaWYgKCFzaWJsaW5nKSB7XHJcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcIkludmFsaWQgdHJlZSwgbGVhZiBub2RlIGhhcyBubyBzaWJsaW5nXCIpXHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBjb25zdCBncmFuZFBhcmVudCA9IHBhcmVudC5wYXJlbnRcclxuXHJcbiAgICAgICAgLy8gbm8gZ3JhbmRwYXJlbnQgLSBwYXJlbnQgd2FzIHJvb3QgLSBtYWtlIHNpYmxpbmcgdGhlIG5ldyByb290XHJcbiAgICAgICAgaWYgKCFncmFuZFBhcmVudCkge1xyXG4gICAgICAgICAgICB0aGlzLnJvb3QgPSBzaWJsaW5nXHJcbiAgICAgICAgICAgIHNpYmxpbmcucGFyZW50ID0gbnVsbFxyXG4gICAgICAgICAgICByZXR1cm5cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGNvbnN0IHBhcmVudElkeCA9IGdyYW5kUGFyZW50LmNoaWxkcmVuLmluZGV4T2YocGFyZW50KVxyXG4gICAgICAgIGlmIChwYXJlbnRJZHggPT09IC0xKSB7XHJcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcIkludmFsaWQgdHJlZSwgZ3JhbmRwYXJlbnQgZG9lcyBub3QgaGF2ZSBsaW5rIHRvIHBhcmVudFwiKVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgZ3JhbmRQYXJlbnQuY2hpbGRyZW5bcGFyZW50SWR4XSA9IHNpYmxpbmdcclxuICAgICAgICBzaWJsaW5nLnBhcmVudCA9IGdyYW5kUGFyZW50XHJcbiAgICAgICAgdGhpcy51cGRhdGVBQUJCcyhncmFuZFBhcmVudClcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIEl0ZXJhdGVzIG92ZXIgYWxsIGRhdGEgdGhhdCBvdmVybGFwcyB0aGUgQUFCQlxyXG4gICAgICogQHBhcmFtIGFhYmIgYWFiYlxyXG4gICAgICovXHJcbiAgICBwdWJsaWMgKnF1ZXJ5KGFhYmI6IEFBQkIpOiBJdGVyYWJsZTxUPiB7XHJcbiAgICAgICAgY29uc3Qgc3RhY2s6IE5vZGU8VD5bXSA9IFtdXHJcbiAgICAgICAgaWYgKHRoaXMucm9vdCAmJiB0aGlzLnJvb3QuYWFiYi5vdmVybGFwcyhhYWJiKSkge1xyXG4gICAgICAgICAgICBzdGFjay5wdXNoKHRoaXMucm9vdClcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHdoaWxlIChzdGFjay5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IG5vZGUgPSBhcnJheS5wb3Aoc3RhY2spXHJcbiAgICAgICAgICAgIHN3aXRjaCAobm9kZS50eXBlKSB7XHJcbiAgICAgICAgICAgICAgICBjYXNlIE5vZGVUeXBlLkludGVybmFsOlxyXG4gICAgICAgICAgICAgICAgICAgIGZvciAoY29uc3QgY2hpbGQgb2Ygbm9kZS5jaGlsZHJlbikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoY2hpbGQuYWFiYi5vdmVybGFwcyhhYWJiKSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhY2sucHVzaChjaGlsZClcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuXHJcbiAgICAgICAgICAgICAgICBjYXNlIE5vZGVUeXBlLkxlYWY6XHJcbiAgICAgICAgICAgICAgICAgICAgeWllbGQgbm9kZS5kYXRhXHJcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBjaG9vc2VTaWJsaW5nTGVhZihub2RlOiBOb2RlPFQ+LCBhYWJiOiBBQUJCKTogTm9kZTxUPiB7XHJcbiAgICAgICAgLy8gY2hvb3NlIHRoZSBsZWFmIHRoYXQgd291bGQgaW5jcmVhc2UgbGVhc3QgaW4gYXJlYSBieSBpbmNsdWRpbmcgdGhpcyBub2RlXHJcbiAgICAgICAgc3dpdGNoIChub2RlLnR5cGUpIHtcclxuICAgICAgICAgICAgY2FzZSBOb2RlVHlwZS5JbnRlcm5hbDpcclxuICAgICAgICAgICAgICAgIGNvbnN0IG4gPSBub2RlLmNoaWxkcmVuLnJlZHVjZSgoYSwgYikgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIC8vIGNhbGN1bGF0ZSBzdXJmYWNlIGFyZWEgaW5jcmVhc2UgZm9yIG5vZGUgYVxyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGRhID0gYS5hYWJiLmFyZWEgLSBhLmFhYmIudW5pb24oYWFiYikuYXJlYVxyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGRiID0gYi5hYWJiLmFyZWEgLSBiLmFhYmIudW5pb24oYWFiYikuYXJlYVxyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBkYSA8IGRiID8gYSA6IGJcclxuICAgICAgICAgICAgICAgIH0pXHJcblxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuY2hvb3NlU2libGluZ0xlYWYobiwgYWFiYilcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG5cclxuICAgICAgICAgICAgY2FzZSBOb2RlVHlwZS5MZWFmOlxyXG4gICAgICAgICAgICAgICAgLy8gd2UndmUgcmVhY2hlZCBhIGxlYWYgLSByZXR1cm4gaXRcclxuICAgICAgICAgICAgICAgIHJldHVybiBub2RlXHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgdXBkYXRlQUFCQnMobm9kZTogSW50ZXJuYWxOb2RlPFQ+IHwgbnVsbCkge1xyXG4gICAgICAgIHdoaWxlIChub2RlICE9IG51bGwpIHtcclxuICAgICAgICAgICAgbm9kZS5hYWJiID0gbm9kZS5jaGlsZHJlblswXS5hYWJiLnVuaW9uKG5vZGUuY2hpbGRyZW5bMV0uYWFiYilcclxuICAgICAgICAgICAgbm9kZSA9IG5vZGUucGFyZW50XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG59XHJcblxyXG4vKipcclxuICogY2FsY3VsYXRlIG1hbmhhdHRlbiBkaXN0YW5jZSBiZXR3ZWVuIGNvb3JkaW5hdGVzXHJcbiAqIEBwYXJhbSBhIGZpcnN0IHBvaW50XHJcbiAqIEBwYXJhbSBiIHNlY29uZCBwb2ludFxyXG4gKi9cclxuZXhwb3J0IGZ1bmN0aW9uIGNhbGNNYW5oYXR0ZW5EaXN0KGE6IFBvaW50LCBiOiBQb2ludCk6IG51bWJlciB7XHJcbiAgICByZXR1cm4gTWF0aC5hYnMoYi54IC0gYS54KSArIE1hdGguYWJzKGIueSAtIGEueSlcclxufSJdfQ==