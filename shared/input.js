/**
 * low-level input handling
 */
export var KeyState;
(function (KeyState) {
    KeyState[KeyState["Up"] = 0] = "Up";
    KeyState[KeyState["Down"] = 1] = "Down";
})(KeyState || (KeyState = {}));
export class Input {
    constructor(canvas) {
        this._mouseLeft = KeyState.Up;
        this._prevMouseLeft = KeyState.Up;
        this._mouseX = 0;
        this._mouseY = 0;
        this.prevKeys = new Map();
        this.keys = new Map();
        canvas.addEventListener("keydown", ev => this.handleKeyDown(ev));
        canvas.addEventListener("keyup", ev => this.handleKeyUp(ev));
        canvas.addEventListener("mousedown", ev => this.handleMouseDown(ev));
        canvas.addEventListener("mouseup", ev => this.handleMouseUp(ev));
        canvas.addEventListener("mousemove", ev => this.handleMouseMove(ev));
        canvas.addEventListener("touchstart", ev => this.handleTouchStart(ev));
        canvas.addEventListener("touchend", ev => this.handleTouchEnd(ev));
        canvas.addEventListener("touchmove", ev => this.handleTouchMove(ev));
    }
    get(key) {
        const kst = this.keys.get(key);
        if (!kst) {
            return KeyState.Up;
        }
        return kst;
    }
    getPrev(key) {
        const kst = this.prevKeys.get(key);
        if (!kst) {
            return KeyState.Up;
        }
        return kst;
    }
    up(key) {
        return this.get(key) === KeyState.Up;
    }
    down(key) {
        return this.get(key) == KeyState.Down;
    }
    pressed(key) {
        return this.getPrev(key) === KeyState.Up && this.get(key) === KeyState.Down;
    }
    held(key) {
        return this.getPrev(key) === KeyState.Down && this.get(key) === KeyState.Down;
    }
    released(key) {
        return this.getPrev(key) === KeyState.Down && this.get(key) === KeyState.Up;
    }
    // mouse
    get mouseX() {
        return this._mouseX;
    }
    get mouseY() {
        return this._mouseY;
    }
    get mouseLeftUp() {
        return this._mouseLeft === KeyState.Up;
    }
    get mouseLeftDown() {
        return this._mouseLeft == KeyState.Down;
    }
    get mouseLeftPressed() {
        return this._prevMouseLeft === KeyState.Up && this._mouseLeft === KeyState.Down;
    }
    get mouseLeftHeld() {
        return this._prevMouseLeft === KeyState.Down && this._mouseLeft === KeyState.Down;
    }
    get mouseLeftReleased() {
        return this._prevMouseLeft === KeyState.Down && this._mouseLeft === KeyState.Up;
    }
    /**
     * update key states, determining which are being held, released etc...
     * this should be done AFTER current input is checked
     */
    flush() {
        // process event list, updating key state
        this.prevKeys = new Map(this.keys);
        this._prevMouseLeft = this._mouseLeft;
    }
    handleKeyDown(ev) {
        this.keys.set(ev.key, KeyState.Down);
    }
    handleKeyUp(ev) {
        this.keys.set(ev.key, KeyState.Up);
    }
    handleMouseDown(ev) {
        switch (ev.button) {
            case 0:
                this._mouseLeft = KeyState.Down;
                break;
        }
    }
    handleMouseUp(ev) {
        switch (ev.button) {
            case 0:
                this._mouseLeft = KeyState.Up;
                break;
        }
    }
    handleMouseMove(ev) {
        this._mouseX = ev.offsetX;
        this._mouseY = ev.offsetY;
    }
    handleTouchStart(ev) {
        // prevent default here will stop sinulated mouse events
        ev.preventDefault();
        console.log("start: ", ev);
        this._mouseLeft = KeyState.Down;
    }
    handleTouchEnd(ev) {
        // prevent default here will stop sinulated mouse events
        ev.preventDefault();
        console.log("end: ", ev);
        this._mouseLeft = KeyState.Up;
    }
    handleTouchMove(ev) {
        // prevent default here will stop sinulated mouse events
        console.log("move: ", ev);
        const rect = ev.target.getBoundingClientRect();
        const offsetX = ev.targetTouches[0].pageX - rect.left;
        const offsetY = ev.targetTouches[0].pageY - rect.top;
        this._mouseX = offsetX;
        this._mouseY = offsetY;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5wdXQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbnB1dC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7R0FFRztBQUVILE1BQU0sQ0FBTixJQUFZLFFBR1g7QUFIRCxXQUFZLFFBQVE7SUFDaEIsbUNBQUUsQ0FBQTtJQUNGLHVDQUFJLENBQUE7QUFDUixDQUFDLEVBSFcsUUFBUSxLQUFSLFFBQVEsUUFHbkI7QUFFRCxNQUFNLE9BQU8sS0FBSztJQVFkLFlBQVksTUFBeUI7UUFQN0IsZUFBVSxHQUFhLFFBQVEsQ0FBQyxFQUFFLENBQUE7UUFDbEMsbUJBQWMsR0FBYSxRQUFRLENBQUMsRUFBRSxDQUFBO1FBQ3RDLFlBQU8sR0FBVyxDQUFDLENBQUE7UUFDbkIsWUFBTyxHQUFXLENBQUMsQ0FBQTtRQUNuQixhQUFRLEdBQTBCLElBQUksR0FBRyxFQUFvQixDQUFBO1FBQzdELFNBQUksR0FBMEIsSUFBSSxHQUFHLEVBQW9CLENBQUE7UUFHN0QsTUFBTSxDQUFDLGdCQUFnQixDQUFDLFNBQVMsRUFBRSxFQUFFLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQTtRQUNoRSxNQUFNLENBQUMsZ0JBQWdCLENBQUMsT0FBTyxFQUFFLEVBQUUsQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFBO1FBQzVELE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQyxXQUFXLEVBQUUsRUFBRSxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUE7UUFDcEUsTUFBTSxDQUFDLGdCQUFnQixDQUFDLFNBQVMsRUFBRSxFQUFFLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQTtRQUNoRSxNQUFNLENBQUMsZ0JBQWdCLENBQUMsV0FBVyxFQUFFLEVBQUUsQ0FBQyxFQUFFLENBQUMs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QUFBO1FBQ3pCLElBQUksQ0FBQyxPQUFPLEdBQUcsRUFBRSxDQUFDLE9BQU8sQ0FBQTtJQUM3QixDQUFDO0lBRU8sZ0JBQWdCLENBQUMsRUFBYztRQUNuQyx3REFBd0Q7UUFDeEQsRUFBRSxDQUFDLGNBQWMsRUFBRSxDQUFBO1FBQ25CLE9BQU8sQ0FBQyxHQUFHLENBQUMsU0FBUyxFQUFFLEVBQUUsQ0FBQyxDQUFBO1FBQzFCLElBQUksQ0FBQyxVQUFVLEdBQUcsUUFBUSxDQUFDLElBQUksQ0FBQTtJQUNuQyxDQUFDO0lBRU8sY0FBYyxDQUFDLEVBQWM7UUFDakMsd0RBQXdEO1FBQ3hELEVBQUUsQ0FBQyxjQUFjLEVBQUUsQ0FBQTtRQUNuQixPQUFPLENBQUMsR0FBRyxDQUFDLE9BQU8sRUFBRSxFQUFFLENBQUMsQ0FBQTtRQUN4QixJQUFJLENBQUMsVUFBVSxHQUFHLFFBQVEsQ0FBQyxFQUFFLENBQUE7SUFDakMsQ0FBQztJQUVPLGVBQWUsQ0FBQyxFQUFjO1FBQ2xDLHdEQUF3RDtRQUN4RCxPQUFPLENBQUMsR0FBRyxDQUFDLFFBQVEsRUFBRSxFQUFFLENBQUMsQ0FBQTtRQUN6QixNQUFNLElBQUksR0FBSSxFQUFFLENBQUMsTUFBc0IsQ0FBQyxxQkFBcUIsRUFBRSxDQUFDO1FBQ2hFLE1BQU0sT0FBTyxHQUFHLEVBQUUsQ0FBQyxhQUFhLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUM7UUFDdEQsTUFBTSxPQUFPLEdBQUcsRUFBRSxDQUFDLGFBQWEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQztRQUNyRCxJQUFJLENBQUMsT0FBTyxHQUFHLE9BQU8sQ0FBQTtRQUN0QixJQUFJLENBQUMsT0FBTyxHQUFHLE9BQU8sQ0FBQTtJQUMxQixDQUFDO0NBQ0oiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcclxuICogbG93LWxldmVsIGlucHV0IGhhbmRsaW5nXHJcbiAqL1xyXG5cclxuZXhwb3J0IGVudW0gS2V5U3RhdGUge1xyXG4gICAgVXAsXHJcbiAgICBEb3duXHJcbn1cclxuXHJcbmV4cG9ydCBjbGFzcyBJbnB1dCB7XHJcbiAgICBwcml2YXRlIF9tb3VzZUxlZnQ6IEtleVN0YXRlID0gS2V5U3RhdGUuVXBcclxuICAgIHByaXZhdGUgX3ByZXZNb3VzZUxlZnQ6IEtleVN0YXRlID0gS2V5U3RhdGUuVXBcclxuICAgIHByaXZhdGUgX21vdXNlWDogbnVtYmVyID0gMFxyXG4gICAgcHJpdmF0ZSBfbW91c2VZOiBudW1iZXIgPSAwXHJcbiAgICBwcml2YXRlIHByZXZLZXlzOiBNYXA8c3RyaW5nLCBLZXlTdGF0ZT4gPSBuZXcgTWFwPHN0cmluZywgS2V5U3RhdGU+KClcclxuICAgIHByaXZhdGUga2V5czogTWFwPHN0cmluZywgS2V5U3RhdGU+ID0gbmV3IE1hcDxzdHJpbmcsIEtleVN0YXRlPigpXHJcblxyXG4gICAgY29uc3RydWN0b3IoY2FudmFzOiBIVE1MQ2FudmFzRWxlbWVudCkge1xyXG4gICAgICAgIGNhbnZhcy5hZGRFdmVudExpc3RlbmVyKFwia2V5ZG93blwiLCBldiA9PiB0aGlzLmhhbmRsZUtleURvd24oZXYpKVxyXG4gICAgICAgIGNhbnZhcy5hZGRFdmVudExpc3RlbmVyKFwia2V5dXBcIiwgZXYgPT4gdGhpcy5oYW5kbGVLZXlVcChldikpXHJcbiAgICAgICAgY2FudmFzLmFkZEV2ZW50TGlzdGVuZXIoXCJtb3VzZWRvd25cIiwgZXYgPT4gdGhpcy5oYW5kbGVNb3VzZURvd24oZXYpKVxyXG4gICAgICAgIGNhbnZhcy5hZGRFdmVudExpc3RlbmVyKFwibW91c2V1cFwiLCBldiA9PiB0aGlzLmhhbmRsZU1vdXNlVXAoZXYpKVxyXG4gICAgICAgIGNhbnZhcy5hZGRFdmVudExpc3RlbmVyKFwibW91c2Vtb3ZlXCIsIGV2ID0+IHRoaXMuaGFuZGxlTW91c2VNb3ZlKGV2KSlcclxuICAgICAgICBjYW52YXMuYWRkRXZlbnRMaXN0ZW5lcihcInRvdWNoc3RhcnRcIiwgZXYgPT4gdGhpcy5oYW5kbGVUb3VjaFN0YXJ0KGV2KSlcclxuICAgICAgICBjYW52YXMuYWRkRXZlbnRMaXN0ZW5lcihcInRvdWNoZW5kXCIsIGV2ID0+IHRoaXMuaGFuZGxlVG91Y2hFbmQoZXYpKVxyXG4gICAgICAgIGNhbnZhcy5hZGRFdmVudExpc3RlbmVyKFwidG91Y2htb3ZlXCIsIGV2ID0+IHRoaXMuaGFuZGxlVG91Y2hNb3ZlKGV2KSlcclxuICAgIH1cclxuXHJcbiAgICBnZXQoa2V5OiBzdHJpbmcpOiBLZXlTdGF0ZSB7XHJcbiAgICAgICAgY29uc3Qga3N0ID0gdGhpcy5rZXlzLmdldChrZXkpXHJcbiAgICAgICAgaWYgKCFrc3QpIHtcclxuICAgICAgICAgICAgcmV0dXJuIEtleVN0YXRlLlVwXHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4ga3N0XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBnZXRQcmV2KGtleTogc3RyaW5nKTogS2V5U3RhdGUge1xyXG4gICAgICAgIGNvbnN0IGtzdCA9IHRoaXMucHJldktleXMuZ2V0KGtleSlcclxuICAgICAgICBpZiAoIWtzdCkge1xyXG4gICAgICAgICAgICByZXR1cm4gS2V5U3RhdGUuVXBcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiBrc3RcclxuICAgIH1cclxuXHJcbiAgICB1cChrZXk6IHN0cmluZyk6IGJvb2xlYW4ge1xyXG4gICAgICAgIHJldHVybiB0aGlzLmdldChrZXkpID09PSBLZXlTdGF0ZS5VcFxyXG4gICAgfVxyXG5cclxuICAgIGRvd24oa2V5OiBzdHJpbmcpOiBib29sZWFuIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5nZXQoa2V5KSA9PSBLZXlTdGF0ZS5Eb3duO1xyXG4gICAgfVxyXG5cclxuICAgIHByZXNzZWQoa2V5OiBzdHJpbmcpOiBib29sZWFuIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5nZXRQcmV2KGtleSkgPT09IEtleVN0YXRlLlVwICYmIHRoaXMuZ2V0KGtleSkgPT09IEtleVN0YXRlLkRvd25cclxuICAgIH1cclxuXHJcbiAgICBoZWxkKGtleTogc3RyaW5nKTogYm9vbGVhbiB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0UHJldihrZXkpID09PSBLZXlTdGF0ZS5Eb3duICYmIHRoaXMuZ2V0KGtleSkgPT09IEtleVN0YXRlLkRvd25cclxuICAgIH1cclxuXHJcbiAgICByZWxlYXNlZChrZXk6IHN0cmluZyk6IGJvb2xlYW4ge1xyXG4gICAgICAgIHJldHVybiB0aGlzLmdldFByZXYoa2V5KSA9PT0gS2V5U3RhdGUuRG93biAmJiB0aGlzLmdldChrZXkpID09PSBLZXlTdGF0ZS5VcFxyXG4gICAgfVxyXG5cclxuICAgIC8vIG1vdXNlXHJcbiAgICBnZXQgbW91c2VYKCk6IG51bWJlciB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuX21vdXNlWFxyXG4gICAgfVxyXG5cclxuICAgIGdldCBtb3VzZVkoKTogbnVtYmVyIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5fbW91c2VZXHJcbiAgICB9XHJcblxyXG4gICAgZ2V0IG1vdXNlTGVmdFVwKCk6IGJvb2xlYW4ge1xyXG4gICAgICAgIHJldHVybiB0aGlzLl9tb3VzZUxlZnQgPT09IEtleVN0YXRlLlVwXHJcbiAgICB9XHJcblxyXG4gICAgZ2V0IG1vdXNlTGVmdERvd24oKTogYm9vbGVhbiB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuX21vdXNlTGVmdCA9PSBLZXlTdGF0ZS5Eb3duO1xyXG4gICAgfVxyXG5cclxuICAgIGdldCBtb3VzZUxlZnRQcmVzc2VkKCk6IGJvb2xlYW4ge1xyXG4gICAgICAgIHJldHVybiB0aGlzLl9wcmV2TW91c2VMZWZ0ID09PSBLZXlTdGF0ZS5VcCAmJiB0aGlzLl9tb3VzZUxlZnQgPT09IEtleVN0YXRlLkRvd25cclxuICAgIH1cclxuXHJcbiAgICBnZXQgbW91c2VMZWZ0SGVsZCgpOiBib29sZWFuIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5fcHJldk1vdXNlTGVmdCA9PT0gS2V5U3RhdGUuRG93biAmJiB0aGlzLl9tb3VzZUxlZnQgPT09IEtleVN0YXRlLkRvd25cclxuICAgIH1cclxuXHJcbiAgICBnZXQgbW91c2VMZWZ0UmVsZWFzZWQoKTogYm9vbGVhbiB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuX3ByZXZNb3VzZUxlZnQgPT09IEtleVN0YXRlLkRvd24gJiYgdGhpcy5fbW91c2VMZWZ0ID09PSBLZXlTdGF0ZS5VcFxyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogdXBkYXRlIGtleSBzdGF0ZXMsIGRldGVybWluaW5nIHdoaWNoIGFyZSBiZWluZyBoZWxkLCByZWxlYXNlZCBldGMuLi5cclxuICAgICAqIHRoaXMgc2hvdWxkIGJlIGRvbmUgQUZURVIgY3VycmVudCBpbnB1dCBpcyBjaGVja2VkXHJcbiAgICAgKi9cclxuICAgIGZsdXNoKCk6IHZvaWQge1xyXG4gICAgICAgIC8vIHByb2Nlc3MgZXZlbnQgbGlzdCwgdXBkYXRpbmcga2V5IHN0YXRlXHJcbiAgICAgICAgdGhpcy5wcmV2S2V5cyA9IG5ldyBNYXA8c3RyaW5nLCBLZXlTdGF0ZT4odGhpcy5rZXlzKVxyXG4gICAgICAgIHRoaXMuX3ByZXZNb3VzZUxlZnQgPSB0aGlzLl9tb3VzZUxlZnRcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGhhbmRsZUtleURvd24oZXY6IEtleWJvYXJkRXZlbnQpIHtcclxuICAgICAgICB0aGlzLmtleXMuc2V0KGV2LmtleSwgS2V5U3RhdGUuRG93bilcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGhhbmRsZUtleVVwKGV2OiBLZXlib2FyZEV2ZW50KSB7XHJcbiAgICAgICAgdGhpcy5rZXlzLnNldChldi5rZXksIEtleVN0YXRlLlVwKVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgaGFuZGxlTW91c2VEb3duKGV2OiBNb3VzZUV2ZW50KSB7XHJcbiAgICAgICAgc3dpdGNoIChldi5idXR0b24pIHtcclxuICAgICAgICAgICAgY2FzZSAwOlxyXG4gICAgICAgICAgICAgICAgdGhpcy5fbW91c2VMZWZ0ID0gS2V5U3RhdGUuRG93blxyXG4gICAgICAgICAgICAgICAgYnJlYWtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBoYW5kbGVNb3VzZVVwKGV2OiBNb3VzZUV2ZW50KSB7XHJcbiAgICAgICAgc3dpdGNoIChldi5idXR0b24pIHtcclxuICAgICAgICAgICAgY2FzZSAwOlxyXG4gICAgICAgICAgICAgICAgdGhpcy5fbW91c2VMZWZ0ID0gS2V5U3RhdGUuVXBcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGhhbmRsZU1vdXNlTW92ZShldjogTW91c2VFdmVudCkge1xyXG4gICAgICAgIHRoaXMuX21vdXNlWCA9IGV2Lm9mZnNldFhcclxuICAgICAgICB0aGlzLl9tb3VzZVkgPSBldi5vZmZzZXRZXHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBoYW5kbGVUb3VjaFN0YXJ0KGV2OiBUb3VjaEV2ZW50KSB7XHJcbiAgICAgICAgLy8gcHJldmVudCBkZWZhdWx0IGhlcmUgd2lsbCBzdG9wIHNpbnVsYXRlZCBtb3VzZSBldmVudHNcclxuICAgICAgICBldi5wcmV2ZW50RGVmYXVsdCgpXHJcbiAgICAgICAgY29uc29sZS5sb2coXCJzdGFydDogXCIsIGV2KVxyXG4gICAgICAgIHRoaXMuX21vdXNlTGVmdCA9IEtleVN0YXRlLkRvd25cclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGhhbmRsZVRvdWNoRW5kKGV2OiBUb3VjaEV2ZW50KSB7XHJcbiAgICAgICAgLy8gcHJldmVudCBkZWZhdWx0IGhlcmUgd2lsbCBzdG9wIHNpbnVsYXRlZCBtb3VzZSBldmVudHNcclxuICAgICAgICBldi5wcmV2ZW50RGVmYXVsdCgpXHJcbiAgICAgICAgY29uc29sZS5sb2coXCJlbmQ6IFwiLCBldilcclxuICAgICAgICB0aGlzLl9tb3VzZUxlZnQgPSBLZXlTdGF0ZS5VcFxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgaGFuZGxlVG91Y2hNb3ZlKGV2OiBUb3VjaEV2ZW50KSB7XHJcbiAgICAgICAgLy8gcHJldmVudCBkZWZhdWx0IGhlcmUgd2lsbCBzdG9wIHNpbnVsYXRlZCBtb3VzZSBldmVudHNcclxuICAgICAgICBjb25zb2xlLmxvZyhcIm1vdmU6IFwiLCBldilcclxuICAgICAgICBjb25zdCByZWN0ID0gKGV2LnRhcmdldCBhcyBIVE1MRWxlbWVudCkuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7XHJcbiAgICAgICAgY29uc3Qgb2Zmc2V0WCA9IGV2LnRhcmdldFRvdWNoZXNbMF0ucGFnZVggLSByZWN0LmxlZnQ7XHJcbiAgICAgICAgY29uc3Qgb2Zmc2V0WSA9IGV2LnRhcmdldFRvdWNoZXNbMF0ucGFnZVkgLSByZWN0LnRvcDtcclxuICAgICAgICB0aGlzLl9tb3VzZVggPSBvZmZzZXRYXHJcbiAgICAgICAgdGhpcy5fbW91c2VZID0gb2Zmc2V0WVxyXG4gICAgfVxyXG59Il19