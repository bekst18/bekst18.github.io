/**
 * low-level input handling
 */
export var KeyState;
(function (KeyState) {
    KeyState[KeyState["Up"] = 0] = "Up";
    KeyState[KeyState["Down"] = 1] = "Down";
})(KeyState || (KeyState = {}));
export class Input {
    constructor(canvas) {
        this._mouseLeft = KeyState.Up;
        this._prevMouseLeft = KeyState.Up;
        this._mouseX = 0;
        this._mouseY = 0;
        this.prevKeys = new Map();
        this.keys = new Map();
        canvas.addEventListener("keydown", ev => this.handleKeyDown(ev));
        canvas.addEventListener("keyup", ev => this.handleKeyUp(ev));
        canvas.addEventListener("mousedown", ev => this.handleMouseDown(ev));
        canvas.addEventListener("mouseup", ev => this.handleMouseUp(ev));
        canvas.addEventListener("mousemove", ev => this.handleMouseMove(ev));
        canvas.addEventListener("touchstart", ev => this.handleTouchStart(ev));
        canvas.addEventListener("touchend", ev => this.handleTouchEnd(ev));
        canvas.addEventListener("touchmove", ev => this.handleTouchMove(ev));
    }
    get(key) {
        const kst = this.keys.get(key);
        if (!kst) {
            return KeyState.Up;
        }
        return kst;
    }
    getPrev(key) {
        const kst = this.prevKeys.get(key);
        if (!kst) {
            return KeyState.Up;
        }
        return kst;
    }
    up(key) {
        return this.get(key) === KeyState.Up;
    }
    down(key) {
        return this.get(key) == KeyState.Down;
    }
    pressed(key) {
        return this.getPrev(key) === KeyState.Up && this.get(key) === KeyState.Down;
    }
    held(key) {
        return this.getPrev(key) === KeyState.Down && this.get(key) === KeyState.Down;
    }
    released(key) {
        return this.getPrev(key) === KeyState.Down && this.get(key) === KeyState.Up;
    }
    // mouse
    get mouseX() {
        return this._mouseX;
    }
    get mouseY() {
        return this._mouseY;
    }
    get mouseLeftUp() {
        return this._mouseLeft === KeyState.Up;
    }
    get mouseLeftDown() {
        return this._mouseLeft == KeyState.Down;
    }
    get mouseLeftPressed() {
        return this._prevMouseLeft === KeyState.Up && this._mouseLeft === KeyState.Down;
    }
    get mouseLeftHeld() {
        return this._prevMouseLeft === KeyState.Down && this._mouseLeft === KeyState.Down;
    }
    get mouseLeftReleased() {
        return this._prevMouseLeft === KeyState.Down && this._mouseLeft === KeyState.Up;
    }
    /**
     * update key states, determining which are being held, released etc...
     * this should be done AFTER current input is checked
     */
    flush() {
        // process event list, updating key state
        this.prevKeys = new Map(this.keys);
        this._prevMouseLeft = this._mouseLeft;
    }
    handleKeyDown(ev) {
        this.keys.set(ev.key, KeyState.Down);
    }
    handleKeyUp(ev) {
        this.keys.set(ev.key, KeyState.Up);
    }
    handleMouseDown(ev) {
        switch (ev.button) {
            case 0:
                this._mouseLeft = KeyState.Down;
                break;
        }
    }
    handleMouseUp(ev) {
        switch (ev.button) {
            case 0:
                this._mouseLeft = KeyState.Up;
                break;
        }
    }
    handleMouseMove(ev) {
        this._mouseX = ev.clientX;
        this._mouseY = ev.clientY;
    }
    handleTouchStart(ev) {
        // prevent default here will stop sinulated mouse events
        ev.preventDefault();
        this._mouseLeft = KeyState.Down;
    }
    handleTouchEnd(ev) {
        // prevent default here will stop sinulated mouse events
        ev.preventDefault();
        this._mouseLeft = KeyState.Up;
    }
    handleTouchMove(ev) {
        // prevent default here will stop sinulated mouse events
        this._mouseX = ev.touches[0].clientX;
        this._mouseY = ev.touches[0].clientY;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5wdXQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbnB1dC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7R0FFRztBQUVILE1BQU0sQ0FBTixJQUFZLFFBR1g7QUFIRCxXQUFZLFFBQVE7SUFDaEIsbUNBQUUsQ0FBQTtJQUNGLHVDQUFJLENBQUE7QUFDUixDQUFDLEVBSFcsUUFBUSxLQUFSLFFBQVEsUUFHbkI7QUFFRCxNQUFNLE9BQU8sS0FBSztJQVFkLFlBQVksTUFBeUI7UUFQN0IsZUFBVSxHQUFhLFFBQVEsQ0FBQyxFQUFFLENBQUE7UUFDbEMsbUJBQWMsR0FBYSxRQUFRLENBQUMsRUFBRSxDQUFBO1FBQ3RDLFlBQU8sR0FBVyxDQUFDLENBQUE7UUFDbkIsWUFBTyxHQUFXLENBQUMsQ0FBQTtRQUNuQixhQUFRLEdBQTBCLElBQUksR0FBRyxFQUFvQixDQUFBO1FBQzdELFNBQUksR0FBMEIsSUFBSSxHQUFHLEVBQW9CLENBQUE7UUFHN0QsTUFBTSxDQUFDLGdCQUFnQixDQUFDLFNBQVMsRUFBRSxFQUFFLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQTtRQUNoRSxNQUFNLENBQUMsZ0JBQWdCLENBQUMsT0FBTyxFQUFFLEVBQUUsQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFBO1FBQzVELE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQyxXQUFXLEVBQUUsRUFBRSxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUE7UUFDcEUsTUFBTSxDQUFDLGdCQUFnQixDQUFDLFNBQVMsRUFBRSxFQUFFLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQTtRQUNoRSxNQUFNLENBQUMsZ0JBQWdCLENBQUMsV0FBVyxFQUFFLEVBQUUsQ0FBQyxFQUFFLENBQUMs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QUFBO1FBQ3pCLElBQUksQ0FBQyxPQUFPLEdBQUcsRUFBRSxDQUFDLE9BQU8sQ0FBQTtJQUM3QixDQUFDO0lBRU8sZ0JBQWdCLENBQUMsRUFBYztRQUNuQyx3REFBd0Q7UUFDeEQsRUFBRSxDQUFDLGNBQWMsRUFBRSxDQUFBO1FBQ25CLElBQUksQ0FBQyxVQUFVLEdBQUcsUUFBUSxDQUFDLElBQUksQ0FBQTtJQUNuQyxDQUFDO0lBRU8sY0FBYyxDQUFDLEVBQWM7UUFDakMsd0RBQXdEO1FBQ3hELEVBQUUsQ0FBQyxjQUFjLEVBQUUsQ0FBQTtRQUNuQixJQUFJLENBQUMsVUFBVSxHQUFHLFFBQVEsQ0FBQyxFQUFFLENBQUE7SUFDakMsQ0FBQztJQUVPLGVBQWUsQ0FBQyxFQUFjO1FBQ2xDLHdEQUF3RDtRQUN4RCxJQUFJLENBQUMsT0FBTyxHQUFHLEVBQUUsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFBO1FBQ3BDLElBQUksQ0FBQyxPQUFPLEdBQUcsRUFBRSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUE7SUFDeEMsQ0FBQztDQUNKIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXHJcbiAqIGxvdy1sZXZlbCBpbnB1dCBoYW5kbGluZ1xyXG4gKi9cclxuXHJcbmV4cG9ydCBlbnVtIEtleVN0YXRlIHtcclxuICAgIFVwLFxyXG4gICAgRG93blxyXG59XHJcblxyXG5leHBvcnQgY2xhc3MgSW5wdXQge1xyXG4gICAgcHJpdmF0ZSBfbW91c2VMZWZ0OiBLZXlTdGF0ZSA9IEtleVN0YXRlLlVwXHJcbiAgICBwcml2YXRlIF9wcmV2TW91c2VMZWZ0OiBLZXlTdGF0ZSA9IEtleVN0YXRlLlVwXHJcbiAgICBwcml2YXRlIF9tb3VzZVg6IG51bWJlciA9IDBcclxuICAgIHByaXZhdGUgX21vdXNlWTogbnVtYmVyID0gMFxyXG4gICAgcHJpdmF0ZSBwcmV2S2V5czogTWFwPHN0cmluZywgS2V5U3RhdGU+ID0gbmV3IE1hcDxzdHJpbmcsIEtleVN0YXRlPigpXHJcbiAgICBwcml2YXRlIGtleXM6IE1hcDxzdHJpbmcsIEtleVN0YXRlPiA9IG5ldyBNYXA8c3RyaW5nLCBLZXlTdGF0ZT4oKVxyXG5cclxuICAgIGNvbnN0cnVjdG9yKGNhbnZhczogSFRNTENhbnZhc0VsZW1lbnQpIHtcclxuICAgICAgICBjYW52YXMuYWRkRXZlbnRMaXN0ZW5lcihcImtleWRvd25cIiwgZXYgPT4gdGhpcy5oYW5kbGVLZXlEb3duKGV2KSlcclxuICAgICAgICBjYW52YXMuYWRkRXZlbnRMaXN0ZW5lcihcImtleXVwXCIsIGV2ID0+IHRoaXMuaGFuZGxlS2V5VXAoZXYpKVxyXG4gICAgICAgIGNhbnZhcy5hZGRFdmVudExpc3RlbmVyKFwibW91c2Vkb3duXCIsIGV2ID0+IHRoaXMuaGFuZGxlTW91c2VEb3duKGV2KSlcclxuICAgICAgICBjYW52YXMuYWRkRXZlbnRMaXN0ZW5lcihcIm1vdXNldXBcIiwgZXYgPT4gdGhpcy5oYW5kbGVNb3VzZVVwKGV2KSlcclxuICAgICAgICBjYW52YXMuYWRkRXZlbnRMaXN0ZW5lcihcIm1vdXNlbW92ZVwiLCBldiA9PiB0aGlzLmhhbmRsZU1vdXNlTW92ZShldikpXHJcbiAgICAgICAgY2FudmFzLmFkZEV2ZW50TGlzdGVuZXIoXCJ0b3VjaHN0YXJ0XCIsIGV2ID0+IHRoaXMuaGFuZGxlVG91Y2hTdGFydChldikpXHJcbiAgICAgICAgY2FudmFzLmFkZEV2ZW50TGlzdGVuZXIoXCJ0b3VjaGVuZFwiLCBldiA9PiB0aGlzLmhhbmRsZVRvdWNoRW5kKGV2KSlcclxuICAgICAgICBjYW52YXMuYWRkRXZlbnRMaXN0ZW5lcihcInRvdWNobW92ZVwiLCBldiA9PiB0aGlzLmhhbmRsZVRvdWNoTW92ZShldikpXHJcbiAgICB9XHJcblxyXG4gICAgZ2V0KGtleTogc3RyaW5nKTogS2V5U3RhdGUge1xyXG4gICAgICAgIGNvbnN0IGtzdCA9IHRoaXMua2V5cy5nZXQoa2V5KVxyXG4gICAgICAgIGlmICgha3N0KSB7XHJcbiAgICAgICAgICAgIHJldHVybiBLZXlTdGF0ZS5VcFxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIGtzdFxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgZ2V0UHJldihrZXk6IHN0cmluZyk6IEtleVN0YXRlIHtcclxuICAgICAgICBjb25zdCBrc3QgPSB0aGlzLnByZXZLZXlzLmdldChrZXkpXHJcbiAgICAgICAgaWYgKCFrc3QpIHtcclxuICAgICAgICAgICAgcmV0dXJuIEtleVN0YXRlLlVwXHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4ga3N0XHJcbiAgICB9XHJcblxyXG4gICAgdXAoa2V5OiBzdHJpbmcpOiBib29sZWFuIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5nZXQoa2V5KSA9PT0gS2V5U3RhdGUuVXBcclxuICAgIH1cclxuXHJcbiAgICBkb3duKGtleTogc3RyaW5nKTogYm9vbGVhbiB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0KGtleSkgPT0gS2V5U3RhdGUuRG93bjtcclxuICAgIH1cclxuXHJcbiAgICBwcmVzc2VkKGtleTogc3RyaW5nKTogYm9vbGVhbiB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0UHJldihrZXkpID09PSBLZXlTdGF0ZS5VcCAmJiB0aGlzLmdldChrZXkpID09PSBLZXlTdGF0ZS5Eb3duXHJcbiAgICB9XHJcblxyXG4gICAgaGVsZChrZXk6IHN0cmluZyk6IGJvb2xlYW4ge1xyXG4gICAgICAgIHJldHVybiB0aGlzLmdldFByZXYoa2V5KSA9PT0gS2V5U3RhdGUuRG93biAmJiB0aGlzLmdldChrZXkpID09PSBLZXlTdGF0ZS5Eb3duXHJcbiAgICB9XHJcblxyXG4gICAgcmVsZWFzZWQoa2V5OiBzdHJpbmcpOiBib29sZWFuIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5nZXRQcmV2KGtleSkgPT09IEtleVN0YXRlLkRvd24gJiYgdGhpcy5nZXQoa2V5KSA9PT0gS2V5U3RhdGUuVXBcclxuICAgIH1cclxuXHJcbiAgICAvLyBtb3VzZVxyXG4gICAgZ2V0IG1vdXNlWCgpOiBudW1iZXIge1xyXG4gICAgICAgIHJldHVybiB0aGlzLl9tb3VzZVhcclxuICAgIH1cclxuXHJcbiAgICBnZXQgbW91c2VZKCk6IG51bWJlciB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuX21vdXNlWVxyXG4gICAgfVxyXG5cclxuICAgIGdldCBtb3VzZUxlZnRVcCgpOiBib29sZWFuIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5fbW91c2VMZWZ0ID09PSBLZXlTdGF0ZS5VcFxyXG4gICAgfVxyXG5cclxuICAgIGdldCBtb3VzZUxlZnREb3duKCk6IGJvb2xlYW4ge1xyXG4gICAgICAgIHJldHVybiB0aGlzLl9tb3VzZUxlZnQgPT0gS2V5U3RhdGUuRG93bjtcclxuICAgIH1cclxuXHJcbiAgICBnZXQgbW91c2VMZWZ0UHJlc3NlZCgpOiBib29sZWFuIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5fcHJldk1vdXNlTGVmdCA9PT0gS2V5U3RhdGUuVXAgJiYgdGhpcy5fbW91c2VMZWZ0ID09PSBLZXlTdGF0ZS5Eb3duXHJcbiAgICB9XHJcblxyXG4gICAgZ2V0IG1vdXNlTGVmdEhlbGQoKTogYm9vbGVhbiB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuX3ByZXZNb3VzZUxlZnQgPT09IEtleVN0YXRlLkRvd24gJiYgdGhpcy5fbW91c2VMZWZ0ID09PSBLZXlTdGF0ZS5Eb3duXHJcbiAgICB9XHJcblxyXG4gICAgZ2V0IG1vdXNlTGVmdFJlbGVhc2VkKCk6IGJvb2xlYW4ge1xyXG4gICAgICAgIHJldHVybiB0aGlzLl9wcmV2TW91c2VMZWZ0ID09PSBLZXlTdGF0ZS5Eb3duICYmIHRoaXMuX21vdXNlTGVmdCA9PT0gS2V5U3RhdGUuVXBcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIHVwZGF0ZSBrZXkgc3RhdGVzLCBkZXRlcm1pbmluZyB3aGljaCBhcmUgYmVpbmcgaGVsZCwgcmVsZWFzZWQgZXRjLi4uXHJcbiAgICAgKiB0aGlzIHNob3VsZCBiZSBkb25lIEFGVEVSIGN1cnJlbnQgaW5wdXQgaXMgY2hlY2tlZFxyXG4gICAgICovXHJcbiAgICBmbHVzaCgpOiB2b2lkIHtcclxuICAgICAgICAvLyBwcm9jZXNzIGV2ZW50IGxpc3QsIHVwZGF0aW5nIGtleSBzdGF0ZVxyXG4gICAgICAgIHRoaXMucHJldktleXMgPSBuZXcgTWFwPHN0cmluZywgS2V5U3RhdGU+KHRoaXMua2V5cylcclxuICAgICAgICB0aGlzLl9wcmV2TW91c2VMZWZ0ID0gdGhpcy5fbW91c2VMZWZ0XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBoYW5kbGVLZXlEb3duKGV2OiBLZXlib2FyZEV2ZW50KSB7XHJcbiAgICAgICAgdGhpcy5rZXlzLnNldChldi5rZXksIEtleVN0YXRlLkRvd24pXHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBoYW5kbGVLZXlVcChldjogS2V5Ym9hcmRFdmVudCkge1xyXG4gICAgICAgIHRoaXMua2V5cy5zZXQoZXYua2V5LCBLZXlTdGF0ZS5VcClcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGhhbmRsZU1vdXNlRG93bihldjogTW91c2VFdmVudCkge1xyXG4gICAgICAgIHN3aXRjaCAoZXYuYnV0dG9uKSB7XHJcbiAgICAgICAgICAgIGNhc2UgMDpcclxuICAgICAgICAgICAgICAgIHRoaXMuX21vdXNlTGVmdCA9IEtleVN0YXRlLkRvd25cclxuICAgICAgICAgICAgICAgIGJyZWFrXHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgaGFuZGxlTW91c2VVcChldjogTW91c2VFdmVudCkge1xyXG4gICAgICAgIHN3aXRjaCAoZXYuYnV0dG9uKSB7XHJcbiAgICAgICAgICAgIGNhc2UgMDpcclxuICAgICAgICAgICAgICAgIHRoaXMuX21vdXNlTGVmdCA9IEtleVN0YXRlLlVwXHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBoYW5kbGVNb3VzZU1vdmUoZXY6IE1vdXNlRXZlbnQpIHtcclxuICAgICAgICB0aGlzLl9tb3VzZVggPSBldi5jbGllbnRYXHJcbiAgICAgICAgdGhpcy5fbW91c2VZID0gZXYuY2xpZW50WVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgaGFuZGxlVG91Y2hTdGFydChldjogVG91Y2hFdmVudCkge1xyXG4gICAgICAgIC8vIHByZXZlbnQgZGVmYXVsdCBoZXJlIHdpbGwgc3RvcCBzaW51bGF0ZWQgbW91c2UgZXZlbnRzXHJcbiAgICAgICAgZXYucHJldmVudERlZmF1bHQoKVxyXG4gICAgICAgIHRoaXMuX21vdXNlTGVmdCA9IEtleVN0YXRlLkRvd25cclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGhhbmRsZVRvdWNoRW5kKGV2OiBUb3VjaEV2ZW50KSB7XHJcbiAgICAgICAgLy8gcHJldmVudCBkZWZhdWx0IGhlcmUgd2lsbCBzdG9wIHNpbnVsYXRlZCBtb3VzZSBldmVudHNcclxuICAgICAgICBldi5wcmV2ZW50RGVmYXVsdCgpXHJcbiAgICAgICAgdGhpcy5fbW91c2VMZWZ0ID0gS2V5U3RhdGUuVXBcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGhhbmRsZVRvdWNoTW92ZShldjogVG91Y2hFdmVudCkge1xyXG4gICAgICAgIC8vIHByZXZlbnQgZGVmYXVsdCBoZXJlIHdpbGwgc3RvcCBzaW51bGF0ZWQgbW91c2UgZXZlbnRzXHJcbiAgICAgICAgdGhpcy5fbW91c2VYID0gZXYudG91Y2hlc1swXS5jbGllbnRYXHJcbiAgICAgICAgdGhpcy5fbW91c2VZID0gZXYudG91Y2hlc1swXS5jbGllbnRZXHJcbiAgICB9XHJcbn0iXX0=