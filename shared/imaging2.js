import * as geo from "../shared/geo3d.js";
import * as array from "../shared/array.js";
export class Color extends geo.Vec4 {
}
export class Image {
    constructor(width, height) {
        this.width = width;
        this.height = height;
        this.data = array.generate(width * height, _ => geo.Vec4.zero());
    }
    atf(i) {
        return this.data[i];
    }
    at(x, y) {
        return this.atf(this.flat(x, y));
    }
    flat(x, y) {
        return y * this.width + x;
    }
    map(f) {
        return this.data.map(f);
    }
    *[Symbol.iterator]() {
        for (const x of this.data) {
            yield x;
        }
    }
    scan(f) {
        for (let y = 0; y < this.height; ++y) {
            const yOffset = y * this.width;
            for (let x = 0; x < this.width; ++x) {
                const xOffset = yOffset + x;
                f(x, y, xOffset);
            }
        }
    }
}
export function fromCanvasImageData(imageData) {
    const { width, height, data } = imageData;
    const numPixels = width * height;
    const image = new Image(width, height);
    for (let i = 0; i < numPixels; ++i) {
        const ii = i * 4;
        const color = image.atf(i);
        color.x = data[ii] / 255;
        color.y = data[ii + 1] / 255;
        color.z = data[ii + 2] / 255;
        color.w = data[ii + 3] / 255;
    }
    return image;
}
export function toCanvasImageData(image) {
    const { width, height } = image;
    const pixels = width * height;
    const imageData = new ImageData(width, height);
    const data = imageData.data;
    for (let i = 0; i < pixels; ++i) {
        const ii = i * 4;
        const color = image.atf(i);
        data[ii] = Math.floor(color.x * 255);
        data[ii + 1] = Math.floor(color.y * 255);
        data[ii + 2] = Math.floor(color.z * 255);
        data[ii + 3] = Math.floor(color.w * 255);
    }
    return imageData;
}
export function palettizeHistogram(image, bucketsPerComponent, maxColors) {
    const bucketPitch = bucketsPerComponent * bucketsPerComponent;
    const numBuckets = bucketPitch * bucketsPerComponent;
    // create intial buckets
    const buckets = array.generate(numBuckets, () => ({ color: geo.Vec4.zero(), pixels: 0 }));
    // assign and update bucket for each pixel
    const bucketOverlay = image.map(color => {
        const rb = Math.min(Math.floor(color.x * bucketsPerComponent), bucketsPerComponent - 1);
        const gb = Math.min(Math.floor(color.y * bucketsPerComponent), bucketsPerComponent - 1);
        const bb = Math.min(Math.floor(color.z * bucketsPerComponent), bucketsPerComponent - 1);
        const bucketIdx = rb * bucketPitch + gb * bucketsPerComponent + bb;
        const bucket = buckets[bucketIdx];
        bucket.color = bucket.color.add(color);
        bucket.pixels++;
        return bucket;
    });
    // calculate bucket colors
    for (const bucket of buckets) {
        bucket.color = bucket.color.divX(bucket.pixels);
    }
    const topBuckets = buckets
        .sort((b1, b2) => b2.pixels - b1.pixels)
        .slice(0, maxColors);
    const bucketSet = new Set(topBuckets);
    // map all colors to top N buckets
    for (let i = 0; i < bucketOverlay.length; ++i) {
        // if color is a remaining color, continue
        // otherwise replace with nearest top bucket
        if (bucketSet.has(bucketOverlay[i])) {
            continue;
        }
        const color = image.atf(i);
        const bucket = topBuckets.reduce((b1, b2) => b1.color.xyz.sub(color.xyz).lengthSq() < b2.color.xyz.sub(color.xyz).lengthSq() ? b1 : b2);
        bucketOverlay[i] = bucket;
    }
    // replace colors with bucket colors
    for (let i = 0; i < bucketOverlay.length; ++i) {
        image.atf(i).set(bucketOverlay[i].color);
    }
}
export function uniqueColors(img) {
    const set = new Set();
    for (const color of img) {
        set.add(packColor(color));
    }
    const colors = [...set].map(n => unpackColor(n));
    return colors;
}
export function indexByColor(img, colors) {
    const idxs = img.map(c1 => colors.findIndex(c2 => c1.equal(c2)));
    return idxs;
}
export function calcLuminance(color) {
    const l = 0.2126 * (color.x / 255) + 0.7152 * (color.y / 255) + 0.0722 * (color.z / 255);
    return l;
}
export function toCanvasColor(color) {
    const r = color.mulX(255).floor();
    return r;
}
export function fromCanvasColor(color) {
    const r = color.divX(255);
    return r;
}
export function toCanvasComponent(x) {
    const y = Math.floor(x * 255);
    return y;
}
export function fromCanvasComponent(x) {
    const y = x / 255;
    return y;
}
export function packColor(color) {
    const r = toCanvasComponent(color.x);
    const g = toCanvasComponent(color.y);
    const b = toCanvasComponent(color.z);
    const a = toCanvasComponent(color.w);
    const n = (r << 24) | (g << 16) | (b << 8) | a;
    return n;
}
export function unpackColor(n) {
    const r = (n & 0xFF000000) >>> 24;
    const g = (n & 0x00FF0000) >>> 16;
    const b = (n & 0x0000FF00) >>> 8;
    const a = n & 0x000000FF;
    return new Color(fromCanvasComponent(r), fromCanvasComponent(g), fromCanvasComponent(b), fromCanvasComponent(a));
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW1hZ2luZzIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbWFnaW5nMi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEtBQUssR0FBRyxNQUFNLG9CQUFvQixDQUFBO0FBQ3pDLE9BQU8sS0FBSyxLQUFLLE1BQU0sb0JBQW9CLENBQUE7QUFFM0MsTUFBTSxPQUFPLEtBQU0sU0FBUSxHQUFHLENBQUMsSUFBSTtDQUVsQztBQUVELE1BQU0sT0FBTyxLQUFLO0lBR2QsWUFBNEIsS0FBYSxFQUFrQixNQUFjO1FBQTdDLFVBQUssR0FBTCxLQUFLLENBQVE7UUFBa0IsV0FBTSxHQUFOLE1BQU0sQ0FBUTtRQUNyRSxJQUFJLENBQUMsSUFBSSxHQUFHLEtBQUssQ0FBQyxRQUFRLENBQUMsS0FBSyxHQUFHLE1BQU0sRUFBRSxDQUFDLENBQUMsRUFBRSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQTtJQUNwRSxDQUFDO0lBRU0sR0FBRyxDQUFDLENBQVM7UUFDaEIsT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFBO0lBQ3ZCLENBQUM7SUFFTSxFQUFFLENBQUMsQ0FBUyxFQUFFLENBQVM7UUFDMUIsT0FBTyxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUE7SUFDcEMsQ0FBQztJQUVNLElBQUksQ0FBQyxDQUFTLEVBQUUsQ0FBUztRQUM1QixPQUFPLENBQUMsR0FBRyxJQUFJLENBQUMsS0FBSyxHQUFHLENBQUMsQ0FBQTtJQUM3QixDQUFDO0lBRU0sR0FBRyxDQUFJLENBQWtCO1FBQzVCLE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUE7SUFDM0IsQ0FBQztJQUVNLENBQUMsQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDO1FBQ3JCLEtBQUssTUFBTSxDQUFDLElBQUksSUFB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LENBQUMsQ0FBQTtJQUNwQyxNQUFNLENBQUMsR0FBRyxpQkFBaUIsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUE7SUFDcEMsTUFBTSxDQUFDLEdBQUcsaUJBQWlCLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFBO0lBQ3BDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQTtJQUM5QyxPQUFPLENBQUMsQ0FBQTtBQUNaLENBQUM7QUFFRCxNQUFNLFVBQVUsV0FBVyxDQUFDLENBQVM7SUFDakMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQUcsVUFBVSxDQUFDLEtBQUssRUFBRSxDQUFBO0lBQ2pDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFHLFVBQVUsQ0FBQyxLQUFLLEVBQUUsQ0FBQTtJQUNqQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsR0FBRyxVQUFVLENBQUMsS0FBSyxDQUFDLENBQUE7SUFDaEMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxHQUFHLFVBQVUsQ0FBQTtJQUV4QixPQUFPLElBQUksS0FBSyxDQUNaLG1CQUFtQixDQUFDLENBQUMsQ0FBQyxFQUN0QixtQkFBbUIsQ0FBQyxDQUFDLENBQUMsRUFDdEIsbUJBQW1CLENBQUMsQ0FBQyxDQUFDLEVBQ3RCLG1CQUFtQixDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUE7QUFDL0IsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIGdlbyBmcm9tIFwiLi4vc2hhcmVkL2dlbzNkLmpzXCJcclxuaW1wb3J0ICogYXMgYXJyYXkgZnJvbSBcIi4uL3NoYXJlZC9hcnJheS5qc1wiXHJcblxyXG5leHBvcnQgY2xhc3MgQ29sb3IgZXh0ZW5kcyBnZW8uVmVjNCB7XHJcblxyXG59XHJcblxyXG5leHBvcnQgY2xhc3MgSW1hZ2Uge1xyXG4gICAgcHVibGljIHJlYWRvbmx5IGRhdGE6IENvbG9yW11cclxuXHJcbiAgICBjb25zdHJ1Y3RvcihwdWJsaWMgcmVhZG9ubHkgd2lkdGg6IG51bWJlciwgcHVibGljIHJlYWRvbmx5IGhlaWdodDogbnVtYmVyKSB7XHJcbiAgICAgICAgdGhpcy5kYXRhID0gYXJyYXkuZ2VuZXJhdGUod2lkdGggKiBoZWlnaHQsIF8gPT4gZ2VvLlZlYzQuemVybygpKVxyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBhdGYoaTogbnVtYmVyKTogQ29sb3Ige1xyXG4gICAgICAgIHJldHVybiB0aGlzLmRhdGFbaV1cclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgYXQoeDogbnVtYmVyLCB5OiBudW1iZXIpOiBDb2xvciB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuYXRmKHRoaXMuZmxhdCh4LCB5KSlcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgZmxhdCh4OiBudW1iZXIsIHk6IG51bWJlcik6IG51bWJlciB7XHJcbiAgICAgICAgcmV0dXJuIHkgKiB0aGlzLndpZHRoICsgeFxyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBtYXA8VD4oZjogKHg6IENvbG9yKSA9PiBUKTogVFtdIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5kYXRhLm1hcChmKVxyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyAqW1N5bWJvbC5pdGVyYXRvcl0oKSB7XHJcbiAgICAgICAgZm9yIChjb25zdCB4IG9mIHRoaXMuZGF0YSkge1xyXG4gICAgICAgICAgICB5aWVsZCB4XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBzY2FuKGY6ICh4OiBudW1iZXIsIHk6IG51bWJlciwgb2Zmc2V0OiBudW1iZXIpID0+IHZvaWQpOiB2b2lkIHtcclxuICAgICAgICBmb3IgKGxldCB5ID0gMDsgeSA8IHRoaXMuaGVpZ2h0OyArK3kpIHtcclxuICAgICAgICAgICAgY29uc3QgeU9mZnNldCA9IHkgKiB0aGlzLndpZHRoXHJcbiAgICAgICAgICAgIGZvciAobGV0IHggPSAwOyB4IDwgdGhpcy53aWR0aDsgKyt4KSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCB4T2Zmc2V0ID0geU9mZnNldCArIHhcclxuICAgICAgICAgICAgICAgIGYoeCwgeSwgeE9mZnNldClcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGZyb21DYW52YXNJbWFnZURhdGEoaW1hZ2VEYXRhOiBJbWFnZURhdGEpOiBJbWFnZSB7XHJcbiAgICBjb25zdCB7IHdpZHRoLCBoZWlnaHQsIGRhdGEgfSA9IGltYWdlRGF0YVxyXG4gICAgY29uc3QgbnVtUGl4ZWxzID0gd2lkdGggKiBoZWlnaHRcclxuICAgIGNvbnN0IGltYWdlID0gbmV3IEltYWdlKHdpZHRoLCBoZWlnaHQpXHJcblxyXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBudW1QaXhlbHM7ICsraSkge1xyXG4gICAgICAgIGNvbnN0IGlpID0gaSAqIDRcclxuICAgICAgICBjb25zdCBjb2xvciA9IGltYWdlLmF0ZihpKVxyXG4gICAgICAgIGNvbG9yLnggPSBkYXRhW2lpXSAvIDI1NVxyXG4gICAgICAgIGNvbG9yLnkgPSBkYXRhW2lpICsgMV0gLyAyNTVcclxuICAgICAgICBjb2xvci56ID0gZGF0YVtpaSArIDJdIC8gMjU1XHJcbiAgICAgICAgY29sb3IudyA9IGRhdGFbaWkgKyAzXSAvIDI1NVxyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiBpbWFnZVxyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gdG9DYW52YXNJbWFnZURhdGEoaW1hZ2U6IEltYWdlKTogSW1hZ2VEYXRhIHtcclxuICAgIGNvbnN0IHsgd2lkdGgsIGhlaWdodCB9ID0gaW1hZ2VcclxuICAgIGNvbnN0IHBpeGVscyA9IHdpZHRoICogaGVpZ2h0XHJcbiAgICBjb25zdCBpbWFnZURhdGEgPSBuZXcgSW1hZ2VEYXRhKHdpZHRoLCBoZWlnaHQpXHJcbiAgICBjb25zdCBkYXRhID0gaW1hZ2VEYXRhLmRhdGFcclxuXHJcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHBpeGVsczsgKytpKSB7XHJcbiAgICAgICAgY29uc3QgaWkgPSBpICogNFxyXG4gICAgICAgIGNvbnN0IGNvbG9yID0gaW1hZ2UuYXRmKGkpXHJcbiAgICAgICAgZGF0YVtpaV0gPSBNYXRoLmZsb29yKGNvbG9yLnggKiAyNTUpXHJcbiAgICAgICAgZGF0YVtpaSArIDFdID0gTWF0aC5mbG9vcihjb2xvci55ICogMjU1KVxyXG4gICAgICAgIGRhdGFbaWkgKyAyXSA9IE1hdGguZmxvb3IoY29sb3IueiAqIDI1NSlcclxuICAgICAgICBkYXRhW2lpICsgM10gPSBNYXRoLmZsb29yKGNvbG9yLncgKiAyNTUpXHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIGltYWdlRGF0YVxyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gcGFsZXR0aXplSGlzdG9ncmFtKGltYWdlOiBJbWFnZSwgYnVja2V0c1BlckNvbXBvbmVudDogbnVtYmVyLCBtYXhDb2xvcnM6IG51bWJlcikge1xyXG4gICAgY29uc3QgYnVja2V0UGl0Y2ggPSBidWNrZXRzUGVyQ29tcG9uZW50ICogYnVja2V0c1BlckNvbXBvbmVudFxyXG4gICAgY29uc3QgbnVtQnVja2V0cyA9IGJ1Y2tldFBpdGNoICogYnVja2V0c1BlckNvbXBvbmVudFxyXG5cclxuICAgIC8vIGNyZWF0ZSBpbnRpYWwgYnVja2V0c1xyXG4gICAgY29uc3QgYnVja2V0cyA9IGFycmF5LmdlbmVyYXRlKG51bUJ1Y2tldHMsICgpID0+ICh7IGNvbG9yOiBnZW8uVmVjNC56ZXJvKCksIHBpeGVsczogMCB9KSlcclxuXHJcbiAgICAvLyBhc3NpZ24gYW5kIHVwZGF0ZSBidWNrZXQgZm9yIGVhY2ggcGl4ZWxcclxuICAgIGNvbnN0IGJ1Y2tldE92ZXJsYXkgPSBpbWFnZS5tYXAoY29sb3IgPT4ge1xyXG4gICAgICAgIGNvbnN0IHJiID0gTWF0aC5taW4oTWF0aC5mbG9vcihjb2xvci54ICogYnVja2V0c1BlckNvbXBvbmVudCksIGJ1Y2tldHNQZXJDb21wb25lbnQgLSAxKVxyXG4gICAgICAgIGNvbnN0IGdiID0gTWF0aC5taW4oTWF0aC5mbG9vcihjb2xvci55ICogYnVja2V0c1BlckNvbXBvbmVudCksIGJ1Y2tldHNQZXJDb21wb25lbnQgLSAxKVxyXG4gICAgICAgIGNvbnN0IGJiID0gTWF0aC5taW4oTWF0aC5mbG9vcihjb2xvci56ICogYnVja2V0c1BlckNvbXBvbmVudCksIGJ1Y2tldHNQZXJDb21wb25lbnQgLSAxKVxyXG4gICAgICAgIGNvbnN0IGJ1Y2tldElkeCA9IHJiICogYnVja2V0UGl0Y2ggKyBnYiAqIGJ1Y2tldHNQZXJDb21wb25lbnQgKyBiYlxyXG4gICAgICAgIGNvbnN0IGJ1Y2tldCA9IGJ1Y2tldHNbYnVja2V0SWR4XVxyXG4gICAgICAgIGJ1Y2tldC5jb2xvciA9IGJ1Y2tldC5jb2xvci5hZGQoY29sb3IpXHJcbiAgICAgICAgYnVja2V0LnBpeGVscysrXHJcbiAgICAgICAgcmV0dXJuIGJ1Y2tldFxyXG4gICAgfSlcclxuXHJcbiAgICAvLyBjYWxjdWxhdGUgYnVja2V0IGNvbG9yc1xyXG4gICAgZm9yIChjb25zdCBidWNrZXQgb2YgYnVja2V0cykge1xyXG4gICAgICAgIGJ1Y2tldC5jb2xvciA9IGJ1Y2tldC5jb2xvci5kaXZYKGJ1Y2tldC5waXhlbHMpXHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgdG9wQnVja2V0cyA9IGJ1Y2tldHNcclxuICAgICAgICAuc29ydCgoYjEsIGIyKSA9PiBiMi5waXhlbHMgLSBiMS5waXhlbHMpXHJcbiAgICAgICAgLnNsaWNlKDAsIG1heENvbG9ycylcclxuXHJcbiAgICBjb25zdCBidWNrZXRTZXQgPSBuZXcgU2V0KHRvcEJ1Y2tldHMpXHJcblxyXG4gICAgLy8gbWFwIGFsbCBjb2xvcnMgdG8gdG9wIE4gYnVja2V0c1xyXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBidWNrZXRPdmVybGF5Lmxlbmd0aDsgKytpKSB7XHJcbiAgICAgICAgLy8gaWYgY29sb3IgaXMgYSByZW1haW5pbmcgY29sb3IsIGNvbnRpbnVlXHJcbiAgICAgICAgLy8gb3RoZXJ3aXNlIHJlcGxhY2Ugd2l0aCBuZWFyZXN0IHRvcCBidWNrZXRcclxuICAgICAgICBpZiAoYnVja2V0U2V0LmhhcyhidWNrZXRPdmVybGF5W2ldKSkge1xyXG4gICAgICAgICAgICBjb250aW51ZVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgY29uc3QgY29sb3IgPSBpbWFnZS5hdGYoaSlcclxuICAgICAgICBjb25zdCBidWNrZXQgPSB0b3BCdWNrZXRzLnJlZHVjZSgoYjEsIGIyKSA9PiBiMS5jb2xvci54eXouc3ViKGNvbG9yLnh5eikubGVuZ3RoU3EoKSA8IGIyLmNvbG9yLnh5ei5zdWIoY29sb3IueHl6KS5sZW5ndGhTcSgpID8gYjEgOiBiMilcclxuICAgICAgICBidWNrZXRPdmVybGF5W2ldID0gYnVja2V0XHJcbiAgICB9XHJcblxyXG4gICAgLy8gcmVwbGFjZSBjb2xvcnMgd2l0aCBidWNrZXQgY29sb3JzXHJcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGJ1Y2tldE92ZXJsYXkubGVuZ3RoOyArK2kpIHtcclxuICAgICAgICBpbWFnZS5hdGYoaSkuc2V0KGJ1Y2tldE92ZXJsYXlbaV0uY29sb3IpXHJcbiAgICB9XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiB1bmlxdWVDb2xvcnMoaW1nOiBJbWFnZSk6IENvbG9yW10ge1xyXG4gICAgY29uc3Qgc2V0ID0gbmV3IFNldDxudW1iZXI+KClcclxuXHJcbiAgICBmb3IgKGNvbnN0IGNvbG9yIG9mIGltZykge1xyXG4gICAgICAgIHNldC5hZGQocGFja0NvbG9yKGNvbG9yKSlcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBjb2xvcnMgPSBbLi4uc2V0XS5tYXAobiA9PiB1bnBhY2tDb2xvcihuKSlcclxuICAgIHJldHVybiBjb2xvcnNcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGluZGV4QnlDb2xvcihpbWc6IEltYWdlLCBjb2xvcnM6IENvbG9yW10pOiBudW1iZXJbXSB7XHJcbiAgICBjb25zdCBpZHhzID0gaW1nLm1hcChjMSA9PiBjb2xvcnMuZmluZEluZGV4KGMyID0+IGMxLmVxdWFsKGMyKSkpXHJcbiAgICByZXR1cm4gaWR4c1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gY2FsY0x1bWluYW5jZShjb2xvcjogQ29sb3IpIHtcclxuICAgIGNvbnN0IGwgPSAwLjIxMjYgKiAoY29sb3IueCAvIDI1NSkgKyAwLjcxNTIgKiAoY29sb3IueSAvIDI1NSkgKyAwLjA3MjIgKiAoY29sb3IueiAvIDI1NSlcclxuICAgIHJldHVybiBsXHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiB0b0NhbnZhc0NvbG9yKGNvbG9yOiBDb2xvcik6IENvbG9yIHtcclxuICAgIGNvbnN0IHIgPSBjb2xvci5tdWxYKDI1NSkuZmxvb3IoKVxyXG4gICAgcmV0dXJuIHJcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGZyb21DYW52YXNDb2xvcihjb2xvcjogQ29sb3IpOiBDb2xvciB7XHJcbiAgICBjb25zdCByID0gY29sb3IuZGl2WCgyNTUpXHJcbiAgICByZXR1cm4gclxyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gdG9DYW52YXNDb21wb25lbnQoeDogbnVtYmVyKTogbnVtYmVyIHtcclxuICAgIGNvbnN0IHkgPSBNYXRoLmZsb29yKHggKiAyNTUpXHJcbiAgICByZXR1cm4geVxyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gZnJvbUNhbnZhc0NvbXBvbmVudCh4OiBudW1iZXIpOiBudW1iZXIge1xyXG4gICAgY29uc3QgeSA9IHggLyAyNTVcclxuICAgIHJldHVybiB5XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBwYWNrQ29sb3IoY29sb3I6IENvbG9yKTogbnVtYmVyIHtcclxuICAgIGNvbnN0IHIgPSB0b0NhbnZhc0NvbXBvbmVudChjb2xvci54KVxyXG4gICAgY29uc3QgZyA9IHRvQ2FudmFzQ29tcG9uZW50KGNvbG9yLnkpXHJcbiAgICBjb25zdCBiID0gdG9DYW52YXNDb21wb25lbnQoY29sb3IueilcclxuICAgIGNvbnN0IGEgPSB0b0NhbnZhc0NvbXBvbmVudChjb2xvci53KVxyXG4gICAgY29uc3QgbiA9IChyIDw8IDI0KSB8IChnIDw8IDE2KSB8IChiIDw8IDgpIHwgYVxyXG4gICAgcmV0dXJuIG5cclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIHVucGFja0NvbG9yKG46IG51bWJlcik6IENvbG9yIHtcclxuICAgIGNvbnN0IHIgPSAobiAmIDB4RkYwMDAwMDApID4+PiAyNFxyXG4gICAgY29uc3QgZyA9IChuICYgMHgwMEZGMDAwMCkgPj4+IDE2XHJcbiAgICBjb25zdCBiID0gKG4gJiAweDAwMDBGRjAwKSA+Pj4gOFxyXG4gICAgY29uc3QgYSA9IG4gJiAweDAwMDAwMEZGXHJcblxyXG4gICAgcmV0dXJuIG5ldyBDb2xvcihcclxuICAgICAgICBmcm9tQ2FudmFzQ29tcG9uZW50KHIpLFxyXG4gICAgICAgIGZyb21DYW52YXNDb21wb25lbnQoZyksXHJcbiAgICAgICAgZnJvbUNhbnZhc0NvbXBvbmVudChiKSxcclxuICAgICAgICBmcm9tQ2FudmFzQ29tcG9uZW50KGEpKVxyXG59Il19