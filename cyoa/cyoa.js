import * as util from "../shared/util.js";
init();
const state = {
    currentModule: null,
    currentPassage: null,
    currentChoice: null
};
function init() {
    initLoadUi();
    initPlayUi();
}
function initLoadUi() {
    const fileDropBox = util.byId("fileDropBox");
    const fileInput = util.byId("fileInput");
    const fileButton = util.byId("fileButton");
    const urlInput = util.byId("urlInput");
    const loadButton = util.byId("urlButton");
    fileButton.addEventListener("click", () => {
        fileInput.click();
    });
    fileDropBox.addEventListener("dragenter", onDragEnterOver);
    fileDropBox.addEventListener("dragover", onDragEnterOver);
    fileDropBox.addEventListener("drop", onFileDrop);
    fileInput.addEventListener("change", () => {
        if (!fileInput.files) {
            return;
        }
        processFiles(fileInput.files);
    });
    loadButton.addEventListener("click", () => {
        clearErrorMessages();
        const url = urlInput.value;
        if (!url) {
            appendErrorMessage("A valid url is required");
            return;
        }
        loadFromUrl(url);
    });
    // for now - debug current game
    loadFromUrl("ana.cyoa.json");
}
function initPlayUi() {
    const choices = util.byId("choices");
    const tryAgain = util.byId("tryAgain");
    const nextPassage = util.byId("nextPassage");
    util.delegate(choices, "click", ".choice", (ev) => {
        if (!state.currentModule) {
            return;
        }
        if (!state.currentPassage) {
            return;
        }
        const choiceIdx = util.getElementIndex(ev.target);
        const choice = state.currentPassage.choices[choiceIdx];
        handleChoice(state.currentModule, choice);
    });
    tryAgain.addEventListener("click", () => {
        if (!state.currentModule) {
            return;
        }
        loadModule(state.currentModule);
    });
    nextPassage.addEventListener("click", () => {
        var _a, _b;
        const passageId = (_a = state === null || state === void 0 ? void 0 : state.currentChoice) === null || _a === void 0 ? void 0 : _a.passageId;
        if (!passageId) {
            return;
        }
        const passage = (_b = state.currentModule) === null || _b === void 0 ? void 0 : _b.passages[passageId];
        if (!passage) {
            return;
        }
        loadPassage(passage);
    });
}
function loadFromString(json) {
    const module = util.tryf(() => (JSON.parse(json)));
    if (module instanceof Error) {
        appendErrorMessage(module.message);
        return;
    }
    if (!validateModule(module)) {
        return;
    }
    // module is valid - proceed
    loadModule(module);
}
function onDragEnterOver(ev) {
    ev.stopPropagation();
    ev.preventDefault();
}
function onFileDrop(ev) {
    ev.stopPropagation();
    ev.preventDefault();
    if (ev.dataTransfer == null) {
        return;
    }
    processFiles(ev.dataTransfer.files);
}
async function loadFromUrl(url) {
    const response = await util.tryf(() => fetch(url));
    if (response instanceof Error) {
        appendErrorMessage(response.message);
        return;
    }
    if (response.status != 200) {
        appendErrorMessage(`Could not load ${url}, unsuccessful response: ${response.status} - ${response.statusText}.`);
        return;
    }
    const json = await response.text();
    loadFromString(json);
}
async function processFiles(files) {
    if (files.length == 0) {
        return;
    }
    const file = files[0];
    const json = await file.text();
    loadFromString(json);
}
function loadModule(module) {
    state.currentModule = module;
    const loadUi = util.byId("loadUi");
    const playUi = util.byId("playUi");
    loadUi.hidden = true;
    playUi.hidden = false;
    // load module title
    const moduleTitle = util.byId("moduleTitle");
    moduleTitle.textContent = module.title;
    // load initial passage
    const intro = module.passages["intro"];
    loadPassage(intro);
}
function loadPassage(passage) {
    const passageTitle = util.byId("passageTitle");
    const passageBody = util.byId("passageBody");
    const choicesDiv = util.byId("choices");
    util.removeAllChildren(choicesDiv);
    passageTitle.textContent = passage.title;
    passageBody.textContent = passage.body;
    const template = util.byId("choiceTemplate");
    for (const choice of passage.choices) {
        const fragment = template.content.cloneNode(true);
        const choiceDiv = util.bySelector(fragment, ".choice");
        choiceDiv.textContent = choice.body;
        choicesDiv.appendChild(fragment);
    }
    const tryAgain = util.byId("tryAgain");
    const end = util.byId("end");
    const nextPassage = util.byId("nextPassage");
    nextPassage.hidden = true;
    if (passage.choices.length == 0) {
        end.hidden = false;
        tryAgain.hidden = false;
    }
    else {
        end.hidden = true;
        tryAgain.hidden = true;
    }
    state.currentPassage = passage;
}
function loadTransition(choice) {
    const passageTitle = util.byId("passageTitle");
    const passageBody = util.byId("passageBody");
    const choicesDiv = util.byId("choices");
    util.removeAllChildren(choicesDiv);
    passageTitle.textContent = "";
    passageBody.textContent = choice.transition;
    const tryAgain = util.byId("tryAgain");
    const end = util.byId("end");
    const nextPassage = util.byId("nextPassage");
    if (choice.passageId) {
        nextPassage.hidden = false;
        end.hidden = true;
        tryAgain.hidden = true;
    }
    else {
        end.hidden = false;
        tryAgain.hidden = false;
        nextPassage.hidden = true;
    }
    state.currentChoice = choice;
}
function clearErrorMessages() {
    const errorsDiv = util.byId("errors");
    util.removeAllChildren(errorsDiv);
}
function validateModule(module) {
    clearErrorMessages();
    if (!module) {
        appendErrorMessage("No module was found - .json file should contain a top level module object.");
        return false;
    }
    if (!module.title) {
        appendErrorMessage("Module title is required.");
        return false;
    }
    if (!module.description) {
        appendErrorMessage("Module description is required.");
        return false;
    }
    if (!module.passages) {
        appendErrorMessage("Module must contain at least one passage.");
        return false;
    }
    const passages = Object.values(module.passages);
    let valid = true;
    for (const passage of passages) {
        const passageValid = validatePassage(module, passage);
        valid = valid && passageValid;
    }
    return valid;
}
function validatePassage(module, passage) {
    var _a;
    let valid = true;
    if (!passage.body) {
        appendErrorMessage("Each passage must have a body.");
        valid = false;
    }
    passage.choices = (_a = passage.choices) !== null && _a !== void 0 ? _a : [];
    for (const choice of passage.choices) {
        const choiceValid = validateChoice(module, choice);
        valid = valid && choiceValid;
    }
    return valid;
}
function validateChoice(module, choice) {
    let valid = true;
    if (!choice.body) {
        appendErrorMessage("Each choice must have a body.");
        valid = false;
    }
    if (!choice.passageId && !choice.transition) {
        appendErrorMessage("Each choice must have either a passageId or a transition.");
        valid = false;
    }
    if (choice.passageId && !(choice.passageId in module.passages)) {
        appendErrorMessage(`Could not find passage with id of ${choice.passageId}`);
        valid = false;
    }
    return valid;
}
function appendErrorMessage(error) {
    console.log(error);
    const errorsDiv = util.byId("errors");
    const div = document.createElement("div");
    div.classList.add("error-message");
    div.textContent = error;
    errorsDiv.appendChild(div);
}
function handleChoice(module, choice) {
    if (choice.transition) {
        loadTransition(choice);
        return;
    }
    const passageId = choice.passageId;
    if (!passageId) {
        throw Error(`No transition or passageId for choice: ${choice.body}`);
    }
    const passage = module.passages[passageId];
    if (!passage) {
        throw Error(`Missing passage for choice: ${choice.body} with id ${passageId}`);
    }
    loadPassage(passage);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3lvYS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImN5b2EudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxLQUFLLElBQUksTUFBTSxtQkFBbUIsQ0FBQTtBQUV6QyxJQUFJLEVBQUUsQ0FBQTtBQTBCTixNQUFNLEtBQUssR0FBVTtJQUNqQixhQUFhLEVBQUUsSUFBSTtJQUNuQixjQUFjLEVBQUUsSUFBSTtJQUNwQixhQUFhLEVBQUUsSUFBSTtDQUN0QixDQUFBO0FBRUQsU0FBUyxJQUFJO0lBQ1QsVUFBVSxFQUFFLENBQUE7SUFDWixVQUFVLEVBQUUsQ0FBQTtBQUNoQixDQUFDO0FBRUQsU0FBUyxVQUFVO0lBQ2YsTUFBTSxXQUFXLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxhQUFhLENBQW1CLENBQUE7SUFDOUQsTUFBTSxTQUFTLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQXFCLENBQUE7SUFDNUQsTUFBTSxVQUFVLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxZQUFZLENBQXNCLENBQUE7SUFDL0QsTUFBTSxRQUFRLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQXFCLENBQUE7SUFDMUQsTUFBTSxVQUFVLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQXNCLENBQUE7SUFFOUQsVUFBVSxDQUFDLGdCQUFnQixDQUFDLE9BQU8sRUFBRSxHQUFHLEVBQUU7UUFDdEMsU0FBUyxDQUFDLEtBQUssRUFBRSxDQUFBO0lBQ3JCLENBQUMsQ0FBQyxDQUFBO0lBRUYsV0FBVyxDQUFDLGdCQUFnQixDQUFDLFdBQVcsRUFBRSxlQUFlLENBQUMsQ0FBQTtJQUMxRCxXQUFXLENBQUMsZ0JBQWdCLENBQUMsVUFBVSxFQUFFLGVBQWUsQ0FBQyxDQUFBO0lBQ3pELFdBQVcsQ0FBQyxnQkFBZ0IsQ0FBQyxNQUFNLEVBQUUsVUFBVSxDQUFDLENBQUE7SUFFaEQsU0FBUyxDQUFDLGdCQUFnQixDQUFDLFFBQVEsRUFBRSxHQUFHLEVBQUU7UUFDdEMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxLQUFLLEVBQUU7WUFDbEIsT0FBTTtTQUNUO1FBRUQsWUFBWSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsQ0FBQTtJQUNqQyxDQUFDLENBQUMsQ0FBQTtJQUVGLFVBQVUsQ0FBQyxnQkFBZ0IsQ0FBQyxPQUFPLEVBQUUsR0FBRyxFQUFFO1FBQ3RDLGtCQUFrQixFQUFFLENBQUE7UUFFcEIsTUFBTSxHQUFHLEdBQUcsUUFBUSxDQUFDLEtBQUssQ0FBQTtRQUMxQixJQUFJLENBQUMsR0FBRyxFQUFFO1lBQ04sa0JBQWtCLENBQUMseUJBQXlCLENBQUMsQ0FBQTtZQUM3QyxPQUFNO1NBQ1Q7UUFFRCxXQUFXLENBQUMsR0FBRyxDQUFDLENBQUE7SUFDcEIsQ0FBQyxDQUFDLENBQUE7SUFFRiwrQkFBK0I7SUFDL0IsV0FBVyxDQUFDLGVBQWUsQ0FBQyxDQUFBO0FBQ2hDLENBQUM7QUFFRCxTQUFTLFVBQVU7SUFDZixNQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFBO0lBQ3BDLE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUE7SUFDdEMsTUFBTSxXQUFXLEdBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsQ0FBQTtJQUU3QyxJQUFJLENBQUMsUUFBUSxDQUFDLE9BQU8sRUFBRSxPQUFPLEVBQUUsU0FBUyxFQUFFLENBQUMsRUFBRSxFQUFFLEVBQUU7UUFDOUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxhQUFhLEVBQUU7WUFDdEIsT0FBTTtTQUNUO1FBRUQsSUFBSSxDQUFDLEtBQUssQ0FBQyxjQUFjLEVBQUU7WUFDdkIsT0FBTTtTQUNUO1FBRUQsTUFBTSxTQUFTLEdBQUcsSUFBSSxDQUFDLGVBQWUsQ0FBQyxFQUFFLENBQUMsTUFBaUIsQ0FBQyxDQUFBO1FBQzVELE1BQU0sTUFBTSxHQUFHLEtBQUssQ0FBQyxjQUFjLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFBO1FBQ3RELFlBQVksQ0FBQyxLQUFLLENBQUMsYUFBYSxFQUFFLE1BQU0sQ0FBQyxDQUFBO0lBQzdDLENBQUMsQ0FBQyxDQUFBO0lBRUYsUUFBUSxDQUFDLGdCQUFnQixDQUFDLE9BQU8sRUFBRSxHQUFHLEVBQUU7UUFDcEMsSUFBSSxDQUFDLEtBQUssQ0FBQyxhQUFhLEVBQUU7WUFDdEIsT0FBTTtTQUNUO1FBRUQsVUFBVSxDQUFDLEtBQUssQ0FBQyxhQUFhLENBQUMsQ0FBQTtJQUNuQyxDQUFDLENBQUMsQ0FBQTtJQUVGLFdBQVcsQ0FBQyxnQkFBZ0IsQ0FBQyxPQUFPLEVBQUUsR0FBRyxFQUFFOztRQUN2QyxNQUFNLFNBQVMsU0FBRyxLQUFLLGFBQUwsS0FBSyx1QkFBTCxLQUFLLENBQUUsYUFBYSwwQ0FBRSxTQUFTLENBQUE7UUFDakQsSUFBSSxDQUFDLFNBQVMsRUFBRTtZQUNaLE9BQU07U0FDVDtRQUVELE1BQU0sT0FBTyxTQUFHLEtBQUssQ0FBQyxhQUFhLDBDQUFFLFFBQVEsQ0FBQyxTQUFTLENBQUMsQ0FBQTtRQUN4RCxJQUFJLENBQUMsT0FBTyxFQUFFO1lBQ1YsT0FBTTtTQUNUO1FBRUQsV0FBVyxDQUFDLE9BQU8sQ0FBQyxDQUFBO0lBQ3hCLENBQUMsQ0FBQyxDQUFBO0FBQ04sQ0FBQztBQUVELFNBQVMsY0FBYyxDQUFDLElBQVk7SUFDaEMsTUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBUyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFBO0lBQzFELElBQUksTUFBTSxZQUFZLEtBQUssRUFBRTtRQUN6QixrQkFBa0IsQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLENBQUE7UUFDbEMsT0FBTTtLQUNUO0lBRUQsSUFBSSxDQUFDLGNBQWMsQ0FBQyxNQUFNLENBQUMsRUFBRTtRQUN6QixPQUFNO0tBQ1Q7SUFFRCw0QkFBNEI7SUFDNUIsVUFBVSxDQUFDLE1BQU0sQ0FBQyxDQUFBO0FBQ3RCLENBQUM7QUFFRCxTQUFTLGVBQWUsQ0FBQyxFQUFhO0lBQ2xDLEVBQUUsQ0FBQyxlQUFlLEVBQUUsQ0FBQTtJQUNwQixFQUFFLENBQUMsY0FBYyxFQUFFLENBQUE7QUFDdkIsQ0FBQztBQUVELFNBQVMsVUFBVSxDQUFDLEVBQWE7SUFDN0IsRUFBRSxDQUFDLGVBQWUsRUFBRSxDQUFBO0lBQ3BCLEVBQUUsQ0FBQyxjQUFjLEVBQUUsQ0FBQTtJQUVuQixJQUFJLEVBQUUsQ0FBQyxZQUFZLElBQUksSUFBSSxFQUFFO1FBQ3pCLE9BQU07S0FDVDtJQUVELFlBQVksQ0FBQyxFQUFFLENBQUMsWUFBWSxDQUFDLEtBQUssQ0FBQyxDQUFBO0FBQ3ZDLENBQUM7QUFFRCxLQUFLLFVBQVUsV0FBVyxDQUFDLEdBQVc7SUFDbEMsTUFBTSxRQUFRLEdBQUcsTUFBTSxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFBO0lBQ2xELElBQUksUUFBUSxZQUFZLEtBQUssRUFBRTtRQUMzQixrQkFBa0IsQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLENBQUE7UUFDcEMsT0FBTTtLQUNUO0lBRUQsSUFBSSxRQUFRLENBQUMsTUFBTSxJQUFJLEdBQUcsRUFBRTtRQUN4QixrQkFBa0IsQ0FBQyxrQkFBa0IsR0FBRyw0QkFBNEIsUUFBUSxDQUFDLE1BQU0sTUFBTSxRQUFRLENBQUMsVUFBVSxHQUFHLENBQUMsQ0FBQTtRQUNoSCxPQUFNO0tBQ1Q7SUFFRCxNQUFNLElBQUksR0FBRyxNQUFNLFFBQVEsQ0FBQyxJQUFJLEVBQUUsQ0FBQTtJQUNsQyxjQUFjLENBQUMsSUFBSSxDQUFDLENBQUE7QUFDeEIsQ0FBQztBQUVELEtBQUssVUFBVSxZQUFZLENBQUMsS0FBZTtJQUN2QyxJQUFJLEtBQUssQ0FBQyxNQUFNLElBQUksQ0FBQyxFQUFFO1FBQ25CLE9BQU07S0FDVDtJQUVELE1BQU0sSUFBSSxHQUFHLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQTtJQUNyQixNQUFNLElBQUksR0FBRyxNQUFNLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQTtJQUM5QixjQUFjLENBQUMsSUFBSSxDQUFDLENBQUE7QUFDeEIsQ0FBQztBQUVELFNBQVMsVUFBVSxDQUFDLE1BQWM7SUFDOUIsS0FBSyxDQUFDLGFBQWEsR0FBRyxNQUFNLENBQUE7SUFDNUIsTUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQztJQUNuQyxNQUFNLE1BQU0sR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO0lBQ25DLE1BQU0sQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDO0lBQ3JCLE1BQU0sQ0FBQyxNQUFNLEdBQUcsS0FBSyxDQUFDO0lBRXRCLG9CQUFvQjtJQUNwQixNQUFNLFdBQVcsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxDQUFBO0lBQzVDLFdBQVcsQ0FBQyxXQUFXLEdBQUcsTUFBTSxDQUFDLEtBQUssQ0FBQTtJQUV0Qyx1QkFBdUI7SUFDdkIsTUFBTSxLQUFLLEdBQUcsTUFBTSxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsQ0FBQTtJQUN0QyxXQUFXLENBQUMsS0FBSyxDQUFDLENBQUE7QUFDdEIsQ0FBQztBQUVELFNBQVMsV0FBVyxDQUFDLE9BQWdCO0lBQ2pDLE1BQU0sWUFBWSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsY0FBYyxDQUFDLENBQUE7SUFDOUMsTUFBTSxXQUFXLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsQ0FBQTtJQUM1QyxNQUFNLFVBQVUsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFBO0lBQ3ZDLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxVQUFVLENBQUMsQ0FBQTtJQUVsQyxZQUFZLENBQUMsV0FBVyxHQUFHLE9BQU8sQ0FBQyxLQUFLLENBQUE7SUFDeEMsV0FBVyxDQUFDLFdBQVcsR0FBRyxPQUFPLENBQUMsSUFBSSxDQUFBO0lBRXRDLE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLENBQXdCLENBQUE7SUFDbkUsS0FBSyxNQUFNLE1BQU0sSUFBSSxPQUFPLENBQUMsT0FBTyxFQUFFO1FBQ2xDLE1BQU0sUUFBUSxHQUFHLFFBQVEsQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBcUIsQ0FBQTtRQUNyRSxNQUFNLFNBQVMsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLFFBQVEsRUFBRSxTQUFTLENBQWdCLENBQUE7UUFDckUsU0FBUyxDQUFDLFdBQVcsR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFBO1FBQ25DLFVBQVUsQ0FBQyxXQUFXLENBQUMsUUFBUSxDQUFDLENBQUE7S0FDbkM7SUFFRCxNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFBO0lBQ3RDLE1BQU0sR0FBRyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUE7SUFDNUIsTUFBTSxXQUFXLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsQ0FBQTtJQUU1QyxXQUFXLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQTtJQUN6QixJQUFJLE9BQU8sQ0FBQyxPQUFPLENBQUMsTUFBTSxJQUFJLENBQUMsRUFBRTtRQUM3QixHQUFHLENBQUMsTUFBTSxHQUFHLEtBQUssQ0FBQTtRQUNsQixRQUFRLENBQUMsTUFBTSxHQUFHLEtBQUssQ0FBQTtLQUMxQjtTQUFNO1FBQ0gsR0FBRyxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUE7UUFDakIsUUFBUSxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUE7S0FDekI7SUFFRCxLQUFLLENBQUMsY0FBYyxHQUFHLE9BQU8sQ0FBQTtBQUNsQyxDQUFDO0FBRUQsU0FBUyxjQUFjLENBQUMsTUFBYztJQUNsQyxNQUFNLFlBQVksR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxDQUFBO0lBQzlDLE1BQU0sV0FBVyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLENBQUE7SUFDNUMsTUFBTSxVQUFVLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQTtJQUN2QyxJQUFJLENBQUMsaUJBQWlCLENBQUMsVUFBVSxDQUFDLENBQUE7SUFFbEMsWUFBWSxDQUFDLFdBQVcsR0FBRyxFQUFFLENBQUE7SUFDN0IsV0FBVyxDQUFDLFdBQVcsR0FBRyxNQUFNLENBQUMsVUFBVSxDQUFBO0lBRTNDLE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUE7SUFDdEMsTUFBTSxHQUFHLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQTtJQUM1QixNQUFNLFdBQVcsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxDQUFBO0lBRTVDLElBQUksTUFBTSxDQUFDLFNBQVMsRUFBRTtRQUNsQixXQUFXLENBQUMsTUFBTSxHQUFHLEtBQUssQ0FBQTtRQUMxQixHQUFHLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQTtRQUNqQixRQUFRLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQTtLQUN6QjtTQUFNO1FBQ0gsR0FBRyxDQUFDLE1BQU0sR0FBRyxLQUFLLENBQUE7UUFDbEIsUUFBUSxDQUFDLE1BQU0sR0FBRyxLQUFLLENBQUE7UUFDdkIsV0FBVyxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUE7S0FDNUI7SUFFRCxLQUFLLENBQUMsYUFBYSxHQUFHLE1BQU0sQ0FBQTtBQUNoQyxDQUFDO0FBRUQsU0FBUyxrQkFBa0I7SUFDdkIsTUFBTSxTQUFTLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQTtJQUNyQyxJQUFJLENBQUMsaUJBQWlCLENBQUMsU0FBUyxDQUFDLENBQUE7QUFDckMsQ0FBQztBQUVELFNBQVMsY0FBYyxDQUFDLE1BQWM7SUFDbEMsa0JBQWtCLEVBQUUsQ0FBQTtJQUVwQixJQUFJLENBQUMsTUFBTSxFQUFFO1FBQ1Qsa0JBQWtCLENBQUMsNEVBQTRFLENBQUMsQ0FBQTtRQUNoRyxPQUFPLEtBQUssQ0FBQTtLQUNmO0lBRUQsSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLEVBQUU7UUFDZixrQkFBa0IsQ0FBQywyQkFBMkIsQ0FBQyxDQUFBO1FBQy9DLE9BQU8sS0FBSyxDQUFBO0tBQ2Y7SUFFRCxJQUFJLENBQUMsTUFBTSxDQUFDLFdBQVcsRUFBRTtRQUNyQixrQkFBa0IsQ0FBQyxpQ0FBaUMsQ0FBQyxDQUFBO1FBQ3JELE9BQU8sS0FBSyxDQUFBO0tBQ2Y7SUFFRCxJQUFJLENBQUMsTUFBTSxDQUFDLFFBQVEsRUFBRTtRQUNsQixrQkFBa0IsQ0FBQywyQ0FBMkMsQ0FBQyxDQUFBO1FBQy9ELE9BQU8sS0FBSyxDQUFBO0tBQ2Y7SUFFRCxNQUFNLFFBQVEsR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQTtJQUMvQyxJQUFJLEtBQUssR0FBRyxJQUFJLENBQUE7SUFDaEIsS0FBSyxNQUFNLE9BQU8sSUFBSSxRQUFRLEVBQUU7UUFDNUIsTUFBTSxZQUFZLEdBQUcsZUFBZSxDQUFDLE1BQU0sRUFBRSxPQUFPLENBQUMsQ0FBQTtRQUNyRCxLQUFLLEdBQUcsS0FBSyxJQUFJLFlBQVksQ0FBQTtLQUNoQztJQUVELE9BQU8sS0FBSyxDQUFBO0FBQ2hCLENBQUM7QUFFRCxTQUFTLGVBQWUsQ0FBQyxNQUFjLEVBQUUsT0FBZ0I7O0lBQ3JELElBQUksS0FBSyxHQUFHLElBQUksQ0FBQTtJQUNoQixJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksRUFBRTtRQUNmLGtCQUFrQixDQUFDLGdDQUFnQyxDQUFDLENBQUE7UUFDcEQsS0FBSyxHQUFHLEtBQUssQ0FBQTtLQUNoQjtJQUVELE9BQU8sQ0FBQyxPQUFPLFNBQUcsT0FBTyxDQUFDLE9BQU8sbUNBQUksRUFBRSxDQUFBO0lBQ3ZDLEtBQUssTUFBTSxNQUFNLElBQUksT0FBTyxDQUFDLE9BQU8sRUFBRTtRQUNsQyxNQUFNLFdBQVcsR0FBRyxjQUFjLENBQUMsTUFBTSxFQUFFLE1BQU0sQ0FBQyxDQUFBO1FBQ2xELEtBQUssR0FBRyxLQUFLLElBQUksV0FBVyxDQUFBO0tBQy9CO0lBRUQsT0FBTyxLQUFLLENBQUE7QUFDaEIsQ0FBQztBQUVELFNBQVMsY0FBYyxDQUFDLE1BQWMsRUFBRSxNQUFjO0lBQ2xELElBQUksS0FBSyxHQUFHLElBQUksQ0FBQTtJQUNoQixJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksRUFBRTtRQUNkLGtCQUFrQixDQUFDLCtCQUErQixDQUFDLENBQUE7UUFDbkQsS0FBSyxHQUFHLEtBQUssQ0FBQTtLQUNoQjtJQUVELElBQUksQ0FBQyxNQUFNLENBQUMsU0FBUyxJQUFJLENBQUMsTUFBTSxDQUFDLFVBQVUsRUFBRTtRQUN6QyxrQkFBa0IsQ0FBQywyREFBMkQsQ0FBQyxDQUFBO1FBQy9FLEtBQUssR0FBRyxLQUFLLENBQUE7S0FDaEI7SUFFRCxJQUFJLE1BQU0sQ0FBQyxTQUFTLElBQUksQ0FBQyxDQUFDLE1BQU0sQ0FBQyxTQUFTLElBQUksTUFBTSxDQUFDLFFBQVEsQ0FBQyxFQUFFO1FBQzVELGtCQUFrQixDQUFDLHFDQUFxQyxNQUFNLENBQUMsU0FBUyxFQUFFLENBQUMsQ0FBQTtRQUMzRSxLQUFLLEdBQUcsS0FBSyxDQUFBO0tBQ2hCO0lBRUQsT0FBTyxLQUFLLENBQUE7QUFDaEIsQ0FBQztBQUVELFNBQVMsa0JBQWtCLENBQUMsS0FBYTtJQUNyQyxPQUFPLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFBO0lBQ2xCLE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUM7SUFDdEMsTUFBTSxHQUFHLEdBQUcsUUFBUSxDQUFDLGFBQWEsQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUMxQyxHQUFHLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxlQUFlLENBQUMsQ0FBQTtJQUNsQyxHQUFHLENBQUMsV0FBVyxHQUFHLEtBQUssQ0FBQTtJQUN2QixTQUFTLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxDQUFBO0FBQzlCLENBQUM7QUFFRCxTQUFTLFlBQVksQ0FBQyxNQUFjLEVBQUUsTUFBYztJQUNoRCxJQUFJLE1BQU0sQ0FBQyxVQUFVLEVBQUU7UUFDbkIsY0FBYyxDQUFDLE1BQU0sQ0FBQyxDQUFBO1FBQ3RCLE9BQU07S0FDVDtJQUVELE1BQU0sU0FBUyxHQUFHLE1BQU0sQ0FBQyxTQUFTLENBQUE7SUFDbEMsSUFBSSxDQUFDLFNBQVMsRUFBRTtRQUNaLE1BQU0sS0FBSyxDQUFDLDBDQUEwQyxNQUFNLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQTtLQUN2RTtJQUVELE1BQU0sT0FBTyxHQUFHLE1BQU0sQ0FBQyxRQUFRLENBQUMsU0FBUyxDQUFDLENBQUE7SUFDMUMsSUFBSSxDQUFDLE9BQU8sRUFBRTtRQUNWLE1BQU0sS0FBSyxDQUFDLCtCQUErQixNQUFNLENBQUMsSUFBSSxZQUFZLFNBQVMsRUFBRSxDQUFDLENBQUE7S0FDakY7SUFFRCxXQUFXLENBQUMsT0FBTyxDQUFDLENBQUE7QUFDeEIsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIHV0aWwgZnJvbSBcIi4uL3NoYXJlZC91dGlsLmpzXCJcclxuXHJcbmluaXQoKVxyXG5cclxuaW50ZXJmYWNlIE1vZHVsZSB7XHJcbiAgICB0aXRsZTogc3RyaW5nXHJcbiAgICBkZXNjcmlwdGlvbjogc3RyaW5nXHJcbiAgICBwYXNzYWdlczogUmVjb3JkPHN0cmluZywgUGFzc2FnZT5cclxufVxyXG5cclxuaW50ZXJmYWNlIFBhc3NhZ2Uge1xyXG4gICAgdGl0bGU6IHN0cmluZ1xyXG4gICAgYm9keTogc3RyaW5nXHJcbiAgICBjaG9pY2VzOiBDaG9pY2VbXVxyXG59XHJcblxyXG5pbnRlcmZhY2UgQ2hvaWNlIHtcclxuICAgIGJvZHk6IHN0cmluZ1xyXG4gICAgdHJhbnNpdGlvbjogc3RyaW5nXHJcbiAgICBwYXNzYWdlSWQ6IHN0cmluZ1xyXG59XHJcblxyXG5pbnRlcmZhY2UgU3RhdGUge1xyXG4gICAgY3VycmVudE1vZHVsZTogbnVsbCB8IE1vZHVsZVxyXG4gICAgY3VycmVudFBhc3NhZ2U6IG51bGwgfCBQYXNzYWdlXHJcbiAgICBjdXJyZW50Q2hvaWNlOiBudWxsIHwgQ2hvaWNlXHJcbn1cclxuXHJcbmNvbnN0IHN0YXRlOiBTdGF0ZSA9IHtcclxuICAgIGN1cnJlbnRNb2R1bGU6IG51bGwsXHJcbiAgICBjdXJyZW50UGFzc2FnZTogbnVsbCxcclxuICAgIGN1cnJlbnRDaG9pY2U6IG51bGxcclxufVxyXG5cclxuZnVuY3Rpb24gaW5pdCgpIHtcclxuICAgIGluaXRMb2FkVWkoKVxyXG4gICAgaW5pdFBsYXlVaSgpXHJcbn1cclxuXHJcbmZ1bmN0aW9uIGluaXRMb2FkVWkoKSB7XHJcbiAgICBjb25zdCBmaWxlRHJvcEJveCA9IHV0aWwuYnlJZChcImZpbGVEcm9wQm94XCIpIGFzIEhUTUxEaXZFbGVtZW50XHJcbiAgICBjb25zdCBmaWxlSW5wdXQgPSB1dGlsLmJ5SWQoXCJmaWxlSW5wdXRcIikgYXMgSFRNTElucHV0RWxlbWVudFxyXG4gICAgY29uc3QgZmlsZUJ1dHRvbiA9IHV0aWwuYnlJZChcImZpbGVCdXR0b25cIikgYXMgSFRNTEJ1dHRvbkVsZW1lbnRcclxuICAgIGNvbnN0IHVybElucHV0ID0gdXRpbC5ieUlkKFwidXJsSW5wdXRcIikgYXMgSFRNTElucHV0RWxlbWVudFxyXG4gICAgY29uc3QgbG9hZEJ1dHRvbiA9IHV0aWwuYnlJZChcInVybEJ1dHRvblwiKSBhcyBIVE1MQnV0dG9uRWxlbWVudFxyXG5cclxuICAgIGZpbGVCdXR0b24uYWRkRXZlbnRMaXN0ZW5lcihcImNsaWNrXCIsICgpID0+IHtcclxuICAgICAgICBmaWxlSW5wdXQuY2xpY2soKVxyXG4gICAgfSlcclxuXHJcbiAgICBmaWxlRHJvcEJveC5hZGRFdmVudExpc3RlbmVyKFwiZHJhZ2VudGVyXCIsIG9uRHJhZ0VudGVyT3ZlcilcclxuICAgIGZpbGVEcm9wQm94LmFkZEV2ZW50TGlzdGVuZXIoXCJkcmFnb3ZlclwiLCBvbkRyYWdFbnRlck92ZXIpXHJcbiAgICBmaWxlRHJvcEJveC5hZGRFdmVudExpc3RlbmVyKFwiZHJvcFwiLCBvbkZpbGVEcm9wKVxyXG5cclxuICAgIGZpbGVJbnB1dC5hZGRFdmVudExpc3RlbmVyKFwiY2hhbmdlXCIsICgpID0+IHtcclxuICAgICAgICBpZiAoIWZpbGVJbnB1dC5maWxlcykge1xyXG4gICAgICAgICAgICByZXR1cm5cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHByb2Nlc3NGaWxlcyhmaWxlSW5wdXQuZmlsZXMpXHJcbiAgICB9KVxyXG5cclxuICAgIGxvYWRCdXR0b24uYWRkRXZlbnRMaXN0ZW5lcihcImNsaWNrXCIsICgpID0+IHtcclxuICAgICAgICBjbGVhckVycm9yTWVzc2FnZXMoKVxyXG5cclxuICAgICAgICBjb25zdCB1cmwgPSB1cmxJbnB1dC52YWx1ZVxyXG4gICAgICAgIGlmICghdXJsKSB7XHJcbiAgICAgICAgICAgIGFwcGVuZEVycm9yTWVzc2FnZShcIkEgdmFsaWQgdXJsIGlzIHJlcXVpcmVkXCIpXHJcbiAgICAgICAgICAgIHJldHVyblxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgbG9hZEZyb21VcmwodXJsKVxyXG4gICAgfSlcclxuXHJcbiAgICAvLyBmb3Igbm93IC0gZGVidWcgY3VycmVudCBnYW1lXHJcbiAgICBsb2FkRnJvbVVybChcImFuYS5jeW9hLmpzb25cIilcclxufVxyXG5cclxuZnVuY3Rpb24gaW5pdFBsYXlVaSgpIHtcclxuICAgIGNvbnN0IGNob2ljZXMgPSB1dGlsLmJ5SWQoXCJjaG9pY2VzXCIpXHJcbiAgICBjb25zdCB0cnlBZ2FpbiA9IHV0aWwuYnlJZChcInRyeUFnYWluXCIpXHJcbiAgICBjb25zdCBuZXh0UGFzc2FnZSAgPSB1dGlsLmJ5SWQoXCJuZXh0UGFzc2FnZVwiKVxyXG5cclxuICAgIHV0aWwuZGVsZWdhdGUoY2hvaWNlcywgXCJjbGlja1wiLCBcIi5jaG9pY2VcIiwgKGV2KSA9PiB7XHJcbiAgICAgICAgaWYgKCFzdGF0ZS5jdXJyZW50TW9kdWxlKSB7XHJcbiAgICAgICAgICAgIHJldHVyblxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKCFzdGF0ZS5jdXJyZW50UGFzc2FnZSkge1xyXG4gICAgICAgICAgICByZXR1cm5cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGNvbnN0IGNob2ljZUlkeCA9IHV0aWwuZ2V0RWxlbWVudEluZGV4KGV2LnRhcmdldCBhcyBFbGVtZW50KVxyXG4gICAgICAgIGNvbnN0IGNob2ljZSA9IHN0YXRlLmN1cnJlbnRQYXNzYWdlLmNob2ljZXNbY2hvaWNlSWR4XVxyXG4gICAgICAgIGhhbmRsZUNob2ljZShzdGF0ZS5jdXJyZW50TW9kdWxlLCBjaG9pY2UpXHJcbiAgICB9KVxyXG5cclxuICAgIHRyeUFnYWluLmFkZEV2ZW50TGlzdGVuZXIoXCJjbGlja1wiLCAoKSA9PiB7XHJcbiAgICAgICAgaWYgKCFzdGF0ZS5jdXJyZW50TW9kdWxlKSB7XHJcbiAgICAgICAgICAgIHJldHVyblxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgbG9hZE1vZHVsZShzdGF0ZS5jdXJyZW50TW9kdWxlKVxyXG4gICAgfSlcclxuXHJcbiAgICBuZXh0UGFzc2FnZS5hZGRFdmVudExpc3RlbmVyKFwiY2xpY2tcIiwgKCkgPT4ge1xyXG4gICAgICAgIGNvbnN0IHBhc3NhZ2VJZCA9IHN0YXRlPy5jdXJyZW50Q2hvaWNlPy5wYXNzYWdlSWRcclxuICAgICAgICBpZiAoIXBhc3NhZ2VJZCkge1xyXG4gICAgICAgICAgICByZXR1cm5cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGNvbnN0IHBhc3NhZ2UgPSBzdGF0ZS5jdXJyZW50TW9kdWxlPy5wYXNzYWdlc1twYXNzYWdlSWRdXHJcbiAgICAgICAgaWYgKCFwYXNzYWdlKSB7XHJcbiAgICAgICAgICAgIHJldHVyblxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgbG9hZFBhc3NhZ2UocGFzc2FnZSlcclxuICAgIH0pXHJcbn1cclxuXHJcbmZ1bmN0aW9uIGxvYWRGcm9tU3RyaW5nKGpzb246IHN0cmluZykge1xyXG4gICAgY29uc3QgbW9kdWxlID0gdXRpbC50cnlmKCgpID0+IDxNb2R1bGU+KEpTT04ucGFyc2UoanNvbikpKVxyXG4gICAgaWYgKG1vZHVsZSBpbnN0YW5jZW9mIEVycm9yKSB7XHJcbiAgICAgICAgYXBwZW5kRXJyb3JNZXNzYWdlKG1vZHVsZS5tZXNzYWdlKVxyXG4gICAgICAgIHJldHVyblxyXG4gICAgfVxyXG5cclxuICAgIGlmICghdmFsaWRhdGVNb2R1bGUobW9kdWxlKSkge1xyXG4gICAgICAgIHJldHVyblxyXG4gICAgfVxyXG5cclxuICAgIC8vIG1vZHVsZSBpcyB2YWxpZCAtIHByb2NlZWRcclxuICAgIGxvYWRNb2R1bGUobW9kdWxlKVxyXG59XHJcblxyXG5mdW5jdGlvbiBvbkRyYWdFbnRlck92ZXIoZXY6IERyYWdFdmVudCkge1xyXG4gICAgZXYuc3RvcFByb3BhZ2F0aW9uKClcclxuICAgIGV2LnByZXZlbnREZWZhdWx0KClcclxufVxyXG5cclxuZnVuY3Rpb24gb25GaWxlRHJvcChldjogRHJhZ0V2ZW50KSB7XHJcbiAgICBldi5zdG9wUHJvcGFnYXRpb24oKVxyXG4gICAgZXYucHJldmVudERlZmF1bHQoKVxyXG5cclxuICAgIGlmIChldi5kYXRhVHJhbnNmZXIgPT0gbnVsbCkge1xyXG4gICAgICAgIHJldHVyblxyXG4gICAgfVxyXG5cclxuICAgIHByb2Nlc3NGaWxlcyhldi5kYXRhVHJhbnNmZXIuZmlsZXMpXHJcbn1cclxuXHJcbmFzeW5jIGZ1bmN0aW9uIGxvYWRGcm9tVXJsKHVybDogc3RyaW5nKSB7XHJcbiAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHV0aWwudHJ5ZigoKSA9PiBmZXRjaCh1cmwpKVxyXG4gICAgaWYgKHJlc3BvbnNlIGluc3RhbmNlb2YgRXJyb3IpIHtcclxuICAgICAgICBhcHBlbmRFcnJvck1lc3NhZ2UocmVzcG9uc2UubWVzc2FnZSlcclxuICAgICAgICByZXR1cm5cclxuICAgIH1cclxuXHJcbiAgICBpZiAocmVzcG9uc2Uuc3RhdHVzICE9IDIwMCkge1xyXG4gICAgICAgIGFwcGVuZEVycm9yTWVzc2FnZShgQ291bGQgbm90IGxvYWQgJHt1cmx9LCB1bnN1Y2Nlc3NmdWwgcmVzcG9uc2U6ICR7cmVzcG9uc2Uuc3RhdHVzfSAtICR7cmVzcG9uc2Uuc3RhdHVzVGV4dH0uYClcclxuICAgICAgICByZXR1cm5cclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBqc29uID0gYXdhaXQgcmVzcG9uc2UudGV4dCgpXHJcbiAgICBsb2FkRnJvbVN0cmluZyhqc29uKVxyXG59XHJcblxyXG5hc3luYyBmdW5jdGlvbiBwcm9jZXNzRmlsZXMoZmlsZXM6IEZpbGVMaXN0KSB7XHJcbiAgICBpZiAoZmlsZXMubGVuZ3RoID09IDApIHtcclxuICAgICAgICByZXR1cm5cclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBmaWxlID0gZmlsZXNbMF1cclxuICAgIGNvbnN0IGpzb24gPSBhd2FpdCBmaWxlLnRleHQoKVxyXG4gICAgbG9hZEZyb21TdHJpbmcoanNvbilcclxufVxyXG5cclxuZnVuY3Rpb24gbG9hZE1vZHVsZShtb2R1bGU6IE1vZHVsZSkge1xyXG4gICAgc3RhdGUuY3VycmVudE1vZHVsZSA9IG1vZHVsZVxyXG4gICAgY29uc3QgbG9hZFVpID0gdXRpbC5ieUlkKFwibG9hZFVpXCIpO1xyXG4gICAgY29uc3QgcGxheVVpID0gdXRpbC5ieUlkKFwicGxheVVpXCIpO1xyXG4gICAgbG9hZFVpLmhpZGRlbiA9IHRydWU7XHJcbiAgICBwbGF5VWkuaGlkZGVuID0gZmFsc2U7XHJcblxyXG4gICAgLy8gbG9hZCBtb2R1bGUgdGl0bGVcclxuICAgIGNvbnN0IG1vZHVsZVRpdGxlID0gdXRpbC5ieUlkKFwibW9kdWxlVGl0bGVcIilcclxuICAgIG1vZHVsZVRpdGxlLnRleHRDb250ZW50ID0gbW9kdWxlLnRpdGxlXHJcblxyXG4gICAgLy8gbG9hZCBpbml0aWFsIHBhc3NhZ2VcclxuICAgIGNvbnN0IGludHJvID0gbW9kdWxlLnBhc3NhZ2VzW1wiaW50cm9cIl1cclxuICAgIGxvYWRQYXNzYWdlKGludHJvKVxyXG59XHJcblxyXG5mdW5jdGlvbiBsb2FkUGFzc2FnZShwYXNzYWdlOiBQYXNzYWdlKSB7XHJcbiAgICBjb25zdCBwYXNzYWdlVGl0bGUgPSB1dGlsLmJ5SWQoXCJwYXNzYWdlVGl0bGVcIilcclxuICAgIGNvbnN0IHBhc3NhZ2VCb2R5ID0gdXRpbC5ieUlkKFwicGFzc2FnZUJvZHlcIilcclxuICAgIGNvbnN0IGNob2ljZXNEaXYgPSB1dGlsLmJ5SWQoXCJjaG9pY2VzXCIpXHJcbiAgICB1dGlsLnJlbW92ZUFsbENoaWxkcmVuKGNob2ljZXNEaXYpXHJcblxyXG4gICAgcGFzc2FnZVRpdGxlLnRleHRDb250ZW50ID0gcGFzc2FnZS50aXRsZVxyXG4gICAgcGFzc2FnZUJvZHkudGV4dENvbnRlbnQgPSBwYXNzYWdlLmJvZHlcclxuXHJcbiAgICBjb25zdCB0ZW1wbGF0ZSA9IHV0aWwuYnlJZChcImNob2ljZVRlbXBsYXRlXCIpIGFzIEhUTUxUZW1wbGF0ZUVsZW1lbnRcclxuICAgIGZvciAoY29uc3QgY2hvaWNlIG9mIHBhc3NhZ2UuY2hvaWNlcykge1xyXG4gICAgICAgIGNvbnN0IGZyYWdtZW50ID0gdGVtcGxhdGUuY29udGVudC5jbG9uZU5vZGUodHJ1ZSkgYXMgRG9jdW1lbnRGcmFnbWVudFxyXG4gICAgICAgIGNvbnN0IGNob2ljZURpdiA9IHV0aWwuYnlTZWxlY3RvcihmcmFnbWVudCwgXCIuY2hvaWNlXCIpIGFzIEhUTUxFbGVtZW50XHJcbiAgICAgICAgY2hvaWNlRGl2LnRleHRDb250ZW50ID0gY2hvaWNlLmJvZHlcclxuICAgICAgICBjaG9pY2VzRGl2LmFwcGVuZENoaWxkKGZyYWdtZW50KVxyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IHRyeUFnYWluID0gdXRpbC5ieUlkKFwidHJ5QWdhaW5cIilcclxuICAgIGNvbnN0IGVuZCA9IHV0aWwuYnlJZChcImVuZFwiKVxyXG4gICAgY29uc3QgbmV4dFBhc3NhZ2UgPSB1dGlsLmJ5SWQoXCJuZXh0UGFzc2FnZVwiKVxyXG5cclxuICAgIG5leHRQYXNzYWdlLmhpZGRlbiA9IHRydWVcclxuICAgIGlmIChwYXNzYWdlLmNob2ljZXMubGVuZ3RoID09IDApIHtcclxuICAgICAgICBlbmQuaGlkZGVuID0gZmFsc2VcclxuICAgICAgICB0cnlBZ2Fpbi5oaWRkZW4gPSBmYWxzZVxyXG4gICAgfSBlbHNlIHtcclxuICAgICAgICBlbmQuaGlkZGVuID0gdHJ1ZVxyXG4gICAgICAgIHRyeUFnYWluLmhpZGRlbiA9IHRydWVcclxuICAgIH1cclxuXHJcbiAgICBzdGF0ZS5jdXJyZW50UGFzc2FnZSA9IHBhc3NhZ2VcclxufVxyXG5cclxuZnVuY3Rpb24gbG9hZFRyYW5zaXRpb24oY2hvaWNlOiBDaG9pY2UpIHtcclxuICAgIGNvbnN0IHBhc3NhZ2VUaXRsZSA9IHV0aWwuYnlJZChcInBhc3NhZ2VUaXRsZVwiKVxyXG4gICAgY29uc3QgcGFzc2FnZUJvZHkgPSB1dGlsLmJ5SWQoXCJwYXNzYWdlQm9keVwiKVxyXG4gICAgY29uc3QgY2hvaWNlc0RpdiA9IHV0aWwuYnlJZChcImNob2ljZXNcIilcclxuICAgIHV0aWwucmVtb3ZlQWxsQ2hpbGRyZW4oY2hvaWNlc0RpdilcclxuXHJcbiAgICBwYXNzYWdlVGl0bGUudGV4dENvbnRlbnQgPSBcIlwiXHJcbiAgICBwYXNzYWdlQm9keS50ZXh0Q29udGVudCA9IGNob2ljZS50cmFuc2l0aW9uXHJcblxyXG4gICAgY29uc3QgdHJ5QWdhaW4gPSB1dGlsLmJ5SWQoXCJ0cnlBZ2FpblwiKVxyXG4gICAgY29uc3QgZW5kID0gdXRpbC5ieUlkKFwiZW5kXCIpXHJcbiAgICBjb25zdCBuZXh0UGFzc2FnZSA9IHV0aWwuYnlJZChcIm5leHRQYXNzYWdlXCIpXHJcblxyXG4gICAgaWYgKGNob2ljZS5wYXNzYWdlSWQpIHtcclxuICAgICAgICBuZXh0UGFzc2FnZS5oaWRkZW4gPSBmYWxzZVxyXG4gICAgICAgIGVuZC5oaWRkZW4gPSB0cnVlXHJcbiAgICAgICAgdHJ5QWdhaW4uaGlkZGVuID0gdHJ1ZVxyXG4gICAgfSBlbHNlIHtcclxuICAgICAgICBlbmQuaGlkZGVuID0gZmFsc2VcclxuICAgICAgICB0cnlBZ2Fpbi5oaWRkZW4gPSBmYWxzZVxyXG4gICAgICAgIG5leHRQYXNzYWdlLmhpZGRlbiA9IHRydWVcclxuICAgIH1cclxuXHJcbiAgICBzdGF0ZS5jdXJyZW50Q2hvaWNlID0gY2hvaWNlXHJcbn1cclxuXHJcbmZ1bmN0aW9uIGNsZWFyRXJyb3JNZXNzYWdlcygpIHtcclxuICAgIGNvbnN0IGVycm9yc0RpdiA9IHV0aWwuYnlJZChcImVycm9yc1wiKVxyXG4gICAgdXRpbC5yZW1vdmVBbGxDaGlsZHJlbihlcnJvcnNEaXYpXHJcbn1cclxuXHJcbmZ1bmN0aW9uIHZhbGlkYXRlTW9kdWxlKG1vZHVsZTogTW9kdWxlKTogYm9vbGVhbiB7XHJcbiAgICBjbGVhckVycm9yTWVzc2FnZXMoKVxyXG5cclxuICAgIGlmICghbW9kdWxlKSB7XHJcbiAgICAgICAgYXBwZW5kRXJyb3JNZXNzYWdlKFwiTm8gbW9kdWxlIHdhcyBmb3VuZCAtIC5qc29uIGZpbGUgc2hvdWxkIGNvbnRhaW4gYSB0b3AgbGV2ZWwgbW9kdWxlIG9iamVjdC5cIilcclxuICAgICAgICByZXR1cm4gZmFsc2VcclxuICAgIH1cclxuXHJcbiAgICBpZiAoIW1vZHVsZS50aXRsZSkge1xyXG4gICAgICAgIGFwcGVuZEVycm9yTWVzc2FnZShcIk1vZHVsZSB0aXRsZSBpcyByZXF1aXJlZC5cIilcclxuICAgICAgICByZXR1cm4gZmFsc2VcclxuICAgIH1cclxuXHJcbiAgICBpZiAoIW1vZHVsZS5kZXNjcmlwdGlvbikge1xyXG4gICAgICAgIGFwcGVuZEVycm9yTWVzc2FnZShcIk1vZHVsZSBkZXNjcmlwdGlvbiBpcyByZXF1aXJlZC5cIilcclxuICAgICAgICByZXR1cm4gZmFsc2VcclxuICAgIH1cclxuXHJcbiAgICBpZiAoIW1vZHVsZS5wYXNzYWdlcykge1xyXG4gICAgICAgIGFwcGVuZEVycm9yTWVzc2FnZShcIk1vZHVsZSBtdXN0IGNvbnRhaW4gYXQgbGVhc3Qgb25lIHBhc3NhZ2UuXCIpXHJcbiAgICAgICAgcmV0dXJuIGZhbHNlXHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgcGFzc2FnZXMgPSBPYmplY3QudmFsdWVzKG1vZHVsZS5wYXNzYWdlcylcclxuICAgIGxldCB2YWxpZCA9IHRydWVcclxuICAgIGZvciAoY29uc3QgcGFzc2FnZSBvZiBwYXNzYWdlcykge1xyXG4gICAgICAgIGNvbnN0IHBhc3NhZ2VWYWxpZCA9IHZhbGlkYXRlUGFzc2FnZShtb2R1bGUsIHBhc3NhZ2UpXHJcbiAgICAgICAgdmFsaWQgPSB2YWxpZCAmJiBwYXNzYWdlVmFsaWRcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gdmFsaWRcclxufVxyXG5cclxuZnVuY3Rpb24gdmFsaWRhdGVQYXNzYWdlKG1vZHVsZTogTW9kdWxlLCBwYXNzYWdlOiBQYXNzYWdlKTogYm9vbGVhbiB7XHJcbiAgICBsZXQgdmFsaWQgPSB0cnVlXHJcbiAgICBpZiAoIXBhc3NhZ2UuYm9keSkge1xyXG4gICAgICAgIGFwcGVuZEVycm9yTWVzc2FnZShcIkVhY2ggcGFzc2FnZSBtdXN0IGhhdmUgYSBib2R5LlwiKVxyXG4gICAgICAgIHZhbGlkID0gZmFsc2VcclxuICAgIH1cclxuXHJcbiAgICBwYXNzYWdlLmNob2ljZXMgPSBwYXNzYWdlLmNob2ljZXMgPz8gW11cclxuICAgIGZvciAoY29uc3QgY2hvaWNlIG9mIHBhc3NhZ2UuY2hvaWNlcykge1xyXG4gICAgICAgIGNvbnN0IGNob2ljZVZhbGlkID0gdmFsaWRhdGVDaG9pY2UobW9kdWxlLCBjaG9pY2UpXHJcbiAgICAgICAgdmFsaWQgPSB2YWxpZCAmJiBjaG9pY2VWYWxpZFxyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiB2YWxpZFxyXG59XHJcblxyXG5mdW5jdGlvbiB2YWxpZGF0ZUNob2ljZShtb2R1bGU6IE1vZHVsZSwgY2hvaWNlOiBDaG9pY2UpOiBib29sZWFuIHtcclxuICAgIGxldCB2YWxpZCA9IHRydWVcclxuICAgIGlmICghY2hvaWNlLmJvZHkpIHtcclxuICAgICAgICBhcHBlbmRFcnJvck1lc3NhZ2UoXCJFYWNoIGNob2ljZSBtdXN0IGhhdmUgYSBib2R5LlwiKVxyXG4gICAgICAgIHZhbGlkID0gZmFsc2VcclxuICAgIH1cclxuXHJcbiAgICBpZiAoIWNob2ljZS5wYXNzYWdlSWQgJiYgIWNob2ljZS50cmFuc2l0aW9uKSB7XHJcbiAgICAgICAgYXBwZW5kRXJyb3JNZXNzYWdlKFwiRWFjaCBjaG9pY2UgbXVzdCBoYXZlIGVpdGhlciBhIHBhc3NhZ2VJZCBvciBhIHRyYW5zaXRpb24uXCIpXHJcbiAgICAgICAgdmFsaWQgPSBmYWxzZVxyXG4gICAgfVxyXG5cclxuICAgIGlmIChjaG9pY2UucGFzc2FnZUlkICYmICEoY2hvaWNlLnBhc3NhZ2VJZCBpbiBtb2R1bGUucGFzc2FnZXMpKSB7XHJcbiAgICAgICAgYXBwZW5kRXJyb3JNZXNzYWdlKGBDb3VsZCBub3QgZmluZCBwYXNzYWdlIHdpdGggaWQgb2YgJHtjaG9pY2UucGFzc2FnZUlkfWApXHJcbiAgICAgICAgdmFsaWQgPSBmYWxzZVxyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiB2YWxpZFxyXG59XHJcblxyXG5mdW5jdGlvbiBhcHBlbmRFcnJvck1lc3NhZ2UoZXJyb3I6IHN0cmluZykge1xyXG4gICAgY29uc29sZS5sb2coZXJyb3IpXHJcbiAgICBjb25zdCBlcnJvcnNEaXYgPSB1dGlsLmJ5SWQoXCJlcnJvcnNcIik7XHJcbiAgICBjb25zdCBkaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwiZGl2XCIpO1xyXG4gICAgZGl2LmNsYXNzTGlzdC5hZGQoXCJlcnJvci1tZXNzYWdlXCIpXHJcbiAgICBkaXYudGV4dENvbnRlbnQgPSBlcnJvclxyXG4gICAgZXJyb3JzRGl2LmFwcGVuZENoaWxkKGRpdilcclxufVxyXG5cclxuZnVuY3Rpb24gaGFuZGxlQ2hvaWNlKG1vZHVsZTogTW9kdWxlLCBjaG9pY2U6IENob2ljZSkge1xyXG4gICAgaWYgKGNob2ljZS50cmFuc2l0aW9uKSB7XHJcbiAgICAgICAgbG9hZFRyYW5zaXRpb24oY2hvaWNlKVxyXG4gICAgICAgIHJldHVyblxyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IHBhc3NhZ2VJZCA9IGNob2ljZS5wYXNzYWdlSWRcclxuICAgIGlmICghcGFzc2FnZUlkKSB7XHJcbiAgICAgICAgdGhyb3cgRXJyb3IoYE5vIHRyYW5zaXRpb24gb3IgcGFzc2FnZUlkIGZvciBjaG9pY2U6ICR7Y2hvaWNlLmJvZHl9YClcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBwYXNzYWdlID0gbW9kdWxlLnBhc3NhZ2VzW3Bhc3NhZ2VJZF1cclxuICAgIGlmICghcGFzc2FnZSkge1xyXG4gICAgICAgIHRocm93IEVycm9yKGBNaXNzaW5nIHBhc3NhZ2UgZm9yIGNob2ljZTogJHtjaG9pY2UuYm9keX0gd2l0aCBpZCAke3Bhc3NhZ2VJZH1gKVxyXG4gICAgfVxyXG5cclxuICAgIGxvYWRQYXNzYWdlKHBhc3NhZ2UpXHJcbn0iXX0=