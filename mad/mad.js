import * as dom from "../shared/dom.js";
import * as channel from "../shared/channel.js";
const minPlaceholderLength = 16;
var TokenType;
(function (TokenType) {
    TokenType[TokenType["Text"] = 0] = "Text";
    TokenType[TokenType["Placeholder"] = 1] = "Placeholder";
})(TokenType || (TokenType = {}));
class CreateUi {
    constructor() {
        this.createDiv = dom.byId("createUi");
        this.form = dom.byId("createForm");
        this.titleInput = dom.byId("title");
        this.templateInput = dom.byId("template");
        this.clearButton = dom.byId("clearButton");
        this.create = new channel.Channel();
        this.form.addEventListener("submit", evt => this.submit(evt));
        this.clearButton.addEventListener("click", _ => this.clear());
    }
    show() {
        this.createDiv.hidden = false;
    }
    hide() {
        this.createDiv.hidden = true;
    }
    load(state) {
        this.titleInput.value = state.title;
        this.templateInput.value = state.template;
    }
    submit(evt) {
        evt.preventDefault();
        this.create.publish(this.titleInput.value, this.templateInput.value);
    }
    clear() {
        this.templateInput.value = "";
    }
}
class PrintUi {
    constructor() {
        this.printDiv = dom.byId("printUi");
        this.printTitle = dom.byId("printTitle");
        this.printContent = dom.byId("printContent");
        this.placeholderTemplate = dom.byId("placeholderTemplate");
        this.returnToTemplateButton = dom.byId("returnToTemplate");
        this.returnToTemplate = new channel.Channel();
        this.returnToTemplateButton.addEventListener("click", _ => this.returnToTemplate.publish());
    }
    show(title, template) {
        this.printDiv.hidden = false;
        this.printTitle.textContent = title;
        dom.removeAllChildren(this.printContent);
        let tokens = this.parseTemplate(template);
        for (const token of tokens) {
            const type = token.type;
            const value = template.substr(token.start, token.length);
            switch (type) {
                case TokenType.Text:
                    this.appendText(value);
                    break;
                case TokenType.Placeholder:
                    this.appendPlaceholder(value);
                    break;
            }
        }
    }
    hide() {
        this.printDiv.hidden = true;
    }
    parseTemplate(template) {
        let tokens = new Array();
        let i = 0;
        while (true) {
            const token = this.parseToken(template, i);
            tokens.push(token);
            i += token.length;
            if (i >= template.length) {
                break;
            }
        }
        return tokens;
    }
    parseToken(template, start) {
        // peek at next char
        const ch = template[start];
        if (ch !== '[') {
            return this.parseText(template, start);
        }
        return this.parsePlaceholder(template, start);
    }
    parsePlaceholder(template, start) {
        for (let i = start; i < template.length; ++i) {
            const ch = template[i];
            if (ch == ']') {
                return {
                    type: TokenType.Placeholder,
                    start: start,
                    length: i - start + 1,
                };
            }
        }
        return {
            type: TokenType.Placeholder,
            start: start,
            length: template.length - start,
        };
    }
    parseText(template, start) {
        for (let i = start; i < template.length; ++i) {
            const ch = template[i];
            if (ch == '[') {
                return {
                    type: TokenType.Text,
                    start: start,
                    length: i - start,
                };
            }
        }
        return {
            type: TokenType.Text,
            start: start,
            length: template.length - start,
        };
    }
    appendText(text) {
        const node = document.createTextNode(text);
        this.printContent.append(node);
    }
    appendPlaceholder(placeholder) {
        placeholder = this.formatPlaceholder(placeholder);
        const frag = this.placeholderTemplate.content.cloneNode(true);
        const textDiv = dom.bySelector(frag, ".placeholder-text");
        textDiv.textContent = placeholder;
        this.printContent.append(frag);
    }
    formatPlaceholder(placeholder) {
        if (placeholder.startsWith("[")) {
            placeholder = placeholder.substr(1);
        }
        if (placeholder.endsWith("]")) {
            placeholder = placeholder.substr(0, placeholder.length - 1);
        }
        placeholder = placeholder.trim();
        while (placeholder.length < minPlaceholderLength) {
            placeholder = ` ${placeholder} `;
        }
        return placeholder;
    }
}
async function main() {
    const createUi = new CreateUi();
    const printUi = new PrintUi();
    const settingsKey = "madSettings";
    createUi.show();
    createUi.create.subcribe(onCreate);
    printUi.returnToTemplate.subcribe(onReturnToTemplate);
    const state = loadState();
    if (state) {
        createUi.load(state);
    }
    function onCreate(title, template) {
        createUi.hide();
        saveState({ title, template });
        printUi.show(title, template);
    }
    function onReturnToTemplate() {
        printUi.hide();
        createUi.show();
    }
    function loadState() {
        const json = localStorage.getItem(settingsKey);
        if (!json) {
            console.log("No stored settings found");
            return null;
        }
        const state = JSON.parse(json);
        return state;
    }
    function saveState(state) {
        localStorage.setItem(settingsKey, JSON.stringify(state));
    }
}
main();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFkLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsibWFkLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sS0FBSyxHQUFHLE1BQU0sa0JBQWtCLENBQUE7QUFDdkMsT0FBTyxLQUFLLE9BQU8sTUFBTSxzQkFBc0IsQ0FBQTtBQUUvQyxNQUFNLG9CQUFvQixHQUFHLEVBQUUsQ0FBQztBQU9oQyxJQUFLLFNBR0o7QUFIRCxXQUFLLFNBQVM7SUFDVix5Q0FBSSxDQUFBO0lBQ0osdURBQVcsQ0FBQTtBQUNmLENBQUMsRUFISSxTQUFTLEtBQVQsU0FBUyxRQUdiO0FBUUQsTUFBTSxRQUFRO0lBUVY7UUFQaUIsY0FBUyxHQUFHLEdBQUcsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUE7UUFDaEMsU0FBSSxHQUFHLEdBQUcsQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUE7UUFDN0IsZUFBVSxHQUFHLEdBQUcsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFxQixDQUFBO1FBQ2xELGtCQUFhLEdBQUcsR0FBRyxDQUFDLElBQUksQ0FBQyxVQUFVLENBQXdCLENBQUE7UUFDM0QsZ0JBQVcsR0FBRyxHQUFHLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxDQUFBO1FBQ3RDLFdBQU0sR0FBRyxJQUFJLE9BQU8sQ0FBQyxPQUFPLEVBQW9CLENBQUE7UUFHNUQsSUFBSSxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxRQUFRLEVBQUUsR0FBRyxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUE7UUFDN0QsSUFBSSxDQUFDLFdBQVcsQ0FBQyxnQkFBZ0IsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsS0FBSyxFQUFFLENBQUMsQ0FBQTtJQUNqRSxDQUFDO0lBRU0sSUFBSTtRQUNQLElBQUksQ0FBQyxTQUFTLENBQUMsTUFBTSxHQUFHLEtBQUssQ0FBQTtJQUNqQyxD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QUFFLENBQUE7UUFDZCxRQUFRLENBQUMsSUFBSSxFQUFFLENBQUE7SUFDbkIsQ0FBQztJQUVELFNBQVMsU0FBUztRQUNkLE1BQU0sSUFBSSxHQUFHLFlBQVksQ0FBQyxPQUFPLENBQUMsV0FBVyxDQUFDLENBQUE7UUFDOUMsSUFBSSxDQUFDLElBQUksRUFBRTtZQUNQLE9BQU8sQ0FBQyxHQUFHLENBQUMsMEJBQTBCLENBQUMsQ0FBQTtZQUN2QyxPQUFPLElBQUksQ0FBQTtTQUNkO1FBRUQsTUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQVUsQ0FBQTtRQUN2QyxPQUFPLEtBQUssQ0FBQTtJQUNoQixDQUFDO0lBRUQsU0FBUyxTQUFTLENBQUMsS0FBWTtRQUMzQixZQUFZLENBQUMsT0FBTyxDQUFDLFdBQVcsRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUE7SUFDNUQsQ0FBQztBQUNMLENBQUM7QUFFRCxJQUFJLEVBQUUsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIGRvbSBmcm9tIFwiLi4vc2hhcmVkL2RvbS5qc1wiXHJcbmltcG9ydCAqIGFzIGNoYW5uZWwgZnJvbSBcIi4uL3NoYXJlZC9jaGFubmVsLmpzXCJcclxuXHJcbmNvbnN0IG1pblBsYWNlaG9sZGVyTGVuZ3RoID0gMTY7XHJcblxyXG5pbnRlcmZhY2UgU3RhdGUge1xyXG4gICAgdGl0bGU6IHN0cmluZ1xyXG4gICAgdGVtcGxhdGU6IHN0cmluZ1xyXG59XHJcblxyXG5lbnVtIFRva2VuVHlwZSB7XHJcbiAgICBUZXh0LFxyXG4gICAgUGxhY2Vob2xkZXIsXHJcbn1cclxuXHJcbmludGVyZmFjZSBUb2tlbiB7XHJcbiAgICB0eXBlOiBUb2tlblR5cGUsXHJcbiAgICBzdGFydDogbnVtYmVyLFxyXG4gICAgbGVuZ3RoOiBudW1iZXIsXHJcbn1cclxuXHJcbmNsYXNzIENyZWF0ZVVpIHtcclxuICAgIHByaXZhdGUgcmVhZG9ubHkgY3JlYXRlRGl2ID0gZG9tLmJ5SWQoXCJjcmVhdGVVaVwiKVxyXG4gICAgcHJpdmF0ZSByZWFkb25seSBmb3JtID0gZG9tLmJ5SWQoXCJjcmVhdGVGb3JtXCIpXHJcbiAgICBwcml2YXRlIHJlYWRvbmx5IHRpdGxlSW5wdXQgPSBkb20uYnlJZChcInRpdGxlXCIpIGFzIEhUTUxJbnB1dEVsZW1lbnRcclxuICAgIHByaXZhdGUgcmVhZG9ubHkgdGVtcGxhdGVJbnB1dCA9IGRvbS5ieUlkKFwidGVtcGxhdGVcIikgYXMgSFRNTFRleHRBcmVhRWxlbWVudFxyXG4gICAgcHJpdmF0ZSByZWFkb25seSBjbGVhckJ1dHRvbiA9IGRvbS5ieUlkKFwiY2xlYXJCdXR0b25cIilcclxuICAgIHB1YmxpYyByZWFkb25seSBjcmVhdGUgPSBuZXcgY2hhbm5lbC5DaGFubmVsPFtzdHJpbmcsIHN0cmluZ10+KClcclxuXHJcbiAgICBjb25zdHJ1Y3RvcigpIHtcclxuICAgICAgICB0aGlzLmZvcm0uYWRkRXZlbnRMaXN0ZW5lcihcInN1Ym1pdFwiLCBldnQgPT4gdGhpcy5zdWJtaXQoZXZ0KSlcclxuICAgICAgICB0aGlzLmNsZWFyQnV0dG9uLmFkZEV2ZW50TGlzdGVuZXIoXCJjbGlja1wiLCBfID0+IHRoaXMuY2xlYXIoKSlcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgc2hvdygpIHtcclxuICAgICAgICB0aGlzLmNyZWF0ZURpdi5oaWRkZW4gPSBmYWxzZVxyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBoaWRlKCkge1xyXG4gICAgICAgIHRoaXMuY3JlYXRlRGl2LmhpZGRlbiA9IHRydWVcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgbG9hZChzdGF0ZTogU3RhdGUpIHtcclxuICAgICAgICB0aGlzLnRpdGxlSW5wdXQudmFsdWUgPSBzdGF0ZS50aXRsZVxyXG4gICAgICAgIHRoaXMudGVtcGxhdGVJbnB1dC52YWx1ZSA9IHN0YXRlLnRlbXBsYXRlXHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBzdWJtaXQoZXZ0OiBFdmVudCkge1xyXG4gICAgICAgIGV2dC5wcmV2ZW50RGVmYXVsdCgpXHJcbiAgICAgICAgdGhpcy5jcmVhdGUucHVibGlzaCh0aGlzLnRpdGxlSW5wdXQudmFsdWUsIHRoaXMudGVtcGxhdGVJbnB1dC52YWx1ZSlcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGNsZWFyKCkge1xyXG4gICAgICAgIHRoaXMudGVtcGxhdGVJbnB1dC52YWx1ZSA9IFwiXCJcclxuICAgIH1cclxufVxyXG5cclxuY2xhc3MgUHJpbnRVaSB7XHJcbiAgICBwcml2YXRlIHJlYWRvbmx5IHByaW50RGl2ID0gZG9tLmJ5SWQoXCJwcmludFVpXCIpXHJcbiAgICBwcml2YXRlIHJlYWRvbmx5IHByaW50VGl0bGUgPSBkb20uYnlJZChcInByaW50VGl0bGVcIilcclxuICAgIHByaXZhdGUgcmVhZG9ubHkgcHJpbnRDb250ZW50ID0gZG9tLmJ5SWQoXCJwcmludENvbnRlbnRcIilcclxuICAgIHByaXZhdGUgcmVhZG9ubHkgcGxhY2Vob2xkZXJUZW1wbGF0ZSA9IGRvbS5ieUlkKFwicGxhY2Vob2xkZXJUZW1wbGF0ZVwiKSBhcyBIVE1MVGVtcGxhdGVFbGVtZW50XHJcbiAgICBwcml2YXRlIHJlYWRvbmx5IHJldHVyblRvVGVtcGxhdGVCdXR0b24gPSBkb20uYnlJZChcInJldHVyblRvVGVtcGxhdGVcIilcclxuICAgIHB1YmxpYyByZWFkb25seSByZXR1cm5Ub1RlbXBsYXRlID0gbmV3IGNoYW5uZWwuQ2hhbm5lbDxbdm9pZF0+KClcclxuXHJcbiAgICBjb25zdHJ1Y3RvcigpIHtcclxuICAgICAgICB0aGlzLnJldHVyblRvVGVtcGxhdGVCdXR0b24uYWRkRXZlbnRMaXN0ZW5lcihcImNsaWNrXCIsIF8gPT4gdGhpcy5yZXR1cm5Ub1RlbXBsYXRlLnB1Ymxpc2goKSlcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgc2hvdyh0aXRsZTogc3RyaW5nLCB0ZW1wbGF0ZTogc3RyaW5nKSB7XHJcbiAgICAgICAgdGhpcy5wcmludERpdi5oaWRkZW4gPSBmYWxzZVxyXG4gICAgICAgIHRoaXMucHJpbnRUaXRsZS50ZXh0Q29udGVudCA9IHRpdGxlXHJcbiAgICAgICAgZG9tLnJlbW92ZUFsbENoaWxkcmVuKHRoaXMucHJpbnRDb250ZW50KVxyXG4gICAgICAgIGxldCB0b2tlbnMgPSB0aGlzLnBhcnNlVGVtcGxhdGUodGVtcGxhdGUpXHJcblxyXG4gICAgICAgIGZvciAoY29uc3QgdG9rZW4gb2YgdG9rZW5zKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHR5cGUgPSB0b2tlbi50eXBlXHJcbiAgICAgICAgICAgIGNvbnN0IHZhbHVlID0gdGVtcGxhdGUuc3Vic3RyKHRva2VuLnN0YXJ0LCB0b2tlbi5sZW5ndGgpXHJcblxyXG4gICAgICAgICAgICBzd2l0Y2ggKHR5cGUpIHtcclxuICAgICAgICAgICAgICAgIGNhc2UgVG9rZW5UeXBlLlRleHQ6XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5hcHBlbmRUZXh0KHZhbHVlKVxyXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG5cclxuICAgICAgICAgICAgICAgIGNhc2UgVG9rZW5UeXBlLlBsYWNlaG9sZGVyOlxyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuYXBwZW5kUGxhY2Vob2xkZXIodmFsdWUpXHJcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIGhpZGUoKSB7XHJcbiAgICAgICAgdGhpcy5wcmludERpdi5oaWRkZW4gPSB0cnVlXHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBwYXJzZVRlbXBsYXRlKHRlbXBsYXRlOiBzdHJpbmcpOiBUb2tlbltdIHtcclxuICAgICAgICBsZXQgdG9rZW5zID0gbmV3IEFycmF5PFRva2VuPigpO1xyXG4gICAgICAgIGxldCBpID0gMDtcclxuICAgICAgICB3aGlsZSAodHJ1ZSkge1xyXG4gICAgICAgICAgICBjb25zdCB0b2tlbiA9IHRoaXMucGFyc2VUb2tlbih0ZW1wbGF0ZSwgaSk7XHJcbiAgICAgICAgICAgIHRva2Vucy5wdXNoKHRva2VuKVxyXG4gICAgICAgICAgICBpICs9IHRva2VuLmxlbmd0aDtcclxuXHJcbiAgICAgICAgICAgIGlmIChpID49IHRlbXBsYXRlLmxlbmd0aCkge1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiB0b2tlbnNcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIHBhcnNlVG9rZW4odGVtcGxhdGU6IHN0cmluZywgc3RhcnQ6IG51bWJlcik6IFRva2VuIHtcclxuICAgICAgICAvLyBwZWVrIGF0IG5leHQgY2hhclxyXG4gICAgICAgIGNvbnN0IGNoID0gdGVtcGxhdGVbc3RhcnRdXHJcbiAgICAgICAgaWYgKGNoICE9PSAnWycpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHRoaXMucGFyc2VUZXh0KHRlbXBsYXRlLCBzdGFydCk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gdGhpcy5wYXJzZVBsYWNlaG9sZGVyKHRlbXBsYXRlLCBzdGFydCk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBwYXJzZVBsYWNlaG9sZGVyKHRlbXBsYXRlOiBzdHJpbmcsIHN0YXJ0OiBudW1iZXIpOiBUb2tlbiB7XHJcbiAgICAgICAgZm9yIChsZXQgaSA9IHN0YXJ0OyBpIDwgdGVtcGxhdGUubGVuZ3RoOyArK2kpIHtcclxuICAgICAgICAgICAgY29uc3QgY2ggPSB0ZW1wbGF0ZVtpXTtcclxuICAgICAgICAgICAgaWYgKGNoID09ICddJykge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgICAgICAgICB0eXBlOiBUb2tlblR5cGUuUGxhY2Vob2xkZXIsXHJcbiAgICAgICAgICAgICAgICAgICAgc3RhcnQ6IHN0YXJ0LFxyXG4gICAgICAgICAgICAgICAgICAgIGxlbmd0aDogaSAtIHN0YXJ0ICsgMSxcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgdHlwZTogVG9rZW5UeXBlLlBsYWNlaG9sZGVyLFxyXG4gICAgICAgICAgICBzdGFydDogc3RhcnQsXHJcbiAgICAgICAgICAgIGxlbmd0aDogdGVtcGxhdGUubGVuZ3RoIC0gc3RhcnQsXHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgcGFyc2VUZXh0KHRlbXBsYXRlOiBzdHJpbmcsIHN0YXJ0OiBudW1iZXIpOiBUb2tlbiB7XHJcbiAgICAgICAgZm9yIChsZXQgaSA9IHN0YXJ0OyBpIDwgdGVtcGxhdGUubGVuZ3RoOyArK2kpIHtcclxuICAgICAgICAgICAgY29uc3QgY2ggPSB0ZW1wbGF0ZVtpXTtcclxuICAgICAgICAgICAgaWYgKGNoID09ICdbJykge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgICAgICAgICB0eXBlOiBUb2tlblR5cGUuVGV4dCxcclxuICAgICAgICAgICAgICAgICAgICBzdGFydDogc3RhcnQsXHJcbiAgICAgICAgICAgICAgICAgICAgbGVuZ3RoOiBpIC0gc3RhcnQsXHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgIHR5cGU6IFRva2VuVHlwZS5UZXh0LFxyXG4gICAgICAgICAgICBzdGFydDogc3RhcnQsXHJcbiAgICAgICAgICAgIGxlbmd0aDogdGVtcGxhdGUubGVuZ3RoIC0gc3RhcnQsXHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgYXBwZW5kVGV4dCh0ZXh0OiBzdHJpbmcpIHtcclxuICAgICAgICBjb25zdCBub2RlID0gZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUodGV4dClcclxuICAgICAgICB0aGlzLnByaW50Q29udGVudC5hcHBlbmQobm9kZSlcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGFwcGVuZFBsYWNlaG9sZGVyKHBsYWNlaG9sZGVyOiBzdHJpbmcpIHtcclxuICAgICAgICBwbGFjZWhvbGRlciA9IHRoaXMuZm9ybWF0UGxhY2Vob2xkZXIocGxhY2Vob2xkZXIpXHJcbiAgICAgICAgY29uc3QgZnJhZyA9IHRoaXMucGxhY2Vob2xkZXJUZW1wbGF0ZS5jb250ZW50LmNsb25lTm9kZSh0cnVlKSBhcyBEb2N1bWVudEZyYWdtZW50XHJcbiAgICAgICAgY29uc3QgdGV4dERpdiA9IGRvbS5ieVNlbGVjdG9yKGZyYWcsIFwiLnBsYWNlaG9sZGVyLXRleHRcIik7XHJcbiAgICAgICAgdGV4dERpdi50ZXh0Q29udGVudCA9IHBsYWNlaG9sZGVyXHJcbiAgICAgICAgdGhpcy5wcmludENvbnRlbnQuYXBwZW5kKGZyYWcpXHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBmb3JtYXRQbGFjZWhvbGRlcihwbGFjZWhvbGRlcjogc3RyaW5nKSB7XHJcbiAgICAgICAgaWYgKHBsYWNlaG9sZGVyLnN0YXJ0c1dpdGgoXCJbXCIpKSB7XHJcbiAgICAgICAgICAgIHBsYWNlaG9sZGVyID0gcGxhY2Vob2xkZXIuc3Vic3RyKDEpXHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAocGxhY2Vob2xkZXIuZW5kc1dpdGgoXCJdXCIpKSB7XHJcbiAgICAgICAgICAgIHBsYWNlaG9sZGVyID0gcGxhY2Vob2xkZXIuc3Vic3RyKDAsIHBsYWNlaG9sZGVyLmxlbmd0aCAtIDEpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcGxhY2Vob2xkZXIgPSBwbGFjZWhvbGRlci50cmltKClcclxuICAgICAgICB3aGlsZSAocGxhY2Vob2xkZXIubGVuZ3RoIDwgbWluUGxhY2Vob2xkZXJMZW5ndGgpIHtcclxuICAgICAgICAgICAgcGxhY2Vob2xkZXIgPSBgICR7cGxhY2Vob2xkZXJ9IGA7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gcGxhY2Vob2xkZXJcclxuICAgIH1cclxufVxyXG5cclxuYXN5bmMgZnVuY3Rpb24gbWFpbigpIHtcclxuICAgIGNvbnN0IGNyZWF0ZVVpID0gbmV3IENyZWF0ZVVpKClcclxuICAgIGNvbnN0IHByaW50VWkgPSBuZXcgUHJpbnRVaSgpXHJcbiAgICBjb25zdCBzZXR0aW5nc0tleSA9IFwibWFkU2V0dGluZ3NcIlxyXG5cclxuICAgIGNyZWF0ZVVpLnNob3coKVxyXG5cclxuICAgIGNyZWF0ZVVpLmNyZWF0ZS5zdWJjcmliZShvbkNyZWF0ZSlcclxuICAgIHByaW50VWkucmV0dXJuVG9UZW1wbGF0ZS5zdWJjcmliZShvblJldHVyblRvVGVtcGxhdGUpXHJcblxyXG4gICAgY29uc3Qgc3RhdGUgPSBsb2FkU3RhdGUoKVxyXG4gICAgaWYgKHN0YXRlKSB7XHJcbiAgICAgICAgY3JlYXRlVWkubG9hZChzdGF0ZSlcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBvbkNyZWF0ZSh0aXRsZTogc3RyaW5nLCB0ZW1wbGF0ZTogc3RyaW5nKSB7XHJcbiAgICAgICAgY3JlYXRlVWkuaGlkZSgpXHJcbiAgICAgICAgc2F2ZVN0YXRlKHsgdGl0bGUsIHRlbXBsYXRlIH0pXHJcbiAgICAgICAgcHJpbnRVaS5zaG93KHRpdGxlLCB0ZW1wbGF0ZSlcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBvblJldHVyblRvVGVtcGxhdGUoKSB7XHJcbiAgICAgICAgcHJpbnRVaS5oaWRlKClcclxuICAgICAgICBjcmVhdGVVaS5zaG93KClcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBsb2FkU3RhdGUoKTogU3RhdGUgfCBudWxsIHtcclxuICAgICAgICBjb25zdCBqc29uID0gbG9jYWxTdG9yYWdlLmdldEl0ZW0oc2V0dGluZ3NLZXkpXHJcbiAgICAgICAgaWYgKCFqc29uKSB7XHJcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiTm8gc3RvcmVkIHNldHRpbmdzIGZvdW5kXCIpXHJcbiAgICAgICAgICAgIHJldHVybiBudWxsXHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBjb25zdCBzdGF0ZSA9IEpTT04ucGFyc2UoanNvbikgYXMgU3RhdGVcclxuICAgICAgICByZXR1cm4gc3RhdGVcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBzYXZlU3RhdGUoc3RhdGU6IFN0YXRlKSB7XHJcbiAgICAgICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oc2V0dGluZ3NLZXksIEpTT04uc3RyaW5naWZ5KHN0YXRlKSlcclxuICAgIH1cclxufVxyXG5cclxubWFpbigpIl19