import * as dom from "../shared/dom.js";
import * as channel from "../shared/channel.js";
const minPlaceholderLength = 16;
var TokenType;
(function (TokenType) {
    TokenType[TokenType["Text"] = 0] = "Text";
    TokenType[TokenType["Placeholder"] = 1] = "Placeholder";
})(TokenType || (TokenType = {}));
class CreateUi {
    constructor() {
        this.createDiv = dom.byId("createUi");
        this.form = dom.byId("createForm");
        this.titleInput = dom.byId("title");
        this.templateInput = dom.byId("template");
        this.clearButton = dom.byId("clearButton");
        this.placeholderSelect = dom.byId("placeholders");
        this.create = new channel.Channel();
        this.form.addEventListener("submit", evt => this.submit(evt));
        this.clearButton.addEventListener("click", _ => this.clear());
        this.templateInput.addEventListener("input", e => this.input(e));
    }
    show() {
        this.createDiv.hidden = false;
    }
    hide() {
        this.createDiv.hidden = true;
    }
    load(state) {
        this.titleInput.value = state.title;
        this.templateInput.value = state.template;
    }
    submit(evt) {
        evt.preventDefault();
        this.create.publish(this.titleInput.value, this.templateInput.value);
    }
    clear() {
        this.templateInput.value = "";
    }
}
class PrintUi {
    constructor() {
        this.printDiv = dom.byId("printUi");
        this.printTitle = dom.byId("printTitle");
        this.printContent = dom.byId("printContent");
        this.placeholderTemplate = dom.byId("placeholderTemplate");
        this.returnToTemplateButton = dom.byId("returnToTemplate");
        this.returnToTemplate = new channel.Channel();
        this.returnToTemplateButton.addEventListener("click", _ => this.returnToTemplate.publish());
    }
    show(title, template) {
        this.printDiv.hidden = false;
        this.printTitle.textContent = title;
        dom.removeAllChildren(this.printContent);
        let tokens = this.parseTemplate(template);
        for (const token of tokens) {
            const type = token.type;
            const value = template.substr(token.start, token.length);
            switch (type) {
                case TokenType.Text:
                    this.appendText(value);
                    break;
                case TokenType.Placeholder:
                    this.appendPlaceholder(value);
                    break;
            }
        }
    }
    hide() {
        this.printDiv.hidden = true;
    }
    parseTemplate(template) {
        let tokens = new Array();
        let i = 0;
        while (true) {
            const token = this.parseToken(template, i);
            tokens.push(token);
            i += token.length;
            if (i >= template.length) {
                break;
            }
        }
        return tokens;
    }
    parseToken(template, start) {
        // peek at next char
        const ch = template[start];
        if (ch !== '[') {
            return this.parseText(template, start);
        }
        return this.parsePlaceholder(template, start);
    }
    parsePlaceholder(template, start) {
        for (let i = start; i < template.length; ++i) {
            const ch = template[i];
            if (ch == ']') {
                return {
                    type: TokenType.Placeholder,
                    start: start,
                    length: i - start + 1,
                };
            }
        }
        return {
            type: TokenType.Placeholder,
            start: start,
            length: template.length - start,
        };
    }
    parseText(template, start) {
        for (let i = start; i < template.length; ++i) {
            const ch = template[i];
            if (ch == '[') {
                return {
                    type: TokenType.Text,
                    start: start,
                    length: i - start,
                };
            }
        }
        return {
            type: TokenType.Text,
            start: start,
            length: template.length - start,
        };
    }
    appendText(text) {
        const node = document.createTextNode(text);
        this.printContent.append(node);
    }
    appendPlaceholder(placeholder) {
        placeholder = this.formatPlaceholder(placeholder);
        const frag = this.placeholderTemplate.content.cloneNode(true);
        const textDiv = dom.bySelector(frag, ".placeholder-text");
        textDiv.textContent = placeholder;
        this.printContent.append(frag);
    }
    formatPlaceholder(placeholder) {
        if (placeholder.startsWith("[")) {
            placeholder = placeholder.substr(1);
        }
        if (placeholder.endsWith("]")) {
            placeholder = placeholder.substr(0, placeholder.length - 1);
        }
        placeholder = placeholder.trim();
        while (placeholder.length < minPlaceholderLength) {
            placeholder = ` ${placeholder} `;
        }
        return placeholder;
    }
}
async function main() {
    const createUi = new CreateUi();
    const printUi = new PrintUi();
    const settingsKey = "madSettings";
    createUi.show();
    createUi.create.subcribe(onCreate);
    printUi.returnToTemplate.subcribe(onReturnToTemplate);
    const state = loadState();
    if (state) {
        createUi.load(state);
    }
    function onCreate(title, template) {
        createUi.hide();
        saveState({ title, template });
        printUi.show(title, template);
    }
    function onReturnToTemplate() {
        printUi.hide();
        createUi.show();
    }
    function loadState() {
        const json = localStorage.getItem(settingsKey);
        if (!json) {
            console.log("No stored settings found");
            return null;
        }
        const state = JSON.parse(json);
        return state;
    }
    function saveState(state) {
        localStorage.setItem(settingsKey, JSON.stringify(state));
    }
}
main();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFkLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsibWFkLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sS0FBSyxHQUFHLE1BQU0sa0JBQWtCLENBQUE7QUFDdkMsT0FBTyxLQUFLLE9BQU8sTUFBTSxzQkFBc0IsQ0FBQTtBQUUvQyxNQUFNLG9CQUFvQixHQUFHLEVBQUUsQ0FBQztBQU9oQyxJQUFLLFNBR0o7QUFIRCxXQUFLLFNBQVM7SUFDVix5Q0FBSSxDQUFBO0lBQ0osdURBQVcsQ0FBQTtBQUNmLENBQUMsRUFISSxTQUFTLEtBQVQsU0FBUyxRQUdiO0FBUUQsTUFBTSxRQUFRO0lBU1Y7UUFSaUIsY0FBUyxHQUFHLEdBQUcsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUE7UUFDaEMsU0FBSSxHQUFHLEdBQUcsQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUE7UUFDN0IsZUFBVSxHQUFHLEdBQUcsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFxQixDQUFBO1FBQ2xELGtCQUFhLEdBQUcsR0FBRyxDQUFDLElBQUksQ0FBQyxVQUFVLENBQXdCLENBQUE7UUFDM0QsZ0JBQVcsR0FBRyxHQUFHLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxDQUFBO1FBQ3JDLHNCQUFpQixHQUFHLEdBQUcsQ0FBQyxJQUFJLENBQUMsY0FBYyxDQUFDLENBQUE7UUFDN0MsV0FBTSxHQUFHLElBQUksT0FBTyxDQUFDLE9BQU8sRUFBb0IsQ0FBQTtRQUc1RCxJQUFJLENBQUMsSUFBSSxDQUFDLGdCQUFnQixDQUFDLFFBQVEsRUFBRSxHQUFHLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQTtRQUM3RCxJQUFJLENBQUMsV0FBVyxDQUFDLGdCQUFnQixDQUFDLE9BQU8sRUFBRSxDQUFDLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUUsQ0FBQyxDQUFBO1FBQzdELElBQUksQ0FBQyxhQUFh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RUFBRSxDQUFBO1FBQ2YsU0FBUyxDQUFDLEVBQUUsS0FBSyxFQUFFLFFBQVEsRUFBRSxDQUFDLENBQUE7UUFDOUIsT0FBTyxDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUUsUUFBUSxDQUFDLENBQUE7SUFDakMsQ0FBQztJQUVELFNBQVMsa0JBQWtCO1FBQ3ZCLE9BQU8sQ0FBQyxJQUFJLEVBQUUsQ0FBQTtRQUNkLFFBQVEsQ0FBQyxJQUFJLEVBQUUsQ0FBQTtJQUNuQixDQUFDO0lBRUQsU0FBUyxTQUFTO1FBQ2QsTUFBTSxJQUFJLEdBQUcsWUFBWSxDQUFDLE9BQU8sQ0FBQyxXQUFXLENBQUMsQ0FBQTtRQUM5QyxJQUFJLENBQUMsSUFBSSxFQUFFO1lBQ1AsT0FBTyxDQUFDLEdBQUcsQ0FBQywwQkFBMEIsQ0FBQyxDQUFBO1lBQ3ZDLE9BQU8sSUFBSSxDQUFBO1NBQ2Q7UUFFRCxNQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBVSxDQUFBO1FBQ3ZDLE9BQU8sS0FBSyxDQUFBO0lBQ2hCLENBQUM7SUFFRCxTQUFTLFNBQVMsQ0FBQyxLQUFZO1FBQzNCLFlBQVksQ0FBQyxPQUFPLENBQUMsV0FBVyxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQTtJQUM1RCxDQUFDO0FBQ0wsQ0FBQztBQUVELElBQUksRUFBRSxDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgZG9tIGZyb20gXCIuLi9zaGFyZWQvZG9tLmpzXCJcclxuaW1wb3J0ICogYXMgY2hhbm5lbCBmcm9tIFwiLi4vc2hhcmVkL2NoYW5uZWwuanNcIlxyXG5cclxuY29uc3QgbWluUGxhY2Vob2xkZXJMZW5ndGggPSAxNjtcclxuXHJcbmludGVyZmFjZSBTdGF0ZSB7XHJcbiAgICB0aXRsZTogc3RyaW5nXHJcbiAgICB0ZW1wbGF0ZTogc3RyaW5nXHJcbn1cclxuXHJcbmVudW0gVG9rZW5UeXBlIHtcclxuICAgIFRleHQsXHJcbiAgICBQbGFjZWhvbGRlcixcclxufVxyXG5cclxuaW50ZXJmYWNlIFRva2VuIHtcclxuICAgIHR5cGU6IFRva2VuVHlwZSxcclxuICAgIHN0YXJ0OiBudW1iZXIsXHJcbiAgICBsZW5ndGg6IG51bWJlcixcclxufVxyXG5cclxuY2xhc3MgQ3JlYXRlVWkge1xyXG4gICAgcHJpdmF0ZSByZWFkb25seSBjcmVhdGVEaXYgPSBkb20uYnlJZChcImNyZWF0ZVVpXCIpXHJcbiAgICBwcml2YXRlIHJlYWRvbmx5IGZvcm0gPSBkb20uYnlJZChcImNyZWF0ZUZvcm1cIilcclxuICAgIHByaXZhdGUgcmVhZG9ubHkgdGl0bGVJbnB1dCA9IGRvbS5ieUlkKFwidGl0bGVcIikgYXMgSFRNTElucHV0RWxlbWVudFxyXG4gICAgcHJpdmF0ZSByZWFkb25seSB0ZW1wbGF0ZUlucHV0ID0gZG9tLmJ5SWQoXCJ0ZW1wbGF0ZVwiKSBhcyBIVE1MVGV4dEFyZWFFbGVtZW50XHJcbiAgICBwcml2YXRlIHJlYWRvbmx5IGNsZWFyQnV0dG9uID0gZG9tLmJ5SWQoXCJjbGVhckJ1dHRvblwiKVxyXG4gICAgcHJpdmF0ZSByZWFkb25seSBwbGFjZWhvbGRlclNlbGVjdCA9IGRvbS5ieUlkKFwicGxhY2Vob2xkZXJzXCIpXHJcbiAgICBwdWJsaWMgcmVhZG9ubHkgY3JlYXRlID0gbmV3IGNoYW5uZWwuQ2hhbm5lbDxbc3RyaW5nLCBzdHJpbmddPigpXHJcblxyXG4gICAgY29uc3RydWN0b3IoKSB7XHJcbiAgICAgICAgdGhpcy5mb3JtLmFkZEV2ZW50TGlzdGVuZXIoXCJzdWJtaXRcIiwgZXZ0ID0+IHRoaXMuc3VibWl0KGV2dCkpXHJcbiAgICAgICAgdGhpcy5jbGVhckJ1dHRvbi5hZGRFdmVudExpc3RlbmVyKFwiY2xpY2tcIiwgXyA9PiB0aGlzLmNsZWFyKCkpXHJcbiAgICAgICAgdGhpcy50ZW1wbGF0ZUlucHV0LmFkZEV2ZW50TGlzdGVuZXIoXCJpbnB1dFwiLCBlID0+IHRoaXMuaW5wdXQoZSkpXHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIHNob3coKSB7XHJcbiAgICAgICAgdGhpcy5jcmVhdGVEaXYuaGlkZGVuID0gZmFsc2VcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgaGlkZSgpIHtcclxuICAgICAgICB0aGlzLmNyZWF0ZURpdi5oaWRkZW4gPSB0cnVlXHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIGxvYWQoc3RhdGU6IFN0YXRlKSB7XHJcbiAgICAgICAgdGhpcy50aXRsZUlucHV0LnZhbHVlID0gc3RhdGUudGl0bGVcclxuICAgICAgICB0aGlzLnRlbXBsYXRlSW5wdXQudmFsdWUgPSBzdGF0ZS50ZW1wbGF0ZVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgc3VibWl0KGV2dDogRXZlbnQpIHtcclxuICAgICAgICBldnQucHJldmVudERlZmF1bHQoKVxyXG4gICAgICAgIHRoaXMuY3JlYXRlLnB1Ymxpc2godGhpcy50aXRsZUlucHV0LnZhbHVlLCB0aGlzLnRlbXBsYXRlSW5wdXQudmFsdWUpXHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBjbGVhcigpIHtcclxuICAgICAgICB0aGlzLnRlbXBsYXRlSW5wdXQudmFsdWUgPSBcIlwiXHJcbiAgICB9XHJcbn1cclxuXHJcbmNsYXNzIFByaW50VWkge1xyXG4gICAgcHJpdmF0ZSByZWFkb25seSBwcmludERpdiA9IGRvbS5ieUlkKFwicHJpbnRVaVwiKVxyXG4gICAgcHJpdmF0ZSByZWFkb25seSBwcmludFRpdGxlID0gZG9tLmJ5SWQoXCJwcmludFRpdGxlXCIpXHJcbiAgICBwcml2YXRlIHJlYWRvbmx5IHByaW50Q29udGVudCA9IGRvbS5ieUlkKFwicHJpbnRDb250ZW50XCIpXHJcbiAgICBwcml2YXRlIHJlYWRvbmx5IHBsYWNlaG9sZGVyVGVtcGxhdGUgPSBkb20uYnlJZChcInBsYWNlaG9sZGVyVGVtcGxhdGVcIikgYXMgSFRNTFRlbXBsYXRlRWxlbWVudFxyXG4gICAgcHJpdmF0ZSByZWFkb25seSByZXR1cm5Ub1RlbXBsYXRlQnV0dG9uID0gZG9tLmJ5SWQoXCJyZXR1cm5Ub1RlbXBsYXRlXCIpXHJcbiAgICBwdWJsaWMgcmVhZG9ubHkgcmV0dXJuVG9UZW1wbGF0ZSA9IG5ldyBjaGFubmVsLkNoYW5uZWw8W3ZvaWRdPigpXHJcblxyXG4gICAgY29uc3RydWN0b3IoKSB7XHJcbiAgICAgICAgdGhpcy5yZXR1cm5Ub1RlbXBsYXRlQnV0dG9uLmFkZEV2ZW50TGlzdGVuZXIoXCJjbGlja1wiLCBfID0+IHRoaXMucmV0dXJuVG9UZW1wbGF0ZS5wdWJsaXNoKCkpXHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIHNob3codGl0bGU6IHN0cmluZywgdGVtcGxhdGU6IHN0cmluZykge1xyXG4gICAgICAgIHRoaXMucHJpbnREaXYuaGlkZGVuID0gZmFsc2VcclxuICAgICAgICB0aGlzLnByaW50VGl0bGUudGV4dENvbnRlbnQgPSB0aXRsZVxyXG4gICAgICAgIGRvbS5yZW1vdmVBbGxDaGlsZHJlbih0aGlzLnByaW50Q29udGVudClcclxuICAgICAgICBsZXQgdG9rZW5zID0gdGhpcy5wYXJzZVRlbXBsYXRlKHRlbXBsYXRlKVxyXG5cclxuICAgICAgICBmb3IgKGNvbnN0IHRva2VuIG9mIHRva2Vucykge1xyXG4gICAgICAgICAgICBjb25zdCB0eXBlID0gdG9rZW4udHlwZVxyXG4gICAgICAgICAgICBjb25zdCB2YWx1ZSA9IHRlbXBsYXRlLnN1YnN0cih0b2tlbi5zdGFydCwgdG9rZW4ubGVuZ3RoKVxyXG5cclxuICAgICAgICAgICAgc3dpdGNoICh0eXBlKSB7XHJcbiAgICAgICAgICAgICAgICBjYXNlIFRva2VuVHlwZS5UZXh0OlxyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuYXBwZW5kVGV4dCh2YWx1ZSlcclxuICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuXHJcbiAgICAgICAgICAgICAgICBjYXNlIFRva2VuVHlwZS5QbGFjZWhvbGRlcjpcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmFwcGVuZFBsYWNlaG9sZGVyKHZhbHVlKVxyXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBoaWRlKCkge1xyXG4gICAgICAgIHRoaXMucHJpbnREaXYuaGlkZGVuID0gdHJ1ZVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgcGFyc2VUZW1wbGF0ZSh0ZW1wbGF0ZTogc3RyaW5nKTogVG9rZW5bXSB7XHJcbiAgICAgICAgbGV0IHRva2VucyA9IG5ldyBBcnJheTxUb2tlbj4oKTtcclxuICAgICAgICBsZXQgaSA9IDA7XHJcbiAgICAgICAgd2hpbGUgKHRydWUpIHtcclxuICAgICAgICAgICAgY29uc3QgdG9rZW4gPSB0aGlzLnBhcnNlVG9rZW4odGVtcGxhdGUsIGkpO1xyXG4gICAgICAgICAgICB0b2tlbnMucHVzaCh0b2tlbilcclxuICAgICAgICAgICAgaSArPSB0b2tlbi5sZW5ndGg7XHJcblxyXG4gICAgICAgICAgICBpZiAoaSA+PSB0ZW1wbGF0ZS5sZW5ndGgpIHtcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gdG9rZW5zXHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBwYXJzZVRva2VuKHRlbXBsYXRlOiBzdHJpbmcsIHN0YXJ0OiBudW1iZXIpOiBUb2tlbiB7XHJcbiAgICAgICAgLy8gcGVlayBhdCBuZXh0IGNoYXJcclxuICAgICAgICBjb25zdCBjaCA9IHRlbXBsYXRlW3N0YXJ0XVxyXG4gICAgICAgIGlmIChjaCAhPT0gJ1snKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzLnBhcnNlVGV4dCh0ZW1wbGF0ZSwgc3RhcnQpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIHRoaXMucGFyc2VQbGFjZWhvbGRlcih0ZW1wbGF0ZSwgc3RhcnQpO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgcGFyc2VQbGFjZWhvbGRlcih0ZW1wbGF0ZTogc3RyaW5nLCBzdGFydDogbnVtYmVyKTogVG9rZW4ge1xyXG4gICAgICAgIGZvciAobGV0IGkgPSBzdGFydDsgaSA8IHRlbXBsYXRlLmxlbmd0aDsgKytpKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGNoID0gdGVtcGxhdGVbaV07XHJcbiAgICAgICAgICAgIGlmIChjaCA9PSAnXScpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgICAgICAgICAgdHlwZTogVG9rZW5UeXBlLlBsYWNlaG9sZGVyLFxyXG4gICAgICAgICAgICAgICAgICAgIHN0YXJ0OiBzdGFydCxcclxuICAgICAgICAgICAgICAgICAgICBsZW5ndGg6IGkgLSBzdGFydCArIDEsXHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgIHR5cGU6IFRva2VuVHlwZS5QbGFjZWhvbGRlcixcclxuICAgICAgICAgICAgc3RhcnQ6IHN0YXJ0LFxyXG4gICAgICAgICAgICBsZW5ndGg6IHRlbXBsYXRlLmxlbmd0aCAtIHN0YXJ0LFxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIHBhcnNlVGV4dCh0ZW1wbGF0ZTogc3RyaW5nLCBzdGFydDogbnVtYmVyKTogVG9rZW4ge1xyXG4gICAgICAgIGZvciAobGV0IGkgPSBzdGFydDsgaSA8IHRlbXBsYXRlLmxlbmd0aDsgKytpKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGNoID0gdGVtcGxhdGVbaV07XHJcbiAgICAgICAgICAgIGlmIChjaCA9PSAnWycpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgICAgICAgICAgdHlwZTogVG9rZW5UeXBlLlRleHQsXHJcbiAgICAgICAgICAgICAgICAgICAgc3RhcnQ6IHN0YXJ0LFxyXG4gICAgICAgICAgICAgICAgICAgIGxlbmd0aDogaSAtIHN0YXJ0LFxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICB0eXBlOiBUb2tlblR5cGUuVGV4dCxcclxuICAgICAgICAgICAgc3RhcnQ6IHN0YXJ0LFxyXG4gICAgICAgICAgICBsZW5ndGg6IHRlbXBsYXRlLmxlbmd0aCAtIHN0YXJ0LFxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGFwcGVuZFRleHQodGV4dDogc3RyaW5nKSB7XHJcbiAgICAgICAgY29uc3Qgbm9kZSA9IGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKHRleHQpXHJcbiAgICAgICAgdGhpcy5wcmludENvbnRlbnQuYXBwZW5kKG5vZGUpXHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBhcHBlbmRQbGFjZWhvbGRlcihwbGFjZWhvbGRlcjogc3RyaW5nKSB7XHJcbiAgICAgICAgcGxhY2Vob2xkZXIgPSB0aGlzLmZvcm1hdFBsYWNlaG9sZGVyKHBsYWNlaG9sZGVyKVxyXG4gICAgICAgIGNvbnN0IGZyYWcgPSB0aGlzLnBsYWNlaG9sZGVyVGVtcGxhdGUuY29udGVudC5jbG9uZU5vZGUodHJ1ZSkgYXMgRG9jdW1lbnRGcmFnbWVudFxyXG4gICAgICAgIGNvbnN0IHRleHREaXYgPSBkb20uYnlTZWxlY3RvcihmcmFnLCBcIi5wbGFjZWhvbGRlci10ZXh0XCIpO1xyXG4gICAgICAgIHRleHREaXYudGV4dENvbnRlbnQgPSBwbGFjZWhvbGRlclxyXG4gICAgICAgIHRoaXMucHJpbnRDb250ZW50LmFwcGVuZChmcmFnKVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgZm9ybWF0UGxhY2Vob2xkZXIocGxhY2Vob2xkZXI6IHN0cmluZykge1xyXG4gICAgICAgIGlmIChwbGFjZWhvbGRlci5zdGFydHNXaXRoKFwiW1wiKSkge1xyXG4gICAgICAgICAgICBwbGFjZWhvbGRlciA9IHBsYWNlaG9sZGVyLnN1YnN0cigxKVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKHBsYWNlaG9sZGVyLmVuZHNXaXRoKFwiXVwiKSkge1xyXG4gICAgICAgICAgICBwbGFjZWhvbGRlciA9IHBsYWNlaG9sZGVyLnN1YnN0cigwLCBwbGFjZWhvbGRlci5sZW5ndGggLSAxKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHBsYWNlaG9sZGVyID0gcGxhY2Vob2xkZXIudHJpbSgpXHJcbiAgICAgICAgd2hpbGUgKHBsYWNlaG9sZGVyLmxlbmd0aCA8IG1pblBsYWNlaG9sZGVyTGVuZ3RoKSB7XHJcbiAgICAgICAgICAgIHBsYWNlaG9sZGVyID0gYCAke3BsYWNlaG9sZGVyfSBgO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIHBsYWNlaG9sZGVyXHJcbiAgICB9XHJcbn1cclxuXHJcbmFzeW5jIGZ1bmN0aW9uIG1haW4oKSB7XHJcbiAgICBjb25zdCBjcmVhdGVVaSA9IG5ldyBDcmVhdGVVaSgpXHJcbiAgICBjb25zdCBwcmludFVpID0gbmV3IFByaW50VWkoKVxyXG4gICAgY29uc3Qgc2V0dGluZ3NLZXkgPSBcIm1hZFNldHRpbmdzXCJcclxuXHJcbiAgICBjcmVhdGVVaS5zaG93KClcclxuXHJcbiAgICBjcmVhdGVVaS5jcmVhdGUuc3ViY3JpYmUob25DcmVhdGUpXHJcbiAgICBwcmludFVpLnJldHVyblRvVGVtcGxhdGUuc3ViY3JpYmUob25SZXR1cm5Ub1RlbXBsYXRlKVxyXG5cclxuICAgIGNvbnN0IHN0YXRlID0gbG9hZFN0YXRlKClcclxuICAgIGlmIChzdGF0ZSkge1xyXG4gICAgICAgIGNyZWF0ZVVpLmxvYWQoc3RhdGUpXHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gb25DcmVhdGUodGl0bGU6IHN0cmluZywgdGVtcGxhdGU6IHN0cmluZykge1xyXG4gICAgICAgIGNyZWF0ZVVpLmhpZGUoKVxyXG4gICAgICAgIHNhdmVTdGF0ZSh7IHRpdGxlLCB0ZW1wbGF0ZSB9KVxyXG4gICAgICAgIHByaW50VWkuc2hvdyh0aXRsZSwgdGVtcGxhdGUpXHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gb25SZXR1cm5Ub1RlbXBsYXRlKCkge1xyXG4gICAgICAgIHByaW50VWkuaGlkZSgpXHJcbiAgICAgICAgY3JlYXRlVWkuc2hvdygpXHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gbG9hZFN0YXRlKCk6IFN0YXRlIHwgbnVsbCB7XHJcbiAgICAgICAgY29uc3QganNvbiA9IGxvY2FsU3RvcmFnZS5nZXRJdGVtKHNldHRpbmdzS2V5KVxyXG4gICAgICAgIGlmICghanNvbikge1xyXG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcIk5vIHN0b3JlZCBzZXR0aW5ncyBmb3VuZFwiKVxyXG4gICAgICAgICAgICByZXR1cm4gbnVsbFxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgY29uc3Qgc3RhdGUgPSBKU09OLnBhcnNlKGpzb24pIGFzIFN0YXRlXHJcbiAgICAgICAgcmV0dXJuIHN0YXRlXHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gc2F2ZVN0YXRlKHN0YXRlOiBTdGF0ZSkge1xyXG4gICAgICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKHNldHRpbmdzS2V5LCBKU09OLnN0cmluZ2lmeShzdGF0ZSkpXHJcbiAgICB9XHJcbn1cclxuXHJcbm1haW4oKSJdfQ==