import * as dom from "../shared/dom.js";
import * as geo from "../shared/geo3d.js";
import * as gfx from "./gfx.js";
// step 1 - clear screen, init gl, etc...
// step 2 - draw a clip space triangle
// step 3 - draw a world space triangle
class App {
    constructor() {
        this.canvas = dom.byId("canvas");
        this.renderer = new gfx.Renderer(this.canvas);
        this.ticks = 0;
        this.fieldBatch = null;
        this.ballBatch = null;
        this.paddleBatch = null;
    }
    exec() {
        this.initScene();
        requestAnimationFrame(() => this.tick());
    }
    initScene() {
        this.renderer.viewMatrix = geo.Mat4.lookAt(new geo.Vec3(0, -16, 16), new geo.Vec3(0, 0, -1), new geo.Vec3(0, 1, 0)).invert();
        this.initPlayingField();
    }
    initPlayingField() {
        // generate border
        const ixm = new gfx.IxMesh();
        const brickRows = 5;
        const brickCols = 10;
        const brickWidth = 2;
        const brickHeight = 1;
        const borderWidth = 1;
        const fieldWidth = brickWidth * brickCols + borderWidth * 2;
        const fieldHeight = brickHeight * brickRows * 4 + borderWidth * 2;
        const left = -fieldWidth / 2;
        const right = left + fieldWidth;
        const bottom = -fieldHeight / 2;
        const top = bottom + fieldHeight;
        const brickMargin = .1;
        const topRowMargin = 1;
        const paddleBottomMargin = 1;
        // playing field
        {
            // floor
            {
                const floor = gfx.IxMesh.rect(new geo.AABB(new geo.Vec3(left, bottom, -3), new geo.Vec3(right, top, -1)));
                floor.vertices.forEach(v => v.color = new geo.Vec4(1, 1, 1, 1));
                ixm.cat(floor);
            }
            // border
            {
                const walls = new gfx.IxMesh();
                walls.cat(gfx.IxMesh.rect(new geo.AABB(new geo.Vec3(left, bottom + borderWidth, -1), new geo.Vec3(left + borderWidth, top - borderWidth, 1))));
                walls.cat(gfx.IxMesh.rect(new geo.AABB(new geo.Vec3(right - borderWidth, bottom + borderWidth, -1), new geo.Vec3(right, top - borderWidth, 1))));
                walls.cat(gfx.IxMesh.rect(new geo.AABB(new geo.Vec3(left, bottom, -1), new geo.Vec3(right, bottom + borderWidth, 1))));
                walls.cat(gfx.IxMesh.rect(new geo.AABB(new geo.Vec3(left, top - borderWidth, -1), new geo.Vec3(right, top, 1))));
                walls.vertices.forEach(v => v.color = new geo.Vec4(1, 0, 0, 1));
                ixm.cat(walls);
            }
            // bricks
            {
                const bricks = new gfx.IxMesh();
                const fieldXOffset = left + borderWidth;
                const fieldYOffset = top - topRowMargin - brickHeight * brickRows;
                for (let i = 0; i < brickRows; ++i) {
                    const yOffset = fieldYOffset + i * brickHeight + brickMargin;
                    for (let j = 0; j < brickCols; ++j) {
                        const xOffset = fieldXOffset + j * brickWidth + brickMargin;
                        const brick = gfx.IxMesh.rect(new geo.AABB(new geo.Vec3(xOffset, yOffset, -1), new geo.Vec3(xOffset + brickWidth - brickMargin, yOffset + brickHeight - brickMargin, 1)));
                        bricks.cat(brick);
                    }
                }
                bricks.vertices.forEach(v => v.color = new geo.Vec4(0, 1, 0, 1));
                ixm.cat(bricks);
            }
            const vao = this.renderer.createMesh(ixm);
            this.fieldBatch = {
                vao: vao,
                worldMatrix: geo.Mat4.identity(),
                offset: 0,
                numIndices: ixm.indices.length
            };
        }
        // add player paddle and ball
        {
            const ixm = gfx.IxMesh.sphere(16, 16);
            ixm.vertices.forEach(v => v.color = new geo.Vec4(0, 0, 1, 1));
            const vao = this.renderer.createMesh(ixm);
            this.ballBatch = {
                vao,
                worldMatrix: geo.Mat4.identity(),
                offset: 0,
                numIndices: ixm.indices.length
            };
        }
        // add paddle
        {
            const paddleWidth = 4;
            const paddleHeight = 1;
            const ixm = gfx.IxMesh.rect(new geo.AABB(new geo.Vec3(-paddleWidth / 2, bottom + borderWidth + paddleBottomMargin, -1), new geo.Vec3(paddleWidth / 2, bottom + borderWidth + paddleBottomMargin + paddleHeight, 1)));
            ixm.vertices.forEach(v => v.color = new geo.Vec4(0, 1, 1, 1));
            const vao = this.renderer.createMesh(ixm);
            this.paddleBatch = {
                vao,
                worldMatrix: geo.Mat4.identity(),
                offset: 0,
                numIndices: ixm.indices.length
            };
        }
    }
    tick() {
        this.checkSize();
        this.drawScene();
        requestAnimationFrame(() => this.tick());
        ++this.ticks;
    }
    checkSize() {
        if (this.canvas.width === this.canvas.clientWidth && this.canvas.height === this.canvas.clientHeight) {
            return;
        }
        this.canvas.width = this.canvas.clientWidth;
        this.canvas.height = this.canvas.clientHeight;
    }
    drawScene() {
        // const rate = Math.PI / 240
        const rate = 0;
        const worldMatrix = geo.Mat4.rotationX(this.ticks * rate);
        if (this.fieldBatch) {
            this.fieldBatch.worldMatrix = worldMatrix;
            this.renderer.drawBatch(this.fieldBatch);
        }
        if (this.ballBatch) {
            this.ballBatch.worldMatrix = worldMatrix;
            this.renderer.drawBatch(this.ballBatch);
        }
        if (this.paddleBatch) {
            this.paddleBatch.worldMatrix = worldMatrix;
            this.renderer.drawBatch(this.paddleBatch);
        }
        this.renderer.present();
    }
}
const app = new App();
app.exec();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYnJlYWtvdXQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJicmVha291dC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEtBQUssR0FBRyxNQUFNLGtCQUFrQixDQUFBO0FBQ3ZDLE9BQU8sS0FBSyxHQUFHLE1BQU0sb0JBQW9CLENBQUE7QUFDekMsT0FBTyxLQUFLLEdBQUcsTUFBTSxVQUFVLENBQUE7QUFFL0IseUNBQXlDO0FBQ3pDLHNDQUFzQztBQUN0Qyx1Q0FBdUM7QUFDdkMsTUFBTSxHQUFHO0lBQVQ7UUFDcUIsV0FBTSxHQUFHLEdBQUcsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFzQixDQUFBO1FBQ2hELGFBQVEsR0FBRyxJQUFJLEdBQUcsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFBO1FBQ2pELFVBQUssR0FBRyxDQUFDLENBQUE7UUFDVCxlQUFVLEdBQXFCLElBQUksQ0FBQTtRQUNuQyxjQUFTLEdBQXFCLElBQUksQ0FBQTtRQUNsQyxnQkFBVyxHQUFxQixJQUFJLENBQUE7SUE0SmhELENBQUM7SUExSkcsSUFBSTtRQUNBLElBQUksQ0FBQyxTQUFTLEVBQUUsQ0FBQTtRQUNoQixxQkFBcUIsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQTtJQUM1QyxDQUFDO0lBRU8sU0FBUztRQUNiLElBQUksQ0FBQyxRQUFRLENBQUMsVUFBVSxHQUFHLEdBQUcsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUUsRUFBRSxDQUFDLEVBQUUsSUFBSSxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsRUFBRSxJQUFJLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFBO1FBQzVILElBQUksQ0FBQyxnQkFBZ0IsRUFBRSxDQUFBO0lBQzNCLENBQUM7SUFFTyxnQkFBZ0I7UUFDcEIsa0JBQWtCO1FBQ2xCLE1BQU0sR0FBRyxHQUFHLElBQUksR0FBRyxDQUFDLE1BQU0sRUFBRSxDQUFBO1FBQzVCLE1BQU0sU0FBUyxHQUFHLENBQUMsQ0FBQTtRQUNuQixNQUFNLFNBQVMsR0FBRyxFQUFFLENBQUE7UUFDcEIsTUFBTSxVQUFVLEdBQUcsQ0FBQyxDQUFBO1FBQ3BCLE1BQU0sV0FBVyxHQUFHLENBQUMsQ0FBQTtRQUNyQixNQUFNLFdBQVcsR0FBRyxDQUFDLENBQUE7UUFDckIsTUFBTSxVQUFVLEdBQUcsVUFBVSxHQUFHLFNBQVMsR0FBRyxXQUFXLEdBQUcsQ0FBQyxDQUFBO1FBQzNELE1BQU0sV0FBVyxHQUFHLFdBQVcsR0FBRyxTQUFTLEdBQUcsQ0FBQyxHQUFHLFdBQVcsR0FBRyxDQUFDLENBQUE7UUFDakUsTUFBTSxJQUFJLEdBQUcsQ0FBQyxVQUFVLEdBQUcsQ0FBQyxDQUFBO1FBQzVCLE1BQU0sS0FBSyxHQUFHLElBQUksR0FBRyxVQUFVLENBQUE7UUFDL0IsTUFBTSxNQUFNLEdBQUcsQ0FBQyxXQUFXLEdBQUcsQ0FBQyxDQUFBO1FBQy9CLE1BQU0sR0FBRyxHQUFHLE1BQU0sR0FBRyxXQUFXLENBQUE7UUFDaEMsTUFBTSxXQUFXLEdBQUcsRUFBRSxDQUFBO1FBQ3RCLE1BQU0sWUFBWSxHQUFHLENBQUMsQ0FBQTtRQUN0QixNQUFNLGtCQUFrQixHQUFHLENBQUMsQ0FBQTtRQUU1QixnQkFBZ0I7UUFDaEI7WUFDSSxRQUFRO1lBQ1I7Z0JBQ0ksTUFBTSxLQUFLLEdBQUcsR0FBRyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxHQUFHLENBQUMsSUFBSSxDQUFDLElBQUksR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsTUFBTSxFQUFFLENBQUMsQ0FBQyxDQUFDLEVBQUUsSUFBSSxHQUFHLENBQUMsSUFBSSxDQUFDLEtBQUssRUFBRSxHQUFHLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUE7Z0JBQ3pHLEtBQUssQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLEtBQUssR0FBRyxJQUFJLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQTtnQkFDL0QsR0FBRyxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQTthQUNqQjtZQUVELFNBQVM7WUFDVDtnQkFDSSxNQUFNLEtBQUssR0FBRyxJQUFJLEdBQUcsQ0FBQyxNQUFNLEVBQUUsQ0FBQTtnQkFDOUIsS0FBSyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxHQUFHLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxNQUFNLEdBQUcsV0FBVyxFQUFFLENBQUMsQ0FBQyxDQUFDLEVBQUUsSUFBSSxHQUFHLENBQUMsSUFBSSxDQUFDLElBQUksR0FBRyxXQUFXLEVBQUUsR0FBRyxHQUFHLFdBQVcsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQTtnQkFDOUksS0FBSyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxHQUFHLENBQUMsSUFBSSxDQUFDLEtBQUssR0FBRyxXQUFXLEVBQUUsTUFBTSxHQUFHLFdBQVcsRUFBRSxDQUFDLENBQUMsQ0FBQyxFQUFFLElBQUksR0FBRyxDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUUsR0FBRyxHQUFHLFdBQVcsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQTtnQkFDaEosS0FBSyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxHQUFHLENBQUMs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SSxJQUFJLENBQUMsVUFBVSxFQUFFO1lBQ2pCLElBQUksQ0FBQyxVQUFVLENBQUMsV0FBVyxHQUFHLFdBQVcsQ0FBQTtZQUN6QyxJQUFJLENBQUMsUUFBUSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUE7U0FDM0M7UUFFRCxJQUFJLElBQUksQ0FBQyxTQUFTLEVBQUU7WUFDaEIsSUFBSSxDQUFDLFNBQVMsQ0FBQyxXQUFXLEdBQUcsV0FBVyxDQUFBO1lBQ3hDLElBQUksQ0FBQyxRQUFRLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQTtTQUMxQztRQUVELElBQUksSUFBSSxDQUFDLFdBQVcsRUFBRTtZQUNsQixJQUFJLENBQUMsV0FBVyxDQUFDLFdBQVcsR0FBRyxXQUFXLENBQUE7WUFDMUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFBO1NBQzVDO1FBRUQsSUFBSSxDQUFDLFFBQVEsQ0FBQyxPQUFPLEVBQUUsQ0FBQTtJQUMzQixDQUFDO0NBQ0o7QUFFRCxNQUFNLEdBQUcsR0FBRyxJQUFJLEdBQUcsRUFBRSxDQUFBO0FBQ3JCLEdBQUcsQ0FBQyxJQUFJLEVBQUUsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIGRvbSBmcm9tIFwiLi4vc2hhcmVkL2RvbS5qc1wiXHJcbmltcG9ydCAqIGFzIGdlbyBmcm9tIFwiLi4vc2hhcmVkL2dlbzNkLmpzXCJcclxuaW1wb3J0ICogYXMgZ2Z4IGZyb20gXCIuL2dmeC5qc1wiXHJcblxyXG4vLyBzdGVwIDEgLSBjbGVhciBzY3JlZW4sIGluaXQgZ2wsIGV0Yy4uLlxyXG4vLyBzdGVwIDIgLSBkcmF3IGEgY2xpcCBzcGFjZSB0cmlhbmdsZVxyXG4vLyBzdGVwIDMgLSBkcmF3IGEgd29ybGQgc3BhY2UgdHJpYW5nbGVcclxuY2xhc3MgQXBwIHtcclxuICAgIHByaXZhdGUgcmVhZG9ubHkgY2FudmFzID0gZG9tLmJ5SWQoXCJjYW52YXNcIikgYXMgSFRNTENhbnZhc0VsZW1lbnRcclxuICAgIHByaXZhdGUgcmVhZG9ubHkgcmVuZGVyZXIgPSBuZXcgZ2Z4LlJlbmRlcmVyKHRoaXMuY2FudmFzKVxyXG4gICAgcHJpdmF0ZSB0aWNrcyA9IDBcclxuICAgIHByaXZhdGUgZmllbGRCYXRjaDogZ2Z4LkJhdGNoIHwgbnVsbCA9IG51bGxcclxuICAgIHByaXZhdGUgYmFsbEJhdGNoOiBnZnguQmF0Y2ggfCBudWxsID0gbnVsbFxyXG4gICAgcHJpdmF0ZSBwYWRkbGVCYXRjaDogZ2Z4LkJhdGNoIHwgbnVsbCA9IG51bGxcclxuXHJcbiAgICBleGVjKCkge1xyXG4gICAgICAgIHRoaXMuaW5pdFNjZW5lKClcclxuICAgICAgICByZXF1ZXN0QW5pbWF0aW9uRnJhbWUoKCkgPT4gdGhpcy50aWNrKCkpXHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBpbml0U2NlbmUoKSB7XHJcbiAgICAgICAgdGhpcy5yZW5kZXJlci52aWV3TWF0cml4ID0gZ2VvLk1hdDQubG9va0F0KG5ldyBnZW8uVmVjMygwLCAtMTYsIDE2KSwgbmV3IGdlby5WZWMzKDAsIDAsIC0xKSwgbmV3IGdlby5WZWMzKDAsIDEsIDApKS5pbnZlcnQoKVxyXG4gICAgICAgIHRoaXMuaW5pdFBsYXlpbmdGaWVsZCgpXHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBpbml0UGxheWluZ0ZpZWxkKCkge1xyXG4gICAgICAgIC8vIGdlbmVyYXRlIGJvcmRlclxyXG4gICAgICAgIGNvbnN0IGl4bSA9IG5ldyBnZnguSXhNZXNoKClcclxuICAgICAgICBjb25zdCBicmlja1Jvd3MgPSA1XHJcbiAgICAgICAgY29uc3QgYnJpY2tDb2xzID0gMTBcclxuICAgICAgICBjb25zdCBicmlja1dpZHRoID0gMlxyXG4gICAgICAgIGNvbnN0IGJyaWNrSGVpZ2h0ID0gMVxyXG4gICAgICAgIGNvbnN0IGJvcmRlcldpZHRoID0gMVxyXG4gICAgICAgIGNvbnN0IGZpZWxkV2lkdGggPSBicmlja1dpZHRoICogYnJpY2tDb2xzICsgYm9yZGVyV2lkdGggKiAyXHJcbiAgICAgICAgY29uc3QgZmllbGRIZWlnaHQgPSBicmlja0hlaWdodCAqIGJyaWNrUm93cyAqIDQgKyBib3JkZXJXaWR0aCAqIDJcclxuICAgICAgICBjb25zdCBsZWZ0ID0gLWZpZWxkV2lkdGggLyAyXHJcbiAgICAgICAgY29uc3QgcmlnaHQgPSBsZWZ0ICsgZmllbGRXaWR0aFxyXG4gICAgICAgIGNvbnN0IGJvdHRvbSA9IC1maWVsZEhlaWdodCAvIDJcclxuICAgICAgICBjb25zdCB0b3AgPSBib3R0b20gKyBmaWVsZEhlaWdodFxyXG4gICAgICAgIGNvbnN0IGJyaWNrTWFyZ2luID0gLjFcclxuICAgICAgICBjb25zdCB0b3BSb3dNYXJnaW4gPSAxXHJcbiAgICAgICAgY29uc3QgcGFkZGxlQm90dG9tTWFyZ2luID0gMVxyXG5cclxuICAgICAgICAvLyBwbGF5aW5nIGZpZWxkXHJcbiAgICAgICAge1xyXG4gICAgICAgICAgICAvLyBmbG9vclxyXG4gICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBmbG9vciA9IGdmeC5JeE1lc2gucmVjdChuZXcgZ2VvLkFBQkIobmV3IGdlby5WZWMzKGxlZnQsIGJvdHRvbSwgLTMpLCBuZXcgZ2VvLlZlYzMocmlnaHQsIHRvcCwgLTEpKSlcclxuICAgICAgICAgICAgICAgIGZsb29yLnZlcnRpY2VzLmZvckVhY2godiA9PiB2LmNvbG9yID0gbmV3IGdlby5WZWM0KDEsIDEsIDEsIDEpKVxyXG4gICAgICAgICAgICAgICAgaXhtLmNhdChmbG9vcilcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgLy8gYm9yZGVyXHJcbiAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IHdhbGxzID0gbmV3IGdmeC5JeE1lc2goKVxyXG4gICAgICAgICAgICAgICAgd2FsbHMuY2F0KGdmeC5JeE1lc2gucmVjdChuZXcgZ2VvLkFBQkIobmV3IGdlby5WZWMzKGxlZnQsIGJvdHRvbSArIGJvcmRlcldpZHRoLCAtMSksIG5ldyBnZW8uVmVjMyhsZWZ0ICsgYm9yZGVyV2lkdGgsIHRvcCAtIGJvcmRlcldpZHRoLCAxKSkpKVxyXG4gICAgICAgICAgICAgICAgd2FsbHMuY2F0KGdmeC5JeE1lc2gucmVjdChuZXcgZ2VvLkFBQkIobmV3IGdlby5WZWMzKHJpZ2h0IC0gYm9yZGVyV2lkdGgsIGJvdHRvbSArIGJvcmRlcldpZHRoLCAtMSksIG5ldyBnZW8uVmVjMyhyaWdodCwgdG9wIC0gYm9yZGVyV2lkdGgsIDEpKSkpXHJcbiAgICAgICAgICAgICAgICB3YWxscy5jYXQoZ2Z4Lkl4TWVzaC5yZWN0KG5ldyBnZW8uQUFCQihuZXcgZ2VvLlZlYzMobGVmdCwgYm90dG9tLCAtMSksIG5ldyBnZW8uVmVjMyhyaWdodCwgYm90dG9tICsgYm9yZGVyV2lkdGgsIDEpKSkpXHJcbiAgICAgICAgICAgICAgICB3YWxscy5jYXQoZ2Z4Lkl4TWVzaC5yZWN0KG5ldyBnZW8uQUFCQihuZXcgZ2VvLlZlYzMobGVmdCwgdG9wIC0gYm9yZGVyV2lkdGgsIC0xKSwgbmV3IGdlby5WZWMzKHJpZ2h0LCB0b3AsIDEpKSkpXHJcblxyXG4gICAgICAgICAgICAgICAgd2FsbHMudmVydGljZXMuZm9yRWFjaCh2ID0+IHYuY29sb3IgPSBuZXcgZ2VvLlZlYzQoMSwgMCwgMCwgMSkpXHJcbiAgICAgICAgICAgICAgICBpeG0uY2F0KHdhbGxzKVxyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAvLyBicmlja3NcclxuICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgYnJpY2tzID0gbmV3IGdmeC5JeE1lc2goKVxyXG4gICAgICAgICAgICAgICAgY29uc3QgZmllbGRYT2Zmc2V0ID0gbGVmdCArIGJvcmRlcldpZHRoXHJcbiAgICAgICAgICAgICAgICBjb25zdCBmaWVsZFlPZmZzZXQgPSB0b3AgLSB0b3BSb3dNYXJnaW4gLSBicmlja0hlaWdodCAqIGJyaWNrUm93c1xyXG5cclxuICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgYnJpY2tSb3dzOyArK2kpIHtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCB5T2Zmc2V0ID0gZmllbGRZT2Zmc2V0ICsgaSAqIGJyaWNrSGVpZ2h0ICsgYnJpY2tNYXJnaW5cclxuICAgICAgICAgICAgICAgICAgICBmb3IgKGxldCBqID0gMDsgaiA8IGJyaWNrQ29sczsgKytqKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHhPZmZzZXQgPSBmaWVsZFhPZmZzZXQgKyBqICogYnJpY2tXaWR0aCArIGJyaWNrTWFyZ2luXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGJyaWNrID0gZ2Z4Lkl4TWVzaC5yZWN0KG5ldyBnZW8uQUFCQihcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5ldyBnZW8uVmVjMyh4T2Zmc2V0LCB5T2Zmc2V0LCAtMSksXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXcgZ2VvLlZlYzMoeE9mZnNldCArIGJyaWNrV2lkdGggLSBicmlja01hcmdpbiwgeU9mZnNldCArIGJyaWNrSGVpZ2h0IC0gYnJpY2tNYXJnaW4sIDEpKSlcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGJyaWNrcy5jYXQoYnJpY2spXHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIGJyaWNrcy52ZXJ0aWNlcy5mb3JFYWNoKHYgPT4gdi5jb2xvciA9IG5ldyBnZW8uVmVjNCgwLCAxLCAwLCAxKSlcclxuICAgICAgICAgICAgICAgIGl4bS5jYXQoYnJpY2tzKVxyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBjb25zdCB2YW8gPSB0aGlzLnJlbmRlcmVyLmNyZWF0ZU1lc2goaXhtKVxyXG5cclxuICAgICAgICAgICAgdGhpcy5maWVsZEJhdGNoID0ge1xyXG4gICAgICAgICAgICAgICAgdmFvOiB2YW8sXHJcbiAgICAgICAgICAgICAgICB3b3JsZE1hdHJpeDogZ2VvLk1hdDQuaWRlbnRpdHkoKSxcclxuICAgICAgICAgICAgICAgIG9mZnNldDogMCxcclxuICAgICAgICAgICAgICAgIG51bUluZGljZXM6IGl4bS5pbmRpY2VzLmxlbmd0aFxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAvLyBhZGQgcGxheWVyIHBhZGRsZSBhbmQgYmFsbFxyXG4gICAgICAgIHtcclxuICAgICAgICAgICAgY29uc3QgaXhtID0gZ2Z4Lkl4TWVzaC5zcGhlcmUoMTYsIDE2KVxyXG4gICAgICAgICAgICBpeG0udmVydGljZXMuZm9yRWFjaCh2ID0+IHYuY29sb3IgPSBuZXcgZ2VvLlZlYzQoMCwgMCwgMSwgMSkpXHJcblxyXG4gICAgICAgICAgICBjb25zdCB2YW8gPSB0aGlzLnJlbmRlcmVyLmNyZWF0ZU1lc2goaXhtKVxyXG4gICAgICAgICAgICB0aGlzLmJhbGxCYXRjaCA9IHtcclxuICAgICAgICAgICAgICAgIHZhbyxcclxuICAgICAgICAgICAgICAgIHdvcmxkTWF0cml4OiBnZW8uTWF0NC5pZGVudGl0eSgpLFxyXG4gICAgICAgICAgICAgICAgb2Zmc2V0OiAwLFxyXG4gICAgICAgICAgICAgICAgbnVtSW5kaWNlczogaXhtLmluZGljZXMubGVuZ3RoXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8vIGFkZCBwYWRkbGVcclxuICAgICAgICB7XHJcbiAgICAgICAgICAgIGNvbnN0IHBhZGRsZVdpZHRoID0gNFxyXG4gICAgICAgICAgICBjb25zdCBwYWRkbGVIZWlnaHQgPSAxXHJcblxyXG4gICAgICAgICAgICBjb25zdCBpeG0gPSBnZnguSXhNZXNoLnJlY3QobmV3IGdlby5BQUJCKFxyXG4gICAgICAgICAgICAgICAgbmV3IGdlby5WZWMzKC1wYWRkbGVXaWR0aCAvIDIsIGJvdHRvbSArIGJvcmRlcldpZHRoICsgcGFkZGxlQm90dG9tTWFyZ2luLCAtMSksXHJcbiAgICAgICAgICAgICAgICBuZXcgZ2VvLlZlYzMocGFkZGxlV2lkdGggLyAyLCBib3R0b20gKyBib3JkZXJXaWR0aCArIHBhZGRsZUJvdHRvbU1hcmdpbiArIHBhZGRsZUhlaWdodCwgMSkpKVxyXG5cclxuICAgICAgICAgICAgaXhtLnZlcnRpY2VzLmZvckVhY2godiA9PiB2LmNvbG9yID0gbmV3IGdlby5WZWM0KDAsIDEsIDEsIDEpKVxyXG5cclxuICAgICAgICAgICAgY29uc3QgdmFvID0gdGhpcy5yZW5kZXJlci5jcmVhdGVNZXNoKGl4bSlcclxuICAgICAgICAgICAgdGhpcy5wYWRkbGVCYXRjaCA9IHtcclxuICAgICAgICAgICAgICAgIHZhbyxcclxuICAgICAgICAgICAgICAgIHdvcmxkTWF0cml4OiBnZW8uTWF0NC5pZGVudGl0eSgpLFxyXG4gICAgICAgICAgICAgICAgb2Zmc2V0OiAwLFxyXG4gICAgICAgICAgICAgICAgbnVtSW5kaWNlczogaXhtLmluZGljZXMubGVuZ3RoXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSB0aWNrKCkge1xyXG4gICAgICAgIHRoaXMuY2hlY2tTaXplKClcclxuICAgICAgICB0aGlzLmRyYXdTY2VuZSgpXHJcbiAgICAgICAgcmVxdWVzdEFuaW1hdGlvbkZyYW1lKCgpID0+IHRoaXMudGljaygpKVxyXG4gICAgICAgICsrdGhpcy50aWNrc1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgY2hlY2tTaXplKCkge1xyXG4gICAgICAgIGlmICh0aGlzLmNhbnZhcy53aWR0aCA9PT0gdGhpcy5jYW52YXMuY2xpZW50V2lkdGggJiYgdGhpcy5jYW52YXMuaGVpZ2h0ID09PSB0aGlzLmNhbnZhcy5jbGllbnRIZWlnaHQpIHtcclxuICAgICAgICAgICAgcmV0dXJuXHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB0aGlzLmNhbnZhcy53aWR0aCA9IHRoaXMuY2FudmFzLmNsaWVudFdpZHRoXHJcbiAgICAgICAgdGhpcy5jYW52YXMuaGVpZ2h0ID0gdGhpcy5jYW52YXMuY2xpZW50SGVpZ2h0XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBkcmF3U2NlbmUoKSB7XHJcbiAgICAgICAgLy8gY29uc3QgcmF0ZSA9IE1hdGguUEkgLyAyNDBcclxuICAgICAgICBjb25zdCByYXRlID0gMFxyXG4gICAgICAgIGNvbnN0IHdvcmxkTWF0cml4ID0gZ2VvLk1hdDQucm90YXRpb25YKHRoaXMudGlja3MgKiByYXRlKVxyXG5cclxuICAgICAgICBpZiAodGhpcy5maWVsZEJhdGNoKSB7XHJcbiAgICAgICAgICAgIHRoaXMuZmllbGRCYXRjaC53b3JsZE1hdHJpeCA9IHdvcmxkTWF0cml4XHJcbiAgICAgICAgICAgIHRoaXMucmVuZGVyZXIuZHJhd0JhdGNoKHRoaXMuZmllbGRCYXRjaClcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmICh0aGlzLmJhbGxCYXRjaCkge1xyXG4gICAgICAgICAgICB0aGlzLmJhbGxCYXRjaC53b3JsZE1hdHJpeCA9IHdvcmxkTWF0cml4XHJcbiAgICAgICAgICAgIHRoaXMucmVuZGVyZXIuZHJhd0JhdGNoKHRoaXMuYmFsbEJhdGNoKVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKHRoaXMucGFkZGxlQmF0Y2gpIHtcclxuICAgICAgICAgICAgdGhpcy5wYWRkbGVCYXRjaC53b3JsZE1hdHJpeCA9IHdvcmxkTWF0cml4XHJcbiAgICAgICAgICAgIHRoaXMucmVuZGVyZXIuZHJhd0JhdGNoKHRoaXMucGFkZGxlQmF0Y2gpXHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB0aGlzLnJlbmRlcmVyLnByZXNlbnQoKVxyXG4gICAgfVxyXG59XHJcblxyXG5jb25zdCBhcHAgPSBuZXcgQXBwKClcclxuYXBwLmV4ZWMoKSJdfQ==